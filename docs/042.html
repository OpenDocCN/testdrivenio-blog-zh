<html>
<head>
<title>Running Flower in Production </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>生产中的流水作业</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/flower-nginx/#0001-01-01">https://testdriven.io/blog/flower-nginx/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何用Docker配置<a href="https://flower.readthedocs.io/"> Flower </a>在Nginx后面运行。我们还将设置基本身份验证。</p>



<h2 id="docker">码头工人</h2>
<p>假设您使用Redis作为您的消息代理，您的Docker编写配置将类似于:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.7'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379</span><span class="w"/>

<span class="w">  </span><span class="nt">worker</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'celery'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'-A'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'app.app'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'worker'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'-l'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'info'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_URL=redis://redis:6379</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RESULT_BACKEND=redis://redis:6379</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">flower</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mher/flower:0.9.7</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'flower'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'--broker=redis://redis:6379'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'--port=5555'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5557:5555</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>截至发稿时，<a href="https://hub.docker.com/r/mher/flower">官方Flower Docker图像</a>还没有版本&gt; 0.9.7的标签，这就是为什么使用了<code>0.9.7</code>标签。更多信息见<a href="https://github.com/mher/flower/issues/1140">1 . 0 . 0版本的Docker标签</a>。</p>
<p>想检查正在使用的版本吗？运行<code>docker-compose exec flower pip freeze</code>。</p>
<p>本教程用花版本<a href="https://github.com/mher/flower/releases/tag/v0.9.7"> 0.9.7 </a>和芹菜<a href="https://github.com/celery/celery/releases/tag/v5.2.7"> 5.2.7 </a>进行了测试。</p>
</blockquote>
<p>您可以在GitHub上的<a href="https://github.com/testdrivenio/celery-flower-docker">芹菜花码头</a> repo中查看这个样本代码。</p>
<p><em> app.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'CELERY_CONFIG_MODULE'</span><span class="p">,</span> <span class="s1">'celery_config'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">'app'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_envvar</span><span class="p">(</span><span class="s1">'CELERY_CONFIG_MODULE'</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div>

<p><em>芹菜_配置. py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>

<span class="n">broker_url</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">'BROKER_URL'</span><span class="p">]</span>
<span class="n">result_backend</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">'RESULT_BACKEND'</span><span class="p">]</span>
</code></pre></div>

<p><em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="k">RUN</span><span class="w"> </span>pip install celery<span class="o">[</span>redis<span class="o">]==</span><span class="m">5</span>.2.7

<span class="k">COPY</span><span class="w"> </span>app.py .
<span class="k">COPY</span><span class="w"> </span>celery_config.py .
</code></pre></div>

<p>快速测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose build
$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> worker python

&gt;&gt; from app import add
&gt;&gt; <span class="nv">task</span> <span class="o">=</span> add.delay<span class="o">(</span><span class="m">5</span>, <span class="m">5</span><span class="o">)</span>
&gt;&gt;&gt;
&gt;&gt;&gt; task.status
<span class="s1">'SUCCESS'</span>
&gt;&gt;&gt; task.result
<span class="m">10</span>
</code></pre></div>

<p>您应该能够在<a href="http://localhost:5557/"> http://localhost:5557/ </a>查看仪表板。</p>
<h2 id="nginx">Nginx</h2>
<p>要在<a href="https://www.nginx.com"> Nginx </a>之后运行flower，首先将Nginx添加到Docker Compose配置中:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.7'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379</span><span class="w"/>

<span class="w">  </span><span class="nt">worker</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'celery'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'-A'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'app.app'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'worker'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'-l'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'info'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_URL=redis://redis:6379</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RESULT_BACKEND=redis://redis:6379</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">flower</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mher/flower:0.9.7</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'flower'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'--broker=redis://redis:6379'</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">'--port=5555'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5555</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:latest</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx.conf:/etc/nginx/nginx.conf</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flower</span><span class="w"/>
</code></pre></div>

<p><em>engine . conf</em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">events</span><span class="w"> </span><span class="p">{}</span><span class="w"/>

<span class="nt">http</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="err">server</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">    </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">server_name</span><span class="w"> </span><span class="err">your.server.url</span><span class="p">;</span><span class="w"/>

<span class="w">    </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">flower</span><span class="o">:</span><span class="mi">5555</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Host</span><span class="w"> </span><span class="err">$host</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_redirect</span><span class="w"> </span><span class="err">off</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_http_version</span><span class="w"> </span><span class="err">1.1</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Upgrade</span><span class="w"> </span><span class="err">$http_upgrade</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Connection</span><span class="w"> </span><span class="err">"upgrade"</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="err">}</span><span class="w"/>
<span class="err">}</span><span class="w"/>
</code></pre></div>

<p>快速测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down
$ docker-compose build
$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> worker python

&gt;&gt; from app import add
&gt;&gt; <span class="nv">task</span> <span class="o">=</span> add.delay<span class="o">(</span><span class="m">7</span>, <span class="m">7</span><span class="o">)</span>
&gt;&gt;&gt;
&gt;&gt;&gt; task.status
<span class="s1">'SUCCESS'</span>
&gt;&gt;&gt; task.result
<span class="m">14</span>
</code></pre></div>

<p>这一次，仪表板应该可以在<a href="http://localhost/"> http://localhost/ </a>上看到。</p>
<h2 id="authentication">证明</h2>
<p>要添加基本认证，首先创建一个<em> htpasswd </em>文件。例如:</p>
<div class="codehilite"><pre><span/><code>$ htpasswd -c htpasswd michael
</code></pre></div>

<p>接下来，向<code>nginx</code>服务添加另一个卷，以将<em> htpasswd </em>从主机挂载到<em> /etc/nginx/。容器中的htpasswd </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:latest</span><span class="w"/>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx.conf:/etc/nginx/nginx.conf</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./htpasswd:/etc/nginx/.htpasswd</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flower</span><span class="w"/>
</code></pre></div>

<p>最后，为了保护“/”路由，将<a href="http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic"> auth_basic </a>和<a href="http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic_user_file"> auth_basic_user_file </a>指令添加到位置块:</p>
<div class="codehilite"><pre><span/><code><span class="nt">events</span><span class="w"> </span><span class="p">{}</span><span class="w"/>

<span class="nt">http</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="err">server</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">    </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">server_name</span><span class="w"> </span><span class="err">your.server.url</span><span class="p">;</span><span class="w"/>

<span class="w">    </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">flower</span><span class="o">:</span><span class="mi">5555</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Host</span><span class="w"> </span><span class="err">$host</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_redirect</span><span class="w"> </span><span class="err">off</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_http_version</span><span class="w"> </span><span class="err">1.1</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Upgrade</span><span class="w"> </span><span class="err">$http_upgrade</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Connection</span><span class="w"> </span><span class="err">"upgrade"</span><span class="p">;</span><span class="w"/>

<span class="w">        </span><span class="err">auth_basic</span><span class="w">  </span><span class="err">"Restricted"</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">auth_basic_user_file</span><span class="w">  </span><span class="err">/etc/nginx/.htpasswd</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="err">}</span><span class="w"/>
<span class="err">}</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>有关使用Nginx设置基本身份验证的更多信息，请查看使用HTTP基本身份验证限制访问指南。</p>
</blockquote>
<p>最终测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down
$ docker-compose build
$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> worker python

&gt;&gt; from app import add
&gt;&gt; <span class="nv">task</span> <span class="o">=</span> add.delay<span class="o">(</span><span class="m">9</span>, <span class="m">9</span><span class="o">)</span>
&gt;&gt;&gt;
&gt;&gt;&gt; task.status
<span class="s1">'SUCCESS'</span>
&gt;&gt;&gt; task.result
<span class="m">18</span>
</code></pre></div>

<p>再次导航到<a href="http://localhost/"> http://localhost/ </a>。这一次应该会提示您输入用户名和密码。</p>
  </div>

  </div>    
</body>
</html>