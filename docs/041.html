<html>
<head>
<title>Dockerizing Masonite with Postgres, Gunicorn, and Nginx </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Postgres、Gunicorn和Nginx对Masonite进行对接</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/dockerizing-masonite-with-postgres-gunicorn-and-nginx/#0001-01-01">https://testdriven.io/blog/dockerizing-masonite-with-postgres-gunicorn-and-nginx/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>这是一个循序渐进的教程，详细介绍了如何配置<a href="https://docs.masoniteproject.com/"> Masonite </a>，一个基于Python的web框架，在Docker和Postgres上运行。对于生产环境，我们将添加Nginx和Gunicorn。我们还将看看如何通过Nginx提供静态和用户上传的媒体文件。</p>
<blockquote>
<p>Masonite是一个现代的、以开发者为中心的、包含电池的Python web框架。如果你是这个框架的新手，可以看看<a href="https://dev.to/masonite/5-reasons-why-people-are-choosing-masonite-over-django-ic3">人们选择Masonite而不是Django的5个原因</a>文章。</p>
</blockquote>
<p><em>依赖关系</em>:</p>
<ol>
<li>mason ite 4 . 16 . 2版</li>
<li>文档v20.10.17</li>
<li>python 3 . 10 . 5版</li>
</ol>



<h2 id="project-setup">项目设置</h2>
<p>创建项目目录，安装Masonite，并创建新的Masonite项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir masonite-on-docker <span class="o">&amp;&amp;</span> <span class="nb">cd</span> masonite-on-docker
$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">masonite</span><span class="o">==</span><span class="m">4</span>.16.2
<span class="o">(</span>env<span class="o">)</span>$ project start web
<span class="o">(</span>env<span class="o">)</span>$ <span class="nb">cd</span> web
<span class="o">(</span>env<span class="o">)</span>$ project install
<span class="o">(</span>env<span class="o">)</span>$ python craft serve
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>查看Masonite欢迎屏幕。完成后，关闭服务器并退出虚拟环境。继续并删除虚拟环境。我们现在有了一个简单的Masonite项目。</p>
<p>接下来，在添加Docker之前，让我们稍微清理一下项目结构:</p>
<ol>
<li>拆下<em>。环境示例</em>和<em>。gitignore </em>来自“web”目录的文件</li>
<li>移动<em>。env </em>文件到项目根目录，并将其重命名为<em> .env.dev </em>。</li>
</ol>
<p>您的项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── .env.dev
└── web
    ├── .env.testing
    ├── Kernel.py
    ├── app
    │   ├── __init__.py
    │   ├── controllers
    │   │   ├── WelcomeController.py
    │   │   └── __init__.py
    │   ├── middlewares
    │   │   ├── AuthenticationMiddleware.py
    │   │   ├── VerifyCsrfToken.py
    │   │   └── __init__.py
    │   ├── models
    │   │   └── User.py
    │   └── providers
    │       ├── AppProvider.py
    │       └── __init__.py
    ├── config
    │   ├── __init__.py
    │   ├── application.py
    │   ├── auth.py
    │   ├── broadcast.py
    │   ├── cache.py
    │   ├── database.py
    │   ├── exceptions.py
    │   ├── filesystem.py
    │   ├── mail.py
    │   ├── notification.py
    │   ├── providers.py
    │   ├── queue.py
    │   ├── security.py
    │   └── session.py
    ├── craft
    ├── databases
    │   ├── migrations
    │   │   ├── 2021_01_09_033202_create_password_reset_table.py
    │   │   └── 2021_01_09_043202_create_users_table.py
    │   └── seeds
    │       ├── __init__.py
    │       ├── database_seeder.py
    │       └── user_table_seeder.py
    ├── makefile
    ├── package.json
    ├── pyproject.toml
    ├── requirements.txt
    ├── resources
    │   ├── css
    │   │   └── app.css
    │   └── js
    │       ├── app.js
    │       └── bootstrap.js
    ├── routes
    │   └── web.py
    ├── setup.cfg
    ├── storage
    │   ├── .gitignore
    │   └── public
    │       ├── favicon.ico
    │       ├── logo.png
    │       └── robots.txt
    ├── templates
    │   ├── __init__.py
    │   ├── base.html
    │   ├── errors
    │   │   ├── <span class="m">403</span>.html
    │   │   ├── <span class="m">404</span>.html
    │   │   └── <span class="m">500</span>.html
    │   ├── maintenance.html
    │   └── welcome.html
    ├── tests
    │   ├── TestCase.py
    │   ├── __init__.py
    │   └── unit
    │       └── test_basic_testcase.py
    ├── webpack.mix.js
    └── wsgi.py
</code></pre></div>

<h2 id="docker">码头工人</h2>
<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有，那么在“web”目录下添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.5-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk --no-cache add <span class="se">\</span>
    libressl-dev libffi-dev gcc musl-dev python3-dev openssl-dev cargo

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>所以，我们从Python 3.10.5的基于<a href="https://github.com/gliderlabs/docker-alpine"> Alpine </a>的<a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及三个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
<li><code>TZ=UTC</code>将容器中的时区设置为UTC，这是日志记录所必需的</li>
</ol>
<p>接下来，我们安装了Python所需的一些系统级依赖项。记下<code>openssl-dev</code>和<code>cargo</code>的依赖关系。这些是必需的，因为<a href="https://cryptography.io/">密码术</a>库<a href="https://github.com/pyca/cryptography/issues/5771">现在依赖于Rust </a>。更多信息，请查看<a href="https://cryptography.io/en/latest/installation.html#building-cryptography-on-linux">在Linux上构建加密技术</a>。</p>
<p>最后，我们更新了Pip，复制了<em> requirements.txt </em>文件，安装了依赖项，并复制了Masonite应用程序本身。</p>
<blockquote>
<p>查看<a href="/blog/docker-best-practices/"> Docker针对Python开发人员的最佳实践</a>，了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将一个<em> docker-compose.yml </em>文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python craft serve -p 8000 -b 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.dev</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>，了解该文件如何工作的信息。</p>
</blockquote>
<p>让我们通过删除任何未使用的变量来简化<em> .env.dev </em>:</p>
<div class="codehilite"><pre><span/><code>APP_DEBUG=True
APP_ENV=local
APP_KEY=zWDMwC0aNfVk8Ao1NyVJC_LiGD9tHJtVn_uCPeaaTNY=
APP_URL=http://localhost:8000
HASHING_FUNCTION=bcrypt

MAIL_DRIVER=terminal

DB_CONNECTION=sqlite
SQLITE_DB_DATABASE=masonite.sqlite3
DB_HOST=127.0.0.1
DB_USERNAME=root
DB_PASSWORD=root
DB_DATABASE=masonite
DB_PORT=3306
DB_LOG=True

QUEUE_DRIVER=async
</code></pre></div>

<p>建立形象:</p>


<p>构建映像后，运行容器:</p>


<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>再次查看欢迎屏幕。</p>
<blockquote>
<p>如果这不起作用，通过<code>docker-compose logs -f</code>检查日志中的错误。</p>
</blockquote>
<p>要测试自动重新加载，首先打开Docker日志- <code>docker-compose logs -f</code> -然后在本地对<em> web/routes/web.py </em>进行更改:</p>


<p>保存后，您应该会看到应用程序在您的终端中重新加载，如下所示:</p>
<div class="codehilite"><pre><span/><code>* Detected change <span class="k">in</span> <span class="s1">'/usr/src/app/routes/web.py'</span>, reloading
* Restarting with watchdog <span class="o">(</span>inotify<span class="o">)</span>
</code></pre></div>

<p>确保<a href="http://localhost:8000/sample">http://localhost:8000/sample</a>按预期工作。</p>
<h2 id="postgres">Postgres</h2>
<p>要配置Postgres，我们需要向<em> docker-compose.yml </em>文件添加一个新服务，更新环境变量，并安装<a href="https://www.psycopg.org/"> Psycopg2 </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python craft serve -p 8000 -b 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.dev</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14.4-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_dev:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_masonite</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_masonite</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_masonite_dev</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_dev</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data_dev</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>在<em> .env.dev </em>文件中更新以下与数据库相关的环境变量:</p>
<div class="codehilite"><pre><span/><code>DB_CONNECTION=postgres
DB_HOST=db
DB_PORT=5432
DB_DATABASE=hello_masonite_dev
DB_USERNAME=hello_masonite
DB_PASSWORD=hello_masonite
</code></pre></div>

<blockquote>
<p>查看<em> web/config/database.py </em>文件，了解如何根据为Masonite项目定义的环境变量来配置数据库。</p>
</blockquote>
<p>更新docker文件以安装Psycopg2所需的相应软件包:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.5-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk --no-cache add <span class="se">\</span>
    libressl-dev libffi-dev gcc musl-dev python3-dev openssl-dev cargo <span class="se">\</span>
    postgresql-dev

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>将Psycopg2添加到<em> web/requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>masonite&gt;=4.0,&lt;5.0
masonite-orm&gt;=2.0,&lt;3.0
psycopg2-binary==2.9.3
</code></pre></div>

<blockquote>
<p>查看<a href="https://github.com/psycopg/psycopg2/issues/684">本期GitHub</a>了解更多关于在基于Alpine的Docker映像中安装Psycopg2的信息。</p>
</blockquote>
<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>应用迁移(从“web/数据库/迁移”文件夹):</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python craft migrate
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code>Migrating: 2021_01_09_033202_create_password_reset_table
Migrated: 2021_01_09_033202_create_password_reset_table <span class="o">(</span><span class="m">0</span>.01s<span class="o">)</span>
Migrating: 2021_01_09_043202_create_users_table
Migrated: 2021_01_09_043202_create_users_table <span class="o">(</span><span class="m">0</span>.02s<span class="o">)</span>
</code></pre></div>

<p>确保<code>users</code>表已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_masonite --dbname<span class="o">=</span>hello_masonite_dev

psql <span class="o">(</span><span class="m">14</span>.4<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                              List of databases
        Name        <span class="p">|</span>     Owner      <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>         Access privileges
--------------------+----------------+----------+------------+------------+-----------------------------------
 hello_masonite_dev <span class="p">|</span> hello_masonite <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres           <span class="p">|</span> hello_masonite <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0          <span class="p">|</span> hello_masonite <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_masonite                +
                    <span class="p">|</span>                <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_masonite</span><span class="o">=</span>CTc/hello_masonite
 template1          <span class="p">|</span> hello_masonite <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_masonite                +
                    <span class="p">|</span>                <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_masonite</span><span class="o">=</span>CTc/hello_masonite
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \c hello_masonite_dev</span>
You are now connected to database <span class="s2">"hello_masonite_dev"</span> as user <span class="s2">"hello_masonite"</span>.

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \dt</span>
              List of relations
 Schema <span class="p">|</span>    Name         <span class="p">|</span> Type  <span class="p">|</span>     Owner
--------+-----------------+-------+----------------
 public <span class="p">|</span> migrations      <span class="p">|</span> table <span class="p">|</span> hello_masonite
 public <span class="p">|</span> password_resets <span class="p">|</span> table <span class="p">|</span> hello_masonite
 public <span class="p">|</span> users           <span class="p">|</span> table <span class="p">|</span> hello_masonite
<span class="o">(</span><span class="m">3</span> rows<span class="o">)</span>

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>您也可以通过运行以下命令来检查该卷是否已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker volume inspect masonite-on-docker_postgres_data_dev
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2022-07-22T20:07:50Z"</span>,
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{</span>
            <span class="s2">"com.docker.compose.project"</span>: <span class="s2">"masonite-on-docker"</span>,
            <span class="s2">"com.docker.compose.version"</span>: <span class="s2">"2.6.1"</span>,
            <span class="s2">"com.docker.compose.volume"</span>: <span class="s2">"postgres_data_dev"</span>
        <span class="o">}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/masonite-on-docker_postgres_data_dev/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"masonite-on-docker_postgres_data_dev"</span>,
        <span class="s2">"Options"</span>: null,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>

<p>接下来，将一个<em> entrypoint.sh </em>文件添加到“web”目录，以在应用迁移和运行Masonite开发服务器之前，验证Postgres是否启动<em>和</em>健康<em>:</em></p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DB_CONNECTION</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$DB_HOST</span> <span class="nv">$DB_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

python craft migrate:refresh  <span class="c1"># you may want to remove this</span>
python craft migrate

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4c680c">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<p>记下环境变量。</p>
<p>然后，更新Dockerfile来运行<em> entrypoint.sh </em>文件，作为Docker <a href="https://docs.docker.com/engine/reference/builder/#entrypoint"> entrypoint </a>命令:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.5-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk --no-cache add <span class="se">\</span>
    libressl-dev libffi-dev gcc musl-dev python3-dev openssl-dev cargo <span class="se">\</span>
    postgresql-dev

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .

<span class="c"># run entrypoint.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/usr/src/app/entrypoint.sh"</span><span class="p">]</span>
</code></pre></div>

<p>在本地更新文件权限:</p>
<div class="codehilite"><pre><span/><code>$ chmod +x web/entrypoint.sh
</code></pre></div>

<p>再次测试:</p>
<ol>
<li>重建图像</li>
<li>运行容器</li>
<li>试试<a href="http://localhost:8000/"> http://localhost:8000/ </a></li>
</ol>
<p>想播种一些用户？</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python craft seed:run

$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_masonite --dbname<span class="o">=</span>hello_masonite_dev

psql <span class="o">(</span><span class="m">14</span>.4<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \c hello_masonite_dev</span>
You are now connected to database <span class="s2">"hello_masonite_dev"</span> as user <span class="s2">"hello_masonite"</span>.

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># select count(*) from users;</span>
 count
-------
     <span class="m">1</span>
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">hello_masonite_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<h2 id="gunicorn">格尼科恩</h2>
<p>接下来，对于生产环境，让我们将<a href="https://gunicorn.org/"> Gunicorn </a>，一个生产级的WSGI服务器，添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>masonite&gt;=4.0,&lt;5.0
masonite-orm&gt;=2.0,&lt;3.0
psycopg2-binary==2.9.3
gunicorn==20.1.0
</code></pre></div>

<p>由于我们仍然希望在开发中使用Masonite的内置服务器，因此为生产创建一个名为<em> docker-compose.prod.yml </em>的新合成文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:8000 wsgi:application</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14.4-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod.db</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果您有多个环境，您可能希望使用一个<a href="https://docs.docker.com/compose/extends/">docker-compose . override . yml</a>配置文件。使用这种方法，您可以将您的基本配置添加到一个<em> docker-compose.yml </em>文件中，然后使用一个<em>docker-compose . override . yml</em>文件根据环境覆盖那些配置设置。</p>
</blockquote>
<p>记下默认值<code>command</code>。我们运行的是Gunicorn而不是Masonite开发服务器。我们还从<code>web</code>服务中删除了这个卷，因为我们在生产中不需要它。最后，我们使用<a href="https://docs.docker.com/compose/env-file/">单独的环境变量文件</a>来定义两个服务的环境变量，它们将在运行时传递给容器。</p>
<p><em> .env.prod </em>:</p>
<div class="codehilite"><pre><span/><code>APP_DEBUG=False
APP_ENV=prod
APP_KEY=GM28x-FeI1sM72tgtsgikLcT-AryyVOiY8etOGr7q7o=
APP_URL=http://localhost:8000
HASHING_FUNCTION=bcrypt

MAIL_DRIVER=terminal

DB_CONNECTION=postgres
DB_HOST=db
DB_PORT=5432
DB_DATABASE=hello_masonite_prod
DB_USERNAME=hello_masonite
DB_PASSWORD=hello_masonite
DB_LOG=True

QUEUE_DRIVER=async
</code></pre></div>

<p><em> .env.prod.db </em>:</p>
<div class="codehilite"><pre><span/><code>POSTGRES_USER=hello_masonite
POSTGRES_PASSWORD=hello_masonite
POSTGRES_DB=hello_masonite_prod
</code></pre></div>

<p>将这两个文件添加到项目根目录。您可能想让它们不受版本控制，所以将它们添加到一个<em>中。gitignore </em>文件。</p>
<p>将<a href="https://docs.docker.com/compose/reference/down/">下放到</a>开发容器(以及带有<code>-v</code>标志的相关卷):</p>


<p>然后，构建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>验证<code>hello_masonite_prod</code>数据库是与<code>users</code>表一起创建的。测试出<a href="http://localhost:8000/"> http://localhost:8000/ </a>。</p>
<blockquote>
<p>同样，如果容器启动失败，通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="production-dockerfile">生产文档</h2>
<p>您是否注意到，每次运行容器时，我们仍然在运行<a href="https://orm.masoniteproject.com/schema-and-migrations#refreshing-migrations"> migrate:refresh </a>(清空数据库)和migrate命令？这在开发中很好，但是让我们为生产创建一个新的入口点文件。</p>
<p>entry point . prod . sh:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DB_CONNECTION</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$DB_HOST</span> <span class="nv">$DB_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b89cf8">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<blockquote>
<p>或者，不创建新的入口点文件，您可以修改现有的文件，如下所示:</p>
<div class="codehilite"><pre><span/><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DB_CONNECTION</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$DB_HOST</span> <span class="nv">$DB_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$APP_ENV</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"local"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Refreshing the database..."</span>
    craft migrate:refresh  <span class="c1"># you may want to remove this</span>
    <span class="nb">echo</span> <span class="s2">"Applying migrations..."</span>
    craft migrate
    <span class="nb">echo</span> <span class="s2">"Tables created"</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="133753">[email protected]</a></span><span class="s2">"</span>
</pre></div></blockquote>

<p>要使用这个文件，创建一个名为<em> Dockerfile.prod </em>的新Dockerfile，用于生产构建:</p>
<div class="codehilite"><pre><span/><code><span class="c">###########</span>
<span class="c"># BUILDER #</span>
<span class="c">###########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.5-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk --no-cache add <span class="se">\</span>
    libressl-dev libffi-dev gcc musl-dev python3-dev openssl-dev cargo <span class="se">\</span>
    postgresql-dev

<span class="c"># lint</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install <span class="nv">flake8</span><span class="o">==</span><span class="m">4</span>.0.1
<span class="k">COPY</span><span class="w"> </span>. .
<span class="k">RUN</span><span class="w"> </span>flake8 --ignore<span class="o">=</span>E501,F401,E303,E402 .

<span class="c"># install python dependencies</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt

<span class="c">#########</span>
<span class="c"># FINAL #</span>
<span class="c">#########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.5-alpine</span>

<span class="c"># create directory for the app user</span>
<span class="k">RUN</span><span class="w"> </span>mkdir -p /home/app

<span class="c"># create the app user</span>
<span class="k">RUN</span><span class="w"> </span>addgroup -S app <span class="o">&amp;&amp;</span> adduser -S app -G app

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk --no-cache add <span class="se">\</span>
    libressl-dev libffi-dev gcc musl-dev python3-dev openssl-dev cargo <span class="se">\</span>
    postgresql-dev
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/wheels /wheels
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --no-cache /wheels/*

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. <span class="nv">$APP_HOME</span>
<span class="k">RUN</span><span class="w"> </span>chmod +x /home/app/web/entrypoint.prod.sh

<span class="c"># chown all the files to the app user</span>
<span class="k">RUN</span><span class="w"> </span>chown -R app:app <span class="nv">$APP_HOME</span>

<span class="c"># change to the app user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">app</span>

<span class="c"># run entrypoint.prod.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/home/app/web/entrypoint.prod.sh"</span><span class="p">]</span>
</code></pre></div>

<p>在这里，我们使用了一个Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>来缩小最终的图像尺寸。本质上，<code>builder</code>是一个用于构建Python轮子的临时图像。然后车轮被复制到最终产品图像中，而<code>builder</code>图像被丢弃。</p>
<blockquote>
<p>你可以将<a href="https://stackoverflow.com/a/53101932/1799408">多阶段构建方法</a>更进一步，使用单个<em>docker文件</em>而不是创建两个docker文件。思考在两个不同的文件上使用这种方法的利弊。</p>
</blockquote>
<p>您是否注意到我们创建了一个非root用户？默认情况下，Docker在容器内部以root用户身份运行容器进程。这是一种不好的做法，因为如果攻击者设法突破容器，他们可以获得Docker主机的根用户访问权限。如果您是容器中的root用户，那么您将是主机上的root用户。</p>
<p>更新<em> docker-compose.prod.yml </em>文件中的<code>web</code>服务，用<em> Dockerfile.prod </em>构建:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:8000 wsgi:application</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python craft migrate
</code></pre></div>

<h2 id="nginx">Nginx</h2>
<p>接下来，让我们将Nginx添加进来，充当Gunicorn的反向代理来处理客户端请求以及提供静态文件。</p>
<p>将服务添加到<em> docker-compose.prod.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
</code></pre></div>

<p>然后，在本地项目根目录中，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<p><em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.23.1-alpine</span>

<span class="k">RUN</span><span class="w"> </span>rm /etc/nginx/conf.d/default.conf
<span class="k">COPY</span><span class="w"> </span>nginx.conf /etc/nginx/conf.d
</code></pre></div>

<p><em>engine . conf</em>:</p>
<div class="codehilite"><pre><span/><code>upstream hello_masonite <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_masonite<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<blockquote>
<p>查看<a href="https://www.digitalocean.com/community/tutorials/understanding-the-nginx-configuration-file-structure-and-configuration-contexts">了解Nginx配置文件结构和配置上下文</a>以了解Nginx配置文件的更多信息。</p>
</blockquote>
<p>然后，更新<code>web</code>服务，在<em> docker-compose.prod.yml </em>中，用<code>expose</code>替换<code>ports</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:8000 wsgi:application</span><span class="w"/>
<span class="w">  </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>现在，端口8000只在内部对其他Docker服务公开。该端口将不再发布到主机上。</p>
<blockquote>
<p>关于端口与暴露的更多信息，请查看<a href="https://stackoverflow.com/questions/40801772/what-is-the-difference-between-docker-compose-ports-vs-expose">这个</a>堆栈溢出问题。</p>
</blockquote>
<p>再测试一次。</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python craft migrate
</code></pre></div>

<p>确保应用程序在<a href="http://localhost:1337"> http://localhost:1337 </a>启动并运行。</p>
<p>您的项目结构现在应该看起来像这样:</p>
<div class="codehilite"><pre><span/><code>├── .env.dev
├── .env.prod
├── .env.prod.db
├── .gitignore
├── docker-compose.prod.yml
├── docker-compose.yml
├── nginx
│   ├── Dockerfile
│   └── nginx.conf
└── web
    ├── .env.testing
    ├── Dockerfile
    ├── Dockerfile.prod
    ├── Kernel.py
    ├── app
    │   ├── __init__.py
    │   ├── controllers
    │   │   ├── WelcomeController.py
    │   │   └── __init__.py
    │   ├── middlewares
    │   │   ├── AuthenticationMiddleware.py
    │   │   ├── VerifyCsrfToken.py
    │   │   └── __init__.py
    │   ├── models
    │   │   └── User.py
    │   └── providers
    │       ├── AppProvider.py
    │       └── __init__.py
    ├── config
    │   ├── __init__.py
    │   ├── application.py
    │   ├── auth.py
    │   ├── broadcast.py
    │   ├── cache.py
    │   ├── database.py
    │   ├── exceptions.py
    │   ├── filesystem.py
    │   ├── mail.py
    │   ├── notification.py
    │   ├── providers.py
    │   ├── queue.py
    │   ├── security.py
    │   └── session.py
    ├── craft
    ├── databases
    │   ├── migrations
    │   │   ├── 2021_01_09_033202_create_password_reset_table.py
    │   │   └── 2021_01_09_043202_create_users_table.py
    │   └── seeds
    │       ├── __init__.py
    │       ├── database_seeder.py
    │       └── user_table_seeder.py
    ├── entrypoint.prod.sh
    ├── entrypoint.sh
    ├── makefile
    ├── package.json
    ├── pyproject.toml
    ├── requirements.txt
    ├── resources
    │   ├── css
    │   │   └── app.css
    │   └── js
    │       ├── app.js
    │       └── bootstrap.js
    ├── routes
    │   └── web.py
    ├── setup.cfg
    ├── storage
    │   ├── .gitignore
    │   └── public
    │       ├── favicon.ico
    │       ├── logo.png
    │       └── robots.txt
    ├── templates
    │   ├── __init__.py
    │   ├── base.html
    │   ├── errors
    │   │   ├── <span class="m">403</span>.html
    │   │   ├── <span class="m">404</span>.html
    │   │   └── <span class="m">500</span>.html
    │   ├── maintenance.html
    │   └── welcome.html
    ├── tests
    │   ├── TestCase.py
    │   ├── __init__.py
    │   └── unit
    │       └── test_basic_testcase.py
    ├── webpack.mix.js
    └── wsgi.py
</code></pre></div>

<p>完成后将容器拿下来:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>

<p>由于Gunicorn是一个应用服务器，它不会提供静态文件。那么，在这种特定的配置中，应该如何处理静态文件和媒体文件呢？</p>
<h2 id="static-files">静态文件</h2>
<p>首先，更新<em> web/config/filesystem.py </em>中的<code>STATICFILES</code>配置:</p>
<div class="codehilite"><pre><span/><code><span class="nv">STATICFILES</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1"># folder          # template alias</span>
    <span class="s2">"storage/static"</span>: <span class="s2">"static/"</span>,
    <span class="s2">"storage/compiled"</span>: <span class="s2">"static/"</span>,
    <span class="s2">"storage/uploads"</span>: <span class="s2">"uploads/"</span>,
    <span class="s2">"storage/public"</span>: <span class="s2">"/"</span>,
<span class="o">}</span>
</code></pre></div>

<p>本质上，存储在“存储/静态”(常规CSS和JS文件)和“存储/编译”(SASS和更少的文件)目录中的所有静态文件都将从<code>/static/</code> URL提供。</p>
<p>为了启用资产编译，假设您已经安装了<a href="https://docs.npmjs.com/downloading-and-installing-node-js-and-npm"> NPM </a>，安装依赖项:</p>


<p>然后，要编译资产，运行:</p>


<blockquote>
<p>有关资产复杂性的更多信息，请查看Masonite文档中的<a href="https://docs.masoniteproject.com/features/compiling-assets">编译资产</a>。</p>
</blockquote>
<p>接下来，为了测试一个常规的静态资产，向“web/storage/static”添加一个名为<em> hello.txt </em>的文本文件:</p>


<h3 id="development">发展</h3>
<p>为了进行测试，首先重新构建映像，并像往常一样旋转新的容器。完成后，确保正确加载以下静态资产:</p>
<ol>
<li><a href="http://localhost:8000/robots.txt">http://localhost:8000/robots . txt</a>(<a href="https://docs.masoniteproject.com/the-basics/static-files#serving-root-files">root</a>静态资产)</li>
<li><a href="http://localhost:8000/static/hello.txt">http://localhost:8000/static/hello . txt</a>(常规静态资产)</li>
<li><a href="http://localhost:8000/static/css/app.css">http://localhost:8000/static/CSS/app . CSS</a>(编译后的静态资产)</li>
</ol>
<h3 id="production">生产</h3>
<p>对于生产，向<em> docker-compose.prod.yml </em>中的<code>web</code>和<code>nginx</code>服务添加一个卷，这样每个容器将共享“存储”目录:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./web</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:8000 wsgi:application</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage_volume:/home/app/web/storage</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14.4-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage_volume:/home/app/web/storage</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">storage_volume</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>接下来，更新Nginx配置，将静态文件请求路由到适当的文件夹:</p>
<div class="codehilite"><pre><span/><code>upstream hello_masonite <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/storage/static/<span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/<span class="o">(</span>favicon.ico<span class="p">|</span>robots.txt<span class="o">)</span>/  <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/storage/public/<span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_masonite<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>现在，对静态文件的请求将被适当地提供:</p>
<table>
<thead>
<tr>
<th>请求URL</th>
<th>文件夹</th>
</tr>
</thead>
<tbody>
<tr>
<td>/static/*</td>
<td>“存储/静态”、“存储/编译”</td>
</tr>
<tr>
<td>/favicon.ico，/robots.txt</td>
<td>"存储/公共"</td>
</tr>
</tbody>
</table>
<p>降低开发容器的转速:</p>


<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>同样，请确保正确加载了以下静态资产:</p>
<ol>
<li><a href="http://localhost:1337/robots.txt">http://localhost:1337/robots . txt</a></li>
<li><a href="http://localhost:1337/static/hello.txt">http://localhost:1337/static/hello . txt</a></li>
<li><a href="http://localhost:1337/static/css/app.css">http://localhost:1337/static/CSS/app . CSS</a></li>
</ol>
<p>您还可以通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>在日志中验证对静态文件的请求是否通过Nginx成功提供:</p>
<div class="codehilite"><pre><span/><code>nginx_1  <span class="p">|</span> <span class="m">172</span>.28.0.1 - - <span class="o">[</span><span class="m">2022</span>-07-20:01:39:43 +0000<span class="o">]</span> <span class="s2">"GET /robots.txt HTTP/1.1"</span> <span class="m">200</span> <span class="m">0</span> <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.96 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">172</span>.28.0.1 - - <span class="o">[</span><span class="m">2022</span>-07-20:01:39:52 +0000<span class="o">]</span> <span class="s2">"GET /static/hello.txt HTTP/1.1"</span> <span class="m">200</span> <span class="m">4</span> <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.96 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">172</span>.28.0.1 - - <span class="o">[</span><span class="m">2022</span>-07-20:01:39:59 +0000<span class="o">]</span> <span class="s2">"GET /static/css/app.css HTTP/1.1"</span> <span class="m">200</span> <span class="m">649</span> <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.96 Safari/537.36"</span> <span class="s2">"-"</span>
</code></pre></div>

<p>完成后带上容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>


<p>要测试对用户上传的媒体文件的处理，请更新<em>web/templates/welcome . html</em>模板中的内容块:</p>
<div class="codehilite"><pre><span/><code>{% block content %}
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"/"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span><span class="p">&gt;</span>
    {{ csrf_field }}
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"image_upload"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"submit"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  {% if image_url %}
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>File uploaded at: <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{{ image_url }}"</span><span class="p">&gt;</span>{{ image_url }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  {% endif %}
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
{% endblock %}
</code></pre></div>

<p>在<em>web/app/controllers/welcome controller . py</em>中给<code>WelcomeController</code>添加一个名为<code>upload</code>的新方法:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="s2">"local"</span><span class="p">)</span><span class="o">.</span><span class="n">put_file</span><span class="p">(</span><span class="s2">"image_upload"</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">"image_upload"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"welcome"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"image_url"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"/framework/filesystem/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">})</span>
</code></pre></div>

<p>不要忘记进口:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">masonite.filesystem</span> <span class="kn">import</span> <span class="n">Storage</span>
<span class="kn">from</span> <span class="nn">masonite.request</span> <span class="kn">import</span> <span class="n">Request</span>
</code></pre></div>

<p>接下来，将控制器连接到<em> web/routes/web.py </em>中的新路线:</p>


<h3 id="development_1">发展</h3>
<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>你应该可以在<a href="http://localhost:8000/"> http://localhost:8000/ </a>上传一张图片，然后在<a href="http://localhost:8000/uploads/IMAGE_FILE_NAME">http://localhost:8000/uploads/IMAGE _ FILE _ NAME</a>查看图片。</p>
<h3 id="production_1">生产</h3>
<p>对于生产，更新Nginx配置以将媒体文件请求路由到“上传”文件夹:</p>
<div class="codehilite"><pre><span/><code>upstream hello_masonite <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/storage/static/<span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/<span class="o">(</span>favicon.ico<span class="p">|</span>robots.txt<span class="o">)</span>/  <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/storage/public/<span class="p">;</span>
    <span class="o">}</span>

    location /uploads/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/storage/framework/filesystem/image_upload/<span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_masonite<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>重建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v

$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>最后一次测试:</p>
<ol>
<li>在<a href="http://localhost:1337"> http://localhost:1337 </a>上传一张图片。</li>
<li>然后在<a href="http://localhost:1337/uploads/IMAGE_FILE_NAME">http://localhost:1337/uploads/IMAGE _ FILE _ NAME</a>查看图片。</li>
</ol>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何使用Postgres来封装Masonite应用程序以进行开发。我们还创建了一个生产就绪的Docker Compose文件，将Gunicorn和Nginx添加到混合文件中，以处理静态和媒体文件。现在，您可以在本地测试生产设置。</p>
<p>就生产环境的实际部署而言，您可能希望使用:</p>
<ol>
<li>完全托管的数据库服务——像<a href="https://aws.amazon.com/rds/"> RDS </a>或<a href="https://cloud.google.com/sql/">云SQL</a>——而不是在一个容器中管理你自己的Postgres实例。</li>
<li><code>db</code>和<code>nginx</code>服务的非根用户</li>
</ol>
<p>你可以在<a href="https://github.com/testdrivenio/masonite-on-docker"> masonite-on-docker </a> repo中找到代码。</p>
<p>感谢阅读！</p>
  </div>

  </div>    
</body>
</html>