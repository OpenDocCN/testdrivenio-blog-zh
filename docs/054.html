<html>
<head>
<title>Python Project Workflow </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Python项目工作流</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/python-project-workflow/#0001-01-01">https://testdriven.io/blog/python-project-workflow/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>到目前为止，在这个系列中，我们已经介绍了:</p>
<ol>
<li><a href="/blog/python-environments/">现代Python环境——依赖性和工作空间管理</a></li>
<li><a href="/blog/testing-python/">Python中的测试</a></li>
<li><a href="/blog/modern-tdd/">Python中的现代测试驱动开发</a></li>
<li><a href="/blog/python-code-quality/"> Python代码质量</a></li>
<li><a href="/blog/python-type-checking/"> Python类型检查</a></li>
<li><a href="/blog/documenting-python/">记录Python代码和项目</a></li>
</ol>
<p>在本文中，当您从头到尾开发一个项目时，您将把所有东西粘在一起。开发基本项目后，您将:</p>
<ol>
<li>用<a href="https://github.com/features/actions"> GitHub动作</a>连接CI/CD</li>
<li>用<a href="http://codecov.io/"> CodeCov </a>配置覆盖报告</li>
<li>将包发布到<a href="https://pypi.org/"> PyPi </a>并将文档发布到<a href="https://readthedocs.org/">阅读文档</a></li>
<li>通过GitHub动作更新PyPI并阅读文档</li>
</ol>
<blockquote>
<p>您可以随意将GitHub操作替换为类似的CI/CD工具，如<a href="https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/"> GitLab CI </a>、<a href="https://bitbucket.org/product/features/pipelines"> Bitbucket Pipelines </a>或<a href="https://circleci.com/"> CircleCI </a>。</p>
</blockquote>



<h2 id="project-setup">项目设置</h2>
<p>让我们构建一个随机报价生成器，从一组报价中返回随机选择的报价。</p>
<h3 id="initialize-project">初始化项目</h3>
<p>首先，让我们为我们的项目创建一个新文件夹:</p>
<div class="codehilite"><pre><span/><code>$ mkdir random-quote-generator
$ <span class="nb">cd</span> random-quote-generator
</code></pre></div>

<p>用<a href="https://python-poetry.org">诗歌</a>初始化项目:</p>
<div class="codehilite"><pre><span/><code>$ poetry init

Package name <span class="o">[</span>random_quote_generator<span class="o">]</span>:
Version <span class="o">[</span><span class="m">0</span>.1.0<span class="o">]</span>:
Description <span class="o">[]</span>:
Author <span class="o">[</span>Your name &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f56405a5d6f4a424e4643014c4042">[email protected]</a>&gt;, n to skip<span class="o">]</span>:
License <span class="o">[]</span>:
Compatible Python versions <span class="o">[</span>^3.10<span class="o">]</span>:

Would you like to define your main dependencies interactively? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span> no
Would you like to define your development dependencies interactively? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span> no
Do you confirm generation? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span>
</code></pre></div>

<blockquote>
<p>关于诗歌的更多内容，请查看<a href="/blog/python-environments/">现代Python环境——依赖性和工作空间管理</a>文章。</p>
</blockquote>
<p>您的项目名称必须是唯一的，因为您将把它上传到<a href="https://pypi.org/"> PyPI </a>。因此，为了避免名称冲突，在<em> pyproject.toml </em>中为包名添加一个唯一的字符串。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="k">[tool.poetry]</span><span class="w"/>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"random-quote-generator-9308"</span><span class="w"/>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="w"/>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"/>
<span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"Michael Herman &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="91fffee5e3f4f0fdd1f6fcf0f8fdbff2fefc">[email protected]</a>&gt;"</span><span class="p">]</span><span class="w"/>

<span class="k">[tool.poetry.dependencies]</span><span class="w"/>
<span class="n">python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^3.10"</span><span class="w"/>

<span class="k">[tool.poetry.dev-dependencies]</span><span class="w"/>

<span class="k">[build-system]</span><span class="w"/>
<span class="n">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"poetry-core&gt;=1.0.0"</span><span class="p">]</span><span class="w"/>
<span class="n">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"poetry.core.masonry.api"</span><span class="w"/>
</code></pre></div>

<p>在<a href="https://github.com/new"> GitHub </a>上创建一个新的资源库:</p>
<p><img data-src="/static/images/blog/python-workflow/new_github_repository.png" loading="lazy" class="lazyload" alt="GitHub new repository" src="../Images/e9bcea0236b6554c639261276cbbfffa.png" data-original-src="https://testdriven.io/static/images/blog/python-workflow/new_github_repository.png"/></p>
<p>接下来，初始化项目中的git存储库:</p>
<div class="codehilite"><pre><span/><code>$ git init
$ git add pyproject.toml
$ git commit -m <span class="s2">"first commit"</span>
$ git branch -M main
$ git remote add origin <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8bece2ffcbece2ffe3fee9a5e8e4e6">[email protected]</a>:&lt;your-github-username&gt;/random-quote-generator.git
$ git fetch
$ git branch --set-upstream-to<span class="o">=</span>origin/main main
$ git pull origin main --rebase
$ git push -u origin main
</code></pre></div>

<p>基本设置完成后，让我们继续添加以下开发依赖项:</p>

<blockquote>
<p>查看<a href="/blog/python-code-quality/"> Python代码质量</a>一文，了解关于这些依赖性的详细信息。</p>
</blockquote>
<p>安装:</p>
<div class="codehilite"><pre><span/><code>$ poetry add --dev pytest pytest-cov black isort flake8 bandit safety
</code></pre></div>

<p>将新的<em>poem . lock</em>文件以及更新后的<em> pyproject.toml </em>文件添加到git:</p>
<div class="codehilite"><pre><span/><code>$ git add poetry.lock pyproject.toml
</code></pre></div>

<h3 id="build-the-project">构建项目</h3>
<p>之后，创建一个名为“random_quote_generator”的新文件夹。在该文件夹中，添加一个<em> __init__。py </em>文件，所以它被当作一个模块，还有一个<em> quotes.py </em>文件。</p>
<div class="codehilite"><pre><span/><code>random-quote-generator
├── poetry.lock
├── pyproject.toml
└── random_quote_generator
    ├── __init__.py
    └── quotes.py
</code></pre></div>

<p>在<em> quotes.py </em>中，添加:</p>
<div class="codehilite"><pre><span/><code><span class="n">quotes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">"quote"</span><span class="p">:</span> <span class="s2">"A long descriptive name is better than a short "</span>
        <span class="s2">"enigmatic name. A long descriptive name is better "</span>
        <span class="s2">"than a long descriptive comment."</span><span class="p">,</span>
        <span class="s2">"author"</span><span class="p">:</span> <span class="s2">"Robert C. Martin"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"quote"</span><span class="p">:</span> <span class="s2">"You should name a variable using the same "</span>
        <span class="s2">"care with which you name a first-born child."</span><span class="p">,</span>
        <span class="s2">"author"</span><span class="p">:</span> <span class="s2">"Robert C. Martin"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"quote"</span><span class="p">:</span> <span class="s2">"Any fool can write code that a computer "</span>
        <span class="s2">"can understand. Good programmers write code"</span>
        <span class="s2">" that humans can understand."</span><span class="p">,</span>
        <span class="s2">"author"</span><span class="p">:</span> <span class="s2">"Martin Fowler"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</code></pre></div>

<p>那里没什么特别的。只是一个字典列表，每个引用一个。接下来，在项目根目录下创建一个名为“tests”的新文件夹，并添加以下文件:</p>
<div class="codehilite"><pre><span/><code>tests
├── __init__.py
└── test_get_quote.py
</code></pre></div>

<p><em> test_get_quote.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">random_quote_generator</span> <span class="kn">import</span> <span class="n">get_quote</span>
<span class="kn">from</span> <span class="nn">random_quote_generator.quotes</span> <span class="kn">import</span> <span class="n">quotes</span>


<span class="k">def</span> <span class="nf">test_get_quote</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    GIVEN</span>
<span class="sd">    WHEN get_quote is called</span>
<span class="sd">    THEN random quote from quotes is returned</span>
<span class="sd">    """</span>

    <span class="n">quote</span> <span class="o">=</span> <span class="n">get_quote</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">quotes</span>
</code></pre></div>

<p>运行测试:</p>
<div class="codehilite"><pre><span/><code>$ poetry run python -m pytest tests
</code></pre></div>

<p>它应该会失败:</p>
<div class="codehilite"><pre><span/><code>E   ImportError: cannot import name <span class="s1">'get_quote'</span> from <span class="s1">'random_quote_generator'</span>
</code></pre></div>

<p>接下来，向“random_quote_generator”添加一个名为<em> get_quote.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">random_quote_generator.quotes</span> <span class="kn">import</span> <span class="n">quotes</span>


<span class="k">def</span> <span class="nf">get_quote</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Get random quote</span>

<span class="sd">    Get randomly selected quote from database our programming quotes</span>

<span class="sd">    :return: selected quote</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    """</span>

    <span class="k">return</span> <span class="n">quotes</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
</code></pre></div>

<p>因此，通过生成一个随机整数来选择一个报价，该整数的值为0到最后一个索引之间的random.randint。</p>
<p>在<em>random _ quote _ generator/_ _ init _中导出函数。py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""</span>
<span class="sd">Random Quote Generator</span>
<span class="sd">======================</span>

<span class="sd">Get random quote from our database of programming wisdom</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">.get_quote</span> <span class="kn">import</span> <span class="n">get_quote</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"get_quote"</span><span class="p">]</span>
</code></pre></div>

<p>该函数被导入并在<code>__all__</code>属性中列出，该属性是模块的公共对象列表。换句话说，当有人使用<code>from random_quote_generator import *</code>时，只会导入<code>__all__</code>中列出的名字。</p>
<p>测试现在应该通过了:</p>
<div class="codehilite"><pre><span/><code>$ poetry run python -m pytest tests
</code></pre></div>

<p>创建一个<em>。gitignore项目根目录中的</em>文件:</p>


<p>将“random_quote_generator”和“tests”文件夹与<em>一起添加到git中。gitignore </em>文件:</p>
<div class="codehilite"><pre><span/><code>$ git add random_quote_generator/ tests/ .gitignore
</code></pre></div>

<p>就是这样。包裹已准备好交付。</p>
<h3 id="document-the-project">记录项目</h3>
<p>我们的软件包工作，但我们的用户将不得不检查它的源代码，看看如何使用它。我们已经包含了docstrings，因此我们可以使用<a href="https://www.sphinx-doc.org/en/master/"> Sphinx </a>轻松创建独立的项目文档。</p>
<blockquote>
<p>如果您不熟悉作为独立资源的docstrings或文档，请阅读<a href="/blog/documenting-python/#sphinx">文档化Python代码和项目</a>文章。</p>
</blockquote>
<p>假设您已经安装了Sphinx<a href="https://www.sphinx-doc.org/en/master/usage/installation.html"/>，运行下面的命令在项目根目录中为Sphinx搭建文件和文件夹:</p>


<p>你将被提升一些问题:</p>
<div class="codehilite"><pre><span/><code>&gt; Separate <span class="nb">source</span> and build directories <span class="o">(</span>y/n<span class="o">)</span> <span class="o">[</span>n<span class="o">]</span>: n
&gt; Project name: Random Quote Generator
&gt; Author name<span class="o">(</span>s<span class="o">)</span>: Your Name
&gt; Project release <span class="o">[]</span>: <span class="m">0</span>.1.0
&gt; Project language <span class="o">[</span>en<span class="o">]</span>: en
</code></pre></div>

<p>接下来，让我们更新项目配置。打开<em> docs/conf.py </em>并替换它:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># import os</span>
<span class="c1"># import sys</span>
<span class="c1"># sys.path.insert(0, os.path.abspath('.'))</span>
</code></pre></div>

<p>有了这个:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">'..'</span><span class="p">))</span>
</code></pre></div>

<p>现在，<a href="https://www.sphinx-doc.org/en/master/usage/quickstart.html#autodoc"> autodoc </a>，用于从docstrings中拉入文档，会在“docs”的父文件夹中搜索模块。</p>
<p>将下列扩展名添加到扩展名列表中:</p>
<div class="codehilite"><pre><span/><code>extensions = [
    'sphinx.ext.autodoc',
]
</code></pre></div>

<p>更新<em> docs/index.rst </em>如下:</p>
<div class="codehilite"><pre><span/><code><span class="cp">.. Random Quote Generator documentation master file, created by</span>
<span class="cp">   sphinx-quickstart on Mon Dec 21 22:27:23 2020.</span>
<span class="cp">   You can adapt this file completely to your liking, but it should at least</span>
<span class="cp">   contain the root `toctree` directive.</span>

<span class="gh">Welcome to Random Quote Generator's documentation!</span>
<span class="gh">==================================================</span>

<span class="p">..</span> <span class="ow">automodule</span><span class="p">::</span> random_quote_generator
    <span class="nc">:members:</span>



<span class="gh">Indices and tables</span>
<span class="gh">==================</span>

<span class="m">*</span> <span class="na">:ref:</span><span class="nv">`genindex`</span>
<span class="m">*</span> <span class="na">:ref:</span><span class="nv">`modindex`</span>
<span class="m">*</span> <span class="na">:ref:</span><span class="nv">`search`</span>
</code></pre></div>

<p>这个文件应该从Flake8中排除，我们将很快添加它。因此，在项目根目录下创建一个<em> .flake8 </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="k">[flake8]</span><span class="w"/>
<span class="na">exclude</span><span class="w"> </span><span class="o">=</span><span class="w"/>
<span class="w">    </span><span class="na">docs/conf.py,</span><span class="w"/>
</code></pre></div>

<p>将“docs”文件夹和<em> .flake8 </em>添加到git:</p>


<h2 id="github-actions">GitHub操作</h2>
<p>接下来，让我们用<a href="https://github.com/features/actions"> GitHub动作</a>连接CI管道。</p>
<p>将以下文件和文件夹添加到项目根目录中:</p>
<div class="codehilite"><pre><span/><code>.github
└── workflows
    └── branch.yaml
</code></pre></div>

<p>在<em> branch.yaml </em>中，添加:</p>
<div class="codehilite"><pre><span/><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Push</span><span class="w"/>
<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">]</span><span class="w"/>

<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"/>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'3.10'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'1.1.13'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a5c6cdc0c6cecad0d1e5d396">[email protected]</a></span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d9aabcadaca9f4a9a0adb1b6b799afea">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run image</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abatilo/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0b6a687f62646578267b646e7f79724b7d39253a253f">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.poetry-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry install</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run pytest --cov=./ --cov-report=xml</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage to Codecov</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="20434f4445434f560d414354494f4e605612">[email protected]</a></span><span class="w"/>
<span class="w">  </span><span class="nt">code-quality</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"/>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'3.10'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'1.1.13'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="24474c41474f4b5150645217">[email protected]</a></span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7f0c1a0b0a0f520f060b1710113f094c">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run image</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abatilo/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="137270677a7c7d603e637c7667616a5365213d223d27">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.poetry-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry install</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run black</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run black . --check</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run isort</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run isort . --check-only --profile black</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run flake8</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run flake8 .</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run bandit</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run bandit .</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run saftey</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run safety check</span><span class="w"/>
</code></pre></div>

<p>这种配置:</p>
<ul>
<li>在每个分支的每次推送时运行- <code>on: [push]</code></li>
<li>运行在最新版本的Ubuntu - <code>ubuntu-latest</code></li>
<li>使用Python 3.10 - <code>python-version: [3.10]</code>，<code>python-version: ${{ matrix.python-version }}</code></li>
<li>1.1.13 -使用诗歌版本<code>poetry-version: [1.1.13]</code>，<code>poetry-version: ${{ matrix.poetry-version }}</code></li>
</ul>
<p>定义了两个作业:<code>test</code>和<code>code-quality</code>。顾名思义，测试在测试作业中运行，而我们的代码质量检查在代码质量作业中运行。</p>
<p>现在，每次推送GitHub库时，测试和代码质量工作都会运行。</p>
<p>添加”。github "到git:</p>


<p>运行所有代码质量检查:</p>
<div class="codehilite"><pre><span/><code>$ poetry run black .
$ poetry run isort . --profile black
$ poetry run flake8 .
$ poetry run bandit .
$ poetry run safety check
</code></pre></div>

<p>确保添加任何可能已经更改为git的文件。然后，将您的更改提交并推送到GitHub:</p>
<div class="codehilite"><pre><span/><code>$ git add docs/ random_quote_generator/ tests/
$ git commit -m <span class="s1">'Package ready'</span>
$ git push -u origin main
</code></pre></div>

<p>您应该在GitHub存储库的“Actions”选项卡上看到您的工作流正在运行。在继续前进之前确保它通过。</p>
<h2 id="codecov">CodeCov</h2>
<p>接下来，我们将配置<a href="http://codecov.io/"> CodeCov </a>来跟踪代码覆盖率。导航到http://codecov.io/的<a href="http://codecov.io/"/>，用你的GitHub账号登录，找到你的库。</p>
<blockquote>
<p>查看<a href="https://docs.codecov.io/docs/quick-start">快速入门</a>指南，获得使用CodeCov的帮助。</p>
</blockquote>
<p>再次运行GitHub操作工作流程。完成后，您应该能够在CodeCov:</p>
<p><img data-src="/static/images/blog/python-workflow/codecov.png" loading="lazy" class="lazyload" alt="CodeCov" src="../Images/6e7fa684a5fafaa48574070283ae2757.png" data-original-src="https://testdriven.io/static/images/blog/python-workflow/codecov.png"/></p>
<p>现在，每次您的工作流运行时，都会生成一个覆盖报告并上传到CodeCov。您可以分析分支、提交和拉请求的覆盖率的变化，重点关注覆盖率随时间的增加和减少。</p>
<h2 id="read-the-docs">阅读文件</h2>
<p>我们将使用<a href="https://readthedocs.org">Read Docs</a>来存放我们的文档。导航到https://readthedocs.org的<a href="https://readthedocs.org"/>，使用你的GitHub账户登录。</p>
<blockquote>
<p>如果您刚刚注册，请确保在继续之前验证您的电子邮件地址。</p>
</blockquote>
<p>接下来，点击“导入项目”。之后，刷新您的项目并添加随机报价生成器项目。打开项目并导航到“Admin”部分。然后，在“高级设置”下，将默认分支设置为<code>main</code>。不要忘记保存您的更改。</p>
<p><img data-src="/static/images/blog/python-workflow/main.png" loading="lazy" class="lazyload" alt="Read the Docs" src="../Images/dafe40c7070f531821bff2920f77bcd4.png" data-original-src="https://testdriven.io/static/images/blog/python-workflow/main.png"/></p>
<p>阅读文档并构建文档需要几分钟时间。一旦完成，您应该能够在<code>https://your-project-slug-on-readthedocs.readthedocs.io</code>查看您的项目文档。</p>
<p><img data-src="/static/images/blog/python-workflow/read_the_docs.png" loading="lazy" class="lazyload" alt="Read the Docs" src="../Images/d76642b9da72c7de23439377e4c8fca1.png" data-original-src="https://testdriven.io/static/images/blog/python-workflow/read_the_docs.png"/></p>
<p>默认情况下，文档将在每次推送到<code>main</code>分支时重新构建。这样，剩下的唯一事情就是将您的包发布到PyPI。</p>
<h2 id="pypi">好吧</h2>
<p>最后，为了使项目“可安装pip ”,我们将把它发布到<a href="https://pypi.org/"> PyPI </a>。</p>
<p>首先将以下部分添加到<em> pyproject.toml </em>中，以便将“random_quote_generator”模块包含在PyPI的发行版中:</p>
<div class="codehilite"><pre><span/><code><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"random_quote_generator"</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>
</code></pre></div>

<p>示例文件:</p>
<div class="codehilite"><pre><span/><code><span class="k">[tool.poetry]</span><span class="w"/>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"random-quote-generator-93618"</span><span class="w"/>
<span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"random_quote_generator"</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="w"/>
<span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"/>
<span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"Amir Tadrisi &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d1bfbea5a3b4b0bd91b6bcb0b8bdffb2bebc">[email protected]</a>&gt;"</span><span class="p">]</span><span class="w"/>

<span class="k">[tool.poetry.dependencies]</span><span class="w"/>
<span class="n">python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^3.10"</span><span class="w"/>

<span class="k">[tool.poetry.dev-dependencies]</span><span class="w"/>
<span class="n">pytest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^7.1.2"</span><span class="w"/>
<span class="n">pytest-cov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^3.0.0"</span><span class="w"/>
<span class="n">black</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^22.3.0"</span><span class="w"/>
<span class="n">isort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^5.10.1"</span><span class="w"/>
<span class="n">flake8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^4.0.1"</span><span class="w"/>
<span class="n">bandit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^1.7.4"</span><span class="w"/>
<span class="n">safety</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"^1.10.3"</span><span class="w"/>

<span class="k">[build-system]</span><span class="w"/>
<span class="n">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"poetry-core&gt;=1.0.0"</span><span class="p">]</span><span class="w"/>
<span class="n">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"poetry.core.masonry.api"</span><span class="w"/>
</code></pre></div>

<p>添加一个名为<em> release.yaml </em>的新文件到”。github/工作流”:</p>
<div class="codehilite"><pre><span/><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Release</span><span class="w"/>
<span class="nt">on</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">release</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">types</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">created</span><span class="w"/>

<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">publish</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"/>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'3.10'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'1.1.13'</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="17747f72747c786263576124">[email protected]</a></span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4e3d2b3a3b3e633e373a2621200e387d">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run image</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abatilo/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a2c3c1d6cbcdccd18fd2cdc7d6d0dbe2d4908c938c96">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.poetry-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Publish</span><span class="w"/>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">PYPI_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.PYPI_TOKEN }}</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"/>
<span class="w">          </span><span class="no">poetry config pypi-token.pypi $PYPI_TOKEN</span><span class="w"/>
<span class="w">          </span><span class="no">poetry publish --build</span><span class="w"/>
</code></pre></div>

<p>因此，当一个新的<a href="https://docs.github.com/en/free-pro-team@latest/github/administering-a-repository/managing-releases-in-a-repository">版本</a>被创建时，这个包将被发布到PyPI。</p>
<p>接下来，我们需要创建一个PyPI令牌。如果你还没有的话，在PyPI上创建一个账户。然后，一旦登录，点击“帐户设置”并添加一个新的API令牌。复制令牌。现在您需要将它添加到您的GitHub库的秘密中。在回购中，单击“设置”选项卡，然后单击“秘密”并选择“操作”。使用<code>PYPI_TOKEN</code>作为秘密名称，使用令牌值作为秘密值。</p>
<p>现在您已经准备好创建您的第一个版本了。</p>
<p>将<em> release.yaml </em>文件以及更新后的<em> pyproject.toml </em>文件添加到git，提交并推送:</p>
<div class="codehilite"><pre><span/><code>$ git add .github/workflows/release.yaml pyproject.toml
$ git commit -m <span class="s1">'Ready for first release'</span>
$ git push -u origin main
</code></pre></div>

<p>要创建新版本，请导航至<code>https://github.com/&lt;username&gt;/&lt;project-name&gt;/releases/</code>。单击“创建新版本”。输入<code>0.1.0</code>作为标签，输入<code>Initial Release</code>作为标题。</p>
<p><img data-src="/static/images/blog/python-workflow/new_release.png" loading="lazy" class="lazyload" alt="GitHub new release" src="../Images/5fbad10b5da602c25d6bcbace109caef.png" data-original-src="https://testdriven.io/static/images/blog/python-workflow/new_release.png"/></p>
<p>这将在GitHub操作上触发一个新的工作流。一旦完成，您应该会在PyPI上看到您的包。</p>
<p>现在您应该能够从PyPI安装和使用您的包了:</p>
<div class="codehilite"><pre><span/><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">random_quote_generator</span> <span class="kn">import</span> <span class="n">get_quote</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">get_quote</span><span class="p">())</span>
<span class="p">{</span><span class="s1">'quote'</span><span class="p">:</span> <span class="s1">'Any fool can write code that a computer can understand. Good programmers write code that humans can understand.'</span><span class="p">,</span> <span class="s1">'author'</span><span class="p">:</span> <span class="s1">'Martin Fowler'</span><span class="p">}</span>
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>我们为发布到PyPI的Python包设置了一个简单的CI/CD管道。通过测试和代码质量来检查每个分支上的代码。您可以在CodeCov中检查代码覆盖率。在发布时，新版本被部署到PyPI，文档被更新。这可以大大简化你的生活。</p>
<p>像这样的自动化管道有助于确保您的工作流程日复一日保持一致。尽管如此，你仍然应该关心你的团队的工作文化。测试在推送时运行，但它们必须存在。如果您没有任何测试要运行，自动化测试运行不会有太大帮助。自动化也不会对您的变更大小产生太大的影响。尽量保持小规模，经常合并到<code>main</code>。伴随着测试驱动开发(TDD)和CI/CD管道的小变化会对你所交付的软件的质量产生巨大的影响。只是不要忘记，它总是以团队文化开始和结束。</p>
<blockquote>
<p><a href="/guides/complete-python/">完整Python </a>指南:</p>
<ol>
<li><a href="/blog/python-environments/">现代Python环境——依赖性和工作空间管理</a></li>
<li><a href="/blog/testing-python/">Python中的测试</a></li>
<li><a href="/blog/modern-tdd/">Python中的现代测试驱动开发</a></li>
<li><a href="/blog/python-code-quality/"> Python代码质量</a></li>
<li><a href="/blog/python-type-checking/"> Python类型检查</a></li>
<li><a href="/blog/documenting-python/">记录Python代码和项目</a></li>
<li><a href="/blog/python-project-workflow/"> Python项目工作流程</a>(本文！)</li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>