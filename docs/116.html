<html>
<head>
<title>Dockerizing Django with Postgres, Gunicorn, and Nginx </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Postgres、Gunicorn和Nginx编写Django文档</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/#0001-01-01">https://testdriven.io/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>这是一个循序渐进的教程，详细介绍了如何配置Django，使其在带有Postgres的Docker上运行。对于生产环境，我们将添加Nginx和Gunicorn。我们还将看看如何通过Nginx提供Django静态和媒体文件。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>Django v3.2.6</li>
<li>文档v20.10.8</li>
<li>python 3 . 9 . 6版</li>
</ol>
<blockquote>
<p>姜戈码头系列:</p>
<ol>
<li><a href="/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/">用Postgres、Gunicorn、Nginx </a>(本文！)</li>
<li><a href="/blog/django-lets-encrypt/">用加密保护容器化的Django应用</a></li>
<li><a href="/blog/django-docker-https-aws/">用Docker将Django部署到AWS，让我们加密</a></li>
</ol>
</blockquote>



<h2 id="project-setup">项目设置</h2>
<p>创建一个新的项目目录和一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-on-docker <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-on-docker
$ mkdir app <span class="o">&amp;&amp;</span> <span class="nb">cd</span> app
$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate
<span class="o">(</span>env<span class="o">)</span>$

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.2.6
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject hello_django .
<span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>查看Django欢迎屏幕。一旦完成就杀死服务器。然后，退出并删除虚拟环境。我们现在有了一个简单的Django项目。</p>
<p>在“app”目录下创建一个<em> requirements.txt </em>文件，并添加Django作为依赖项:</p>


<p>因为我们将转移到Postgres，所以继续从“app”目录中删除<em> db.sqlite3 </em>文件。</p>
<p>您的项目目录应该如下所示:</p>
<div class="codehilite"><pre><span/><code>└── app
    ├── hello_django
    │   ├── __init__.py
    │   ├── asgi.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    └── requirements.txt
</code></pre></div>

<h2 id="docker">码头工人</h2>
<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有，那么在“app”目录下添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.6-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>所以，我们从Python 3.9.6的基于<a href="https://github.com/gliderlabs/docker-alpine"> Alpine </a>的<a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及两个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
</ol>
<p>最后，我们更新了Pip，复制了<em> requirements.txt </em>文件，安装了依赖项，并复制了Django项目本身。</p>
<blockquote>
<p>查看<a href="https://mherman.org/presentations/dockercon-2018">Docker for Python Developers</a>了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将一个<em> docker-compose.yml </em>文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.dev</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>，了解该文件如何工作的信息。</p>
</blockquote>
<p>更新<em> settings.py </em>中的<code>SECRET_KEY</code>、<code>DEBUG</code>和<code>ALLOWED_HOSTS</code>变量:</p>
<div class="codehilite"><pre><span/><code><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SECRET_KEY"</span><span class="p">)</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"DEBUG"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># 'DJANGO_ALLOWED_HOSTS' should be a single string of hosts with a space between each.</span>
<span class="c1"># For example: 'DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]'</span>
<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"DJANGO_ALLOWED_HOSTS"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
</code></pre></div>

<p>确保将导入添加到顶部:</p>


<p>然后，在项目根目录下创建一个<em> .env.dev </em>文件来存储开发环境变量:</p>
<div class="codehilite"><pre><span/><code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
</code></pre></div>

<p>建立形象:</p>


<p>构建映像后，运行容器:</p>


<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>再次查看欢迎屏幕。</p>
<blockquote>
<p>如果这不起作用，通过<code>docker-compose logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="postgres">Postgres</h2>
<p>要配置Postgres，我们需要向<em> docker-compose.yml </em>文件添加一个新服务，更新Django设置，并安装<a href="https://www.psycopg.org/"> Psycopg2 </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.dev</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_django</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_django</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_django_dev</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>我们还需要为<code>web</code>服务添加一些新的环境变量，所以像这样更新<em> .env.dev </em>:</p>
<div class="codehilite"><pre><span/><code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_dev
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
</code></pre></div>

<p>更新<em> settings.py </em>中的<code>DATABASES</code> dict:</p>
<div class="codehilite"><pre><span/><code><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"default"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"ENGINE"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_ENGINE"</span><span class="p">,</span> <span class="s2">"django.db.backends.sqlite3"</span><span class="p">),</span>
        <span class="s2">"NAME"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_DATABASE"</span><span class="p">,</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">"db.sqlite3"</span><span class="p">),</span>
        <span class="s2">"USER"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_USER"</span><span class="p">,</span> <span class="s2">"user"</span><span class="p">),</span>
        <span class="s2">"PASSWORD"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_PASSWORD"</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">),</span>
        <span class="s2">"HOST"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_HOST"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">),</span>
        <span class="s2">"PORT"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SQL_PORT"</span><span class="p">,</span> <span class="s2">"5432"</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这里，数据库是基于我们刚刚定义的环境变量进行配置的。记下默认值。</p>
<p>更新docker文件以安装Psycopg2所需的相应软件包:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.6-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2 dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev gcc python3-dev musl-dev

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>将Psycopg2添加到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>Django==3.2.6
psycopg2-binary==2.9.1
</code></pre></div>

<blockquote>
<p>查看<a href="https://github.com/psycopg/psycopg2/issues/684">本期GitHub</a>了解更多关于在基于Alpine的Docker映像中安装Psycopg2的信息。</p>
</blockquote>
<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>运行迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<blockquote>
<p>得到以下错误？</p>
<div class="codehilite"><pre><span/>django.db.utils.OperationalError: FATAL:  database <span class="s2">"hello_django_dev"</span> does not exist
</pre></div><p>运行<code>docker-compose down -v</code>移除卷和容器。然后，重新构建映像，运行容器，并应用迁移。</p></blockquote>

<p>确保创建了默认的Django表:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_django --dbname<span class="o">=</span>hello_django_dev

psql <span class="o">(</span><span class="m">13</span>.0<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                          List of databases
       Name       <span class="p">|</span>    Owner     <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>       Access privileges
------------------+--------------+----------+------------+------------+-------------------------------
 hello_django_dev <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres         <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0        <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_django              +
                  <span class="p">|</span>              <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_django</span><span class="o">=</span>CTc/hello_django
 template1        <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_django              +
                  <span class="p">|</span>              <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_django</span><span class="o">=</span>CTc/hello_django
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \c hello_django_dev</span>
You are now connected to database <span class="s2">"hello_django_dev"</span> as user <span class="s2">"hello_django"</span>.

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \dt</span>
                     List of relations
 Schema <span class="p">|</span>            Name            <span class="p">|</span> Type  <span class="p">|</span>    Owner
--------+----------------------------+-------+--------------
 public <span class="p">|</span> auth_group                 <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_group_permissions     <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_permission            <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user                  <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user_groups           <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user_user_permissions <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_admin_log           <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_content_type        <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_migrations          <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_session             <span class="p">|</span> table <span class="p">|</span> hello_django
<span class="o">(</span><span class="m">10</span> rows<span class="o">)</span>

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>您也可以通过运行以下命令来检查该卷是否已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker volume inspect django-on-docker_postgres_data
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2021-08-23T15:49:08Z"</span>,
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{</span>
            <span class="s2">"com.docker.compose.project"</span>: <span class="s2">"django-on-docker"</span>,
            <span class="s2">"com.docker.compose.version"</span>: <span class="s2">"1.29.2"</span>,
            <span class="s2">"com.docker.compose.volume"</span>: <span class="s2">"postgres_data"</span>
        <span class="o">}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/django-on-docker_postgres_data/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"django-on-docker_postgres_data"</span>,
        <span class="s2">"Options"</span>: null,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>

<p>接下来，在应用迁移并运行Django开发服务器之前，将<em> entrypoint.sh </em>文件添加到“app”目录中，以验证Postgres是否健康<em>:</em></p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

python manage.py flush --no-input
python manage.py migrate

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fedabe">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<p>在本地更新文件权限:</p>
<div class="codehilite"><pre><span/><code>$ chmod +x app/entrypoint.sh
</code></pre></div>

<p>然后，更新Docker文件以复制覆盖<em> entrypoint.sh </em>文件，并将其作为Docker <a href="https://docs.docker.com/engine/reference/builder/#entrypoint"> entrypoint </a>命令运行:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.6-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2 dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev gcc python3-dev musl-dev

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy entrypoint.sh</span>
<span class="k">COPY</span><span class="w"> </span>./entrypoint.sh .
<span class="k">RUN</span><span class="w"> </span>sed -i <span class="s1">'s/\r$//g'</span> /usr/src/app/entrypoint.sh
<span class="k">RUN</span><span class="w"> </span>chmod +x /usr/src/app/entrypoint.sh

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .

<span class="c"># run entrypoint.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/usr/src/app/entrypoint.sh"</span><span class="p">]</span>
</code></pre></div>

<p>将<code>DATABASE</code>环境变量添加到<em> .env.dev </em>:</p>
<div class="codehilite"><pre><span/><code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_dev
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres
</code></pre></div>

<p>再次测试:</p>
<ol>
<li>重建图像</li>
<li>运行容器</li>
<li>试试<a href="http://localhost:8000/"> http://localhost:8000/ </a></li>
</ol>
<h3 id="notes">笔记</h3>
<p>首先，尽管添加了Postgres，只要<code>DATABASE</code>环境变量没有设置为<code>postgres</code>，我们仍然可以为Django创建一个独立的Docker映像。要进行测试，构建一个新的映像，然后运行一个新的容器:</p>
<div class="codehilite"><pre><span/><code>$ docker build -f ./app/Dockerfile -t hello_django:latest ./app
$ docker run -d <span class="se">\</span>
    -p <span class="m">8006</span>:8000 <span class="se">\</span>
    -e <span class="s2">"SECRET_KEY=please_change_me"</span> -e <span class="s2">"DEBUG=1"</span> -e <span class="s2">"DJANGO_ALLOWED_HOSTS=*"</span> <span class="se">\</span>
    hello_django python /usr/src/app/manage.py runserver <span class="m">0</span>.0.0.0:8000
</code></pre></div>

<p>您应该能够在<a href="http://localhost:8006"> http://localhost:8006 </a>查看欢迎页面</p>
<p>其次，您可能希望注释掉<em> entrypoint.sh </em>脚本中的数据库刷新和迁移命令，这样它们就不会在每次容器启动或重新启动时运行:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="c1"># python manage.py flush --no-input</span>
<span class="c1"># python manage.py migrate</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c9ed89">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<p>相反，您可以在容器旋转后手动运行它们，如下所示:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py flush --no-input
$ docker-compose <span class="nb">exec</span> web python manage.py migrate
</code></pre></div>

<h2 id="gunicorn">格尼科恩</h2>
<p>接下来，对于生产环境，让我们将<a href="https://gunicorn.org/"> Gunicorn </a>，一个生产级的WSGI服务器，添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>Django==3.2.6
gunicorn==20.1.0
psycopg2-binary==2.9.1
</code></pre></div>

<blockquote>
<p>对WSGI和Gunicorn很好奇？回顾来自<a href="https://testdriven.io/courses/python-web-framework/">构建你自己的Python Web框架</a>课程的<a href="https://testdriven.io/courses/python-web-framework/wsgi/"> WSGI </a>章节。</p>
</blockquote>
<p>由于我们仍然希望在开发中使用Django的内置服务器，因此为生产创建一个名为<em> docker-compose.prod.yml </em>的新合成文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果您有多个环境，您可能希望使用一个<a href="https://docs.docker.com/compose/extends/">docker-compose . override . yml</a>配置文件。使用这种方法，您可以将您的基本配置添加到一个<em> docker-compose.yml </em>文件中，然后使用一个<em>docker-compose . override . yml</em>文件根据环境覆盖那些配置设置。</p>
</blockquote>
<p>记下默认值<code>command</code>。我们运行的是Gunicorn，而不是Django开发服务器。我们还从<code>web</code>服务中删除了这个卷，因为我们在生产中不需要它。最后，我们使用<a href="https://docs.docker.com/compose/env-file/">单独的环境变量文件</a>来定义两个服务的环境变量，它们将在运行时传递给容器。</p>
<p><em> .env.prod </em>:</p>
<div class="codehilite"><pre><span/><code>DEBUG=0
SECRET_KEY=change_me
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_prod
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres
</code></pre></div>

<p><em> .env.prod.db </em>:</p>
<div class="codehilite"><pre><span/><code>POSTGRES_USER=hello_django
POSTGRES_PASSWORD=hello_django
POSTGRES_DB=hello_django_prod
</code></pre></div>

<p>将这两个文件添加到项目根目录。您可能想让它们不受版本控制，所以将它们添加到一个<em>中。gitignore </em>文件。</p>
<p>将<a href="https://docs.docker.com/compose/reference/down/">下放到</a>开发容器(以及带有<code>-v</code>标志的相关卷):</p>


<p>然后，构建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>验证<code>hello_django_prod</code>数据库是和默认的Django表一起创建的。在<a href="http://localhost:8000/admin">http://localhost:8000/admin</a>测试管理页面。静态文件不再被加载。这是意料之中的，因为调试模式已关闭。我们会尽快解决这个问题。</p>
<blockquote>
<p>同样，如果容器启动失败，通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="production-dockerfile">生产文档</h2>
<p>您是否注意到我们仍然在运行数据库<a href="https://docs.djangoproject.com/en/2.2/ref/django-admin/#flush"> flush </a>(清空数据库)并在每次运行容器时迁移命令？这在开发中很好，但是让我们为生产创建一个新的入口点文件。</p>
<p>entry point . prod . sh:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="af8bef">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<p>在本地更新文件权限:</p>
<div class="codehilite"><pre><span/><code>$ chmod +x app/entrypoint.prod.sh
</code></pre></div>

<p>要使用这个文件，创建一个名为<em> Dockerfile.prod </em>的新Dockerfile，用于生产构建:</p>
<div class="codehilite"><pre><span/><code><span class="c">###########</span>
<span class="c"># BUILDER #</span>
<span class="c">###########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.6-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2 dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev gcc python3-dev musl-dev

<span class="c"># lint</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install <span class="nv">flake8</span><span class="o">==</span><span class="m">3</span>.9.2
<span class="k">COPY</span><span class="w"> </span>. .
<span class="k">RUN</span><span class="w"> </span>flake8 --ignore<span class="o">=</span>E501,F401 .

<span class="c"># install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt


<span class="c">#########</span>
<span class="c"># FINAL #</span>
<span class="c">#########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.6-alpine</span>

<span class="c"># create directory for the app user</span>
<span class="k">RUN</span><span class="w"> </span>mkdir -p /home/app

<span class="c"># create the app user</span>
<span class="k">RUN</span><span class="w"> </span>addgroup -S app <span class="o">&amp;&amp;</span> adduser -S app -G app

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apk update <span class="o">&amp;&amp;</span> apk add libpq
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/wheels /wheels
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --no-cache /wheels/*

<span class="c"># copy entrypoint.prod.sh</span>
<span class="k">COPY</span><span class="w"> </span>./entrypoint.prod.sh .
<span class="k">RUN</span><span class="w"> </span>sed -i <span class="s1">'s/\r$//g'</span>  <span class="nv">$APP_HOME</span>/entrypoint.prod.sh
<span class="k">RUN</span><span class="w"> </span>chmod +x  <span class="nv">$APP_HOME</span>/entrypoint.prod.sh

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. <span class="nv">$APP_HOME</span>

<span class="c"># chown all the files to the app user</span>
<span class="k">RUN</span><span class="w"> </span>chown -R app:app <span class="nv">$APP_HOME</span>

<span class="c"># change to the app user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">app</span>

<span class="c"># run entrypoint.prod.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/home/app/web/entrypoint.prod.sh"</span><span class="p">]</span>
</code></pre></div>

<p>在这里，我们使用了一个Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>来缩小最终的图像尺寸。本质上，<code>builder</code>是一个用于构建Python轮子的临时图像。然后车轮被复制到最终产品图像中，而<code>builder</code>图像被丢弃。</p>
<blockquote>
<p>你可以将<a href="https://stackoverflow.com/a/53101932/1799408">多阶段构建方法</a>更进一步，使用单个<em>docker文件</em>而不是创建两个docker文件。思考在两个不同的文件上使用这种方法的利弊。</p>
</blockquote>
<p>您是否注意到我们创建了一个非root用户？默认情况下，Docker在容器内部以root用户身份运行容器进程。这是一种不好的做法，因为如果攻击者设法突破容器，他们可以获得Docker主机的根用户访问权限。如果您是容器中的root用户，那么您将是主机上的root用户。</p>
<p>更新<em> docker-compose.prod.yml </em>文件中的<code>web</code>服务，用<em> Dockerfile.prod </em>构建:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<h2 id="nginx">Nginx</h2>
<p>接下来，让我们将Nginx添加进来，充当Gunicorn的反向代理来处理客户端请求以及提供静态文件。</p>
<p>将服务添加到<em> docker-compose.prod.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
</code></pre></div>

<p>然后，在本地项目根目录中，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<p><em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.21-alpine</span>

<span class="k">RUN</span><span class="w"> </span>rm /etc/nginx/conf.d/default.conf
<span class="k">COPY</span><span class="w"> </span>nginx.conf /etc/nginx/conf.d
</code></pre></div>

<p><em>engine . conf</em>:</p>
<div class="codehilite"><pre><span/><code>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.nginx.com/nginx/admin-guide/web-server/app-gateway-uwsgi-django/">使用NGINX和NGINX Plus作为uWSGI和Django的应用网关</a>,了解更多关于配置NGINX与Django协同工作的信息。</p>
</blockquote>
<p>然后，更新<code>web</code>服务，在<em> docker-compose.prod.yml </em>中，用<code>expose</code>替换<code>ports</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">  </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>现在，端口8000只在内部对其他Docker服务公开。该端口将不再发布到主机上。</p>
<blockquote>
<p>关于端口与暴露的更多信息，请查看<a href="https://stackoverflow.com/questions/40801772/what-is-the-difference-between-docker-compose-ports-vs-expose">这个</a>堆栈溢出问题。</p>
</blockquote>
<p>再测试一次。</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<p>确保应用程序在<a href="http://localhost:1337"> http://localhost:1337 </a>启动并运行。</p>
<p>您的项目结构现在应该看起来像这样:</p>
<div class="codehilite"><pre><span/><code>├── .env.dev
├── .env.prod
├── .env.prod.db
├── .gitignore
├── app
│   ├── Dockerfile
│   ├── Dockerfile.prod
│   ├── entrypoint.prod.sh
│   ├── entrypoint.sh
│   ├── hello_django
│   │   ├── __init__.py
│   │   ├── asgi.py
│   │   ├── settings.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   ├── manage.py
│   └── requirements.txt
├── docker-compose.prod.yml
├── docker-compose.yml
└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<p>完成后将容器拿下来:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>

<p>由于Gunicorn是一个应用服务器，它不会提供静态文件。那么，在这种特定的配置中，应该如何处理静态文件和媒体文件呢？</p>
<h2 id="static-files">静态文件</h2>
<p>更新<em> settings.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nv">STATIC_URL</span> <span class="o">=</span> <span class="s2">"/static/"</span>
<span class="nv">STATIC_ROOT</span> <span class="o">=</span> BASE_DIR / <span class="s2">"staticfiles"</span>
</code></pre></div>

<h3 id="development">发展</h3>
<p>现在，对<code>http://localhost:8000/static/*</code>的任何请求都将从“staticfiles”目录得到服务。</p>
<p>为了进行测试，首先重新构建映像，并像往常一样旋转新的容器。确保静态文件仍然在<a href="http://localhost:8000/admin">http://localhost:8000/admin</a>上被正确地提供。</p>
<h3 id="production">生产</h3>
<p>对于生产，向<em> docker-compose.prod.yml </em>中的<code>web</code>和<code>nginx</code>服务添加一个卷，这样每个容器将共享一个名为“staticfiles”的目录:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>我们还需要在<em> Dockerfile.prod </em>中创建“/home/app/web/staticfiles”文件夹:</p>
<div class="codehilite"><pre><span/><code>...

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>/staticfiles
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

...
</code></pre></div>

<p>为什么这是必要的？</p>
<p>Docker Compose通常将命名的卷挂载为根卷。由于我们使用的是非根用户，如果目录不存在，那么当运行<code>collectstatic</code>命令时，我们会得到一个权限被拒绝的错误</p>
<p>要解决这个问题，您可以:</p>
<ol>
<li>在Dockerfile ( <a href="https://github.com/docker/compose/issues/3270#issuecomment-206214034"> source </a>)中创建文件夹</li>
<li>挂载后更改目录的权限(<a href="https://stackoverflow.com/a/40510068/1799408"> source </a>)</li>
</ol>
<p>我们用的是前者。</p>
<p>接下来，更新Nginx配置，将静态文件请求路由到“staticfiles”文件夹:</p>
<div class="codehilite"><pre><span/><code>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/staticfiles/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>降低开发容器的转速:</p>


<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py collectstatic --no-input --clear
</code></pre></div>

<p>同样，对<code>http://localhost:1337/static/*</code>的请求将由“staticfiles”目录提供。</p>
<p>导航到<a href="http://localhost:1337/admin">http://localhost:1337/admin</a>并确保静态资产正确加载。</p>
<p>您还可以通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>在日志中验证对静态文件的请求是否通过Nginx成功提供:</p>
<div class="codehilite"><pre><span/><code>nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /admin/ HTTP/1.1"</span> <span class="m">302</span> <span class="m">0</span> <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /admin/login/?next=/admin/ HTTP/1.1"</span> <span class="m">200</span> <span class="m">2214</span> <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/css/base.css HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/admin/login/?next=/admin/"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/css/nav_sidebar.css HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/admin/login/?next=/admin/"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/css/responsive.css HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/admin/login/?next=/admin/"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/css/login.css HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/admin/login/?next=/admin/"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/js/nav_sidebar.js HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/admin/login/?next=/admin/"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/css/fonts.css HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/static/admin/css/base.css"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/fonts/Roboto-Regular-webfont.woff HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/static/admin/css/fonts.css"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
nginx_1  <span class="p">|</span> <span class="m">192</span>.168.144.1 - - <span class="o">[</span><span class="m">23</span>/Aug/2021:20:11:00 +0000<span class="o">]</span> <span class="s2">"GET /static/admin/fonts/Roboto-Light-webfont.woff HTTP/1.1"</span> <span class="m">304</span> <span class="m">0</span> <span class="s2">"http://localhost:1337/static/admin/css/fonts.css"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36"</span> <span class="s2">"-"</span>
</code></pre></div>

<p>完成后带上容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>


<p>要测试媒体文件的处理，首先要创建一个新的Django应用程序:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> web python manage.py startapp upload
</code></pre></div>

<p>将新应用添加到<em> settings.py </em>中的<code>INSTALLED_APPS</code>列表:</p>
<div class="codehilite"><pre><span/><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"django.contrib.admin"</span><span class="p">,</span>
    <span class="s2">"django.contrib.auth"</span><span class="p">,</span>
    <span class="s2">"django.contrib.contenttypes"</span><span class="p">,</span>
    <span class="s2">"django.contrib.sessions"</span><span class="p">,</span>
    <span class="s2">"django.contrib.messages"</span><span class="p">,</span>
    <span class="s2">"django.contrib.staticfiles"</span><span class="p">,</span>

    <span class="s2">"upload"</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p><em> app/upload/views.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">FileSystemStorage</span>


<span class="k">def</span> <span class="nf">image_upload</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s2">"image_file"</span><span class="p">]:</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s2">"image_file"</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">"upload.html"</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">"image_url"</span><span class="p">:</span> <span class="n">image_url</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">"upload.html"</span><span class="p">)</span>
</code></pre></div>

<p>在“app/upload”目录下添加一个“templates”，然后添加一个名为<em>upload.html</em>的新模板:</p>
<div class="codehilite"><pre><span/><code>{% block content %}

  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"{% url "</span><span class="na">upload</span><span class="err">"</span> <span class="err">%}"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span><span class="p">&gt;</span>
    {% csrf_token %}
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"image_file"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"submit"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

  {% if image_url %}
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>File uploaded at: <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{{ image_url }}"</span><span class="p">&gt;</span>{{ image_url }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  {% endif %}

{% endblock %}
</code></pre></div>

<p><em> app/hello_django/urls.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>

<span class="kn">from</span> <span class="nn">upload.views</span> <span class="kn">import</span> <span class="n">image_upload</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">image_upload</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"upload"</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">"admin/"</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</code></pre></div>

<p><em>app/hello _ django/settings . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s2">"/media/"</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">"mediafiles"</span>
</code></pre></div>

<h3 id="development_1">发展</h3>
<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>你应该可以在<a href="http://localhost:8000/"> http://localhost:8000/ </a>上传一张图片，然后在<a href="http://localhost:8000/media/IMAGE_FILE_NAME">http://localhost:8000/media/IMAGE _ FILE _ NAME</a>查看图片。</p>
<h3 id="production_1">生产</h3>
<p>对于生产，向<code>web</code>和<code>nginx</code>服务添加另一个卷:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">media_volume</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>在<em> Dockerfile.prod </em>中创建“/home/app/web/mediafiles”文件夹:</p>
<div class="codehilite"><pre><span/><code>...

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>/staticfiles
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>/mediafiles
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

...
</code></pre></div>

<p>再次更新Nginx配置:</p>
<div class="codehilite"><pre><span/><code>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/staticfiles/<span class="p">;</span>
    <span class="o">}</span>

    location /media/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/mediafiles/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>重建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v

$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py collectstatic --no-input --clear
</code></pre></div>

<p>最后一次测试:</p>
<ol>
<li>在<a href="http://localhost:1337/">上传一张图片http://localhost:1337/ </a>。</li>
<li>然后在<a href="http://localhost:1337/media/IMAGE_FILE_NAME">http://localhost:1337/media/IMAGE _ FILE _ NAME</a>查看图片。</li>
</ol>
<blockquote>
<p>如果您看到一个<code>413 Request Entity Too Large</code>错误，您将需要<a href="https://stackoverflow.com/a/28476755/1799408">在Nginx配置中的服务器或位置上下文中增加客户端请求主体</a>的最大允许大小。</p>
<p>示例:</p>
<div class="codehilite"><pre><span/>location / <span class="o">{</span>
    proxy_pass http://hello_django<span class="p">;</span>
    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
    proxy_redirect off<span class="p">;</span>
    client_max_body_size 100M<span class="p">;</span>
<span class="o">}</span>
</pre></div></blockquote>

<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何使用Postgres来封装Django web应用程序以进行开发。我们还创建了一个生产就绪的Docker Compose文件，将Gunicorn和Nginx添加到混合文件中，以处理静态和媒体文件。现在，您可以在本地测试生产设置。</p>
<p>就生产环境的实际部署而言，您可能希望使用:</p>
<ol>
<li>完全托管的数据库服务——像<a href="https://aws.amazon.com/rds/"> RDS </a>或<a href="https://cloud.google.com/sql/">云SQL</a>——而不是在一个容器中管理你自己的Postgres实例。</li>
<li><code>db</code>和<code>nginx</code>服务的非根用户</li>
</ol>
<p>关于其他生产技巧，请查看<a href="https://www.reddit.com/r/django/comments/bjgod8/dockerizing_django_with_postgres_gunicorn_and/">本讨论</a>。</p>
<p>你可以在django-on-docker  repo中找到代码。</p>
<blockquote>
<p>这里还有一个更老的Pipenv版本的代码。</p>
</blockquote>
<p>感谢阅读！</p>
<blockquote>
<p>姜戈码头系列:</p>
<ol>
<li><a href="/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/">用Postgres、Gunicorn、Nginx </a>(本文！)</li>
<li><a href="/blog/django-lets-encrypt/">用加密保护容器化的Django应用</a></li>
<li><a href="/blog/django-docker-https-aws/">用Docker将Django部署到AWS，让我们加密</a></li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>