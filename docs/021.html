<html>
<head>
<title>Asynchronous Tasks with Falcon and Celery </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>猎鹰和芹菜的异步任务</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/asynchronous-tasks-with-falcon-and-celery/#0001-01-01">https://testdriven.io/blog/asynchronous-tasks-with-falcon-and-celery/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>异步任务用于将容易失败的密集、耗时的流程转移到后台，以便可以立即向客户端返回响应。</p>
<p>本教程着眼于如何将异步任务队列<a href="https://docs.celeryq.dev/"> Celery </a>集成到基于Python的<a href="https://falconframework.org/"> Falcon </a> web框架中。我们还将使用Docker和Docker Compose将所有内容联系在一起。最后，我们将看看如何用单元测试和集成测试来测试Celery任务。</p>



<h2 id="learning-objectives">学习目标</h2>
<p>学完本教程后，您应该能够:</p>
<ol>
<li>将芹菜整合到猎鹰网络应用程序中。</li>
<li>用码头工人把猎鹰、芹菜和红萝卜装进集装箱。</li>
<li>使用单独的工作进程在后台执行任务。</li>
<li>将芹菜日志保存到文件中。</li>
<li>设置<a href="http://flower.readthedocs.io/"> Flower </a>来监控和管理芹菜作业和工人。</li>
<li>用单元测试和集成测试来测试芹菜任务。</li>
</ol>
<h2 id="background-tasks">后台任务</h2>
<p>同样，为了改善用户体验，长时间运行的流程应该在正常的HTTP请求/响应流程之外，在后台进程中运行。</p>
<p>示例:</p>
<ol>
<li>发送确认电子邮件</li>
<li>刮擦和爬行</li>
<li>分析数据</li>
<li>图像处理</li>
<li>制作每日报告</li>
<li>运行机器学习模型</li>
</ol>
<p>当你构建一个应用程序时，试着区分应该在请求/响应生命周期中运行的任务(比如CRUD操作)和应该在后台运行的任务。</p>
<h2 id="falcon-framework">猎鹰框架</h2>
<p>Falcon是一个微型Python web框架，非常适合创建后端RESTful APIs。Falcon感觉很像Flask，但是在开发和<a href="https://falconframework.org/#sectionBenchmarks">性能</a>方面都要快很多。</p>
<blockquote>
<p>Falcon是一个极简主义的WSGI库，用于构建快速的web APIs和应用程序后端。我们喜欢将Falcon视为web框架的迪特·拉姆斯。</p>
<p>当涉及到构建HTTP APIs时，其他框架会用大量的依赖性和不必要的抽象来拖累你。Falcon以简洁的设计切入正题，它包含了HTTP和REST架构风格。</p>
</blockquote>
<p>请务必查看官方<a href="https://falcon.readthedocs.io/en/stable/">文档</a>了解更多信息。</p>
<h2 id="project-setup">项目设置</h2>
<p>克隆基础项目:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://github.com/testdrivenio/falcon-celery --branch base --single-branch
$ <span class="nb">cd</span> falcon-celery
</code></pre></div>

<p>快速浏览一下代码和项目结构，然后使用Docker启动应用程序:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>构建和运行映像应该只需要一点时间。一旦完成，该应用程序应该在<a href="http://localhost:8000/ping">http://localhost:8000/ping</a>上运行。</p>
<p>确保测试通过:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose run web python test.py

.
----------------------------------------------------------------------
Ran <span class="m">1</span> <span class="nb">test</span> <span class="k">in</span> <span class="m">0</span>.001s

OK
</code></pre></div>

<h2 id="celery">芹菜</h2>
<p>现在有趣的部分来了——添加<a href="https://docs.celeryq.dev/">芹菜</a>！首先将芹菜和Redis添加到<em> requirements.txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>celery==5.2.7
falcon==3.1.0
gunicorn==20.1.0
redis==4.3.4
</code></pre></div>

<h3 id="create-a-task">创建任务</h3>
<p>向“项目/应用程序”目录添加一个名为<em> tasks.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/app/tasks.py</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">celery</span>


<span class="n">CELERY_BROKER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CELERY_BROKER'</span><span class="p">)</span>
<span class="n">CELERY_BACKEND</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CELERY_BACKEND'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">Celery</span><span class="p">(</span><span class="s1">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">CELERY_BROKER</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">CELERY_BACKEND</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># simulate slow computation</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<p>在这里，我们创建了一个新的芹菜实例，并定义了一个名为<code>fib</code>的新芹菜任务<a href="https://docs.celeryq.dev/en/stable/userguide/tasks.html">T2，它根据给定的数字计算斐波那契数列。</a></p>
<p>Celery使用消息代理来促进Celery worker和web应用程序之间的通信。消息被添加到代理中，然后由工作人员进行处理。一旦完成，结果被添加到后端。</p>
<p>Redis将被用作代理和后端。将Redis和芹菜<a href="https://docs.celeryq.dev/en/stable/userguide/workers.html">工人</a>添加到<em> docker-compose.yml </em>文件中:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn -b 0.0.0.0:8000 app:app</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">celery</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A app.tasks worker --loglevel=info</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span><span class="w"/>
</code></pre></div>

<p>添加一个新的路由处理程序，将<code>fib</code>任务启动到<em> __init__。py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">CreateTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">raw_json</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_json</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">fib</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'number'</span><span class="p">]))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'status'</span><span class="p">:</span> <span class="s1">'success'</span><span class="p">,</span>
            <span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'task_id'</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>注册路线:</p>
<div class="codehilite"><pre><span/><code><span class="n">app</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">'/create'</span><span class="p">,</span> <span class="n">CreateTask</span><span class="p">())</span>
</code></pre></div>

<p>导入任务:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">app.tasks</span> <span class="kn">import</span> <span class="n">fib</span>
</code></pre></div>

<p>构建映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ curl -X POST http://localhost:8000/create <span class="se">\</span>
    -d <span class="s1">'{"number":"4"}'</span> <span class="se">\</span>
    -H <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>

<p>您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"success"</span>,
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"task_id"</span>: <span class="s2">"d935fa51-44ad-488f-b63d-6b0e178700a8"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="check-task-status">检查任务状态</h3>
<p>接下来，添加一个新的路由处理程序来检查任务的状态:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">CheckStatus</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">task_result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'status'</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">'result'</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">result</span><span class="p">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>注册路线:</p>
<div class="codehilite"><pre><span/><code><span class="n">app</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">'/status/</span><span class="si">{task_id}</span><span class="s1">'</span><span class="p">,</span> <span class="n">CheckStatus</span><span class="p">())</span>
</code></pre></div>

<p>导入<a href="https://docs.celeryq.dev/en/stable/reference/celery.result.html">异步结果</a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">AsyncResult</span>
</code></pre></div>

<p>更新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>触发新任务:</p>
<div class="codehilite"><pre><span/><code>$ curl -X POST http://localhost:8000/create <span class="se">\</span>
    -d <span class="s1">'{"number":"3"}'</span> <span class="se">\</span>
    -H <span class="s2">"Content-Type: application/json"</span>

<span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"success"</span>,
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"task_id"</span>: <span class="s2">"65a1c427-ee08-4fb1-9842-d0f90d081c54"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>然后，使用返回的<code>task_id</code>检查状态:</p>
<div class="codehilite"><pre><span/><code>$ curl http://localhost:8000/status/65a1c427-ee08-4fb1-9842-d0f90d081c54

<span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"SUCCESS"</span>, <span class="s2">"result"</span>: <span class="o">[</span><span class="m">0</span>, <span class="m">1</span>, <span class="m">1</span>, <span class="m">2</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="logs">日志</h3>
<p>更新<code>celery</code>服务，以便将芹菜日志转储到一个日志文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">celery</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project/logs:/usr/src/app/logs</span><span class="w"> </span><span class="c1"># add this line</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A app.tasks worker --loglevel=info  --logfile=logs/celery.log</span><span class="w"> </span><span class="c1"># update this line</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
</code></pre></div>

<p>更新:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>因为我们设置了一个卷，所以您应该在本地的<em> logs/celery.log </em>中看到日志文件:</p>
<div class="codehilite"><pre><span/><code><span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">31</span><span class="p">,</span><span class="mi">471</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span><span class="w"> </span><span class="n">Connected</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">redis</span><span class="o">:</span><span class="c1">//redis:6379/0</span>
<span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">31</span><span class="p">,</span><span class="mi">476</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span><span class="w"> </span><span class="n">mingle</span><span class="o">:</span><span class="w"> </span><span class="n">searching</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">neighbors</span><span class="w"/>
<span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="mi">488</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span><span class="w"> </span><span class="n">mingle</span><span class="o">:</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">alone</span><span class="w"/>
<span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="mi">503</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span><span class="w"> </span><span class="n">celery</span><span class="mi">@80</span><span class="n">a00f0c917e</span><span class="w"> </span><span class="n">ready</span><span class="p">.</span><span class="w"/>
<span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="mi">569</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span><span class="w"> </span><span class="n">Received</span><span class="w"> </span><span class="n">task</span><span class="o">:</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">fib</span><span class="p">[</span><span class="mb">0b1</span><span class="mi">61</span><span class="n">c4d</span><span class="mf">-5e1</span><span class="n">c</span><span class="mi">-424</span><span class="n">a</span><span class="o">-</span><span class="n">ae9f</span><span class="mi">-5</span><span class="n">c3e84de5043</span><span class="p">]</span><span class="w"/>
<span class="p">[</span><span class="mi">2022-11-15</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="mi">593</span><span class="o">:</span><span class="w"> </span><span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">fib</span><span class="p">[</span><span class="mb">0b1</span><span class="mi">61</span><span class="n">c4d</span><span class="mf">-5e1</span><span class="n">c</span><span class="mi">-424</span><span class="n">a</span><span class="o">-</span><span class="n">ae9f</span><span class="mi">-5</span><span class="n">c3e84de5043</span><span class="p">]</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">6.018030700040981</span><span class="n">s</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"/>
</code></pre></div>

<h2 id="flower">花</h2>
<p><a href="http://flower.readthedocs.io/"> Flower </a>是一个基于网络的芹菜实时监控工具。您可以监控当前正在运行的任务，增加或减少工作池，查看图表和一些统计数据，等等。</p>
<p>添加到<em> requirements.txt: </em></p>
<div class="codehilite"><pre><span/><code>celery==5.2.7
falcon==3.1.0
flower==1.2.0
gunicorn==20.1.0
redis==4.3.4
</code></pre></div>

<p>然后将服务添加到<em> docker-compose.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">monitor</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5555:5555</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery flower -A app.tasks --port=5555 --broker=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
</code></pre></div>

<p>测试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://localhost:5555"> http://localhost:5555 </a>查看仪表板。您应该看到一名员工准备就绪:</p>
<p><img data-src="/static/images/blog/falcon-celery/flower1.png" loading="lazy" class="lazyload" alt="flower" src="../Images/45503eb7ca0eea75b68d15b49457c922.png" data-original-src="https://testdriven.io/static/images/blog/falcon-celery/flower1.png"/></p>
<p>触发更多的任务:</p>
<p><img data-src="/static/images/blog/falcon-celery/flower2.png" loading="lazy" class="lazyload" alt="flower" src="../Images/e63cca798fddf694ff7e18fcda1412c9.png" data-original-src="https://testdriven.io/static/images/blog/falcon-celery/flower2.png"/></p>
<h2 id="flow">流动</h2>
<p>在编写任何测试之前，让我们后退一步，看看整个工作流程。</p>
<p>本质上，HTTP POST请求命中了<code>/create</code>。在路由处理程序中，消息被添加到代理中，Celery worker进程从队列中获取消息并处理任务。同时，web应用程序继续正常执行和运行，向客户机发回一个带有任务ID的响应。然后，客户机可以用HTTP GET请求点击<code>/status/&lt;TASK_ID&gt;</code>端点来检查任务的状态。</p>
<p><img data-src="/static/images/blog/falcon-celery/falcon-celery-flow.png" loading="lazy" class="lazyload" alt="falcon celery flow" src="../Images/7e488720ee358bd1f6eab67bf98ec6e0.png" data-original-src="https://testdriven.io/static/images/blog/falcon-celery/falcon-celery-flow.png"/></p>
<h2 id="tests">试验</h2>
<p>让我们从单元测试开始:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">TestCeleryTasks</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_fib_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</code></pre></div>

<p>将上面的测试用例添加到<em> project/test.py </em>中，然后更新导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">falcon</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">tasks</span>
</code></pre></div>

<p>运行:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose run web python test.py
</code></pre></div>

<p>应该需要大约20秒来运行:</p>
<div class="codehilite"><pre><span/><code>..
----------------------------------------------------------------------
Ran <span class="m">2</span> tests <span class="k">in</span> <span class="m">20</span>.038s

OK
</code></pre></div>

<p>值得注意的是，在上面的断言中，我们使用了<code>.run</code>方法(而不是<code>.delay</code>)来直接运行任务，而没有芹菜工人。</p>
<p>想模拟芹菜任务吗？</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">TestCeleryTasks</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="c1"># def test_fib_task(self):</span>
    <span class="c1">#     self.assertEqual(tasks.fib.run(-1), [])</span>
    <span class="c1">#     self.assertEqual(tasks.fib.run(1), [0, 1])</span>
    <span class="c1">#     self.assertEqual(tasks.fib.run(3), [0, 1, 1, 2])</span>
    <span class="c1">#     self.assertEqual(tasks.fib.run(5), [0, 1, 1, 2, 3, 5])</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s1">'app.tasks.fib'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_mock_fib_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_fib</span><span class="p">):</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</code></pre></div>

<p>添加导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
</code></pre></div>

<div class="codehilite"><pre><span/><code>$ docker-compose run web python test.py


..
----------------------------------------------------------------------
Ran <span class="m">2</span> tests <span class="k">in</span> <span class="m">0</span>.002s

OK
</code></pre></div>

<p>好多了！</p>
<p>您还可以通过运行以下脚本，从容器外部运行完整的集成测试:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>

<span class="c1"># trigger jobs</span>
<span class="nv">test</span><span class="o">=</span><span class="sb">`</span>curl -X POST http://localhost:8000/create <span class="se">\</span>
    -d <span class="s1">'{"number":"2"}'</span> <span class="se">\</span>
    -H <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
    -s <span class="se">\</span>
<span class="p">|</span> jq -r <span class="s1">'.data.task_id'</span><span class="sb">`</span>

<span class="c1"># get status</span>
<span class="nv">check</span><span class="o">=</span><span class="sb">`</span>curl http://localhost:8000/status/<span class="si">${</span><span class="nv">test</span><span class="si">}</span> -s <span class="p">|</span> jq -r <span class="s1">'.status'</span><span class="sb">`</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"SUCCESS"</span> <span class="o">]</span>
<span class="k">do</span>
  <span class="nv">check</span><span class="o">=</span><span class="sb">`</span>curl http://localhost:8000/status/<span class="si">${</span><span class="nv">test</span><span class="si">}</span> -s <span class="p">|</span> jq -r <span class="s1">'.status'</span><span class="sb">`</span>
  <span class="nb">echo</span> <span class="k">$(</span>curl http://localhost:8000/status/<span class="si">${</span><span class="nv">test</span><span class="si">}</span> -s<span class="k">)</span>
<span class="k">done</span>
</code></pre></div>

<p><img data-src="/static/images/gifs/blog/falcon-celery/test.gif" loading="lazy" class="lazyload" alt="test" src="../Images/ec6ef10fa7766462c6dc7366419e2a71.png" data-original-src="https://testdriven.io/static/images/gifs/blog/falcon-celery/test.gif"/></p>
<p>请记住，这与开发中使用的代理和后端是一样的。您可能想要实例化一个新的Celery应用程序来进行测试:</p>
<div class="codehilite"><pre><span/><code><span class="n">app</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">Celery</span><span class="p">(</span><span class="s1">'tests'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">CELERY_BROKER</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">CELERY_BACKEND</span><span class="p">)</span>
</code></pre></div>

<h2 id="next-steps">后续步骤</h2>
<p>寻找一些挑战？</p>
<ol>
<li>启动<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean </a>并使用Docker Swarm或Kubernetes将该应用程序部署到多个droplets上。</li>
<li>使用React、Angular、Vue或普通JavaScript添加一个基本客户端。允许最终用户开始一项新任务。建立一个轮询机制来检查任务的状态。</li>
</ol>
<p>从<a href="https://github.com/testdrivenio/falcon-celery">回购</a>中抓取代码。</p>
  </div>

  </div>    
</body>
</html>