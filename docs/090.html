<html>
<head>
<title>Django Stripe Tutorial </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>姜戈条纹教程</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-stripe-tutorial/#0001-01-01">https://testdriven.io/blog/django-stripe-tutorial/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我将演示如何从头开始配置一个新的Django网站，以接受带有<a href="https://stripe.com/"> Stripe </a>的一次性付款。</p>
<blockquote>
<p>需要处理订阅付款？查看<a href="/blog/django-stripe-subscriptions/"> Django Stripe订阅</a>。</p>
</blockquote>



<h2 id="stripe-payment-options">条纹支付选项</h2>
<p>目前有三种方式接受Stripe的一次性付款:</p>
<ol>
<li><a href="https://stripe.com/docs/payments/charges-api">收费API </a>(遗留)</li>
<li><a href="https://stripe.com/payments/checkout">条纹检测</a>(本教程的重点)</li>
<li><a href="https://stripe.com/docs/payments/payment-intents">支付意向API </a>(通常与<a href="https://stripe.com/payments/elements">条纹元素</a>相结合)</li>
</ol>
<p>你应该用哪一个？</p>
<ol>
<li>如果您想快速启动并运行，请使用Checkout。如果你熟悉Checkout的旧版本<a href="/static/images/blog/django/django-stripe/legacy_stripe_checkout.png">模态版本</a>,这是正确的方法。它提供了大量开箱即用的功能，支持多种语言，并包括一个实现<a href="https://stripe.com/docs/payments/checkout/set-up-a-subscription">定期支付</a>的简单途径。最重要的是，Checkout为您管理整个付款过程，因此您甚至无需添加任何表单就可以开始接受付款！</li>
<li>如果您希望为最终用户提供更加定制的体验，请使用付款意向API。</li>
</ol>
<p>虽然您仍然可以使用Charges API，但是如果您是Stripe的新手，请不要使用它，因为它不支持最新的银行法规(如<a href="https://stripe.com/docs/strong-customer-authentication"> SCA </a>)。你会看到很高的下降率。如需了解更多信息，请查看官方Stripe文档中的<a href="https://stripe.com/docs/payments/payment-intents/migration/charges">费用与付款意向API</a>页面。</p>
<blockquote>
<p>还在用收费API？如果你的大多数客户都在美国或加拿大，你还不需要迁移。查看<a href="https://stripe.com/docs/payments/checkout/migration">结帐迁移指南</a>指南了解更多信息。</p>
</blockquote>
<h2 id="project-setup">项目设置</h2>
<p>创建一个新的项目目录以及一个名为<code>djangostripe</code>的新Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-stripe-checkout <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-stripe-checkout
$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.2.9
<span class="o">(</span>env<span class="o">)</span>$ django-admin startproject djangostripe .
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>接下来，创建一个名为<code>payments</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp payments
</code></pre></div>

<p>现在将新应用添加到<em> settings.py </em>中的<code>INSTALLED_APPS</code>配置中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>

    <span class="c1"># Local</span>
    <span class="s1">'payments.apps.PaymentsConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>用<code>payments</code> app更新项目级<em> urls.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span> <span class="c1"># new</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'payments.urls'</span><span class="p">)),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>在新应用中也创建一个<em> urls.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ touch payments/urls.py
</code></pre></div>

<p>然后按如下方式填充它:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomePageView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'home'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>现在添加一个<em> views.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/views.py</span>

<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="k">class</span> <span class="nc">HomePageView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'home.html'</span>
</code></pre></div>

<p>并为我们的主页创建一个专用的“模板”文件夹和文件。</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ mkdir templates
<span class="o">(</span>env<span class="o">)</span>$ touch templates/home.html
</code></pre></div>

<p>然后，添加以下HTML:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/home.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Stripe Checkout<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0664736a6b674636283f2835">[email protected]</a>/css/bulma.min.css"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://use.fontawesome.com/releases/v5.15.4/js/all.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"button is-primary"</span> <span class="na">id</span><span class="o">=</span><span class="s">"submitBtn"</span><span class="p">&gt;</span>Purchase!<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>确保更新<em> settings.py </em>文件，以便Django知道要查找“模板”文件夹:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/settings.py</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">'BACKEND'</span><span class="p">:</span> <span class="s1">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
        <span class="s1">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'templates'</span><span class="p">],</span> <span class="c1"># new</span>
        <span class="o">...</span>
</code></pre></div>

<p>最后运行<code>migrate</code>来同步数据库，运行<code>runserver</code>来启动Django的本地web服务器。</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>就是这样！查看<a href="http://localhost:8000/"> http://localhost:8000/ </a>你会看到主页:</p>
<p><img data-src="/static/images/blog/django/django-stripe/helloworld.png" loading="lazy" class="lazyload" alt="Django" src="../Images/0992ad9e57a35f1c8224e8143beaa09c.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/helloworld.png"/></p>
<h2 id="add-stripe">添加条纹</h2>
<p>条纹时间到了。从安装开始:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">stripe</span><span class="o">==</span><span class="m">2</span>.63.0
</code></pre></div>

<p>接下来，<a href="https://dashboard.stripe.com/register">注册一个Stripe账户的</a>(如果你还没有这样做的话)并导航到<a href="https://dashboard.stripe.com/test/dashboard">仪表板</a>。点击“开发者”:</p>
<p><img data-src="/static/images/blog/django/django-stripe/developers.png" loading="lazy" class="lazyload" alt="Stripe Developers" src="../Images/b64f2d91daafcd5042ea16a1167142aa.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/developers.png"/></p>
<p>然后在左侧栏中点击“API keys”:</p>
<p><img data-src="/static/images/blog/django/django-stripe/developerskey.png" loading="lazy" class="lazyload" alt="Stripe Developers Key" src="../Images/41cac045dc47f0547301c9f65d7e3b54.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/developerskey.png"/></p>
<p>每个条带帐户有四个<a href="https://stripe.com/docs/keys"> API密钥</a>:两个用于测试，两个用于生产。每一对都有一个“秘密密钥”和一个“可公开密钥”。不要向任何人透露密钥；可发布的密钥将被嵌入到任何人都可以看到的页面上的JavaScript中。</p>
<p>目前右上角的“查看测试数据”开关表示我们正在使用测试键。这就是我们想要的。</p>
<p>在您的<em> settings.py </em>文件的底部，添加以下两行，包括您自己的测试秘密和测试可发布密钥。确保在实际的键周围包含<code>''</code>字符。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/settings.py</span>

<span class="n">STRIPE_PUBLISHABLE_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your test publishable key here&gt;'</span>
<span class="n">STRIPE_SECRET_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your test secret key here&gt;'</span>
</code></pre></div>

<p>最后，您需要在<a href="https://dashboard.stripe.com/settings/account">https://dashboard.stripe.com/settings/account</a>的“帐户设置”中指定一个“帐户名称”:</p>
<p><img data-src="/static/images/blog/django/django-stripe/accountname.png" loading="lazy" class="lazyload" alt="Stripe Account Name" src="../Images/df79e66f7d54ada48699a1adee473396.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/accountname.png"/></p>
<h2 id="create-a-product">创造产品</h2>
<p>接下来，我们需要创造一个产品来销售。</p>
<p>单击“产品”，然后单击“添加产品”:</p>
<p><img data-src="/static/images/blog/django/django-stripe/addproduct1.png" loading="lazy" class="lazyload" alt="Stripe Add Product" src="../Images/3ecc3e098cad8219aaf769be088fe94d.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/addproduct1.png"/></p>
<p>添加产品名称，输入价格，然后选择“一次性”:</p>
<p><img data-src="/static/images/blog/django/django-stripe/addproduct2.png" loading="lazy" class="lazyload" alt="Stripe Add Product" src="../Images/55b14594bec10c334996be3741731eb3.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/addproduct2.png"/></p>
<p>点击“保存产品”。</p>
<h2 id="user-flow">用户流量</h2>
<p>在用户点击购买按钮后，我们需要做以下事情:</p>
<ol>
<li>
<p>获取可发布密钥</p>
<ul>
<li>从客户端向服务器发送请求可发布密钥的XHR请求</li>
<li>用键回应</li>
<li>使用键创建Stripe.js的新实例</li>
</ul>
</li>
<li>
<p>创建签出会话</p>
<ul>
<li>向服务器发送另一个XHR请求，请求新的结帐会话ID</li>
<li>生成新的签出会话并发回ID</li>
<li>重定向到用户完成购买的结帐页面</li>
</ul>
</li>
<li>
<p>适当地重定向用户</p>
<ul>
<li>成功付款后重定向到成功页面</li>
<li>取消付款后重定向到取消页面</li>
</ul>
</li>
<li>
<p>用条纹网钩确认付款</p>
<ul>
<li>设置webhook端点</li>
<li>使用条带CLI测试端点</li>
<li>用条带注册端点</li>
</ul>
</li>
</ol>
<h2 id="get-publishable-key">获取可发布密钥</h2>
<h3 id="javascript-static-file">JavaScript静态文件</h3>
<p>让我们首先创建一个新的静态文件来保存我们所有的JavaScript:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ mkdir static
<span class="o">(</span>env<span class="o">)</span>$ touch static/main.js
</code></pre></div>

<p>向新的<em> main.js </em>文件添加快速健全检查:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// static/main.js</span><span class="w"/>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Sanity check!"</span><span class="p">);</span><span class="w"/>
</code></pre></div>

<p>然后更新<em> settings.py </em>文件，这样Django就知道在哪里可以找到静态文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/settings.py</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s1">'/static/'</span>

<span class="c1"># for django &gt;= 3.1</span>
<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">'static'</span><span class="p">]</span>  <span class="c1"># new</span>

<span class="c1"># for django &lt; 3.1</span>
<span class="c1"># STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]  # new</span>
</code></pre></div>

<p>在HTML模板中添加静态模板标签和新的脚本标签:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/home.html --&gt;</span>

{% load static %} <span class="cm">&lt;!-- new --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Stripe Checkout<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dbb9aeb7b6ba9bebf5e2f5e8">[email protected]</a>/css/bulma.min.css"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"{% static 'main.js' %}"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>   <span class="cm">&lt;!-- new --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://use.fontawesome.com/releases/v5.15.4/js/all.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"button is-primary"</span> <span class="na">id</span><span class="o">=</span><span class="s">"submitBtn"</span><span class="p">&gt;</span>Purchase!<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>再次运行开发服务器。导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>，打开JavaScript控制台。您应该看到健全性检查:</p>
<p><img data-src="/static/images/blog/django/django-stripe/sanitycheck.png" loading="lazy" class="lazyload" alt="JavaScript Sanity Check" src="../Images/adc02c9db68d27f01d86eb9d722a6904.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/sanitycheck.png"/></p>
<h3 id="view">视角</h3>
<p>接下来，向<em> payments/views.py </em>添加一个新视图来处理XHR请求:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/views.py</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span> <span class="c1"># new</span>
<span class="kn">from</span> <span class="nn">django.http.response</span> <span class="kn">import</span> <span class="n">JsonResponse</span> <span class="c1"># new</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span> <span class="c1"># new</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">TemplateView</span>


<span class="k">class</span> <span class="nc">HomePageView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'home.html'</span>


<span class="c1"># new</span>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">stripe_config</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">:</span>
        <span class="n">stripe_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'publicKey'</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLISHABLE_KEY</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">stripe_config</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<p>也添加一个URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomePageView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'home'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'config/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">stripe_config</span><span class="p">),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="xhr-request">XHR请求</h3>
<p>接下来，使用<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">获取API </a>向<em> static/main.js </em>中的新<code>/config/</code>端点发出XHR (XMLHttpRequest)请求:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// static/main.js</span><span class="w"/>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Sanity check!"</span><span class="p">);</span><span class="w"/>

<span class="c1">// new</span><span class="w"/>
<span class="c1">// Get Stripe publishable key</span><span class="w"/>
<span class="nx">fetch</span><span class="p">(</span><span class="s2">"/config/"</span><span class="p">)</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span><span class="w"> </span><span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="c1">// Initialize Stripe.js</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stripe</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">);</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>来自<code>fetch</code>请求的响应是一个<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">可读流</a>。<code>result.json()</code>返回一个承诺，我们将其解析为一个JavaScript对象——例如<code>data</code>。然后我们使用点符号来访问<code>publicKey</code>以获得可发布的密钥。</p>
<p>将<a href="https://stripe.com/docs/js"> Stripe.js </a>包含在<em> templates/home.html </em>中像这样:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/home.html --&gt;</span>

{% load static %}

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Stripe Checkout<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cfadbaa3a2ae8fffe1f6e1fc">[email protected]</a>/css/bulma.min.css"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://js.stripe.com/v3/"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>  <span class="cm">&lt;!-- new --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"{% static 'main.js' %}"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://use.fontawesome.com/releases/v5.15.4/js/all.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"button is-primary"</span> <span class="na">id</span><span class="o">=</span><span class="s">"submitBtn"</span><span class="p">&gt;</span>Purchase!<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>现在，在页面加载之后，将调用<code>/config/</code>，它将使用Stripe publish key进行响应。然后，我们将使用这个键创建Stripe.js的新实例。</p>
<p>流量:</p>
<ol>
  <li>
  <p><s>获取可发布密钥</s></p>
  <ul>
    <li><s>从客户端向服务器发送XHR请求，请求可发布密钥</s></li>
    <li><s>用</s>键响应</li>
    <li><s>使用键创建Stripe.js的新实例</s></li>
  </ul>
  </li>
  <li>
  <p>创建签出会话</p>
  <ul>
    <li>向服务器发送另一个XHR请求，请求新的结帐会话ID</li>
    <li>生成新的签出会话并发回ID</li>
    <li>重定向到用户完成购买的结帐页面</li>
  </ul>
  </li>
  <li>
  <p>适当地重定向用户</p>
  <ul>
    <li>成功付款后重定向到成功页面</li>
    <li>取消付款后重定向到取消页面</li>
  </ul>
  </li>
  <li>
  <p>用条纹网钩确认付款</p>
  <ul>
    <li>设置webhook端点</li>
    <li>使用条带CLI测试端点</li>
    <li>用条带注册端点</li>
  </ul>
  </li>
</ol>

<h2 id="create-checkout-session">创建签出会话</h2>
<p>接下来，我们需要为按钮的click事件附加一个事件处理程序，该事件将向服务器发送另一个XHR请求，以生成新的结帐会话ID。</p>
<h3 id="view_1">视角</h3>
<p>首先，添加新视图:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/views.py</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">create_checkout_session</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">:</span>
        <span class="n">domain_url</span> <span class="o">=</span> <span class="s1">'http://localhost:8000/'</span>
        <span class="n">stripe</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create new Checkout Session for the order</span>
            <span class="c1"># Other optional params include:</span>
            <span class="c1"># [billing_address_collection] - to display billing address details on the page</span>
            <span class="c1"># [customer] - if you have an existing Stripe Customer ID</span>
            <span class="c1"># [payment_intent_data] - capture the payment later</span>
            <span class="c1"># [customer_email] - prefill the email input in the form</span>
            <span class="c1"># For full details see https://stripe.com/docs/api/checkout/sessions/create</span>

            <span class="c1"># ?session_id={CHECKOUT_SESSION_ID} means the redirect will have the session ID set as a query param</span>
            <span class="n">checkout_session</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">checkout</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">success_url</span><span class="o">=</span><span class="n">domain_url</span> <span class="o">+</span> <span class="s1">'success?session_id=</span><span class="si">{CHECKOUT_SESSION_ID}</span><span class="s1">'</span><span class="p">,</span>
                <span class="n">cancel_url</span><span class="o">=</span><span class="n">domain_url</span> <span class="o">+</span> <span class="s1">'cancelled/'</span><span class="p">,</span>
                <span class="n">payment_method_types</span><span class="o">=</span><span class="p">[</span><span class="s1">'card'</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">'payment'</span><span class="p">,</span>
                <span class="n">line_items</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'T-shirt'</span><span class="p">,</span>
                        <span class="s1">'quantity'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">'currency'</span><span class="p">:</span> <span class="s1">'usd'</span><span class="p">,</span>
                        <span class="s1">'amount'</span><span class="p">:</span> <span class="s1">'2000'</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'sessionId'</span><span class="p">:</span> <span class="n">checkout_session</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'error'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
</code></pre></div>

<p>这里，如果请求方法是<code>GET</code>，我们定义了一个<code>domain_url</code>，将条带密钥分配给<code>stripe.api_key</code>(因此当我们请求创建一个新的签出会话时，它将被自动发送)，创建了签出会话，并在响应中发回了ID。注意<code>success_url</code>和<code>cancel_url</code>。在成功支付或取消的情况下，用户将分别被重定向回这些URL。我们将很快设置这些视图。</p>
<p>不要忘记重要的一点:</p>


<p>添加URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomePageView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'home'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'config/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">stripe_config</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create-checkout-session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">create_checkout_session</span><span class="p">),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="xhr-request_1">XHR请求</h3>
<p>将事件处理程序和后续的XHR请求添加到<em> static/main.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// static/main.js</span><span class="w"/>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Sanity check!"</span><span class="p">);</span><span class="w"/>

<span class="c1">// Get Stripe publishable key</span><span class="w"/>
<span class="nx">fetch</span><span class="p">(</span><span class="s2">"/config/"</span><span class="p">)</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span><span class="w"> </span><span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="c1">// Initialize Stripe.js</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stripe</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">);</span><span class="w"/>

<span class="w">  </span><span class="c1">// new</span><span class="w"/>
<span class="w">  </span><span class="c1">// Event handler</span><span class="w"/>
<span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"#submitBtn"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="c1">// Get Checkout Session ID</span><span class="w"/>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="s2">"/create-checkout-session/"</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span><span class="w"> </span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="c1">// Redirect to Stripe Checkout</span><span class="w"/>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">redirectToCheckout</span><span class="p">({</span><span class="nx">sessionId</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>在这里，在解析了<code>result.json()</code>承诺之后，我们调用了<a href="https://stripe.com/docs/js/checkout/redirect_to_checkout"> redirectToCheckout </a>,其中的结帐会话ID来自解析的承诺。</p>
<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>。点击按钮后，您将被重定向到Stripe Checkout实例(一个Stripe托管页面，用于安全收集支付信息),其中包含t恤产品信息:</p>
<p><img data-src="/static/images/blog/django/django-stripe/checkout.png" loading="lazy" class="lazyload" alt="Stripe Checkout" src="../Images/898ac73703f1d8fafdab02e58472be47.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/checkout.png"/></p>
<p>我们可以使用Stripe提供的几个<a href="https://stripe.com/docs/testing#cards">测试卡号</a>中的一个来测试表单。还是用<code>4242 4242 4242 4242</code>吧。请确保到期日期在未来。为CVC添加任意3个数字，为邮政编码添加任意5个数字。输入任何电子邮件地址和名称。如果一切顺利，付款应该被处理，但是重定向将失败，因为我们还没有设置<code>/success/</code> URL。</p>
<p>流量:</p>
<ol>
  <li>
  <p><s>获取可发布密钥</s></p>
  <ul>
    <li><s>从客户端向服务器发送XHR请求，请求可发布密钥</s></li>
    <li><s>用</s>键响应</li>
    <li><s>使用键创建Stripe.js的新实例</s></li>
  </ul>
  </li>
  <li>
  <p><s>创建结账会话</s></p>
  <ul>
    <li><s>向服务器发送另一个XHR请求，请求新的结账会话ID </s></li>
    <li><s>生成新的结账会话并发回ID </s></li>
    <li><s>重定向到用户完成购买的结账页面</s></li>
  </ul>
  </li>
  <li>
  <p>适当地重定向用户</p>
  <ul>
    <li>成功付款后重定向到成功页面</li>
    <li>取消付款后重定向到取消页面</li>
  </ul>
  </li>
  <li>
  <p>用条纹网钩确认付款</p>
  <ul>
    <li>设置webhook端点</li>
    <li>使用条带CLI测试端点</li>
    <li>用条带注册端点</li>
  </ul>
  </li>
</ol>

<h2 id="redirect-the-user-appropriately">适当地重定向用户</h2>
<p>最后，让我们连接用于处理成功和取消重定向的模板、视图和URL。</p>
<p>成功模板:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/success.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Stripe Checkout<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5e3c2b32333f1e6e7067706d">[email protected]</a>/css/bulma.min.css"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://use.fontawesome.com/releases/v5.15.4/js/all.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Your payment succeeded.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>已取消的模板:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/cancelled.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Stripe Checkout<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0a687f66676b4a3a24332439">[email protected]</a>/css/bulma.min.css"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://use.fontawesome.com/releases/v5.15.4/js/all.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">"section"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Your payment was cancelled.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>视图:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/views.py</span>

<span class="k">class</span> <span class="nc">SuccessView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'success.html'</span>


<span class="k">class</span> <span class="nc">CancelledView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'cancelled.html'</span>
</code></pre></div>

<p>URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomePageView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'home'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'config/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">stripe_config</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create-checkout-session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">create_checkout_session</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SuccessView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span> <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'cancelled/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">CancelledView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>好的，在<a href="http://localhost:8000/">刷新网页http://localhost:8000/ </a>。点击支付按钮，再次使用信用卡号<code>4242 4242 4242 4242</code>和其他虚拟信息。提交付款。你应该被重定向回<a href="http://localhost:8000/success/">http://localhost:8000/success/</a>。</p>
<p>要确认实际收费，请返回“支付”下的Stripe仪表盘:</p>
<p><img data-src="/static/images/blog/django/django-stripe/payment.png" loading="lazy" class="lazyload" alt="Stripe Payments" src="../Images/ec73f11c58c0cce27fb93fe97896650d.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/payment.png"/></p>
<p>回顾一下，我们使用密钥在服务器上创建一个惟一的签出会话ID。这个ID随后被用来创建一个结帐实例，最终用户在点击支付按钮后被重定向到这个实例。收费发生后，他们会被重定向回成功页面。</p>
<p>流量:</p>
<ol>
  <li>
  <p><s>获取可发布密钥</s></p>
  <ul>
    <li><s>从客户端向服务器发送XHR请求，请求可发布密钥</s></li>
    <li><s>用</s>键响应</li>
    <li><s>使用键创建Stripe.js的新实例</s></li>
  </ul>
  </li>
  <li>
  <p><s>创建结账会话</s></p>
  <ul>
    <li><s>向服务器发送另一个XHR请求，请求新的结账会话ID </s></li>
    <li><s>生成新的结账会话并发回ID </s></li>
    <li><s>重定向到用户完成购买的结账页面</s></li>
  </ul>
  </li>
  <li>
  <p><s>适当地重定向用户</s></p>
  <ul>
    <li><s>支付成功后重定向至成功页面</s></li>
    <li><s>取消付款后重定向至取消页面</s></li>
  </ul>
  </li>
  <li>
  <p>用条纹网钩确认付款</p>
  <ul>
    <li>设置webhook端点</li>
    <li>使用条带CLI测试端点</li>
    <li>用条带注册端点</li>
  </ul>
  </li>
</ol>

<h2 id="confirm-payment-with-stripe-webhooks">用条纹网钩确认付款</h2>
<p>我们的应用程序在这一点上工作得很好，但我们仍然不能以编程方式确认支付，或者在支付成功时运行一些代码。我们已经在用户结帐后将他们重定向到成功页面，但是我们不能只依赖那个页面，因为付款确认是异步发生的。</p>
<blockquote>
<p>Stripe和一般编程中有两种类型的事件:同步事件，具有即时效果和结果(例如，创建一个客户)，异步事件，没有即时结果(例如，确认付款)。因为支付确认是异步完成的，用户可能会在他们的支付被确认之前<em>和</em>我们收到他们的资金之前<em>被重定向到成功页面。</em></p>
</blockquote>
<p>当支付完成时，获得通知的最简单的方法之一是使用回调或所谓的<a href="https://stripe.com/docs/webhooks"> Stripe webhook </a>。我们需要在应用程序中创建一个简单的端点，每当事件发生时(例如，当用户购买t恤时)，Stripe就会调用这个端点。通过使用webhooks，我们可以绝对肯定支付成功。</p>
<p>为了使用webhooks，我们需要:</p>
<ol>
<li>设置webhook端点</li>
<li>使用<a href="https://stripe.com/docs/stripe-cli">条带CLI </a>测试端点</li>
<li>用条带注册端点</li>
</ol>
<blockquote>
<p>这一部分由尼克·托马兹奇撰写。</p>
</blockquote>
<h3 id="endpoint">端点</h3>
<p>创建一个名为<code>stripe_webhook</code>的新视图，它会在每次付款成功时打印一条消息:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/views.py</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">stripe_webhook</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">stripe</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span>
    <span class="n">endpoint_secret</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_ENDPOINT_SECRET</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
    <span class="n">sig_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">'HTTP_STRIPE_SIGNATURE'</span><span class="p">]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">Webhook</span><span class="o">.</span><span class="n">construct_event</span><span class="p">(</span>
            <span class="n">payload</span><span class="p">,</span> <span class="n">sig_header</span><span class="p">,</span> <span class="n">endpoint_secret</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Invalid payload</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">stripe</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SignatureVerificationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Invalid signature</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Handle the checkout.session.completed event</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'checkout.session.completed'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Payment was successful."</span><span class="p">)</span>
        <span class="c1"># TODO: run some custom code here</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>

<p><code>stripe_webhook</code>现在作为我们的webhook端点。这里，我们只寻找每当结帐成功时调用的<code>checkout.session.completed</code>事件，但是您可以对其他<a href="https://stripe.com/docs/api/events">条带事件</a>使用相同的模式。</p>
<p>确保将<code>HttpResponse</code>导入添加到顶部:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.http.response</span> <span class="kn">import</span> <span class="n">JsonResponse</span><span class="p">,</span> <span class="n">HttpResponse</span>
</code></pre></div>

<p>要使端点可访问，唯一要做的就是在<em> urls.py </em>中注册它:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># payments/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomePageView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'home'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'config/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">stripe_config</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create-checkout-session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">create_checkout_session</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SuccessView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'cancelled/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">CancelledView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'webhook/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">stripe_webhook</span><span class="p">),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="testing-the-webhook">测试webhook</h3>
<p>我们将使用<a href="https://stripe.com/docs/stripe-cli"> Stripe CLI </a>来测试webhook。</p>
<p>一旦<a href="https://stripe.com/docs/stripe-cli#install">下载并安装了</a>，在新的终端窗口中运行以下命令，登录到您的Stripe帐户:</p>


<p>此命令应生成一个配对代码:</p>
<div class="codehilite"><pre><span/><code>Your pairing code is: peach-loves-classy-cozy
This pairing code verifies your authentication with Stripe.
Press Enter to open the browser <span class="o">(</span>^C to quit<span class="o">)</span>
</code></pre></div>

<p>通过按Enter，CLI将打开您的默认web浏览器，并请求访问您的帐户信息的权限。请继续并允许访问。回到您的终端，您应该看到类似于以下内容的内容:</p>
<div class="codehilite"><pre><span/><code>&gt; Done! The Stripe CLI is configured <span class="k">for</span> Django Test with account id acct_&lt;ACCOUNT_ID&gt;

Please note: this key will expire after <span class="m">90</span> days, at which point you<span class="err">'</span>ll need to re-authenticate.
</code></pre></div>

<p>接下来，我们可以开始侦听条带事件，并使用以下命令将它们转发到我们的端点:</p>
<div class="codehilite"><pre><span/><code>$ stripe listen --forward-to localhost:8000/webhook/
</code></pre></div>

<p>这也将生成一个webhook签名密码:</p>
<div class="codehilite"><pre><span/><code>&gt; Ready! Your webhook signing secret is whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="o">(</span>^C to quit<span class="o">)</span>
</code></pre></div>

<p>为了初始化端点，将秘密添加到<em> settings.py </em>文件中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangostripe/settings.py</span>

<span class="n">STRIPE_ENDPOINT_SECRET</span> <span class="o">=</span> <span class="s1">'&lt;your webhook signing secret here&gt;'</span>
</code></pre></div>

<p>Stripe现在会将事件转发到我们的端点。要测试，通过<code>4242 4242 4242 4242</code>运行另一个测试支付。在您的终端中，您应该会看到<code>Payment was successful.</code>消息。</p>
<p>一旦完成，停止<code>stripe listen --forward-to localhost:8000/webhook/</code>过程。</p>
<blockquote>
<p>如果您想识别进行购买的用户，可以使用<a href="https://stripe.com/docs/api/checkout/sessions/object"> client_reference_id </a>将某种用户标识符附加到条带会话。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><span class="c1"># payments/views.py</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">create_checkout_session</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">:</span>
        <span class="n">domain_url</span> <span class="o">=</span> <span class="s1">'http://localhost:8000/'</span>
        <span class="n">stripe</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">checkout_session</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">checkout</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="c1"># new</span>
                <span class="n">client_reference_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">success_url</span><span class="o">=</span><span class="n">domain_url</span> <span class="o">+</span> <span class="s1">'success?session_id=</span><span class="si">{CHECKOUT_SESSION_ID}</span><span class="s1">'</span><span class="p">,</span>
                <span class="n">cancel_url</span><span class="o">=</span><span class="n">domain_url</span> <span class="o">+</span> <span class="s1">'cancelled/'</span><span class="p">,</span>
                <span class="n">payment_method_types</span><span class="o">=</span><span class="p">[</span><span class="s1">'card'</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">'payment'</span><span class="p">,</span>
                <span class="n">line_items</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'T-shirt'</span><span class="p">,</span>
                        <span class="s1">'quantity'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">'currency'</span><span class="p">:</span> <span class="s1">'usd'</span><span class="p">,</span>
                        <span class="s1">'amount'</span><span class="p">:</span> <span class="s1">'2000'</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'sessionId'</span><span class="p">:</span> <span class="n">checkout_session</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'error'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
</pre></div></blockquote>

<h3 id="register-the-endpoint">注册端点</h3>
<p>最后，在部署你的应用程序后，你可以在Stripe仪表板中注册端点，在<a href="https://dashboard.stripe.com/test/webhooks">开发者&gt; Webhooks </a>下。这将生成一个webhook签名密码，用于您的生产应用程序。</p>
<p>例如:</p>
<p><img data-src="/static/images/blog/django/django-stripe/webhook.png" loading="lazy" class="lazyload" alt="Django webhook" src="../Images/1318222bbe20a4a04c82f59ff340433f.png" data-original-src="https://testdriven.io/static/images/blog/django/django-stripe/webhook.png"/></p>
<p>流量:</p>
<ol>
  <li>
  <p><s>获取可发布密钥</s></p>
  <ul>
    <li><s>从客户端向服务器发送XHR请求，请求可发布密钥</s></li>
    <li><s>用</s>键响应</li>
    <li><s>使用键创建Stripe.js的新实例</s></li>
  </ul>
  </li>
  <li>
  <p><s>创建结账会话</s></p>
  <ul>
    <li><s>向服务器发送另一个XHR请求，请求新的结账会话ID </s></li>
    <li><s>生成新的结账会话并发回ID </s></li>
    <li><s>重定向到用户完成购买的结账页面</s></li>
  </ul>
  </li>
  <li>
  <p><s>适当地重定向用户</s></p>
  <ul>
    <li><s>支付成功后重定向至成功页面</s></li>
    <li><s>取消付款后重定向至取消页面</s></li>
  </ul>
  </li>
  <li>
  <p><s>用条纹网钩确认付款</s></p>
  <ul>
    <li><s>设置webhook端点</s></li>
    <li><s>使用条带CLI测试端点</s></li>
    <li><s>用条带注册端点</s></li>
  </ul>
  </li>
</ol>

<h2 id="whats-next">下一步是什么</h2>
<p>在实时网站上，需要有HTTPS，这样你的连接是安全的。此外，虽然为了简单起见，我们硬编码了API密钥和webhook签名密码，但它们实际上应该存储在环境变量中。您可能还想将<code>domain_url</code>存储为一个环境变量。</p>
<p>从GitHub上的<a href="https://github.com/testdrivenio/django-stripe-checkout">django-stripe-check out</a>repo中获取代码。</p>
  </div>

  </div>    
</body>
</html>