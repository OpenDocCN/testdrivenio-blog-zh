<html>
<head>
<title>Django REST Framework and Elasticsearch </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django REST框架和Elasticsearch</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-drf-elasticsearch/#0001-01-01">https://testdriven.io/blog/django-drf-elasticsearch/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何集成<a href="https://www.django-rest-framework.org/"> Django REST框架</a> (DRF)和<a href="https://www.elastic.co/elasticsearch/"> Elasticsearch </a>。我们将使用Django对数据建模，使用DRF对数据进行序列化和服务。最后，我们将使用Elasticsearch索引数据，并使其可搜索。</p>



<h2 id="what-is-elasticsearch">什么是Elasticsearch？</h2>
<p>Elasticsearch是一个分布式、免费和开放的搜索和分析引擎，适用于所有类型的数据，包括文本、数字、地理空间、结构化和非结构化数据。它以其简单的RESTful APIs、分布式特性、速度和可伸缩性而闻名。Elasticsearch是<a href="https://www.elastic.co/elastic-stack/"> Elastic Stack </a>(也称为<a href="https://www.elastic.co/what-is/elk-stack"> ELK Stack </a>)的核心组件，这是一套用于数据摄取、丰富、存储、分析和可视化的免费开放工具。</p>
<p>其使用案例包括:</p>
<ol>
<li>网站搜索和应用程序搜索</li>
<li>监控和可视化您的系统指标</li>
<li>安全和业务分析</li>
<li>日志记录和日志分析</li>
</ol>
<blockquote>
<p>要了解更多关于Elasticsearch的信息，请查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html">什么是Elasticsearch？</a>来自<a href="https://www.elastic.co/guide/index.html">官方文件</a>。</p>
</blockquote>
<h2 id="elasticsearch-structure-and-concepts">弹性搜索结构和概念</h2>
<p>在使用Elasticsearch之前，我们应该熟悉基本的Elasticsearch概念。这些从大到小排列如下:</p>
<ol>
<li><strong>集群</strong>是一个或多个节点的集合。</li>
<li><strong>节点</strong>是运行Elasticsearch的单个服务器实例。在与集群通信时，它:<ol>
<li>存储和索引您的数据</li>
<li>提供搜索</li>
</ol>
</li>
<li><strong>索引</strong>用于将文档存储在对应于字段数据类型的专用数据结构中(类似于SQL数据库)。每个索引都有一个或多个碎片和副本。</li>
<li><strong> Type </strong>是文档的集合，它们有一些共同点(类似于SQL表)。</li>
<li><strong> Shard </strong>是一个<a href="https://lucene.apache.org/"> Apache Lucene </a>索引。它用于拆分索引并保持大量数据的可管理性。</li>
<li>副本是一个安全机制，基本上是你的索引碎片的副本。</li>
<li><strong>文档</strong>是可以被索引的基本信息单元(类似于SQL行)。它用<a href="https://en.wikipedia.org/wiki/JSON"> JSON </a>来表示，这是一种无处不在的互联网数据交换格式。</li>
<li><strong>字段</strong>是Elasticsearch中最小的数据单元(类似于SQL列)。</li>
</ol>
<p>Elasticsearch集群具有以下结构:</p>
<p><img data-src="/static/images/blog/django/django-drf-elasticsearch/elasticsearch_cluster.png" loading="lazy" class="lazyload" alt="Elasticsearch cluster structure" src="../Images/aa76c24028af672ad9e2f3e427efcc56.png" data-original-src="https://testdriven.io/static/images/blog/django/django-drf-elasticsearch/elasticsearch_cluster.png"/></p>
<p>好奇关系数据库概念如何与Elasticsearch概念相关联？</p>
<table>
<thead>
<tr>
<th>关系数据库</th>
<th>弹性搜索</th>
</tr>
</thead>
<tbody>
<tr>
<td>串</td>
<td>串</td>
</tr>
<tr>
<td>RDBMS实例</td>
<td>结节</td>
</tr>
<tr>
<td>桌子</td>
<td>索引</td>
</tr>
<tr>
<td>排</td>
<td>文件</td>
</tr>
<tr>
<td>圆柱</td>
<td>田</td>
</tr>
</tbody>
</table>
<blockquote>
<p>查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_mapping_concepts_across_sql_and_elasticsearch.html">跨SQL和Elasticsearch映射概念</a>，了解SQL和Elasticsearch中的概念如何相互关联的更多信息。</p>
</blockquote>
<h2 id="elasticsearch-vs-postgresql-full-text-search">Elasticsearch与PostgreSQL全文搜索</h2>
<p>关于全文搜索，Elasticsearch和<a href="https://www.postgresql.org/"> PostgreSQL </a>各有利弊。在选择它们时，您应该考虑速度、查询复杂性和预算。</p>
<p>PostgreSQL的优势:</p>
<ol>
<li>Django支持</li>
<li>更快、更容易设置</li>
<li>不需要维护</li>
</ol>
<p>弹性搜索优势:</p>
<ol>
<li>仅为搜索而优化</li>
<li>电子搜索更快(尤其是当记录数量增加时)</li>
<li>支持不同的查询类型(叶、复合、模糊、正则表达式等等)</li>
</ol>
<p>如果你正在做一个简单的项目，速度并不重要，你应该选择PostgreSQL。如果性能很重要，并且您想编写复杂的查找，请选择Elasticsearch。</p>
<blockquote>
<p>关于Django和Postgres全文搜索的更多信息，请查看文章<a href="/blog/django-search/">使用Django和Postgres进行基本和全文搜索</a>。</p>
</blockquote>
<h2 id="project-setup">项目设置</h2>
<p>我们将构建一个简单的博客应用程序。我们的项目将由多个模型组成，这些模型将通过<a href="https://www.django-rest-framework.org/"> Django REST框架</a>进行序列化和服务。集成Elasticsearch后，我们将创建一个端点，允许我们查找不同的作者、类别和文章。</p>
<p>为了保持代码的整洁和模块化，我们将把项目分成以下两个应用:</p>
<ol>
<li>对于我们的Django模型、序列化器和视图集</li>
<li><code>search</code> -用于弹性搜索文档、索引和查询</li>
</ol>
<p>首先创建一个新目录，并建立一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-drf-elasticsearch <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-drf-elasticsearch
$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.2.6
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject core .
</code></pre></div>

<p>之后，创建一个名为<code>blog</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp blog
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em> core/settings.py </em>中注册app:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'blog.apps.BlogConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h2 id="database-models">数据库模型</h2>
<p>接下来，在<em>博客/models.py </em>中创建<code>Category</code>和<code>Article</code>模型:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/models.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s1">'categories'</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span>


<span class="n">ARTICLE_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">'UN'</span><span class="p">,</span> <span class="s1">'Unspecified'</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'TU'</span><span class="p">,</span> <span class="s1">'Tutorial'</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'RS'</span><span class="p">,</span> <span class="s1">'Research'</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'RW'</span><span class="p">,</span> <span class="s1">'Review'</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">ARTICLE_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'UN'</span><span class="p">)</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">Category</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">'categories'</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">)'</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>代表一个文章类别——例如，编程、Linux、测试。</li>
<li><code>Article</code>代表单篇文章。每篇文章可以有多个类别。文章有特定的类型- <code>Tutorial</code>、<code>Research</code>、<code>Review</code>或<code>Unspecified</code>。</li>
<li>作者由默认的Django用户模型表示。</li>
</ol>
<h3 id="run-migrations">运行迁移</h3>
<p>进行迁移，然后应用它们:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py makemigrations
<span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>在<em> blog/admin.py </em>中注册模型:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/admin.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Article</span>


<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span>
</code></pre></div>

<h3 id="populate-the-database">填充数据库</h3>
<p>在进入下一步之前，我们需要一些数据来处理。我创建了一个简单的命令，可以用来填充数据库。</p>
<p>在“博客”中创建一个名为“管理”的新文件夹，然后在该文件夹中创建另一个名为“命令”的文件夹。在“commands”文件夹中，创建一个名为<em> populate_db.py </em>的新文件。</p>
<div class="codehilite"><pre><span/><code>management
└── commands
    └── populate_db.py
</code></pre></div>

<p>从<a href="https://github.com/testdrivenio/django-drf-elasticsearch/blob/main/blog/management/commands/populate_db.py"> populate_db.py </a>中复制文件内容，粘贴到您的<em> populate_db.py </em>中。</p>
<p>运行以下命令来填充数据库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py populate_db
</code></pre></div>

<p>如果一切顺利，你应该会在控制台上看到一条<code>Successfully populated the database.</code>消息，并且你的数据库中应该会有一些文章。</p>
<h2 id="django-rest-framework">Django REST框架</h2>
<p>现在让我们使用pip安装<code>djangorestframework</code>:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">djangorestframework</span><span class="o">==</span><span class="m">3</span>.12.4
</code></pre></div>

<p>在我们的<em> settings.py </em>中注册，就像这样:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'blog.apps.BlogConfig'</span><span class="p">,</span>
    <span class="s1">'rest_framework'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>添加以下设置:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DEFAULT_PAGINATION_CLASS'</span><span class="p">:</span> <span class="s1">'rest_framework.pagination.LimitOffsetPagination'</span><span class="p">,</span>
    <span class="s1">'PAGE_SIZE'</span><span class="p">:</span> <span class="mi">25</span>
<span class="p">}</span>
</code></pre></div>

<p>我们将需要这些设置来实现分页。</p>
<h3 id="create-serializers">创建序列化程序</h3>
<p>为了序列化我们的Django模型，我们需要为每个模型创建一个序列化器。创建依赖于Django模型的序列化器的最简单方法是使用<code>ModelSerializer</code>类。</p>
<p><em>blog/serializer . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/serializers.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span><span class="p">,</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span> <span class="s1">'first_name'</span><span class="p">,</span> <span class="s1">'last_name'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">'__all__'</span>


<span class="k">class</span> <span class="nc">ArticleSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">()</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">CategorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">'__all__'</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li><code>UserSerializer</code>和<code>CategorySerializer</code>相当简单:我们只是提供了想要序列化的字段。</li>
<li>在<code>ArticleSerializer</code>中，我们需要处理好关系，以确保它们也被序列化。这就是为什么我们提供了<code>UserSerializer</code>和<code>CategorySerializer</code>。</li>
</ol>
<blockquote>
<p>想了解更多关于DRF连载？使用Django REST框架序列化器有效地检查<a href="/blog/drf-serializers/">。</a></p>
</blockquote>
<h3 id="create-viewsets">创建浏览器</h3>
<p>让我们在<em> blog/views.py </em>中为我们的每个模型创建一个视图集:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/views.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Article</span>
<span class="kn">from</span> <span class="nn">blog.serializers</span> <span class="kn">import</span> <span class="n">CategorySerializer</span><span class="p">,</span> <span class="n">ArticleSerializer</span><span class="p">,</span> <span class="n">UserSerializer</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CategoryViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ArticleViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ArticleSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>在这段代码中，我们通过为每个视图集提供<code>serializer_class</code>和<code>queryset</code>来创建视图集。</p>
<h3 id="define-urls">定义URL</h3>
<p>为视图集创建应用程序级别的URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="kn">from</span> <span class="nn">blog.views</span> <span class="kn">import</span> <span class="n">UserViewSet</span><span class="p">,</span> <span class="n">CategoryViewSet</span><span class="p">,</span> <span class="n">ArticleViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'user'</span><span class="p">,</span> <span class="n">UserViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'category'</span><span class="p">,</span> <span class="n">CategoryViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'article'</span><span class="p">,</span> <span class="n">ArticleViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div>

<p>然后，将应用程序URL连接到项目URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'blog/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'blog.urls'</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>我们的应用程序现在有以下网址:</p>
<ol>
<li><code>/blog/user/</code>列出所有用户</li>
<li><code>/blog/user/&lt;USER_ID&gt;/</code>获取特定用户</li>
<li><code>/blog/category/</code>列出所有类别</li>
<li><code>/blog/category/&lt;CATEGORY_ID&gt;/</code>获取特定类别</li>
<li><code>/blog/article/</code>列出所有文章</li>
<li><code>/blog/article/&lt;ARTICLE_ID&gt;/</code>获取特定的文章</li>
</ol>
<h3 id="testing">测试</h3>
<p>现在我们已经注册了URL，我们可以测试端点，看看是否一切正常。</p>
<p>运行开发服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>然后，在您选择的浏览器中，导航到<a href="http://127.0.0.1:8000/blog/article/">http://127 . 0 . 0 . 1:8000/blog/article/</a>。响应应该如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"next"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">                </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jess_"</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"first_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jess"</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"last_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Brown"</span><span class="w"/>
<span class="w">            </span><span class="p">},</span><span class="w"/>
<span class="w">            </span><span class="nt">"categories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">                </span><span class="p">{</span><span class="w"/>
<span class="w">                    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"/>
<span class="w">                    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SEO optimization"</span><span class="p">,</span><span class="w"/>
<span class="w">                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"/>
<span class="w">                </span><span class="p">}</span><span class="w"/>
<span class="w">            </span><span class="p">],</span><span class="w"/>
<span class="w">            </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"How to improve your Google rating?"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TU"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Firstly, add the correct SEO tags..."</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"created_datetime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-12T17:34:31.271610Z"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"updated_datetime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-12T17:34:31.322165Z"</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">                </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"johnny"</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"first_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Johnny"</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nt">"last_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Davis"</span><span class="w"/>
<span class="w">            </span><span class="p">},</span><span class="w"/>
<span class="w">            </span><span class="nt">"categories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">                </span><span class="p">{</span><span class="w"/>
<span class="w">                    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"/>
<span class="w">                    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Programming"</span><span class="p">,</span><span class="w"/>
<span class="w">                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"/>
<span class="w">                </span><span class="p">}</span><span class="w"/>
<span class="w">            </span><span class="p">],</span><span class="w"/>
<span class="w">            </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Installing latest version of Ubuntu"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TU"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"In this tutorial, we'll take a look at how to setup the latest version of Ubuntu. Ubuntu (/ʊˈbʊntuː/ is a Linux distribution based on Debian and composed mostly of free and open-source software. Ubuntu is officially released in three editions: Desktop, Server, and Core for Internet of things devices and robots."</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"created_datetime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-12T17:34:31.540628Z"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"updated_datetime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-12T17:34:31.592555Z"</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="err">...</span><span class="w"/>
<span class="w">    </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>手动测试其他端点。</p>
<h2 id="elasticsearch-setup">弹性搜索设置</h2>
<p>首先在后台安装并运行Elasticsearch。</p>
<blockquote>
<p>需要帮助启动和运行Elasticsearch吗？查看<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html">安装弹性搜索</a>指南。如果你熟悉Docker，你可以简单地运行下面的命令来拉取<a href="https://www.docker.elastic.co/r/elasticsearch">的官方图片</a>，并旋转一个运行着Elasticsearch的容器:</p><div class="codehilite"><pre><span/><code>$ docker run -p <span class="m">9200</span>:9200 -p <span class="m">9300</span>:9300 -e <span class="s2">"discovery.type=single-node"</span> docker.elastic.co/elasticsearch/elasticsearch:7.14.0
</code></pre></div>
</blockquote>

<p>要将Elasticsearch与Django集成，我们需要安装以下软件包:</p>
<ol>
<li><a href="https://elasticsearch-py.readthedocs.io/en/7.x/"> elasticsearch </a> -用于elasticsearch的官方低级Python客户端</li>
<li>用于编写和运行针对elasticsearch的查询的高级库</li>
<li>django-elasticsearch-dsl  -围绕elasticsearch-dsl-py的包装器，允许在elasticsearch中索引django模型</li>
</ol>
<p>安装:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">elasticsearch</span><span class="o">==</span><span class="m">7</span>.14.0
<span class="o">(</span>env<span class="o">)</span>$ pip install elasticsearch-dsl<span class="o">==</span><span class="m">7</span>.4.0
<span class="o">(</span>env<span class="o">)</span>$ pip install django-elasticsearch-dsl<span class="o">==</span><span class="m">7</span>.2.0
</code></pre></div>

<p>启动一个名为<code>search</code>的新应用，它将保存我们的弹性搜索文档、索引和查询:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp search
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em> core/settings.py </em>中注册<code>search</code>和<code>django_elasticsearch_dsl</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'django_elasticsearch_dsl'</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="s1">'blog.apps.BlogConfig'</span><span class="p">,</span>
    <span class="s1">'search.apps.SearchConfig'</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="s1">'rest_framework'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p>现在我们需要让Django知道Elasticsearch在哪里运行。为此，我们将以下内容添加到我们的<em> core/settings.py </em>文件中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="c1"># Elasticsearch</span>
<span class="c1"># https://django-elasticsearch-dsl.readthedocs.io/en/latest/settings.html</span>

<span class="n">ELASTICSEARCH_DSL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'hosts'</span><span class="p">:</span> <span class="s1">'localhost:9200'</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p>如果您的Elasticsearch在不同的端口上运行，请确保相应地更改上述设置。</p>
</blockquote>
<p>我们可以通过启动服务器来测试Django是否可以连接到Elasticsearch:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>如果您的Django服务器出现故障，Elasticsearch可能无法正常工作。</p>
<h2 id="creating-documents">创建文档</h2>
<p>在创建文档之前，我们需要确保所有的数据都以正确的格式保存。我们在文章<code>type</code>中使用<code>CharField(max_length=2)</code>，这本身没有多大意义。这就是为什么我们将它转换成人类可读的文本。</p>
<p>我们将通过在模型中添加一个<code>type_to_string()</code>方法来实现这一点，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/models.py</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">ARTICLE_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'UN'</span><span class="p">)</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">Category</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">'categories'</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># new</span>
    <span class="k">def</span> <span class="nf">type_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'UN'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'Unspecified'</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'TU'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'Tutorial'</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'RS'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'Research'</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'RW'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'Review'</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">)'</span>
</code></pre></div>

<p>如果没有<code>type_to_string()</code>,我们的模型将会连载成这样:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is my article."</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TU"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="err">...</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>在实现<code>type_to_string()</code>之后，我们的模型被序列化成这样:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is my article."</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tutorial"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="err">...</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>现在让我们创建文档。每个文档需要有一个<code>Index</code>和<code>Django</code>类。在<code>Index</code>类中，我们需要提供指标名称和<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html">弹性搜索指标设置</a>。在<code>Django</code>类中，我们告诉文档与哪个Django模型相关联，并提供我们想要索引的字段。</p>
<p><em>博客/documents.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># blog/documents.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django_elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">django_elasticsearch_dsl.registries</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Article</span>


<span class="nd">@registry</span><span class="o">.</span><span class="n">register_document</span>
<span class="k">class</span> <span class="nc">UserDocument</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Index</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">'users'</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'number_of_shards'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'number_of_replicas'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Django</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span><span class="p">,</span>
            <span class="s1">'first_name'</span><span class="p">,</span>
            <span class="s1">'last_name'</span><span class="p">,</span>
            <span class="s1">'username'</span><span class="p">,</span>
        <span class="p">]</span>


<span class="nd">@registry</span><span class="o">.</span><span class="n">register_document</span>
<span class="k">class</span> <span class="nc">CategoryDocument</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Index</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">'categories'</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'number_of_shards'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'number_of_replicas'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Django</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'name'</span><span class="p">,</span>
            <span class="s1">'description'</span><span class="p">,</span>
        <span class="p">]</span>


<span class="nd">@registry</span><span class="o">.</span><span class="n">register_document</span>
<span class="k">class</span> <span class="nc">ArticleDocument</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ObjectField</span><span class="p">(</span><span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'id'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(),</span>
        <span class="s1">'first_name'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(),</span>
        <span class="s1">'last_name'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(),</span>
        <span class="s1">'username'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(),</span>
    <span class="p">})</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ObjectField</span><span class="p">(</span><span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'id'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(),</span>
        <span class="s1">'name'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(),</span>
        <span class="s1">'description'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(),</span>
    <span class="p">})</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s1">'type_to_string'</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Index</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">'articles'</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'number_of_shards'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'number_of_replicas'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">class</span> <span class="nc">Django</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span><span class="p">,</span>
            <span class="s1">'content'</span><span class="p">,</span>
            <span class="s1">'created_datetime'</span><span class="p">,</span>
            <span class="s1">'updated_datetime'</span><span class="p">,</span>
        <span class="p">]</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>为了转换文章类型，我们向<code>ArticleDocument</code>添加了<code>type</code>属性。</li>
<li>因为我们的<code>Article</code>模型与<code>Category</code>是多对多(M:N)关系，与<code>User</code>是多对一(N:1)关系，所以我们需要处理好这些关系。我们通过添加<code>ObjectField</code>属性做到了这一点。</li>
</ol>
<h3 id="populate-elasticsearch">填充弹性搜索</h3>
<p>要创建和填充Elasticsearch索引和映射，使用<code>search_index</code>命令:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py search_index --rebuild

Deleting index <span class="s1">'users'</span>
Deleting index <span class="s1">'categories'</span>
Deleting index <span class="s1">'articles'</span>
Creating index <span class="s1">'users'</span>
Creating index <span class="s1">'categories'</span>
Creating index <span class="s1">'articles'</span>
Indexing <span class="m">3</span> <span class="s1">'User'</span> objects
Indexing <span class="m">4</span> <span class="s1">'Article'</span> objects
Indexing <span class="m">4</span> <span class="s1">'Category'</span> objects
</code></pre></div>

<blockquote>
<p>每次更改索引设置时，都需要运行此命令。</p>
</blockquote>
<p>django-elasticsearch-dsl创建了适当的数据库信号，这样每次创建、删除或编辑模型实例时，您的elasticsearch存储都会得到更新。</p>
<h2 id="elasticsearch-queries">弹性搜索查询</h2>
<p>在创建适当的视图之前，让我们看看Elasticsearch查询是如何工作的。</p>
<p>我们首先必须获得<code>Search</code>实例。我们通过调用文档中的<code>search()</code>来实现，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span>

<span class="n">search</span> <span class="o">=</span> <span class="n">ArticleDocument</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>
</code></pre></div>

<blockquote>
<p>您可以在Django shell中随意运行这些查询。</p>
</blockquote>
<p>一旦我们有了<code>Search</code>实例，我们就可以将查询传递给<code>query()</code>方法并获取响应:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span>


<span class="c1"># Looks up all the articles that contain `How to` in the title.</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">'How to'</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
     <span class="s1">'multi_match'</span><span class="p">,</span>
     <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
     <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
         <span class="s1">'title'</span>
     <span class="p">])</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">ArticleDocument</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># print all the hits</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</code></pre></div>

<p>我们还可以像这样组合多个Q语句:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span>

<span class="sd">"""</span>
<span class="sd">Looks up all the articles that:</span>
<span class="sd">1) Contain 'language' in the 'title'</span>
<span class="sd">2) Don't contain 'ruby' or 'javascript' in the 'title'</span>
<span class="sd">3) And contain the query either in the 'title' or 'description'</span>
<span class="sd">"""</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">'programming'</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
     <span class="s1">'bool'</span><span class="p">,</span>
     <span class="n">must</span><span class="o">=</span><span class="p">[</span>
         <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'language'</span><span class="p">),</span>
     <span class="p">],</span>
     <span class="n">must_not</span><span class="o">=</span><span class="p">[</span>
         <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'ruby'</span><span class="p">),</span>
         <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'javascript'</span><span class="p">),</span>
     <span class="p">],</span>
     <span class="n">should</span><span class="o">=</span><span class="p">[</span>
         <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">query</span><span class="p">),</span>
         <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">query</span><span class="p">),</span>
     <span class="p">],</span>
     <span class="n">minimum_should_match</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">ArticleDocument</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># print all the hits</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</code></pre></div>

<p>使用Elasticsearch查询的另一个重要因素是模糊性。模糊查询是允许我们处理错别字的查询。他们使用<a href="https://en.wikipedia.org/wiki/Levenshtein_distance"> Levenshtein距离算法</a>来计算数据库中的结果和查询之间的距离。</p>
<p>让我们看一个例子。</p>
<p>通过运行下面的查询，我们不会得到任何结果，因为用户拼错了“django”。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">'djengo'</span>  <span class="c1"># notice the typo</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
     <span class="s1">'multi_match'</span><span class="p">,</span>
     <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
     <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
         <span class="s1">'title'</span>
     <span class="p">])</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">ArticleDocument</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># print all the hits</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</code></pre></div>

<p>如果我们像这样启用模糊性:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">'djengo'</span>  <span class="c1"># notice the typo</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
     <span class="s1">'multi_match'</span><span class="p">,</span>
     <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
     <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
         <span class="s1">'title'</span>
     <span class="p">],</span>
     <span class="n">fuzziness</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">ArticleDocument</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># print all the hits</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</code></pre></div>

<p>用户将得到正确的结果。</p>
<blockquote>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html">全文搜索</a>和<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html">精确匹配</a>的区别在于，全文搜索会在文本被索引到Elasticsearch之前对其进行分析。文本被分解成不同的记号，这些记号被转换成它们的根形式(例如，reading - &gt; read)。这些令牌然后被保存到<a href="https://www.elastic.co/blog/found-elasticsearch-from-the-bottom-up#inverted-indexes-and-index-terms">倒排索引</a>中。因此，全文搜索会产生更多的结果，但需要更长的处理时间。</p>
</blockquote>
<p>Elasticsearch有许多附加功能。要熟悉API，请尝试实现:</p>
<ol>
<li>自己的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-custom-analyzer.html">分析仪</a>。</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/search-suggesters-completion.html">完成提示器</a> -当用户查询‘j’时，你的应用程序应该提示‘johny’或‘Jess _’。</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/highlighting.html">高亮显示</a> -当用户打错字时，高亮显示(如Linux-&gt;<em>Linux</em>)。</li>
</ol>
<p>你可以在这里看到所有的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html"> Elasticsearch搜索API</a>。</p>
<h2 id="search-views">搜索视图</h2>
<p>这样，让我们创建一些视图。为了让我们的代码更加简洁，我们可以在<em> search/views.py </em>中使用下面的抽象类:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># search/views.py</span>

<span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">LimitOffsetPagination</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>


<span class="k">class</span> <span class="nc">PaginatedElasticSearchAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">,</span> <span class="n">LimitOffsetPagination</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">document_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate_q_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">"""This method should be overridden</span>
<span class="sd">        and return a Q() expression."""</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_q_expression</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_class</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Found </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1"> hit(s) for query: "</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>要使用这个类，我们必须提供我们的<code>serializer_class</code>和<code>document_class</code>并覆盖<code>generate_q_expression()</code>。</li>
<li>该类除了运行<code>generate_q_expression()</code>查询、获取响应、分页并返回序列化数据之外什么也不做。</li>
</ol>
<p>所有的视图现在都应该继承自<code>PaginatedElasticSearchAPIView</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># search/views.py</span>

<span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">LimitOffsetPagination</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">blog.documents</span> <span class="kn">import</span> <span class="n">ArticleDocument</span><span class="p">,</span> <span class="n">UserDocument</span><span class="p">,</span> <span class="n">CategoryDocument</span>
<span class="kn">from</span> <span class="nn">blog.serializers</span> <span class="kn">import</span> <span class="n">ArticleSerializer</span><span class="p">,</span> <span class="n">UserSerializer</span><span class="p">,</span> <span class="n">CategorySerializer</span>


<span class="k">class</span> <span class="nc">PaginatedElasticSearchAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">,</span> <span class="n">LimitOffsetPagination</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">document_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate_q_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">"""This method should be overridden</span>
<span class="sd">        and return a Q() expression."""</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_q_expression</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_class</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Found </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1"> hit(s) for query: "</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="c1"># views</span>


<span class="k">class</span> <span class="nc">SearchUsers</span><span class="p">(</span><span class="n">PaginatedElasticSearchAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">document_class</span> <span class="o">=</span> <span class="n">UserDocument</span>

    <span class="k">def</span> <span class="nf">generate_q_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">,</span>
                 <span class="n">should</span><span class="o">=</span><span class="p">[</span>
                     <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">query</span><span class="p">),</span>
                     <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="n">query</span><span class="p">),</span>
                     <span class="n">Q</span><span class="p">(</span><span class="s1">'match'</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="n">query</span><span class="p">),</span>
                 <span class="p">],</span> <span class="n">minimum_should_match</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SearchCategories</span><span class="p">(</span><span class="n">PaginatedElasticSearchAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
    <span class="n">document_class</span> <span class="o">=</span> <span class="n">CategoryDocument</span>

    <span class="k">def</span> <span class="nf">generate_q_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span>
                <span class="s1">'multi_match'</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">'name'</span><span class="p">,</span>
                    <span class="s1">'description'</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">fuzziness</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SearchArticles</span><span class="p">(</span><span class="n">PaginatedElasticSearchAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ArticleSerializer</span>
    <span class="n">document_class</span> <span class="o">=</span> <span class="n">ArticleDocument</span>

    <span class="k">def</span> <span class="nf">generate_q_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">(</span>
                <span class="s1">'multi_match'</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">'title'</span><span class="p">,</span>
                    <span class="s1">'author'</span><span class="p">,</span>
                    <span class="s1">'type'</span><span class="p">,</span>
                    <span class="s1">'content'</span>
                <span class="p">],</span> <span class="n">fuzziness</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
</code></pre></div>

<h3 id="define-urls_1">定义URL</h3>
<p>最后，让我们为视图创建URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># search.urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">search.views</span> <span class="kn">import</span> <span class="n">SearchArticles</span><span class="p">,</span> <span class="n">SearchCategories</span><span class="p">,</span> <span class="n">SearchUsers</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'user/&lt;str:query&gt;/'</span><span class="p">,</span> <span class="n">SearchUsers</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'category/&lt;str:query&gt;/'</span><span class="p">,</span> <span class="n">SearchCategories</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'article/&lt;str:query&gt;/'</span><span class="p">,</span> <span class="n">SearchArticles</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div>

<p>然后，将应用程序URL连接到项目URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'blog/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'blog.urls'</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'search/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'search.urls'</span><span class="p">)),</span> <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="testing_1">测试</h3>
<p>我们的web应用程序完成了。我们可以通过访问以下URL来测试我们的搜索端点:</p>


<blockquote>
<p>注意第四个请求的错别字。我们拼写了“progreming ”,但由于模糊性，仍然得到了正确的结果。</p>
</blockquote>
<h2 id="alternative-libraries">替代库</h2>
<p>我们选择的道路并不是整合Django和Elasticsearch的唯一途径。还有一些其他的图书馆你可能想去看看:</p>
<ol>
<li>django-elasicsearch-dsl-drf 是围绕Elasticsearch和Django REST框架的一个包装器。它提供了视图、序列化器、过滤器后端、分页等等。它工作得很好，但是对于较小的项目来说可能有些矫枉过正。如果你需要高级的弹性搜索功能，我推荐你使用它。</li>
<li><a href="https://haystacksearch.org/"> Haystack </a>是一些搜索后端的包装器，比如Elasticsearch、<a href="http://lucene.apache.org/solr/"> Solr </a>和<a href="https://github.com/mchaput/whoosh/"> Whoosh </a>。它允许您编写一次搜索代码，并在不同的搜索后端重用它。它非常适合实现一个简单的搜索框。因为Haystack是另一个抽象层，所以会涉及更多的开销，所以如果性能真的很重要或者如果您正在处理大量数据，就不应该使用它。这也需要一些配置。</li>
<li>Django REST框架的Haystack是一个小库，它试图简化Haystack与Django REST框架的集成。在撰写本文时，该项目有点过时，他们的文档也写得很糟糕。我花了相当多的时间试图让它工作，但运气不好。</li>
</ol>
<h2 id="conclusion">结论</h2>
<p>在本教程中，您学习了使用Django REST框架和Elasticsearch的基础知识。您现在知道如何集成它们，创建Elasticsearch文档和查询，并通过RESTful API提供数据。</p>
<blockquote>
<p>在将你的项目投入生产之前，考虑使用一个托管的Elasticsearch服务，比如<a href="https://www.elastic.co/pricing/"> Elastic Cloud </a>、<a href="https://aws.amazon.com/elasticsearch-service/">亚马逊Elasticsearch服务</a>或<a href="https://azure.microsoft.com/en-us/overview/linux-on-azure/elastic/"> Elastic on Azure </a>。使用托管服务的成本将高于管理您自己的集群，但它们提供了部署、保护和运行Elasticsearch集群所需的所有基础设施。此外，他们将处理版本更新、定期备份和扩展。</p>
</blockquote>
<p>从GitHub上的<a href="https://github.com/testdrivenio/django-drf-elasticsearch">django-drf-elastic search</a>repo中抓取代码。</p>
  </div>

  </div>    
</body>
</html>