<html>
<head>
<title>Building a Concurrent Web Scraper with Python and Selenium </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Python和Selenium构建并发Web Scraper</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/building-a-concurrent-web-scraper-with-python-and-selenium/#0001-01-01">https://testdriven.io/blog/building-a-concurrent-web-scraper-with-python-and-selenium/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本文着眼于如何通过<code>concurrent.futures</code>模块用多线程加速Python web抓取和爬行脚本。我们还将分解脚本本身，并展示如何用pytest测试解析功能。</p>
<p>完成本文后，您将能够:</p>
<ol>
<li>用Selenium抓取网站，用美汤解析HTML</li>
<li>设置pytest来测试抓取和解析功能</li>
<li>与<code>concurrent.futures</code>模块同时执行网络刮刀</li>
<li>使用Selenium为ChromeDriver配置无头模式</li>
</ol>



<h2 id="project-setup">项目设置</h2>
<p>如果你想继续的话，复制回购协议。从命令行运行以下命令:</p>
<div class="codehilite"><pre><span/><code>$ git clone <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="73141a0733141a071b06115d101c1e">[email protected]</a>:testdrivenio/concurrent-web-scraping.git
$ <span class="nb">cd</span> concurrent-web-scraping

$ python -m venv env
$ <span class="nb">source</span> env/bin/activate
<span class="o">(</span>env<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<blockquote>
<p>根据您的环境，上述命令可能会有所不同。</p>
</blockquote>
<p>全局安装<a href="https://sites.google.com/chromium.org/driver/"> ChromeDriver </a>。(我们使用的是版本<a href="https://chromedriver.storage.googleapis.com/index.html?path=96.0.4664.45/"> 96.0.4664.45 </a>)。</p>
<h2 id="script-overview">脚本概述</h2>
<p>该脚本向<a href="https://en.wikipedia.org/wiki/Wikipedia:Random"> Wikipedia:Random </a> - <code>https://en.wikipedia.org/wiki/Special:Random</code>发出20个请求，请求关于每篇文章的信息，使用<a href="http://www.seleniumhq.org/projects/webdriver/"> Selenium </a>自动与站点交互，使用<a href="https://www.crummy.com/software/BeautifulSoup/"> Beautiful Soup </a>解析HTML。</p>
<p><em> script.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">scrapers.scraper</span> <span class="kn">import</span> <span class="n">connect_to_base</span><span class="p">,</span> <span class="n">get_driver</span><span class="p">,</span> <span class="n">parse_html</span><span class="p">,</span> <span class="n">write_to_file</span>


<span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># headless mode?</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"headless"</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Running in headless mode"</span><span class="p">)</span>
            <span class="n">headless</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># set variables</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">current_attempt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S"</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"output_</span><span class="si">{</span><span class="n">output_timestamp</span><span class="si">}</span><span class="s2">.csv"</span>

    <span class="c1"># init browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>

    <span class="c1"># scrape and crawl</span>
    <span class="k">while</span> <span class="n">current_attempt</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Scraping Wikipedia #</span><span class="si">{</span><span class="n">current_attempt</span><span class="si">}</span><span class="s2"> time(s)..."</span><span class="p">)</span>
        <span class="n">run_process</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">)</span>
        <span class="n">current_attempt</span> <span class="o">=</span> <span class="n">current_attempt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># exit</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed run time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>
</code></pre></div>

<p>让我们从主块开始。在确定Chrome是否应该在headless模式下运行并定义一些变量后，浏览器通过<em> scrapers/scraper.py </em>中的<code>get_driver()</code>进行初始化:</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># headless mode?</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"headless"</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Running in headless mode"</span><span class="p">)</span>
            <span class="n">headless</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># set variables</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">current_attempt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S"</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"output_</span><span class="si">{</span><span class="n">output_timestamp</span><span class="si">}</span><span class="s2">.csv"</span>

    <span class="c1">########</span>
    <span class="c1"># here #</span>
    <span class="c1">########</span>
    <span class="c1"># init browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>

    <span class="c1"># scrape and crawl</span>
    <span class="k">while</span> <span class="n">current_attempt</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Scraping Wikipedia #</span><span class="si">{</span><span class="n">current_attempt</span><span class="si">}</span><span class="s2"> time(s)..."</span><span class="p">)</span>
        <span class="n">run_process</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">)</span>
        <span class="n">current_attempt</span> <span class="o">=</span> <span class="n">current_attempt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># exit</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed run time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>
</code></pre></div>

<p>然后配置一个<code>while</code>回路来控制整个刮刀的流量。</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># headless mode?</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"headless"</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Running in headless mode"</span><span class="p">)</span>
            <span class="n">headless</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># set variables</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">current_attempt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S"</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"output_</span><span class="si">{</span><span class="n">output_timestamp</span><span class="si">}</span><span class="s2">.csv"</span>

    <span class="c1"># init browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>

    <span class="c1">########</span>
    <span class="c1"># here #</span>
    <span class="c1">########</span>
    <span class="c1"># scrape and crawl</span>
    <span class="k">while</span> <span class="n">current_attempt</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Scraping Wikipedia #</span><span class="si">{</span><span class="n">current_attempt</span><span class="si">}</span><span class="s2"> time(s)..."</span><span class="p">)</span>
        <span class="n">run_process</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">)</span>
        <span class="n">current_attempt</span> <span class="o">=</span> <span class="n">current_attempt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># exit</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed run time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>
</code></pre></div>

<p>在这个循环中，<code>run_process()</code>被调用，它管理<a href="https://developer.mozilla.org/en-US/docs/Web/WebDriver"> WebDriver </a>的连接和抓取功能。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>
</code></pre></div>

<p>在<code>run_process()</code>中，浏览器实例传递给了<code>connect_to_base()</code>。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>

    <span class="c1">########</span>
    <span class="c1"># here #</span>
    <span class="c1">########</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to wikipedia"</span><span class="p">)</span>
</code></pre></div>

<p>这个函数试图连接到wikipedia，然后使用Selenium的显式等待功能来确保带有<code>id='content'</code>的元素在继续之前已经加载。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://en.wikipedia.org/wiki/Special:Random"</span>
    <span class="n">connection_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">connection_attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
            <span class="c1"># wait for table element with id = 'content' to load</span>
            <span class="c1"># before returning True</span>
            <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">browser</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
                <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">connection_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error connecting to </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Attempt #</span><span class="si">{</span><span class="n">connection_attempts</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<blockquote>
<p>查看Selenium <a href="http://selenium-python.readthedocs.io/waits.html#explicit-waits">文档</a>了解更多关于显式等待的信息。</p>
</blockquote>
<p>为了模拟人类用户，在浏览器连接到维基百科后会调用<code>sleep(2)</code>。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>

        <span class="c1">########</span>
        <span class="c1"># here #</span>
        <span class="c1">########</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>
</code></pre></div>

<p>一旦页面被加载并且<code>sleep(2)</code>被执行，浏览器获取HTML源，然后传递给<code>parse_html()</code>。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1">########</span>
        <span class="c1"># here #</span>
        <span class="c1">########</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>

        <span class="c1">########</span>
        <span class="c1"># here #</span>
        <span class="c1">########</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>
</code></pre></div>

<p>使用Beautiful Soup解析HTML，生成包含适当数据的字典列表。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="c1"># create soup object</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s2">"html.parser"</span><span class="p">)</span>
    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># parse soup object to get wikipedia article url, title, and last modified date</span>
    <span class="n">article_url</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"link"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"rel"</span><span class="p">:</span> <span class="s2">"canonical"</span><span class="p">})[</span><span class="s2">"href"</span><span class="p">]</span>
    <span class="n">article_title</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"h1"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="s2">"firstHeading"</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
    <span class="n">article_last_modified</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"li"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="s2">"footer-info-lastmod"</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
    <span class="n">article_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"url"</span><span class="p">:</span> <span class="n">article_url</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="n">article_title</span><span class="p">,</span>
        <span class="s2">"last_modified"</span><span class="p">:</span> <span class="n">article_last_modified</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_list</span>
</code></pre></div>

<p>该函数还将文章URL传递给<code>get_load_time()</code>，由它加载URL并记录随后的加载时间。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">get_load_time</span><span class="p">(</span><span class="n">article_url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># set headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"User-Agent"</span><span class="p">:</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36"</span>
        <span class="p">}</span>
        <span class="c1"># make get request to article_url</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">article_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.000</span>
        <span class="p">)</span>
        <span class="c1"># get page load time</span>
        <span class="n">load_time</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">load_time</span> <span class="o">=</span> <span class="s2">"Loading Error"</span>
    <span class="k">return</span> <span class="n">load_time</span>
</code></pre></div>

<p>输出被添加到CSV文件中。</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="c1">########</span>
        <span class="c1"># here #</span>
        <span class="c1">########</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>
</code></pre></div>

<p><code>write_to_file()</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s2">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"url"</span><span class="p">,</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"last_modified"</span><span class="p">]</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>

<p>最后，回到<code>while</code>循环中，<code>current_attempt</code>递增，过程再次开始。</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># headless mode?</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"headless"</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Running in headless mode"</span><span class="p">)</span>
            <span class="n">headless</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># set variables</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">current_attempt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S"</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"output_</span><span class="si">{</span><span class="n">output_timestamp</span><span class="si">}</span><span class="s2">.csv"</span>

    <span class="c1"># init browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>

    <span class="c1"># scrape and crawl</span>
    <span class="k">while</span> <span class="n">current_attempt</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Scraping Wikipedia #</span><span class="si">{</span><span class="n">current_attempt</span><span class="si">}</span><span class="s2"> time(s)..."</span><span class="p">)</span>
        <span class="n">run_process</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">browser</span><span class="p">)</span>

        <span class="c1">########</span>
        <span class="c1"># here #</span>
        <span class="c1">########</span>
        <span class="n">current_attempt</span> <span class="o">=</span> <span class="n">current_attempt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># exit</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed run time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<p>想测试一下吗？点击获取完整脚本<a href="https://github.com/testdrivenio/concurrent-web-scraping/blob/master/script.py">。</a></p>
</blockquote>
<p>运行大约需要57秒:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python script.py

Scraping Wikipedia <span class="c1">#1 time(s)...</span>
Scraping Wikipedia <span class="c1">#2 time(s)...</span>
Scraping Wikipedia <span class="c1">#3 time(s)...</span>
Scraping Wikipedia <span class="c1">#4 time(s)...</span>
Scraping Wikipedia <span class="c1">#5 time(s)...</span>
Scraping Wikipedia <span class="c1">#6 time(s)...</span>
Scraping Wikipedia <span class="c1">#7 time(s)...</span>
Scraping Wikipedia <span class="c1">#8 time(s)...</span>
Scraping Wikipedia <span class="c1">#9 time(s)...</span>
Scraping Wikipedia <span class="c1">#10 time(s)...</span>
Scraping Wikipedia <span class="c1">#11 time(s)...</span>
Scraping Wikipedia <span class="c1">#12 time(s)...</span>
Scraping Wikipedia <span class="c1">#13 time(s)...</span>
Scraping Wikipedia <span class="c1">#14 time(s)...</span>
Scraping Wikipedia <span class="c1">#15 time(s)...</span>
Scraping Wikipedia <span class="c1">#16 time(s)...</span>
Scraping Wikipedia <span class="c1">#17 time(s)...</span>
Scraping Wikipedia <span class="c1">#18 time(s)...</span>
Scraping Wikipedia <span class="c1">#19 time(s)...</span>
Scraping Wikipedia <span class="c1">#20 time(s)...</span>
Elapsed run time: <span class="m">57</span>.36561393737793 seconds
</code></pre></div>

<p>明白了吗？太好了！让我们添加一些基本的测试。</p>
<h2 id="testing">测试</h2>
<p>要在不启动浏览器的情况下测试解析功能，从而向Wikipedia发出重复的GET请求，您可以下载页面的HTML ( <em> test/test.html </em>)并在本地解析它。这有助于避免在编写和测试解析函数时，由于太快发出太多请求而导致IP被阻塞的情况，同时也节省了时间，因为不必在每次运行脚本时都打开浏览器。</p>
<p><em> test/test_scraper.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">scrapers</span> <span class="kn">import</span> <span class="n">scraper</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">html_output</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"test.html"</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">scraper</span><span class="o">.</span><span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_output_is_not_none</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">html_output</span>


<span class="k">def</span> <span class="nf">test_output_is_a_list</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">html_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_output_is_a_list_of_dicts</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">html_output</span><span class="p">)</span>
</code></pre></div>

<p>确保一切正常:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python -m pytest test/test_scraper.py

<span class="o">================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=================================</span>
platform darwin -- Python <span class="m">3</span>.10.0, pytest-6.2.5, py-1.11.0, pluggy-1.0.0
rootdir: /Users/michael/repos/testdriven/async-web-scraping
collected <span class="m">3</span> items

test/test_scraper.py ...                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=================================</span> <span class="m">3</span> passed <span class="k">in</span> <span class="m">0</span>.19 <span class="o">==================================</span>
</code></pre></div>

<p>想模仿<code>get_load_time()</code>绕过GET请求？</p>
<p><em>test/test _ scraper _ mock . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">scrapers</span> <span class="kn">import</span> <span class="n">scraper</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">html_output</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mock_get_load_time</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"mocked!"</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">scraper</span><span class="p">,</span> <span class="s2">"get_load_time"</span><span class="p">,</span> <span class="n">mock_get_load_time</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"test.html"</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">scraper</span><span class="o">.</span><span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_output_is_not_none</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">html_output</span>


<span class="k">def</span> <span class="nf">test_output_is_a_list</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">html_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_output_is_a_list_of_dicts</span><span class="p">(</span><span class="n">html_output</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">html_output</span><span class="p">)</span>
</code></pre></div>

<p>测试:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python -m pytest test/test_scraper_mock.py

<span class="o">================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=================================</span>
platform darwin -- Python <span class="m">3</span>.10.0, pytest-6.2.5, py-1.11.0, pluggy-1.0.0
rootdir: /Users/michael/repos/testdriven/async-web-scraping
collected <span class="m">3</span> items

test/test_scraper.py ...                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=================================</span> <span class="m">3</span> passed <span class="k">in</span> <span class="m">0</span>.27s <span class="o">=================================</span>
</code></pre></div>

<h2 id="configure-multithreading">配置多线程</h2>
<p>现在有趣的部分来了！通过对脚本进行一些修改，我们可以加快速度:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">wait</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">scrapers.scraper</span> <span class="kn">import</span> <span class="n">connect_to_base</span><span class="p">,</span> <span class="n">get_driver</span><span class="p">,</span> <span class="n">parse_html</span><span class="p">,</span> <span class="n">write_to_file</span>


<span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">headless</span><span class="p">):</span>

    <span class="c1"># init browser</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">headless</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connect_to_base</span><span class="p">(</span><span class="n">browser</span><span class="p">):</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">write_to_file</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># exit</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error connecting to Wikipedia"</span><span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># headless mode?</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"headless"</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Running in headless mode"</span><span class="p">)</span>
            <span class="n">headless</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># set variables</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S"</span><span class="p">)</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"output_</span><span class="si">{</span><span class="n">output_timestamp</span><span class="si">}</span><span class="s2">.csv"</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># scrape and crawl</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">run_process</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">headless</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">wait</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elapsed run time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>
</code></pre></div>

<p>有了<code>concurrent.futures</code>库，<code>ThreadPoolExecutor</code>被用来产生一个线程池来异步执行<code>run_process</code>函数。<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">提交</a>方法接受该函数及其参数，并返回一个<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Future">未来</a>对象。<a href="https://docs.python.org/3.4/library/concurrent.futures.html#module-functions"> wait </a>用于阻塞执行，直到所有任务完成。</p>
<p>值得注意的是，您可以通过<code>ProcessPoolExecutor</code>轻松切换到多处理，因为<code>ProcessPoolExecutor</code>和<code>ThreadPoolExecutor</code>实现了相同的接口:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># scrape and crawl</span>
<span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">run_process</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">headless</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<blockquote>
<p>为什么是多线程而不是多重处理？</p>
<p>Web抓取是I/O绑定的，因为获取HTML (I/O)比解析它(CPU)慢。关于这一点以及并行性(多处理)和并发性(多线程)之间的区别的更多信息，请回顾文章<a href="/blog/concurrency-parallelism-asyncio/">用并发性、并行性和异步性加速Python。</a></p>
</blockquote>
<p>运行:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python script_concurrent.py

Elapsed run time: <span class="m">11</span>.831077098846436 seconds
</code></pre></div>

<blockquote>
<p>点击查看完整的脚本<a href="https://github.com/testdrivenio/concurrent-web-scraping/blob/master/script_concurrent.py">。</a></p>
</blockquote>
<p>为了进一步加快速度，我们可以通过传入<code>headless</code>命令行参数在无头模式下运行Chrome:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python script_concurrent.py headless

Running <span class="k">in</span> headless mode
Elapsed run time: <span class="m">6</span>.222846269607544 seconds
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>通过对原始代码进行少量修改，我们能够并发执行web scraper，将脚本的运行时间从大约57秒缩短到6秒多一点。在这个特定场景中，速度提高了大约90%，这是一个巨大的进步。</p>
<p>我希望这对你的剧本有所帮助。你可以在<a href="https://github.com/testdrivenio/concurrent-web-scraping/">回购</a>中找到代码。干杯！</p>
  </div>

  </div>    
</body>
</html>