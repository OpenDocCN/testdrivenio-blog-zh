<html>
<head>
<title>Building a CRUD App with FastAPI and MongoDB </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用FastAPI和MongoDB构建CRUD应用程序</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/fastapi-mongo/#0001-01-01">https://testdriven.io/blog/fastapi-mongo/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，你将学习如何用<a href="https://fastapi.tiangolo.com/"> FastAPI </a>和<a href="https://www.mongodb.com/"> MongoDB </a>开发异步API。我们将使用<a href="https://motor.readthedocs.io">马达</a>包与MongoDB进行异步交互。</p>



<h2 id="objectives">目标</h2>
<p>本教程结束时，您将能够:</p>
<ol>
<li>用Python和FastAPI开发RESTful API</li>
<li>与MongoDB异步交互</li>
<li>使用MongoDB Atlas在云中运行MongoDB</li>
<li>将FastAPI应用程序部署到Heroku</li>
</ol>
<h2 id="initial-setup">初始设置</h2>
<p>首先创建一个新文件夹来保存名为“fastapi-mongo”的项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir fastapi-mongo
$ <span class="nb">cd</span> fastapi-mongo
</code></pre></div>

<p>接下来，创建并激活虚拟环境:</p>
<div class="codehilite"><pre><span/><code>$ python3.9 -m venv venv
$ <span class="nb">source</span> venv/bin/activate
$ <span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$PWD</span>
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>接下来，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>├── app
│   ├── __init__.py
│   ├── main.py
│   └── server
│       ├── app.py
│       ├── database.py
│       ├── models
│       └── routes
└── requirements.txt
</code></pre></div>

<p>将以下依赖项添加到您的<em> requirements.txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.73.0
uvicorn==0.17.4
</code></pre></div>

<p>安装它们:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>在<em> app/main.py </em>文件中，定义运行应用程序的入口点:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">uvicorn</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"server.app:app"</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们指示文件在端口8000上运行一个<a href="https://www.uvicorn.org/">uvicon</a>服务器，并在每次文件更改时重新加载。</p>
<p>在通过入口点文件启动服务器之前，在<em> app/server/app.py </em>中创建一个基本路由:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"Root"</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_root</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Welcome to this fantastic app!"</span><span class="p">}</span>
</code></pre></div>

<blockquote>
<p><a href="https://fastapi.tiangolo.com/tutorial/path-operation-configuration/#tags">标签</a>是用于对路线进行分组的标识符。具有相同标签的路线被分组到API文档的一个部分中。</p>
</blockquote>
<p>从控制台运行入口点文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ python app/main.py
</code></pre></div>

<p>在浏览器中导航至<a href="http://localhost:8000"> http://localhost:8000 </a>。您应该看到:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Welcome to this fantastic app!"</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>也可以在<a href="http://localhost:8000/docs">http://localhost:8000/docs</a>查看交互API文档:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs.png" loading="lazy" class="lazyload" alt="fastapi swagger ui" src="../Images/8b8b9e3b82a2de35a880cf835ef5b0a4.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs.png"/></p>
<h2 id="routes">路线</h2>
<p>我们将构建一个简单的应用程序，通过以下CRUD途径存储学生数据:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/routes.png" loading="lazy" class="lazyload" alt="crud routes" src="../Images/0623ce8567cc2fd4236bd11aa3b23360.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/routes.png"/></p>
<p>在我们开始编写路由之前，让我们首先定义相关的模式并配置MongoDB。</p>
<h2 id="schema">(计划或理论的)纲要</h2>
<p>让我们定义我们的数据将基于的<a href="https://pydantic-docs.helpmanual.io/usage/schema/">模式</a>，它将表示数据如何存储在MongoDB数据库中。</p>
<blockquote>
<p>Pydantic模式用于验证数据以及序列化(JSON -&gt; Python)和反序列化(Python -&gt; JSON)。换句话说，它不充当Mongo <a href="https://docs.mongodb.com/manual/core/schema-validation/">模式验证器</a>。</p>
</blockquote>
<p>在“app/server/models”文件夹中，创建一个名为<em> student.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span> <span class="nc">StudentSchema</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">course_of_study</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lt</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">gpa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"example"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"fullname"</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">,</span>
                <span class="s2">"email"</span><span class="p">:</span> <span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="402a242f2500386e2524356e2e27">[email protected]</a>"</span><span class="p">,</span>
                <span class="s2">"course_of_study"</span><span class="p">:</span> <span class="s2">"Water resources engineering"</span><span class="p">,</span>
                <span class="s2">"year"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">"gpa"</span><span class="p">:</span> <span class="s2">"3.0"</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">UpdateStudentModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmailStr</span><span class="p">]</span>
    <span class="n">course_of_study</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">gpa</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"example"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"fullname"</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">,</span>
                <span class="s2">"email"</span><span class="p">:</span> <span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d3b9b7bcb693">[email protected]</a>x.edu.ng"</span><span class="p">,</span>
                <span class="s2">"course_of_study"</span><span class="p">:</span> <span class="s2">"Water resources and environmental engineering"</span><span class="p">,</span>
                <span class="s2">"year"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s2">"gpa"</span><span class="p">:</span> <span class="s2">"4.0"</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>


<span class="k">def</span> <span class="nf">ResponseModel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"data"</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">],</span>
        <span class="s2">"code"</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">"message"</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">ErrorResponseModel</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"error"</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="s2">"code"</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
</code></pre></div>

<p>在上面的代码中，我们定义了一个名为<code>StudentSchema</code>的Pydantic <a href="https://pydantic-docs.helpmanual.io/usage/schema/">模式</a>，它表示学生数据将如何存储在MongoDB数据库中。</p>
<p>在Pydantic中，<a href="https://pydantic-docs.helpmanual.io/usage/models/#required-fields">省略号</a>，<code>...</code>表示某个字段是必填的。它可以被替换为<code>None</code>或默认值。在<code>StudentSchema</code>中，每个字段都有一个省略号，因为每个字段都很重要，如果没有设置值，程序就不能继续运行。</p>
<p>在<code>StudentSchema</code>的<code>gpa</code>和<code>year</code>字段中，我们添加了<a href="https://pydantic-docs.helpmanual.io/usage/schema/#field-customization">验证器</a> <code>gt</code>、<code>lt</code>和<code>le</code>:</p>
<ol>
<li><code>year</code>字段中的<code>gt</code>和<code>lt</code>保证传递的值大于<em> 0 </em>小于<em> 9 </em>。因此，诸如<em> 0 </em>、<em> 10 </em>、<em> 11 </em>的值将导致错误。</li>
<li><code>gpa</code>字段中的<code>le</code>验证器确保传递的值小于或等于<em> 4.0 </em>。</li>
</ol>
<p>这个模式将帮助用户以适当的形式向API发送HTTP请求——即，要发送的数据类型和发送方式。</p>
<blockquote>
<p>FastAPI使用Pyantic模式结合<a href="https://json-schema.org"> Json模式</a>自动记录数据模型。<a href="https://swagger.io/tools/swagger-ui/"> Swagger UI </a>然后从生成的数据模型中渲染数据。你可以在这里阅读更多关于FastAPI如何生成API文档<a href="https://fastapi.tiangolo.com/features/#automatic-docs">。</a></p>
</blockquote>
<p>由于我们使用了<code>EmailStr</code>，我们需要安装<a href="https://github.com/JoshData/python-email-validator">电子邮件验证器</a>。</p>
<p>将其添加到需求文件中:</p>


<p>安装:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>有了模式之后，让我们在为API编写路由之前设置MongoDB。</p>
<h2 id="mongodb">MongoDB</h2>
<p>在这一节中，我们将连接MongoDB并配置我们的应用程序与之通信。</p>
<blockquote>
<p>据<a href="https://en.wikipedia.org/wiki/MongoDB">维基百科</a>介绍，MongoDB是一个跨平台的面向文档的数据库程序。作为一个NoSQL数据库程序，MongoDB使用带有可选模式的类似JSON的文档。</p>
</blockquote>
<h3 id="mongodb-setup">MongoDB设置</h3>
<p>如果您的机器上没有安装MongoDB，请参考文档中的<a href="https://docs.mongodb.com/manual/installation/">安装</a>指南。安装完成后，继续按照指南运行<a href="https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod"> mongod </a>守护进程。一旦完成，您就可以通过使用<code>mongo</code> shell命令连接到实例来验证MongoDB已经启动并正在运行:</p>


<p>作为参考，本教程使用MongoDB社区版v5.0.6。</p>
<div class="codehilite"><pre><span/><code>$ mongo --version

MongoDB shell version v5.0.6

Build Info: <span class="o">{</span>
    <span class="s2">"version"</span>: <span class="s2">"5.0.6"</span>,
    <span class="s2">"gitVersion"</span>: <span class="s2">"212a8dbb47f07427dae194a9c75baec1d81d9259"</span>,
    <span class="s2">"modules"</span>: <span class="o">[]</span>,
    <span class="s2">"allocator"</span>: <span class="s2">"system"</span>,
    <span class="s2">"environment"</span>: <span class="o">{</span>
        <span class="s2">"distarch"</span>: <span class="s2">"x86_64"</span>,
        <span class="s2">"target_arch"</span>: <span class="s2">"x86_64"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="motor-setup">电机设置</h3>
<p>接下来，我们将配置异步MongoDB驱动程序<a href="https://motor.readthedocs.io/"> Motor </a>来与数据库交互。</p>
<p>首先将依赖项添加到需求文件中:</p>


<p>安装:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>回到应用程序，将数据库连接信息添加到<em> app/server/database.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">motor.motor_asyncio</span>

<span class="n">MONGO_DETAILS</span> <span class="o">=</span> <span class="s2">"mongodb://localhost:27017"</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">motor_asyncio</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">MONGO_DETAILS</span><span class="p">)</span>

<span class="n">database</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">students</span>

<span class="n">student_collection</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s2">"students_collection"</span><span class="p">)</span>
</code></pre></div>

<p>在上面的代码中，我们导入了Motor，定义了连接细节，并通过<a href="https://motor.readthedocs.io/en/stable/api-asyncio/asyncio_motor_client.html#motor.motor_asyncio.AsyncIOMotorClient"> AsyncIOMotorClient </a>创建了一个客户端。</p>
<p>然后我们引用了一个名为<code>students</code>的数据库和一个名为<code>students_collection</code>的集合(类似于关系数据库中的一个表)。因为这些只是引用而不是实际的I/O，所以也不需要<code>await</code>表达式。当进行第一次I/O操作时，如果数据库和集合尚不存在，则将创建它们。</p>
<p>接下来，创建一个快速助手函数，用于将数据库查询的结果解析成Python dict。</p>
<p>将此内容也添加到<em> database.py </em>文件中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">motor.motor_asyncio</span>

<span class="n">MONGO_DETAILS</span> <span class="o">=</span> <span class="s2">"mongodb://localhost:27017"</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">motor_asyncio</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">MONGO_DETAILS</span><span class="p">)</span>

<span class="n">database</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">students</span>

<span class="n">student_collection</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s2">"students_collection"</span><span class="p">)</span>


<span class="c1"># helpers</span>


<span class="k">def</span> <span class="nf">student_helper</span><span class="p">(</span><span class="n">student</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">student</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]),</span>
        <span class="s2">"fullname"</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s2">"fullname"</span><span class="p">],</span>
        <span class="s2">"email"</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s2">"email"</span><span class="p">],</span>
        <span class="s2">"course_of_study"</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s2">"course_of_study"</span><span class="p">],</span>
        <span class="s2">"year"</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s2">"year"</span><span class="p">],</span>
        <span class="s2">"GPA"</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s2">"gpa"</span><span class="p">],</span>
    <span class="p">}</span>
</code></pre></div>

<p>接下来，让我们编写CRUD数据库操作。</p>
<h3 id="database-crud-operations">数据库CRUD操作</h3>
<p>首先从<em> database.py </em>文件顶部的<a href="https://github.com/py-bson/bson"> bson </a>包中导入<code>ObjectId</code>方法:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
</code></pre></div>

<blockquote>
<p>bson作为电机的附属设备安装。</p>
</blockquote>
<p>接下来，为CRUD操作添加以下每个函数:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># Retrieve all students present in the database</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_students</span><span class="p">():</span>
    <span class="n">students</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">find</span><span class="p">():</span>
        <span class="n">students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">student_helper</span><span class="p">(</span><span class="n">student</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">students</span>


<span class="c1"># Add a new student into to the database</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_student</span><span class="p">(</span><span class="n">student_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">student_data</span><span class="p">)</span>
    <span class="n">new_student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">student</span><span class="o">.</span><span class="n">inserted_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">student_helper</span><span class="p">(</span><span class="n">new_student</span><span class="p">)</span>


<span class="c1"># Retrieve a student with a matching ID</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_student</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)})</span>
    <span class="k">if</span> <span class="n">student</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">student_helper</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>


<span class="c1"># Update a student with a matching ID</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_student</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="c1"># Return false if an empty request body is sent.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)})</span>
    <span class="k">if</span> <span class="n">student</span><span class="p">:</span>
        <span class="n">updated_student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)},</span> <span class="p">{</span><span class="s2">"$set"</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">updated_student</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># Delete a student from the database</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_student</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)})</span>
    <span class="k">if</span> <span class="n">student</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">student_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">"_id"</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="nb">id</span><span class="p">)})</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>在上面的代码中，我们定义了异步操作来通过motor创建、读取、更新和删除数据库中的学生数据。</p>
<p>在更新和删除操作中，在数据库中搜索学生以决定是否执行操作。返回值指导如何向用户发送响应，这将在下一节中讨论。</p>
<h2 id="crud-routes">CRUD路线</h2>
<p>在本节中，我们将添加路由来补充数据库文件中的数据库操作。</p>
<p>在“routes”文件夹中，创建一个名为<em> student.py </em>的新文件，并向其中添加以下内容:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Body</span>
<span class="kn">from</span> <span class="nn">fastapi.encoders</span> <span class="kn">import</span> <span class="n">jsonable_encoder</span>

<span class="kn">from</span> <span class="nn">app.server.database</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">add_student</span><span class="p">,</span>
    <span class="n">delete_student</span><span class="p">,</span>
    <span class="n">retrieve_student</span><span class="p">,</span>
    <span class="n">retrieve_students</span><span class="p">,</span>
    <span class="n">update_student</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">app.server.models.student</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ErrorResponseModel</span><span class="p">,</span>
    <span class="n">ResponseModel</span><span class="p">,</span>
    <span class="n">StudentSchema</span><span class="p">,</span>
    <span class="n">UpdateStudentModel</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
</code></pre></div>

<p>我们将使用FastAPI的<a href="https://fastapi.tiangolo.com/tutorial/encoder/"> JSON兼容编码器</a>将我们的模型转换成JSON兼容的格式。</p>
<p>接下来，在<em> app/server/app.py </em>中连线学生路线:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">app.server.routes.student</span> <span class="kn">import</span> <span class="n">router</span> <span class="k">as</span> <span class="n">StudentRouter</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">StudentRouter</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"Student"</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"/student"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"Root"</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_root</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Welcome to this fantastic app!"</span><span class="p">}</span>
</code></pre></div>

<h3 id="create">创造</h3>
<p>回到routes文件，添加以下用于创建新学生的处理程序:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">response_description</span><span class="o">=</span><span class="s2">"Student data added into the database"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_student_data</span><span class="p">(</span><span class="n">student</span><span class="p">:</span> <span class="n">StudentSchema</span> <span class="o">=</span> <span class="n">Body</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="n">jsonable_encoder</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
    <span class="n">new_student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">add_student</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span><span class="n">new_student</span><span class="p">,</span> <span class="s2">"Student added successfully."</span><span class="p">)</span>
</code></pre></div>

<p>因此，该路由期望一个匹配<code>StudentSchema</code>格式的有效载荷。示例:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"fullname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7218161d17320a5c1716075c1c15">[email protected]</a>"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"course_of_study"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Water resources engineering"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"year"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"gpa"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.0"</span><span class="p">,</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>启动Uvicorn服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ python app/main.py
</code></pre></div>

<p>并在<a href="http://localhost:8000/docs">http://localhost:8000/docs</a>刷新交互API文档页面查看新路由:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_create.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/595285c47d5d995cabb79c3b89ca11b4.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_create.png"/></p>
<p>也测试一下:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_create_test.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/27f1f95bd599e94817d95096c5067f13.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_create_test.png"/></p>
<p>因此，当一个请求被发送到端点时，在调用<code>add_student</code>数据库方法和将响应存储在<code>new_student</code>变量之前，它将JSON编码的请求体存储在变量<code>student</code>中。然后通过<code>ResponseModel</code>返回来自数据库的响应。</p>
<p>也测试一下验证器:</p>
<ol>
<li>年份必须大于0小于10</li>
<li>GPA必须小于或等于4.0</li>
</ol>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_create_test_fail.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/332ca45bebf9c0d59cace11b014d8785.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_create_test_fail.png"/></p>
<h3 id="read">阅读</h3>
<p>向右移动，添加以下路线来检索所有学生和单个学生:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">response_description</span><span class="o">=</span><span class="s2">"Students retrieved"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_students</span><span class="p">():</span>
    <span class="n">students</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retrieve_students</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">students</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="s2">"Students data retrieved successfully"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="s2">"Empty list returned"</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_description</span><span class="o">=</span><span class="s2">"Student data retrieved"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_student_data</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retrieve_student</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">student</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span><span class="n">student</span><span class="p">,</span> <span class="s2">"Student data retrieved successfully"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ErrorResponseModel</span><span class="p">(</span><span class="s2">"An error occurred."</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">"Student doesn't exist."</span><span class="p">)</span>
</code></pre></div>

<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_read.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/aed73117f594ea95c1ddd9d197db52a3.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_read.png"/></p>
<blockquote>
<p>如果您没有为id传递一个有效的ObjectId(例如，<code>1</code>)来检索单个学生路由，会发生什么情况？如何在应用程序中更好地处理这个问题？</p>
</blockquote>
<p>当实现删除操作时，您将有机会测试空数据库的响应。</p>
<h3 id="update">更新</h3>
<p>接下来，编写更新学生数据的单独路径:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_student_data</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">UpdateStudentModel</span> <span class="o">=</span> <span class="n">Body</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
    <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">updated_student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">update_student</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">updated_student</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span>
            <span class="s2">"Student with ID: </span><span class="si">{}</span><span class="s2"> name update is successful"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span>
            <span class="s2">"Student name updated successfully"</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">ErrorResponseModel</span><span class="p">(</span>
        <span class="s2">"An error occurred"</span><span class="p">,</span>
        <span class="mi">404</span><span class="p">,</span>
        <span class="s2">"There was an error updating the student data."</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>

<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_update.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/a0f5128b1471c52a62a59eeb53e2416d.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_update.png"/></p>
<h3 id="delete">删除</h3>
<p>最后，添加删除路径:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_description</span><span class="o">=</span><span class="s2">"Student data deleted from the database"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_student_data</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">deleted_student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">delete_student</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deleted_student</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ResponseModel</span><span class="p">(</span>
            <span class="s2">"Student with ID: </span><span class="si">{}</span><span class="s2"> removed"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="s2">"Student deleted successfully"</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">ErrorResponseModel</span><span class="p">(</span>
        <span class="s2">"An error occurred"</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">"Student with id </span><span class="si">{0}</span><span class="s2"> doesn't exist"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<p>检索您之前创建的用户的ID，并测试删除路由:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/api_docs_delete.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/c7ebc0e9f62df32fb6c252dad94af0b7.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/api_docs_delete.png"/></p>
<p>移除任何剩余的学生，并再次测试读取路线，确保响应适用于空数据库。</p>
<h2 id="deployment">部署</h2>
<p>在这一节中，我们将把应用程序部署到Heroku，并为MongoDB配置一个云数据库。</p>
<h3 id="mongodb-atlas">蒙戈布地图集</h3>
<p>在部署之前，我们需要设置<a href="https://www.mongodb.com/cloud/atlas"> MongoDB Atlas </a>，这是一个云数据库服务，用于MongoDB托管我们的数据库。</p>
<p>遵循<a href="https://docs.atlas.mongodb.com/getting-started/">入门</a>指南，您将创建一个帐户，部署一个免费层集群，设置一个用户，并将一个IP地址列入白名单。</p>
<blockquote>
<p>出于测试目的，将<code>0.0.0.0/0</code>用于白名单中的IP，以允许来自任何地方的访问。对于生产应用程序，您需要限制对静态IP的访问。</p>
</blockquote>
<p>完成后，通过单击“Connect”按钮从集群中获取数据库连接信息:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_1.png" loading="lazy" class="lazyload" alt="mongodb atlas" src="../Images/043b374d63cb1ccab6e54f2d584caab6.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_1.png"/></p>
<p>单击第二个选项“连接到您的应用程序”:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_2.png" loading="lazy" class="lazyload" alt="mongodb atlas" src="../Images/988b8f8d034cae48c64f9ae6413ccde6.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_2.png"/></p>
<p>复制连接URL，确保更新密码。将默认数据库也设置为“学生”。它将类似于:</p>
<div class="codehilite"><pre><span/><code><span class="n">mongodb</span><span class="o">+</span><span class="nl">srv</span><span class="p">:</span><span class="o">//</span><span class="nl">foobar</span><span class="p">:</span><span class="n">foobar</span><span class="nv">@cluster0</span><span class="mf">.0</span><span class="n">reol</span><span class="p">.</span><span class="n">mongodb</span><span class="p">.</span><span class="n">net</span><span class="o">/</span><span class="n">students</span><span class="vm">?</span><span class="n">retryWrites</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="n">w</span><span class="o">=</span><span class="n">majority</span><span class="w"/>
</code></pre></div>

<p>我们将定义它有一个环境变量，而不是在我们的应用程序中硬编码这个值。创建一个名为<em>的新文件。项目根中的env </em>以及到它的连接信息:</p>
<div class="codehilite"><pre><span/><code>MONGO_DETAILS=your_connection_url
</code></pre></div>

<blockquote>
<p>确保用复制的URL替换<code>your_connection_url</code>。</p>
</blockquote>
<p>接下来，为了简化应用程序中环境变量的管理，让我们安装<a href="https://github.com/henriquebastos/python-decouple/"> Python Decouple </a>包。将它添加到您的需求文件中，如下所示:</p>


<p>安装:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>在<em> app/server/database.py </em>文件中，导入库:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">decouple</span> <span class="kn">import</span> <span class="n">config</span>
</code></pre></div>

<p>导入的<code>config</code>方法在根目录中扫描一个<em>。env </em>文件并读取传递给它的内容。因此，在我们的例子中，它将读取<code>MONGO_DETAILS</code>变量。</p>
<p>接下来，将<code>MONGO_DETAILS</code>变量改为:</p>
<div class="codehilite"><pre><span/><code><span class="n">MONGO_DETAILS</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">"MONGO_DETAILS"</span><span class="p">)</span>  <span class="c1"># read environment variable</span>
</code></pre></div>

<h3 id="testing-locally">本地测试</h3>
<p>在部署之前，让我们使用云数据库在本地测试应用程序，以确保连接配置正确。重启您的Uvicorn服务器，并从位于<a href="http://localhost:8000/docs">http://localhost:8000/docs</a>的交互文档中测试每条路由。</p>
<p>您应该能够在Atlas仪表盘上看到数据:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_3.png" loading="lazy" class="lazyload" alt="mongodb atlas" src="../Images/04467e2161ebb5196cf5f53b37c13fe5.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-mongo/mongo_atlas_3.png"/></p>
<h3 id="deploying-to-heroku">部署到Heroku</h3>
<p>最后，让我们将应用程序部署到<a href="https://heroku.com"> Heroku </a>。</p>
<blockquote>
<p>Heroku是一个云平台即服务(PaaS ),用于部署和扩展应用程序。</p>
</blockquote>
<p>如有必要，<a href="https://signup.heroku.com/">注册</a>一个Heroku账号，安装<a href="https://devcenter.heroku.com/articles/heroku-cli"> Heroku CLI </a>。</p>
<p>在继续之前，创建一个<em>。gitignore项目中的</em>文件，防止签入“venv”文件夹和<em>。要git的env </em>文件:</p>


<p>添加以下内容:</p>


<p>接下来，将一个<em> Procfile </em>添加到您的项目的根目录:</p>
<div class="codehilite"><pre><span/><code><span class="n">web</span><span class="o">:</span><span class="w"> </span><span class="n">uvicorn</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">app</span><span class="o">:</span><span class="n">app</span><span class="w"> </span><span class="o">--</span><span class="n">host</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="w"> </span><span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="n">$PORT</span><span class="w"/>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>Procfile 是一个文本文件，放在项目的根目录下，指导Heroku如何运行你的应用程序。因为我们提供的是web应用程序，所以我们定义了流程类型<code>web</code>以及提供Uvicorn的命令。</li>
<li>Heroku为您的应用程序动态公开一个在部署时运行的端口，这是通过<code>$PORT</code>环境变量公开的。</li>
</ol>
<p>您的项目现在应该有以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>├── .env
├── .gitignore
├── Procfile
├── app
│   ├── __init__.py
│   ├── main.py
│   └── server
│       ├── app.py
│       ├── database.py
│       ├── models
│       │   └── student.py
│       └── routes
│           └── student.py
└── requirements.txt
</code></pre></div>

<p>在项目的根目录中，初始化一个新的git存储库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ git init
<span class="o">(</span>venv<span class="o">)</span>$ git add .
<span class="o">(</span>venv<span class="o">)</span>$ git commit -m <span class="s2">"My fastapi and mongo application"</span>
</code></pre></div>

<p>现在，我们可以<a href="https://devcenter.heroku.com/articles/git#for-a-new-heroku-app">在Heroku上创建</a>一个新应用程序:</p>


<p>除了创建一个新的应用程序，这个命令还会在Heroku上创建一个远程git存储库，以便我们将应用程序推送到该存储库进行部署。然后，它会自动在本地存储库上将其设置为远程。</p>
<blockquote>
<p>您可以通过运行<code>git remote -v</code>来验证遥控器是否已设置。</p>
</blockquote>
<p>记下应用程序的URL。</p>
<p>既然我们没有加上<em>。env </em>文件到git，我们需要在Heroku环境中设置环境变量:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ heroku config:set <span class="nv">MONGO_DETAILS</span><span class="o">=</span><span class="s2">"your_mongo_connection_url"</span>
</code></pre></div>

<blockquote>
<p>同样，确保用真实的连接URL替换<code>your_connection_url</code>。</p>
</blockquote>
<p>将您的代码推送到Heroku，并确保至少有一个应用程序实例正在运行:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ git push heroku master
<span class="o">(</span>venv<span class="o">)</span>$ heroku ps:scale <span class="nv">web</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p>运行<code>heroku open</code>在默认浏览器中打开你的应用。</p>
<p>您已经成功地将您的应用程序部署到Heroku。测试一下。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，您学习了如何使用FastAPI和MongoDB创建一个CRUD应用程序，并将其部署到Heroku。通过回顾本教程开头的目标，快速进行自我检查。你可以在<a href="https://github.com/Youngestdev/async-fastapi-mongo"> GitHub </a>上找到本教程使用的代码。</p>
<p>想要更多吗？</p>
<ol>
<li>用pytest设置单元和集成测试。</li>
<li>添加其他路线。</li>
<li>为您的应用程序创建一个GitHub repo，并使用GitHub操作配置CI/CD。</li>
<li>使用<a href="https://elements.heroku.com/addons/fixie-socks"> Fixie Socks </a>在Heroku上配置一个静态IP，并限制对MongoDB Atlas数据库的访问。</li>
<li>回顾一下<a href="/blog/fastapi-beanie/">用FastAPI、MongoDB和Beanie </a>构建CRUD应用教程，看看如何利用<a href="https://roman-right.github.io/beanie/"> Beanie ODM </a>，它在Motor上提供了一个额外的抽象层，使得与Mongo数据库中的集合进行交互变得更加容易。</li>
</ol>
<blockquote>
<p>查看<a href="/courses/tdd-fastapi/">测试驱动的FastAPI开发和Docker </a>课程，了解有关测试和设置FastAPI应用的CI/CD的更多信息。</p>
</blockquote>
<p>干杯！</p>
  </div>

  </div>    
</body>
</html>