<html>
<head>
<title>Securing a Containerized Django Application with Let's Encrypt </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用加密保护容器化的Django应用程序</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-lets-encrypt/#0001-01-01">https://testdriven.io/blog/django-lets-encrypt/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>如何为Django应用程序设置SSL证书？</p>
<p>在本教程中，我们将看看如何使用<a href="https://letsencrypt.org/">加密</a> SSL证书来保护运行在HTTPS Nginx代理后面的容器化Django应用程序。</p>
<p>本教程建立在用Postgres、Gunicorn和Nginx构建Django的基础上。它假设您了解如何将Django应用程序与Postgres、Nginx和Gunicorn一起容器化。</p>
<p>如今，你根本无法让你的应用程序运行在HTTP之上。没有HTTPS，你的网站就不那么安全和可信。“让我们加密”简化了获取和安装SSL证书的过程，再也没有理由不使用HTTPS了。</p>
<blockquote>
<p>姜戈码头系列:</p>
<ol>
<li><a href="/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/">用Postgres、Gunicorn和Nginx将Django归档</a></li>
<li><a href="/blog/django-lets-encrypt/">使用Let's Encrypt </a>(本文！)</li>
<li><a href="/blog/django-docker-https-aws/">用Docker将Django部署到AWS，让我们加密</a></li>
</ol>
</blockquote>



<h2 id="prerequisites">先决条件</h2>
<p>要学习本教程，您需要:</p>

<blockquote>
<p>需要一个便宜的域名来练习？几个域名注册商有特殊优惠。“xyz”域。或者，您可以在<a href="https://www.freenom.com/"> Freenom </a>创建一个免费域名。</p>
</blockquote>
<h2 id="approach">方法</h2>
<p>有许多不同的方法来保护HTTPS的容器化Django应用程序。可以说，最流行的方法是向Docker Compose文件添加一个新的服务，该服务利用<a href="https://certbot.eff.org/"> Certbot </a>来发布和更新SSL证书。虽然这是完全正确的，但我们将采用稍微不同的方法，并使用以下项目:</p>
<ol>
<li><a href="https://github.com/nginx-proxy/nginx-proxy"> nginx-proxy </a> -用于自动构建运行容器的nginx代理配置，其中每个容器都被视为单个虚拟主机</li>
<li>Let sencrypt-nginx-proxy-companion-用于为nginx-proxy代理的每个容器颁发和更新加密SSL证书</li>
</ol>
<p>总之，这些项目简化了Nginx配置和SSL证书的管理。</p>
<blockquote>
<p>另一种选择是使用<a href="https://traefik.io/"> Traefik </a>而不是Nginx。简而言之，Traefik使用Let's Encrypt来发布和更新证书。更多信息，请查看<a href="/blog/django-docker-traefik/">Dockerizing Django with Postgres、Gunicorn和Traefik </a>。</p>
</blockquote>
<h2 id="lets-encrypt">让我们加密</h2>
<p>首次部署应用程序时，您应该遵循以下两个步骤来避免证书问题:</p>
<ol>
<li>首先从Let's Encrypt的<a href="https://letsencrypt.org/docs/staging-environment/">登台环境</a>中颁发证书</li>
<li>然后，当一切按预期运行时，切换到Let's Encrypt的生产环境</li>
</ol>
<p>为什么？</p>
<p>为了保护他们的服务器，让我们对他们的生产验证系统实施<a href="https://letsencrypt.org/docs/rate-limits/">速率限制</a>:</p>
<ol>
<li>每个帐户、每个主机名每小时5次验证失败</li>
<li>每个域每周可以创建50个证书</li>
</ol>
<p>如果您在域名或DNS条目或任何类似的地方输入错误，您的请求将失败，这将计入您的费率限制，您将不得不尝试颁发新的证书。</p>
<p>为了避免速率受限，在开发和测试期间，您应该使用Let's Encrypt的登台环境来测试他们的验证系统。在分段环境中，速率限制要高得多，这对测试来说更好。请注意，暂存中颁发的证书并不公开可信，因此一旦一切正常，您应该切换到他们的生产环境。</p>
<h2 id="project-setup">项目设置</h2>
<p>首先，克隆GitHub项目报告的内容:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://github.com/testdrivenio/django-on-docker django-on-docker-letsencrypt
$ <span class="nb">cd</span> django-on-docker-letsencrypt
</code></pre></div>

<p>这个库包含了部署Dockerized Django应用程序所需的一切，但不包括SSL证书，我们将在本教程中添加SSL证书。</p>
<h2 id="django-configuration">Django配置</h2>
<p>首先，要在HTTPS代理后面运行Django应用程序，您需要将<a href="https://docs.djangoproject.com/en/3.2/ref/settings/#secure-proxy-ssl-header"> SECURE_PROXY_SSL_HEADER </a>设置添加到<em> settings.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">SECURE_PROXY_SSL_HEADER</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"HTTP_X_FORWARDED_PROTO"</span><span class="p">,</span> <span class="s2">"https"</span><span class="p">)</span>
</code></pre></div>

<p>在这个元组中，当<code>X-Forwarded-Proto</code>被设置为<code>https</code>时，请求是安全的。</p>
<h2 id="docker-compose">复合坞站</h2>
<p>是时候配置Docker Compose了。</p>
<p>让我们添加一个新的Docker Compose文件用于测试，名为<em>Docker-Compose . staging . yml</em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.staging</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.staging.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx-proxy</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-proxy</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443:443</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs:/etc/nginx/certs</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">html:/usr/share/nginx/html</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vhost:/etc/nginx/vhost.d</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/tmp/docker.sock:ro</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx-proxy-letsencrypt</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jrcs/letsencrypt-nginx-proxy-companion</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.staging.proxy-companion</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs:/etc/nginx/certs</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">html:/usr/share/nginx/html</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vhost:/etc/nginx/vhost.d</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme:/etc/acme.sh</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-proxy</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">media_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">html</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">vhost</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为<code>db</code>容器添加一个<em> .env.staging.db </em>文件:</p>
<div class="codehilite"><pre><span/><code>POSTGRES_USER=hello_django
POSTGRES_PASSWORD=hello_django
POSTGRES_DB=hello_django_prod
</code></pre></div>

<blockquote>
<p>更改<code>POSTGRES_USER</code>和<code>POSTGRES_PASSWORD</code>的值，以匹配您的用户和密码。</p>
</blockquote>
<p>我们已经在之前的<a href="https://testdriven.io/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/">教程</a>中看到了<code>web</code>和<code>db</code>服务，所以让我们深入研究一下<code>nginx-proxy</code>和<code>nginx-proxy-letsencrypt</code>服务。</p>
<blockquote>
<p>数据库是关键服务。增加额外的层，例如Docker，会增加生产中不必要的风险。为了简化小版本更新、定期备份和扩展等任务，建议使用托管服务，如<a href="https://aws.amazon.com/rds/"> AWS RDS </a>、<a href="https://cloud.google.com/sql"> Google Cloud SQL </a>或<a href="https://www.digitalocean.com/products/managed-databases/"> DigitalOcean托管数据库</a>。</p>
</blockquote>
<h2 id="nginx-proxy-service">Nginx代理服务</h2>
<p>对于这个服务，<a href="https://github.com/nginx-proxy/nginx-proxy"> nginx-proxy </a>项目用于为使用虚拟主机进行路由的<code>web</code>容器生成反向代理配置。</p>
<blockquote>
<p>请务必查看关于<a href="https://github.com/nginx-proxy/nginx-proxy"> nginx-proxy </a> repo的自述文件。</p>
</blockquote>
<p>一旦启动，与<code>nginx-proxy</code>相关联的容器自动检测设置了<code>VIRTUAL_HOST</code>环境变量的容器(在同一网络中),并动态更新其虚拟主机配置。</p>
<p>继续为<code>web</code>容器添加一个<em> .env.staging </em>文件:</p>
<div class="codehilite"><pre><span/><code>DEBUG=0
SECRET_KEY=change_me
DJANGO_ALLOWED_HOSTS=&lt;YOUR_DOMAIN.COM&gt;
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_prod
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres
VIRTUAL_HOST=&lt;YOUR_DOMAIN.COM&gt;
VIRTUAL_PORT=8000
LETSENCRYPT_HOST=&lt;YOUR_DOMAIN.COM&gt;
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>将<code>&lt;YOUR_DOMAIN.COM&gt;</code>更改为您的实际域，并将<code>SQL_USER</code>和<code>SQL_PASSWORD</code>的默认值更改为匹配<code>POSTGRES_USER</code>和<code>POSTGRES_PASSWORD</code>(来自<em> .env.staging.db </em>)。</li>
<li>如上所述，<code>nginx-proxy</code>需要<code>VIRTUAL_HOST</code>(和<code>VIRTUAL_PORT</code>)来自动创建反向代理配置。</li>
<li><code>LETSENCRYPT_HOST</code>有没有办法让<code>nginx-proxy-companion</code>为你的域名颁发加密证书。</li>
<li>由于Django应用程序将监听端口8000，我们还设置了<code>VIRTUAL_PORT</code>环境变量。</li>
<li><em>docker-compose . staging . yml</em>中的<code>/var/run/docker.sock:/tmp/docker.sock:ro</code>卷用于监听新注册/注销的容器。</li>
</ol>
<blockquote>
<p>出于测试/调试的目的，您可能希望在第一次部署时使用一个<code>*</code>来代替<code>DJANGO_ALLOWED_HOSTS</code>,以简化事情。只是不要忘记在测试完成后限制允许的主机。</p>
</blockquote>
<p>因此，对指定域的请求将由<a href="https://timothy-quinn.com/using-nginx-as-a-reverse-proxy-for-multiple-sites/">代理</a>到容器，该容器将域设置为<code>VIRTUAL_HOST</code>环境变量。</p>
<p>接下来，让我们更新“nginx”文件夹中的Nginx配置。</p>
<p>首先，添加名为“vhost.d”的目录。然后，在该目录中添加一个名为<em> default </em>的文件来提供静态和媒体文件:</p>
<div class="codehilite"><pre><span/><code>location /static/ {
  alias /home/app/web/staticfiles/;
  add_header Access-Control-Allow-Origin *;
}

location /media/ {
  alias /home/app/web/mediafiles/;
  add_header Access-Control-Allow-Origin *;
}
</code></pre></div>

<p>符合任何这些模式的请求将从静态或媒体文件夹中得到服务。它们不会被代理到其他容器。<code>web</code>和<code>nginx-proxy</code>容器共享静态和媒体文件所在的卷:</p>
<div class="codehilite"><pre><span/><code>static_volume:/home/app/web/staticfiles
media_volume:/home/app/web/mediafiles
</code></pre></div>

<p>将一个<em> custom.conf </em>文件添加到“nginx”文件夹中，以保存自定义代理范围的配置:</p>
<div class="codehilite"><pre><span/><code>client_max_body_size 10M;
</code></pre></div>

<p>更新<em> nginx/Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">jwilder/nginx-proxy:0.9</span>
<span class="k">COPY</span><span class="w"> </span>vhost.d/default /etc/nginx/vhost.d/default
<span class="k">COPY</span><span class="w"> </span>custom.conf /etc/nginx/conf.d/custom.conf
</code></pre></div>

<p>移除<em> nginx.conf </em>。</p>
<p>您的“nginx”目录现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>└── nginx
    ├── Dockerfile
    ├── custom.conf
    └── vhost.d
        └── default
</code></pre></div>

<h2 id="lets-encrypt-nginx-proxy-companion-service">让我们加密Nginx代理配套服务</h2>
<p>当<code>nginx-proxy</code>服务处理路由时，<code>nginx-proxy-letsencrypt</code>(通过<a href="https://github.com/nginx-proxy/docker-letsencrypt-nginx-proxy-companion">lets Encrypt-nginx-proxy-companion</a>)处理代理Docker容器的证书的创建、更新和使用。</p>
<p>要为代理容器颁发和更新证书，需要为每个容器添加<code>LETSENCRYPT_HOST</code>环境变量(我们已经完成了)。它还必须具有与<code>VIRTUAL_HOST</code>相同的值。</p>
<p>该容器必须与<code>nginx-proxy</code>共享以下卷:</p>
<ol>
<li><code>certs:/etc/nginx/certs</code>存储证书、私钥和ACME帐户密钥</li>
<li><code>html:/usr/share/nginx/html</code>写入<a href="https://tools.ietf.org/html/draft-ietf-acme-acme-03#section-7.2"> http-01 </a>挑战文件</li>
<li><code>vhost:/etc/nginx/vhost.d</code>更改虚拟主机的配置</li>
</ol>
<blockquote>
<p>有关更多信息，请查看官方文档。</p>
</blockquote>
<p>添加一个<em>. env . staging . proxy-companion</em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="n">DEFAULT_EMAIL</span><span class="o">=</span><span class="n">youremail</span><span class="nv">@yourdomain</span><span class="p">.</span><span class="n">com</span><span class="w"/>
<span class="n">ACME_CA_URI</span><span class="o">=</span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">acme</span><span class="o">-</span><span class="n">staging</span><span class="o">-</span><span class="n">v02</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">letsencrypt</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">directory</span><span class="w"/>
<span class="n">NGINX_PROXY_CONTAINER</span><span class="o">=</span><span class="n">nginx</span><span class="o">-</span><span class="n">proxy</span><span class="w"/>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li><code>DEFAULT_EMAIL</code>是我们将用来向您发送证书(包括续订)通知的电子邮件。</li>
<li><code>ACME_CA_URI</code>是用于颁发证书的URL。再次，使用阶段直到你100%确定一切正常。</li>
<li><code>NGINX_PROXY_CONTAINER</code>是<code>nginx-proxy</code>容器的名称。</li>
</ol>
<h2 id="running-the-containers">运行容器</h2>
<p>一切准备就绪，随时可以部署。</p>
<p>是时候转移到您的Linux实例了。</p>
<p>假设在您的实例上创建了一个项目目录，如<em>/home/my user/django-on-docker</em>，用SCP复制文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>$ scp -r <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/<span class="o">{</span>app,nginx,.env.staging,.env.staging.db,.env.staging.proxy-companion,docker-compose.staging.yml<span class="o">}</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="94e1e7f1e6d4edfbe1e6b9fde4b9fbe6b9f0fbf9f5fdfa">[email protected]</a>:/path/to/django-on-docker
</code></pre></div>

<p>通过SSH连接到您的实例，并移动到项目目录:</p>


<p>这时，您就可以构建映像并旋转容器了:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.staging.yml up -d --build
</code></pre></div>

<p>一旦容器启动并运行，在浏览器中导航到您的域。您应该会看到类似这样的内容:</p>
<p><img data-src="/static/images/blog/django/django-docker/privacy_error.png" loading="lazy" class="lazyload" alt="HTTPS certificate not secure" src="../Images/d83157ae320af80a164075c62af84cc2.png" data-original-src="https://testdriven.io/static/images/blog/django/django-docker/privacy_error.png"/></p>
<p>这是意料之中的。显示该屏幕是因为证书是从<a href="https://letsencrypt.org/docs/staging-environment/">暂存环境</a>中颁发的，该环境同样没有与生产环境相同的<a href="https://letsencrypt.org/docs/staging-environment/#rate-limits">速率限制</a>。它类似于一个<a href="https://en.wikipedia.org/wiki/Self-signed_certificate">自签名的HTTPS证书</a>。始终使用试运行环境，直到您确定一切都按预期运行。</p>
<p>你怎么知道一切是否正常？</p>
<p>点击“高级”,然后点击“继续”。您现在应该可以看到您的应用程序了。上传图像，然后确保您可以在<code>https://yourdomain.com/mediafiles/IMAGE_FILE_NAME</code>查看图像。</p>
<h2 id="issue-the-production-certificate">颁发生产证书</h2>
<p>现在，一切都按预期运行，我们可以切换到Let's Encrypt的生产环境。</p>
<p>关闭现有容器并退出实例:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.staging.yml down -v
$ <span class="nb">exit</span>
</code></pre></div>

<p>回到您的本地机器上，更新<em>docker-composite . product . yml</em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13.0-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx-proxy</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-proxy</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443:443</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/staticfiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/mediafiles</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs:/etc/nginx/certs</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">html:/usr/share/nginx/html</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vhost:/etc/nginx/vhost.d</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/tmp/docker.sock:ro</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx-proxy-letsencrypt</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jrcs/letsencrypt-nginx-proxy-companion</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.proxy-companion</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock:ro</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certs:/etc/nginx/certs</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">html:/usr/share/nginx/html</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vhost:/etc/nginx/vhost.d</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme:/etc/acme.sh</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-proxy</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">media_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">html</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">vhost</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>与<em>docker-compose . staging . yml</em>相比，这里唯一的区别是我们使用了不同的环境文件。</p>
<p><em> .env.prod </em>:</p>
<div class="codehilite"><pre><span/><code>DEBUG=0
SECRET_KEY=change_me
DJANGO_ALLOWED_HOSTS=&lt;YOUR_DOMAIN.COM&gt;
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_prod
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres
VIRTUAL_HOST=&lt;YOUR_DOMAIN.COM&gt;
VIRTUAL_PORT=8000
LETSENCRYPT_HOST=&lt;YOUR_DOMAIN.COM&gt;
</code></pre></div>

<p><em> .env.prod.db </em>:</p>
<div class="codehilite"><pre><span/><code>POSTGRES_USER=hello_django
POSTGRES_PASSWORD=hello_django
POSTGRES_DB=hello_django_prod
</code></pre></div>

<p><em>. env . prod . proxy-companion</em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">DEFAULT_EMAIL</span><span class="o">=</span><span class="n">youremail</span><span class="nv">@yourdomain</span><span class="p">.</span><span class="n">co</span><span class="w"/>
<span class="n">NGINX_PROXY_CONTAINER</span><span class="o">=</span><span class="n">nginx</span><span class="o">-</span><span class="n">proxy</span><span class="w"/>
</code></pre></div>

<p>适当地更新它们。</p>
<p>你发现了不同版本的区别了吗？没有设置<code>ACME_CA_URI</code>环境变量，因为默认情况下<code>letsencrypt-nginx-proxy-companion</code>映像使用Let's Encrypt的生产环境。</p>
<p>使用SCP将新文件和文件夹复制到您的实例中:</p>
<div class="codehilite"><pre><span/><code>$ scp <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/<span class="o">{</span>.env.prod,.env.prod.db,.env.prod.proxy-companion,docker-compose.prod.yml<span class="o">}</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="097c7a6c7b4970667c7b24607924667b246d6664686067">[email protected]</a>:/path/to/django-on-docker
</code></pre></div>

<p>像前面一样，通过SSH连接到您的实例，并移动到项目目录:</p>


<p>构建图像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>再次导航到您的域。您应该不会再看到警告。</p>
<p>恭喜你。您现在使用的是生产加密证书。</p>
<blockquote>
<p>想要查看证书创建过程的运行情况，请查看日志:</p><div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml logs nginx-proxy-letsencrypt
</code></pre></div>
</blockquote>

<h2 id="conclusion">结论</h2>
<p>总之，一旦您将Docker Compose配置为运行Django，要设置HTTPS，您需要在Docker Compose文件中添加(并配置)服务<code>nginx-proxy</code>和<code>nginx-proxy-letsencrypt</code>。现在，您可以通过配置<code>VIRTUAL_HOST</code>(路由)和<code>LETSENCRYPT_HOST</code>(证书)环境变量来添加更多的容器。和往常一样，一定要先用Let's Encrypt的登台环境进行测试。</p>
<p>你可以在django-on-docker-letsencryptrepo中找到代码。</p>
<blockquote>
<p>姜戈码头系列:</p>
<ol>
<li><a href="/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/">用Postgres、Gunicorn和Nginx将Django归档</a></li>
<li><a href="/blog/django-lets-encrypt/">使用Let's Encrypt </a>(本文！)</li>
<li><a href="/blog/django-docker-https-aws/">用Docker将Django部署到AWS，让我们加密</a></li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>