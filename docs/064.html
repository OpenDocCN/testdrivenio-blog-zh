<html>
<head>
<title>Python Code Quality </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Python代码质量</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/python-code-quality/#0001-01-01">https://testdriven.io/blog/python-code-quality/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p><em>到底什么是代码质量？我们如何衡量它？我们如何提高代码质量，清理我们的Python代码？</em></p>
<p><br/></p>
<p><a href="https://en.wikipedia.org/wiki/Software_quality">代码质量</a>一般指你的代码功能性和可维护性如何。在以下情况下，代码被视为高质量:</p>
<ol>
<li>这符合它的目的</li>
<li>它的行为是可以测试的</li>
<li>它遵循一贯的风格</li>
<li>可以理解</li>
<li>它不包含安全漏洞</li>
<li>这是有据可查的</li>
<li>很容易维护</li>
</ol>
<p>因为我们已经在Python中的<a href="/blog/testing-python/">测试</a>和Python中的<a href="/blog/modern-tdd/">现代测试驱动开发</a>文章中解决了前两点，所以本文的重点是第三至第七点。</p>
<p>本文探讨了如何使用linters、代码格式化器和安全漏洞扫描器来提高Python代码的质量。</p>
<p><br/></p>
<blockquote>
<p><a href="/guides/complete-python/">完整Python </a>指南:</p>
<ol>
<li><a href="/blog/python-environments/">现代Python环境——依赖性和工作空间管理</a></li>
<li><a href="/blog/testing-python/">Python中的测试</a></li>
<li><a href="/blog/modern-tdd/">Python中的现代测试驱动开发</a></li>
<li><a href="/blog/python-code-quality/"> Python代码质量</a>(本文！)</li>
<li><a href="/blog/python-type-checking/"> Python类型检查</a></li>
<li><a href="/blog/documenting-python/">记录Python代码和项目</a></li>
<li><a href="/blog/python-project-workflow/"> Python项目工作流程</a></li>
</ol>
</blockquote>



<h2 id="linters">棉短绒</h2>
<p><a href="https://en.wikipedia.org/wiki/Lint_(software)"> Linters </a>通过源代码分析标记编程错误、bug、风格错误和可疑结构。林挺工具易于设置，提供合理的默认值，并通过消除对风格有不同意见的开发人员之间的摩擦来改善整体开发体验。</p>
<blockquote>
<p>虽然林挺是一种常见的实践，但它仍然被许多开发人员所不喜欢，因为开发人员往往非常固执己见。</p>
</blockquote>
<p>让我们看一个简单的例子。</p>
<p>版本一:</p>
<div class="codehilite"><pre><span/><code><span class="n">numbers</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'Enter a number: '</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">!=</span> <span class="s1">'quit'</span><span class="p">:</span>
        <span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Numbers: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">numbers</span><span class="p">)</span>
</code></pre></div>

<p>版本二:</p>
<div class="codehilite"><pre><span/><code><span class="n">numbers</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">while</span> <span class="p">(</span><span class="n">answer</span> <span class="o">:=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Enter a number: "</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">"quit"</span><span class="p">:</span>
    <span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Numbers: </span><span class="si">{</span><span class="n">numbers</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>

<p>版本三:</p>
<div class="codehilite"><pre><span/><code><span class="n">numbers</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Enter a number: "</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s2">"quit"</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Numbers: </span><span class="si">{</span><span class="n">numbers</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>

<p>哪个更好？</p>
<p>就功能而言，它们是相同的。</p>
<p>你喜欢哪一个？你的项目合作者更喜欢哪一个？</p>
<p>作为一名软件开发人员，你很可能在团队中工作。而且，在团队环境中，所有开发人员遵循相同的编码标准是非常重要的。不然看别人的代码就难多了。代码审查的重点应该是更高层次的问题，而不是普通的语法格式问题。</p>
<p>例如，如果你决定用感叹号结束每一句话，读者将很难推断出语气。如果你更进一步，忽略像大写和间距规则这样的通用标准，你的句子将很难阅读。阅读你的作品需要更多的脑力。你会失去读者和合作者。代码也类似。我们使用风格指南使我们的开发伙伴(包括我们自己)更容易推断意图并与我们合作。</p>
<p>作为Python开发人员，我们很幸运能够拥有<a href="https://pep8.org/"> PEP-8 </a>风格指南，它提供了一组约定、指南和最佳实践，使我们的代码更容易阅读和维护。它主要关注命名约定、代码注释和布局问题(比如缩进和空白)。几个例子:</p>

<p>就林挺工具而言，虽然有很多这样的工具，但大部分都是在代码逻辑或强制代码标准中寻找错误:</p>
<ol>
<li><strong>代码逻辑</strong>——这些检查编程错误，强制执行代码标准，搜索代码气味，并检查代码复杂性。<a href="https://github.com/PyCQA/pyflakes"> Pyflakes </a>和<a href="https://github.com/PyCQA/mccabe"> McCabe </a>(复杂度检查器)是林挺代码逻辑最流行的工具。</li>
<li><strong>代码风格</strong>——这些只是执行代码标准(基于PEP-8)。<a href="https://github.com/pycqa/pycodestyle"> pycodestyle </a>就属于这一类。</li>
</ol>
<h3 id="flake8">薄片8</h3>
<p><a href="https://flake8.pycqa.org/"> Flake8 </a>是Pyflakes、pycodestyle和McCabe的包装器。</p>
<p>它可以像任何其他PyPI包一样安装:</p>


<p>假设您将以下代码保存到一个名为<em> my_module.py </em>的文件中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">get_error_message</span><span class="p">(</span><span class="n">error_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'red'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'orange'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'yellow'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'blue'</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">'https://api.github.com/events'</span><span class="p">)</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">STATUS</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_error_message</span><span class="p">(</span><span class="n">STATUS</span><span class="p">))</span>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>要lint这个文件，您只需运行:</p>
<div class="codehilite"><pre><span/><code>$ python -m flake8 my_module.py
</code></pre></div>

<p>这将产生以下输出:</p>
<div class="codehilite"><pre><span/><code>my_module.py:1:1: F403 <span class="s1">'from requests import *'</span> used<span class="p">;</span> unable to detect undefined names
my_module.py:3:1: E302 expected <span class="m">2</span> blank lines, found <span class="m">1</span>
my_module.py:15:11: F405 <span class="s1">'get'</span> may be undefined, or defined from star imports: requests
my_module.py:25:1: E303 too many blank lines <span class="o">(</span><span class="m">4</span><span class="o">)</span>
</code></pre></div>

<blockquote>
<p>根据代码编辑器的配置，您可能还会看到一个<code>my_module.py:26:11: W292 no newline at end of file</code>错误。</p>
</blockquote>
<p>对于每个违规，都会打印一行，其中包含以下数据:</p>
<ol>
<li>文件路径(相对于运行Flake8的目录)</li>
<li>行数</li>
<li>列号</li>
<li>违反的<a href="https://www.flake8rules.com/">规则的ID</a></li>
<li>规则描述</li>
</ol>
<p>以<code>F</code>开头的违例是来自<a href="https://flake8.pycqa.org/en/latest/user/error-codes.html"> Pyflakes </a>的错误，而以<code>E</code>开头的违例来自<a href="https://pycodestyle.pycqa.org/en/latest/intro.html#error-codes"> pycodestyle </a>。</p>
<p>纠正违规后，您应该:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">get</span>


<span class="k">def</span> <span class="nf">get_error_message</span><span class="p">(</span><span class="n">error_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'red'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'orange'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'yellow'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'blue'</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">'https://api.github.com/events'</span><span class="p">)</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">STATUS</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_error_message</span><span class="p">(</span><span class="n">STATUS</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>除了PyFlakes和pycodestyle，您还可以使用Flake8来检查<a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">圈复杂度</a>。</p>
<p>例如，<code>get_error_message</code>函数的复杂度为4，因为有四个可能的分支(或代码路径):</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">get_error_message</span><span class="p">(</span><span class="n">error_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'red'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'orange'</span>
    <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'yellow'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">'blue'</span>
</code></pre></div>

<p>要强制最大复杂性为3或更低，请运行:</p>
<div class="codehilite"><pre><span/><code>$ python -m flake8 --max-complexity <span class="m">3</span> my_module.py
</code></pre></div>

<p>Flake8应失败，出现以下情况:</p>
<div class="codehilite"><pre><span/><code>my_module.py:4:1: C901 <span class="s1">'get_error_message'</span> is too complex <span class="o">(</span><span class="m">4</span><span class="o">)</span>
</code></pre></div>

<p>像这样重构代码:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">get_error_message</span><span class="p">(</span><span class="n">error_type</span><span class="p">):</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">404</span><span class="p">:</span> <span class="s1">'red'</span><span class="p">,</span>
        <span class="mi">403</span><span class="p">:</span> <span class="s1">'orange'</span><span class="p">,</span>
        <span class="mi">401</span><span class="p">:</span> <span class="s1">'yellow'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">colors</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="n">colors</span> <span class="k">else</span> <span class="s1">'blue'</span>
</code></pre></div>

<p>薄片8现在应该通过:</p>
<div class="codehilite"><pre><span/><code>$ python -m flake8 --max-complexity <span class="m">3</span> my_module.py
</code></pre></div>

<p>你可以通过它强大的插件系统给Flake8添加额外的检查。例如，为了实施PEP-8命名约定，安装<a href="https://github.com/PyCQA/pep8-naming"> pep8-naming </a>:</p>
<div class="codehilite"><pre><span/><code>$ pip install pep8-naming
</code></pre></div>

<p>运行:</p>
<div class="codehilite"><pre><span/><code>$ python -m flake8 my_module.py
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code>my_module.py:15:6: N806 variable <span class="s1">'STATUS'</span> <span class="k">in</span> <span class="k">function</span> should be lowercase
</code></pre></div>

<p>修复:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">'https://api.github.com/events'</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_error_message</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</code></pre></div>

<p>查看<a href="https://github.com/DmytroLitvinov/awesome-flake8-extensions">牛逼的Flake8扩展</a>获得最受欢迎的扩展列表。</p>
<blockquote>
<p>Pylama 也是一种流行的林挺工具，像Flake8一样，它可以将几块棉绒粘合在一起。</p>
</blockquote>
<h2 id="code-formatters">代码格式化程序</h2>
<p>虽然linters只是检查代码中的问题，但代码格式化程序实际上是基于一组标准来重新格式化代码的。</p>
<p>让你的代码保持正确的格式是一项必要而枯燥的工作，应该由计算机来完成。</p>
<p>为什么有必要？</p>
<p>遵循一致性风格指南的格式良好的代码更容易阅读，这使得找到bug和新开发人员更容易。它还减少了合并冲突。</p>
<blockquote>
<p>可读性很重要。</p>
<p>–Python的<a href="https://en.wikipedia.org/wiki/Zen_of_Python">禅</a></p>
</blockquote>
<p>同样，因为这是一项枯燥的工作，开发人员常常固执己见(制表符对空格，单引号对双引号，等等)。)，使用代码格式化工具根据一组标准自动重新格式化您的代码。</p>
<h3 id="isort">伊索特</h3>
<p><a href="https://pycqa.github.io/isort/"> isort </a>用于自动将代码中的导入分成以下几组:</p>
<ol>
<li>标准程序库</li>
<li>第三方的</li>
<li>当地的</li>
</ol>
<p>然后，成组的导入按字母顺序逐个排列。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># standard library</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># third-party</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">AppGroup</span>

<span class="c1"># local</span>
<span class="kn">from</span> <span class="nn">your_module</span> <span class="kn">import</span> <span class="n">some_method</span>
</code></pre></div>

<p>安装:</p>


<blockquote>
<p>如果你更喜欢Flake8插件，请查看<a href="https://github.com/gforcada/flake8-isort"> flake8-isort </a>。<a href="https://github.com/PyCQA/flake8-import-order">薄片8-进口订单</a>也很受欢迎。</p>
</blockquote>
<p>对当前目录和子目录中的文件运行它:</p>


<p>要对单个文件运行它:</p>
<div class="codehilite"><pre><span/><code>$ python -m isort my_module.py
</code></pre></div>

<p>之前:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">your_module</span> <span class="kn">import</span> <span class="n">some_method</span>
<span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">AppGroup</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</code></pre></div>

<p>之后:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">AppGroup</span>

<span class="kn">from</span> <span class="nn">your_module</span> <span class="kn">import</span> <span class="n">some_method</span>
</code></pre></div>

<p>要检查您的导入是否正确排序，并且不做任何更改，请使用<code>--check-only</code>标志:</p>
<div class="codehilite"><pre><span/><code>$ python -m isort my_module.py --check-only

ERROR: my_module.py Imports are incorrectly sorted and/or formatted.
</code></pre></div>

<p>要查看更改，而不应用更改，请使用<code>--diff</code>标志:</p>
<div class="codehilite"><pre><span/><code>$ python -m isort my_module.py --diff

--- my_module.py:before      <span class="m">2022</span>-02-28 <span class="m">22</span>:04:45.977272
+++ my_module.py:after       <span class="m">2022</span>-02-28 <span class="m">22</span>:04:48.254686
@@ -1,6 +1,7 @@
+import datetime
 import os
-import datetime
+
+import requests
+from flask import Flask
+from flask.cli import AppGroup
 from your_module import some_method
-from flask.cli import AppGroup
-import requests
-from flask import Flask
</code></pre></div>

<p>使用isort和Black时，您应该使用<code>--profile black</code> <a href="https://pycqa.github.io/isort/docs/configuration/black_compatibility.html">选项</a>,以避免代码风格冲突:</p>
<div class="codehilite"><pre><span/><code>$ python -m isort --profile black .
</code></pre></div>

<h3 id="black">黑色</h3>
<p><a href="https://github.com/psf/black"> Black </a>是一个Python代码格式化程序，用于根据Black的<a href="https://black.readthedocs.io/en/stable/the_black_code_style/current_style.html">代码风格指南</a>重新格式化你的代码，它非常接近PEP-8。</p>


<blockquote>
<p>更喜欢Flake8插件？检查一下<a href="https://github.com/peterjc/flake8-black"> flake8-black </a>。</p>
</blockquote>
<p>要递归编辑当前目录中的文件:</p>


<p>它也可以针对单个文件运行:</p>
<div class="codehilite"><pre><span/><code>$ python -m black my_module.py
</code></pre></div>

<p>之前:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authenticated_client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8febfae2e2f6cfeae2eee6e3a1eee6">[email protected]</a>"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">"notreal"</span><span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>

<p>之后:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authenticated_client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">"/login"</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5f3b2a3232261f3a323e3633713e36">[email protected]</a>"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">"notreal"</span><span class="p">),</span>
        <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>

<p>如果您只想检查您的代码是否遵循Black code风格标准，您可以使用<code>--check</code>标志:</p>
<div class="codehilite"><pre><span/><code>$ python -m black my_module.py --check

would reformat my_module.py
Oh no! 💥 💔 💥
<span class="m">1</span> file would be reformatted.
</code></pre></div>

<p>与此同时,<code>--diff</code>标志显示了当前代码和重新格式化后的代码之间的差异:</p>
<div class="codehilite"><pre><span/><code>$ python -m black my_module.py --diff

--- my_module.py        <span class="m">2022</span>-02-28 <span class="m">22</span>:04:45.977272 +0000
+++ my_module.py        <span class="m">2022</span>-02-28 <span class="m">22</span>:05:15.124565 +0000
@@ -1,7 +1,12 @@
 import pytest
+

 @pytest.fixture<span class="o">(</span><span class="nv">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="o">)</span>
 def authenticated_client<span class="o">(</span>app<span class="o">)</span>:
     <span class="nv">client</span> <span class="o">=</span> app.test_client<span class="o">()</span>
-    client.post<span class="o">(</span><span class="s2">"/login"</span>, <span class="nv">data</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9ffbeaf2f2e6dffaf2fef6f3b1fef6">[email protected]</a>"</span>, <span class="nv">password</span><span class="o">=</span><span class="s2">"notreal"</span><span class="o">)</span>, <span class="nv">follow_redirects</span><span class="o">=</span>True<span class="o">)</span>
-    <span class="k">return</span> client
<span class="se">\ </span>No newline at end of file
+    client.post<span class="o">(</span>
+        <span class="s2">"/login"</span>,
+        <span class="nv">data</span><span class="o">=</span>dict<span class="o">(</span><span class="nv">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5f3b2a3232261f3a323e3633713e36">[email protected]</a>"</span>, <span class="nv">password</span><span class="o">=</span><span class="s2">"notreal"</span><span class="o">)</span>,
+        <span class="nv">follow_redirects</span><span class="o">=</span>True,
+    <span class="o">)</span>
+    <span class="k">return</span> client
would reformat my_module.py

All <span class="k">done</span>! ✨ 🍰 ✨
<span class="m">1</span> file would be reformatted.
</code></pre></div>

<blockquote>
<p><a href="https://github.com/google/yapf"> YAPF </a>和<a href="https://github.com/hhatto/autopep8"> autopep8 </a>是类似于Black的代码格式化程序，也值得一看。</p>
</blockquote>
<h2 id="security-vulnerability-scanners">安全漏洞扫描器</h2>
<p>安全漏洞可以说是代码质量最重要的方面，然而它们经常被忽视。您的代码的安全性取决于它最薄弱的环节。幸运的是，有许多工具可以帮助检测我们代码中可能的漏洞。让我们来看看其中的两个。</p>
<h3 id="bandit">强盗</h3>
<p><a href="https://github.com/PyCQA/bandit"> Bandit </a>是一款旨在发现Python代码中常见安全<a href="https://bandit.readthedocs.io/en/latest/plugins/index.html#complete-test-plugin-listing">问题</a>的工具，比如硬编码的密码字符串、反序列化不可信代码、在except块中使用<code>pass</code>等等。</p>


<blockquote>
<p>更喜欢Flake8插件？检查一下<a href="https://github.com/tylerwince/flake8-bandit"> flake8-bandit </a>。</p>
</blockquote>
<p>像这样运行它:</p>


<p>代码:</p>
<div class="codehilite"><pre><span/><code><span class="n">evaluate</span> <span class="o">=</span> <span class="s1">'print("Hi!")'</span>
<span class="nb">eval</span><span class="p">(</span><span class="n">evaluate</span><span class="p">)</span>


<span class="n">evaluate</span> <span class="o">=</span> <span class="s1">'open("secret_file.txt").read()'</span>
<span class="nb">eval</span><span class="p">(</span><span class="n">evaluate</span><span class="p">)</span>
</code></pre></div>

<p>您应该会看到以下警告:</p>
<div class="codehilite"><pre><span/><code>&gt;&gt; Issue: <span class="o">[</span>B307:blacklist<span class="o">]</span> Use of possibly insecure <span class="k">function</span> - consider using safer
    ast.literal_eval.
   Severity: Medium   Confidence: High
   Location: my_module.py:2
   More Info:
    https://bandit.readthedocs.io/en/latest/blacklists/blacklist_calls.html#b307-eval
<span class="m">1</span>   <span class="nv">evaluate</span> <span class="o">=</span> <span class="s1">'print("Hi!")'</span>
<span class="m">2</span>   eval<span class="o">(</span>evaluate<span class="o">)</span>
<span class="m">3</span>

--------------------------------------------------
&gt;&gt; Issue: <span class="o">[</span>B307:blacklist<span class="o">]</span> Use of possibly insecure <span class="k">function</span> - consider using safer
    ast.literal_eval.
   Severity: Medium   Confidence: High
   Location: my_module.py:6
   More Info:
    https://bandit.readthedocs.io/en/latest/blacklists/blacklist_calls.html#b307-eval
<span class="m">5</span>   <span class="nv">evaluate</span> <span class="o">=</span> <span class="s1">'open("secret_file.txt").read()'</span>
<span class="m">6</span>   eval<span class="o">(</span>evaluate<span class="o">)</span>

--------------------------------------------------
</code></pre></div>

<h3 id="safety">安全</h3>
<p>安全是另一个让你的代码免于安全问题的工具。</p>
<p>它用于对照<a href="https://github.com/pyupio/safety-db">安全数据库</a>检查您已安装的依赖项中已知的安全漏洞，安全数据库是Python包中已知安全漏洞的数据库。</p>


<p>激活虚拟环境后，您可以像这样运行它:</p>


<p>安装烧瓶v0.12.2时的样品输出:</p>
<div class="codehilite"><pre><span/><code>+<span class="o">==============================================================================</span>+
<span class="p">|</span>                                                                              <span class="p">|</span>
<span class="p">|</span>                               /<span class="nv">$$$$$$</span>            /<span class="nv">$$</span>                         <span class="p">|</span>
<span class="p">|</span>                              /<span class="nv">$$</span>__  <span class="nv">$$</span>          <span class="p">|</span> <span class="nv">$$</span>                         <span class="p">|</span>
<span class="p">|</span>           /<span class="nv">$$$$$$</span>$  /<span class="nv">$$$$$$</span> <span class="p">|</span> <span class="nv">$$</span>  <span class="se">\_</span>_//<span class="nv">$$$$$$</span>  /<span class="nv">$$$$$$</span>   /<span class="nv">$$</span>   /<span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>          /<span class="nv">$$</span>_____/ <span class="p">|</span>____  <span class="nv">$$</span><span class="p">|</span> <span class="nv">$$$$</span>   /<span class="nv">$$</span>__  <span class="nv">$$</span><span class="p">|</span>_  <span class="nv">$$</span>_/  <span class="p">|</span> <span class="nv">$$</span>  <span class="p">|</span> <span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>         <span class="p">|</span>  <span class="nv">$$$$$$</span>   /<span class="nv">$$$$$$</span>$<span class="p">|</span> <span class="nv">$$</span>_/  <span class="p">|</span> <span class="nv">$$$$$$$$</span>  <span class="p">|</span> <span class="nv">$$</span>    <span class="p">|</span> <span class="nv">$$</span>  <span class="p">|</span> <span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>          <span class="se">\_</span>___  <span class="nv">$$</span> /<span class="nv">$$</span>__  <span class="nv">$$</span><span class="p">|</span> <span class="nv">$$</span>    <span class="p">|</span> <span class="nv">$$</span>_____/  <span class="p">|</span> <span class="nv">$$</span> /<span class="nv">$$</span><span class="p">|</span> <span class="nv">$$</span>  <span class="p">|</span> <span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>          /<span class="nv">$$$$$$</span>$/<span class="p">|</span>  <span class="nv">$$$$$$</span>$<span class="p">|</span> <span class="nv">$$</span>    <span class="p">|</span>  <span class="nv">$$$$$$</span>$  <span class="p">|</span>  <span class="nv">$$$$</span>/<span class="p">|</span>  <span class="nv">$$$$$$</span>$           <span class="p">|</span>
<span class="p">|</span>         <span class="p">|</span>_______/  <span class="se">\_</span>______/<span class="p">|</span>__/     <span class="se">\_</span>______/   <span class="se">\_</span>__/   <span class="se">\_</span>___  <span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>                                                          /<span class="nv">$$</span>  <span class="p">|</span> <span class="nv">$$</span>           <span class="p">|</span>
<span class="p">|</span>                                                         <span class="p">|</span>  <span class="nv">$$$$$$</span>/           <span class="p">|</span>
<span class="p">|</span>  by pyup.io                                              <span class="se">\_</span>_____/            <span class="p">|</span>
<span class="p">|</span>                                                                              <span class="p">|</span>
+<span class="o">==============================================================================</span>+
<span class="p">|</span> REPORT                                                                       <span class="p">|</span>
<span class="p">|</span> checked <span class="m">37</span> packages, using default DB                                        <span class="p">|</span>
+<span class="o">============================</span>+<span class="o">===========</span>+<span class="o">==========================</span>+<span class="o">==========</span>+
<span class="p">|</span> package                    <span class="p">|</span> installed <span class="p">|</span> affected                 <span class="p">|</span> ID       <span class="p">|</span>
+<span class="o">============================</span>+<span class="o">===========</span>+<span class="o">==========================</span>+<span class="o">==========</span>+
<span class="p">|</span> flask                      <span class="p">|</span> <span class="m">0</span>.12.2    <span class="p">|</span> &lt;<span class="m">0</span>.12.3                  <span class="p">|</span> <span class="m">36388</span>    <span class="p">|</span>
<span class="p">|</span> flask                      <span class="p">|</span> <span class="m">0</span>.12.2    <span class="p">|</span> &lt;<span class="m">1</span>.0                     <span class="p">|</span> <span class="m">38654</span>    <span class="p">|</span>
+<span class="o">==============================================================================</span>+
</code></pre></div>


<p>现在你已经知道了工具，下一个问题是:什么时候应该使用它们？</p>
<p>通常，这些工具会运行:</p>
<ol>
<li>编码时(在ide或代码编辑器中)</li>
<li>提交时(使用预提交挂钩)</li>
<li>当代码签入源代码管理时(通过CI管道)</li>
</ol>
<h3 id="inside-your-ide-or-code-editor">在您的ide或代码编辑器中</h3>
<p>最好尽早并经常检查可能对质量有负面影响的问题。因此，强烈建议在开发过程中对代码进行lint和格式化。许多流行的ide都内置了linters和formatters。你可以为你的代码编辑器找到一个插件，用于上面提到的大多数工具。此类插件会实时警告您代码风格违规和潜在的编程错误。</p>
<p>资源:</p>
<ol>
<li><a href="https://code.visualstudio.com/docs/python/linting">林挺</a>和<a href="https://code.visualstudio.com/docs/python/editing#_formatting">在Visual Studio代码中格式化</a> Python</li>
<li><a href="https://black.readthedocs.io/en/stable/integrations/editors.html">黑色编辑器集成</a></li>
<li><a href="https://packagecontrol.io/">崇高文字包查找器</a></li>
<li><a href="https://atom.io/packages"> Atom包</a></li>
</ol>
<h3 id="pre-commit-hooks">提交前挂钩</h3>
<p>由于您在编码时不可避免地会遗漏一些警告，所以在提交时用预提交git挂钩检查质量问题是一个好的实践。在lint之前，可以先格式化代码。这样，您可以避免在CI管道中提交无法通过代码质量检查的代码。</p>
<p>推荐使用<a href="https://pre-commit.com/">预提交</a>框架来管理git挂钩。</p>


<p>安装完成后，添加一个名为<em>的预提交配置文件。将pre-commit-config.yaml </em>提交到项目中。要运行Flake8，请添加以下配置:</p>
<div class="codehilite"><pre><span/><code><span class="nt">repos</span><span class="p">:</span><span class="w"/>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://gitlab.com/PyCQA/flake8</span><span class="w"/>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0.1</span><span class="w"/>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8</span><span class="w"/>
</code></pre></div>

<p>最后，要设置git挂钩脚本，运行:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pre-commit install
</code></pre></div>

<p>现在，每次运行<code>git commit</code> Flake8都会在实际提交之前运行。如果有任何问题，提交将被中止。</p>
<h3 id="ci-pipeline">CI管道</h3>
<p>尽管您可能在代码编辑器和预提交钩子中使用代码质量工具，但您不能总是指望您的队友和其他合作者也这样做。因此，您应该在CI管道中运行代码质量检查。此时，您应该运行linters和安全漏洞检测器，并确保代码遵循特定的代码风格。您可以在测试的同时运行这样的检查。</p>
<h2 id="real-project">真实项目</h2>
<p>让我们创建一个简单的项目来看看所有这些是如何工作的。</p>
<p>首先，创建一个新文件夹:</p>
<div class="codehilite"><pre><span/><code>$ mkdir flask_example
$ <span class="nb">cd</span> flask_example
</code></pre></div>

<p>接下来，用<a href="https://python-poetry.org">诗歌</a>初始化你的项目:</p>
<div class="codehilite"><pre><span/><code>$ poetry init

Package name <span class="o">[</span>flask_example<span class="o">]</span>:
Version <span class="o">[</span><span class="m">0</span>.1.0<span class="o">]</span>:
Description <span class="o">[]</span>:
Author <span class="o">[</span>Your name &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a1d8ced4d3e1c4ccc0c8cd8fc2cecc">[email protected]</a>&gt;, n to skip<span class="o">]</span>:
License <span class="o">[]</span>:
Compatible Python versions <span class="o">[</span>^3.10<span class="o">]</span>:

Would you like to define your main dependencies interactively? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span> no
Would you like to define your development dependencies interactively? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span> no
Do you confirm generation? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span>yes<span class="o">]</span>
</code></pre></div>

<p>之后，添加Flask、pytest、Flake8、Black、isort、Bandit和Safety:</p>
<div class="codehilite"><pre><span/><code>$ poetry add flask
$ poetry add --dev pytest flake8 black isort safety bandit
</code></pre></div>

<p>创建一个文件来保存名为<em> test_app.py </em>的测试:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'TESTING'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="k">def</span> <span class="nf">test_home</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<p>接下来，为Flask应用程序添加一个名为<em> app.py </em>的文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'OK'</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>现在，我们准备添加预提交配置。</p>
<p>首先，初始化一个新的git存储库:</p>


<p>接下来，安装预提交并设置git挂钩脚本:</p>
<div class="codehilite"><pre><span/><code>$ poetry add --dev pre-commit
$ poetry run pre-commit install
</code></pre></div>

<p>为名为<em>的配置创建一个文件。预提交配置. yaml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">repos</span><span class="p">:</span><span class="w"/>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://gitlab.com/PyCQA/flake8</span><span class="w"/>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0.1</span><span class="w"/>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8</span><span class="w"/>
</code></pre></div>

<p>在提交之前，运行isort和Black:</p>
<div class="codehilite"><pre><span/><code>$ poetry run isort . --profile black
$ poetry run black .
</code></pre></div>

<p>提交您的更改以触发预提交挂钩:</p>
<div class="codehilite"><pre><span/><code>$ git add .
$ git commit -m <span class="s1">'Initial commit'</span>
</code></pre></div>

<p>最后，让我们通过<a href="https://github.com/features/actions"> GitHub Actions </a>配置一个CI管道。</p>
<p>创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>.github
└── workflows
    └── main.yaml
</code></pre></div>

<p><em>。github/workflows/main.yaml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CI</span><span class="w"/>
<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">]</span><span class="w"/>

<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"/>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">3.10.2</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.1.13</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7e1d161b1d15110b0a3e084d">[email protected]</a></span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5a293f2e2f2a772a232e3235341a2c68">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run image</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abatilo/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8feeecfbe6e0e1fca2ffe0eafbfdf6cff9bda1bfa1bf">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.poetry-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry install</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run pytest</span><span class="w"/>
<span class="w">  </span><span class="nt">code-quality</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"/>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">3.10.2</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.1.13</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5e3d363b3d35312b2a1e286d">[email protected]</a></span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b3c0d6c7c6c39ec3cac7dbdcddf3c581">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run image</span><span class="w"/>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abatilo/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="08696b7c6167667b2578676d7c7a71487e3a26382638">[email protected]</a></span><span class="w"/>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">poetry-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.poetry-version }}</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry install</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run black</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run black . --check</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run isort</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run isort . --check-only --profile black</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run flake8</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run flake8 .</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run bandit</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run bandit .</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run saftey</span><span class="w"/>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">poetry run safety check</span><span class="w"/>
</code></pre></div>

<p>这种配置:</p>
<ul>
<li>每次推送时运行- <code>on: [push]</code></li>
<li>运行在最新版本的Ubuntu - <code>ubuntu-latest</code></li>
<li>使用Python 3.10.2 - <code>python-version: [3.10.2]</code>，<code>python-version: ${{ matrix.python-version }}</code></li>
<li>1.1.13 -使用诗歌版本<code>poetry-version: [1.1.13]</code>，<code>poetry-version: ${{ matrix.poetry-version }}</code></li>
</ul>
<p>定义了两个作业:<code>test</code>和<code>code-quality</code>。顾名思义，测试在<code>test</code>作业中运行，而我们的代码质量检查在<code>code-quality</code>作业中运行。</p>
<p>将配置项配置添加到git并提交:</p>
<div class="codehilite"><pre><span/><code>$ git add .github/workflows/main.yaml
$ git commit -m <span class="s1">'Add CI config'</span>
</code></pre></div>

<p>在<a href="https://github.com/new"> GitHub </a>上创建一个新的资源库，并将您的项目推送到新创建的remote。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code>$ git remote add origin <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="65020c1125020c110d10074b060a08">[email protected]</a>:jangia/flask_example.git
$ git branch -M main
$ git push -u origin main
</code></pre></div>

<p>您应该在GitHub存储库的<em> Actions </em>选项卡上看到您的工作流正在运行。</p>
<h2 id="conclusion">结论</h2>
<p>代码质量是软件开发中最具争议的话题之一。尤其是代码风格，在开发人员中是一个敏感的问题，因为我们花费了大量的开发时间来阅读代码。当代码具有符合PEP-8标准的一致风格时，阅读和推断意图要容易得多。由于这是一个枯燥、平凡的过程，它应该由计算机通过代码格式化程序如Black和isort来处理。同样，Flake8、Bandit和Safety有助于确保您的代码安全无误。</p>
<hr/>

<blockquote>
<p><a href="/guides/complete-python/">完整Python </a>指南:</p>
<ol>
<li><a href="/blog/python-environments/">现代Python环境——依赖性和工作空间管理</a></li>
<li><a href="/blog/testing-python/">Python中的测试</a></li>
<li><a href="/blog/modern-tdd/">Python中的现代测试驱动开发</a></li>
<li><a href="/blog/python-code-quality/"> Python代码质量</a>(本文！)</li>
<li><a href="/blog/python-type-checking/"> Python类型检查</a></li>
<li><a href="/blog/documenting-python/">记录Python代码和项目</a></li>
<li><a href="/blog/python-project-workflow/"> Python项目工作流程</a></li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>