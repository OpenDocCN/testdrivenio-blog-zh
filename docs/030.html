<html>
<head>
<title>CSRF Protection in Flask </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>烧瓶中的CSRF保护</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/csrf-flask/#0001-01-01">https://testdriven.io/blog/csrf-flask/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>这篇文章着眼于如何防止烧瓶中的<a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery"> CSRF </a>攻击。在这个过程中，我们将看看CSRF是什么，一个CSRF攻击的例子，以及如何通过Flask-WTF防范CSRF。</p>



<h2 id="what-is-csrf">什么是CSRF？</h2>
<p>CSRF代表跨站点请求伪造，是一种针对web应用程序的攻击，攻击者试图欺骗经过身份验证的用户执行恶意操作。大多数CSRF攻击的目标是使用基于cookie的身份验证的web应用程序，因为web浏览器在每个请求中都包含与特定域相关联的所有cookie。因此，当恶意请求来自同一个浏览器时，攻击者可以很容易地利用存储的cookies。</p>
<p>这种攻击通常是通过诱骗用户点击按钮或提交表单来实现的。例如，假设您的银行web应用程序容易受到CSRF攻击。攻击者可以创建一个包含以下形式的银行网站的克隆:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"https://centralbank.com/api/account"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"transaction"</span> <span class="na">value</span><span class="o">=</span><span class="s">"transfer"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"amount"</span> <span class="na">value</span><span class="o">=</span><span class="s">"100"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"account"</span> <span class="na">value</span><span class="o">=</span><span class="s">"999"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Check your statement now"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>然后，攻击者向您发送一封看似来自您的银行(cemtralbenk.com而非centralbank.com)的电子邮件，表明您的银行对账单已经可以查看了。单击电子邮件中的链接后，您会被带到带有表单的恶意网站。你点击按钮检查你的陈述。然后，浏览器将自动发送身份验证cookie和POST请求。由于您已经过身份验证，攻击者将能够执行您被允许执行的任何操作。在这种情况下，100美元从您的帐户转移到帐号999。</p>
<p>想想你每天收到的垃圾邮件。其中有多少包含隐藏的CSRF攻击？</p>
<h2 id="flask-example">烧瓶示例</h2>
<p>接下来，让我们看一个容易受到CSRF攻击的Flask应用程序的例子。同样，我们将使用银行网站场景。</p>
<p>该应用程序具有以下功能:</p>
<ul>
<li>创建用户会话的登录表单</li>
<li>显示帐户余额和转帐表单的帐户页面</li>
<li>注销按钮以清除会话</li>
</ul>
<p>它使用<a href="https://flask-login.readthedocs.io/en/latest/"> Flask-Login </a>来处理auth和管理用户会话。</p>
<p>你可以从<a href="https://github.com/testdrivenio/csrf-example"> csrf-example </a> repo的<a href="https://github.com/testdrivenio/csrf-example/tree/csrf-flask-insecure">csrf-flask-insecurity</a>分支中克隆这个应用。按照自述文件上的说明安装依赖项，并在<a href="http://localhost:5000"> http://localhost:5000 </a>上运行应用程序:</p>


<p>确保您可以使用以下身份登录:</p>
<ul>
<li>用户名:<code>test</code></li>
<li>密码:<code>test</code></li>
</ul>
<p>登录后，您将被重定向到<a href="http://localhost:5000/accounts">http://localhost:5000/accounts</a>。记下会话cookie:</p>
<p><img data-src="/static/images/blog/csrf-flask/cookie.png" loading="lazy" class="lazyload" alt="session cookie" src="../Images/f0d207949a443a836710775a725db17b.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/cookie.png"/></p>
<p>浏览器将随每个后续请求一起向<code>localhost:5000</code>域发送cookie。记下与<em> app.py </em>中的账户页面相关联的路线:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/accounts"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">accounts</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"amount"</span><span class="p">))</span>
        <span class="n">account</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"account"</span><span class="p">))</span>

        <span class="n">transfer_to</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">user</span><span class="p">[</span><span class="s2">"balance"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">transfer_to</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">"balance"</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span>
            <span class="n">transfer_to</span><span class="p">[</span><span class="s2">"balance"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s2">"accounts.html"</span><span class="p">,</span>
        <span class="n">balance</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">"balance"</span><span class="p">],</span>
        <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">"username"</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>

<p>这里没有什么太复杂的:在POST请求中，从用户的余额中减去提供的金额，并添加到与提供的帐号相关联的余额中。当用户通过身份验证时，银行服务器基本上信任来自浏览器的请求。由于这个路由处理程序无法抵御CSRF攻击，攻击者可以利用这种信任，诱使某人在不知情的情况下在银行服务器上执行操作。这正是<em> hacker/index.html </em>页面所做的:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">hidden</span> <span class="na">id</span><span class="o">=</span><span class="s">"hack"</span> <span class="na">target</span><span class="o">=</span><span class="s">"csrf-frame"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://localhost:5000/accounts"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">"off"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"number"</span> <span class="na">name</span><span class="o">=</span><span class="s">"amount"</span> <span class="na">value</span><span class="o">=</span><span class="s">"2000"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">hidden</span> <span class="na">name</span><span class="o">=</span><span class="s">"csrf-frame"</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>You won $100,000<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="s">"hack();"</span> <span class="na">id</span><span class="o">=</span><span class="s">"button"</span><span class="p">&gt;</span>Click to claim<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"warning"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">hack</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"hack"</span><span class="p">).</span><span class="nx">submit</span><span class="p">();</span><span class="w"/>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"warning"</span><span class="p">).</span><span class="nx">innerHTML</span><span class="o">=</span><span class="s2">"check your bank balance!"</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>您可以在<a href="http://localhost:8002"> http://localhost:8002 </a>上提供此页面，方法是导航到项目目录，并在新的终端窗口中运行以下命令:</p>
<div class="codehilite"><pre><span/><code>$ python -m http.server --directory hacker <span class="m">8002</span>
</code></pre></div>

<p><img data-src="/static/images/blog/csrf-flask/hacker.png" loading="lazy" class="lazyload" alt="malicious site" src="../Images/5b4502d2aab5cdbe4147162a382f9395.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/hacker.png"/></p>
<p>除了糟糕的设计，在普通人看来，没有什么值得怀疑的。但在幕后，有一个隐藏的表单在后台执行，从用户的帐户中删除所有的钱。</p>
<p>攻击者可以通过电子邮件发送该页面的链接，伪装成某种奖品。现在，在打开页面并点击“点击认领”按钮后，一个POST请求被发送到<a href="http://localhost:5000/accounts">http://localhost:5000/accounts</a>，该请求利用了银行和web浏览器之间建立的信任。</p>
<p><img data-src="/static/images/blog/csrf-flask/csrf.gif" loading="lazy" class="lazyload" alt="csrf example" src="../Images/b06e2719e52c546b0f4bcee81aa97e78.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/csrf.gif"/></p>
<h2 id="how-to-prevent-csrf">如何预防CSRF？</h2>
<p>通过使用CSRF令牌——一个随机的、不可猜测的字符串——来验证请求来源，可以防止CSRF攻击。对于具有副作用的不安全请求，如HTTP POST表单提交，您必须提供有效的CSRF令牌，以便服务器可以验证请求的来源以获得CSRF保护。</p>
<h3 id="csrf-token-workflow">CSRF令牌工作流</h3>
<p><img data-src="/static/images/blog/csrf-flask/workflow.png" loading="lazy" class="lazyload" alt="csrf protection workflow" src="../Images/78ce8692fc96843b986ddd631e0bb351.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/workflow.png"/></p>
<ol>
<li>客户端发送一个POST请求，其中包含要进行身份验证的凭据。</li>
<li>如果凭据正确，服务器将生成一个会话和CSRF令牌。</li>
<li>请求被发送回客户端，会话存储在cookie中，而令牌呈现在隐藏的表单字段中。</li>
<li>客户端将会话cookie和CSRF令牌包含在表单提交中。</li>
<li>服务器验证会话和CSRF令牌，并接受或拒绝请求。</li>
</ol>
<p>现在让我们看看如何使用<a href="https://flask-wtf.readthedocs.io/"> Flask-WTF </a>扩展在我们的示例应用程序中实现CSRF保护。</p>
<p>从安装依赖项开始:</p>


<p>接下来，在<em> app.py </em>中全局注册<a href="https://flask-wtf.readthedocs.io/csrf.html#csrf-protection"> CSRFProtect </a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LoginManager</span><span class="p">,</span>
    <span class="n">UserMixin</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">,</span>
    <span class="n">login_required</span><span class="p">,</span>
    <span class="n">login_user</span><span class="p">,</span>
    <span class="n">logout_user</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flask_wtf.csrf</span> <span class="kn">import</span> <span class="n">CSRFProtect</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="s2">"secret_sauce"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">csrf</span> <span class="o">=</span> <span class="n">CSRFProtect</span><span class="p">()</span>
<span class="n">csrf</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="o">...</span>
</code></pre></div>

<p>现在，默认情况下，所有POST、PUT、PATCH和DELETE方法都受到保护，不会被CSRF攻击。请注意这一点。永远不要通过GET请求产生副作用，比如改变数据库中的数据。</p>
<p>接下来，将带有CSRF令牌的隐藏输入字段添加到表单中。</p>
<p><em>模板/索引. html </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">'/'</span> <span class="na">method</span><span class="o">=</span><span class="s">'POST'</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">"off"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">'text'</span> <span class="na">name</span><span class="o">=</span><span class="s">'username'</span> <span class="na">id</span><span class="o">=</span><span class="s">'email'</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">'username'</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">'password'</span> <span class="na">name</span><span class="o">=</span><span class="s">'password'</span> <span class="na">id</span><span class="o">=</span><span class="s">'password'</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">'password'</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">'submit'</span> <span class="na">name</span><span class="o">=</span><span class="s">'submit'</span> <span class="na">value</span><span class="o">=</span><span class="s">'login'</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"csrf_token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{ csrf_token() }}"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p><em>模板/账户. html </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Central bank account of {{username}}<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/logout"</span><span class="p">&gt;</span>logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Balance: ${{balance}}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"/accounts"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">"off"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Transfer Money<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"account"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"accountid"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"number"</span> <span class="na">name</span><span class="o">=</span><span class="s">"amount"</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">"amount"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"send"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"csrf_token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"{{ csrf_token() }}"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>就是这样。这能帮你搞定CSRF。现在，让我们看看这是否能阻止攻击。再次运行两台服务器。登录银行app，然后尝试“点击认领”按钮。您应该会看到一个400错误:</p>
<p><img data-src="/static/images/blog/csrf-flask/error.png" loading="lazy" class="lazyload" alt="400 error" src="../Images/7615aa65a674756e8a6bf1338dcd3c60.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/error.png"/></p>
<p>如果在<em> hacker/index.html </em>中的表单中添加相同的隐藏字段会怎么样？</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">hidden</span> <span class="na">id</span><span class="o">=</span><span class="s">"hack"</span> <span class="na">target</span><span class="o">=</span><span class="s">"csrf-frame"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://localhost:5000/accounts"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">"off"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"number"</span> <span class="na">name</span><span class="o">=</span><span class="s">"amount"</span> <span class="na">value</span><span class="o">=</span><span class="s">"2000"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"number"</span> <span class="na">name</span><span class="o">=</span><span class="s">"account"</span> <span class="na">value</span><span class="o">=</span><span class="s">"2"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"csrf_token"</span> <span class="na">value</span><span class="o">=</span><span class="s">"123"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>它仍然应该失败，并显示400。我们成功阻止了CSRF的袭击。</p>
<p><img data-src="/static/images/blog/csrf-flask/csrf_prevent.gif" loading="lazy" class="lazyload" alt="csrf example" src="../Images/4fafc8072adaa9cac1b481bde5352fa3.png" data-original-src="https://testdriven.io/static/images/blog/csrf-flask/csrf_prevent.gif"/></p>
<h2 id="cors-and-json-apis">CORS和JSON APIs</h2>
<p>对于JSON APIs，拥有一个正确配置的<a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">跨源资源共享</a> (CORS)策略是很重要的，但是它本身并不能防止CSRF攻击。事实上，如果CORS配置不正确，它会使您更容易受到CSRF的攻击。</p>
<p>对于<a href="https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request">预检请求</a> CORS策略定义了谁可以和不可以访问特定资源。当使用<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"> XMLHttpRequest </a>或<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"> Fetch </a>时，此类请求由浏览器触发。</p>
<blockquote>
<p>当触发预检请求时，浏览器向服务器发送请求，询问CORS策略(允许的来源、允许的请求类型等)。).然后，浏览器根据原始请求检查响应。如果请求不符合要求，浏览器将拒绝它。</p>
</blockquote>
<p>同时，简单的请求，比如来自基于浏览器的表单提交的POST请求，不会触发预检请求，因此CORS策略无关紧要。</p>
<p>因此，如果您有JSON API，限制允许的来源或完全消除CORS是防止不必要请求的一个好方法。在那种情况下，你不需要使用CSRF代币。如果你对原产地有更开放的CORS政策，使用CSRF代币是个好主意。</p>
<h2 id="conclusion">结论</h2>
<p>我们已经看到了攻击者如何在用户不知情的情况下伪造请求并执行操作。随着浏览器变得越来越安全，JSON APIs被越来越多地使用，幸运的是CSRF变得越来越不令人担心。也就是说，对于像表单中的POST请求这样的简单请求，确保处理此类请求的路由处理程序的安全是至关重要的，尤其是当Flask-WTF使得抵御CSRF攻击变得如此容易时。</p>
  </div>

  </div>    
</body>
</html>