<html>
<head>
<title>Developing a Single Page App with FastAPI and Vue.js </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用FastAPI和Vue.js开发单页应用</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/developing-a-single-page-app-with-fastapi-and-vuejs/#0001-01-01">https://testdriven.io/blog/developing-a-single-page-app-with-fastapi-and-vuejs/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>以下是如何使用FastAPI、Vue、Docker和Postgres构建和封装一个基本CRUD应用程序的分步演练。我们将从后端开始，开发一个由Python、FastAPI和Docker支持的RESTful API，然后转移到前端。我们还将连接基于令牌的身份验证。</p>
<p><em>最终应用</em>:</p>
<p><img data-src="/static/images/gifs/blog/fastapi-vue/final.gif" loading="lazy" class="lazyload" alt="final app" src="../Images/5a64117bc23037bb5929badea7538fa1.png" data-original-src="https://testdriven.io/static/images/gifs/blog/fastapi-vue/final.gif"/></p>
<p><em>主要依赖:</em></p>
<ul>
<li>视图v3.2.45</li>
<li>CLI视图v5.0.8</li>
<li>节点v18.12.1</li>
<li>npm v8.19.2</li>
<li>FastAPI v0.88.0</li>
<li>python 3 . 11 . 1版</li>
</ul>
<blockquote>
<p>这是一个中级教程，重点是分别用FastAPI和Vue开发后端和前端app。除了应用程序本身，您还可以添加身份验证，并将它们集成在一起。假设您有使用FastAPI、Vue和Docker的经验。请参见<a href="/blog/developing-a-single-page-app-with-fastapi-and-vuejs/#fastapi-and-vue"> FastAPI和Vue </a>部分，了解学习上述工具和技术的推荐资源。</p>
</blockquote>



<h2 id="objectives">目标</h2>
<p>本教程结束时，您将能够:</p>
<ol>
<li>解释什么是FastAPI</li>
<li>解释什么是Vue，以及它与其他UI库和前端框架(如React和Angular)相比如何</li>
<li>用FastAPI开发RESTful API</li>
<li>使用Vue CLI搭建Vue项目</li>
<li>在浏览器中创建和渲染Vue组件</li>
<li>使用Vue组件创建单页面应用程序(SPA)</li>
<li>将Vue应用程序连接到FastAPI后端</li>
<li>使用引导程序设计Vue组件</li>
<li>使用Vue路由器创建路线并渲染组件</li>
<li>使用基于令牌的身份验证管理用户身份验证</li>
</ol>
<h2 id="fastapi-and-vue">FastAPI和视图</h2>
<p>让我们快速看一下每个框架。</p>
<h3 id="what-is-fastapi">什么是FastAPI？</h3>
<p>FastAPI是一个包含电池的现代Python web框架，非常适合构建RESTful APIs。它可以处理同步和异步请求，并内置了对数据验证、JSON序列化、认证和授权以及<a href="https://swagger.io/docs/specification/about/"> OpenAPI </a>文档的支持。</p>
<p>亮点:</p>
<ol>
<li>受Flask的启发，它有一种轻量级微框架的感觉，支持类似Flask的route decorators。</li>
<li>它利用Python类型提示进行参数声明，支持数据验证(通过<a href="https://pydantic-docs.helpmanual.io/"> pydantic </a>)和OpenAPI/Swagger文档。</li>
<li>它建立在<a href="https://www.starlette.io/"> Starlette </a>之上，支持异步API的开发。</li>
<li>已经<a href="https://www.techempower.com/benchmarks/#section=data-r21&amp;hw=ph&amp;test=query&amp;l=zijzen-7">快</a>了。由于async比传统的同步线程模型更有效，所以在性能方面它可以与Node和Go竞争。</li>
<li>因为它基于并完全兼容OpenAPI和JSON Schema，所以它支持许多强大的工具，比如Swagger UI。</li>
<li>它有惊人的<a href="https://fastapi.tiangolo.com/">文档</a>。</li>
</ol>
<p><strong>第一次用FastAPI？</strong>查看以下资源:</p>
<ol>
<li><a href="/blog/fastapi-crud/">使用FastAPI和Pytest开发和测试异步API</a></li>
<li><a href="/courses/tdd-fastapi/">用FastAPI和Docker进行测试驱动开发</a></li>
</ol>
<h3 id="what-is-vue">Vue是什么？</h3>
<p>Vue是一个开源的JavaScript框架，用于构建用户界面。它采用了React和Angular的一些最佳实践。也就是说，与React和Angular相比，它要平易近人得多，因此初学者可以快速上手并运行。它也同样强大，因此它提供了创建现代前端应用程序所需的所有功能。</p>
<p>有关Vue的更多信息，以及使用它与React和Angular相比的优缺点，请查看以下文章:</p>
<ol>
<li><a href="https://vuejs.org/v2/guide/comparison.html"> Vue:与其他框架的比较</a></li>
<li><a href="/courses/learn-vue/">通过构建和部署CRUD应用程序学习Vue</a></li>
<li><a href="https://medium.com/techmagic/reactjs-vs-angular5-vs-vue-js-what-to-choose-in-2018-b91e028fa91d">反应vs角度vs Vue.js </a></li>
</ol>
<p><strong>第一次用Vue？</strong></p>
<ol>
<li>花点时间通读官方Vue指南中的<a href="https://vuejs.org/guide/introduction.html">介绍</a>。</li>
<li>查看<a href="/courses/learn-vue/"> Learn Vue，构建并部署CRUD App </a>课程。</li>
</ol>
<h2 id="what-are-we-building">我们在建造什么？</h2>
<p>我们的目标是为两种资源——用户和notes——设计一个后端RESTful API，由Python和FastAPI提供支持。API本身应该遵循RESTful设计原则，使用基本的HTTP动词:GET、POST、PUT和DELETE。</p>
<p>我们还将使用Vue设置一个前端应用程序，与后端API进行交互:</p>
<p><img data-src="/static/images/gifs/blog/fastapi-vue/final.gif" loading="lazy" class="lazyload" alt="final app" src="../Images/5a64117bc23037bb5929badea7538fa1.png" data-original-src="https://testdriven.io/static/images/gifs/blog/fastapi-vue/final.gif"/></p>
<p>核心功能:</p>
<ol>
<li>经过身份验证的用户将能够查看、添加、更新和删除注释</li>
<li>经过身份验证的用户也可以查看他们的用户信息并删除他们自己</li>
</ol>
<blockquote>
<p>本教程主要是讨论快乐之路。对于读者来说，处理不愉快/异常路径是一个单独的练习。检查您的理解，并为前端和后端添加适当的错误处理。</p>
</blockquote>
<h2 id="fastapi-setup">FastAPI Setup</h2>
<p>首先创建一个名为“fastapi-vue”的新项目文件夹，并添加以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>fastapi-vue
├── docker-compose.yml
└── services
    └── backend
        ├── Dockerfile
        ├── requirements.txt
        └── src
            └── main.py
</code></pre></div>

<blockquote>
<p>以下命令将创建项目结构:</p><div class="codehilite"><pre><span/><code>$ mkdir fastapi-vue <span class="o">&amp;&amp;</span> <span class="se">\</span>
  <span class="nb">cd</span> fastapi-vue <span class="o">&amp;&amp;</span> <span class="se">\</span>
  mkdir -p services/backend/src <span class="o">&amp;&amp;</span> <span class="se">\</span>
  touch docker-compose.yml services/backend/Dockerfile <span class="o">&amp;&amp;</span> <span class="se">\</span>
  touch services/backend/requirements.txt services/backend/src/main.py
</code></pre></div>
</blockquote>

<p>接下来，将以下代码添加到<em>服务/后端/Dockerfile </em>中:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-buster</span>

<span class="k">RUN</span><span class="w"> </span>mkdir app
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">:/root/.local/bin"</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>.

<span class="k">COPY</span><span class="w"> </span>requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="k">COPY</span><span class="w"> </span>src/ .
</code></pre></div>

<p>将以下依赖项添加到<em>服务/后端/需求. txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.88.0
uvicorn==0.20.0
</code></pre></div>

<p>更新坞站-复合. yml 如:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uvicorn src.main:app --reload --host 0.0.0.0 --port 5000</span><span class="w"/>
</code></pre></div>

<p>在我们构建映像之前，让我们添加一个到<em>services/back end/src/main . py</em>的测试路径，这样我们就可以快速测试应用是否构建成功:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"Hello, World!"</span>
</code></pre></div>

<p>在您的终端中构建映像:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>完成后，在您选择的浏览器中导航至<a href="http://127.0.0.1:5000/"> http://127.0.0.1:5000/ </a>。您应该看到:</p>


<p>可以在<a href="http://localhost:5000/docs">http://localhost:5000/docs</a>查看Swagger UI。</p>
<p>接下来，添加<a href="https://fastapi.tiangolo.com/tutorial/cors/#use-corsmiddleware">中间件</a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.middleware.cors</span> <span class="kn">import</span> <span class="n">CORSMiddleware</span>  <span class="c1"># NEW</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="c1"># NEW</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"http://localhost:8080"</span><span class="p">],</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
<span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"Hello, World!"</span>
</code></pre></div>

<p><code>CORSMiddleware</code>需要发出<a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">跨来源</a>请求——即来自不同协议、IP地址、域名或端口的请求。这是必要的，因为前端将在<code>http://localhost:8080</code>运行。</p>
<h2 id="vue-setup">视图设置</h2>
<p>从我们的前端开始，我们将使用<a href="https://cli.vuejs.org/"> Vue CLI </a>搭建一个项目。</p>
<p>确保您使用的是Vue CLI的版本<a href="https://www.npmjs.com/package/@vue/cli/v/5.0.8"> 5.0.8 </a>:</p>


<p>接下来，从“fastapi-vue/services”文件夹中，搭建出一个新的vue项目:</p>


<p>选择<code>Default ([Vue 3] babel, eslint)</code>。</p>
<p>脚手架搭好之后，添加<a href="https://router.vuejs.org/">路由器</a>(对<a href="https://router.vuejs.org/guide/essentials/history-mode.html">历史模式</a>说是)，并安装所需的依赖项:</p>


<p>我们将很快讨论这些依赖项。</p>
<p>要在本地提供Vue应用程序，请运行:</p>


<p>导航至<a href="http://localhost:8080/"> http://localhost:8080/ </a>查看您的应用。</p>
<p>关掉服务器。</p>
<p>接下来，在<em>services/frontend/src/main . js</em>中连接Axios和Bootstrap的依赖关系:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="s1">'bootstrap/dist/css/bootstrap.css'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createApp</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"vue"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./App.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./router'</span><span class="p">;</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createApp</span><span class="p">(</span><span class="nx">App</span><span class="p">);</span><span class="w"/>

<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">withCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'http://localhost:5000/'</span><span class="p">;</span><span class="w">  </span><span class="c1">// the FastAPI backend</span><span class="w"/>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span><span class="w"/>
<span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s2">"#app"</span><span class="p">);</span><span class="w"/>
</code></pre></div>

<p>向“服务/前端”添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">node:lts-alpine</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">ENV</span><span class="w"> </span>PATH /app/node_modules/.bin:<span class="nv">$PATH</span>

<span class="k">RUN</span><span class="w"> </span>npm install @vue/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6407080d24514a544a5c">[email protected]</a> -g

<span class="k">COPY</span><span class="w"> </span>package.json .
<span class="k">COPY</span><span class="w"> </span>package-lock.json .
<span class="k">RUN</span><span class="w"> </span>npm install

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"npm"</span><span class="p">,</span><span class="w"> </span><span class="s2">"run"</span><span class="p">,</span><span class="w"> </span><span class="s2">"serve"</span><span class="p">]</span>
</code></pre></div>

<p>增加a服务至<em>码头-化合物. yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uvicorn src.main:app --reload --host 0.0.0.0 --port 5000</span><span class="w"/>

<span class="w">  </span><span class="nt">frontend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/frontend</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'./services/frontend:/app'</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'/app/node_modules'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:8080</span><span class="w"/>
</code></pre></div>

<p>构建新映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>确保<a href="http://localhost:8080/"> http://localhost:8080/ </a>仍然工作。</p>
<p>接下来，更新<em>services/frontend/src/components/hello world . vue</em>如下:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ msg }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Ping'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">getMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="p">})</span><span class="w"/>
<span class="w">        </span><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">created</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">getMessage</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">};</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p><a href="https://axios-http.com/"> Axios </a>，这是一个HTTP客户端，用于向后端发送AJAX请求。在上面的组件中，我们从后端的响应中更新了<code>msg</code>的值。</p>
<p>最后，在<em>services/frontend/src/app . vue</em>中，移除导航以及相关的样式:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"app"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">router-view</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span><span class="w"/>
<span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Avenir</span><span class="p">,</span><span class="w"> </span><span class="n">Helvetica</span><span class="p">,</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kp">-webkit-</span><span class="n">font-smoothing</span><span class="p">:</span><span class="w"> </span><span class="n">antialiased</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kp">-moz-</span><span class="n">osx-font-smoothing</span><span class="p">:</span><span class="w"> </span><span class="n">grayscale</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#2c3e50</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div>

<p>现在，您应该会在浏览器的<a href="http://localhost:8080/">中看到<code>Hello, World!</code>。</a></p>
<p>您的完整项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── docker-compose.yml
└── services
    ├── backend
    │   ├── Dockerfile
    │   ├── requirements.txt
    │   └── src
    │       └── main.py
    └── frontend
        ├── .gitignore
        ├── Dockerfile
        ├── README.md
        ├── babel.config.js
        ├── jsconfig.json
        ├── package-lock.json
        ├── package.json
        ├── public
        │   ├── favicon.ico
        │   └── index.html
        ├── src
        │   ├── App.vue
        │   ├── assets
        │   │   └── logo.png
        │   ├── components
        │   │   └── HelloWorld.vue
        │   ├── main.js
        │   ├── router
        │   │   └── index.js
        │   └── views
        │       ├── AboutView.vue
        │       └── HomeView.vue
        └── vue.config.js
</code></pre></div>

<h2 id="models-and-migrations">模型和迁移</h2>
<p>我们将使用<a href="https://tortoise-orm.readthedocs.io/"> Tortoise </a>来管理ORM(对象关系映射器),使用<a href="https://github.com/tortoise/aerich"> Aerich </a>来管理数据库迁移。</p>
<p>更新后端依赖关系:</p>
<div class="codehilite"><pre><span/><code>aerich==0.7.1
asyncpg==0.27.0
fastapi==0.88.0
tortoise-orm==0.19.2
uvicorn==0.20.0
</code></pre></div>

<p>首先，让我们为Postgres添加一个新服务到<em> docker-compose.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgres://hello_fastapi:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b9d1dcd5d5d6e6dfd8cacdd8c9d0f9dddb">[email protected]</a>:5432/hello_fastapi_dev</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uvicorn src.main:app --reload --host 0.0.0.0 --port 5000</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>

<span class="w">  </span><span class="nt">frontend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/frontend</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'./services/frontend:/app'</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'/app/node_modules'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:8080</span><span class="w"/>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15.1</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_fastapi_dev</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>注意<code>db</code>中的环境变量以及<code>backend</code>服务中新的<code>DATABASE_URL</code>环境变量。</p>
<p>接下来，在“services/backend/src”文件夹中创建一个名为“database”的文件夹，并向其中添加一个名为<em> models.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">tortoise</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Users</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">modified_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Notes</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">225</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="s2">"models.Users"</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">"note"</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">modified_at</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">DatetimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">author_id</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>

<p><code>Users</code>和<code>Notes</code>类将在我们的数据库中创建两个新表。请注意，<code>author</code>列与用户相关联，创建了一个一对多的关系(一个用户可以有多个注释)。</p>
<p>在“services/backend/src/database”文件夹中创建一个<em> config.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>


<span class="n">TORTOISE_ORM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"connections"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"default"</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">)},</span>
    <span class="s2">"apps"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"models"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"models"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"src.database.models"</span><span class="p">,</span> <span class="s2">"aerich.models"</span>
            <span class="p">],</span>
            <span class="s2">"default_connection"</span><span class="p">:</span> <span class="s2">"default"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这里，我们为Tortoise和Aerich指定了配置。</p>
<p>简而言之，我们:</p>
<ol>
<li>通过<code>DATABASE_URL</code>环境变量定义数据库连接</li>
<li>注册我们的模型，<code>src.database.models</code>(用户和注释)和<code>aerich.models</code>(迁移元数据)</li>
</ol>
<p>将一个<em> register.py </em>文件添加到“服务/后端/src/数据库”中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">tortoise</span> <span class="kn">import</span> <span class="n">Tortoise</span>


<span class="k">def</span> <span class="nf">register_tortoise</span><span class="p">(</span>
    <span class="n">app</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">generate_schemas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_orm</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">Tortoise</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generate_schemas</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">Tortoise</span><span class="o">.</span><span class="n">generate_schemas</span><span class="p">()</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"shutdown"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close_orm</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">Tortoise</span><span class="o">.</span><span class="n">close_connections</span><span class="p">()</span>
</code></pre></div>

<p><code>register_tortoise</code>是一个将用于配置我们的应用程序和Tortoise模型的函数。它接受我们的应用程序、一个配置字典和一个<code>generate_schema</code>布尔值。</p>
<p>该函数将在<em> main.py </em>中用我们的配置字典调用:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.middleware.cors</span> <span class="kn">import</span> <span class="n">CORSMiddleware</span>

<span class="kn">from</span> <span class="nn">src.database.register</span> <span class="kn">import</span> <span class="n">register_tortoise</span>  <span class="c1"># NEW</span>
<span class="kn">from</span> <span class="nn">src.database.config</span> <span class="kn">import</span> <span class="n">TORTOISE_ORM</span>         <span class="c1"># NEW</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># NEW</span>
<span class="n">register_tortoise</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TORTOISE_ORM</span><span class="p">,</span> <span class="n">generate_schemas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"Hello, World!"</span>
</code></pre></div>

<p>构建新映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>容器启动并运行后，运行:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> backend aerich init -t src.database.config.TORTOISE_ORM
Success create migrate location ./migrations
Success write config to pyproject.toml

$ docker-compose <span class="nb">exec</span> backend aerich init-db
Success create app migrate location migrations/models
Success generate schema <span class="k">for</span> app <span class="s2">"models"</span>
</code></pre></div>

<p>第一个命令告诉Aerich配置字典在哪里，用于初始化模型和数据库之间的连接。这创建了一个<em>服务/后端/pyproject.toml </em> <a href="https://github.com/tortoise/aerich#initialization">配置文件</a>和一个“服务/后端/迁移”文件夹。</p>
<p>接下来，我们在“服务/后端/迁移/模型”中为我们的三个模型——用户、notes和aerich——生成了一个迁移文件。这些也应用于数据库。</p>
<p>让我们将<em> pyproject.toml </em>文件和“migrations”文件夹复制到容器中。为此，更新<em> Dockerfile </em>，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-buster</span>

<span class="k">RUN</span><span class="w"> </span>mkdir app
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">ENV</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">:/root/.local/bin"</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>.

<span class="k">COPY</span><span class="w"> </span>requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># for migrations</span>
<span class="k">COPY</span><span class="w"> </span>migrations .
<span class="k">COPY</span><span class="w"> </span>pyproject.toml .

<span class="k">COPY</span><span class="w"> </span>src/ .
</code></pre></div>

<p>更新:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>现在，当您对模型进行更改时，您可以运行以下命令来更新数据库:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> backend aerich migrate
$ docker-compose <span class="nb">exec</span> backend aerich upgrade
</code></pre></div>

<h2 id="crud-actions">CRUD操作</h2>
<p>现在让我们连接基本的CRUD操作:创建、读取、更新和删除。</p>
<p>首先，因为我们需要定义模式来序列化和反序列化我们的数据，所以在“services/backend/src”中创建两个文件夹，分别称为“crud”和“schemas”。</p>
<p>为了确保我们的序列化程序能够读取模型之间的关系，我们需要初始化<em> main.py </em>文件中的模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.middleware.cors</span> <span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span> <span class="nn">tortoise</span> <span class="kn">import</span> <span class="n">Tortoise</span>  <span class="c1"># NEW</span>

<span class="kn">from</span> <span class="nn">src.database.register</span> <span class="kn">import</span> <span class="n">register_tortoise</span>
<span class="kn">from</span> <span class="nn">src.database.config</span> <span class="kn">import</span> <span class="n">TORTOISE_ORM</span>


<span class="c1"># enable schemas to read relationship between models</span>
<span class="n">Tortoise</span><span class="o">.</span><span class="n">init_models</span><span class="p">([</span><span class="s2">"src.database.models"</span><span class="p">],</span> <span class="s2">"models"</span><span class="p">)</span>  <span class="c1"># NEW</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"http://localhost:8080"</span><span class="p">],</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">register_tortoise</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TORTOISE_ORM</span><span class="p">,</span> <span class="n">generate_schemas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"Hello, World!"</span>
</code></pre></div>

<p>现在，对任何对象的查询都可以从相关表中获取数据。</p>
<p>接下来，在“schemas”文件夹中，添加两个名为<em> users.py </em>和<em> notes.py </em>的文件。</p>
<p><em>服务/后端/src/模式/用户. py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">tortoise.contrib.pydantic</span> <span class="kn">import</span> <span class="n">pydantic_model_creator</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Users</span>


<span class="n">UserInSchema</span> <span class="o">=</span> <span class="n">pydantic_model_creator</span><span class="p">(</span>
    <span class="n">Users</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"UserIn"</span><span class="p">,</span> <span class="n">exclude_readonly</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">pydantic_model_creator</span><span class="p">(</span>
    <span class="n">Users</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"UserOut"</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">"password"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"modified_at"</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">UserDatabaseSchema</span> <span class="o">=</span> <span class="n">pydantic_model_creator</span><span class="p">(</span>
    <span class="n">Users</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"User"</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"modified_at"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/tortoise/tortoise-orm/blob/0.19.2/tortoise/contrib/pydantic/creator.py#L117"> pydantic_model_creator </a>是一个乌龟助手，它允许我们从乌龟模型中创建<a href="https://pydantic-docs.helpmanual.io/usage/models/"> pydantic模型</a>，我们将用它来创建和检索数据库记录。它接受<code>Users</code>模型和一个<code>name</code>。还可以<code>exclude</code>具体栏目。</p>
<p>架构:</p>
<ol>
<li><code>UserInSchema</code>用于创建新用户。</li>
<li><code>UserOutSchema</code>用于检索将在应用程序外<em>使用的用户信息，用于返回给最终用户。</em></li>
<li><code>UserDatabaseSchema</code>用于检索在应用程序中使用的<em>用户信息，用于验证用户。</em></li>
</ol>
<p><em>服务/后端/src/schemas/notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">tortoise.contrib.pydantic</span> <span class="kn">import</span> <span class="n">pydantic_model_creator</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Notes</span>


<span class="n">NoteInSchema</span> <span class="o">=</span> <span class="n">pydantic_model_creator</span><span class="p">(</span>
    <span class="n">Notes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"NoteIn"</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">"author_id"</span><span class="p">],</span> <span class="n">exclude_readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">NoteOutSchema</span> <span class="o">=</span> <span class="n">pydantic_model_creator</span><span class="p">(</span>
    <span class="n">Notes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"Note"</span><span class="p">,</span> <span class="n">exclude</span> <span class="o">=</span><span class="p">[</span>
      <span class="s2">"modified_at"</span><span class="p">,</span> <span class="s2">"author.password"</span><span class="p">,</span> <span class="s2">"author.created_at"</span><span class="p">,</span> <span class="s2">"author.modified_at"</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">UpdateNote</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

<p>架构:</p>
<ol>
<li><code>NoteInSchema</code>用于创建新的便笺。</li>
<li><code>NoteOutSchema</code>用于检索笔记。</li>
<li><code>UpdateNote</code>用于更新笔记。</li>
</ol>
<p>接下来，将<em> users.py </em>和<em> notes.py </em>文件添加到“服务/后端/src/crud”文件夹中。</p>
<p><em>服务/后端/src/crud/users.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">passlib.context</span> <span class="kn">import</span> <span class="n">CryptContext</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Users</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserOutSchema</span>


<span class="n">pwd_context</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span><span class="s2">"bcrypt"</span><span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserOutSchema</span><span class="p">:</span>
    <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Users</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Sorry, that username already exists."</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">UserOutSchema</span><span class="o">.</span><span class="n">from_tortoise_orm</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">UserOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Users</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deleted_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Deleted user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to delete"</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们定义了用于创建和删除用户的助手函数:</p>
<ol>
<li><code>create_user</code>接收一个用户，加密<code>user.password</code>，然后将该用户添加到数据库中。</li>
<li><code>delete_user</code>从数据库中删除用户。它还通过确保请求由当前经过身份验证的用户发起来保护用户。</li>
</ol>
<p>将所需的依赖项添加到<em>services/back end/requirements . txt</em>:</p>
<div class="codehilite"><pre><span/><code>aerich==0.7.1
asyncpg==0.27.0
bcrypt==4.0.1
passlib==1.7.4
fastapi==0.88.0
tortoise-orm==0.19.2
uvicorn==0.20.0
</code></pre></div>

<p><em>服务/后端/src/crud/notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Notes</span>
<span class="kn">from</span> <span class="nn">src.schemas.notes</span> <span class="kn">import</span> <span class="n">NoteOutSchema</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_notes</span><span class="p">():</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="n">note_dict</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">note_dict</span><span class="p">[</span><span class="s2">"author_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">note_obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">note_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_tortoise_orm</span><span class="p">(</span><span class="n">note_obj</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_note</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">note</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to update"</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_note</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deleted_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Deleted note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to delete"</span><span class="p">)</span>
</code></pre></div>

<p>在这里，我们创建了助手函数来实现notes资源的所有CRUD操作。记下<code>update_note</code>和<code>delete_note</code>助手。我们添加了一个检查来确保请求来自笔记作者。</p>
<p>您的文件夹结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── docker-compose.yml
└── services
    ├── backend
    │   ├── Dockerfile
    │   ├── migrations
    │   │   └── models
    │   │       └── 0_20221212182213_init.py
    │   ├── pyproject.toml
    │   ├── requirements.txt
    │   └── src
    │       ├── crud
    │       │   ├── notes.py
    │       │   └── users.py
    │       ├── database
    │       │   ├── config.py
    │       │   ├── models.py
    │       │   └── register.py
    │       ├── main.py
    │       └── schemas
    │           ├── notes.py
    │           └── users.py
    └── frontend
        ├── .gitignore
        ├── Dockerfile
        ├── README.md
        ├── babel.config.js
        ├── jsconfig.json
        ├── package-lock.json
        ├── package.json
        ├── public
        │   ├── favicon.ico
        │   └── index.html
        ├── src
        │   ├── App.vue
        │   ├── assets
        │   │   └── logo.png
        │   ├── components
        │   │   └── HelloWorld.vue
        │   ├── main.js
        │   ├── router
        │   │   └── index.js
        │   └── views
        │       ├── AboutView.vue
        │       └── HomeView.vue
        └── vue.config.js
</code></pre></div>

<blockquote>
<p>这是一个停下来的好时机，回顾一下到目前为止你已经完成了什么，并连接<a href="https://docs.pytest.org/"> pytest </a>来测试CRUD助手。需要帮助吗？回顾<a href="/blog/fastapi-crud/">用FastAPI和Pytest开发和测试异步API</a>。</p>
</blockquote>
<h2 id="jwt-authentication">JWT认证</h2>
<p>在添加路由处理程序之前，让我们连接身份验证来保护特定的路由。</p>
<p>首先，我们需要在“services/backend/src/schemas”文件夹中名为<em> token.py </em>的新文件中创建一些pydantic模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Status</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<p>我们定义了两种模式:</p>
<ol>
<li><code>TokenData</code>用于确保令牌中的用户名是一个字符串。</li>
<li><code>Status</code>用于向最终用户发回状态消息。</li>
</ol>
<p>在“服务/后端/src”文件夹中创建另一个名为“auth”的文件夹。然后，向其中添加两个新文件，分别名为<em> jwthandler.py </em>和<em> users.py </em>。</p>
<p><em>services/back end/src/auth/jwthandler . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi.openapi.models</span> <span class="kn">import</span> <span class="n">OAuthFlows</span> <span class="k">as</span> <span class="n">OAuthFlowsModel</span>
<span class="kn">from</span> <span class="nn">fastapi.security</span> <span class="kn">import</span> <span class="n">OAuth2</span>
<span class="kn">from</span> <span class="nn">fastapi.security.utils</span> <span class="kn">import</span> <span class="n">get_authorization_scheme_param</span>
<span class="kn">from</span> <span class="nn">jose</span> <span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span>

<span class="kn">from</span> <span class="nn">src.schemas.token</span> <span class="kn">import</span> <span class="n">TokenData</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserOutSchema</span>
<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Users</span>


<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SECRET_KEY"</span><span class="p">)</span>
<span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">"HS256"</span>
<span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>


<span class="k">class</span> <span class="nc">OAuth2PasswordBearerCookie</span><span class="p">(</span><span class="n">OAuth2</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">token_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scheme_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scopes</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scopes</span><span class="p">:</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">flows</span> <span class="o">=</span> <span class="n">OAuthFlowsModel</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="p">{</span><span class="s2">"tokenUrl"</span><span class="p">:</span> <span class="n">token_url</span><span class="p">,</span> <span class="s2">"scopes"</span><span class="p">:</span> <span class="n">scopes</span><span class="p">})</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">flows</span><span class="o">=</span><span class="n">flows</span><span class="p">,</span> <span class="n">scheme_name</span><span class="o">=</span><span class="n">scheme_name</span><span class="p">,</span> <span class="n">auto_error</span><span class="o">=</span><span class="n">auto_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">authorization</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Authorization"</span><span class="p">)</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="n">get_authorization_scheme_param</span><span class="p">(</span><span class="n">authorization</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">authorization</span> <span class="ow">or</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"bearer"</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="s2">"Not authenticated"</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"WWW-Authenticate"</span><span class="p">:</span> <span class="s2">"Bearer"</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">param</span>


<span class="n">security</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearerCookie</span><span class="p">(</span><span class="n">token_url</span><span class="o">=</span><span class="s2">"/login"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">expires_delta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"exp"</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_jwt</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
        <span class="n">detail</span><span class="o">=</span><span class="s2">"Could not validate credentials"</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"WWW-Authenticate"</span><span class="p">:</span> <span class="s2">"Bearer"</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"sub"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">credentials_exception</span>
        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">credentials_exception</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">UserOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span>
            <span class="n">Users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">credentials_exception</span>

    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li><code>OAuth2PasswordBearerCookie</code>是一个继承自<code>OAuth2</code>类的类，用于读取受保护路由的请求报头中发送的cookie。它确保cookie存在，然后从cookie中返回令牌。</li>
<li><code>create_access_token</code>函数接收用户的用户名，用到期时间对其进行编码，并从中生成一个令牌。</li>
<li><code>get_current_user</code>解码令牌并验证用户。</li>
</ol>
<p><a href="https://python-jose.readthedocs.io/"> python-jose </a>用于对<a href="https://jwt.io/"> JWT令牌</a>进行编码和解码。将包添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>aerich==0.7.1
asyncpg==0.27.0
bcrypt==4.0.1
passlib==1.7.4
fastapi==0.88.0
python-jose==3.3.0
tortoise-orm==0.19.2
uvicorn==0.20.0
</code></pre></div>

<p>将<code>SECRET_KEY</code>环境变量添加到<em> docker-compose.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgres://hello_fastapi:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6008050c0c0f3f06011314011009200402">[email protected]</a>:5432/hello_fastapi_dev</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/backend:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uvicorn src.main:app --reload --host 0.0.0.0 --port 5000</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>

<span class="w">  </span><span class="nt">frontend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/frontend</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'./services/frontend:/app'</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'/app/node_modules'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:8080</span><span class="w"/>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15.1</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_fastapi_dev</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p><em>服务/后端/src/auth/users.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">fastapi.security</span> <span class="kn">import</span> <span class="n">OAuth2PasswordRequestForm</span>
<span class="kn">from</span> <span class="nn">passlib.context</span> <span class="kn">import</span> <span class="n">CryptContext</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Users</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserDatabaseSchema</span>


<span class="n">pwd_context</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span><span class="s2">"bcrypt"</span><span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">UserDatabaseSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">validate_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">"Incorrect username or password"</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">db_user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">"Incorrect username or password"</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">db_user</span>
</code></pre></div>

<p>注意事项:</p>
<ul>
<li><code>validate_user</code>用于验证用户登录时的身份。如果用户名或密码不正确，它会向用户抛出一个<code>401_UNAUTHORIZED</code>错误。</li>
</ul>
<p>最后，让我们更新CRUD助手，以便它们使用<code>Status</code> pydantic模型:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">Status</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<p><em>服务/后端/src/crud/users.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">passlib.context</span> <span class="kn">import</span> <span class="n">CryptContext</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Users</span>
<span class="kn">from</span> <span class="nn">src.schemas.token</span> <span class="kn">import</span> <span class="n">Status</span>  <span class="c1"># NEW</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserOutSchema</span>


<span class="n">pwd_context</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span><span class="s2">"bcrypt"</span><span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserOutSchema</span><span class="p">:</span>
    <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Users</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Sorry, that username already exists."</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">UserOutSchema</span><span class="o">.</span><span class="n">from_tortoise_orm</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Status</span><span class="p">:</span>  <span class="c1"># UPDATED</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">UserOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Users</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deleted_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Status</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Deleted user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  <span class="c1"># UPDATED</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to delete"</span><span class="p">)</span>
</code></pre></div>

<p><em>服务/后端/src/crud/notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span>

<span class="kn">from</span> <span class="nn">src.database.models</span> <span class="kn">import</span> <span class="n">Notes</span>
<span class="kn">from</span> <span class="nn">src.schemas.notes</span> <span class="kn">import</span> <span class="n">NoteOutSchema</span>
<span class="kn">from</span> <span class="nn">src.schemas.token</span> <span class="kn">import</span> <span class="n">Status</span>  <span class="c1"># NEW</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_notes</span><span class="p">():</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="n">note_dict</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">note_dict</span><span class="p">[</span><span class="s2">"author_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">note_obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">note_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_tortoise_orm</span><span class="p">(</span><span class="n">note_obj</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_note</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">note</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to update"</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Status</span><span class="p">:</span>  <span class="c1"># UPDATED</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">NoteOutSchema</span><span class="o">.</span><span class="n">from_queryset_single</span><span class="p">(</span><span class="n">Notes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db_note</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Notes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">note_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deleted_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Status</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Deleted note </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  <span class="c1"># UPDATED</span>

    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Not authorized to delete"</span><span class="p">)</span>
</code></pre></div>

<h2 id="routing">按指定路线发送</h2>
<p>随着pydantic模型、CRUD助手和JWT认证的建立，我们现在可以用路由处理程序将所有东西粘在一起。</p>
<p>在我们的“src”文件夹中创建一个“routes”文件夹，并添加两个文件，<em> users.py </em>和<em> notes.py </em>。</p>
<p><em> users.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">fastapi.encoders</span> <span class="kn">import</span> <span class="n">jsonable_encoder</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi.security</span> <span class="kn">import</span> <span class="n">OAuth2PasswordRequestForm</span>

<span class="kn">from</span> <span class="nn">tortoise.contrib.fastapi</span> <span class="kn">import</span> <span class="n">HTTPNotFoundError</span>

<span class="kn">import</span> <span class="nn">src.crud.users</span> <span class="k">as</span> <span class="nn">crud</span>
<span class="kn">from</span> <span class="nn">src.auth.users</span> <span class="kn">import</span> <span class="n">validate_user</span>
<span class="kn">from</span> <span class="nn">src.schemas.token</span> <span class="kn">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserInSchema</span><span class="p">,</span> <span class="n">UserOutSchema</span>

<span class="kn">from</span> <span class="nn">src.auth.jwthandler</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_access_token</span><span class="p">,</span>
    <span class="n">get_current_user</span><span class="p">,</span>
    <span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/register"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserOutSchema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserInSchema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserOutSchema</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">"Incorrect username or password"</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"WWW-Authenticate"</span><span class="p">:</span> <span class="s2">"Bearer"</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="n">access_token_expires</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span><span class="p">)</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">"sub"</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">},</span> <span class="n">expires_delta</span><span class="o">=</span><span class="n">access_token_expires</span>
    <span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">jsonable_encoder</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"You've successfully logged in. Welcome back!"</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="s2">"Authorization"</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
        <span class="n">expires</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">"Lax"</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">"/users/whoami"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserOutSchema</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_users_me</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">current_user</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">"/user/</span><span class="si">{user_id}</span><span class="s2">"</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Status</span><span class="p">,</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span><span class="mi">404</span><span class="p">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="p">:</span> <span class="n">HTTPNotFoundError</span><span class="p">}},</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Status</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</code></pre></div>

<p>这里发生了什么事？</p>
<ol>
<li><code>get_current_user</code>隶属于<code>read_users_me</code>和<code>delete_user</code>以保护航线。除非用户以<code>current_user</code>身份登录，否则他们将无法访问它们。</li>
<li><code>/register</code>利用<code>crud.create_user</code>助手创建一个新用户并将其添加到数据库中。</li>
<li><code>/login</code>通过来自<code>OAuth2PasswordRequestForm</code>的包含用户名和密码的表单数据接收用户。然后，它调用用户的<code>validate_user</code>函数，或者在<code>None</code>时抛出异常。从<code>create_access_token</code>函数生成一个访问令牌，然后作为cookie附加到响应头。</li>
<li><code>/users/whoami</code>接收<code>get_current_user</code>并返回结果作为响应。</li>
<li><code>/user/{user_id}</code>是一个动态路由，它接收<code>user_id</code>并将其与来自<code>current_user</code>的结果一起发送给<code>crud.delete_user</code>助手。</li>
</ol>
<p><code>OAuth2PasswordRequestForm</code>需要<a href="http://andrew-d.github.io/python-multipart/"> Python-Multipart </a>。添加到<em>services/back end/requirements . txt</em>:</p>
<div class="codehilite"><pre><span/><code>aerich==0.7.1
asyncpg==0.27.0
bcrypt==4.0.1
passlib==1.7.4
fastapi==0.88.0
python-jose==3.3.0
python-multipart==0.0.5
tortoise-orm==0.19.2
uvicorn==0.20.0
</code></pre></div>

<p>在用户成功认证后，通过响应头中的<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie"> Set-cookie </a>发送回一个Cookie。当用户发出后续请求时，它被附加到请求头。</p>
<p>注意到:</p>
<div class="codehilite"><pre><span/><code><span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
    <span class="s2">"Authorization"</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">max_age</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
    <span class="n">expires</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
    <span class="n">samesite</span><span class="o">=</span><span class="s2">"Lax"</span><span class="p">,</span>
    <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>cookie的名称是<code>Authorization</code>，值是<code>Bearer {token}</code>，而<code>token</code>是实际的令牌。它在1800秒(30分钟)后过期。</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">为了安全起见，httponly </a>被设置为<code>True</code>，这样客户端脚本将无法访问cookie。这有助于防止<a href="https://owasp.org/www-community/attacks/xss/">跨站脚本</a> (XSS)攻击。</li>
<li>当<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite"> samesite </a>设置为<code>Lax</code>时，浏览器只在<em>一些</em> HTTP请求上发送cookies。这有助于防止<a href="https://owasp.org/www-community/attacks/csrf">跨站点请求伪造</a> (CSRF)攻击。</li>
<li>最后，<code>secure</code>被设置为<code>False</code>,因为我们将在本地测试，没有HTTPS。确保在生产中将此设置为<code>True</code>。</li>
</ol>
<p><em> notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">tortoise.contrib.fastapi</span> <span class="kn">import</span> <span class="n">HTTPNotFoundError</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="n">DoesNotExist</span>

<span class="kn">import</span> <span class="nn">src.crud.notes</span> <span class="k">as</span> <span class="nn">crud</span>
<span class="kn">from</span> <span class="nn">src.auth.jwthandler</span> <span class="kn">import</span> <span class="n">get_current_user</span>
<span class="kn">from</span> <span class="nn">src.schemas.notes</span> <span class="kn">import</span> <span class="n">NoteOutSchema</span><span class="p">,</span> <span class="n">NoteInSchema</span><span class="p">,</span> <span class="n">UpdateNote</span>
<span class="kn">from</span> <span class="nn">src.schemas.token</span> <span class="kn">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">src.schemas.users</span> <span class="kn">import</span> <span class="n">UserOutSchema</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">"/notes"</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">NoteOutSchema</span><span class="p">],</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_notes</span><span class="p">():</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get_notes</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">"/note/</span><span class="si">{note_id}</span><span class="s2">"</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">NoteOutSchema</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">"Note does not exist"</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">"/notes"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteOutSchema</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span>
    <span class="n">note</span><span class="p">:</span> <span class="n">NoteInSchema</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">create_note</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
    <span class="s2">"/note/</span><span class="si">{note_id}</span><span class="s2">"</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">NoteOutSchema</span><span class="p">,</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span><span class="mi">404</span><span class="p">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="p">:</span> <span class="n">HTTPNotFoundError</span><span class="p">}},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span>
    <span class="n">note_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">note</span><span class="p">:</span> <span class="n">UpdateNote</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoteOutSchema</span><span class="p">:</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">update_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">"/note/</span><span class="si">{note_id}</span><span class="s2">"</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Status</span><span class="p">,</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span><span class="mi">404</span><span class="p">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="p">:</span> <span class="n">HTTPNotFoundError</span><span class="p">}},</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span>
    <span class="n">note_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserOutSchema</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">delete_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</code></pre></div>

<p>自己复习一下这个。</p>
<p>最后，我们需要在<em> main.py </em>中连接我们的路线:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.middleware.cors</span> <span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span> <span class="nn">tortoise</span> <span class="kn">import</span> <span class="n">Tortoise</span>

<span class="kn">from</span> <span class="nn">src.database.register</span> <span class="kn">import</span> <span class="n">register_tortoise</span>
<span class="kn">from</span> <span class="nn">src.database.config</span> <span class="kn">import</span> <span class="n">TORTOISE_ORM</span>


<span class="c1"># enable schemas to read relationship between models</span>
<span class="n">Tortoise</span><span class="o">.</span><span class="n">init_models</span><span class="p">([</span><span class="s2">"src.database.models"</span><span class="p">],</span> <span class="s2">"models"</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">import 'from src.routes import users, notes' must be after 'Tortoise.init_models'</span>
<span class="sd">why?</span>
<span class="sd">https://stackoverflow.com/questions/65531387/tortoise-orm-for-python-no-returns-relations-of-entities-pyndantic-fastapi</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">src.routes</span> <span class="kn">import</span> <span class="n">users</span><span class="p">,</span> <span class="n">notes</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"http://localhost:8080"</span><span class="p">],</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>

<span class="n">register_tortoise</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TORTOISE_ORM</span><span class="p">,</span> <span class="n">generate_schemas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"Hello, World!"</span>
</code></pre></div>

<p>更新映像以安装新的依赖项:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://localhost:5000/docs">http://localhost:5000/docs</a>查看Swagger UI:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/swagger.png" loading="lazy" class="lazyload" alt="Swagger UI" src="../Images/0dc502bfc8e452f804e33fa6705338fa.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/swagger.png"/></p>
<p>现在，您可以手动测试每条路线。</p>
<p>你应该测试什么？</p>
<table>
<thead>
<tr>
<th>途径</th>
<th>方法</th>
<th>快乐之路</th>
<th>不愉快的道路</th>
</tr>
</thead>
<tbody>
<tr>
<td>/注册</td>
<td>邮政</td>
<td>您可以注册新用户</td>
<td>重复的用户名，缺少用户名或密码字段</td>
</tr>
<tr>
<td>/登录</td>
<td>邮政</td>
<td>您可以让用户登录</td>
<td>用户名或密码不正确</td>
</tr>
<tr>
<td>/用户/whoami</td>
<td>得到</td>
<td>验证后返回用户信息</td>
<td>没有<code>Authorization</code> cookie或令牌无效</td>
</tr>
<tr>
<td>/user/{user_id}</td>
<td>删除</td>
<td>您可以在鉴定后删除用户，并且您正在尝试删除当前用户</td>
<td>找不到用户，用户存在但无权删除</td>
</tr>
<tr>
<td>/备注</td>
<td>得到</td>
<td>通过验证后，您可以获得所有笔记</td>
<td>未认证</td>
</tr>
<tr>
<td>/备注</td>
<td>邮政</td>
<td>经过验证后，您可以添加注释</td>
<td>未认证</td>
</tr>
<tr>
<td>/note/{note_id}</td>
<td>得到</td>
<td>当经过验证并且它存在时，您可以获得该便笺</td>
<td>未验证，已验证，但便条不存在</td>
</tr>
<tr>
<td>/note/{note_id}</td>
<td>删除</td>
<td>当通过身份验证、注释存在并且当前用户创建了注释时，您可以删除注释</td>
<td>未验证，已验证但笔记不存在，不存在但未授权删除</td>
</tr>
<tr>
<td>/note/{note_id}</td>
<td>修补</td>
<td>当经过身份验证、注释存在且当前用户创建了注释时，您可以更新注释</td>
<td>未验证，已验证，但注释不存在，不存在但未授权更新</td>
</tr>
</tbody>
</table>
<blockquote>
<p>这需要大量繁琐的手工测试。用pytest添加自动化测试是一个好主意。再次回顾<a href="/blog/fastapi-crud/">使用FastAPI和Pytest </a>开发和测试异步API，以获得这方面的帮助。</p>
</blockquote>
<p>说到这里，让我们把注意力转向前端。</p>
<h2 id="vuex">武契特</h2>
<p><a href="https://vuex.vuejs.org/"> Vuex </a>是Vue的状态管理模式和库。它全局管理状态。在Vuex中，<a href="https://vuex.vuejs.org/guide/mutations.html">突变</a>，由<a href="https://vuex.vuejs.org/guide/actions.html">动作</a>调用，用于改变状态。</p>
<p>在“服务/前端/src”中添加一个名为“store”的新文件夹。在“存储”中，添加以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>services/frontend/src/store
├── index.js
└── modules
    ├── notes.js
    └── users.js
</code></pre></div>

<p><em>服务/前端/src/商店/索引. js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createStore</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"vuex"</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">notes</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./modules/notes'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./modules/users'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">createStore</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">modules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">notes</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">users</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>这里，我们用两个模块创建了一个新的Vuex商店，<em> notes.js </em>和<em> users.js </em>。</p>
<p><em>服务/前端/src/商店/模块/notes.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">note</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">getters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">stateNotes</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">stateNote</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">note</span><span class="p">,</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createNote</span><span class="p">({</span><span class="nx">dispatch</span><span class="p">},</span><span class="w"> </span><span class="nx">note</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">,</span><span class="w"> </span><span class="nx">note</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'getNotes'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getNotes</span><span class="p">({</span><span class="nx">commit</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">commit</span><span class="p">(</span><span class="s1">'setNotes'</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">viewNote</span><span class="p">({</span><span class="nx">commit</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`note/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">commit</span><span class="p">(</span><span class="s1">'setNote'</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="c1">// eslint-disable-next-line no-empty-pattern</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateNote</span><span class="p">({},</span><span class="w"> </span><span class="nx">note</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="sb">`note/</span><span class="si">${</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">note</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="c1">// eslint-disable-next-line no-empty-pattern</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteNote</span><span class="p">({},</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="sb">`note/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">mutations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">setNotes</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">){</span><span class="w"/>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">notes</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">setNote</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">note</span><span class="p">){</span><span class="w"/>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">note</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">note</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">state</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">getters</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">actions</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">mutations</span><span class="w"/>
<span class="p">};</span><span class="w"/>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li><code>state</code>-<code>note</code>和<code>notes</code>都默认为<code>null</code>。它们将分别被更新为一个对象和一个对象数组。</li>
<li><code>getters</code> -检索<code>state.note</code>和<code>state.notes</code>的值。</li>
<li><code>actions</code> -每个动作都通过Axios进行HTTP调用，然后其中一些动作会产生副作用——例如，调用相关的突变来更新状态或不同的动作。</li>
<li><code>mutations</code> -两者都对状态进行更改，从而更新<code>state.note</code>和<code>state.notes</code>。</li>
</ol>
<p><em>服务/前端/src/商店/模块/用户. js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">getters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">isAuthenticated</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!!</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">stateUser</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">register</span><span class="p">({</span><span class="nx">dispatch</span><span class="p">},</span><span class="w"> </span><span class="nx">form</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'register'</span><span class="p">,</span><span class="w"> </span><span class="nx">form</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">UserForm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="nx">UserForm</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span><span class="w"> </span><span class="nx">form</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">UserForm</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span><span class="w"> </span><span class="nx">form</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'logIn'</span><span class="p">,</span><span class="w"> </span><span class="nx">UserForm</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">logIn</span><span class="p">({</span><span class="nx">dispatch</span><span class="p">},</span><span class="w"> </span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'login'</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'viewMe'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">viewMe</span><span class="p">({</span><span class="nx">commit</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'users/whoami'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">commit</span><span class="p">(</span><span class="s1">'setUser'</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="c1">// eslint-disable-next-line no-empty-pattern</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteUser</span><span class="p">({},</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="sb">`user/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">logOut</span><span class="p">({</span><span class="nx">commit</span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">commit</span><span class="p">(</span><span class="s1">'logout'</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">mutations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">setUser</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">username</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">logout</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">){</span><span class="w"/>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">};</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">state</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">getters</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">actions</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">mutations</span><span class="w"/>
<span class="p">};</span><span class="w"/>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li><code>isAuthenticated</code> -如果<code>state.user</code>不是<code>null</code>，则返回<code>true</code>，否则返回<code>false</code>。</li>
<li><code>stateUser</code> -返回<code>state.user</code>的值。</li>
<li><code>register</code>——向我们在后端创建的<code>/register</code>端点发送一个POST请求，创建一个<a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData"> FormData </a>实例，并将其分派给<code>logIn</code>动作，让注册用户登录。</li>
</ol>
<p>最后，将存储连接到<em>services/frontend/src/main . js</em>中的根实例:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="s1">'bootstrap/dist/css/bootstrap.css'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createApp</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"vue"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./App.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./router'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">store</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./store'</span><span class="p">;</span><span class="w"> </span><span class="c1">// New</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createApp</span><span class="p">(</span><span class="nx">App</span><span class="p">);</span><span class="w"/>

<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">withCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'http://localhost:5000/'</span><span class="p">;</span><span class="w">  </span><span class="c1">// the FastAPI backend</span><span class="w"/>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span><span class="w"/>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">store</span><span class="p">);</span><span class="w"> </span><span class="c1">// New</span><span class="w"/>
<span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s2">"#app"</span><span class="p">);</span><span class="w"/>
</code></pre></div>

<h2 id="components-views-and-routes">零部件、视图和管线</h2>
<p>接下来，我们将开始添加组件和视图。</p>
<h3 id="components">成分</h3>
<h4 id="navbar">导航条</h4>
<p><em>服务/前端/src/组件/NavBar.vue </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar navbar-expand-md navbar-dark bg-dark"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar-brand"</span> <span class="na">href</span><span class="o">=</span><span class="s">"/"</span><span class="p">&gt;</span>FastAPI + Vue<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar-toggler"</span> <span class="na">type</span><span class="o">=</span><span class="s">"button"</span> <span class="na">data-bs-toggle</span><span class="o">=</span><span class="s">"collapse"</span> <span class="na">data-bs-target</span><span class="o">=</span><span class="s">"#navbarCollapse"</span> <span class="na">aria-controls</span><span class="o">=</span><span class="s">"navbarCollapse"</span> <span class="na">aria-expanded</span><span class="o">=</span><span class="s">"false"</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">"Toggle navigation"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar-toggler-icon"</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id</span><span class="o">=</span><span class="s">"navbarCollapse"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"isLoggedIn"</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar-nav me-auto mb-2 mb-md-0"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/"</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/dashboard"</span><span class="p">&gt;</span>Dashboard<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/profile"</span><span class="p">&gt;</span>My Profile<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"logout"</span><span class="p">&gt;</span>Log Out<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">v-else</span> <span class="na">class</span><span class="o">=</span><span class="s">"navbar-nav me-auto mb-2 mb-md-0"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/"</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/register"</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-item"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">class</span><span class="o">=</span><span class="s">"nav-link"</span> <span class="na">to</span><span class="o">=</span><span class="s">"/login"</span><span class="p">&gt;</span>Log In<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'NavBar'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">isLoggedIn</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">getters</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">logout</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'logOut'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span> <span class="na">scoped</span><span class="p">&gt;</span><span class="w"/>
<span class="nt">a</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div>

<p><code>NavBar</code>用于导航到应用程序中的其他页面。<code>isLoggedIn</code>属性用于检查用户是否从商店登录。如果他们已登录，他们可以访问仪表板和简档，包括注销链接。</p>
<p><code>logout</code>函数分派<code>logOut</code>动作并将用户重定向到<code>/login</code>路线。</p>
<h4 id="app">应用</h4>
<p>接下来，让我们将<code>NavBar</code>组件添加到主<code>App</code>组件中。</p>
<p><em>服务/前端/src/app . view</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"app"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">NavBar</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"main container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">router-view</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="c1">// @ is an alias to /src</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">NavBar</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/components/NavBar.vue'</span><span class="w"/>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">components</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">NavBar</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span><span class="w"/>
<span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Avenir</span><span class="p">,</span><span class="w"> </span><span class="n">Helvetica</span><span class="p">,</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kp">-webkit-</span><span class="n">font-smoothing</span><span class="p">:</span><span class="w"> </span><span class="n">antialiased</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kp">-moz-</span><span class="n">osx-font-smoothing</span><span class="p">:</span><span class="w"> </span><span class="n">grayscale</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#2c3e50</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">.</span><span class="nc">main</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">padding-top</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">em</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div>

<p>您现在应该可以在<a href="http://localhost:8080/"> http://localhost:8080/ </a>看到新的导航栏。</p>
<h3 id="views">视图</h3>
<h4 id="home">主页</h4>
<p><em>services/frontend/src/views/home view . vue</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This site is built with FastAPI and Vue.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"isLoggedIn"</span> <span class="na">id</span><span class="o">=</span><span class="s">"logout"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">"logout"</span><span class="p">&gt;</span>Click <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/dashboard"</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> to view all notes.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">v-else</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/register"</span><span class="p">&gt;</span>Register<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span> or <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"/login"</span><span class="p">&gt;</span>Log In<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'HomeView'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">isLoggedIn</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">getters</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>在这里，根据<code>isLoggedIn</code>属性的值，向最终用户显示所有注释的链接或注册/登录的链接。</p>
<p>接下来，将视图连接到我们在<em>services/frontend/src/router/index . js</em>中的路由:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>导航到<a href="http://localhost:8080/"> http://localhost:8080/ </a>。您应该看到:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/home.png" loading="lazy" class="lazyload" alt="home" src="../Images/4b088c9057c011c04289eb680e042226.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/home.png"/></p>
<h4 id="register">注册</h4>
<p><em>服务/前端/src/views/RegisterView.vue </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="err">@</span><span class="na">submit</span><span class="err">.</span><span class="na">prevent</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"username"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"username"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"user.username"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"full_name"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Full Name:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"full_name"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"user.full_name"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"password"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Password:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="na">name</span><span class="o">=</span><span class="s">"password"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"user.password"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">full_name</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'register'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">submit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/dashboard'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="s1">'Username already exists. Please try again.'</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>表单接受用户名、全名和密码，所有这些都是<code>user</code>对象的属性。通过<a href="https://vuex.vuejs.org/api/#mapactions"> mapActions </a>将<code>Register</code>动作映射(导入)到组件中。然后，<code>this.Register</code>被调用并传递给<code>user</code>对象。如果结果是成功的，用户将被重定向到<code>/dashboard</code>。</p>
<p>更新路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>测试<a href="http://localhost:8080/register">http://localhost:8080/register</a>，确保可以注册新用户。</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/register.png" loading="lazy" class="lazyload" alt="register" src="../Images/a539416cba8e376d193c952894397250.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/register.png"/></p>
<h4 id="login">注册</h4>
<p><em>services/frontend/src/views/loginvue . vue</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="err">@</span><span class="na">submit</span><span class="err">.</span><span class="na">prevent</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"username"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"username"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"form.username"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"password"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Password:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="na">name</span><span class="o">=</span><span class="s">"password"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"form.password"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">form</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">password</span><span class="o">:</span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'logIn'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">submit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span><span class="w"/>
<span class="w">      </span><span class="nx">User</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="nx">User</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">User</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/dashboard'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>在提交时，调用<code>logIn</code>动作。如果成功，用户将被重定向到<code>/dashboard</code>。</p>
<p>更新路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">LoginView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>测试<a href="http://localhost:8080/login">http://localhost:8080/log in</a>，确保可以让注册用户登录。</p>
<h4 id="dashboard">仪表盘</h4>
<p><em>services/frontend/src/views/dashboard view . vue</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Add new note<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>

      <span class="p">&lt;</span><span class="nt">form</span> <span class="err">@</span><span class="na">submit</span><span class="err">.</span><span class="na">prevent</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"title"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Title:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"title"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"form.title"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"content"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Content:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">textarea</span>
            <span class="na">name</span><span class="o">=</span><span class="s">"content"</span>
            <span class="na">v-model</span><span class="o">=</span><span class="s">"form.content"</span>
            <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span>
          <span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>

    <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Notes<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>

      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"notes.length"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-for</span><span class="o">=</span><span class="s">"note in notes"</span> <span class="na">:key</span><span class="o">=</span><span class="s">"note.id"</span> <span class="na">class</span><span class="o">=</span><span class="s">"notes"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"card"</span> <span class="na">style</span><span class="o">=</span><span class="s">"width: 18rem;"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"card-body"</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Note Title:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> {{ note.title }}<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Author:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> {{ note.author.username }}<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">router-link</span> <span class="na">:to</span><span class="o">=</span><span class="s">"{name: 'Note', params:{id: note.id}}"</span><span class="p">&gt;</span>View<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-else</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Nothing to see. Check back later.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapGetters</span><span class="p">,</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">form</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'getNotes'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapGetters</span><span class="p">({</span><span class="w"> </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="s1">'stateNotes'</span><span class="p">}),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'createNote'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">submit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createNote</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>仪表板显示来自API的所有注释，还允许用户创建新注释。注意到:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">:to</span><span class="o">=</span><span class="s">"{name: 'Note', params:{id: note.id}}"</span><span class="p">&gt;</span>View<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
</code></pre></div>

<p>我们将很快在这里配置路由和视图，但要注意的关键是，路由接收注释ID，并将用户发送到相应的路由——例如，<code>note/1</code>、<code>note/2</code>、<code>note/10</code>、<code>note/101</code>等等。</p>
<p>在创建组件的过程中调用<code>created</code>函数，该函数与组件<a href="https://vuejs.org/guide/essentials/lifecycle.html">生命周期</a>挂钩。在其中，我们称映射的<code>getNotes</code>动作。</p>
<p>路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">DashboardView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/DashboardView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">LoginView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">DashboardView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>确保在您注册或登录后，您会被重定向到仪表板，并且它现在会正确显示:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/dashboard.png" loading="lazy" class="lazyload" alt="dashboard" src="../Images/9f0f7c66456b185785f745f4fe65d61c.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/dashboard.png"/></p>
<h4 id="profile">轮廓</h4>
<p><em>服务/前端/src/视图/ProfileView.vue </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Your Profile<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Full Name:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{ user.full_name }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Username:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{ user.username }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">button</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"deleteAccount()"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Delete Account<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapGetters</span><span class="p">,</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Profile'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'viewMe'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapGetters</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="s1">'stateUser'</span><span class="w"> </span><span class="p">}),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'deleteUser'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteAccount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">deleteUser</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'logOut'</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>“删除帐户”按钮调用<code>deleteUser</code>，它将<code>user.id</code>发送给<code>deleteUser</code>动作，注销用户，然后将用户重定向回主页。</p>
<p>路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">DashboardView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/DashboardView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ProfileView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/ProfileView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">LoginView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">DashboardView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">ProfileView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>确保您可以在<a href="http://localhost:8080/profile">http://localhost:8080/profile</a>查看您的个人资料。也测试一下删除功能。</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/profile.png" loading="lazy" class="lazyload" alt="profile" src="../Images/432bf1f211609d81f0b7f6176858b390.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/profile.png"/></p>
<h4 id="note">注意</h4>
<p><em>服务/前端/src/views/NoteView.vue </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"note"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Title:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> {{ note.title }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Content:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> {{ note.content }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Author:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span> {{ note.author.username }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">v-if</span><span class="o">=</span><span class="s">"user.id === note.author.id"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">router-link</span> <span class="na">:to</span><span class="o">=</span><span class="s">"{name: 'EditNote', params:{id: note.id}}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Edit<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">button</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">"removeNote()"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-secondary"</span><span class="p">&gt;</span>Delete<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>


<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapGetters</span><span class="p">,</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Note'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">created</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">viewNote</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/dashboard'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapGetters</span><span class="p">({</span><span class="w"> </span><span class="nx">note</span><span class="o">:</span><span class="w"> </span><span class="s1">'stateNote'</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="s1">'stateUser'</span><span class="p">}),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'viewNote'</span><span class="p">,</span><span class="w"> </span><span class="s1">'deleteNote'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">removeNote</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">deleteNote</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/dashboard'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>该视图加载从路由中作为属性传递给它的任何注释ID的注释细节。</p>
<p>在创建的生命周期挂钩中，我们从商店的<code>props</code>向<code>viewNote</code>动作传递了<code>id</code>。<code>stateUser</code>和<code>stateNote</code>通过<a href="https://vuex.vuejs.org/api/#mapgetters">映射器</a>映射到组件中，分别为<code>user</code>和<code>note</code>。“Delete”按钮触发了<code>deleteNote</code>方法，该方法依次调用<code>deleteNote</code>动作并将用户重定向回<code>/dashboard</code>路线。</p>
<p>只有当<code>note.author</code>与登录用户相同时，我们才使用if语句来显示“编辑”和“删除”按钮。</p>
<p>路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">DashboardView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/DashboardView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ProfileView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/ProfileView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">NoteView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/NoteView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">LoginView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">DashboardView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">ProfileView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/note/:id'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Note'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">NoteView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>因为这个路由是动态的，所以我们将<code>props</code>设置为<code>true</code>,以便将注释ID作为一个属性从URL传递给视图。</p>
<h4 id="editnote">EditNote</h4>
<p><em>services/frontend/src/views/editnoteview . vue</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Edit note<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>

    <span class="p">&lt;</span><span class="nt">form</span> <span class="err">@</span><span class="na">submit</span><span class="err">.</span><span class="na">prevent</span><span class="o">=</span><span class="s">"submit"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"title"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Title:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"title"</span> <span class="na">v-model</span><span class="o">=</span><span class="s">"form.title"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"mb-3"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"content"</span> <span class="na">class</span><span class="o">=</span><span class="s">"form-label"</span><span class="p">&gt;</span>Content:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">textarea</span>
          <span class="na">name</span><span class="o">=</span><span class="s">"content"</span>
          <span class="na">v-model</span><span class="o">=</span><span class="s">"form.content"</span>
          <span class="na">class</span><span class="o">=</span><span class="s">"form-control"</span>
        <span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Submit<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineComponent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mapGetters</span><span class="p">,</span><span class="w"> </span><span class="nx">mapActions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vuex'</span><span class="p">;</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">defineComponent</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'EditNote'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">form</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">GetNote</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">computed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapGetters</span><span class="p">({</span><span class="w"> </span><span class="nx">note</span><span class="o">:</span><span class="w"> </span><span class="s1">'stateNote'</span><span class="w"> </span><span class="p">}),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="s1">'updateNote'</span><span class="p">,</span><span class="w"> </span><span class="s1">'viewNote'</span><span class="p">]),</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">submit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">note</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">form</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="p">};</span><span class="w"/>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">updateNote</span><span class="p">(</span><span class="nx">note</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Note'</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">}});</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">GetNote</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">viewNote</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/dashboard'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>该视图显示一个预加载的表单，其中包含注释标题和内容，供作者编辑和更新。类似于<code>Note</code>视图，注释的<code>id</code>作为道具从路由器对象传递到页面。</p>
<p><code>getNote</code>方法用于加载带有注释信息的表单。它将<code>id</code>传递给<code>viewNote</code>动作，并使用<code>note</code> getter值来填充表单。当创建组件时，调用<code>getNote</code>函数。</p>
<p>路由器:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">DashboardView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/DashboardView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ProfileView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/ProfileView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">NoteView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/NoteView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">EditNoteView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/EditNoteView.vue'</span><span class="p">;</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"Home"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">HomeView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Register'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">RegisterView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Login'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">LoginView</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dashboard'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">DashboardView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Profile'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">ProfileView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/note/:id'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'Note'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">NoteView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'/editnote/:id'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">'EditNote'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="nx">EditNoteView</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requiresAuth</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>从仪表板中，添加新注释:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/add_note.png" loading="lazy" class="lazyload" alt="add_note" src="../Images/eacfce78be91fd68c621c36aee7e8015.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/add_note.png"/></p>
<p>然后，单击链接查看新的便笺。确保“编辑”和“删除”按钮仅在登录用户是便笺创建者时显示:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-vue/note.png" loading="lazy" class="lazyload" alt="note" src="../Images/af4f0fa680da887e87eba784807e02d4.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-vue/note.png"/></p>
<p>此外，在继续之前，请确保您还可以编辑和删除注释。</p>
<h2 id="unauthorized-users-and-expired-tokens">未授权用户和过期令牌</h2>
<h3 id="unauthorized-users">未经授权的用户</h3>
<p>您是否注意到有些路线附带了<code>meta: {requiresAuth: true},</code>？未经验证的用户不应该访问这些路由。</p>
<p>例如，如果您在未通过身份验证的情况下导航到<a href="http://localhost:8080/profile">http://localhost:8080/profile</a>，会发生什么？您应该能够查看页面，但没有数据加载，对不对？让我们改变一下，让用户被重定向到<code>/login</code>路线。</p>
<p>所以，为了防止未经授权的访问，让我们给<em>services/frontend/src/router/index . js</em>添加一个<a href="https://router.vuejs.org/guide/advanced/navigation-guards.html">导航守卫</a>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'vue-router'</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">HomeView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/HomeView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">RegisterView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/RegisterView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">LoginView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/LoginView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">DashboardView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/DashboardView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ProfileView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/ProfileView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">NoteView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/NoteView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">EditNoteView</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/views/EditNoteView.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">store</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@/store'</span><span class="p">;</span><span class="w"> </span><span class="c1">// NEW</span><span class="w"/>


<span class="kd">const</span><span class="w"> </span><span class="nx">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">...</span><span class="w"/>
<span class="p">]</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createRouter</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="nx">createWebHistory</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="nx">routes</span><span class="w"/>
<span class="p">})</span><span class="w"/>

<span class="c1">// NEW</span><span class="w"/>
<span class="nx">router</span><span class="p">.</span><span class="nx">beforeEach</span><span class="p">((</span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">record</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">requiresAuth</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getters</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">next</span><span class="p">();</span><span class="w"/>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">next</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">router</span><span class="w"/>
</code></pre></div>

<p>注销。然后，再次测试<a href="http://localhost:8080/profile">http://localhost:8080/profile</a>。您应该被重新引导回<code>/login</code>路线。</p>
<h3 id="expired-tokens">过期令牌</h3>
<p>请记住，令牌会在三十分钟后过期:</p>
<div class="codehilite"><pre><span/><code><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
</code></pre></div>

<p>发生这种情况时，用户应该被注销并重定向到登录页面。为了处理这个问题，让我们给<em>服务/前端/src/main.js </em>添加一个Axios <a href="https://axios-http.com/docs/interceptors">拦截器</a>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="s1">'bootstrap/dist/css/bootstrap.css'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createApp</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"vue"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'axios'</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./App.vue'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./router'</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">store</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./store'</span><span class="p">;</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createApp</span><span class="p">(</span><span class="nx">App</span><span class="p">);</span><span class="w"/>

<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">withCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'http://localhost:5000/'</span><span class="p">;</span><span class="w">  </span><span class="c1">// the FastAPI backend</span><span class="w"/>

<span class="c1">// NEW</span><span class="w"/>
<span class="nx">axios</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">401</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">originalRequest</span><span class="p">.</span><span class="nx">_retry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">originalRequest</span><span class="p">.</span><span class="nx">_retry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'logOut'</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span><span class="w"/>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">store</span><span class="p">);</span><span class="w"/>
<span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s2">"#app"</span><span class="p">);</span><span class="w"/>
</code></pre></div>

<p>如果你想测试，把<code>ACCESS_TOKEN_EXPIRE_MINUTES = 30</code>改成类似<code>ACCESS_TOKEN_EXPIRE_MINUTES = 1</code>的。请记住，饼干本身仍可持续30分钟。是令牌过期了。</p>
<h2 id="conclusion">结论</h2>
<p>本教程涵盖了使用Vue和FastAPI设置CRUD应用程序的基础知识。除了这些应用程序，您还使用Docker来简化开发和添加身份验证。</p>
<p>从头开始回顾目标并应对下面的每个挑战，检查您的理解情况。</p>
<p>你可以在GitHub上的<a href="https://github.com/testdrivenio/fastapi-vue"> fastapi-vue </a> repo中找到源代码。干杯！</p>
<p>--</p>
<blockquote>
<p><strong>寻找更多？</strong></p>
<ol>
<li>测试所有的东西。别黑了。开始确保您的应用程序按预期工作。需要帮助吗？查看以下资源:</li>
<li>添加<a href="https://getbootstrap.com/docs/5.1/components/alerts/">警报</a>以向最终用户显示正确的成功和错误消息。查看来自<a href="/blog/developing-a-single-page-app-with-flask-and-vuejs">用Flask和Vue.js开发单页应用</a>的<a href="https://testdriven.io/blog/developing-a-single-page-app-with-flask-and-vuejs/#alert-component">警报组件</a>部分，了解更多关于用Bootstrap和Vue设置警报的信息。</li>
<li>向后端添加一个新的端点，当用户注销时会调用这个端点来更新cookie <a href="https://stackoverflow.com/a/5285982/1799408">，就像这样</a>。</li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>