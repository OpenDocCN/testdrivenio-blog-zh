<html>
<head>
<title>Using Hypothesis and Schemathesis to Test FastAPI </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用假设和图式测试FastAPI</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/fastapi-hypothesis/#0001-01-01">https://testdriven.io/blog/fastapi-hypothesis/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>测试是开发软件的必要部分。具有高测试覆盖率的软件项目从来都不是完美的，但是它是软件质量的一个很好的初始指示器。为了鼓励测试的编写，测试应该有趣且易于编写。它们也应该像代码库中的其他代码一样被小心对待。因此，在添加新测试时，您需要考虑维护测试套件的成本。在可读性和可维护性之间取得平衡，同时确保测试覆盖广泛的场景并不容易</p>
<p>在本文中，我们将看看基于属性的测试是如何帮助解决这个问题的。我们首先来看看什么是基于属性的测试，以及为什么你可能想要使用它。然后，我们将展示如何使用<a href="https://hypothesis.works/">假设</a>和<a href="https://schemathesis.readthedocs.io/">模式</a>对FastAPI应用基于属性的测试。</p>



<h2 id="property-based-testing">基于属性的测试</h2>
<p>什么是基于属性的测试？</p>
<p><a href="https://hypothesis.works/articles/what-is-property-based-testing/">基于属性的测试</a>基于给定函数或程序的属性。这些测试有助于确保被测试的函数或程序符合其属性。</p>
<h3 id="benefits">利益</h3>
<p>为什么要使用基于属性的测试？</p>
<ol>
<li><strong>作用域</strong>:基于属性的测试不需要为每个要测试的参数编写不同的测试用例，而是允许您为单个测试中的每个参数测试一系列参数。这有助于提高测试套件的稳健性，同时减少测试冗余。简而言之，您的测试代码将更干净、更DRY，并且总体上更高效，同时更有效，因为您将能够更容易地测试所有这些边缘情况。</li>
<li><strong> Reproducibility </strong>:测试代理保存测试用例以及它们的结果，在失败的情况下，这些结果可以用于重现和重放测试。</li>
</ol>
<p>让我们看一个简单的例子来说明这一点:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Number must be &gt;= 0"</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">*=</span> <span class="n">_</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="c1"># test</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_factorial_less_than_0</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">test_factorial</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5040</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">479001600</span>
    <span class="k">assert</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2658271574788448768043625811014615890319638528000000000</span>
</code></pre></div>

<p>这有什么不好？</p>
<ol>
<li>测试用例写起来很无聊</li>
<li>很难找到随机的、无偏见的测试例子</li>
<li>测试套件的大小会迅速膨胀，因此很难阅读和维护</li>
<li>还是那句话，没意思！</li>
<li>很难充实边缘案例</li>
</ol>
<p>人类不应该在这上面浪费时间。这是最适合计算机完成的任务。</p>
<h2 id="property-based-testing-with-hypothesis">基于属性的假设测试</h2>
<p><a href="https://hypothesis.readthedocs.io/en/latest/">假设</a>是在Python中进行基于属性的测试的工具。假设使得编写测试和找到所有边缘案例变得容易。</p>
<blockquote>
<p>它的工作原理是生成与您的规格相匹配的任意数据，并检查您的保证在这种情况下仍然有效。如果它找到了一个没有的例子，它就把这个例子缩小，简化它，直到找到一个更小的例子，这个例子仍然会引起问题。然后它保存这个例子，以便以后一旦发现你的代码有问题，以后不会忘记。</p>
</blockquote>
<p>这里最重要的部分是所有失败的测试都将被尝试，即使错误已经被修复！</p>
<h3 id="quick-start">快速启动</h3>
<p>假设集成到您正常的pytest或unittest工作流中。</p>
<p>从安装库开始:</p>


<p>接下来，您需要定义一个<a href="https://hypothesis.readthedocs.io/en/latest/data.html?#core-strategies">策略</a>，这是一个生成随机数据的方法。</p>
<p>示例:</p>
<table>
<thead>
<tr>
<th>战略</th>
<th>它会产生什么</th>
</tr>
</thead>
<tbody>
<tr>
<td>二进制的</td>
<td>字节字符串</td>
</tr>
<tr>
<td>文本</td>
<td>用线串</td>
</tr>
<tr>
<td>整数</td>
<td>整数</td>
</tr>
<tr>
<td>漂浮物</td>
<td>漂浮物</td>
</tr>
<tr>
<td>分数</td>
<td>分数实例</td>
</tr>
</tbody>
</table>
<p>策略应该组合在一起，以生成复杂的测试输入数据。因此，与其编写和维护自己的数据生成器，不如让Hypothesis为您管理所有这些。</p>
<p>让我们将上面的<code>test_factorial</code>重构为一个基于属性的测试:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
<span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">integers</span>


<span class="nd">@given</span><span class="p">(</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_factorial</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">num</span> <span class="o">==</span> <span class="n">result</span>
</code></pre></div>

<blockquote>
<p>这个测试现在断言一个数的阶乘除以该数的阶乘减一就是原始数。</p>
</blockquote>
<p>在这里，我们将<a href="https://hypothesis.readthedocs.io/en/latest/data.html#hypothesis.strategies.integers">整数</a>策略传递给了<code>@given</code>装饰器，这是假设的入口点。这个装饰器本质上把测试函数变成了一个参数化的函数，这样当它被调用时，从策略生成的数据将被传递到测试中。</p>
<p>如果已经发现故障，假设使用<a href="https://hypothesis.readthedocs.io/en/latest/data.html#shrinking">收缩</a>来找到最小的故障情况。</p>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">Verbosity</span><span class="p">,</span> <span class="n">given</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>


<span class="nd">@settings</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">test_shrinking</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">2</span>
</code></pre></div>

<p>测试输出:</p>
<div class="codehilite"><pre><span/><code>...

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-4475302896957925906,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">2872</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-93,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">14443</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">56</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-13873,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">23519</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-91,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-93,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">0</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">0</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-29,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-13,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-5,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-1,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-2,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-4,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-3,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">3</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-3,
<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"shrinking.py"</span>, line <span class="m">8</span>, <span class="k">in</span> test_shrinking
    assert num &gt;<span class="o">=</span> -2
AssertionError

Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">0</span>,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-1,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-2,
<span class="o">)</span>
Trying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span><span class="m">3</span>,
<span class="o">)</span>
Falsifying example: test_shrinking<span class="o">(</span>
    <span class="nv">num</span><span class="o">=</span>-3,
<span class="o">)</span>
</code></pre></div>

<p>这里，我们针对整数池测试了表达式<code>num &gt;= -2</code>。假设从第一个失败案例<code>num = -4475302896957925906</code>开始，这是一个相当大的数字。然后收缩<code>num</code>的值，直到假设发现值<code>num = -3</code>是最小的失败案例。</p>
<h2 id="using-hypothesis-with-fastapi">对FastAPI使用假设</h2>
<p>假设已被证明是一个简单而强大的测试工具。让我们看看如何在FastAPI中使用它。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># server.py</span>

<span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/</span><span class="si">{s}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">homepage</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre></div>

<p>因此，<code>/api/{s}</code>路由接受一个名为<code>s</code>的URL参数，它应该是一个整数。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># test_server.py</span>

<span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>


<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">test_home</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">"/api/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">}</span>
</code></pre></div>

<p>就像之前我们使用<code>integers</code>策略生成随机整数，正的和负的，用于测试。</p>
<h2 id="schemathesis">图式</h2>
<p><a href="https://schemathesis.readthedocs.io/en/stable/">概要</a>是一个基于<a href="https://www.openapis.org/"> OpenAPI </a>和<a href="https://spec.graphql.org/June2018/"> GraphQL </a>规范的现代API测试工具。它使用幕后假设将基于属性的测试应用于API模式。换句话说，给定一个模式，Schemathesis可以自动为您生成测试用例。由于FastAPI是基于OpenAPI标准的，Schemathesis与它配合得很好。</p>
<p>如果您运行上面的<em> server.py </em>文件并导航到<a href="http://localhost:8000/openapi.json">http://localhost:8000/openapi . JSON</a>，您应该会看到由FastAPI生成的open API规范。它定义了所有的端点及其输入类型。使用这个规范，Schemathesis可以用来生成测试数据。</p>
<h3 id="quick-start-with-the-cli">使用CLI快速入门</h3>
<p>安装:</p>
<div class="codehilite"><pre><span/><code>$ pip install schemathesis
</code></pre></div>

<p>一旦安装完毕，运行测试最简单的方法就是通过<a href="https://schemathesis.readthedocs.io/en/stable/cli.html"> schemathesis </a>命令。当Uvicorn在一个终端窗口中运行时，打开一个新窗口并运行:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run http://localhost:8000/openapi.json
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code><span class="o">=========================</span> Schemathesis <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">========================</span>
Schema location: http://localhost:8000/openapi.json
Base URL: http://localhost:8000/
Specification version: Open API <span class="m">3</span>.0.2
Workers: <span class="m">1</span>
Collected API operations: <span class="m">1</span>

GET /api/<span class="o">{</span>s<span class="o">}</span> .                                                               <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=====================================</span> <span class="nv">SUMMARY</span> <span class="o">=====================================</span>

Performed checks:
    not_a_server_error                    <span class="m">100</span> / <span class="m">100</span> passed          <span class="nv">PASSED</span>

<span class="o">================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.61s <span class="o">================================</span>
</code></pre></div>

<p>请注意，这只针对<code>not_a_server_error</code>进行了检查。图式有五个内置的<a href="https://schemathesis.readthedocs.io/en/stable/cli.html#how-are-responses-checked">检查</a>:</p>
<ol>
<li><code>not_a_server_error</code>:响应具有5xx HTTP状态</li>
<li><code>status_code_conformance</code>:API模式中未定义响应状态</li>
<li><code>content_type_conformance</code>:API模式中未定义响应内容类型</li>
<li><code>response_schema_conformance</code>:响应内容不符合为此特定响应定义的模式</li>
<li><code>response_headers_conformance</code>:响应头不包含所有已定义的头。</li>
</ol>
<p>您可以使用<code>--checks all</code>选项执行所有内置检查:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run --checks all http://localhost:8000/openapi.json

<span class="o">=========================</span> Schemathesis <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">========================</span>
Schema location: http://localhost:8000/openapi.json
Base URL: http://localhost:8000/
Specification version: Open API <span class="m">3</span>.0.2
Workers: <span class="m">1</span>
Collected API operations: <span class="m">1</span>

GET /api/<span class="o">{</span>s<span class="o">}</span> .                                                               <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=====================================</span> <span class="nv">SUMMARY</span> <span class="o">=====================================</span>

Performed checks:
    not_a_server_error                              <span class="m">100</span> / <span class="m">100</span> passed          PASSED
    status_code_conformance                         <span class="m">100</span> / <span class="m">100</span> passed          PASSED
    content_type_conformance                        <span class="m">100</span> / <span class="m">100</span> passed          PASSED
    response_headers_conformance                    <span class="m">100</span> / <span class="m">100</span> passed          PASSED
    response_schema_conformance                     <span class="m">100</span> / <span class="m">100</span> passed          <span class="nv">PASSED</span>

<span class="o">================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.87s <span class="o">================================</span>
</code></pre></div>

<h3 id="additional-options">附加选项</h3>
<p>您可以测试一个<a href="https://schemathesis.readthedocs.io/en/stable/cli.html#testing-specific-operations">特定的端点</a>或HTTP方法，而不是整个应用程序:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run --endpoint /api/. http://localhost:8000/openapi.json

$ schemathesis run --method GET http://localhost:8000/openapi.json
</code></pre></div>

<p>最大响应时间可用于帮助充实可能降低端点速度的边缘情况。时间以毫秒为单位。</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run --max-response-time<span class="o">=</span><span class="m">50</span> HTTP://localhost:8000/openapi.json
</code></pre></div>

<p>您的一些端点需要授权吗？</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run -H <span class="s2">"Authorization: Bearer TOKEN"</span> http://localhost:8000/openapi.json

$ schemathesis run -H <span class="s2">"Authorization: ..."</span> -H <span class="s2">"X-API-Key: ..."</span> HTTP://localhost:8000/openapi.json
</code></pre></div>

<p>您可以使用多个工作人员来加快测试速度:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run --workers <span class="m">8</span> http://localhost:8000/openapi.json
</code></pre></div>

<p>通常，Schemathesis为每个端点生成随机数据。<a href="https://schemathesis.readthedocs.io/en/stable/stateful.html">状态测试</a>确保数据来自之前的测试/响应:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run --stateful<span class="o">=</span>links http://localhost:8000/openapi.json
</code></pre></div>

<p>最后，重放测试很简单，因为每个测试用例都与一个种子值相关联。当一个测试用例失败时，它会提供种子，这样您就可以重现失败的用例:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run http://localhost:8000/openapi.json

<span class="o">============================</span> Schemathesis <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">============================</span>
platform Darwin -- Python <span class="m">3</span>.10.6, schemathesis-3.17.2, hypothesis-6.54.4,
    hypothesis_jsonschema-0.22.0, jsonschema-4.15.0
rootdir: /hypothesis-examples
hypothesis profile <span class="s1">'default'</span> -&gt;
    <span class="nv">database</span><span class="o">=</span>DirectoryBasedExampleDatabase<span class="o">(</span><span class="s1">'/hypothesis-examples/.hypothesis/examples'</span><span class="o">)</span>
Schema location: http://localhost:8000/openapi.json
Base URL: http://localhost:8000/
Specification version: Open API <span class="m">3</span>.0.2
Workers: <span class="m">1</span>
collected endpoints: <span class="m">1</span>

GET /api/<span class="o">{</span>s<span class="o">}</span> F                                                                      <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">========================================</span> <span class="nv">FAILURES</span> <span class="o">========================================</span>
_____________________________________ GET: /api/<span class="o">{</span>s<span class="o">}</span> ______________________________________
<span class="m">1</span>. Received a response with 5xx status code: <span class="m">500</span>

Path parameters : <span class="o">{</span><span class="s1">'s'</span>: <span class="m">0</span><span class="o">}</span>

Run this Python code to reproduce this failure:
  requests.get<span class="o">(</span><span class="s1">'http://localhost:8000/api/0'</span>, <span class="nv">headers</span><span class="o">={</span><span class="s1">'User-Agent'</span>: <span class="s1">'schemathesis/2.6.0'</span><span class="o">})</span>

Or add this option to your <span class="nb">command</span> line parameters:
    --hypothesis-seed<span class="o">=</span><span class="nv">135947773389980684299156880789978283847</span>
<span class="o">========================================</span> <span class="nv">SUMMARY</span> <span class="o">=========================================</span>

Performed checks:
    not_a_server_error                    <span class="m">0</span> / <span class="m">3</span> passed          <span class="nv">FAILED</span>

<span class="o">===================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.10s <span class="o">====================================</span>
</code></pre></div>

<p>然后，要重现，运行:</p>
<div class="codehilite"><pre><span/><code>$ schemathesis run http://localhost:8000/openapi.json --hypothesis-seed<span class="o">=</span><span class="m">135947773389980684299156880789978283847</span>
</code></pre></div>

<h3 id="python-tests">Python测试</h3>
<p>您也可以在测试中使用模式:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">schemathesis</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">schemathesis</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="s2">"http://localhost:8000/openapi.json"</span><span class="p">)</span>


<span class="nd">@schema</span><span class="o">.</span><span class="n">parametrize</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test_api</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
    <span class="k">case</span><span class="o">.</span><span class="n">call_and_validate</span><span class="p">()</span>
</code></pre></div>

<p>Schemathesis还支持直接调用ASGI(即Uvicorn和Daphne)和WSGI(即Gunicorn和uWSGI)应用程序，而不是通过网络:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">schemathesis</span>
<span class="kn">from</span> <span class="nn">schemathesis.specs.openapi.loaders</span> <span class="kn">import</span> <span class="n">from_asgi</span>

<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">from_asgi</span><span class="p">(</span><span class="s2">"/openapi.json"</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>


<span class="nd">@schema</span><span class="o">.</span><span class="n">parametrize</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test_api</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">call_asgi</span><span class="p">()</span>
    <span class="k">case</span><span class="o">.</span><span class="n">validate_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>希望你能看到基于属性的测试有多强大。它可以使您的代码更加健壮，而不会降低样板测试代码的可读性。收缩以找到最简单的失败案例和重放等功能提高了工作效率。基于属性的测试将减少花费在编写手动测试上的时间，同时增加测试覆盖率。</p>
<p>像Hypothesis这样基于属性的测试工具应该是几乎所有Python工作流的一部分。Schemathesis用于基于OpenAPI标准的自动化API测试，这在与FastAPI等以API为中心的框架结合使用时非常有用。</p>
  </div>

  </div>    
</body>
</html>