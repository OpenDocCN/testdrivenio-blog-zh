<html>
<head>
<title>Centralized Logging with Django, Docker, and CloudWatch </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Django、Docker和CloudWatch进行集中日志记录</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-logging-cloudwatch/#0001-01-01">https://testdriven.io/blog/django-logging-cloudwatch/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>让我们看看如何配置运行在EC2实例上的容器化Django应用程序，以便将日志发送到<a href="https://aws.amazon.com/cloudwatch/"> Amazon CloudWatch </a>。</p>
<p><em>步骤</em>:</p>
<ol>
<li>创建IAM角色</li>
<li>将IAM角色附加到EC2实例</li>
<li>创建云观察日志组</li>
<li>在EC2实例上安装CloudWatch日志代理</li>
<li>配置Django日志记录</li>
<li>复合更新坞站</li>
</ol>





<h2 id="create-iam-role">创建IAM角色</h2>
<p>首先创建一个新的IAM角色，并附加<a href="https://github.com/SummitRoute/aws_managed_policies/blob/master/policies/CloudWatchAgentServerPolicy">CloudWatchAgentServerPolicy</a>策略，供Docker守护进程用来写入CloudWatch。</p>
<p>从<a href="https://console.aws.amazon.com/iam"> IAM控制台</a>中，选择“角色”并点击“创建角色”。在“常见用例”下选择“EC2”服务:</p>
<p><img data-src="/static/images/blog/django/django-logging-cloudwatch/iam_create_role1.png" loading="lazy" class="lazyload" alt="iam create new role" src="../Images/4c2ad1301eb1d6f40f3778cf2cb81df4.png" data-original-src="https://testdriven.io/static/images/blog/django/django-logging-cloudwatch/iam_create_role1.png"/></p>
<p>单击下一步按钮。</p>
<p>在“权限”页面上，搜索“CloudWatchAgentServerPolicy”策略，并选中复选框以附加它:</p>
<p><img data-src="/static/images/blog/django/django-logging-cloudwatch/iam_create_role2.png" loading="lazy" class="lazyload" alt="iam create new role" src="../Images/6c5d8a7f3c21ed6a2b55d9ef5ceefa1f.png" data-original-src="https://testdriven.io/static/images/blog/django/django-logging-cloudwatch/iam_create_role2.png"/></p>
<p>单击几次“下一步”。在审查页面上，输入一个角色名称-即<code>CloudWatchAgentRole</code> -然后创建该角色。</p>
<h2 id="attach-iam-role">附加IAM角色</h2>
<p>要将角色附加到EC2实例，导航到<a href="https://console.aws.amazon.com/ec2"> EC2仪表板</a>并选择实例。单击“操作”下拉菜单，选择“实例设置”，然后单击“附加/替换IAM角色”:</p>
<p><img data-src="/static/images/blog/django/django-logging-cloudwatch/attach_iam_role.png" loading="lazy" class="lazyload" alt="attach iam role" src="../Images/071337a4c09b548e64b73f46bc1f94d2.png" data-original-src="https://testdriven.io/static/images/blog/django/django-logging-cloudwatch/attach_iam_role.png"/></p>
<p>搜索并选择您刚刚创建的IAM角色，然后单击“应用”。</p>
<blockquote>
<p>您也可以从命令行附加角色，如下所示:</p>
<div class="codehilite"><pre><span/>$ aws ec2 associate-iam-instance-profile <span class="se">\</span>
    --instance-id &lt;YOUR_INSTANCE_ID&gt; <span class="se">\</span>
    --iam-instance-profile <span class="nv">Name</span><span class="o">=</span>CloudWatchAgentRole
</pre></div></blockquote>

<h2 id="create-cloudwatch-log-group">创建云观察日志组</h2>
<p>既然Docker守护进程已经获得了写入CloudWatch的权限，那么让我们创建一个要写入的日志组。在<a href="https://console.aws.amazon.com/cloudwatch/"> CloudWatch控制台</a>内，创建一个新的日志组。向新创建的组中添加一个新的日志流。</p>
<h2 id="install-the-cloudwatch-logs-agent">安装云观察日志代理</h2>
<p>SSH到EC2实例，直接从S3下载并安装CloudWatch日志代理<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/download-cloudwatch-agent-commandline.html"/>。</p>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># download</span>
$ curl https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb

<span class="c1"># install</span>
$ sudo dpkg -i -E ./amazon-cloudwatch-agent.deb
</code></pre></div>

<h2 id="configure-django-logging">配置Django日志记录</h2>
<p>因为Docker容器向stdout和stderr输出流发出日志，所以您需要配置Django日志记录，通过<a href="https://docs.python.org/3/library/logging.handlers.html#logging.StreamHandler"> StreamHandler </a>将所有内容记录到stderr。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'version'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">'disable_existing_loggers'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">'handlers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'console'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'class'</span><span class="p">:</span> <span class="s1">'logging.StreamHandler'</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s1">'loggers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">''</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'console'</span><span class="p">],</span>
            <span class="s1">'level'</span><span class="p">:</span> <span class="s1">'DEBUG'</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="update-docker-compose">复合更新坞站</h2>
<p>最后，我们可以在单个容器中使用Docker的<a href="https://docs.docker.com/config/containers/logging/awslogs/"> awslogs </a>日志驱动程序。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">"3.8"</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">api</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn core.wsgi:application --bind 0.0.0.0:8000 --log-level=debug</span><span class="w"/>
<span class="w">    </span><span class="nt">logging</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="s">"awslogs"</span><span class="w"/>
<span class="w">      </span><span class="nt">options</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">awslogs-region</span><span class="p">:</span><span class="w"> </span><span class="s">"us-east-1"</span><span class="w"/>
<span class="w">        </span><span class="nt">awslogs-group</span><span class="p">:</span><span class="w"> </span><span class="s">"your-log-group"</span><span class="w"/>
<span class="w">        </span><span class="nt">awslogs-stream</span><span class="p">:</span><span class="w"> </span><span class="s">"your-log-stream"</span><span class="w"/>
</code></pre></div>

<p>不使用compose？假设您已经构建并标记了图像，像这样旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker run <span class="se">\</span>
    --log-driver<span class="o">=</span><span class="s2">"awslogs"</span> <span class="se">\</span>
    --log-opt awslogs-region<span class="o">=</span><span class="s2">"use-east-1"</span> <span class="se">\</span>
    --log-opt awslogs-group<span class="o">=</span><span class="s2">"your-log-group"</span> <span class="se">\</span>
    --log-opt awslogs-stream<span class="o">=</span><span class="s2">"your-log-group"</span> <span class="se">\</span>
    your-image-tag
</code></pre></div>
  </div>

  </div>    
</body>
</html>