<html>
<head>
<title>Running Cypress Tests in Parallel </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>并行运行Cypress测试</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/running-cypress-tests-in-parallel/#0001-01-01">https://testdriven.io/blog/running-cypress-tests-in-parallel/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在接下来的教程中，我们将带您了解如何配置<a href="https://www.cypress.io/"> Cypress </a>来与<a href="https://circleci.com/"> CircleCI </a>并行运行测试。</p>
<blockquote>
<p>想看看最终项目的运行情况吗？查看<a href="https://www.youtube.com/watch?v=0eSET5MdcYs">视频</a>。</p>
</blockquote>



<h2 id="project-setup">项目设置</h2>
<p>让我们从建立一个基本的Cypress项目开始:</p>
<div class="codehilite"><pre><span/><code>$ mkdir cypress-parallel <span class="o">&amp;&amp;</span> <span class="nb">cd</span> cypress-parallel
$ npm init -y
$ npm install cypress --save-dev
$ ./node_modules/.bin/cypress open
</code></pre></div>

<p>这将创建一个新的项目文件夹，添加一个<em> package.json </em>文件，安装Cypress，打开Cypress GUI，并构建出以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>├── cypress
│   ├── fixtures
│   │   └── example.json
│   ├── integration
│   │   └── examples
│   │       ├── actions.spec.js
│   │       ├── aliasing.spec.js
│   │       ├── assertions.spec.js
│   │       ├── connectors.spec.js
│   │       ├── cookies.spec.js
│   │       ├── cypress_api.spec.js
│   │       ├── files.spec.js
│   │       ├── local_storage.spec.js
│   │       ├── location.spec.js
│   │       ├── misc.spec.js
│   │       ├── navigation.spec.js
│   │       ├── network_requests.spec.js
│   │       ├── querying.spec.js
│   │       ├── spies_stubs_clocks.spec.js
│   │       ├── traversal.spec.js
│   │       ├── utilities.spec.js
│   │       ├── viewport.spec.js
│   │       ├── waiting.spec.js
│   │       └── window.spec.js
│   ├── plugins
│   │   └── index.js
│   └── support
│       ├── commands.js
│       └── index.js
└─── cypress.json
</code></pre></div>

<p>关上柏圭。然后，删除“cypress/integration/examples”文件夹，并添加四个样本规范文件:</p>
<p><em> sample1.spec.js </em></p>
<div class="codehilite"><pre><span/><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Cypress parallel run example - 1'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should display the title'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="sb">`https://mherman.org`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'Michael Herman'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><em> sample2.spec.js </em></p>
<div class="codehilite"><pre><span/><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Cypress parallel run example - 2'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should display the blog link'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="sb">`https://mherman.org`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'Blog'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><em> sample3.spec.js </em></p>
<div class="codehilite"><pre><span/><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Cypress parallel run example - 3'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should display the about link'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="sb">`https://mherman.org`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'About'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><em> sample4.spec.js </em></p>
<div class="codehilite"><pre><span/><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Cypress parallel run example - 4'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should display the rss link'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="sb">`https://mherman.org`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'RSS'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>您的项目现在应该具有以下结构:</p>
<div class="codehilite"><pre><span/><code>├── cypress
│   ├── fixtures
│   │   └── example.json
│   ├── integration
│   │   ├── sample1.spec.js
│   │   ├── sample2.spec.js
│   │   ├── sample3.spec.js
│   │   └── sample4.spec.js
│   ├── plugins
│   │   └── index.js
│   └── support
│       ├── commands.js
│       └── index.js
├── cypress.json
├── package-lock.json
└── package.json
</code></pre></div>

<p>确保在继续之前通过测试:</p>
<div class="codehilite"><pre><span/><code>$ ./node_modules/.bin/cypress run

      Spec                                                Tests  Passing  Failing  Pending  Skipped
  ┌────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ ✔ sample1.spec.js                           <span class="m">00</span>:02        <span class="m">1</span>        <span class="m">1</span>        -        -        - │
  ├────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ ✔ sample2.spec.js                           <span class="m">00</span>:01        <span class="m">1</span>        <span class="m">1</span>        -        -        - │
  ├────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ ✔ sample3.spec.js                           <span class="m">00</span>:02        <span class="m">1</span>        <span class="m">1</span>        -        -        - │
  ├────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ ✔ sample4.spec.js                           <span class="m">00</span>:01        <span class="m">1</span>        <span class="m">1</span>        -        -        - │
  └────────────────────────────────────────────────────────────────────────────────────────────────┘
    All specs passed!                           <span class="m">00</span>:08        <span class="m">4</span>        <span class="m">4</span>        -        -        -
</code></pre></div>

<p>一旦完成，添加一个<em>。gitignore </em>文件:</p>
<div class="codehilite"><pre><span/><code>node_modules/
cypress/videos/
cypress/screenshots/
</code></pre></div>

<p>在GitHub上创建一个名为<em> cypress-parallel </em>的新存储库，在本地初始化一个新的git repo，然后将代码提交到GitHub。</p>
<h2 id="circleci-setup">CircleCI设置</h2>
<p>如果你还没有一个<a href="https://circleci.com/"> CircleCI </a>账户，就注册吧。然后，在CircleCI上添加<em>柏树平行</em>作为新项目。</p>
<blockquote>
<p>查看<a href="https://circleci.com/docs/2.0/getting-started/#section=getting-started">入门</a>指南，了解如何在CircleCI上设置和使用项目。</p>
</blockquote>
<p>向名为“”的文件夹中添加一个新文件。circleci”，然后向该文件夹添加一个名为<em> config.yml </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>

<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">restore_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">keys</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2-deps-</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm ci</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">save_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.npm</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.cache</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmp</span><span class="w"/>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(npm bin)/cypress run</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>

<span class="nt">workflows</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>
<span class="w">  </span><span class="nt">build_and_test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
</code></pre></div>

<p>这里，我们配置了两个作业，<code>build</code>和<code>test</code>。<code>build</code>作业安装Cypress，测试在<code>test</code>作业中运行。这两个任务都在Docker内部运行，并从<a href="https://hub.docker.com/r/cypress/base"> cypress/base </a>映像扩展而来。</p>
<blockquote>
<p>有关CircleCI配置的更多信息，请查看<a href="https://circleci.com/docs/2.0/config-intro/#section=configuration">配置介绍</a>指南。</p>
</blockquote>
<p>提交并推送您的代码以触发新的构建。确保两个工作都通过。您应该能够在<code>test</code>任务的“工件”选项卡中看到Cypress录制的视频:</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-1.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/ca88e4ef6927b26c0ff7fa8b8c94692e.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-1.png"/></p>
<p>这样，让我们看看如何使用配置文件分割测试，这样Cypress测试可以在<a href="https://circleci.com/docs/2.0/parallelism-faster-jobs/">并行</a>中运行。</p>
<h2 id="parallelism">平行</h2>
<p>我们将从手动拆分它们开始。像这样更新配置文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>

<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">restore_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">keys</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2-deps-</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm ci</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">save_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.npm</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.cache</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmp</span><span class="w"/>
<span class="w">  </span><span class="nt">test1</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 1</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(npm bin)/cypress run --spec cypress/integration/sample1.spec.js</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">  </span><span class="nt">test2</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 2</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(npm bin)/cypress run --spec cypress/integration/sample2.spec.js</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">  </span><span class="nt">test3</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 3</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(npm bin)/cypress run --spec cypress/integration/sample3.spec.js</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">  </span><span class="nt">test4</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 4</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(npm bin)/cypress run --spec cypress/integration/sample4.spec.js</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>

<span class="nt">workflows</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>
<span class="w">  </span><span class="nt">build_and_test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test1</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test2</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test3</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test4</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
</code></pre></div>

<p>因此，我们创建了四个测试作业，每个作业将在CircleCI上的不同机器上运行单个spec文件。提交你的代码并上传到GitHub。这一次，一旦<code>build</code>作业完成，您应该会看到每个测试作业同时运行:</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-2.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/d114f826b00a665135eb73b52f744a8f.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-2.png"/></p>
<p>接下来，让我们看看如何动态生成配置文件。</p>
<h2 id="generate-circleci-config">生成CircleCI配置</h2>
<p>在项目根目录中创建一个“lib”文件夹，然后将以下文件添加到该文件夹中:</p>
<ol>
<li><em> circle.json </em></li>
<li><em>generate-circle-config . js</em></li>
</ol>
<p>将<code>build</code>作业的配置添加到<em> circle.json </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"jobs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"build"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"working_directory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~/tmp"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"docker"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cypress/base:10"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"TERM"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xterm"</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">}</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nt">"steps"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="s2">"checkout"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"run"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pwd"</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"run"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ls"</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"restore_cache"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"keys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">              </span><span class="s2">"v2-deps-{{ .Branch }}-{{ checksum \"package-lock.json\" }}"</span><span class="p">,</span><span class="w"/>
<span class="w">              </span><span class="s2">"v2-deps-{{ .Branch }}-"</span><span class="p">,</span><span class="w"/>
<span class="w">              </span><span class="s2">"v2-deps-"</span><span class="w"/>
<span class="w">            </span><span class="p">]</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"run"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm ci"</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"save_cache"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v2-deps-{{ .Branch }}-{{ checksum \"package-lock.json\" }}"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">              </span><span class="s2">"~/.npm"</span><span class="p">,</span><span class="w"/>
<span class="w">              </span><span class="s2">"~/.cache"</span><span class="w"/>
<span class="w">            </span><span class="p">]</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nt">"persist_to_workspace"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nt">"root"</span><span class="p">:</span><span class="w"> </span><span class="s2">"~/"</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nt">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">              </span><span class="s2">".cache"</span><span class="p">,</span><span class="w"/>
<span class="w">              </span><span class="s2">"tmp"</span><span class="w"/>
<span class="w">            </span><span class="p">]</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">}</span><span class="w"/>
<span class="w">      </span><span class="p">]</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"workflows"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"build_and_test"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"jobs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="s2">"build"</span><span class="w"/>
<span class="w">      </span><span class="p">]</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>本质上，我们将使用这个配置作为基础，动态地向其中添加测试作业，然后在YAML保存最终的配置文件。</p>
<p>将代码添加到<em>generate-circle-config . js</em>中:</p>
<ol>
<li>从“cypress/integration”目录中获取等级库文件的名称</li>
<li>将<em> circle.json </em>文件作为对象读取</li>
<li>将测试作业添加到对象</li>
<li>将对象转换为YAML，并作为<em>写入磁盘。circleci/config.yml </em></li>
</ol>
<p>代码:</p>
<div class="codehilite"><pre><span/><code><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'write-yaml'</span><span class="p">);</span><span class="w"/>


<span class="cm">/*</span>
<span class="cm">  helpers</span>
<span class="cm">*/</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">createJSON</span><span class="p">(</span><span class="nx">fileArray</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">fileArray</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">jobs</span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">working_directory</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/tmp'</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">docker</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/base:10'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">TERM</span><span class="o">:</span><span class="w"> </span><span class="s1">'xterm'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">attach_workspace</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress/integration'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="sb">`Running cypress tests </span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">command</span><span class="o">:</span><span class="w"> </span><span class="sb">`$(npm bin)/cypress run --spec cypress/integration/</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/videos'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/screenshots'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">workflows</span><span class="p">.</span><span class="nx">build_and_test</span><span class="p">.</span><span class="nx">jobs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">requires</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">          </span><span class="s1">'build'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">yaml</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">'..'</span><span class="p">,</span><span class="w"> </span><span class="s1">'.circleci'</span><span class="p">,</span><span class="w"> </span><span class="s1">'config.yml'</span><span class="p">),</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Success!'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">}</span><span class="w"/>


<span class="cm">/*</span>
<span class="cm">  main</span>
<span class="cm">*/</span><span class="w"/>

<span class="c1">// get spec files as an array</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">'..'</span><span class="p">,</span><span class="w"> </span><span class="s1">'cypress'</span><span class="p">,</span><span class="w"> </span><span class="s1">'integration'</span><span class="p">)).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">fn</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'.spec.js'</span><span class="p">));</span><span class="w"/>
<span class="c1">// read circle.json</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">circleConfigJSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">'circle.json'</span><span class="p">));</span><span class="w"/>
<span class="c1">// add cypress specs to object as test jobs</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createJSON</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span><span class="w"> </span><span class="nx">circleConfigJSON</span><span class="p">);</span><span class="w"/>
<span class="c1">// write file to disc</span><span class="w"/>
<span class="nx">writeFile</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
</code></pre></div>

<p>自己回顾(并重构)这一点。</p>
<p>安装<a href="https://www.npmjs.com/package/write-yaml"> write-yaml </a>然后生成新的配置文件:</p>
<div class="codehilite"><pre><span/><code>$ npm install write-yaml --save-dev
$ node lib/generate-circle-config.js
</code></pre></div>

<p>再次提交您的代码，并将其推送到GitHub以触发新的构建。同样，四个测试任务应该在<code>build</code>任务完成后并行运行。</p>
<h2 id="mochawesome">摩卡真棒</h2>
<p>接下来，让我们添加<a href="https://github.com/adamgruber/mochawesome"> mochawesome </a>作为Cypress <a href="https://docs.cypress.io/guides/tooling/reporters.html#Custom-Reporters">自定义报告器</a>，这样我们就可以在所有测试任务运行完毕后生成一个漂亮的报告。</p>
<p>安装:</p>
<div class="codehilite"><pre><span/><code>$ npm install mochawesome mocha --save-dev
</code></pre></div>

<p>更新<em>generate-circle-config . js</em>中<code>createJSON</code>函数的以下<code>run</code>步骤:</p>
<div class="codehilite"><pre><span/><code><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="sb">`Running cypress tests </span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">command</span><span class="o">:</span><span class="w"> </span><span class="sb">`$(npm bin)/cypress run --spec cypress/integration/</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb"> --reporter mochawesome --reporter-options "reportFilename=test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">"`</span><span class="p">,</span><span class="w"/>
<span class="p">},</span><span class="w"/>
</code></pre></div>

<p>然后，添加一个新步骤，将生成的报告作为一个<a href="https://circleci.com/docs/2.0/artifacts/">工件</a>存储到<code>createJSON</code>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">},</span><span class="w"/>
</code></pre></div>

<p><code>createJSON</code>现在应该是这样的:</p>
<div class="codehilite"><pre><span/><code><span class="kd">function</span><span class="w"> </span><span class="nx">createJSON</span><span class="p">(</span><span class="nx">fileArray</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">fileArray</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">jobs</span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">working_directory</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/tmp'</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">docker</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/base:10'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">TERM</span><span class="o">:</span><span class="w"> </span><span class="s1">'xterm'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">attach_workspace</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress/integration'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="sb">`Running cypress tests </span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">command</span><span class="o">:</span><span class="w"> </span><span class="sb">`$(npm bin)/cypress run --spec cypress/integration/</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb"> --reporter mochawesome --reporter-options "reportFilename=test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">"`</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/videos'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/screenshots'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">workflows</span><span class="p">.</span><span class="nx">build_and_test</span><span class="p">.</span><span class="nx">jobs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">requires</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">          </span><span class="s1">'build'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>现在，每个测试运行将生成一个具有唯一名称的mochawesome报告。试试看。生成新的配置。提交并推送您的代码。每个测试作业都应该在“工件”选项卡中存储一份生成的mochawesome报告的副本:</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-3.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/6e3de31148a40bd613c1ebb59e61337d.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-3.png"/></p>
<p>实际的报告应该是这样的:</p>
<p><img data-src="/static/images/blog/cypress-parallel/mochawesome-report-1.png" loading="lazy" class="lazyload" alt="mochawesome report" src="../Images/f4afead6e909ecb2f789a737e8513192.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/mochawesome-report-1.png"/></p>
<h2 id="combine-reports">合并报告</h2>
<p>下一步是将单独的报告合并成一个报告。首先向<code>createJSON</code>函数添加一个新步骤，将生成的报告存储在<a href="https://circleci.com/docs/2.0/configuration-reference/#persist_to_workspace">工作区</a>中:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">persist_to_workspace</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">paths</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">.json`</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">.html`</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="p">},</span><span class="w"/>
</code></pre></div>

<p>此外，向<em> lib/circle.json </em>添加一个名为<code>combine_reports</code>的新作业，它附加工作区，然后运行一个<code>ls</code>命令来显示目录的内容:</p>
<div class="codehilite"><pre><span/><code><span class="s2">"combine_reports"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="s2">"working_directory"</span><span class="o">:</span><span class="w"> </span><span class="s2">"~/tmp"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="s2">"docker"</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"image"</span><span class="o">:</span><span class="w"> </span><span class="s2">"cypress/base:10"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"environment"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"TERM"</span><span class="o">:</span><span class="w"> </span><span class="s2">"xterm"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="s2">"steps"</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"attach_workspace"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"at"</span><span class="o">:</span><span class="w"> </span><span class="s2">"/tmp/mochawesome-report"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"run"</span><span class="o">:</span><span class="w"> </span><span class="s2">"ls /tmp/mochawesome-report"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<blockquote>
<p><code>ls</code>的目的是确保我们正确地持久化和附加工作空间。换句话说，在运行时，您应该看到“/tmp/mochawesome-report”目录中的所有报告。</p>
</blockquote>
<p>因为这个作业依赖于测试作业，所以再次更新<code>createJSON</code>,就像这样:</p>
<div class="codehilite"><pre><span/><code><span class="kd">function</span><span class="w"> </span><span class="nx">createJSON</span><span class="p">(</span><span class="nx">fileArray</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">fileArray</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">jobs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">jobs</span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">working_directory</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/tmp'</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">docker</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/base:10'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">TERM</span><span class="o">:</span><span class="w"> </span><span class="s1">'xterm'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">attach_workspace</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="s1">'~/'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="s1">'ls -la cypress/integration'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="sb">`Running cypress tests </span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">command</span><span class="o">:</span><span class="w"> </span><span class="sb">`$(npm bin)/cypress run --spec cypress/integration/</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb"> --reporter mochawesome --reporter-options "reportFilename=test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">"`</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/videos'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'cypress/screenshots'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">store_artifacts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">persist_to_workspace</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">root</span><span class="o">:</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">paths</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">              </span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">.json`</span><span class="p">,</span><span class="w"/>
<span class="w">              </span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">.html`</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="p">],</span><span class="w"/>
<span class="w">          </span><span class="p">},</span><span class="w"/>
<span class="w">        </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="p">.</span><span class="nx">workflows</span><span class="p">.</span><span class="nx">build_and_test</span><span class="p">.</span><span class="nx">jobs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="p">[</span><span class="sb">`test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">requires</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">          </span><span class="s1">'build'</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="p">.</span><span class="nx">workflows</span><span class="p">.</span><span class="nx">build_and_test</span><span class="p">.</span><span class="nx">jobs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">combine_reports</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s1">'requires'</span><span class="o">:</span><span class="w"> </span><span class="nx">jobs</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>生成配置:</p>
<div class="codehilite"><pre><span/><code>$ node lib/generate-circle-config.js
</code></pre></div>

<p>配置文件现在应该看起来像这样:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>
<span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwd</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">restore_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">keys</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-'</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2-deps-</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm ci</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">save_cache</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">'v2-deps-{{</span><span class="nv"> </span><span class="s">.Branch</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">checksum</span><span class="nv"> </span><span class="s">"package-lock.json"</span><span class="nv"> </span><span class="s">}}'</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.npm</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.cache</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmp</span><span class="w"/>
<span class="w">  </span><span class="nt">combine_reports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/mochawesome-report</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls /tmp/mochawesome-report</span><span class="w"/>
<span class="w">  </span><span class="nt">test1</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 1</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"/>
<span class="w">            </span><span class="no">$(npm bin)/cypress run --spec cypress/integration/sample1.spec.js</span><span class="w"/>
<span class="w">            </span><span class="no">--reporter mochawesome --reporter-options "reportFilename=test1"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1.json</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1.html</span><span class="w"/>
<span class="w">  </span><span class="nt">test2</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 2</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"/>
<span class="w">            </span><span class="no">$(npm bin)/cypress run --spec cypress/integration/sample2.spec.js</span><span class="w"/>
<span class="w">            </span><span class="no">--reporter mochawesome --reporter-options "reportFilename=test2"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2.json</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2.html</span><span class="w"/>
<span class="w">  </span><span class="nt">test3</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 3</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"/>
<span class="w">            </span><span class="no">$(npm bin)/cypress run --spec cypress/integration/sample3.spec.js</span><span class="w"/>
<span class="w">            </span><span class="no">--reporter mochawesome --reporter-options "reportFilename=test3"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test3.json</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test3.html</span><span class="w"/>
<span class="w">  </span><span class="nt">test4</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">working_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/tmp</span><span class="w"/>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">'cypress/base:10'</span><span class="w"/>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">TERM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xterm</span><span class="w"/>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">attach_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">at</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ls -la cypress/integration</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running cypress tests 4</span><span class="w"/>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span><span class="w"/>
<span class="w">            </span><span class="no">$(npm bin)/cypress run --spec cypress/integration/sample4.spec.js</span><span class="w"/>
<span class="w">            </span><span class="no">--reporter mochawesome --reporter-options "reportFilename=test4"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/videos</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cypress/screenshots</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">store_artifacts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">persist_to_workspace</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mochawesome-report</span><span class="w"/>
<span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test4.json</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test4.html</span><span class="w"/>
<span class="nt">workflows</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"/>
<span class="w">  </span><span class="nt">build_and_test</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test1</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test2</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test3</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test4</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">combine_reports</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">requires</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test1</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test2</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test3</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test4</span><span class="w"/>
</code></pre></div>

<p>再次提交并推送到GitHub。确保<code>combine_reports</code>运行到最后:</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-4.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/d1e4bcbf7f79f9a4034e02681afccaa9.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-4.png"/></p>
<p>接下来，添加一个脚本来合并报告:</p>
<div class="codehilite"><pre><span/><code><span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'shelljs'</span><span class="p">);</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">uuidv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'uuid/v1'</span><span class="p">);</span><span class="w"/>


<span class="kd">function</span><span class="w"> </span><span class="nx">getFiles</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="nx">ext</span><span class="p">,</span><span class="w"> </span><span class="nx">fileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">dir</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">dir</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">file</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">getFiles</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileList</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">ext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">fileList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fileList</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">traverseAndModifyTimedOut</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">deep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="s1">'tests'</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">target</span><span class="p">[</span><span class="s1">'tests'</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">target</span><span class="p">[</span><span class="s1">'tests'</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">test</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">test</span><span class="p">.</span><span class="nx">timedOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="s1">'suites'</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">target</span><span class="p">[</span><span class="s1">'suites'</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">suite</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">traverseAndModifyTimedOut</span><span class="p">(</span><span class="nx">suite</span><span class="p">,</span><span class="w"> </span><span class="nx">deep</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">combineMochaAwesomeReports</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">reportDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span><span class="w"> </span><span class="s1">'tmp'</span><span class="p">,</span><span class="w"> </span><span class="s1">'mochawesome-report'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">reports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getFiles</span><span class="p">(</span><span class="nx">reportDir</span><span class="p">,</span><span class="w"> </span><span class="s1">'.json'</span><span class="p">,</span><span class="w"> </span><span class="p">[]);</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">suites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalSuites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalTests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalPasses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalPending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">startTime</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">endTime</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalskipped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="nx">reports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">rawdata</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">idx</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">idx</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">reports</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="nx">totalSuites</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">suites</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">totalskipped</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">skipped</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">totalPasses</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">passes</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">totalFailures</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">failures</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">totalPending</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">pending</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">totalTests</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">tests</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"/>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsedData</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">suites</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">suites</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">parsedData</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">suite</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">suites</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">suite</span><span class="p">)</span><span class="w"/>
<span class="w">      </span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">totalSuites</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">totalTests</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">totalPasses</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">totalFailures</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">totalPending</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">startTime</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">endTime</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">totalskipped</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">suites</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">};</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">getPercentClass</span><span class="p">(</span><span class="nx">pct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pct</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'danger'</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'warning'</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'success'</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">writeReport</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">uuid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sampleFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">'sample.json'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">outFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">'..'</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">uuid</span><span class="si">}</span><span class="sb">.json`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">sampleFile</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf8'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">err</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedSampleFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedSampleFile</span><span class="p">.</span><span class="nx">stats</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">suites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalSuites</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalTests</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">passes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalPasses</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">failures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalFailures</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalPending</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">endTime</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">endTime</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">startTime</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">testsRegistered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalTests</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalPending</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">passPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">stats</span><span class="p">.</span><span class="nx">passes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">tests</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">pending</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">pendingPercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">stats</span><span class="p">.</span><span class="nx">pending</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">testsRegistered</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="mf">10</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">skipped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalskipped</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">hasSkipped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">totalskipped</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">passPercentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPercentClass</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">passPercent</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">stats</span><span class="p">.</span><span class="nx">pendingPercentClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPercentClass</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">pendingPercent</span><span class="p">);</span><span class="w"/>

<span class="w">    </span><span class="nx">obj</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">suit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">traverseAndModifyTimedOut</span><span class="p">(</span><span class="nx">suit</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>

<span class="w">    </span><span class="nx">parsedSampleFile</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">suites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">suites</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">parsedSampleFile</span><span class="p">.</span><span class="nx">suites</span><span class="p">.</span><span class="nx">uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uuid</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">parsedSampleFile</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">flag</span><span class="o">:</span><span class="w"> </span><span class="s1">'wx'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">combineMochaAwesomeReports</span><span class="p">();</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uuidv1</span><span class="p">();</span><span class="w"/>
<span class="nx">writeReport</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">uuid</span><span class="p">);</span><span class="w"/>
<span class="nx">shell</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`./node_modules/.bin/marge </span><span class="si">${</span><span class="nx">uuid</span><span class="si">}</span><span class="sb">.json --reportDir mochareports --reportTitle </span><span class="si">${</span><span class="nx">uuid</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">stdout</span><span class="p">,</span><span class="w"> </span><span class="nx">stderr</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stderr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stderr</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Success!'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>将此保存为“lib”中的<em> combine.js </em>。</p>
<p>这个脚本将收集所有的mochawesome JSON文件(包含每个mochawesome报告的原始JSON输出)，合并它们，并生成一个新的mochawesome报告。</p>
<blockquote>
<p>如果感兴趣的话，可以返回到CircleCI，在一个测试作业的“Artifacts”选项卡中查看一个生成的mochawesome JSON文件。</p>
</blockquote>
<p>安装依赖项:</p>
<div class="codehilite"><pre><span/><code>$ npm install shelljs uuid --save-dev
</code></pre></div>

<p>将<em> sample.json </em>添加到“lib”目录中:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"stats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"suites"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"tests"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"passes"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"pending"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"failures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"end"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"duration"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"testsRegistered"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"passPercent"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"pendingPercent"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"other"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"hasOther"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"hasSkipped"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"passPercentClass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"pendingPercentClass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"suites"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"fullFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"file"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"beforeHooks"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"afterHooks"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"tests"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"suites"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"passes"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"pending"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"duration"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"root"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"rootEmpty"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"_timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"copyrightYear"</span><span class="p">:</span><span class="w"> </span><span class="mi">2019</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>更新<em> circle.json </em>中的<code>combine_reports</code>以运行<em> combine.js </em>脚本，然后将新报告保存为工件:</p>
<div class="codehilite"><pre><span/><code><span class="s2">"combine_reports"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="s2">"working_directory"</span><span class="o">:</span><span class="w"> </span><span class="s2">"~/tmp"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="s2">"docker"</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"image"</span><span class="o">:</span><span class="w"> </span><span class="s2">"cypress/base:10"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"environment"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"TERM"</span><span class="o">:</span><span class="w"> </span><span class="s2">"xterm"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="s2">"steps"</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="s2">"checkout"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"attach_workspace"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"at"</span><span class="o">:</span><span class="w"> </span><span class="s2">"~/"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"attach_workspace"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"at"</span><span class="o">:</span><span class="w"> </span><span class="s2">"/tmp/mochawesome-report"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"run"</span><span class="o">:</span><span class="w"> </span><span class="s2">"ls /tmp/mochawesome-report"</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"run"</span><span class="o">:</span><span class="w"> </span><span class="s2">"node ./lib/combine.js"</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="s2">"store_artifacts"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"path"</span><span class="o">:</span><span class="w"> </span><span class="s2">"mochareports"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>为了测试，生成新的配置，提交并推送您的代码。所有作业都应该通过，您应该会看到合并的最终报告。</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-5.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/17662b7cf09ff0dd73b30c09baf88c36.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-5.png"/></p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-6.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/78091ac37ac2816f268fc2a7fbc477f7.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-6.png"/></p>
<p><img data-src="/static/images/blog/cypress-parallel/mochawesome-report-2.png" loading="lazy" class="lazyload" alt="mochawesome report" src="../Images/06b7932735ad3ced52fde925fcda725b.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/mochawesome-report-2.png"/></p>
<h2 id="handle-test-failures">处理测试失败</h2>
<p>如果测试失败会发生什么？</p>
<p>将<em> sample2.spec.js </em>中的<code>cy.get('a').contains('Blog');</code>改为<code>cy.get('a').contains('Not Real');</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Cypress parallel run example - 2'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'should display the blog link'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="sb">`https://mherman.org`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'Not Real'</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>提交并推送您的代码。由于<code>combine_reports</code>任务依赖于测试任务，如果其中任何一个测试任务失败，它就不会运行。</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-7.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/6cccd40574a0b152e757ddb91072520f.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-7.png"/></p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-8.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/5debceb451deba261792c3615fe685e2.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-8.png"/></p>
<p>那么，即使工作流中的前一个作业失败，如何让<code>combine_reports</code>作业运行呢？</p>
<p>不幸的是，CircleCI目前不支持这一功能。更多信息请参见本<a href="https://discuss.circleci.com/t/continue-running-other-jobs-after-required-job-fails/24334">讨论</a>。因为我们实际上只关心mochawesome JSON报告，所以您可以通过取消测试作业的退出代码来解决这个问题。测试作业仍然会运行并生成mochawesome报告——不管底层测试是通过还是失败，它们都会通过。</p>
<p>在<code>createJSON</code>中再次更新以下<code>run</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nx">run</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="sb">`Running cypress tests </span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">command</span><span class="o">:</span><span class="w"> </span><span class="sb">`if $(npm bin)/cypress run --spec cypress/integration/</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb"> --reporter mochawesome --reporter-options "reportFilename=test</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">"; then echo 'pass'; else echo 'fail'; fi`</span><span class="p">,</span><span class="w"/>
<span class="p">},</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>单行bash if/else有点难读。请自行重构。</p>
</blockquote>
<p>有用吗？生成新的配置文件，提交并推送您的代码。所有的测试工作都应该通过，最终的mochawesome报告应该显示失败的规范。</p>
<p><img data-src="/static/images/blog/cypress-parallel/circle-dashboard-9.png" loading="lazy" class="lazyload" alt="circleci dashboard" src="../Images/f403c8c89d021c8667c898db6062cd14.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/circle-dashboard-9.png"/></p>
<p><img data-src="/static/images/blog/cypress-parallel/mochawesome-report-3.png" loading="lazy" class="lazyload" alt="mochawesome report" src="../Images/b1e488ead784a913ff9169771be58fa3.png" data-original-src="https://testdriven.io/static/images/blog/cypress-parallel/mochawesome-report-3.png"/></p>
<p>最后一件事:如果一个任务失败了，我们可能仍然会让整个构建失败。实现这个的最快方法是在<em> combine.js </em>中的<code>shell.exec</code>回调中:</p>
<div class="codehilite"><pre><span/><code><span class="nx">shell</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`./node_modules/.bin/marge </span><span class="si">${</span><span class="nx">uuid</span><span class="si">}</span><span class="sb">.json --reportDir mochareports --reportTitle </span><span class="si">${</span><span class="nx">uuid</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">stdout</span><span class="p">,</span><span class="w"> </span><span class="nx">stderr</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stderr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stderr</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Success!'</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">totalFailures</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>测试一下。然后，尝试测试一些其他场景，比如跳过一个测试或者添加四个以上的规范文件。</p>
<h2 id="conclusion">结论</h2>
<p>本教程着眼于如何在CircleCI上并行运行Cypress测试，而不使用Cypress <a href="https://docs.cypress.io/guides/dashboard/runs/"> record </a>特性。值得注意的是，您可以使用任何提供并行性的CI服务来实现完全相同的工作流，例如<a href="https://about.gitlab.com/product/continuous-integration/"> GitLab CI </a>、<a href="https://travis-ci.com/"> Travis </a>和<a href="https://semaphoreci.com"> Semaphore </a>，以及您自己的定制CI平台Jenkins或<a href="https://concourse-ci.org/"> Concourse </a>。如果您的CI服务不提供并行性，那么您可以使用Docker并行运行作业。请联系我们了解更多详情。</p>
<p>寻找一些挑战？</p>
<ol>
<li>创建一个Slack bot，在测试运行完成时通知一个频道，并添加一个链接到mochawesome报告以及任何失败测试规范的截图或视频</li>
<li>将最终报告上传到S3桶(见<a href="https://github.com/testdrivenio/cypress-mochawesome-s3"> cypress-mochawesome-s3 </a>)</li>
<li>通过将测试结果存储在数据库中，跟踪一段时间内失败测试的数量</li>
<li>将整个测试套件作为一项夜间工作运行多次，然后只在测试失败X次时指出测试是否失败——这将有助于暴露不可靠的测试，并消除不必要的开发人员干预</li>
</ol>
<p>从赛普拉斯平行的回购协议中获取最终代码。干杯！</p>
  </div>

  </div>    
</body>
</html>