<html>
<head>
<title>Adding Charts to Django with Chart.js </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Chart.js向Django添加图表</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-charts/#0001-01-01">https://testdriven.io/blog/django-charts/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何使用<a href="https://www.chartjs.org/"> Chart.js </a>向Django添加交互式图表。我们将使用Django来建模和准备数据，然后使用AJAX从模板中异步获取数据。最后，我们将看看如何创建新的Django管理视图并扩展现有的管理模板，以便向Django管理添加自定义图表。</p>



<h2 id="what-is-chartjs">什么是Chart.js？</h2>
<p><a href="https://www.chartjs.org/"> Chart.js </a>是一个用于数据可视化的开源JavaScript库。它支持八种不同的图表类型:条形图、折线图、面积图、饼图、气泡图、雷达图、极坐标图和散点图。它灵活且高度可定制。它支持动画。最棒的是，它很容易使用。</p>
<p>首先，您只需要在HTML文件中包含Chart.js脚本和一个<code>&lt;canvas&gt;</code>节点:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b6d5ded7c4c298dcc5f684988f9882">[email protected]</a>"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"chart"</span> <span class="na">width</span><span class="o">=</span><span class="s">"500"</span> <span class="na">height</span><span class="o">=</span><span class="s">"500"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
</code></pre></div>

<p>然后，您可以像这样创建一个图表:</p>
<div class="codehilite"><pre><span/><code><span class="kd">let</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"chart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>

<span class="kd">let</span><span class="w"> </span><span class="nx">chart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">     </span><span class="nx">labels</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2020/Q1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2020/Q2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2020/Q3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2020/Q4"</span><span class="p">],</span><span class="w"/>
<span class="w">     </span><span class="nx">datasets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="s2">"Gross volume ($)"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s2">"#79AEC8"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">borderColor</span><span class="o">:</span><span class="w"> </span><span class="s2">"#417690"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">26900</span><span class="p">,</span><span class="w"> </span><span class="mf">28700</span><span class="p">,</span><span class="w"> </span><span class="mf">27300</span><span class="p">,</span><span class="w"> </span><span class="mf">29200</span><span class="p">]</span><span class="w"/>
<span class="w">        </span><span class="p">}</span><span class="w"/>
<span class="w">     </span><span class="p">]</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">     </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s2">"Gross Volume in 2020"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"/>
<span class="w">     </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>此代码创建了以下图表:</p>
<p class="codepen" data-height="500" data-theme-id="0" data-default-tab="result" data-user="mjhea0" data-slug-hash="wvogmJy" data-pen-title="wvogmJy"><span>见<a href="https://codepen.io"> CodePen </a>上Michael Herman ( <a href="https://codepen.io/mjhea0"> @mjhea0 </a>)的笔<a href="https://codepen.io/mjhea0/pen/wvogmJy/"> wvogmJy </a>。</span></p>


<p/>

<p><a href="https://codepen.io/mjhea0/pen/wvogmJy"> CodePen链接</a></p>
<blockquote>
<p>要了解更多关于Chart.js的信息，请查看官方文档。</p>
</blockquote>
<p>至此，我们来看看如何用Chart.js向Django添加图表。</p>
<h2 id="project-setup">项目设置</h2>
<p>让我们创建一个简单的商店应用程序。我们将使用Django管理命令生成样本数据，然后用Chart.js将其可视化。</p>
<blockquote>
<p>喜欢不同的JavaScript图表库，如<a href="https://d3js.org/"> D3.js </a>或<a href="https://gionkunz.github.io/chartist-js/"> Chartist </a>？您可以使用相同的方法将图表添加到Django和Django admin中。您只需要调整JSON端点中数据的格式。</p>
</blockquote>
<p>工作流程:</p>
<ol>
<li>使用Django ORM查询获取数据</li>
<li>格式化数据并通过受保护的端点返回</li>
<li>使用AJAX从模板中请求数据</li>
<li>初始化Chart.js并加载数据</li>
</ol>
<p>首先创建一个新目录，并建立一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-interactive-charts <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-interactive-charts
$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.1.6
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject core .
</code></pre></div>

<p>之后，创建一个名为<code>shop</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp shop
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em> core/settings.py </em>中注册app:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'shop.apps.ShopConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="create-database-models">创建数据库模型</h3>
<p>接下来，创建<code>Item</code>和<code>Purchase</code>模型:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s1">)'</span>


<span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">customer_full_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">Item</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">PAYMENT_METHODS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">'CC'</span><span class="p">,</span> <span class="s1">'Credit card'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'DC'</span><span class="p">,</span> <span class="s1">'Debit card'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'ET'</span><span class="p">,</span> <span class="s1">'Ethereum'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'BC'</span><span class="p">,</span> <span class="s1">'Bitcoin'</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">payment_method</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">'CC'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PAYMENT_METHODS</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">successful</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-time'</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_full_name</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">payment_method</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">)'</span>
</code></pre></div>

<ol>
<li><code>Item</code>代表我们店里的一件商品</li>
<li><code>Purchase</code>代表购买(与<code>Item</code>相关联)</li>
</ol>
<p>进行迁移，然后应用它们:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py makemigrations
<span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>在<em> shop/admin.py </em>中注册模型:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/admin.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Purchase</span>


<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Purchase</span><span class="p">)</span>
</code></pre></div>

<h3 id="populate-the-database">填充数据库</h3>
<p>在创建任何图表之前，我们需要一些数据来处理。我创建了一个简单的命令，可以用来填充数据库。</p>
<p>在“商店”中创建一个名为“管理”的新文件夹，然后在该文件夹中创建另一个名为“命令”的文件夹。在“commands”文件夹中，创建一个名为<em> populate_db.py </em>的新文件。</p>
<div class="codehilite"><pre><span/><code>management
└── commands
    └── populate_db.py
</code></pre></div>

<p><em> populate_db.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/management/commands/populate_db.py</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>

<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Purchase</span>


<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s1">'Populates the database with random generated data.'</span>

    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--amount'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'The number of purchases that should be created.'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'James'</span><span class="p">,</span> <span class="s1">'John'</span><span class="p">,</span> <span class="s1">'Robert'</span><span class="p">,</span> <span class="s1">'Michael'</span><span class="p">,</span> <span class="s1">'William'</span><span class="p">,</span> <span class="s1">'David'</span><span class="p">,</span> <span class="s1">'Richard'</span><span class="p">,</span> <span class="s1">'Joseph'</span><span class="p">,</span> <span class="s1">'Thomas'</span><span class="p">,</span> <span class="s1">'Charles'</span><span class="p">]</span>
        <span class="n">surname</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Smith'</span><span class="p">,</span> <span class="s1">'Jones'</span><span class="p">,</span> <span class="s1">'Taylor'</span><span class="p">,</span> <span class="s1">'Brown'</span><span class="p">,</span> <span class="s1">'Williams'</span><span class="p">,</span> <span class="s1">'Wilson'</span><span class="p">,</span> <span class="s1">'Johnson'</span><span class="p">,</span> <span class="s1">'Davies'</span><span class="p">,</span> <span class="s1">'Patel'</span><span class="p">,</span> <span class="s1">'Wright'</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Socks'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Pants'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'T-Shirt'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Boots'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Sweater'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Underwear'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Leggings'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Cap'</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">'amount'</span><span class="p">]</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">'amount'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">2500</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1825</span><span class="p">)))</span>
            <span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">customer_full_name</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">surname</span><span class="p">),</span>
                <span class="n">item</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">items</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">payment_method</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Purchase</span><span class="o">.</span><span class="n">PAYMENT_METHODS</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">successful</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">purchase</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">purchase</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">(</span><span class="s1">'Successfully populated the database.'</span><span class="p">))</span>
</code></pre></div>

<p>运行以下命令来填充数据库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py populate_db --amount <span class="m">1000</span>
</code></pre></div>

<p>如果一切顺利，您应该会在控制台上看到一条<code>Successfully populated the database.</code>消息。</p>
<p>这给数据库增加了8个项目和1，000次购买。</p>
<h2 id="prepare-and-serve-the-data">准备和提供数据</h2>
<p>我们的应用将有以下端点:</p>
<ol>
<li>列出我们有记录的所有年份</li>
<li><code>chart/sales/&lt;YEAR&gt;/</code>按年提取月度总量数据</li>
<li><code>chart/spend-per-customer/&lt;YEAR&gt;/</code>按年度提取每位客户的月支出</li>
<li><code>chart/payment-success/YEAR/</code>取年度支付成功数据</li>
<li><code>chart/payment-method/YEAR/</code>获取年度支付方式数据(信用卡、借记卡、以太坊、比特币)</li>
</ol>
<p>在添加视图之前，让我们创建几个实用函数，这将使创建图表变得更加容易。在项目根目录中添加一个名为“utils”的新文件夹。然后，向该文件夹添加一个名为<em> charts.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># util/charts.py</span>

<span class="n">months</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'January'</span><span class="p">,</span> <span class="s1">'February'</span><span class="p">,</span> <span class="s1">'March'</span><span class="p">,</span> <span class="s1">'April'</span><span class="p">,</span>
    <span class="s1">'May'</span><span class="p">,</span> <span class="s1">'June'</span><span class="p">,</span> <span class="s1">'July'</span><span class="p">,</span> <span class="s1">'August'</span><span class="p">,</span>
    <span class="s1">'September'</span><span class="p">,</span> <span class="s1">'October'</span><span class="p">,</span> <span class="s1">'November'</span><span class="p">,</span> <span class="s1">'December'</span>
<span class="p">]</span>
<span class="n">colorPalette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'#55efc4'</span><span class="p">,</span> <span class="s1">'#81ecec'</span><span class="p">,</span> <span class="s1">'#a29bfe'</span><span class="p">,</span> <span class="s1">'#ffeaa7'</span><span class="p">,</span> <span class="s1">'#fab1a0'</span><span class="p">,</span> <span class="s1">'#ff7675'</span><span class="p">,</span> <span class="s1">'#fd79a8'</span><span class="p">]</span>
<span class="n">colorPrimary</span><span class="p">,</span> <span class="n">colorSuccess</span><span class="p">,</span> <span class="n">colorDanger</span> <span class="o">=</span> <span class="s1">'#79aec8'</span><span class="p">,</span> <span class="n">colorPalette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colorPalette</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_year_dict</span><span class="p">():</span>
    <span class="n">year_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
        <span class="n">year_dict</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">year_dict</span>


<span class="k">def</span> <span class="nf">generate_color_palette</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colorPalette</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colorPalette</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">colorPalette</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">palette</span>
</code></pre></div>

<p>因此，我们定义了图表颜色，并创建了以下两种方法:</p>
<ol>
<li>创建一个月和值的字典，我们将用它来添加月数据。</li>
<li><code>generate_color_palette(amount)</code>生成一个重复的调色板，我们将把它传递给我们的图表。</li>
</ol>
<h3 id="views">视图</h3>
<p>创建视图:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/views.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.admin.views.decorators</span> <span class="kn">import</span> <span class="n">staff_member_required</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">Avg</span>
<span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">ExtractYear</span><span class="p">,</span> <span class="n">ExtractMonth</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>

<span class="kn">from</span> <span class="nn">shop.models</span> <span class="kn">import</span> <span class="n">Purchase</span>
<span class="kn">from</span> <span class="nn">utils.charts</span> <span class="kn">import</span> <span class="n">months</span><span class="p">,</span> <span class="n">colorPrimary</span><span class="p">,</span> <span class="n">colorSuccess</span><span class="p">,</span> <span class="n">colorDanger</span><span class="p">,</span> <span class="n">generate_color_palette</span><span class="p">,</span> <span class="n">get_year_dict</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">get_filter_options</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">grouped_purchases</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">ExtractYear</span><span class="p">(</span><span class="s1">'time'</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'year'</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'-year'</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">purchase</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span> <span class="k">for</span> <span class="n">purchase</span> <span class="ow">in</span> <span class="n">grouped_purchases</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'options'</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span>
    <span class="p">})</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">get_sales_chart</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">purchases</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">time__year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="n">grouped_purchases</span> <span class="o">=</span> <span class="n">purchases</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">'item__price'</span><span class="p">))</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">ExtractMonth</span><span class="p">(</span><span class="s1">'time'</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'month'</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">'item__price'</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span> <span class="s1">'average'</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'month'</span><span class="p">)</span>

    <span class="n">sales_dict</span> <span class="o">=</span> <span class="n">get_year_dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_purchases</span><span class="p">:</span>
        <span class="n">sales_dict</span><span class="p">[</span><span class="n">months</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s1">'month'</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">'average'</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'Sales in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
        <span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'labels'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">sales_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">'datasets'</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'Amount ($)'</span><span class="p">,</span>
                <span class="s1">'backgroundColor'</span><span class="p">:</span> <span class="n">colorPrimary</span><span class="p">,</span>
                <span class="s1">'borderColor'</span><span class="p">:</span> <span class="n">colorPrimary</span><span class="p">,</span>
                <span class="s1">'data'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">sales_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">}]</span>
        <span class="p">},</span>
    <span class="p">})</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">spend_per_customer_chart</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">purchases</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">time__year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="n">grouped_purchases</span> <span class="o">=</span> <span class="n">purchases</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">'item__price'</span><span class="p">))</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">ExtractMonth</span><span class="p">(</span><span class="s1">'time'</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'month'</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">'item__price'</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span> <span class="s1">'average'</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'month'</span><span class="p">)</span>

    <span class="n">spend_per_customer_dict</span> <span class="o">=</span> <span class="n">get_year_dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_purchases</span><span class="p">:</span>
        <span class="n">spend_per_customer_dict</span><span class="p">[</span><span class="n">months</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="s1">'month'</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">'average'</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'Spend per customer in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
        <span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'labels'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">spend_per_customer_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">'datasets'</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'Amount ($)'</span><span class="p">,</span>
                <span class="s1">'backgroundColor'</span><span class="p">:</span> <span class="n">colorPrimary</span><span class="p">,</span>
                <span class="s1">'borderColor'</span><span class="p">:</span> <span class="n">colorPrimary</span><span class="p">,</span>
                <span class="s1">'data'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">spend_per_customer_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">}]</span>
        <span class="p">},</span>
    <span class="p">})</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">payment_success_chart</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">purchases</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">time__year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'Payment success rate in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
        <span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'labels'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Successful'</span><span class="p">,</span> <span class="s1">'Unsuccessful'</span><span class="p">],</span>
            <span class="s1">'datasets'</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'Amount ($)'</span><span class="p">,</span>
                <span class="s1">'backgroundColor'</span><span class="p">:</span> <span class="p">[</span><span class="n">colorSuccess</span><span class="p">,</span> <span class="n">colorDanger</span><span class="p">],</span>
                <span class="s1">'borderColor'</span><span class="p">:</span> <span class="p">[</span><span class="n">colorSuccess</span><span class="p">,</span> <span class="n">colorDanger</span><span class="p">],</span>
                <span class="s1">'data'</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">purchases</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                    <span class="n">purchases</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">successful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                <span class="p">],</span>
            <span class="p">}]</span>
        <span class="p">},</span>
    <span class="p">})</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">payment_method_chart</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">purchases</span> <span class="o">=</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">time__year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
    <span class="n">grouped_purchases</span> <span class="o">=</span> <span class="n">purchases</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'payment_method'</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">'id'</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'payment_method'</span><span class="p">,</span> <span class="s1">'count'</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'payment_method'</span><span class="p">)</span>

    <span class="n">payment_method_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">payment_method</span> <span class="ow">in</span> <span class="n">Purchase</span><span class="o">.</span><span class="n">PAYMENT_METHODS</span><span class="p">:</span>
        <span class="n">payment_method_dict</span><span class="p">[</span><span class="n">payment_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_purchases</span><span class="p">:</span>
        <span class="n">payment_method_dict</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">Purchase</span><span class="o">.</span><span class="n">PAYMENT_METHODS</span><span class="p">)[</span><span class="n">group</span><span class="p">[</span><span class="s1">'payment_method'</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">'count'</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'Payment method rate in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
        <span class="s1">'data'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'labels'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">payment_method_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">'datasets'</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'Amount ($)'</span><span class="p">,</span>
                <span class="s1">'backgroundColor'</span><span class="p">:</span> <span class="n">generate_color_palette</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payment_method_dict</span><span class="p">)),</span>
                <span class="s1">'borderColor'</span><span class="p">:</span> <span class="n">generate_color_palette</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payment_method_dict</span><span class="p">)),</span>
                <span class="s1">'data'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">payment_method_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">}]</span>
        <span class="p">},</span>
    <span class="p">})</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>获取所有的购买，按年份分组，从时间字段中提取年份，并在列表中返回它们。</li>
<li>获取所有购买(在特定年份)及其价格，按月分组，并计算每月价格总和。</li>
<li>获取所有购买(在特定年份)及其价格，按月分组，并计算月平均价格。</li>
<li><code>payment_success_chart()</code>统计特定年份中成功和不成功的采购。</li>
<li>获取所有购买(在特定年份)，按付款方式分组，计算购买数量，并在字典中返回。</li>
</ol>
<blockquote>
<p>注意，每个视图都有一个<a href="https://docs.djangoproject.com/en/3.1/ref/contrib/admin/#the-staff-member-required-decorator"> @staff_member_required </a>装饰器。</p>
</blockquote>
<h3 id="urls">资源定位符</h3>
<p>创建以下应用程序级别的URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/filter-options/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_filter_options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-filter-options'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/sales/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_sales_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-sales'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/spend-per-customer/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">spend_per_customer_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-spend-per-customer'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/payment-success/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">payment_success_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-payment-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/payment-method/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">payment_method_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-payment-method'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>然后，将应用程序URL连接到项目URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'shop/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'shop.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="testing">测试</h3>
<p>现在我们已经注册了URL，让我们测试一下端点，看看是否一切正常。</p>
<p>创建超级用户，然后运行开发服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py createsuperuser
<span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>然后，在您选择的浏览器中，导航到<a href="http://localhost:8000/shop/chart/filter-options/">http://localhost:8000/shop/chart/filter-options/</a>。您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"options"</span><span class="p">:[</span><span class="w"/>
<span class="w">        </span><span class="mi">2021</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="mi">2020</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="mi">2019</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="mi">2018</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="mi">2017</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="mi">2016</span><span class="w"/>
<span class="w">    </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>要查看2020年的月度销售数据，请导航至<a href="http://localhost:8000/shop/chart/sales/2020/">http://localhost:8000/shop/chart/sales/2020/</a>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"Sales in 2020"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"data"</span><span class="p">:{</span><span class="w"/>
<span class="w">    </span><span class="nt">"labels"</span><span class="p">:[</span><span class="w"/>
<span class="w">      </span><span class="s2">"January"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"February"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"March"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"April"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"May"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"June"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"July"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"August"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"September"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"October"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"November"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="s2">"December"</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"datasets"</span><span class="p">:[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"label"</span><span class="p">:</span><span class="s2">"Amount ($)"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"backgroundColor"</span><span class="p">:</span><span class="s2">"#79aec8"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"borderColor"</span><span class="p">:</span><span class="s2">"#79aec8"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"data"</span><span class="p">:[</span><span class="w"/>
<span class="w">          </span><span class="mf">137.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">88.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">187.5</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">156.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">70.5</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">133.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">142.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">176.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">155.5</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">104.0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">125.5</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="mf">97.0</span><span class="w"/>
<span class="w">        </span><span class="p">]</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">]</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<h2 id="create-charts-with-chartjs">使用Chart.js创建图表</h2>
<p>继续，让我们连接Chart.js。</p>
<p>在“商店”中添加一个“模板”文件夹。然后，添加一个名为<em>statistics.html</em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- shop/templates/statistics.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Statistics<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2e4d464f5c5a00445d6e1c0017001a">[email protected]</a>"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://code.jquery.com/jquery-3.5.1.min.js"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="99fbf6f6edeaedebf8e9b4efadb4feebf0fdb4f6f7f5e0d9a8b7a9b7a9">[email protected]</a>/dist/bootstrap-grid.min.css"</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">"filterForm"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"year"</span><span class="p">&gt;</span>Choose a year:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">"year"</span> <span class="na">id</span><span class="o">=</span><span class="s">"year"</span><span class="p">&gt;&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Load"</span> <span class="na">name</span><span class="o">=</span><span class="s">"_load"</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"row"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"salesChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"paymentSuccessChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"spendPerCustomerChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"paymentMethodChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">salesCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"salesChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">salesChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">salesCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">spendPerCustomerCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"spendPerCustomerChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">spendPerCustomerChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">spendPerCustomerCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentSuccessCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"paymentSuccessChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentSuccessChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">paymentSuccessCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"pie"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">layout</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">              </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">                </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="w"/>
<span class="w">              </span><span class="p">}</span><span class="w"/>
<span class="w">            </span><span class="p">}</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentMethodCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"paymentMethodChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentMethodChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">paymentMethodCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"pie"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">            </span><span class="nx">layout</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">              </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">                </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">                </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="w"/>
<span class="w">              </span><span class="p">}</span><span class="w"/>
<span class="w">            </span><span class="p">}</span><span class="w"/>
<span class="w">          </span><span class="p">}</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>这段代码创建了Chart.js用来初始化的HTML画布。我们还将<code>responsive</code>传递给每个图表的选项，以便它根据窗口大小进行调整。</p>
<p>将以下脚本添加到HTML文件中:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s2">"/shop/chart/filter-options/"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">jsonResponse</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="c1">// Load all the options</span><span class="w"/>
<span class="w">        </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">option</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">Option</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span><span class="w"> </span><span class="nx">option</span><span class="p">));</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="c1">// Load data for the first option</span><span class="w"/>
<span class="w">        </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">first</span><span class="p">().</span><span class="nx">val</span><span class="p">());</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Failed to fetch chart filter options!"</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>

<span class="nx">$</span><span class="p">(</span><span class="s2">"#filterForm"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"submit"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span><span class="w"/>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">year</span><span class="p">)</span><span class="w"/>
<span class="p">});</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">chart</span><span class="p">,</span><span class="w"> </span><span class="nx">endpoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">endpoint</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">jsonResponse</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="c1">// Extract data from the response</span><span class="w"/>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">datasets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">;</span><span class="w"/>

<span class="w">      </span><span class="c1">// Reset the current chart</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>

<span class="w">      </span><span class="c1">// Load new data into the chart</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">title</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="nx">datasets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dataset</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dataset</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="p">});</span><span class="w"/>
<span class="w">      </span><span class="nx">chart</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Failed to fetch chart data from "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">endpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"!"</span><span class="p">)</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="kd">function</span><span class="w"> </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">year</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">salesChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/sales/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">spendPerCustomerChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/spend-per-customer/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">paymentSuccessChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/payment-success/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">paymentMethodChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/payment-method/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>当页面加载时，这个脚本向<code>/chart/filter-options/</code>发送一个AJAX请求，获取所有有效年份，并将它们加载到表单中。</p>
<ol>
<li><code>loadChart</code>将Django端点的图表数据加载到图表中</li>
<li><code>loadAllCharts</code>加载所有图表</li>
</ol>
<blockquote>
<p>注意，为了简单起见，我们使用jQuery来处理AJAX请求。请随意使用<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">获取API </a>来代替。</p>
</blockquote>
<p>Inside <em> shop/views.py </em>创建一个新视图:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">statistics_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'statistics.html'</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div>

<p>不要忘记重要的一点:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
</code></pre></div>

<p>为视图分配URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># shop/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'statistics/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">statistics_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'shop-statistics'</span><span class="p">),</span>  <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/filter-options/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_filter_options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-filter-options'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/sales/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_sales_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-sales'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/spend-per-customer/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">spend_per_customer_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-spend-per-customer'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/payment-success/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">payment_success_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-payment-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'chart/payment-method/&lt;int:year&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">payment_method_chart</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'chart-payment-method'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>您的图表现在可以在以下位置访问:<a href="http://localhost:8000/shop/statistics/">http://localhost:8000/shop/statistics/</a>。</p>
<h2 id="add-charts-to-the-django-admin">向Django管理添加图表</h2>
<p>关于将图表集成到Django admin中，我们可以:</p>
<ol>
<li>创建一个新的Django管理视图</li>
<li>扩展现有管理模板</li>
<li>使用第三方包(即<a href="https://github.com/django-admin-tools/django-admin-tools"> django-admin-tools </a>)</li>
</ol>
<h3 id="create-a-new-django-admin-view">创建一个新的Django管理视图</h3>
<p>创建一个新的Django管理视图是最干净和最直接的方法。在这种方法中，我们将创建一个新的<a href="https://docs.djangoproject.com/en/3.1/ref/contrib/admin/#django.contrib.admin.AdminSite">管理站点</a>，并在<em> settings.py </em>文件中对其进行更改。</p>
<p>首先，在“商店/模板”中，添加一个“管理”文件夹。给它添加一个<em>statistics.html</em>模板:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- shop/templates/admin/statistics.html --&gt;</span>

{% extends "admin/base_site.html" %}
{% block content %}
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4c2f242d3e3862263f0c7e62756278">[email protected]</a>"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://code.jquery.com/jquery-3.5.1.min.js"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c7a5a8a8b3b4b3b5a6b7eab1f3eaa0b5aea3eaa8a9abbe87f6e9f7e9f7">[email protected]</a>/dist/bootstrap-grid.min.css"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">"filterForm"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">"year"</span><span class="p">&gt;</span>Choose a year:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">"year"</span> <span class="na">id</span><span class="o">=</span><span class="s">"year"</span><span class="p">&gt;&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Load"</span> <span class="na">name</span><span class="o">=</span><span class="s">"_load"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s2">"/shop/chart/filter-options/"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">jsonResponse</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="c1">// Load all the options</span><span class="w"/>
<span class="w">        </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">option</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">Option</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span><span class="w"> </span><span class="nx">option</span><span class="p">));</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="c1">// Load data for the first option</span><span class="w"/>
<span class="w">        </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">first</span><span class="p">().</span><span class="nx">val</span><span class="p">());</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Failed to fetch chart filter options!"</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>

<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#filterForm"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"submit"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span><span class="w"/>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#year"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span><span class="w"/>
<span class="w">    </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">year</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">chart</span><span class="p">,</span><span class="w"> </span><span class="nx">endpoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">endpoint</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">jsonResponse</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="c1">// Extract data from the response</span><span class="w"/>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">datasets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">;</span><span class="w"/>

<span class="w">        </span><span class="c1">// Reset the current chart</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"/>

<span class="w">        </span><span class="c1">// Load new data into the chart</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">title</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="nx">datasets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dataset</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">            </span><span class="nx">chart</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dataset</span><span class="p">);</span><span class="w"/>
<span class="w">        </span><span class="p">});</span><span class="w"/>
<span class="w">        </span><span class="nx">chart</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Failed to fetch chart data from "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">endpoint</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"!"</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">loadAllCharts</span><span class="p">(</span><span class="nx">year</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">salesChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/sales/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">spendPerCustomerChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/spend-per-customer/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">paymentSuccessChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/payment-success/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">loadChart</span><span class="p">(</span><span class="nx">paymentMethodChart</span><span class="p">,</span><span class="w"> </span><span class="sb">`/shop/chart/payment-method/</span><span class="si">${</span><span class="nx">year</span><span class="si">}</span><span class="sb">/`</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"row"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"salesChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"paymentSuccessChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"spendPerCustomerChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"col-6"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">"paymentMethodChart"</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">salesCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"salesChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">salesChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">salesCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">spendPerCustomerCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"spendPerCustomerChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">spendPerCustomerChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">spendPerCustomerCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentSuccessCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"paymentSuccessChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentSuccessChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">paymentSuccessCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"pie"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">layout</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="w"/>
<span class="w">        </span><span class="p">}</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentMethodCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"paymentMethodChart"</span><span class="p">).</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">"2d"</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">paymentMethodChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Chart</span><span class="p">(</span><span class="nx">paymentMethodCtx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"pie"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">responsive</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">layout</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">          </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="w"/>
<span class="w">        </span><span class="p">}</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
{% endblock %}
</code></pre></div>

<p>接下来，创建一个<em> core/admin.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/admin.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin.views.decorators</span> <span class="kn">import</span> <span class="n">staff_member_required</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>


<span class="nd">@staff_member_required</span>
<span class="k">def</span> <span class="nf">admin_statistics_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'admin/statistics.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Statistics'</span>
    <span class="p">})</span>


<span class="k">class</span> <span class="nc">CustomAdminSite</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">AdminSite</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_app_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">app_list</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_app_list</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">app_list</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'My Custom App'</span><span class="p">,</span>
                <span class="s1">'app_label'</span><span class="p">:</span> <span class="s1">'my_custom_app'</span><span class="p">,</span>
                <span class="s1">'models'</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'Statistics'</span><span class="p">,</span>
                        <span class="s1">'object_name'</span><span class="p">:</span> <span class="s1">'statistics'</span><span class="p">,</span>
                        <span class="s1">'admin_url'</span><span class="p">:</span> <span class="s1">'/admin/statistics'</span><span class="p">,</span>
                        <span class="s1">'view_only'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">app_list</span>

    <span class="k">def</span> <span class="nf">get_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_urls</span><span class="p">()</span>
        <span class="n">urls</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">path</span><span class="p">(</span><span class="s1">'statistics/'</span><span class="p">,</span> <span class="n">admin_statistics_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'admin-statistics'</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">urls</span>
</code></pre></div>

<p>在这里，我们创建了一个名为<code>admin_statistics_view</code>的人员保护视图。然后，我们创建了一个新的<code>AdminSite</code>并覆盖了<code>get_app_list</code>来添加我们自己的定制应用程序。我们为我们的应用程序提供了一个名为<code>Statistics</code>的人工视图模型。最后，我们覆盖了<code>get_urls</code>，并为我们的新视图分配了一个URL。</p>
<p>在<em> core/apps.py </em>里面创建一个<code>AdminConfig</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/apps.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.admin.apps</span> <span class="kn">import</span> <span class="n">AdminConfig</span>


<span class="k">class</span> <span class="nc">CustomAdminConfig</span><span class="p">(</span><span class="n">AdminConfig</span><span class="p">):</span>
    <span class="n">default_site</span> <span class="o">=</span> <span class="s1">'core.admin.CustomAdminSite'</span>
</code></pre></div>

<p>这里，我们创建了一个新的<code>AdminConfig</code>，它加载我们的<code>CustomAdminSite</code>而不是Django的默认<code>CustomAdminSite</code>。</p>
<p>在<em> core/settings.py </em>中用新的替换默认的<code>AdminConfig</code>:</p>
<div class="codehilite"><pre><span/><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'core.apps.CustomAdminConfig'</span><span class="p">,</span>  <span class="c1"># replaced</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'shop.apps.ShopConfig'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p>导航到<a href="http://localhost:8000/admin/">http://localhost:8000/admin/</a>查看新的Django管理视图。</p>
<p>最终结果:</p>
<p><img data-src="/static/images/blog/django/django-charts/new_admin_app.png" loading="lazy" class="lazyload" alt="new Django admin app" src="../Images/afb04d45b2a708bf77c5dc0f30bafb2e.png" data-original-src="https://testdriven.io/static/images/blog/django/django-charts/new_admin_app.png"/></p>
<p>点击“查看”查看图表:</p>
<p><img data-src="/static/images/blog/django/django-charts/new_admin_app_charts.png" loading="lazy" class="lazyload" alt="new Django admin app charts" src="../Images/bacaa698bf20675b55cf0ccddd530df9.png" data-original-src="https://testdriven.io/static/images/blog/django/django-charts/new_admin_app_charts.png"/></p>
<h3 id="extend-an-existing-admin-template">扩展现有管理模板</h3>
<p>您可以随时扩展管理模板并覆盖您想要的部分。</p>
<p>例如，如果您想在商店模型下放置图表，您可以通过覆盖<a href="https://docs.djangoproject.com/en/3.1/ref/contrib/admin/#templates-which-may-be-overridden-per-app-or-model"> app_index.html </a>模板来实现。在“商店/模板/管理/商店”中添加一个新的<em> app_index.html </em>文件，然后在这里添加找到的HTML<a href="https://github.com/duplxey/django-interactive-charts/blob/master/shop/templates/admin/shop/app_index.html"/>。</p>
<p>最终结果:</p>
<p><img data-src="/static/images/blog/django/django-charts/shop_dashboard.png" loading="lazy" class="lazyload" alt="Django admin template overriding" src="../Images/9b40ca2dc3565c3ce7c19381fee1761e.png" data-original-src="https://testdriven.io/static/images/blog/django/django-charts/shop_dashboard.png"/></p>
<h2 id="conclusion">结论</h2>
<p>在本文中，您学习了如何使用Django提供数据，然后使用Chart.js可视化数据。</p>
<p>从GitHub上的<a href="https://github.com/duplxey/django-interactive-charts">django-interactive-charts</a>repo中获取代码。</p>
  </div>

  </div>    
</body>
</html>