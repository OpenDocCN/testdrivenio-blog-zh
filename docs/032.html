<html>
<head>
<title>Dockerizing Flask with Postgres, Gunicorn, and Nginx </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>装有Postgres、Gunicorn和Nginx的对接烧瓶</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/dockerizing-flask-with-postgres-gunicorn-and-nginx/#0001-01-01">https://testdriven.io/blog/dockerizing-flask-with-postgres-gunicorn-and-nginx/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>这是一个循序渐进的教程，详细介绍了如何配置Flask运行在Docker与Postgres。对于生产环境，我们将添加Nginx和Gunicorn。我们还将看看如何通过Nginx提供静态和用户上传的媒体文件。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>烧瓶v2.2.2</li>
<li>文档v20.10.17</li>
<li>python 3 . 10 . 7版</li>
</ol>



<h2 id="project-setup">项目设置</h2>
<p>创建一个新的项目目录并安装Flask:</p>
<div class="codehilite"><pre><span/><code>$ mkdir flask-on-docker <span class="o">&amp;&amp;</span> <span class="nb">cd</span> flask-on-docker
$ mkdir services <span class="o">&amp;&amp;</span> <span class="nb">cd</span> services
$ mkdir web <span class="o">&amp;&amp;</span> <span class="nb">cd</span> web
$ mkdir project

$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">flask</span><span class="o">==</span><span class="m">2</span>.2.2
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>接下来，让我们创建一个新的Flask应用程序。</p>
<p>添加一个<em> __init__。py </em>文件到" project "目录并配置第一条路由:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">hello</span><span class="o">=</span><span class="s2">"world"</span><span class="p">)</span>
</code></pre></div>

<p>然后，要配置Flask CLI工具从命令行运行和管理应用程序，请将一个<em> manage.py </em>文件添加到“web”目录:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span>


<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>这里，我们创建了一个新的<code>FlaskGroup</code>实例，用与Flask应用程序相关的命令来扩展普通CLI。</p>
<p>从“web”目录运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>project/__init__.py
<span class="o">(</span>env<span class="o">)</span>$ python manage.py run
</code></pre></div>

<p>导航到<a href="http://localhost:5000/"> http://localhost:5000/ </a>。您应该看到:</p>


<p>一旦完成就杀死服务器。退出，然后也删除虚拟环境。</p>
<p>在“web”目录下创建一个<em> requirements.txt </em>文件，并添加Flask作为依赖项:</p>


<p>您的项目结构应该是这样的:</p>
<div class="codehilite"><pre><span/><code>└── services
    └── web
        ├── manage.py
        ├── project
        │   └── __init__.py
        └── requirements.txt
</code></pre></div>

<h2 id="docker">码头工人</h2>
<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有，那么在“web”目录下添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.7-slim-buster</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt /usr/src/app/requirements.txt
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. /usr/src/app/
</code></pre></div>

<p>所以，我们从Python 3.10.7的基于<code>slim-buster</code>的<a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及两个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
</ol>
<p>最后，我们更新了Pip，复制了<em> requirements.txt </em>文件，安装了依赖项，并复制了Flask应用程序本身。</p>
<blockquote>
<p>查看<a href="/blog/docker-best-practices/"> Docker针对Python开发人员的最佳实践</a>，了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将一个<em> docker-compose.yml </em>文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py run -h 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.dev</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>，了解该文件如何工作的信息。</p>
</blockquote>
<p>然后，在项目根目录下创建一个<em> .env.dev </em>文件来存储开发环境变量:</p>
<div class="codehilite"><pre><span/><code>FLASK_APP=project/__init__.py
FLASK_DEBUG=1
</code></pre></div>

<p>建立形象:</p>


<p>构建映像后，运行容器:</p>


<p>导航到<a href="http://localhost:5000/"> http://localhost:5000/ </a>再次查看hello world健全性检查。</p>
<blockquote>
<p>如果这不起作用，通过<code>docker-compose logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="postgres">Postgres</h2>
<p>要配置Postgres，我们需要在<em> docker-compose.yml </em>文件中添加一个新服务，设置<a href="https://flask-sqlalchemy.palletsprojects.com"> Flask-SQLAlchemy </a>，安装<a href="https://www.psycopg.org/"> Psycopg2 </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py run -h 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.dev</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_flask_dev</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>向<em> .env.dev </em>添加一个<code>DATABASE_URL</code>环境变量:</p>
<div class="codehilite"><pre><span/><code><span class="n">FLASK_APP</span><span class="o">=</span><span class="n">project</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w"/>
<span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">1</span><span class="w"/>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">hello_flask</span><span class="p">:</span><span class="n">hello_flask</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">hello_flask_dev</span><span class="w"/>
</code></pre></div>

<p>然后，将一个名为<em> config.py </em>的新文件添加到“项目”目录中，在这里我们将定义特定于环境的<a href="https://flask.palletsprojects.com/config/">配置</a>变量:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>


<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">,</span> <span class="s2">"sqlite://"</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

<p>这里，数据库是基于我们刚刚定义的<code>DATABASE_URL</code>环境变量配置的。记下默认值。</p>
<p>更新<em> __init__。py </em>在init上拉入配置:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s2">"project.config.Config"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">hello</span><span class="o">=</span><span class="s2">"world"</span><span class="p">)</span>
</code></pre></div>

<p>将<a href="https://flask-sqlalchemy.palletsprojects.com"> Flask-SQLAlchemy </a>和<a href="https://www.psycopg.org/"> Psycopg2 </a>添加到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>Flask==2.2.2
Flask-SQLAlchemy==2.5.1
psycopg2-binary==2.9.4
</code></pre></div>

<p>更新<em> __init__。py </em>再次创建一个新的<code>SQLAlchemy</code>实例并定义一个数据库模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s2">"project.config.Config"</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"users"</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">hello</span><span class="o">=</span><span class="s2">"world"</span><span class="p">)</span>
</code></pre></div>

<p>最后，更新<em> manage.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>


<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"create_db"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>这向CLI注册了一个新命令<code>create_db</code>，以便我们可以从命令行运行它，稍后我们将使用它将模型应用到数据库。</p>
<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>创建表格:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py create_db
</code></pre></div>

<blockquote>
<p>得到以下错误？</p>
<div class="codehilite"><pre><span/>sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)
FATAL:  database "hello_flask_dev" does not exist
</pre></div><p>运行<code>docker-compose down -v</code>移除卷和容器。然后，重新构建映像，运行容器，并应用迁移。</p></blockquote>

<p>确保<code>users</code>表已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_flask --dbname<span class="o">=</span>hello_flask_dev

psql <span class="o">(</span><span class="m">13</span>.8<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                        List of databases
      Name       <span class="p">|</span>    Owner    <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>      Access privileges
-----------------+-------------+----------+------------+------------+-----------------------------
 hello_flask_dev <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres        <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0       <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_flask             +
                 <span class="p">|</span>             <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_flask</span><span class="o">=</span>CTc/hello_flask
 template1       <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_flask             +
                 <span class="p">|</span>             <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_flask</span><span class="o">=</span>CTc/hello_flask
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \c hello_flask_dev</span>
You are now connected to database <span class="s2">"hello_flask_dev"</span> as user <span class="s2">"hello_flask"</span>.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \dt</span>
          List of relations
 Schema <span class="p">|</span> Name  <span class="p">|</span> Type  <span class="p">|</span>    Owner
--------+-------+-------+-------------
 public <span class="p">|</span> users <span class="p">|</span> table <span class="p">|</span> hello_flask
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>您也可以通过运行以下命令来检查该卷是否已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker volume inspect flask-on-docker_postgres_data
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2022-10-11T14:43:49Z"</span>,
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{</span>
            <span class="s2">"com.docker.compose.project"</span>: <span class="s2">"flask-on-docker"</span>,
            <span class="s2">"com.docker.compose.version"</span>: <span class="s2">"2.10.2"</span>,
            <span class="s2">"com.docker.compose.volume"</span>: <span class="s2">"postgres_data"</span>
        <span class="o">}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/flask-on-docker_postgres_data/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"flask-on-docker_postgres_data"</span>,
        <span class="s2">"Options"</span>: null,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>

<p>接下来，将一个<em> entrypoint.sh </em>文件添加到“web”目录，以在创建数据库表并运行Flask开发服务器之前，验证Postgres是否已启动<em>和</em>是否健康<em>:</em></p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

python manage.py create_db

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="406400">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<p>记下环境变量。</p>
<p>在本地更新文件权限:</p>
<div class="codehilite"><pre><span/><code>$ chmod +x services/web/entrypoint.sh
</code></pre></div>

<p>然后，更新Docker文件安装<a href="http://netcat.sourceforge.net/"> Netcat </a>，复制<em> entrypoint.sh </em>文件，运行该文件作为Docker <a href="https://docs.docker.com/engine/reference/builder/#entrypoint"> entrypoint </a>命令:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.7-slim-buster</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y netcat

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt /usr/src/app/requirements.txt
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. /usr/src/app/

<span class="c"># run entrypoint.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/usr/src/app/entrypoint.sh"</span><span class="p">]</span>
</code></pre></div>

<p>将<em> entrypoint.sh </em>脚本的<code>SQL_HOST</code>、<code>SQL_PORT</code>和<code>DATABASE</code>环境变量添加到<em> .env.dev </em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">FLASK_APP</span><span class="o">=</span><span class="n">project</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w"/>
<span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">1</span><span class="w"/>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">hello_flask</span><span class="p">:</span><span class="n">hello_flask</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">hello_flask_dev</span><span class="w"/>
<span class="n">SQL_HOST</span><span class="o">=</span><span class="n">db</span><span class="w"/>
<span class="n">SQL_PORT</span><span class="o">=</span><span class="mi">5432</span><span class="w"/>
<span class="k">DATABASE</span><span class="o">=</span><span class="n">postgres</span><span class="w"/>
</code></pre></div>

<p>再次测试:</p>
<ol>
<li>重建图像</li>
<li>运行容器</li>
<li>试试<a href="http://localhost:5000/"> http://localhost:5000/ </a></li>
</ol>
<p>让我们添加一个CLI种子命令，用于将示例用户添加到<em> manage.py </em>中的<code>users</code>表中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span>


<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"create_db"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"seed_db"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">seed_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e38e8a808b82868fa38e8b86918e828dcd8c9184">[email protected]</a>"</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py seed_db

$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_flask --dbname<span class="o">=</span>hello_flask_dev

psql <span class="o">(</span><span class="m">13</span>.8<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \c hello_flask_dev</span>
You are now connected to database <span class="s2">"hello_flask_dev"</span> as user <span class="s2">"hello_flask"</span>.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># select * from users;</span>
 id <span class="p">|</span>        email        <span class="p">|</span> active
----+---------------------+--------
  <span class="m">1</span> <span class="p">|</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c0ada9a3a8a1a5ac80ada8a5b2ada1aeeeafb2a7">[email protected]</a> <span class="p">|</span> t
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<blockquote>
<p>尽管添加了Postgres，我们仍然可以通过不设置<code>DATABASE_URL</code>环境变量来为Flask创建一个独立的Docker映像。要进行测试，构建一个新的映像，然后运行一个新的容器:</p>
<div class="codehilite"><pre><span/>$ docker build -f ./services/web/Dockerfile -t hello_flask:latest ./services/web
$ docker run -p <span class="m">5001</span>:5000 <span class="se">\</span>
    -e <span class="s2">"FLASK_APP=project/__init__.py"</span> -e <span class="s2">"FLASK_DEBUG=1"</span> <span class="se">\</span>
    hello_flask python /usr/src/app/manage.py run -h 0.0.0.0
</pre></div><p>您应该能够在http://localhost:5001 查看hello world健全性检查。</p></blockquote>

<h2 id="gunicorn">格尼科恩</h2>
<p>接下来，对于生产环境，让我们将<a href="https://gunicorn.org/"> Gunicorn </a>，一个生产级的WSGI服务器，添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>Flask==2.2.2
Flask-SQLAlchemy==2.5.1
gunicorn==20.1.0
psycopg2-binary==2.9.4
</code></pre></div>

<p>因为我们仍然希望在开发中使用Flask的内置服务器，所以为生产创建一个名为<em> docker-compose.prod.yml </em>的新合成文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:5000 manage:app</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果您有多个环境，您可能希望使用一个<a href="https://docs.docker.com/compose/extends/">docker-compose . override . yml</a>配置文件。使用这种方法，您可以将您的基本配置添加到一个<em> docker-compose.yml </em>文件中，然后使用一个<em>docker-compose . override . yml</em>文件根据环境覆盖那些配置设置。</p>
</blockquote>
<p>记下默认值<code>command</code>。我们运行的是Gunicorn，而不是Flask开发服务器。我们还从<code>web</code>服务中删除了这个卷，因为我们在生产中不需要它。最后，我们使用<a href="https://docs.docker.com/compose/env-file/">单独的环境变量文件</a>来定义两个服务的环境变量，它们将在运行时传递给容器。</p>
<p><em> .env.prod </em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">FLASK_APP</span><span class="o">=</span><span class="n">project</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w"/>
<span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">0</span><span class="w"/>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">hello_flask</span><span class="p">:</span><span class="n">hello_flask</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">hello_flask_prod</span><span class="w"/>
<span class="n">SQL_HOST</span><span class="o">=</span><span class="n">db</span><span class="w"/>
<span class="n">SQL_PORT</span><span class="o">=</span><span class="mi">5432</span><span class="w"/>
<span class="k">DATABASE</span><span class="o">=</span><span class="n">postgres</span><span class="w"/>
</code></pre></div>

<p><em> .env.prod.db </em>:</p>
<div class="codehilite"><pre><span/><code>POSTGRES_USER=hello_flask
POSTGRES_PASSWORD=hello_flask
POSTGRES_DB=hello_flask_prod
</code></pre></div>

<p>将这两个文件添加到项目根目录。您可能想让它们不受版本控制，所以将它们添加到一个<em>中。gitignore </em>文件。</p>
<p>将<a href="https://docs.docker.com/compose/reference/down/">下放到</a>开发容器(以及带有<code>-v</code>标志的相关卷):</p>


<p>然后，构建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>验证<code>hello_flask_prod</code>数据库是与<code>users</code>表一起创建的。测试出<a href="http://localhost:5000/"> http://localhost:5000/ </a>。</p>
<blockquote>
<p>同样，如果容器启动失败，通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="production-dockerfile">生产文档</h2>
<p>您是否注意到我们仍然在运行<code>create_db</code>命令，每次运行容器时，该命令会删除所有现有的表，然后从模型中创建表。这在开发中很好，但是让我们为生产创建一个新的入口点文件。</p>
<p>entry point . prod . sh:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0b2f4b">[email protected]</a></span><span class="s2">"</span>
</code></pre></div>

<blockquote>
<p>或者，不创建新的入口点文件，您可以修改现有的文件，如下所示:</p>
<div class="codehilite"><pre><span/><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$DATABASE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"postgres"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Waiting for postgres..."</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">"PostgreSQL started"</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$FLASK_DEBUG</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Creating the database tables..."</span>
    python manage.py create_db
    <span class="nb">echo</span> <span class="s2">"Tables created"</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">"</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a286e2">[email protected]</a></span><span class="s2">"</span>
</pre></div></blockquote>

<p>在本地更新文件权限:</p>
<div class="codehilite"><pre><span/><code>$ chmod +x services/web/entrypoint.prod.sh
</code></pre></div>

<p>要使用这个文件，创建一个名为<em> Dockerfile.prod </em>的新Dockerfile，用于生产构建:</p>
<div class="codehilite"><pre><span/><code><span class="c">###########</span>
<span class="c"># BUILDER #</span>
<span class="c">###########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.7-slim-buster</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends gcc

<span class="c"># lint</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install <span class="nv">flake8</span><span class="o">==</span><span class="m">5</span>.0.4
<span class="k">COPY</span><span class="w"> </span>. /usr/src/app/
<span class="k">RUN</span><span class="w"> </span>flake8 --ignore<span class="o">=</span>E501,F401 .

<span class="c"># install python dependencies</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt


<span class="c">#########</span>
<span class="c"># FINAL #</span>
<span class="c">#########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.10.7-slim-buster</span>

<span class="c"># create directory for the app user</span>
<span class="k">RUN</span><span class="w"> </span>mkdir -p /home/app

<span class="c"># create the app user</span>
<span class="k">RUN</span><span class="w"> </span>addgroup --system app <span class="o">&amp;&amp;</span> adduser --system --group app

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y --no-install-recommends netcat
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/wheels /wheels
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install --no-cache /wheels/*

<span class="c"># copy entrypoint-prod.sh</span>
<span class="k">COPY</span><span class="w"> </span>./entrypoint.prod.sh <span class="nv">$APP_HOME</span>

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. <span class="nv">$APP_HOME</span>

<span class="c"># chown all the files to the app user</span>
<span class="k">RUN</span><span class="w"> </span>chown -R app:app <span class="nv">$APP_HOME</span>

<span class="c"># change to the app user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">app</span>

<span class="c"># run entrypoint.prod.sh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"/home/app/web/entrypoint.prod.sh"</span><span class="p">]</span>
</code></pre></div>

<p>在这里，我们使用了一个Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>来缩小最终的图像尺寸。本质上，<code>builder</code>是一个用于构建Python轮子的临时图像。然后车轮被复制到最终产品图像中，而<code>builder</code>图像被丢弃。</p>
<blockquote>
<p>你可以将<a href="https://stackoverflow.com/a/53101932/1799408">多阶段构建方法</a>更进一步，使用单个<em>docker文件</em>而不是创建两个docker文件。思考在两个不同的文件上使用这种方法的利弊。</p>
</blockquote>
<p>您是否注意到我们创建了一个非root用户？默认情况下，Docker在容器内部以root用户身份运行容器进程。这是一种不好的做法，因为如果攻击者设法突破容器，他们可以获得Docker主机的根用户访问权限。如果您是容器中的root用户，那么您将是主机上的root用户。</p>
<p>更新<em> docker-compose.prod.yml </em>文件中的<code>web</code>服务，用<em> Dockerfile.prod </em>构建:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:5000 manage:app</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
</code></pre></div>

<h2 id="nginx">Nginx</h2>
<p>接下来，让我们将Nginx添加进来，充当Gunicorn的反向代理来处理客户端请求以及提供静态文件。</p>
<p>将服务添加到<em> docker-compose.prod.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/nginx</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
</code></pre></div>

<p>然后，在“服务”目录中，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<p><em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.23-alpine</span>

<span class="k">RUN</span><span class="w"> </span>rm /etc/nginx/conf.d/default.conf
<span class="k">COPY</span><span class="w"> </span>nginx.conf /etc/nginx/conf.d
</code></pre></div>

<p><em>engine . conf</em>:</p>
<div class="codehilite"><pre><span/><code>upstream hello_flask <span class="o">{</span>
    server web:5000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_flask<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<blockquote>
<p>回顾<a href="https://www.patricksoftwareblog.com/how-to-configure-nginx-for-a-flask-web-application/">如何为Flask Web应用配置NGINX</a>以获得更多关于配置NGINX与Flask一起工作的信息。</p>
</blockquote>
<p>然后，更新<code>web</code>服务，在<em> docker-compose.prod.yml </em>中，用<code>expose</code>替换<code>ports</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:5000 manage:app</span><span class="w"/>
<span class="w">  </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"/>
<span class="w">  </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>现在，端口5000只在内部对其他Docker服务公开。该端口将不再发布到主机上。</p>
<blockquote>
<p>关于端口与暴露的更多信息，请查看<a href="https://stackoverflow.com/questions/40801772/what-is-the-difference-between-docker-compose-ports-vs-expose">这个</a>堆栈溢出问题。</p>
</blockquote>
<p>再次测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
</code></pre></div>

<p>确保应用程序在<a href="http://localhost:1337"> http://localhost:1337 </a>启动并运行。</p>
<p>您的项目结构现在应该看起来像这样:</p>
<div class="codehilite"><pre><span/><code>├── .env.dev
├── .env.prod
├── .env.prod.db
├── .gitignore
├── docker-compose.prod.yml
├── docker-compose.yml
└── services
    ├── nginx
    │   ├── Dockerfile
    │   └── nginx.conf
    └── web
        ├── Dockerfile
        ├── Dockerfile.prod
        ├── entrypoint.prod.sh
        ├── entrypoint.sh
        ├── manage.py
        ├── project
        │   ├── __init__.py
        │   └── config.py
        └── requirements.txt
</code></pre></div>

<p>完成后将容器拿下来:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>

<p>由于Gunicorn是一个应用服务器，它不会提供静态文件。那么，在这种特定的配置中，应该如何处理静态文件和媒体文件呢？</p>
<h2 id="static-files">静态文件</h2>
<p>首先在“服务/web/项目”文件夹中创建以下文件和文件夹:</p>


<p>给<em> hello.txt </em>添加一些文字:</p>


<p>向<em> __init__添加一个新的路由处理程序。py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/static/&lt;path:filename&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">staticfiles</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"STATIC_FOLDER"</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
</code></pre></div>

<p>不要忘记导入<a href="https://flask.palletsprojects.com/api/#flask.send_from_directory">发送自目录</a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">send_from_directory</span>
</code></pre></div>

<p>最后，将<code>STATIC_FOLDER</code>配置添加到<em>服务/web/project/config.py </em></p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>


<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">,</span> <span class="s2">"sqlite://"</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">STATIC_FOLDER</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'APP_FOLDER'</span><span class="p">)</span><span class="si">}</span><span class="s2">/project/static"</span>
</code></pre></div>

<h3 id="development">发展</h3>
<p>将<code>APP_FOLDER</code>环境变量添加到<em> .env.dev </em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">FLASK_APP</span><span class="o">=</span><span class="n">project</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w"/>
<span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">1</span><span class="w"/>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">hello_flask</span><span class="p">:</span><span class="n">hello_flask</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">hello_flask_dev</span><span class="w"/>
<span class="n">SQL_HOST</span><span class="o">=</span><span class="n">db</span><span class="w"/>
<span class="n">SQL_PORT</span><span class="o">=</span><span class="mi">5432</span><span class="w"/>
<span class="k">DATABASE</span><span class="o">=</span><span class="n">postgres</span><span class="w"/>
<span class="n">APP_FOLDER</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="w"/>
</code></pre></div>

<p>为了进行测试，首先重新构建映像，并像往常一样旋转新的容器。一旦完成，确保<a href="http://localhost:5000/static/hello.txt">http://localhost:5000/static/hello . txt</a>正确地提供文件。</p>
<h3 id="production">生产</h3>
<p>对于生产，向<em> docker-compose.prod.yml </em>中的<code>web</code>和<code>nginx</code>服务添加一个卷，这样每个容器将共享一个名为“static”的目录:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:5000 manage:app</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/project/static</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/project/static</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>接下来，更新Nginx配置，将静态文件请求路由到“static”文件夹:</p>
<div class="codehilite"><pre><span/><code>upstream hello_flask <span class="o">{</span>
    server web:5000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_flask<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/project/static/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>将<code>APP_FOLDER</code>环境变量添加到<em> .env.prod </em>:</p>
<div class="codehilite"><pre><span/><code><span class="n">FLASK_APP</span><span class="o">=</span><span class="n">project</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span><span class="w"/>
<span class="n">FLASK_DEBUG</span><span class="o">=</span><span class="mi">0</span><span class="w"/>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">hello_flask</span><span class="p">:</span><span class="n">hello_flask</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">hello_flask_prod</span><span class="w"/>
<span class="n">SQL_HOST</span><span class="o">=</span><span class="n">db</span><span class="w"/>
<span class="n">SQL_PORT</span><span class="o">=</span><span class="mi">5432</span><span class="w"/>
<span class="k">DATABASE</span><span class="o">=</span><span class="n">postgres</span><span class="w"/>
<span class="n">APP_FOLDER</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">web</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>这个目录路径来自哪里？将该路径与添加到<em> .env.dev </em>的路径进行比较。它们为什么不同呢？</p>
</blockquote>
<p>降低开发容器的转速:</p>


<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>同样，对<code>http://localhost:1337/static/*</code>的请求将由“静态”目录提供服务。</p>
<p>导航到<a href="http://localhost:1337/static/hello.txt">http://localhost:1337/static/hello . txt</a>并确保静态资产被正确加载。</p>
<p>您还可以通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>在日志中验证对静态文件的请求是否通过Nginx成功提供:</p>
<div class="codehilite"><pre><span/><code><span class="m">192</span>.168.80.1 - - <span class="o">[</span><span class="m">11</span>/Oct/2022:15:20:25 +0000<span class="o">]</span> <span class="s2">"GET /static/hello.txt HTTP/1.1"</span> <span class="m">200</span> <span class="m">4</span> <span class="s2">"-"</span>
<span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36"</span> <span class="s2">"-"</span>
</code></pre></div>

<p>完成后带上容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>


<p>为了测试对用户上传的媒体文件的处理，向<em> __init__添加两个新的路由处理程序。py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/media/&lt;path:filename&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mediafiles</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"MEDIA_FOLDER"</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/upload"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload_file</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"MEDIA_FOLDER"</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">"""</span>
<span class="s2">    &lt;!doctype html&gt;</span>
<span class="s2">    &lt;title&gt;upload new File&lt;/title&gt;</span>
<span class="s2">    &lt;form action="" method=post enctype=multipart/form-data&gt;</span>
<span class="s2">      &lt;p&gt;&lt;input type=file name=file&gt;&lt;input type=submit value=Upload&gt;</span>
<span class="s2">    &lt;/form&gt;</span>
<span class="s2">    """</span>
</code></pre></div>

<p>也更新导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span>
    <span class="n">jsonify</span><span class="p">,</span>
    <span class="n">send_from_directory</span><span class="p">,</span>
    <span class="n">request</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
</code></pre></div>

<p>将<code>MEDIA_FOLDER</code>配置添加到<em>services/web/project/config . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>


<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">,</span> <span class="s2">"sqlite://"</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">STATIC_FOLDER</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'APP_FOLDER'</span><span class="p">)</span><span class="si">}</span><span class="s2">/project/static"</span>
    <span class="n">MEDIA_FOLDER</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'APP_FOLDER'</span><span class="p">)</span><span class="si">}</span><span class="s2">/project/media"</span>
</code></pre></div>

<p>最后，在“项目”文件夹中创建一个名为“媒体”的新文件夹。</p>
<h3 id="development_1">发展</h3>
<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>你应该可以在<a href="http://localhost:5000/upload">http://localhost:5000/upload</a>上传一张图片，然后在<a href="http://localhost:5000/media/IMAGE_FILE_NAME">http://localhost:5000/media/IMAGE _ FILE _ NAME</a>查看图片。</p>
<h3 id="production_1">生产</h3>
<p>对于生产，向<code>web</code>和<code>nginx</code>服务添加另一个卷:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gunicorn --bind 0.0.0.0:5000 manage:app</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/project/static</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/project/media</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./.env.prod.db</span><span class="w"/>
<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static_volume:/home/app/web/project/static</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">media_volume:/home/app/web/project/media</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">static_volume</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">media_volume</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>接下来，更新Nginx配置，将媒体文件请求路由到“media”文件夹:</p>
<div class="codehilite"><pre><span/><code>upstream hello_flask <span class="o">{</span>
    server web:5000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_flask<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /static/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/project/static/<span class="p">;</span>
    <span class="o">}</span>

    location /media/ <span class="o">{</span>
        <span class="nb">alias</span> /home/app/web/project/media/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>重建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v

$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
</code></pre></div>

<p>最后一次测试:</p>
<ol>
<li>在<a href="http://localhost:1337/upload">http://localhost:1337/upload</a>上传一张图片。</li>
<li>然后在<a href="http://localhost:1337/media/IMAGE_FILE_NAME">http://localhost:1337/media/IMAGE _ FILE _ NAME</a>查看图片。</li>
</ol>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何用Postgres封装Flask应用程序以进行开发。我们还创建了一个生产就绪的Docker Compose文件，将Gunicorn和Nginx添加到混合文件中，以处理静态和媒体文件。现在，您可以在本地测试生产设置。</p>
<p>就生产环境的实际部署而言，您可能希望使用:</p>
<ol>
<li>完全托管的数据库服务——像<a href="https://aws.amazon.com/rds/"> RDS </a>或<a href="https://cloud.google.com/sql/">云SQL</a>——而不是在一个容器中管理你自己的Postgres实例。</li>
<li><code>db</code>和<code>nginx</code>服务的非根用户</li>
</ol>
<p>你可以在<a href="https://github.com/testdrivenio/flask-on-docker">码头上的烧瓶</a>报告中找到代码。</p>
<p>感谢阅读！</p>
  </div>

  </div>    
</body>
</html>