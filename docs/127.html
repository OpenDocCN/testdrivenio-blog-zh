<html>
<head>
<title>Built-in Permission Classes in Django REST Framework </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django REST框架中内置的权限类</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/built-in-permission-classes-drf/#0001-01-01">https://testdriven.io/blog/built-in-permission-classes-drf/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本文着眼于Django REST框架(DRF)中内置的权限类是如何工作的。</p>
<p>--</p>
<p><strong> Django REST框架权限系列:</strong></p>
<ol>
<li><a href="/blog/drf-permissions">Django REST框架中的权限</a></li>
<li><a href="/blog/built-in-permission-classes-drf">Django REST框架中内置的权限类</a>(本文！)</li>
<li><a href="/blog/custom-permission-classes-drf">Django REST框架中的自定义权限类</a></li>
</ol>



<h2 id="objectives">目标</h2>
<p>完成本文后，您应该能够:</p>
<ol>
<li>解释DRF的七个内置权限类之间的区别</li>
<li>设置特定模型和对象的权限</li>
<li>使用内置权限类来设置全局权限策略</li>
</ol>
<h2 id="built-in-classes">内置类</h2>
<p>虽然你可以创建自己的权限类，但DRF提供了七个内置类，旨在让你的生活更轻松:</p>
<ol>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#allowany">允许</a>使用</li>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#isauthenticated">被认证</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#isauthenticatedorreadonly">isauthenticedorreadonly</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#isadminuser">是管理员</a></li>
<li>姜戈模型权限</li>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#djangomodelpermissionsoranonreadonly">djangodelpermissionsoranonreadonly</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/permissions/#djangoobjectpermissions"> DjangoObjectPermissions </a></li>
</ol>
<p>使用它们就像在特定API视图的<code>permission_classes</code>列表中包含类一样简单。它们从完全开放(<code>AllowAny</code>)到只授予管理员用户的访问权限(<code>IsAdminUser</code>)。只需很少的额外工作，您就可以使用它们来实现细粒度的访问控制——无论是在模型上还是在对象级别上。您还可以为所有API端点全局设置权限。</p>
<p>除了最后一个类<code>DjangoObjectPermissions</code>，所有这些类都只覆盖了<code>has_permission</code>方法，并从<code>BasePermission</code>类继承了<code>has_object_permission</code>。<code>BasePermission</code>类中的<code>has_object_permission</code>总是返回<code>True</code>，所以它对对象级访问限制没有影响:</p>
<table>
<thead>
<tr>
<th>权限类别</th>
<th>拥有_权限</th>
<th>拥有_对象_权限</th>
</tr>
</thead>
<tbody>
<tr>
<td>允许任何</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>已认证</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>isauthentaicatedorreadonly</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>IsAdminUser</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>DjangoModelPermissions</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>djangodelpermissionsoranonreadonly</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>DjangoObjectPermissions</td>
<td>通过扩展<code>DjangoModelPermissions</code></td>
<td>✓</td>
</tr>
</tbody>
</table>
<blockquote>
<p>关于<code>has_permission</code>与<code>has_object_permission</code>的更多信息，请务必阅读本系列的第一篇文章，Django REST框架中的<a href="/blog/drf-permissions">权限</a>。</p>
</blockquote>
<h2 id="allowany">允许任何</h2>
<p>最开放的权限是<code>AllowAny</code>。<code>AllowAny</code>上的<code>has_permission</code>和<code>has_object_permission</code>方法总是不做任何检查就返回<code>True</code>。没有必要使用它(通过不设置permission类，您隐式地设置了这个类)，但您仍然应该使用它，因为它使意图变得明确，并有助于保持整个应用程序的一致性。</p>
<p>通过在视图中包含<code>permission_classes</code>来指定它:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">AllowAny</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">AllowAny</span><span class="p">]</span> <span class="c1"># built-in permission class used</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>任何人，甚至未经身份验证的用户，都可以使用任何HTTP请求方法访问API端点:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/allow_any.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/0a6722b22d9db971929b5d38b140bd27.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/allow_any.png"/></p>
<h2 id="isauthenticated">已认证</h2>
<p><code>IsAuthenticated</code>检查请求是否有用户，以及该用户是否被认证。将<code>permission_classes</code>设置为<code>IsAuthenticated</code>意味着<strong>只有经过认证的</strong>用户才能使用任何请求方法访问API端点。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span> <span class="c1"># permission class changed</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>未经身份验证的用户现在被拒绝访问:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/is_authenticated.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/f62c0bca68a43fc05f9d0beba645fff0.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/is_authenticated.png"/></p>
<h2 id="isauthenticatedorreadonly">isauthentaicatedorreadonly</h2>
<p>当权限设置为<code>IsAuthenticatedOrReadOnly</code>时，请求必须或者有一个经过验证的用户，或者使用一个安全/只读的HTTP请求方法(GET、HEAD、OPTIONS)。这意味着<strong>每个用户</strong>将能够<strong>看到所有</strong>的消息，但是只有登录的用户能够<strong>添加、更改或删除</strong>对象。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticatedOrReadOnly</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">]</span> <span class="c1"># ReadOnly added</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>未经验证的用户可以查看由经过验证的用户发布的消息，但是他们不能对其进行任何操作或添加他们自己的消息:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/authenitcated_or_read_only.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/e3e71bb3378203e417666a73762a064b.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/authenitcated_or_read_only.png"/></p>
<h2 id="isadminuser">IsAdminUser</h2>
<p>权限设置为<code>IsAdminUser</code>意味着请求需要有一个用户，并且该用户必须将<a href="https://docs.djangoproject.com/en/3.2/ref/contrib/auth/#django.contrib.auth.models.User.is_staff">的is_staff </a>设置为<code>True</code>。这意味着只有管理员用户可以<strong>查看、添加、更改或删除</strong>对象。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAdminUser</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAdminUser</span><span class="p">]</span> <span class="c1"># only for admin users</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>有趣的是，未经身份验证的用户和没有管理员权限的经过身份验证的用户会得到不同的错误。</p>
<p>对于未经验证的用户，会引发一个<code>NotAuthenticated</code>异常:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/is_admin_unauthenticated.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/14eda96273651a9f61b0e28e8f49ab31.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/is_admin_unauthenticated.png"/></p>
<p>同时，对于没有管理员访问权限的已验证用户，会引发一个<code>PermissionDenied</code>异常:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/is_admin_authenticated.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/10aaf182b012cb1b9ac425fd265bc267.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/is_admin_authenticated.png"/></p>
<h2 id="djangomodelpermissions">DjangoModelPermissions</h2>
<p><code>DjangoModelPermissions</code>允许我们分别为每个用户设置任意权限组合。然后权限检查用户是否通过了身份验证，以及他们是否对模型拥有<code>add</code>、<code>change</code>或<code>delete</code>用户<a href="https://docs.djangoproject.com/en/3.2/topics/auth/default/#default-permissions">权限</a>。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">DjangoModelPermissions</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoModelPermissions</span><span class="p">]</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>与其他权限不同，这并不是设置权限的结束。您需要为特定用户设置权限:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/user_model_permission_admin.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/81de667904301e0a9265e2d98e604b32.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/user_model_permission_admin.png"/></p>
<p>如果您查看帖子的单一视图，您可以看到该特定用户可以编辑帖子，但不能删除它:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/user_model_permission.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/ed7a75ba7a23592aaa27542c0439ae6d.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/user_model_permission.png"/></p>
<p><code>DjangoModelPermissions</code>不一定需要分配给单个用户。你可以用它获得<a href="https://docs.djangoproject.com/en/3.2/topics/auth/default/#groups">组</a>的权限也可以。以下是允许删除邮件的群组:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/group_permission.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/2e028b43ff1a693e93eaffe169a8750b.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/group_permission.png"/></p>
<p>您可以在这里看到，该组的成员可以删除该消息:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/group_delete_brow_api.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/68295dd69a2c67c4a0ae944c24442f19.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/group_delete_brow_api.png"/></p>
<blockquote>
<p><code>DjangoModelPermissions</code>必须仅应用于具有<code>queryset</code>属性或<code>get_queryset()</code>方法的视图。</p>
<p>例如，<a href="https://www.django-rest-framework.org/api-guide/generic-views/#createapiview"> CreateAPIView </a>通用视图不需要queryset，所以如果你在它上面设置<code>DjangoModelPermissions</code>，你会得到一个断言错误。但是，如果您执行查询，即使您没有使用queryset，<code>DjangoModelPermissions</code>也将工作:</p><div class="codehilite"><pre><span/><span class="k">class</span> <span class="nc">NewMessage</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">CreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoModelPermissions</span><span class="p">]</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</pre></div>
</blockquote>

<h2 id="djangomodelpermissionsoranonreadonly">djangodelpermissionsoranonreadonly</h2>
<p><code>DjangoModelPermissionsOrAnonReadOnly</code>扩展了<code>DjangoModelPermissions</code>，只改变了一件事:将<code>authenticated_users_only</code>设置为<code>False</code>。</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">DjangoModelPermissionsOrAnonReadOnly</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoModelPermissionsOrAnonReadOnly</span><span class="p">]</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>
</code></pre></div>

<p>匿名用户可以看到这些对象，但不能与之交互:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/model_permission_or_anon_read_only.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/5180e0882ea4bb220ea6219a63958ec2.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/model_permission_or_anon_read_only.png"/></p>
<h2 id="djangoobjectpermissions">DjangoObjectPermissions</h2>
<p>虽然<code>DjangoModelPermissions</code>限制了用户与模型(所有实例)交互的权限，但是<code>DjangoObjectPermissions</code>限制了与模型的单个实例(一个对象)的交互。要使用<code>DjangoObjectPermissions</code>，你需要一个支持对象级权限的权限后端。我们将看看<a href="https://github.com/django-guardian/django-guardian">姜戈-卫报</a>。</p>
<blockquote>
<p>虽然有相当多的<a href="https://djangopackages.org/grids/g/perms/">包</a>覆盖了Django权限，<a href="https://www.django-rest-framework.org/api-guide/permissions/#djangoobjectpermissions"> DRF明确提到了django-guardian </a>，这就是为什么我们在本文中使用它。</p>
<p>处理对象级权限的其他包:</p>
<ol>
<li><a href="https://chibisov.github.io/drf-extensions/docs/#object-permissions">drf-扩展</a></li>
<li>姜戈-奥索</li>
<li><a href="https://github.com/dfunckt/django-rules">姜戈-规则</a></li>
<li><a href="https://django-role-permissions.readthedocs.io/en/stable/">django-角色-权限</a></li>
</ol>
</blockquote>
<h3 id="installing-django-guardian">安装django-guardian</h3>
<p>要使用django-guardian，首先需要安装它:</p>
<div class="codehilite"><pre><span/><code>$ pip install django-guardian
</code></pre></div>

<p>然后，将其添加到<code>INSTALLED_APPS</code>和<code>AUTHENTICATION_BACKENDS</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">'rest_framework'</span><span class="p">,</span>
    <span class="s1">'guardian'</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># ...</span>

<span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'django.contrib.auth.backends.ModelBackend'</span><span class="p">,</span>
    <span class="s1">'guardian.backends.ObjectPermissionBackend'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<p>最后，运行迁移:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>如果你想查看单个对象的权限，你需要使用<a href="https://django-guardian.readthedocs.io/en/stable/api/guardian.admin.html#guardedmodeladmin"> GuardedModelAdmin </a>而不是<a href="https://docs.djangoproject.com/en/3.2/ref/contrib/admin/#django.contrib.admin.ModelAdmin"> ModelAdmin </a>。你可以在一个<em> admin.py </em>文件中这样做:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># admin.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">guardian.admin</span> <span class="kn">import</span> <span class="n">GuardedModelAdmin</span>
<span class="kn">from</span> <span class="nn">tutorial.models</span> <span class="kn">import</span> <span class="n">Message</span>

<span class="k">class</span> <span class="nc">MessageAdmin</span><span class="p">(</span><span class="n">GuardedModelAdmin</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Message</span><span class="p">,</span> <span class="n">MessageAdmin</span><span class="p">)</span>
</code></pre></div>

<p>现在，如果你在管理面板中打开一个单独的对象，在右上角会有一个新的按钮叫做“对象权限”。单击它，将打开“对象权限”面板:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/object_permissions_admin.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/d2c2fb84b857c1b1fad8e5223122a4e5.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/object_permissions_admin.png"/></p>
<h3 id="using-djangoobjectpermissions">使用DjangoObjectPermissions</h3>
<p>现在知道<a href="/blog/drf-permissions/"><code>has_permission</code>和<code>has_object_permission</code> </a>的区别将会派上用场。简而言之，DRF首先检查请求是否有访问模型的权限。如果没有，DRF不关心对象级权限。</p>
<p><img data-src="/static/images/blog/django/drf-permissions/permissions_execution.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/961f770659f4bc84df45bc670fdc73a6.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/permissions_execution.png"/></p>
<p>这意味着如果您想要检查对象级权限，用户<strong>必须拥有</strong>模型权限。对象级权限的一个很好的用例是只允许对象的所有者更改或删除它。这里有一个视图，只允许对象的创建者删除它:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># views.py</span>

<span class="kn">from</span> <span class="nn">guardian.shortcuts</span> <span class="kn">import</span> <span class="n">assign_perm</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">DjangoObjectPermissions</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">MessageSerializer</span>


<span class="k">class</span> <span class="nc">MessageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoObjectPermissions</span><span class="p">]</span> <span class="c1"># class changed</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MessageSerializer</span>

    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span> <span class="c1"># new function</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="s2">"delete_message"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</code></pre></div>

<p>如您所见，有两个重要的变化:</p>
<ol>
<li>第一，权限类是<code>DjangoObjectPermissions</code>。</li>
<li>接下来，我们开始创建模型实例。我们不能给一个不存在的对象分配权限，所以我们首先需要创建实例，然后通过django-guardian中的<a href="https://django-guardian.readthedocs.io/en/stable/api/guardian.shortcuts.html#assign-perm"> assign_perm </a>快捷方式给它分配对象权限。</li>
</ol>
<p><code>assign_perm</code>是一个django-guardian函数，用于向某些用户或组分配权限。它需要三个参数:</p>
<ol>
<li>权限:<code>delete_message</code></li>
<li>用户或组:<code>self.request.user</code></li>
<li>对象(默认为<code>None</code> ): <code>instance</code></li>
</ol>
<p>同样，为了使对象权限起作用，用户<strong>必须拥有相应模型的</strong>模型级权限。假设您有两个对模型拥有相同权限的用户:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/object_model_permissions.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/601ae75fae06f4463502f6cc82d4af08.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/object_model_permissions.png"/></p>
<p>您使用上面的代码将权限只分配给创建者。<em> user_1 </em> -对象的创建者-可以删除它，但是<em> user_2 </em>不能删除它，尽管他们有模型级别的权限:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/object_perm_user_cant_delete.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/7785dda088f1e4f4f9f23d2d92687580.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/object_perm_user_cant_delete.png"/></p>
<p>如果我们删除<em> user_1 </em>在模型上删除任何对象的权限:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/user_1_permission_removed.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/95dbc89b230ea6e75da0253d1c1021ff.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/user_1_permission_removed.png"/></p>
<p>他们不能删除他们的邮件:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/object_perm_user_cant_delete.png" loading="lazy" class="lazyload" alt="DRF Permissions Execution" src="../Images/7785dda088f1e4f4f9f23d2d92687580.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/object_perm_user_cant_delete.png"/></p>
<p>即使他们拥有删除该特定对象的权限:</p>
<p><img data-src="/static/images/blog/django/drf-permissions/user_1_has_object_permission.png" loading="lazy" class="lazyload" alt="Django Admin" src="../Images/5cac73fac5898e7f90e51484421d1ed0.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-permissions/user_1_has_object_permission.png"/></p>
<h2 id="global-permissions">全局权限</h2>
<p>您可以使用内置的权限类在您的<em> settings.py </em>文件中轻松设置全局权限。例如:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># settings.py</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DEFAULT_PERMISSION_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'rest_framework.permissions.IsAuthenticated'</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><code>DEFAULT_PERMISSION_CLASSES</code>仅适用于没有明确设置权限的视图或对象。</p>
<blockquote>
<p>这里不一定需要使用内置类。你也可以使用你自己的定制类。</p>
</blockquote>
<h2 id="conclusion">结论</h2>
<p>就是这样。您现在应该知道如何使用Django REST框架的七个内置权限类。它们从完全打开(<code>AllowAny</code>)到基本关闭(<code>IsAdminUser</code>)不等。</p>
<p>您可以在模型(<code>DjangoModelPermissions</code>)或单个对象(<code>DjangoObjectPermissions</code>)上设置全局权限。还有一些类允许你限制“不安全”的HTTP方法，但是允许任何人使用安全的方法(<code>IsAuthenticatedOrReadOnly</code>、<code>DjangoModelPermissionsOrAnonReadOnly</code>)。</p>
<p>如果您没有任何特定的需求，内置的类应该可以满足大多数情况。另一方面，如果你有一些特殊的要求，你应该建立自己的权限类。</p>
<p>--</p>
<p><strong> Django REST框架权限系列:</strong></p>
<ol>
<li><a href="/blog/drf-permissions">Django REST框架中的权限</a></li>
<li><a href="/blog/built-in-permission-classes-drf">Django REST框架中内置的权限类</a>(本文！)</li>
<li><a href="/blog/custom-permission-classes-drf">Django REST框架中的自定义权限类</a></li>
</ol>
  </div>

  </div>    
</body>
</html>