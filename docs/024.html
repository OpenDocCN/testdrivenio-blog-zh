<html>
<head>
<title>Adding Social Authentication to Django </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>向Django添加社会认证</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-social-auth/#0001-01-01">https://testdriven.io/blog/django-social-auth/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本教程着眼于如何使用<a href="https://github.com/pennersr/django-allauth"> Django Allauth </a>向Django应用程序添加社交认证(也称为社交登录或社交登录)。您还将配置GitHub和Twitter认证，以及带有用户名和密码的常规认证。</p>
<blockquote>
<p>社交登录是一种单点登录形式，使用脸书、推特或谷歌等社交网络服务的现有信息登录第三方网站，而不是专门为该网站创建新的登录帐户。它旨在简化最终用户的登录，并为web开发人员提供更可靠的人口统计信息。<br/> - <a href="https://en.wikipedia.org/wiki/Social_login">维基百科</a></p>
</blockquote>
<p>使用社交认证有其优势。您不需要为您的web应用程序设置auth，因为它是由第三方<a href="https://en.wikipedia.org/wiki/List_of_OAuth_providers"> OAuth提供者</a>处理的。此外，由于像谷歌、脸书和GitHub这样的提供商执行广泛的检查来防止对其服务的未经授权的访问，利用社交认证而不是滚动您自己的认证机制可以提高您的应用程序的安全性。</p>
<p><img data-src="/static/images/gifs/blog/django-social-auth/demo.gif" loading="lazy" class="lazyload" alt="django social auth demo" src="../Images/14e4b4ed1f90dc024ab9a3264b3727e1.png" data-original-src="https://testdriven.io/static/images/gifs/blog/django-social-auth/demo.gif"/></p>



<h2 id="oauth">OAuth</h2>
<p>社交认证通常是通过OAuth来实现的，OAuth是一种开放的标准认证协议，由第三方认证提供商来验证用户的身份。</p>
<p>典型流程:</p>
<ol>
<li>用户试图使用第三方身份验证提供商的帐户登录您的应用程序</li>
<li>它们被重定向到身份验证提供者进行验证</li>
<li>验证后，它们会被重定向回你的应用程序</li>
<li>然后他们登录，这样他们就可以访问受保护的资源</li>
</ol>
<blockquote>
<p>有关OAuth的更多信息，请查看<a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">OAuth 2的介绍</a>。</p>
</blockquote>
<p>为什么要利用OAuth而不是滚动自己的Auth呢？</p>
<p><strong>优点</strong>:</p>
<ol>
<li>提高安全性。</li>
<li>由于无需创建和记住用户名或密码，登录流程更加简单快捷。</li>
<li>在安全漏洞的情况下，不会发生第三方损害，因为认证是无密码的。</li>
</ol>
<p><strong>缺点</strong>:</p>
<ol>
<li>您的应用程序现在依赖于您控制之外的另一个应用程序。如果提供商关闭，用户将无法登录。</li>
<li>人们往往会忽略OAuth提供者请求的权限。</li>
<li>在您配置的提供商中没有帐户的用户将无法访问您的应用程序。最好的方法是同时实现用户名、密码和社交认证，让用户自己选择。</li>
</ol>
<h2 id="django-allauth-vs-python-social-auth">django Allauth vs . Python Social Auth</h2>
<p>Django Allauth 和<a href="https://python-social-auth.readthedocs.io/en/latest/"> Python Social Auth </a>是在Django中实现社会认证的两个最流行的包。你应该用哪一个？</p>
<h3 id="django-allauth">姜戈·阿劳斯</h3>
<p><strong>优点</strong>:</p>
<ol>
<li>Django Allauth是最受欢迎的Django包之一。</li>
<li>它支持50多个身份验证提供商(例如GitHub、Twitter、Google)。</li>
<li>除了社交认证，它还提供常规的用户名和密码认证。</li>
<li>Django Allauth使得定制授权流程中使用的表单变得很容易。</li>
</ol>
<p><strong>缺点</strong>:</p>
<ol>
<li>尽管这个包很受欢迎，但是文档结构很差，不适合初学者。</li>
<li>注册OAuth提供者需要相当多的初始设置，这对初学者来说可能很困难。</li>
<li>GitHub上有310多个问题(截至发稿时)。</li>
</ol>
<h3 id="python-social-auth">Python社交认证</h3>
<p><strong>优点</strong>:</p>
<ol>
<li>Python Social Auth提供了对几个Python web框架的支持，如Django、Flask、Webpy、Pyramid和Tornado。</li>
<li>它支持近50个OAuth提供者。</li>
<li>它支持Django ORM和<a href="http://mongoengine.org/"> MongoEngine </a> ODM。</li>
<li>
<p>它提供了一个存储接口，允许用户添加更多的ORM。</p>
<blockquote>
<p>例如，要了解如何使用存储接口来处理SQLAlchemy ORM，请在这里查看代码<a href="https://github.com/python-social-auth/social-storage-sqlalchemy/blob/1.1.0/social_sqlalchemy/storage.py"/>。查看<a href="https://python-social-auth.readthedocs.io/en/latest/storage.html#storage-interface">官方文档</a>，了解更多关于如何使用存储接口的信息。</p>
</blockquote>
</li>
</ol>
<p><strong>缺点</strong>:</p>
<ol>
<li>文档稍微简单一点，但是仍然需要做一些与组织相关的工作。</li>
<li>同样，注册OAuth提供者需要相当多的初始设置，这对初学者来说可能很困难。</li>
<li>GitHub上有将近125个未解决的问题(截至发稿时)。</li>
</ol>
<p><br/></p>
<p>这两种包装都有其起伏。然而，本教程主要关注Django Allauth，因为它更受欢迎，并且支持通过用户名和密码进行社交认证和常规认证。</p>
<h2 id="django-setup">Django Setup</h2>
<p>让我们创建一个新的Django项目并配置Django Allauth。</p>
<h3 id="create-a-new-django-project">创建新的Django项目</h3>
<p>首先创建一个虚拟环境并安装Django:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-social-auth <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-social-auth
$ python3.11 -m venv .venv
$ <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span>$ pip install <span class="nv">Django</span><span class="o">==</span><span class="m">4</span>.1.3
</code></pre></div>

<blockquote>
<p>随意把venv和Pip换成<a href="https://python-poetry.org">诗歌</a>或<a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>现在创建一个新项目，应用迁移，并运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ django-admin startproject social_app .
<span class="o">(</span>.venv<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>.venv<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>导航到<a href="http://127.0.0.1:8000"> http://127.0.0.1:8000 </a>。您应该会看到以下屏幕:</p>
<p><img data-src="/static/images/blog/django/django-social-auth/django_landing.png" loading="lazy" class="lazyload" alt="django landing page" src="../Images/d614b41fc7fb029b249821ab947ff1e1.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/django_landing.png"/></p>
<h3 id="configure-django-allauth">Configure Django Allauth</h3>
<p>接下来，让我们为Django应用程序设置Django Allauth。</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ pip install django-allauth<span class="o">==</span><span class="m">0</span>.51.0
</code></pre></div>

<p>为了让Django Allauth使用我们的Django应用程序，更新<em> settings.py </em>文件中的<code>INSTALLED_APPS</code>,如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># social_app/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"django.contrib.admin"</span><span class="p">,</span>
    <span class="s2">"django.contrib.auth"</span><span class="p">,</span>
    <span class="s2">"django.contrib.contenttypes"</span><span class="p">,</span>
    <span class="s2">"django.contrib.sessions"</span><span class="p">,</span>
    <span class="s2">"django.contrib.messages"</span><span class="p">,</span>
    <span class="s2">"django.contrib.staticfiles"</span><span class="p">,</span>
    <span class="s2">"django.contrib.sites"</span><span class="p">,</span>  <span class="c1"># new</span>
    <span class="c1"># 3rd party</span>
    <span class="s2">"allauth"</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="s2">"allauth.account"</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="s2">"allauth.socialaccount"</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="c1"># social providers</span>
    <span class="s2">"allauth.socialaccount.providers.github"</span><span class="p">,</span> <span class="c1"># new</span>
    <span class="s2">"allauth.socialaccount.providers.twitter"</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>首先，我们添加了<a href="https://docs.djangoproject.com/en/4.1/ref/contrib/sites/"> Django“站点”框架</a>，这是Allauth正常工作所必需的。然后我们添加了核心的Allauth应用程序:<code>allauth</code>、<code>allauth.account</code>和<code>allauth.socialaccount</code>。</p>
<p>现在将以下内容添加到<em> settings.py </em>的底部:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># social_app/settings.py</span>

<span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">"allauth.account.auth_backends.AuthenticationBackend"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">SITE_ID</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ACCOUNT_EMAIL_VERIFICATION</span> <span class="o">=</span> <span class="s2">"none"</span>
<span class="n">LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s2">"home"</span>
<span class="n">ACCOUNT_LOGOUT_ON_GET</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<p>这里，我们定义了以下内容:</p>
<ul>
<li>我们添加了<code>allauth</code>作为认证后端。所有登录和退出(通过OAuth或常规用户名和密码)现在将由Allauth处理。</li>
<li><code>SITE_ID</code>，Django Allauth需要它才能运行。</li>
<li><code>ACCOUNT_EMAIL_VERIFICATION = "none"</code>关闭验证邮件。Django自动建立了一个电子邮件验证工作流程。我们现在不需要这个功能。</li>
<li>成功登录后，将用户重定向到主页。</li>
<li><code>ACCOUNT_LOGOUT_ON_GET = True</code>当通过GET请求点击注销按钮时，直接将用户注销。这跳过了<a href="https://django-allauth.readthedocs.io/en/latest/views.html#logout-account-logout">确认注销页面</a>。</li>
</ul>
<p>更新<em> urls.py </em>以包含Django Allauth:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span> <span class="c1"># new</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">"admin/"</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">"accounts/"</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s2">"allauth.urls"</span><span class="p">)),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>应用与Django Allauth相关的迁移文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<blockquote>
<p>迁移在这里很重要，因为Allauth需要大量新表。别忘了这一步！</p>
</blockquote>
<p>创建超级用户:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ python manage.py createsuperuser
</code></pre></div>

<h3 id="templates">模板</h3>
<p>新建一个名为“templates”的文件夹，添加两个名为<em> _base.html </em>和【home.html】T2的文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ mkdir templates <span class="o">&amp;&amp;</span> <span class="nb">cd</span> templates
<span class="o">(</span>.venv<span class="o">)</span>$ touch _base.html home.html
</code></pre></div>

<p>更新<em> settings.py </em>中的<code>TEMPLATES</code>，以便Django知道在哪里可以找到模板:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># social_app/settings.py</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="o">...</span>
        <span class="s2">"DIRS"</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"templates"</span><span class="p">))],</span>
        <span class="o">...</span>
    <span class="p">},</span>
<span class="p">]</span>
</code></pre></div>

<p><em> templates/_base.html </em>:</p>
<div class="codehilite"><pre><span/><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span>
      <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4c2e2323383f383e2d3c0c79627e627e">[email protected]</a>/dist/css/bootstrap.min.css"</span>
      <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span>
      <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span>
      <span class="na">href</span><span class="o">=</span><span class="s">"https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1.0"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django Social Login<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    {% block content %} {% endblock content %}
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><em> templates/home.html </em></p>
<div class="codehilite"><pre><span/><code>{% extends '_base.html' %} {% load socialaccount %}

{% block content %}

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align: center; padding-top: 10%;"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Django Social Login<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>

  {% if user.is_authenticated %}
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Welcome {{ user.username }} !!!<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% url 'account_logout' %}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger"</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  {% endif %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

{% endblock content %}
</code></pre></div>

<p>创建一个视图来提供<em>home.html</em>模板:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># social_app/views.py</span>

<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>


<span class="k">class</span> <span class="nc">Home</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">"home.html"</span>
</code></pre></div>

<p>添加新的URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># social_app/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">Home</span> <span class="c1"># new</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">"admin/"</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">"accounts/"</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s2">"allauth.urls"</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">Home</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">"home"</span><span class="p">),</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>就是这样！Django Allauth已配置好，可以测试了。现在，您应该能够通过用户名和密码登录。运行服务器。导航到<a href="http://127.0.0.1:8000/accounts/login/">http://127 . 0 . 0 . 1:8000/accounts/log in/</a>。确保您可以使用超级用户凭据登录。</p>
<blockquote>
<p>您可能想要覆盖默认模板来应用CSS样式等等。查看官方文档中的<a href="https://django-allauth.readthedocs.io/en/latest/templates.html">模板</a>页面了解更多信息。</p>
</blockquote>
<h2 id="github-provider">GitHub提供商</h2>
<p>现在Django和Django Allauth都准备好了，让我们连接我们的第一个社会认证提供者:GitHub。</p>
<h3 id="app">应用</h3>
<p>首先，我们需要创建一个OAuth应用程序，并从GitHub获取OAuth密钥。登录你的GitHub账户，然后导航到<a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a>创建一个新的<a href="https://docs.github.com/en/free-pro-team@latest/developers/apps/authorizing-oauth-apps"> OAuth应用</a>:</p>
<div class="codehilite"><pre><span/><code>Application name: Testing Django Allauth
Homepage URL: http://127.0.0.1:8000
Callback URL: http://127.0.0.1:8000/accounts/github/login/callback
</code></pre></div>

<p><img data-src="/static/images/blog/django/django-social-auth/register_github_oauth_app.png" loading="lazy" class="lazyload" alt="register github oauth app" src="../Images/fb527846d58adc737a6a07f9b5137761.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/register_github_oauth_app.png"/></p>
<p>点击“注册申请”。你将被重定向至你的应用。记下客户端ID和客户端密码:</p>
<p><img data-src="/static/images/blog/django/django-social-auth/github_oauth_app.png" loading="lazy" class="lazyload" alt="github oauth ap" src="../Images/4033247f95d0d2655426527dd7e1ad6c.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/github_oauth_app.png"/></p>
<blockquote>
<p>如果没有生成客户端密码，请点按“生成新的客户端密码”。</p>
</blockquote>
<p>接下来，我们需要在Django管理面板中添加GitHub提供者。</p>
<p>运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>在<a href="http://127.0.0.1:8000/admin">http://127 . 0 . 0 . 1:8000/admin</a>登录管理员。然后，在“社交应用”下，点击“添加社交应用”:</p>
<ul>
<li>选择GitHub作为提供商</li>
<li>添加姓名</li>
<li>将先前获得的客户端ID和客户端秘密添加到秘密密钥中</li>
<li>将example.com添加为所选地点之一</li>
</ul>
<p><img data-src="/static/images/blog/django/django-social-auth/django_admin_github.png" loading="lazy" class="lazyload" alt="django admin github oauth provider setup" src="../Images/f49240fca3d96dde7dfd246eaffd79f2.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/django_admin_github.png"/></p>
<p>我们已经成功地将GitHub整合为一个社交认证提供商。现在，让我们更新一下<em> templates/home.html </em>模板来测试一下:</p>
<div class="codehilite"><pre><span/><code>{% extends '_base.html' %} {% load socialaccount %}

{% block content %}

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align: center; padding-top: 10%;"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Django Social Login<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>

  {% if user.is_authenticated %}
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Welcome {{ user.username }} !!!<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% url 'account_logout' %}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger"</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  {% else %}
    <span class="cm">&lt;!-- GitHub button starts here --&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% provider_login_url 'github' %}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-secondary"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">"fa fa-github fa-fw"</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Login with GitHub<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- GitHub button ends here --&gt;</span>
  {% endif %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

{% endblock content %}
</code></pre></div>

<p>运行应用程序。你现在应该可以通过GitHub登录了。</p>
<p><img data-src="/static/images/blog/django/django-social-auth/django_github_social_auth.png" loading="lazy" class="lazyload" alt="django github social auth" src="../Images/2752c03f97064616797219cc0b4d0730.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/django_github_social_auth.png"/></p>
<p>登录后，您应该会在<a href="http://127.0.0.1:8000/admin/auth/user/">http://127 . 0 . 0 . 1:8000/admin/auth/user/</a>看到用户，以及在<a href="http://127.0.0.1:8000/admin/socialaccount/socialaccount/">http://127 . 0 . 0 . 1:8000/admin/socialaccount/socialaccount/</a>看到关联的社交账户。如果你查看社交账户，你会看到与GitHub账户相关的所有公开数据。这些数据(称为<a href="https://oauth.net/2/scope/">范围</a>)可以用于你在Django上的用户资料。为此，建议使用定制的<a href="https://docs.djangoproject.com/en/4.1/ref/contrib/auth/#user-model">用户模型</a>。更多信息，请查看<a href="/blog/django-custom-user-model/">在Django </a>中创建定制用户模型。</p>
<blockquote>
<p>您是否需要对Allauth默认范围之外的用户信息进行读写访问？从官方文件中查看<a href="https://django-allauth.readthedocs.io/en/latest/advanced.html#changing-provider-scopes">变更提供商范围</a>。</p>
</blockquote>

<p>设置Twitter提供者类似于GitHub:</p>
<ol>
<li>在Twitter上创建OAuth应用程序</li>
<li>在Django admin中注册提供者</li>
<li>更新<em>home.html</em>模板</li>
</ol>
<p>从<a href="https://developer.twitter.com/en/portal/dashboard">申请一个Twitter开发者账户</a>开始。创建完成后，导航至<a href="https://developer.twitter.com/en/portal/projects-and-apps">项目和应用</a>，点击“创建应用”。</p>
<p>为应用程序命名，并记下API密钥和API密钥。然后，在“认证设置”下，打开“启用3脚OAuth”和“向用户请求电子邮件地址”。添加回拨、网站、服务条款和隐私政策URL:</p>
<div class="codehilite"><pre><span/><code>Callback URL: http://127.0.0.1:8000/accounts/twitter/login/callback
Website URL: http://example.com
Terms of service: http://example.com
Privacy policy: http://example.com
</code></pre></div>

<p><img data-src="/static/images/blog/django/django-social-auth/register_twitter_oauth_app.png" loading="lazy" class="lazyload" alt="register twitter oauth app" src="../Images/545749f35d9c5fc1452ed786270a96d6.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/register_twitter_oauth_app.png"/></p>
<p>让我们在Django管理中添加提供者。</p>
<p>运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>在<a href="http://127.0.0.1:8000/admin">http://127 . 0 . 0 . 1:8000/admin</a>登录管理员。然后，在“社交应用”下，点击“添加社交应用”:</p>
<ul>
<li>选择Twitter作为提供商</li>
<li>添加姓名</li>
<li>将先前获得的API密钥(添加到客户端id)和API秘密密钥(添加到秘密密钥)</li>
<li>将example.com添加为所选地点之一</li>
</ul>
<p><img data-src="/static/images/blog/django/django-social-auth/django_admin_twitter.png" loading="lazy" class="lazyload" alt="django admin twitter oauth provider setup" src="../Images/c4c172896bf04f4c008762cfb6c582e7.png" data-original-src="https://testdriven.io/static/images/blog/django/django-social-auth/django_admin_twitter.png"/></p>
<blockquote>
<p>记住保护您的API密钥和令牌。</p>
</blockquote>
<p>最后，在<em> templates/home.html </em>中添加一个“用Twitter登录”按钮:</p>
<div class="codehilite"><pre><span/><code>{% extends '_base.html' %} {% load socialaccount %}

{% block content %}

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container"</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align: center; padding-top: 10%;"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Django Social Login<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>

  {% if user.is_authenticated %}
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Welcome {{ user.username }} !!!<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% url 'account_logout' %}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger"</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  {% else %}

    ...

    <span class="cm">&lt;!-- Twitter button starts here --&gt;</span>
      <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% provider_login_url 'twitter' %}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">"fa fa-twitter fa-fw"</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Login with Twitter<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- Twitter button ends here --&gt;</span>
  {% endif %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

{% endblock content %}
</code></pre></div>

<p>导航到<a href="http://127.0.0.1:8000"> http://127.0.0.1:8000 </a>以测试身份验证工作流。</p>
<h2 id="conclusion">结论</h2>
<p>本教程详细介绍了如何用Django和Django Allauth设置社交认证。现在，您应该对如何连接新的社交认证提供商有了深入的了解:</p>
<ol>
<li>将适当的Allauth应用程序添加到设置文件中的<code>INSTALLED_APPS</code></li>
<li>在提供商的开发人员站点上创建一个OAuth应用程序，并记录令牌/密钥/秘密</li>
<li>在Django管理中注册应用程序</li>
<li>将URL添加到模板中</li>
</ol>
<p>尽管本教程关注的是Django Allauth，但这并不意味着它应该在每种情况下都用于Python Social Auth。探索这两个包。尝试实现自定义表单并链接多个社交帐户。</p>
<p>从GitHub上的<a href="https://github.com/testdrivenio/django-social-auth"> django-social-auth </a>库获取代码。</p>
  </div>

  </div>    
</body>
</html>