<html>
<head>
<title>Adding Social Authentication to Flask </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>向Flask添加社会身份验证</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/flask-social-auth/#0001-01-01">https://testdriven.io/blog/flask-social-auth/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何使用GitHub和Twitter向Flask应用程序添加social auth。</p>
<blockquote>
<p>社交认证(也称为社交登录或社交登录)是基于第三方服务对用户进行认证的过程，而不依赖于您自己的认证服务。例如，你在许多网站上看到的“用谷歌登录”按钮就是社交认证的最好例子。Google对用户进行身份验证，并向应用程序提供一个令牌来管理用户的会话。</p>
</blockquote>
<p>使用社交认证有其优势。您不需要为web应用程序设置auth，因为它是由第三方<a href="https://en.wikipedia.org/wiki/List_of_OAuth_providers"> OAuth提供者</a>处理的。此外，由于像谷歌、脸书和GitHub这样的提供商执行广泛的检查来防止对其服务的未经授权的访问，利用社交认证而不是滚动您自己的认证机制可以提高您的应用程序的安全性。</p>
<p>除了Flask，我们还将使用<a href="https://flask-dance.readthedocs.io/en/latest/"> Flask-Dance </a>来启用社交认证，<a href="https://flask-login.readthedocs.io/"> Flask-Login </a>用于登录和注销用户并管理会话，以及<a href="https://flask-sqlalchemy.palletsprojects.com/en/3.0.x/"> Flask-SQLAlchemy </a>用于与数据库交互以存储用户相关数据。</p>



<h2 id="why-use-social-authentication">为什么要使用社交认证？</h2>
<p>你为什么想要利用社交认证而不是自己的认证呢？</p>
<h4 id="pros">赞成的意见</h4>
<ol>
<li>无需启动您自己的身份认证工作流程。</li>
<li>提高安全性。第三方认证提供商，如谷歌、脸书等。，高度重视安全性。使用这样的服务可以提高您自己的应用程序的安全性。</li>
<li>您可以从身份验证提供程序自动检索用户名、电子邮件和其他数据。这通过消除这一步骤(手动询问他们)改善了注册体验。</li>
</ol>
<h4 id="cons">骗局</h4>
<ol>
<li>您的应用程序现在依赖于您控制之外的另一个应用程序。如果第三方应用关闭，用户将无法注册或登录。</li>
<li>人们往往会忽略身份验证提供者请求的权限。一些应用程序甚至可能访问不需要的数据。</li>
<li>在您配置的提供商中没有帐户的用户将无法访问您的应用程序。最好的方法是同时实现这两者——即用户名和密码以及社交认证——并让用户选择。</li>
</ol>
<h2 id="oauth">OAuth</h2>
<p>社交认证通常是通过OAuth来实现的，OAuth是一种开放的标准认证协议，由第三方认证提供商来验证用户的身份。</p>
<p>最常见的流程(或授权)是<a href="https://oauth.net/2/grant-types/authorization-code/">授权码</a>:</p>
<ol>
<li>用户试图使用第三方身份验证提供商的帐户登录您的应用程序。</li>
<li>它们被重定向到身份验证提供者进行验证。</li>
<li>验证后，它们会通过授权码重定向回你的应用。</li>
<li>然后，您需要使用访问令牌的授权代码向auth provider发出请求。</li>
<li>在提供商验证授权码之后，他们发送回访问令牌。</li>
<li>然后用户登录，这样他们就可以访问受保护的资源。</li>
<li>然后，可以使用访问令牌从身份验证提供者获取数据。</li>
</ol>
<blockquote>
<p>有关OAuth的更多信息，请查看<a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">OAuth 2的介绍</a>。</p>
</blockquote>
<p>让我们看一个使用GitHub的流程的快速示例:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""</span>
<span class="sd">Import necessary modules.</span>
<span class="sd">  - `os` to read env variable</span>
<span class="sd">  - `requests` to make GET/POST requests</span>
<span class="sd">  - `parse_qs` to parse the response</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">parse_qs</span>


<span class="sd">"""</span>
<span class="sd">Define the GITHUB_ID and GITHUB_SECRET environment variables</span>
<span class="sd">along with the endpoints.</span>
<span class="sd">"""</span>
<span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_ID"</span><span class="p">)</span>
<span class="n">CLIENT_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_SECRET"</span><span class="p">)</span>
<span class="n">AUTHORIZATION_ENDPOINT</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"https://github.com/login/oauth/authorize?response_type=code&amp;client_id=</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'GITHUB_ID'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="n">TOKEN_ENDPOINT</span> <span class="o">=</span> <span class="s2">"https://github.com/login/oauth/access_token"</span>
<span class="n">USER_ENDPOINT</span> <span class="o">=</span> <span class="s2">"https://api.github.com/user"</span>


<span class="sd">"""</span>
<span class="sd">1. Log in via the browser using the 'Authorization URL' outputted in the terminal.</span>
<span class="sd">   (If you're already logged in to GitHub, either log out or test in an incognito/private browser window.)</span>
<span class="sd">2. Once logged in, the page will redirect. Grab the code from the redirect URL.</span>
<span class="sd">3. Paste the code in the terminal.</span>
<span class="sd">"""</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Authorization URL: </span><span class="si">{</span><span class="n">AUTHORIZATION_ENDPOINT</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">code</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Enter the code: "</span><span class="p">)</span>


<span class="sd">"""</span>
<span class="sd">Using the authorization code, we can request an access token.</span>
<span class="sd">"""</span>
<span class="c1"># Once we get the code, we sent the code to the access token</span>
<span class="c1"># endpoint(along with id and secret). The response contains</span>
<span class="c1"># the access_token and we parse is using parse_qs</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="n">TOKEN_ENDPOINT</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">client_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_ID"</span><span class="p">),</span>
        <span class="n">client_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_SECRET"</span><span class="p">),</span>
        <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">"access_token"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


<span class="sd">"""</span>
<span class="sd">Finally, we can use the access token to obtain information about the user.</span>
<span class="sd">"""</span>
<span class="n">user_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_ENDPOINT</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Authorization</span><span class="o">=</span><span class="sa">f</span><span class="s2">"token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span><span class="p">))</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"login"</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"You are </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> on GitHub"</span><span class="p">)</span>
</code></pre></div>

<p>为了进行测试，将这段代码保存到一个名为<em> oauth.py </em>的文件中。请务必查看评论。</p>
<p>接下来，您需要创建一个OAuth应用程序，并从GitHub获取OAuth密钥。</p>
<p>登录你的GitHub账户，然后导航到<a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a>创建一个新的<a href="https://docs.github.com/en/free-pro-team@latest/developers/apps/authorizing-oauth-apps"> OAuth应用</a>:</p>
<div class="codehilite"><pre><span/><code>Application name: Testing Flask-Dance
Homepage URL: http://127.0.0.1:5000
Callback URL: http://127.0.0.1:5000/login/github/authorized
</code></pre></div>

<p><img data-src="/static/images/blog/flask-social-auth/register_github_oauth_app.png" loading="lazy" class="lazyload" alt="register github oauth app" src="../Images/057e2b0ee228b855b5d8b1d7492952ab.png" data-original-src="https://testdriven.io/static/images/blog/flask-social-auth/register_github_oauth_app.png"/></p>
<p>点击“注册申请”。你将被重定向至你的应用。记下客户端ID和客户端密码:</p>
<p><img data-src="/static/images/blog/flask-social-auth/github_oauth_app.png" loading="lazy" class="lazyload" alt="github oauth ap" src="../Images/e6c919d6427e16431e563989f6b47697.png" data-original-src="https://testdriven.io/static/images/blog/flask-social-auth/github_oauth_app.png"/></p>
<blockquote>
<p>如果没有生成客户端密码，请点按“生成新的客户端密码”。</p>
</blockquote>
<p>将生成的客户端ID和客户端密码设置为环境变量:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">GITHUB_ID</span><span class="o">=</span>&lt;your-github-id&gt;
$ <span class="nb">export</span> <span class="nv">GITHUB_SECRET</span><span class="o">=</span>&lt;your-github-secret&gt;
<span class="c1"># for windows machine, use `set` instead of `export`</span>
</code></pre></div>

<p>安装<a href="https://requests.readthedocs.io/en/master/">请求</a>库，然后运行脚本:</p>
<div class="codehilite"><pre><span/><code>$ pip install requests
$ python oauth.py
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code>Authorization URL: https://github.com/login/oauth/authorize?response_type<span class="o">=</span>code<span class="p">&amp;</span><span class="nv">client_id</span><span class="o">=</span>cde067521efaefe0c927
Enter the code:
</code></pre></div>

<p>导航到该URL。授权应用程序。然后，从重定向URL获取代码。例如:</p>
<div class="codehilite"><pre><span/><code>http://127.0.0.1:5000/login/github/authorized?code<span class="o">=</span>5e54f2d755e450a64af3
</code></pre></div>

<p>将代码添加回终端窗口:</p>
<div class="codehilite"><pre><span/><code>Authorization URL: https://github.com/login/oauth/authorize?response_type<span class="o">=</span>code<span class="p">&amp;</span><span class="nv">client_id</span><span class="o">=</span>cde067521efaefe0c927
Enter the code: 5e54f2d755e450a64af3
</code></pre></div>

<p>您应该会看到您的GitHub用户名输出如下:</p>


<p>至此，让我们看看如何向Flask应用程序添加社交认证。</p>
<h2 id="flask-dance">烧瓶舞</h2>
<p>OAuthLib是一个流行的、维护良好的Python库，它实现了OAuth。虽然你可以单独使用这个库，但是在本教程中，我们将使用<a href="https://flask-dance.readthedocs.io/en/latest/">烧瓶舞</a>。Flask-Dance是一个构建在OAuthLib之上的库，专门为Flask设计。它有一个简单的API，可以让你快速添加社交认证到Flask应用程序中。它也是为Flask设计的OAuth库中最受欢迎的。</p>
<p>继续创建新的Flask应用程序，激活虚拟环境，并安装所需的依赖项:</p>
<div class="codehilite"><pre><span/><code>$ mkdir flask-social-auth <span class="o">&amp;&amp;</span> <span class="nb">cd</span> flask-social-auth
$ python3.11 -m venv .venv
$ <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span>$ pip install <span class="nv">Flask</span><span class="o">==</span><span class="m">2</span>.2.2 Flask-Dance<span class="o">==</span><span class="m">6</span>.2.0 python-dotenv<span class="o">==</span><span class="m">0</span>.21.0
</code></pre></div>

<p>接下来，创建一个<em> main.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># main.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ping</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ping</span><span class="o">=</span><span class="s2">"pong"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>运行服务器:</p>


<p>导航到<a href="http://127.0.0.1:5000/ping">http://127 . 0 . 0 . 1:5000/ping</a>。您应该看到:</p>


<h2 id="github-provider">GitHub提供商</h2>
<p>继续将您之前创建的GitHub客户端ID和客户端密码保存到一个新的<em>。env </em>文件:</p>
<div class="codehilite"><pre><span/><code>GITHUB_ID=&lt;YOUR_ID_HERE&gt;
GITHUB_SECRET=&lt;YOUR_SECRET_HERE&gt;

OAUTHLIB_INSECURE_TRANSPORT=1
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>由于我们安装了<a href="https://github.com/theskumar/python-dotenv"> python-dotenv </a>，Flask会<a href="https://flask.palletsprojects.com/en/2.2.x/cli/#environment-variables-from-dotenv">自动</a>设置来自<em>的环境变量。env </em>文件。</li>
<li><a href="https://oauthlib.readthedocs.io/en/latest/oauth2/security.html#envvar-OAUTHLIB_INSECURE_TRANSPORT">OAUTHLIB _ unsecure _ TRANSPORT = 1</a>用于测试目的，因为OAUTHLIB默认需要HTTPS。</li>
</ol>
<p>Flask-Dance为每个供应商提供Flask <a href="https://flask-dance.readthedocs.io/en/latest/concepts.html#blueprints">蓝图</a>。让我们在<em> app/oauth.py </em>中为GitHub提供者创建一个:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># app/oauth.py</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_dance.contrib.github</span> <span class="kn">import</span> <span class="n">make_github_blueprint</span>


<span class="n">github_blueprint</span> <span class="o">=</span> <span class="n">make_github_blueprint</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_ID"</span><span class="p">),</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_SECRET"</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>

<p>在<em> main.py </em>中导入并注册蓝图，并连接新路线:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># main.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask_dance.contrib.github</span> <span class="kn">import</span> <span class="n">github</span>

<span class="kn">from</span> <span class="nn">app.oauth</span> <span class="kn">import</span> <span class="n">github_blueprint</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s2">"supersecretkey"</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">github_blueprint</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s2">"/login"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ping</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ping</span><span class="o">=</span><span class="s2">"pong"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/github"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">github</span><span class="o">.</span><span class="n">authorized</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">"github.login"</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">"You are @</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'login'</span><span class="p">]</span><span class="si">}</span><span class="s2"> on GitHub"</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>如果用户还没有登录，<code>/github</code>路由重定向到GitHub进行验证。登录后，它会显示用户名。</p>
<p>通过运行<code>python main.py</code>启动应用程序，导航到<a href="http://127.0.0.1:5000/github">http://127 . 0 . 0 . 1:5000/github</a>，测试应用程序。在GitHub上验证后，你会被重定向回来。您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="n">You</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="nv">@mjhea0</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">GitHub</span><span class="w"/>
</code></pre></div>

<h2 id="user-management">用户管理</h2>
<p>接下来，让我们连接用于管理用户会话的<a href="https://flask-login.readthedocs.io/"> Flask-Login </a>和用于添加SQLAlchemy支持的<a href="https://flask-sqlalchemy.palletsprojects.com/en/3.0.x/"> Flask-SQLAlchemy </a>，以便在数据库中存储用户相关数据。</p>
<p>安装依赖项:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ pip install Flask-Login<span class="o">==</span><span class="m">0</span>.6.2 Flask-SQLAlchemy<span class="o">==</span><span class="m">3</span>.0.2 SQLAlchemy-Utils<span class="o">==</span><span class="m">0</span>.38.3
</code></pre></div>

<h3 id="models">模型</h3>
<p>创建模型以在名为<em> app/models.py </em>的新文件中存储用户和OAuth信息:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># app/models.py</span>

<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">UserMixin</span><span class="p">,</span> <span class="n">LoginManager</span>
<span class="kn">from</span> <span class="nn">flask_dance.consumer.storage.sqla</span> <span class="kn">import</span> <span class="n">OAuthConsumerMixin</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OAuth</span><span class="p">(</span><span class="n">OAuthConsumerMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>


<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>


<span class="nd">@login_manager</span><span class="o">.</span><span class="n">user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>Flask-Dance的<a href="https://flask-dance.readthedocs.io/en/v6.2.0/storages.html#sqlalchemy"> OAuthConsumerMixin </a>将自动添加必要的字段来存储OAuth信息。</li>
<li>来自Flask-Login的<a href="https://flask-login.readthedocs.io/en/latest/#flask_login.LoginManager"> LoginManager </a>将从<code>user</code>表中获取用户。</li>
</ol>
<p>这将创建两个表，<code>user</code>和<code>flask_dance_oauth</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># user table</span>

name          <span class="nb">type</span>
--------  ------------
id        INTEGER
username  VARCHAR<span class="o">(</span><span class="m">250</span><span class="o">)</span>

<span class="c1"># flask_dance_oauth table</span>

name        <span class="nb">type</span>
----------  -----------
id          INTEGER
provider    VARCHAR<span class="o">(</span><span class="m">50</span><span class="o">)</span>
created_at  DATETIME
token       TEXT
user_id     INTEGER
</code></pre></div>

<h3 id="github-blueprint">GitHub蓝图</h3>
<p>接下来，修改之前创建的GitHub蓝图，添加<code>OAuth</code>表作为存储:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># app/oauth.py</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">flask_dance.contrib.github</span> <span class="kn">import</span> <span class="n">make_github_blueprint</span>
<span class="kn">from</span> <span class="nn">flask_dance.consumer.storage.sqla</span> <span class="kn">import</span> <span class="n">SQLAlchemyStorage</span>

<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">OAuth</span><span class="p">,</span> <span class="n">db</span>


<span class="n">github_blueprint</span> <span class="o">=</span> <span class="n">make_github_blueprint</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_ID"</span><span class="p">),</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_SECRET"</span><span class="p">),</span>
    <span class="n">storage</span><span class="o">=</span><span class="n">SQLAlchemyStorage</span><span class="p">(</span>
        <span class="n">OAuth</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="n">current_user</span><span class="p">,</span>
        <span class="n">user_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</code></pre></div>

<p>在这里，我们通过了:</p>
<ol>
<li><code>storage</code>为SQLAlchemy <a href="https://flask-dance.readthedocs.io/en/latest/storages.html">存储</a>与<code>OAuth</code>型号</li>
<li><code>db.session</code>，这是一个<code>sqlalchemy.session</code></li>
<li>用户作为<code>current_user</code>从Flask登录</li>
</ol>
<h3 id="endpoints">端点</h3>
<p>接下来，让我们在<em> main.py </em> - <code>login</code>、<code>logout</code>和<code>homepage</code>中定义适当的端点:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># main.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask_dance.contrib.github</span> <span class="kn">import</span> <span class="n">github</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>

<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">login_manager</span>
<span class="kn">from</span> <span class="nn">app.oauth</span> <span class="kn">import</span> <span class="n">github_blueprint</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s2">"supersecretkey"</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">"SQLALCHEMY_DATABASE_URI"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sqlite:///./users.db"</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">github_blueprint</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s2">"/login"</span><span class="p">)</span>

<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ping</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ping</span><span class="o">=</span><span class="s2">"pong"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">homepage</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/github"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">github</span><span class="o">.</span><span class="n">authorized</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">"github.login"</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"login"</span><span class="p">]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"You are @</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> on GitHub"</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">"/logout"</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">"homepage"</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们初始化了之前在<em> models.py </em>中定义的<code>db</code>和<code>login_manager</code>。</p>
<p><code>homepage</code>视图呈现了<em>index.html</em>模板，我们稍后将添加该模板。接下来，<code>login</code>视图使用GitHub进行认证，并返回用户名。<code>logout</code>路径将用户注销。</p>
<p>现在所有的路由都已经设置好了，但是我们还没有让用户登录。为此，我们将使用烧瓶<a href="https://flask.palletsprojects.com/en/2.2.x/signals/">信号</a>。</p>
<h3 id="signals">信号</h3>
<p>当某些预定义的事件发生时，信号允许您执行操作。在我们的例子中，当GitHub认证成功时，我们将让用户登录。</p>
<p>Signals需要<a href="https://pypi.org/project/blinker/"> Binker </a>才能工作，所以现在就开始安装吧:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ pip install <span class="nv">blinker</span><span class="o">==</span><span class="m">1</span>.5
</code></pre></div>

<p>向<em> app/oauth.py </em>添加新的助手:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># app/oauth.py</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_user</span>
<span class="kn">from</span> <span class="nn">flask_dance.consumer</span> <span class="kn">import</span> <span class="n">oauth_authorized</span>
<span class="kn">from</span> <span class="nn">flask_dance.contrib.github</span> <span class="kn">import</span> <span class="n">github</span><span class="p">,</span> <span class="n">make_github_blueprint</span>
<span class="kn">from</span> <span class="nn">flask_dance.consumer.storage.sqla</span> <span class="kn">import</span> <span class="n">SQLAlchemyStorage</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="n">NoResultFound</span>

<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">OAuth</span><span class="p">,</span> <span class="n">User</span>


<span class="n">github_blueprint</span> <span class="o">=</span> <span class="n">make_github_blueprint</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_ID"</span><span class="p">),</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"GITHUB_SECRET"</span><span class="p">),</span>
    <span class="n">storage</span><span class="o">=</span><span class="n">SQLAlchemyStorage</span><span class="p">(</span>
        <span class="n">OAuth</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="n">current_user</span><span class="p">,</span>
        <span class="n">user_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>


<span class="nd">@oauth_authorized</span><span class="o">.</span><span class="n">connect_via</span><span class="p">(</span><span class="n">github_blueprint</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">github_logged_in</span><span class="p">(</span><span class="n">blueprint</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/user"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="n">account_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">account_info</span><span class="p">[</span><span class="s2">"login"</span><span class="p">]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>

<p>当用户通过<code>github_blueprint</code>连接时，<code>github_logged_in</code>功能被执行。它接受两个参数:蓝图和令牌(来自GitHub)。然后，我们从提供商那里获取用户名，并执行以下两个操作之一:</p>
<ol>
<li>如果用户名已经出现在表中，我们让用户登录</li>
<li>如果没有，我们创建一个新用户，然后让该用户登录</li>
</ol>
<h3 id="templates">模板</h3>
<p>最后，让我们添加模板:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.venv<span class="o">)</span>$ mkdir templates <span class="o">&amp;&amp;</span> <span class="nb">cd</span> templates
<span class="o">(</span>.venv<span class="o">)</span>$ touch _base.html
<span class="o">(</span>.venv<span class="o">)</span>$ touch index.html
</code></pre></div>

<p><em> _base.html </em>模板包含总体布局:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/_base.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span>
      <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ff9d90908b8c8b8d9e8fbfcad1cdd1cd">[email protected]</a>/dist/css/bootstrap.min.css"</span>
      <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span>
      <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span>
      <span class="na">href</span><span class="o">=</span><span class="s">"https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1.0"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Flask Social Login<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"padding-top: 10%;"</span><span class="p">&gt;</span>
    {% block content %} {% endblock content %}
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>接下来，给<em>index.html</em>添加一个“用GitHub登录”按钮:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/index.html --&gt;</span>

{% extends '_base.html' %}

{% block content %}
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">"text-align:center;"</span><span class="p">&gt;</span>
    {% if current_user.is_authenticated %}
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>You are logged in as {{current_user.username}}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{{url_for('logout')}}"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger"</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    {% else %}
      <span class="cm">&lt;!-- GitHub button starts here --&gt;</span>
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{{url_for('login')}}"</span>  <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-secondary"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">"fa fa-github fa-fw"</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Login with GitHub<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      <span class="cm">&lt;!-- GitHub button ends here --&gt;</span>
    {% endif %}
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{% endblock content %}
</code></pre></div>

<p>完成后，启动应用程序并导航至<a href="http://127.0.0.1:5000"> http://127.0.0.1:5000 </a>。测试验证流。</p>
<p>项目结构:</p>
<div class="codehilite"><pre><span/><code>├── .env
├── app
│   ├── __init__.py
│   ├── models.py
│   └── oauth.py
├── main.py
└── templates
    ├── _base.html
    └── index.html
</code></pre></div>


<p>现在您已经知道了连接新的OAuth提供者以及配置Flask-Login的步骤，您应该能够相当容易地设置新的提供者。</p>
<p>例如，Twitter的步骤如下:</p>
<ol>
<li>在Twitter上创建OAuth应用程序</li>
<li>在<em> app/oauth.py </em>中配置<a href="https://github.com/singingwolfboy/flask-dance-twitter"> Twitter蓝图</a></li>
<li>在<em> main.py </em>中设置重定向到Twitter登录的路由</li>
<li>在<em> main.py </em>中为Twitter登录(<code>@app.route("/twitter")</code>)创建一个新的端点</li>
<li>当用户通过twitter ( <code>@oauth_authorized.connect_via(twitter_blueprint)</code>)在<em> app/oauth.py </em>中授权时，创建一个新的Flask信号来登录</li>
<li>更新<em>模板/index.html </em>模板</li>
</ol>
<p>自己试试这个。</p>
<h2 id="conclusion">结论</h2>
<p>本教程详细介绍了如何使用Flask-Dance向Flask应用程序添加社交认证。在配置完GitHub和Twitter之后，您现在应该对如何连接新的社交认证提供商有了很好的理解:</p>
<ol>
<li>通过创建OAuth应用程序来获取每个提供者的令牌</li>
<li>建立数据库模型来存储用户和OAuth数据</li>
<li>为每个提供者创建蓝图，并将创建的OAuth模型添加为存储</li>
<li>添加向提供商验证的路由</li>
<li>添加一个信号，以便用户在通过身份验证后登录</li>
</ol>
<p>寻找额外的挑战？</p>
<ol>
<li>找出如何将多个社交媒体登录链接到单个帐户(因此，如果用户使用不同的社交媒体帐户登录，而不是在<code>user</code>表中创建新行，新的社交媒体帐户将链接到现有用户)。</li>
<li>通过指定OAuth作用域，从社交提供商处获取有关用户的附加信息(例如，电子邮件、语言、国家/地区)。</li>
</ol>
<p>从GitHub上的<a href="https://github.com/testdrivenio/flask-social-auth"> flask-social-auth </a>库获取代码。</p>
  </div>

  </div>    
</body>
</html>