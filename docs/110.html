<html>
<head>
<title>FastAPI with Async SQLAlchemy, SQLModel, and Alembic </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>带有异步SQLAlchemy、SQLModel和Alembic的FastAPI</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/fastapi-sqlmodel/#0001-01-01">https://testdriven.io/blog/fastapi-sqlmodel/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本教程着眼于如何通过SQLModel和FastAPI异步地使用SQLAlchemy。我们还将配置Alembic来处理数据库迁移。</p>
<blockquote>
<p>本教程假设您有使用Docker处理FastAPI和Postgres的经验。需要帮助快速掌握FastAPI、Postgres和Docker吗？从以下资源开始:</p>
<ol>
<li><a href="/blog/fastapi-crud/">使用FastAPI和Pytest开发和测试异步API</a></li>
<li><a href="/courses/tdd-fastapi/">用FastAPI和Docker进行测试驱动开发</a></li>
</ol>
</blockquote>



<h2 id="project-setup">项目设置</h2>
<p>从从<a href="https://github.com/testdrivenio/fastapi-sqlmodel-alembic">fastapi-SQL model-alem BIC</a>repo克隆基础项目开始:</p>
<div class="codehilite"><pre><span/><code>$ git clone -b base https://github.com/testdrivenio/fastapi-sqlmodel-alembic
$ <span class="nb">cd</span> fastapi-sqlmodel-alembic
</code></pre></div>

<p>从项目根目录，创建映像并启动Docker容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>构建完成后，导航到<a href="http://localhost:8004/ping">http://localhost:8004/ping</a>。您应该看到:</p>


<p>在继续之前，快速浏览一下项目结构。</p>
<h2 id="sqlmodel">SQLModel</h2>
<p>接下来，让我们添加<a href="https://sqlmodel.tiangolo.com/"> SQLModel </a>，这是一个用于通过Python对象从Python代码与SQL数据库进行交互的库。基于Python类型注释，它本质上是一个位于<a href="https://pydantic-docs.helpmanual.io/"> pydantic </a>和<a href="https://www.sqlalchemy.org/"> SQLAlchemy </a>之上的包装器，使得两者都能轻松工作。</p>
<p>我们还需要<a href="https://www.psycopg.org/">心理医生</a>。</p>
<p>将两个依赖项添加到<em> project/requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.68.1
psycopg2-binary==2.9.1
sqlmodel==0.0.4
uvicorn==0.15.0
</code></pre></div>

<p>在“项目/app”中新建两个文件，<em> db.py </em>和<em> models.py </em>。</p>
<p><em> project/app/models.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span> <span class="nc">SongBase</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">artist</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">(</span><span class="n">SongBase</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SongCreate</span><span class="p">(</span><span class="n">SongBase</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p>这里，我们定义了三个模型:</p>
<ol>
<li><code>SongBase</code>是其他人继承的基础模型。它有两个属性，<code>name</code>和<code>artist</code>，都是字符串。这是一个纯数据模型，因为它缺少<code>table=True</code>，这意味着它只能用作pydantic模型。</li>
<li>与此同时，<code>Song</code>向基本模型添加了一个<code>id</code>属性。这是一个表格模型，所以它是一个pydantic和SQLAlchemy模型。它代表一个数据库表。</li>
<li><code>SongCreate</code>是一个纯数据的pydantic模型，将用于创建新的歌曲实例。</li>
</ol>
<p><em>项目/app/db.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">Session</span>


<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">)</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="n">SQLModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>
</code></pre></div>

<p>在此，我们:</p>
<ol>
<li>使用SQLModel中的<code>create_engine</code>初始化新的SQLAlchemy <a href="https://docs.sqlalchemy.org/en/14/core/engines.html">引擎</a>。SQLModel的<code>create_engine</code>和SQLAlchemy的版本之间的主要区别在于，SQLModel版本添加了类型注释(用于编辑器支持)并启用了<a href="https://docs.sqlalchemy.org/en/14/core/future.html">SQLAlchemy“2.0”风格的引擎和连接</a>。此外，我们传入了<code>echo=True</code>,这样我们可以在终端中看到生成的SQL查询。出于调试目的，在开发模式下启用这一点总是好的。</li>
<li>创建了SQLAlchemy <a href="https://docs.sqlalchemy.org/en/14/orm/session.html">会话</a>。</li>
</ol>
<p>接下来，在<em> project/app/main.py </em>中，让我们使用<a href="https://fastapi.tiangolo.com/advanced/events/#startup-event"> startup </a>事件在启动时创建表:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">init_db</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Song</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_startup</span><span class="p">():</span>
    <span class="n">init_db</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>值得注意的是<code>from app.models import Song</code>是必填项。没有它，就不会创建歌单。</p>
<p>要进行测试，请关闭旧容器和卷，重建映像，并启动新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v
$ docker-compose up -d --build
</code></pre></div>

<p>通过<code>docker-compose logs web</code>打开容器日志。您应该看到:</p>
<div class="codehilite"><pre><span/><code>web_1  <span class="p">|</span> CREATE TABLE song <span class="o">(</span>
web_1  <span class="p">|</span>    name VARCHAR NOT NULL,
web_1  <span class="p">|</span>    artist VARCHAR NOT NULL,
web_1  <span class="p">|</span>    id SERIAL,
web_1  <span class="p">|</span>    PRIMARY KEY <span class="o">(</span>id<span class="o">)</span>
web_1  <span class="p">|</span> <span class="o">)</span>
</code></pre></div>

<p>打开psql:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>postgres --dbname<span class="o">=</span>foo

psql <span class="o">(</span><span class="m">13</span>.4 <span class="o">(</span>Debian <span class="m">13</span>.4-1.pgdg100+1<span class="o">))</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">foo</span><span class="o">=</span><span class="c1"># \dt</span>

        List of relations
 Schema <span class="p">|</span> Name <span class="p">|</span> Type  <span class="p">|</span>  Owner
--------+------+-------+----------
 public <span class="p">|</span> song <span class="p">|</span> table <span class="p">|</span> postgres
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">foo</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>有了这个表，让我们给<em> project/app/main.py </em>添加一些新的路由:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">get_session</span><span class="p">,</span> <span class="n">init_db</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Song</span><span class="p">,</span> <span class="n">SongCreate</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_startup</span><span class="p">():</span>
    <span class="n">init_db</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Song</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_songs</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Song</span><span class="p">))</span>
    <span class="n">songs</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">song</span> <span class="ow">in</span> <span class="n">songs</span><span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_song</span><span class="p">(</span><span class="n">song</span><span class="p">:</span> <span class="n">SongCreate</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">song</span>
</code></pre></div>

<p>添加歌曲:</p>
<div class="codehilite"><pre><span/><code>$ curl -d <span class="s1">'{"name":"Midnight Fit", "artist":"Mogwai"}'</span> -H <span class="s2">"Content-Type: application/json"</span> -X POST http://localhost:8004/songs

<span class="o">{</span>
  <span class="s2">"id"</span>: <span class="m">1</span>,
  <span class="s2">"name"</span>: <span class="s2">"Midnight Fit"</span>,
  <span class="s2">"artist"</span>: <span class="s2">"Mogwai"</span>
<span class="o">}</span>
</code></pre></div>

<p>在浏览器中，导航到<a href="http://localhost:8004/songs">http://localhost:8004/songs</a>。您应该看到:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Midnight Fit"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"artist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mogwai"</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<h2 id="async-sqlmodel">异步SQLModel</h2>
<p>接下来，让我们为SQLModel添加异步支持。</p>
<p>首先，把容器和体积拿下来:</p>


<p>更新<em> docker-compose.yml </em>中的数据库URI，在<code>+asyncpg</code>中增加:</p>


<p>接下来，用<a href="https://magicstack.github.io/asyncpg/"> asyncpg </a>替换Psycopg:</p>
<div class="codehilite"><pre><span/><code>asyncpg==0.24.0
fastapi==0.68.1
sqlmodel==0.0.4
uvicorn==0.15.0
</code></pre></div>

<p>更新<em> project/app/db.py </em>:使用SQLAlchemy引擎和会话的异步风格:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">SQLModel</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">create_async_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>


<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">)</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="c1"># await conn.run_sync(SQLModel.metadata.drop_all)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">SQLModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncSession</span><span class="p">:</span>
    <span class="n">async_session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>我们使用了SQLAlchemy构造——例如，<a href="https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.create_async_engine"> create_async_engine </a>和<a href="https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession">async session</a>——因为在撰写本文时，SQLModel还没有它们的包装器。</li>
<li>我们通过传入<code>expire_on_commit=False</code>来禁用<a href="https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html#preventing-implicit-io-when-using-asyncsession">提交时过期</a>行为。</li>
<li><code>metadata.create_all</code>不异步执行，所以我们使用<a href="https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.AsyncSession.run_sync"> run_sync </a>在异步函数中同步执行。</li>
</ol>
<p>将<code>on_startup</code>变成<em> project/app/main.py </em>中的异步函数:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">init_db</span><span class="p">()</span>
</code></pre></div>

<p>就是这样。重建图像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>确保已经创建了表。</p>
<p>最后，更新<em> project/app/main.py </em>中的路由处理程序以使用异步执行:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.future</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">get_session</span><span class="p">,</span> <span class="n">init_db</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Song</span><span class="p">,</span> <span class="n">SongCreate</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">init_db</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Song</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_songs</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Song</span><span class="p">))</span>
    <span class="n">songs</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">song</span> <span class="ow">in</span> <span class="n">songs</span><span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_song</span><span class="p">(</span><span class="n">song</span><span class="p">:</span> <span class="n">SongCreate</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">song</span>
</code></pre></div>

<p>添加一首新歌，并确保<a href="http://localhost:8004/songs">http://localhost:8004/songs</a>按预期工作。</p>
<h2 id="alembic">蒸馏器</h2>
<p>最后，让我们添加<a href="https://alembic.sqlalchemy.org/"> Alembic </a>来正确处理数据库模式变化。</p>
<p>将其添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>alembic==1.7.1
asyncpg==0.24.0
fastapi==0.68.1
sqlmodel==0.0.4
uvicorn==0.15.0
</code></pre></div>

<p>从<em> project/app/main.py </em>中移除启动事件，因为我们不再需要在启动时创建的表:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">init_db</span><span class="p">()</span>
</code></pre></div>

<p>同样，关闭现有的容器和卷:</p>


<p>向上旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>在构建新图像时，快速浏览一下使用带有Alembic 的Asyncio】。</p>
<p>一旦容器备份完毕，用<a href="https://github.com/sqlalchemy/alembic/tree/rel_1_7_1/alembic/templates/async">异步</a>模板初始化Alembic:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web alembic init -t async migrations
</code></pre></div>

<p>在生成的“项目/迁移”文件夹中，将SQLModel导入到<em> script.py.mako </em>中，这是一个<a href="https://www.makotemplates.org/">樱井真子</a>模板文件:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""${message}</span>

<span class="sd">Revision ID: ${up_revision}</span>
<span class="sd">Revises: ${down_revision | comma,n}</span>
<span class="sd">Create Date: ${create_date}</span>

<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">import</span> <span class="nn">sqlmodel</span>             <span class="c1"># NEW</span>
<span class="err">$</span><span class="p">{</span><span class="n">imports</span> <span class="k">if</span> <span class="n">imports</span> <span class="k">else</span> <span class="s2">""</span><span class="p">}</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">up_revision</span><span class="p">)}</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">down_revision</span><span class="p">)}</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">branch_labels</span><span class="p">)}</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">depends_on</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="err">$</span><span class="p">{</span><span class="n">upgrades</span> <span class="k">if</span> <span class="n">upgrades</span> <span class="k">else</span> <span class="s2">"pass"</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="err">$</span><span class="p">{</span><span class="n">downgrades</span> <span class="k">if</span> <span class="n">downgrades</span> <span class="k">else</span> <span class="s2">"pass"</span><span class="p">}</span>
</code></pre></div>

<p>现在，当生成新的迁移文件时，它将包含<code>import sqlmodel</code>。</p>
<p>接下来，我们需要更新<em>project/migrations/env . py</em>的顶部，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">logging.config</span> <span class="kn">import</span> <span class="n">fileConfig</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">pool</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncEngine</span>
<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">SQLModel</span>                       <span class="c1"># NEW</span>

<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">context</span>

<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Song</span>                         <span class="c1"># NEW</span>

<span class="c1"># this is the Alembic Config object, which provides</span>
<span class="c1"># access to the values within the .ini file in use.</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">config</span>

<span class="c1"># Interpret the config file for Python logging.</span>
<span class="c1"># This line sets up loggers basically.</span>
<span class="n">fileConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>

<span class="c1"># add your model's MetaData object here</span>
<span class="c1"># for 'autogenerate' support</span>
<span class="c1"># from myapp import mymodel</span>
<span class="c1"># target_metadata = mymodel.Base.metadata</span>
<span class="n">target_metadata</span> <span class="o">=</span> <span class="n">SQLModel</span><span class="o">.</span><span class="n">metadata</span>             <span class="c1"># UPDATED</span>

<span class="c1"># other values from the config, defined by the needs of env.py,</span>
<span class="c1"># can be acquired:</span>
<span class="c1"># my_important_option = config.get_main_option("my_important_option")</span>
<span class="c1"># ... etc.</span>

<span class="o">...</span>
</code></pre></div>

<p>这里，我们导入了SQLModel和我们的歌曲模型。然后，我们将<code>target_metadata</code>设置为模型的<a href="https://docs.sqlalchemy.org/en/14/core/metadata.html#sqlalchemy.schema.MetaData">元数据</a>、<code>SQLModel.metadata</code>。关于<code>target_metadata</code>论点的更多信息，请查看官方Alembic文档中的<a href="https://alembic.sqlalchemy.org/en/latest/autogenerate.html">自动生成迁移</a>。</p>
<p>更新<em>项目/alembic.ini </em>中的<code>sqlalchemy.url</code>:</p>
<div class="codehilite"><pre><span/><code><span class="n">sqlalchemy</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postgresql</span><span class="o">+</span><span class="nl">asyncpg</span><span class="p">:</span><span class="o">//</span><span class="nl">postgres</span><span class="p">:</span><span class="n">postgres</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">foo</span><span class="w"/>
</code></pre></div>

<p>要生成第一个迁移文件，请运行:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web alembic revision --autogenerate -m <span class="s2">"init"</span>
</code></pre></div>

<p>如果一切顺利，您应该会在“项目/迁移/版本”中看到一个新的迁移文件，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""init</span>

<span class="sd">Revision ID: f9c634db477d</span>
<span class="sd">Revises:</span>
<span class="sd">Create Date: 2021-09-10 00:24:32.718895</span>

<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">import</span> <span class="nn">sqlmodel</span>


<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">'f9c634db477d'</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">'song'</span><span class="p">,</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="n">sqlmodel</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">AutoString</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'artist'</span><span class="p">,</span> <span class="n">sqlmodel</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">AutoString</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_artist'</span><span class="p">),</span> <span class="s1">'song'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'artist'</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_id'</span><span class="p">),</span> <span class="s1">'song'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_name'</span><span class="p">),</span> <span class="s1">'song'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_name'</span><span class="p">),</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">'song'</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_id'</span><span class="p">),</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">'song'</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_artist'</span><span class="p">),</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">'song'</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">'song'</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>
</code></pre></div>

<p>应用迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web alembic upgrade head
</code></pre></div>

<p>确保您可以添加歌曲。</p>
<p>让我们快速测试一个模式变更。更新<em>项目/app/models.py </em>中的<code>SongBase</code>模型:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">SongBase</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">artist</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>不要忘记重要的一点:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</code></pre></div>

<p>创建新的迁移文件:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web alembic revision --autogenerate -m <span class="s2">"add year"</span>
</code></pre></div>

<p>从自动生成的迁移文件中更新<code>upgrade</code>和<code>downgrade</code>函数，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">'song'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">'year'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_year'</span><span class="p">),</span> <span class="s1">'song'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">'ix_song_year'</span><span class="p">),</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">'song'</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">'song'</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>
</code></pre></div>

<p>应用迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web alembic upgrade head
</code></pre></div>

<p>更新路线处理程序:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Song</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_songs</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Song</span><span class="p">))</span>
    <span class="n">songs</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">song</span> <span class="ow">in</span> <span class="n">songs</span><span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/songs"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_song</span><span class="p">(</span><span class="n">song</span><span class="p">:</span> <span class="n">SongCreate</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_session</span><span class="p">)):</span>
    <span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">artist</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">song</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">song</span>
</code></pre></div>

<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ curl -d <span class="s1">'{"name":"Midnight Fit", "artist":"Mogwai", "year":"2021"}'</span> -H <span class="s2">"Content-Type: application/json"</span> -X POST http://localhost:8004/songs
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何配置SQLAlchemy、SQLModel和Alembic来异步使用FastAPI。</p>
<p>如果你正在寻找更多的挑战，请查看我们所有的FastAPI <a href="/blog/topics/fastapi/">教程</a>和<a href="/courses/topics/fastapi/">课程</a>。</p>
<p>您可以在<a href="https://github.com/testdrivenio/fastapi-sqlmodel-alembic">fastapi-SQL model-alem BIC</a>repo中找到源代码。干杯！</p>
  </div>

  </div>    
</body>
</html>