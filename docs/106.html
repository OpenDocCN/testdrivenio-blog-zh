<html>
<head>
<title>Django REST Framework Views - ViewSets </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django REST框架视图-视图集</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/drf-views-part-3/#0001-01-01">https://testdriven.io/blog/drf-views-part-3/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>到目前为止，我们已经介绍了使用<a href="/blog/drf-views-part-1/"> APIViews </a>和<a href="/blog/drf-views-part-2/">通用视图</a>创建单独的视图。通常，将一组相关视图的视图逻辑合并到一个类中是有意义的。这可以在Django REST框架(DRF)中通过扩展一个<a href="https://www.django-rest-framework.org/api-guide/viewsets/">视图集</a>类来实现。</p>
<p>视图集类消除了对额外代码行的需求，当与<a href="https://www.django-rest-framework.org/api-guide/routers/">路由器</a>结合使用时，有助于保持URL的一致性。</p>
<p>--</p>
<p><strong> Django REST框架视图系列:</strong></p>
<ol>
<li><a href="/blog/drf-views-part-1/">观点</a></li>
<li><a href="/blog/drf-views-part-2/">通用视图</a></li>
<li><a href="/blog/drf-views-part-3/"> ViewSets </a>(本文！)</li>
</ol>



<h2 id="viewsets">viewster</h2>
<p><a href="https://www.django-rest-framework.org/api-guide/viewsets/#viewsets">视图集</a>是一种基于类的视图。</p>
<p>它不像<code>.get()</code>和<code>.post()</code>那样提供方法处理程序，而是提供动作，像<code>.list()</code>和<code>.create()</code>。</p>
<p>视图集最显著的优点是URL构造是自动处理的(使用路由器类)。这有助于整个API中URL约定的一致性，并最小化您需要编写的代码量。</p>
<p>从最基本到最强大，共有四种类型的视图集:</p>
<ol>
<li>视图集</li>
<li>GenericViewSet</li>
<li>ReadOnlyModelViewSet</li>
<li>模型视图集</li>
</ol>
<p>它们大多是基于您在本系列的前一篇<a href="/blog/drf-views-part-2/">文章</a>中了解的类构建的:</p>
<p><img data-src="/static/images/blog/django/drf-views/all_viewsets.png" loading="lazy" class="lazyload" alt="DRF ViewSets Overview" src="../Images/46099019b325163dae6b17dafa2febe2.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-views/all_viewsets.png"/></p>
<p>是一个所有“奇迹发生”的班级。这是所有四个视图集共享的唯一一个类。它覆盖了<code>as_view</code>方法，并将该方法与适当的动作相结合。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>列表/详细信息</th>
<th>行动</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>post</code></td>
<td>目录</td>
<td><code>create</code></td>
</tr>
<tr>
<td><code>get</code></td>
<td>目录</td>
<td><code>list</code></td>
</tr>
<tr>
<td><code>get</code></td>
<td>详述</td>
<td><code>retrieve</code></td>
</tr>
<tr>
<td><code>put</code></td>
<td>详述</td>
<td><code>update</code></td>
</tr>
<tr>
<td><code>patch</code></td>
<td>详述</td>
<td><code>partial_update</code></td>
</tr>
<tr>
<td><code>delete</code></td>
<td>详述</td>
<td><code>destroy</code></td>
</tr>
</tbody>
</table>
<h2 id="viewset-class">视图集类</h2>
<p><code>ViewSet</code>类利用了<code>APIView</code>类的优势。默认情况下，它不提供任何操作，但是您可以使用它来创建自己的视图集:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ViewSet</span>

<span class="k">class</span> <span class="nc">ItemViewSet</span><span class="p">(</span><span class="n">ViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p>这个视图集提供了<code>GET</code> HTTP方法，映射到一个<code>list</code>动作(用于列出所有实例)和一个<code>retrieve</code>动作(用于检索单个实例)。</p>
<h3 id="actions">行动</h3>
<p>默认情况下，路由器类<a href="https://www.django-rest-framework.org/api-guide/viewsets/#viewset-actions">处理以下动作</a>:</p>
<ol>
<li><code>list</code></li>
<li><code>create</code></li>
<li><code>retrieve</code>(需要pk)</li>
<li><code>update</code>(需要pk)</li>
<li><code>partial_update</code>(需要pk)</li>
<li><code>destroy</code>(需要pk)</li>
</ol>
<p>您还可以用<code>@action</code>装饰器创建定制动作。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ViewSet</span>

<span class="k">class</span> <span class="nc">ItemsViewSet</span><span class="p">(</span><span class="n">ViewSet</span><span class="p">):</span>

    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'get'</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">items_not_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user_count</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">user_count</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们定义了一个名为<code>items_not_done</code>的定制动作。</p>
<p>允许的HTTP方法是GET。</p>
<blockquote>
<p>我们已经在这里显式地设置了它，但是缺省情况下允许GET。</p>
</blockquote>
<p><code>methods</code>参数是可选的，而<code>detail</code>参数不是。如果动作针对单个对象，则<code>detail</code>参数应设置为<code>True</code>，如果针对所有对象，则应设置为<code>False</code>。</p>
<p>默认情况下，可通过以下URL访问此操作:<code>/items_not_done</code>。要更改这个URL，您可以在装饰器中设置<code>url_path</code>参数。</p>
<blockquote>
<p>如果你已经使用视图集有一段时间了，你可能会记得<code>@list_route</code>和<code>@detail_route</code>装饰器而不是<code>@action</code>。从<a href="https://www.django-rest-framework.org/community/3.8-announcement/#action-decorator-replaces-list_route-and-detail_route">3.9版</a>开始，这些已经被弃用。</p>
</blockquote>
<h2 id="handling-urls">处理URL</h2>
<p>尽管可以像映射其他视图一样映射视图集的URL，但这不是视图集的重点。</p>
<p>视图集没有使用Django的<a href="https://docs.djangoproject.com/en/3.2/topics/http/urls/#syntax-of-the-urlpatterns-variable"> urlpatterns </a>，而是附带了一个路由器类，可以自动生成URL配置。</p>
<p>DRF有两个开箱即用的路由器:</p>
<ol>
<li><a href="https://www.django-rest-framework.org/api-guide/routers/#simplerouter">简单路由器</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/routers/#defaultrouter">默认路由器</a></li>
</ol>
<p>它们之间的主要区别是DefaultRouter包括一个默认的API根视图:</p>
<p><img data-src="/static/images/blog/django/drf-views/api_root.png" loading="lazy" class="lazyload" alt="DRF Browsable API" src="../Images/794b9e243932486aeed268387b98a4c2.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-views/api_root.png"/></p>
<p>默认的API根视图列出了超链接列表视图，这使得在应用程序中导航更加容易。</p>
<blockquote>
<p>也可以创建一个<a href="https://www.django-rest-framework.org/api-guide/routers/#custom-routers">定制路由器</a>。</p>
</blockquote>
<p>路由器也可以与urlpatterns结合使用:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">ChangeUserInfo</span><span class="p">,</span> <span class="n">ItemsViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'custom-viewset'</span><span class="p">,</span> <span class="n">ItemsViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'change-user-info'</span><span class="p">,</span> <span class="n">ChangeUserInfo</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div>

<p>这里，我们创建了一个路由器(使用DefaultRouter，因此我们获得了默认的API视图)并向它注册了<code>ItemsViewSet</code>。创建路由器时，必须提供两个参数:</p>
<ol>
<li>视图的URL前缀</li>
<li>视图集本身</li>
</ol>
<p>然后，我们把路由器包含在<code>urlpatterns</code>里面。</p>
<blockquote>
<p>这不是包含路由器的唯一方式。更多选项请参考<a href="https://www.django-rest-framework.org/api-guide/routers/">路由器</a>文档。</p>
</blockquote>
<p>在开发过程中，在<code>http://127.0.0.1:8000/custom-viewset/</code>可以访问项目列表，在<code>http://127.0.0.1:8000/custom-viewset/{id}/</code>可以访问单个项目。</p>
<p>因为我们只在我们的<code>ItemsViewSet</code>中定义了<code>list</code>和<code>retrieve</code>动作，所以唯一允许的方法是GET。</p>
<p>我们的自定义操作将在<code>http://127.0.0.1:8000/custom-viewset/items_not_done/</code>可用。</p>
<p>路由器是如何将方法映射到操作的:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># https://github.com/encode/django-rest-framework/blob/3.12.4/rest_framework/routers.py#L83</span>

<span class="n">routes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># List route.</span>
        <span class="n">Route</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">r</span><span class="s1">'^</span><span class="si">{prefix}{trailing_slash}</span><span class="s1">$'</span><span class="p">,</span>
            <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">'get'</span><span class="p">:</span> <span class="s1">'list'</span><span class="p">,</span>
                <span class="s1">'post'</span><span class="p">:</span> <span class="s1">'create'</span>
            <span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'</span><span class="si">{basename}</span><span class="s1">-list'</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">initkwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'suffix'</span><span class="p">:</span> <span class="s1">'List'</span><span class="p">}</span>
        <span class="p">),</span>
        <span class="c1"># Dynamically generated list routes. Generated using</span>
        <span class="c1"># @action(detail=False) decorator on methods of the viewset.</span>
        <span class="n">DynamicRoute</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">r</span><span class="s1">'^</span><span class="si">{prefix}</span><span class="s1">/</span><span class="si">{url_path}{trailing_slash}</span><span class="s1">$'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'</span><span class="si">{basename}</span><span class="s1">-</span><span class="si">{url_name}</span><span class="s1">'</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">initkwargs</span><span class="o">=</span><span class="p">{}</span>
        <span class="p">),</span>
        <span class="c1"># Detail route.</span>
        <span class="n">Route</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">r</span><span class="s1">'^</span><span class="si">{prefix}</span><span class="s1">/</span><span class="si">{lookup}{trailing_slash}</span><span class="s1">$'</span><span class="p">,</span>
            <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">'get'</span><span class="p">:</span> <span class="s1">'retrieve'</span><span class="p">,</span>
                <span class="s1">'put'</span><span class="p">:</span> <span class="s1">'update'</span><span class="p">,</span>
                <span class="s1">'patch'</span><span class="p">:</span> <span class="s1">'partial_update'</span><span class="p">,</span>
                <span class="s1">'delete'</span><span class="p">:</span> <span class="s1">'destroy'</span>
            <span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'</span><span class="si">{basename}</span><span class="s1">-detail'</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">initkwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'suffix'</span><span class="p">:</span> <span class="s1">'Instance'</span><span class="p">}</span>
        <span class="p">),</span>
        <span class="c1"># Dynamically generated detail routes. Generated using</span>
        <span class="c1"># @action(detail=True) decorator on methods of the viewset.</span>
        <span class="n">DynamicRoute</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">r</span><span class="s1">'^</span><span class="si">{prefix}</span><span class="s1">/</span><span class="si">{lookup}</span><span class="s1">/</span><span class="si">{url_path}{trailing_slash}</span><span class="s1">$'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'</span><span class="si">{basename}</span><span class="s1">-</span><span class="si">{url_name}</span><span class="s1">'</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">initkwargs</span><span class="o">=</span><span class="p">{}</span>
        <span class="p">),</span>
    <span class="p">]</span>
</code></pre></div>

<h2 id="genericviewset">GenericViewSet</h2>
<p>当<code>ViewSet</code>延伸<code>APIView</code>时，<code>GenericViewSet</code>延伸<code>GenericAPIView</code>。</p>
<p><a href="https://www.django-rest-framework.org/api-guide/viewsets/#genericviewset"> GenericViewSet </a>类提供了通用视图行为的基本集合以及<code>get_object</code>和<code>get_queryset</code>方法。</p>
<p>这就是<code>ViewSet</code>和<code>GenericViewSet</code>类的创建方式:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># https://github.com/encode/django-rest-framework/blob/3.12.4/rest_framework/viewsets.py#L210</span>
<span class="k">class</span> <span class="nc">ViewSet</span><span class="p">(</span><span class="n">ViewSetMixin</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">APIView</span><span class="p">):</span>
   <span class="k">pass</span>


<span class="c1"># https://github.com/encode/django-rest-framework/blob/3.12.4/rest_framework/viewsets.py#L217</span>
<span class="k">class</span> <span class="nc">GenericViewSet</span><span class="p">(</span><span class="n">ViewSetMixin</span><span class="p">,</span> <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
   <span class="k">pass</span>
</code></pre></div>

<p>如你所见，它们都扩展了<code>ViewSetMixin</code>和<code>APIView</code>或<code>GenericAPIView</code>。除此之外，没有额外的代码。</p>
<p>要使用一个<code>GenericViewSet</code>类，您需要覆盖该类，或者使用mixin类，或者显式定义动作实现，以获得想要的结果。</p>
<h3 id="using-genericviewset-with-mixins">将GenericViewSet与Mixins一起使用</h3>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span><span class="p">,</span> <span class="n">viewsets</span>

<span class="k">class</span> <span class="nc">ItemViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">viewsets</span><span class="o">.</span><span class="n">GenericViewSet</span><span class="p">):</span>

    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>这个<code>GenericViewSet</code>与<code>ListModelMixin</code>和<code>RetrieveModelMixin</code>混音组合在一起。因为这是一个视图集，路由器负责URL映射，mixins为列表和细节视图提供动作。</p>
<h3 id="using-genericviewset-with-explicit-action-implementations">通过显式操作实现使用genericviewset</h3>
<p>使用mixins时，只需要提供<code>serializer_class</code>和<code>queryset</code>属性；否则，您将需要自己实现这些操作。</p>
<p>为了强调<code>GenericViewSet</code>相对于<code>ViewSet</code>的优势，我们将使用一个稍微复杂一点的例子:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">DjangoObjectPermissions</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">GenericViewSet</span>

<span class="k">class</span> <span class="nc">ItemViewSet</span><span class="p">(</span><span class="n">GenericViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoObjectPermissions</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">item</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们创建了一个允许<code>create</code>、<code>list</code>、<code>retrieve</code>和<code>destroy</code>动作的视图集。</p>
<p>由于我们延长了<code>GenericViewSet</code>，我们:</p>
<ol>
<li>使用了<code>DjangoObjectPermissions</code>并且不需要自己检查对象权限</li>
<li>返回了分页的响应</li>
</ol>
<h2 id="modelviewset">模型视图集</h2>
<p><a href="https://www.django-rest-framework.org/api-guide/viewsets/#modelviewset"> ModelViewSet </a>提供了默认的<code>create</code>、<code>retrieve</code>、<code>update</code>、<code>partial_update</code>、<code>destroy</code>和<code>list</code>动作，因为它使用了<code>GenericViewSet</code>和所有可用的混音。</p>
<p><code>ModelViewSet</code>是所有视图中最容易使用的。您只需要三行代码:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">ItemModelViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>然后，在您将视图注册到路由器之后，您就可以开始了！</p>
<div class="codehilite"><pre><span/><code><span class="c1"># urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">ChangeUserInfo</span><span class="p">,</span> <span class="n">ItemsViewSet</span><span class="p">,</span> <span class="n">ItemModelViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'custom-viewset'</span><span class="p">,</span> <span class="n">ItemsViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'model-viewset'</span><span class="p">,</span> <span class="n">ItemModelViewSet</span><span class="p">)</span> <span class="c1"># newly registered ViewSet</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'change-user-info'</span><span class="p">,</span> <span class="n">ChangeUserInfo</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，您可以:</p>
<ol>
<li>创建一个项目并列出所有项目</li>
<li>检索、更新和删除单个项目</li>
</ol>
<h2 id="readonlymodelviewset">ReadOnlyModelViewSet</h2>
<p><a href="https://www.django-rest-framework.org/api-guide/viewsets/#readonlymodelviewset"> ReadOnlyModelViewSet </a>是一个视图集，通过将<code>GenericViewSet</code>与<code>RetrieveModelMixin</code>和<code>ListModelMixin</code>混合在一起，只提供<code>list</code>和<code>retrieve</code>动作。</p>
<p>像<code>ModelViewSet</code>，<code>ReadOnlyModelViewSet</code>只需要<code>queryset</code>和<code>serializer_class</code>属性就可以工作:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ReadOnlyModelViewSet</span>

<span class="k">class</span> <span class="nc">ItemReadOnlyViewSet</span><span class="p">(</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>

    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h2 id="apiviews-generic-views-and-viewsets-summary">API视图、通用视图和视图集摘要</h2>
<p>系列摘要:</p>
<ul>
<li>第一篇<a href="(/blog/drf-views-part-1/)">第二篇</a><a href="(/blog/drf-views-part-2/)">第二篇</a>文章分别介绍了如何通过扩展<code>APIView</code>和通用视图来创建API视图。</li>
<li>在本文中，我们介绍了如何用视图集创建API视图。</li>
</ul>
<p>为了深入理解这些视图，我们覆盖了所有的构建模块；但是，在现实生活中，您最有可能使用以下方法之一:</p>
<ol>
<li><code>APIView</code></li>
<li>具体的观点</li>
<li><code>ModelViewSet</code> / <code>ReadOnlyModelViewSet</code></li>
</ol>
<p>为了快速看出它们之间的区别，让我们来看一下这三者实现相同目标的例子。</p>
<p>三个端点:</p>
<ol>
<li>列出所有项目</li>
<li>创建新项目</li>
<li>检索、更新和删除单个项目</li>
</ol>
<p>以下是如何通过扩展<strong> APIView </strong>来实现这一点:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">ItemsList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ItemDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ItemSerializer</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</code></pre></div>

<p>下面是你如何用<strong>具体的通用视图</strong>做同样的事情:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">ItemsListGeneric</span><span class="p">(</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>


<span class="k">class</span> <span class="nc">ItemDetailGeneric</span><span class="p">(</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
</code></pre></div>

<p>以下是您需要使用<code>ModelViewSet</code>的代码行:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">ItemsViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>最后，下面是各个URL配置的样子:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># APIView</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">views</span> <span class="kn">import</span> <span class="n">ItemsList</span><span class="p">,</span> <span class="n">ItemDetail</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api-view'</span><span class="p">,</span> <span class="n">ItemsList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api-view/&lt;pk&gt;'</span><span class="p">,</span> <span class="n">ItemDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>


<span class="c1"># generic views</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span>
<span class="kn">from</span> <span class="nn">views</span> <span class="kn">import</span> <span class="n">ItemsListGeneric</span><span class="p">,</span> <span class="n">ItemDetailGeneric</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'generic-view'</span><span class="p">,</span> <span class="n">ItemsListGeneric</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'generic-view/&lt;pk&gt;'</span><span class="p">,</span> <span class="n">ItemDetailGeneric</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>


<span class="c1"># ViewSet</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">views</span> <span class="kn">import</span> <span class="n">ItemsViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">'viewset'</span><span class="p">,</span> <span class="n">ItemsViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>DRF的观点是一张复杂纠结的网:</p>
<p><img data-src="/static/images/blog/django/drf-views/drf_views_overview.png" loading="lazy" class="lazyload" alt="DRF Views Overview" src="../Images/7c9f937051f11d63db71adc78eaf9d82.png" data-original-src="https://testdriven.io/static/images/blog/django/drf-views/drf_views_overview.png"/></p>
<p>使用它们有三种核心方法，并有几种子可能性:</p>
<ol>
<li>扩展<code>APIView</code>类<ul>
<li>装饰器也可以使用基于函数的视图</li>
</ul>
</li>
<li>使用通用视图<ul>
<li><code>GenericAPIView</code>是基地</li>
<li><code>GenericAPIView</code>可与一种或多种mixins结合</li>
<li>具体视图类已经涵盖了以所有广泛使用的方式将<code>GenericAPIView</code>与mixins结合起来</li>
</ul>
</li>
<li>将所有可能的动作组合成一个类<ul>
<li><code>GenericViewSet</code>比基础<code>ViewSet</code>更强大</li>
<li><code>ModelViewSet</code>和<code>ReadOnlyModelViewSet</code>用最少的代码提供最多的功能</li>
</ul>
</li>
</ol>
<p>以上所有这些都提供了允许轻松定制的挂钩。</p>
<p>大多数时候，您会发现自己在使用<code>APIView</code>(一个具体的视图类)或<code>(ReadOnly)ModelViewSet</code>。也就是说，当您试图开发一个定制的解决方案时，理解视图是如何构建的以及祖先的优点是很有帮助的。</p>
<p><strong> Django REST框架视图系列:</strong></p>
<ol>
<li><a href="/blog/drf-views-part-1/">观点</a></li>
<li><a href="/blog/drf-views-part-2/">通用视图</a></li>
<li><a href="/blog/drf-views-part-3/"> ViewSets </a>(本文！)</li>
</ol>
  </div>

  </div>    
</body>
</html>