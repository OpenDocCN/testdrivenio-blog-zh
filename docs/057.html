<html>
<head>
<title>Running Python in the Browser with WebAssembly </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用WebAssembly在浏览器中运行Python</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/python-webassembly/#0001-01-01">https://testdriven.io/blog/python-webassembly/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>Python社区长期以来一直在讨论让Python成为现代web浏览器中的一等公民的最佳方式。最大的挑战是web浏览器实际上只支持一种编程语言:JavaScript。然而，随着网络技术的进步，我们已经将越来越多的应用程序推向网络，如游戏、科学可视化以及音频和视频编辑软件。这意味着我们给网络带来了繁重的计算——这不是JavaScript的设计初衷。所有这些挑战都提出了对一种能够提供快速、可移植、紧凑和安全执行的低级web语言的需求。因此，主要浏览器供应商致力于这一想法，并在2017年向世界推出了<a href="https://dl.acm.org/doi/10.1145/3062341.3062363"> WebAssembly </a>。</p>
<p>在本教程中，我们将了解WebAssembly如何帮助您在浏览器中运行Python代码。</p>
<blockquote>
<p>明确地说，JavaScript本身就是一种强大的编程语言。只是不适合某些事情。关于这方面的更多信息，请查看ASM的<a href="https://brendaneich.com/2015/06/from-asm-js-to-webassembly/">。JS to WebAssembly </a>作者Brendan Eich，JavaScript的创造者。</p>
</blockquote>



<h2 id="what-were-building">我们正在建造的东西</h2>
<p>假设你想教一门Python课程。为了使您的课程更有趣，每节课之后，您都要为学生准备一个练习，这样他们就可以练习他们所学的内容。</p>
<p>这里的问题是，学生需要通过安装特定版本的Python、创建和激活虚拟环境以及安装所有必要的包来准备开发环境。这会耗费大量的时间和精力。因为每台机器都不一样，所以很难提供准确的说明。</p>
<p>虽然您可以创建一个后端来运行Docker容器或AWS Lambda函数中提交的代码，但您选择保持堆栈简单，并在课程内容中添加一个Python编辑器，该编辑器可以在客户端、web浏览器中运行Python代码，并向用户显示结果。这正是您将在本教程中构建的内容:</p>
<p><img data-src="/static/images/gifs/blog/python-webassembly/wasm.gif" loading="lazy" class="lazyload" alt="Final WASM App" src="../Images/57333643a1f631029e15d07c06661e63.png" data-original-src="https://testdriven.io/static/images/gifs/blog/python-webassembly/wasm.gif"/></p>
<p>点击查看现场演示<a href="https://python-browser-editor.onrender.com/">。你也可以在wasmeditor.com的</a><a href="https://wasmeditor.com/">看到它的React版本。</a></p>
<h2 id="webassembly">web程序集</h2>
<p>根据Mozilla开发者网络(MDN)文档的定义，<a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Concepts#what_is_webassembly"> WebAssembly </a> (WASM)是:</p>
<p>一种新型代码，可以在现代网络浏览器中运行，并提供了新的功能和主要的性能提升。它主要不是用来手工编写的，而是被设计成C、C++、Rust等源语言的有效编译目标。</p>
<p>因此，WASM让我们在浏览器中运行用不同语言编写的代码(不仅仅是JavaScript ),这样做有以下好处:</p>
<ol>
<li>它快速、高效、便携。</li>
<li>它是安全的，因为代码是在安全的沙盒执行环境中运行的。</li>
<li>它可以在客户端运行。</li>
</ol>
<p>因此，在我们上面的例子中，我们不需要担心用户是否在我们的服务器上运行代码，我们也不需要担心成千上万的学生尝试练习代码，因为代码执行发生在客户端，在web浏览器中。</p>
<p>WebAssembly并不是为了杀死JavaScript而设计的。它是JavaScript的补充。当JavaScript不是合适的工具时，可以使用它，比如游戏、图像识别和图像/视频编辑等等。</p>
<blockquote>
<p>请参见来自WebAssembly.org<a href="https://webassembly.org/docs/use-cases/">的</a><a href="https://webassembly.org/docs/use-cases/">用例</a>了解更多关于何时您可能想要利用WebAssembly的信息。</p>
</blockquote>
<h2 id="pyodide">Pyodide</h2>
<p>本教程使用<a href="https://pyodide.org/"> Pyodide </a>库来运行Python代码，该代码将CPython解释器编译成WebAssembly，并在浏览器的JavaScript环境中运行二进制文件。它附带了许多预装的Python <a href="https://github.com/pyodide/pyodide/tree/main/packages">包</a>。你也可以使用<a href="https://pyodide.org/en/stable/usage/api/micropip-api.html">micro tip</a>来使用更多默认不提供的软件包。</p>
<h3 id="hello-world">你好世界</h3>
<p>使用以下代码创建一个新的HTML文件:</p>
<div class="codehilite"><pre><span/><code><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="w"/>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pyodide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadPyodide</span><span class="p">({</span><span class="w"/>
<span class="w">        </span><span class="nx">indexURL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">"https://cdn.jsdelivr.net/pyodide/v0.20.0/full/"</span><span class="w"/>
<span class="w">      </span><span class="p">});</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pyodide</span><span class="p">.</span><span class="nx">runPython</span><span class="p">(</span><span class="s2">"print('Hello, world from the browser!')"</span><span class="p">));</span><span class="w"/>
<span class="w">    </span><span class="p">};</span><span class="w"/>
<span class="w">    </span><span class="nx">main</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</code></pre></div>

<p>在浏览器中打开文件。然后，在您浏览器的<a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_are_browser_developer_tools">开发工具</a>的控制台中，您应该执行如下操作:</p>
<div class="codehilite"><pre><span/><code>Loading distutils
Loading distutils from https://cdn.jsdelivr.net/pyodide/v0.20.0/full/distutils.js
Loaded distutils
Python initialization complete
Hello, world from the browser!
</code></pre></div>

<p>如您所见，最后一行是浏览器中Python代码执行的结果。</p>
<p>让我们快速看一下上面的代码:</p>
<ol>
<li>首先，你可以使用<a href="https://pyodide.org/en/stable/usage/downloading-and-deploying.html#cdn"> CDN </a>或者直接从<a href="https://pyodide.org/en/stable/usage/downloading-and-deploying.html#github-releases"> GitHub版本</a>下载并安装Pyodide。</li>
<li><a href="https://pyodide.org/en/stable/usage/api/js-api.html#globalThis.loadPyodide"> loadPyodide </a>加载并初始化Pyodide wasm模块。</li>
<li><a href="https://pyodide.org/en/stable/usage/api/js-api.html#pyodide.runPython"> pyodide.runPython </a>以Python代码为字符串，返回代码的结果。</li>
</ol>
<h3 id="pyodide-advantages">优点</h3>
<p>在前面的例子中，您看到了安装Pyodide并开始使用它是多么容易。你只需要从CDN导入<a href="https://pyodide.org/en/stable/usage/downloading-and-deploying.html"> pyodide.js </a>并通过<code>loadPyodide</code>初始化即可。之后，您可以使用<code>pyodide.runPython("Your Python Code Here")</code>在浏览器中运行您的Python代码。</p>
<p>当你第一次下载Pyodide时，下载量很大，因为你下载的是完整的CPython解释器，但是你的浏览器会缓存它，你不需要再次下载。</p>
<p>还有一个很大的、活跃的社区在研究Pyodide:</p>
<ol>
<li><a href="https://pyodide.org/en/stable/project/roadmap.html#">脓皮病路线图</a></li>
<li><a href="https://github.com/pyodide/pyodide/issues">GitHub上的未决问题</a></li>
<li><a href="https://gitter.im/pyodide/community"> Gitter社区</a></li>
</ol>
<h3 id="pyodide-limitations">脓毒性限制</h3>
<p>第一次加载Pyodide需要四五秒钟(取决于你的连接),因为你需要下载大约10MB。此外，Pyodide代码的运行速度比原生Python慢3到5倍。</p>
<h3 id="other-options">其他选项</h3>
<p>通常，如果您想在浏览器中运行Python，有两种方法可用:</p>
<ol>
<li>使用transpiler将Python转换为JavaScript。<a href="https://brython.info/"> Brython </a>、<a href="https://www.transcrypt.org/"> Transcrypt </a>、<a href="https://skulpt.org/"> Skulpt </a>都采用这种方式。</li>
<li>转换Python运行时以便在浏览器中使用。Pyodide和<a href="https://pypyjs.org/"> PyPy.js </a>使用这种方法。</li>
</ol>
<p>选项一和选项二的一个主要区别是，选项一中提到的库不支持Python包。也就是说，它们的下载大小比选项二中的库要小得多，因此速度更快。</p>
<p>我们在本教程中使用Pyodide，因为它的语法更简单，并且支持Python包。如果您对其他选项感兴趣，请随意查看它们的文档。</p>
<h2 id="python-code-editor">Python代码编辑器</h2>
<p>在本节中，我们将创建一个简单的Python编辑器，它可以使用以下代码在浏览器中运行代码:</p>
<ol>
<li><a href="https://pyodide.org/"> Pyodide </a></li>
<li><a href="https://codemirror.net/">代码镜像</a></li>
<li><a href="https://flask.palletsprojects.com/">烧瓶</a></li>
</ol>
<p>创建新项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir python_editor_wasm
$ <span class="nb">cd</span> python_editor_wasm
</code></pre></div>

<p>创建并激活虚拟环境:</p>
<div class="codehilite"><pre><span/><code>$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate
<span class="o">(</span>env<span class="o">)</span>$
</code></pre></div>

<p>安装烧瓶:</p>


<p>在项目的根目录下创建一个名为<em> app.py </em>的文件，并添加以下代码:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'index.html'</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>在我们项目的根目录下创建一个“模板”文件夹，并在它下面添加<em>index.html</em>文件。</p>
<p><em>模板/索引. html </em>:</p>
<div class="codehilite"><pre><span/><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">class</span><span class="o">=</span><span class="s">"h-full bg-slate-900"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- install tailwindcss from cdn, don't do this for production application --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.tailwindcss.com"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- install pyodide version 0.20.0 --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- import codemirror stylings --&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css"</span> <span class="p">/&gt;</span>
  <span class="cm">&lt;!-- install codemirror.js version /5.63.3 from cdn --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.js"</span>
  <span class="na">integrity</span><span class="o">=</span><span class="s">"sha512-XMlgZzPyVXf1I/wbGnofk1Hfdx+zAWyZjh6c21yGo/k1zNC4Ve6xcQnTDTCHrjFGsOrVicJsBURLYktVEu/8vQ=="</span>
  <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span> <span class="na">referrerpolicy</span><span class="o">=</span><span class="s">"no-referrer"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- install codemirror python language support --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/python/python.min.js"</span>
  <span class="na">integrity</span><span class="o">=</span><span class="s">"sha512-/mavDpedrvPG/0Grj2Ughxte/fsm42ZmZWWpHz1jCbzd5ECv8CB7PomGtw0NAnhHmE/lkDFkRMupjoohbKNA1Q=="</span>
  <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span> <span class="na">referrerpolicy</span><span class="o">=</span><span class="s">"no-referrer"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- import codemirror dracula theme styles from cdn --&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/theme/dracula.css"</span><span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span><span class="w"/>
<span class="w">    </span><span class="c">/* set codemirror ide height to 100% of the textarea */</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nc">CodeMirror</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">"h-full overflow-hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"text-slate-200 text-3xl my-4 font-extrabold mx-2 pt-8"</span><span class="p">&gt;</span>Run Python in your browser<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"h-3/4 flex flex-row"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"grid w-2/3 border-dashed border-2 border-slate-500 mx-2"</span><span class="p">&gt;</span>
      <span class="cm">&lt;!-- our code editor, where codemirror renders it's editor --&gt;</span>
      <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">"code"</span> <span class="na">name</span><span class="o">=</span><span class="s">"code"</span> <span class="na">class</span><span class="o">=</span><span class="s">"h-full"</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"grid w-1/3 border-dashed border-2 border-slate-500 mx-2"</span><span class="p">&gt;</span>
      <span class="cm">&lt;!-- output section where we show the stdout of the python code execution --&gt;</span>
      <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">readonly</span> <span class="na">class</span><span class="o">=</span><span class="s">"p-8 text-slate-200 bg-slate-900"</span> <span class="na">id</span><span class="o">=</span><span class="s">"output"</span> <span class="na">name</span><span class="o">=</span><span class="s">"output"</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- run button to pass the code to pyodide.runPython() --&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">"evaluatePython()"</span> <span class="na">type</span><span class="o">=</span><span class="s">"button"</span> <span class="na">class</span><span class="o">=</span><span class="s">"mx-2 my-4 h-12 px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm bg-green-700 hover:bg-green-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-700 text-slate-300"</span><span class="p">&gt;</span>Run<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- clean the output section --&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">"clearHistory()"</span> <span class="na">type</span><span class="o">=</span><span class="s">"button"</span> <span class="na">class</span><span class="o">=</span><span class="s">"mx-2 my-4 h-12 px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm bg-red-700 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-700 text-slate-300"</span><span class="p">&gt;</span>Clear History<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"/static/js/main.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>在<em>index.html</em>文件的头部，我们导入了用于样式的Tailwind CSS、Pyodide.js版本<code>0.20.0</code>，以及CodeMirror及其依赖项。</p>
<p>UI有三个重要的组件:</p>
<ol>
<li><strong>编辑器</strong>:用户可以在这里编写Python代码。这是一个带有<code>code</code>的<code>id</code>的<code>textarea</code> HTML元素。当我们初始化<code>codemirror</code>时，我们让它知道我们想要使用这个元素作为代码编辑器。</li>
<li><strong>输出</strong>:显示代码的输出。这是一个带有<code>output</code>的<code>id</code>的<code>textarea</code>元素。Pyodide执行Python代码时，会将结果输出到这个元素。我们也在这个元素中显示了一个错误消息。</li>
<li><strong>运行按钮</strong>:当用户点击这个按钮时，我们获取编辑器元素的值，并将其作为字符串传递给<code>pyodide.runPython</code>。当<code>pyodide.runPython</code>返回结果时，我们在输出元素中显示它。</li>
</ol>
<p>现在在项目的根目录下，创建“static/js”文件夹。然后，在“js”文件夹下，创建一个名为<em> main.js </em>的新文件。</p>
<p><em> static/js/main.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// find the output element</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"output"</span><span class="p">);</span><span class="w"/>

<span class="c1">// initialize codemirror and pass configuration to support Python and the dracula theme</span><span class="w"/>
<span class="kd">const</span><span class="w"> </span><span class="nx">editor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">fromTextArea</span><span class="p">(</span><span class="w"/>
<span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"code"</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">singleLineStringErrors</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">theme</span><span class="o">:</span><span class="w"> </span><span class="s2">"dracula"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">lineNumbers</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">indentUnit</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">matchBrackets</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">);</span><span class="w"/>
<span class="c1">// set the initial value of the editor</span><span class="w"/>
<span class="nx">editor</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="s2">"print('Hello world')"</span><span class="p">);</span><span class="w"/>
<span class="nx">output</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Initializing...\n"</span><span class="p">;</span><span class="w"/>

<span class="c1">// add pyodide returned value to the output</span><span class="w"/>
<span class="kd">function</span><span class="w"> </span><span class="nx">addToOutput</span><span class="p">(</span><span class="nx">stdout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">output</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">"&gt;&gt;&gt; "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\n"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">stdout</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="c1">// clean the output section</span><span class="w"/>
<span class="kd">function</span><span class="w"> </span><span class="nx">clearHistory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">output</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="c1">// init pyodide and show sys.version when it's loaded successfully</span><span class="w"/>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">pyodide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadPyodide</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">indexURL</span><span class="o">:</span><span class="w"> </span><span class="s2">"https://cdn.jsdelivr.net/pyodide/v0.20.0/full/"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="w">  </span><span class="nx">output</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pyodide</span><span class="p">.</span><span class="nx">runPython</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    import sys</span>
<span class="sb">    sys.version</span>
<span class="sb">  `</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="nx">output</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">"\n"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"Python Ready !"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">pyodide</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="c1">// run the main function</span><span class="w"/>
<span class="kd">let</span><span class="w"> </span><span class="nx">pyodideReadyPromise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="p">();</span><span class="w"/>

<span class="c1">// pass the editor value to the pyodide.runPython function and show the result in the output section</span><span class="w"/>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">evaluatePython</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">pyodide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">pyodideReadyPromise</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">pyodide</span><span class="p">.</span><span class="nx">runPython</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">      import io</span>
<span class="sb">      sys.stdout = io.StringIO()</span>
<span class="sb">    `</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pyodide</span><span class="p">.</span><span class="nx">runPython</span><span class="p">(</span><span class="nx">editor</span><span class="p">.</span><span class="nx">getValue</span><span class="p">());</span><span class="w"/>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">stdout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pyodide</span><span class="p">.</span><span class="nx">runPython</span><span class="p">(</span><span class="s2">"sys.stdout.getvalue()"</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="nx">addToOutput</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">addToOutput</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>在此，我们:</p>
<ol>
<li>初始化CodeMirror，支持<a href="https://codemirror.net/mode/python/"> Python </a>和<a href="https://en.wikipedia.org/wiki/Dracula_(color_scheme)">吸血鬼主题</a>。</li>
<li>已初始化Pyodide。</li>
<li>添加了一个名为<code>evaluatePython</code>的函数，当用户点击<code>Run</code>按钮时执行。它将<code>code</code>元素的值传递给<code>pyodide.runPython</code>，并通过<code>addToOutput</code>在<code>output</code>元素中显示结果。</li>
<li>添加了一个名为<code>clearHistory</code>的函数，当用户点击<code>Clear History</code>按钮时，该函数清除<code>output</code>元素。</li>
</ol>
<p>要在本地运行Flask development server，请运行:</p>


<p>服务器现在应该运行在端口5000上。在浏览器中导航到<a href="http://127.0.0.1:5000"> http://127.0.0.1:5000 </a>来测试代码编辑器。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们仅仅触及了Pyodide和WebAssembly的冰山一角。我们看到了如何使用WebAssembly在浏览器中运行Python代码，但是WebAssembly通常涵盖更广泛的用例。</p>
<p>我们的部署平台比以往更加多样化，我们根本负担不起不断为多个平台重写软件的时间和金钱。WebAssembly可以影响客户端web开发、服务器端开发、游戏、教育、云计算、移动平台、物联网、无服务器等等。</p>
<p>WebAssembly的目标是交付快速、安全、可移植和紧凑的软件。</p>
<p>在这里可以找到代码repo <a href="https://github.com/amirtds/python_editor_wasm">。</a></p>
  </div>

  </div>    
</body>
</html>