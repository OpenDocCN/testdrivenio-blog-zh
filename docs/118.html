<html>
<head>
<title>Working with AJAX in Django </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Django中使用AJAX</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-ajax-xhr/#0001-01-01">https://testdriven.io/blog/django-ajax-xhr/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p><a href="https://en.wikipedia.org/wiki/Ajax_(programming)"> AJAX </a>，代表异步JavaScript和XML，是一组在客户端使用的技术，用于异步发送和从服务器检索数据。</p>
<p>AJAX允许我们对网页内容进行修改，而不需要用户重新加载整个页面。例如，这对于搜索栏中的自动完成或表单验证非常有用。如果使用得当，您可以提高网站的性能，减少服务器负载，并改善整体用户体验。</p>
<p>在本文中，我们将看看如何在Django中执行GET、POST、PUT和DELETE AJAX请求的例子。虽然重点将放在<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">获取API </a>上，我们也将展示<a href="https://jquery.com/"> jQuery </a>的例子。</p>



<h2 id="what-is-ajax">什么是AJAX？</h2>
<p>AJAX是一种编程实践，它使用<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"> XMLHttpRequest </a> (XHR)对象与服务器异步通信并构建动态网页。尽管AJAX和XMLHttpRequest经常互换使用，但它们是<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API#differences_from_jquery">不同的</a>事物。</p>
<p>为了向web服务器发送数据和从web服务器接收数据，AJAX使用以下步骤:</p>
<ol>
<li>创建一个XMLHttpRequest对象。</li>
<li>使用XMLHttpRequest对象在客户端和服务器之间异步交换数据。</li>
<li>使用JavaScript和DOM来处理数据。</li>
</ol>
<p>通过使用<a href="https://api.jquery.com/jquery.ajax/"> ajax </a>方法，AJAX可以与jQuery一起使用，但是本机Fetch API要好得多，因为它有一个干净的接口，不需要第三方库。</p>
<p>获取API的一般结构如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="nx">fetch</span><span class="p">(</span><span class="s1">'http://some_url.com'</span><span class="p">)</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span><span class="w"> </span><span class="c1">// converts the response to JSON</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="c1">// do something (like update the DOM with the data)</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>参考<a href="https://developer.mozilla.org/"> MDN文档</a>中的<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">使用Fetch </a>和<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch">windoworworkerglobalscope . Fetch()</a>获取更多示例以及<code>fetch</code>方法可用的完整选项。</p>
</blockquote>
<h2 id="when-should-you-use-ajax">什么时候应该使用AJAX？</h2>
<p>同样，AJAX有助于提高站点的性能，同时降低服务器负载，改善整体用户体验。也就是说，它增加了应用程序的复杂性。正因为如此，除非你使用的是一个<a href="https://en.wikipedia.org/wiki/Single-page_application">单页面应用</a>(SPA)——比如React、Angular或Vue——你应该只在绝对必要的时候使用AJAX。</p>
<p>您可能会考虑使用AJAX的一些例子:</p>
<ol>
<li>搜索自动完成</li>
<li>表单验证</li>
<li>表格排序和过滤</li>
<li>验证码</li>
<li>调查和民意测验</li>
</ol>
<p>一般来说，如果内容需要根据用户交互进行大量更新，您可能希望使用AJAX来管理web页面的更新部分，而不是通过页面刷新来管理整个页面。</p>
<h2 id="crud-resource">CRUD资源</h2>
<p>本文中的例子可以应用于任何CRUD资源。示例Django项目使用todos作为它的资源:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>统一资源定位器</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>得到</td>
<td><code>/todos/</code></td>
<td>返回所有待办事项</td>
</tr>
<tr>
<td>邮政</td>
<td><code>/todos/</code></td>
<td>添加待办事项</td>
</tr>
<tr>
<td>放</td>
<td><code>/todos/&lt;todo-id&gt;/</code></td>
<td>更新待办事项</td>
</tr>
<tr>
<td>删除</td>
<td><code>/todos/&lt;todo-id&gt;/</code></td>
<td>删除待办事项</td>
</tr>
</tbody>
</table>
<p>示例项目可以在GitHub上找到:</p>
<ol>
<li>获取版本:<a href="https://github.com/testdrivenio/django-ajax-xhr">https://github.com/testdrivenio/django-ajax-xhr</a></li>
<li>jQuery版本:<a href="https://github.com/testdrivenio/django-ajax-xhr/tree/jquery">https://github.com/testdrivenio/django-ajax-xhr/tree/jquery</a></li>
</ol>
<h2 id="get-request">获取请求</h2>
<p>让我们从简单的获取数据的GET请求开始。</p>
<h3 id="fetch-api">获取API</h3>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>唯一必需的参数是您希望从中获取数据的资源的URL。如果URL需要关键字参数或查询字符串，可以使用Django的<code>{% url %}</code>标签。</p>
<p>你注意到标题了吗？这是通知服务器您正在发送一个AJAX请求所必需的。</p>
<p><code>fetch</code>返回包含HTTP响应的承诺。我们使用<code>.then</code>方法首先从响应中提取JSON格式的数据(通过<code>response.json()</code>)，然后访问返回的数据。在上面的例子中，我们只是在控制台中输出数据。</p>
<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/static/main.js#L19-L39">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/static/main . js # L19-L39</a></p>
<h3 id="jquery-ajax">jQuery AJAX</h3>
<p>等效的jQuery代码:</p>
<div class="codehilite"><pre><span/><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/jquery/static/main.js#L19-L41">https://github . com/test rivieno/django-Ajax-xhr/blob/jquery/static/main . js # l19-l41</a></p>
<h3 id="django-view">姜戈观点</h3>
<p>在Django方面，虽然有几种方法可以处理视图中的AJAX请求，但最简单的方法是使用基于函数的视图:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">JsonResponse</span>

<span class="kn">from</span> <span class="nn">todos.models</span> <span class="kn">import</span> <span class="n">Todo</span>


<span class="k">def</span> <span class="nf">todos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># request.is_ajax() is deprecated since django 3.1</span>
    <span class="n">is_ajax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'X-Requested-With'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'XMLHttpRequest'</span>

    <span class="k">if</span> <span class="n">is_ajax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'GET'</span><span class="p">:</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Todo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'context'</span><span class="p">:</span> <span class="n">todos</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Invalid request'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">'Invalid request'</span><span class="p">)</span>
</code></pre></div>

<p>在本例中，我们的资源是todos。因此，在从数据库获取todos之前，我们验证了我们正在处理一个AJAX请求，并且请求方法是GET。如果两者都为真，我们序列化数据并使用<code>JsonResponse</code>类发送响应。由于<code>QuerySet</code>对象不是JSON可序列化的(在本例中是todos)，我们使用<code>values</code>方法将QuerySet作为一个字典返回，然后将其包装在<code>list</code>中。最终结果是一个字典列表。</p>
<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/todos/views.py#L13-L28">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/todos/views . py # L13-L28</a></p>
<h2 id="post-request">发布请求</h2>
<p>接下来，让我们看看如何处理POST请求。</p>
<h3 id="fetch-api_1">获取API</h3>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s2">"same-origin"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="s2">"data to send"</span><span class="p">})</span><span class="w"/>
<span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>我们需要指定如何在请求中发送凭证。</p>
<p>在上面的代码中，我们使用了<code>"same-origin"</code>(默认值)的值来指示浏览器，如果所请求的URL与fetch调用在同一个源上，就发送凭证。</p>
<p>在前端和后端托管在不同服务器上的情况下，您必须将<code>credentials</code>设置为<code>"include"</code>(它总是随每个请求发送凭证)，并在后端启用<a href="http://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">跨源资源共享</a>。您可以使用<a href="https://pypi.org/project/django-cors-headers/"> django-cors-headers </a>包将cors报头添加到django应用程序的响应中。</p>
<blockquote>
<p>想进一步了解如何处理同一域和跨域的AJAX请求吗？查看<a href="/blog/django-spa-auth/"> Django基于会话的单页面应用认证</a>文章。</p>
</blockquote>
<p>这次我们在请求的<code>body</code>中向服务器发送数据。</p>
<p>注意<code>X-CSRFToken</code>标题。如果没有它，您将在终端中从服务器得到403禁止响应:</p>
<div class="codehilite"><pre><span/><code>Forbidden <span class="o">(</span>CSRF token missing or incorrect.<span class="o">)</span>: /todos/
</code></pre></div>

<p>这是因为在发布请求时必须包含CSRF令牌，以防止<a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">跨站请求伪造</a>攻击。</p>
<p>我们可以通过将每个<code>XMLHttpRequest</code>上的<code>X-CSRFToken</code>头设置为CSRF令牌的值来包含CSRF令牌。</p>
<p>Django文档为我们提供了一个很好的<a href="https://docs.djangoproject.com/en/3.0/ref/csrf/#ajax">函数，允许我们获取令牌</a>，从而简化了我们的生活:</p>
<div class="codehilite"><pre><span/><code><span class="kd">function</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">cookieValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookies</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span><span class="w"/>
<span class="w">      </span><span class="c1">// Does this cookie string begin with the name we want?</span><span class="w"/>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"="</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nx">cookieValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span><span class="w"/>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cookieValue</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/static/main.js#L42-L56">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/static/main . js # L42-L56</a></p>
<h3 id="jquery-ajax_1">jQuery AJAX</h3>
<p>带有jQuery的AJAX POST请求与GET请求非常相似:</p>
<div class="codehilite"><pre><span/><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">,}),</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w">  </span><span class="c1">// don't forget to include the 'getCookie' function</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/jquery/static/main.js#L44-L61">https://github . com/test rivieno/django-Ajax-xhr/blob/jquery/static/main . js # l44-l61</a></p>
<h3 id="django-view_1">姜戈观点</h3>
<p>在服务器端，视图需要从请求中获取JSON格式的数据，所以您需要使用<code>json</code>模块来加载它。</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">JsonResponse</span>

<span class="kn">from</span> <span class="nn">todos.models</span> <span class="kn">import</span> <span class="n">Todo</span>


<span class="k">def</span> <span class="nf">todos</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># request.is_ajax() is deprecated since django 3.1</span>
    <span class="n">is_ajax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'X-Requested-With'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'XMLHttpRequest'</span>

    <span class="k">if</span> <span class="n">is_ajax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'payload'</span><span class="p">)</span>
            <span class="n">Todo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">todo</span><span class="p">[</span><span class="s1">'task'</span><span class="p">],</span> <span class="n">completed</span><span class="o">=</span><span class="n">todo</span><span class="p">[</span><span class="s1">'completed'</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Todo added!'</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Invalid request'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">'Invalid request'</span><span class="p">)</span>
</code></pre></div>

<p>在验证我们正在处理一个AJAX请求并且请求方法是POST之后，我们反序列化请求对象并提取有效负载对象。然后，我们创建了一个新的todo并发回了适当的响应。</p>
<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/todos/views.py#L13-L28">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/todos/views . py # L13-L28</a></p>
<h2 id="put-request">上传请求</h2>
<h3 id="fetch-api_2">获取API</h3>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s2">"same-origin"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w">  </span><span class="c1">// don't forget to include the 'getCookie' function</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="s2">"data to send"</span><span class="p">})</span><span class="w"/>
<span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>这应该类似于POST请求。唯一的区别是URL的形状:</p>
<ol>
<li>后- <code>/todos/</code></li>
<li>放- <code>/todos/&lt;todo-id&gt;/</code></li>
</ol>
<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/static/main.js#L59-L73">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/static/main . js # L59-L73</a></p>
<h3 id="jquery-ajax_2">jQuery AJAX</h3>
<p>等效jQuery:</p>
<div class="codehilite"><pre><span/><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="nx">payload</span><span class="p">,}),</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w">  </span><span class="c1">// don't forget to include the 'getCookie' function</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/jquery/static/main.js#L64-L81">https://github . com/test rivieno/django-Ajax-xhr/blob/jquery/static/main . js # l64-l81</a></p>
<h3 id="django-view_2">姜戈观点</h3>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>

<span class="kn">from</span> <span class="nn">todos.models</span> <span class="kn">import</span> <span class="n">Todo</span>


<span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">todoId</span><span class="p">):</span>
    <span class="c1"># request.is_ajax() is deprecated since django 3.1</span>
    <span class="n">is_ajax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'X-Requested-With'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'XMLHttpRequest'</span>

    <span class="k">if</span> <span class="n">is_ajax</span><span class="p">:</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">todoId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'PUT'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">updated_values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'payload'</span><span class="p">)</span>

            <span class="n">todo</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">updated_values</span><span class="p">[</span><span class="s1">'task'</span><span class="p">]</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="n">updated_values</span><span class="p">[</span><span class="s1">'completed'</span><span class="p">]</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Todo updated!'</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Invalid request'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">'Invalid request'</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/todos/views.py#L31-L53">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/todos/views . py # L31-L53</a></p>
<h2 id="delete-request">删除请求</h2>
<h3 id="fetch-api_3">获取API</h3>
<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">"DELETE"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s2">"same-origin"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w">  </span><span class="c1">// don't forget to include the 'getCookie' function</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">})</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span><span class="w"/>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/static/main.js#L76-L89">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/static/main . js # L76-L89</a></p>
<h3 id="jquery-ajax_3">jQuery AJAX</h3>
<p>jQuery代码:</p>
<div class="codehilite"><pre><span/><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">"DELETE"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-Requested-With"</span><span class="o">:</span><span class="w"> </span><span class="s2">"XMLHttpRequest"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/jquery/static/main.js#L84-L100">https://github . com/test rivieno/django-Ajax-xhr/blob/jquery/static/main . js # l84-l100</a></p>
<h3 id="django-view_3">姜戈观点</h3>
<p>查看:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>

<span class="kn">from</span> <span class="nn">todos.models</span> <span class="kn">import</span> <span class="n">Todo</span>


<span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">todoId</span><span class="p">):</span>
    <span class="c1"># request.is_ajax() is deprecated since django 3.1</span>
    <span class="n">is_ajax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'X-Requested-With'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'XMLHttpRequest'</span>

    <span class="k">if</span> <span class="n">is_ajax</span><span class="p">:</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">todoId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'DELETE'</span><span class="p">:</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Todo deleted!'</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Invalid request'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">'Invalid request'</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://github.com/testdrivenio/django-ajax-xhr/blob/main/todos/views.py#L31-L53">https://github . com/testdrivenio/django-Ajax-xhr/blob/main/todos/views . py # L31-L53</a></p>
<h2 id="summary">摘要</h2>
<p>AJAX允许我们执行异步请求来更改页面的某些部分，而不必重新加载整个页面。</p>
<p>在本文中，您看到了如何使用Fetch API和jQuery在Django中执行GET、POST、PUT和DELETE AJAX请求的详细示例。</p>
<p>示例项目可以在GitHub上找到:</p>
<ol>
<li>获取版本:<a href="https://github.com/testdrivenio/django-ajax-xhr">https://github.com/testdrivenio/django-ajax-xhr</a></li>
<li>jQuery版本:<a href="https://github.com/testdrivenio/django-ajax-xhr/tree/jquery">https://github.com/testdrivenio/django-ajax-xhr/tree/jquery</a></li>
</ol>
  </div>

  </div>    
</body>
</html>