<html>
<head>
<title>Asynchronous Tasks with Django and Celery </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django和Celery的异步任务</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-and-celery/#0001-01-01">https://testdriven.io/blog/django-and-celery/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>如果长时间运行的流程是应用程序工作流的一部分，而不是阻塞响应，您应该在后台处理它，在正常的请求/响应流之外。</p>
<p>也许您的web应用程序要求用户在注册时提交一个缩略图(可能需要重新调整大小)并确认他们的电子邮件。如果您的应用程序处理了图像并直接在请求处理程序中发送了确认电子邮件，那么最终用户将不得不在页面加载或更新之前不必要地等待他们完成处理。相反，您会希望将这些进程传递给任务队列，并让一个单独的工作进程来处理它，这样您就可以立即将响应发送回客户端。最终用户可以在处理过程中在客户端做其他事情。您的应用程序还可以自由地响应来自其他用户和客户端的请求。</p>
<p>为了实现这一点，我们将带您完成设置和配置<a href="https://docs.celeryq.dev/en/stable/"> Celery </a>和Redis的过程，以便在Django应用程序中处理长时间运行的流程。我们还将使用Docker和Docker Compose将所有内容联系在一起。最后，我们将看看如何用单元测试和集成测试来测试Celery任务。</p>
<blockquote>
<p>姜戈+芹菜系列:</p>
<ol>
<li><a href="/blog/django-and-celery/">与Django和芹菜的异步任务</a>(本文！)</li>
<li><a href="/blog/django-celery-periodic-tasks/">在Django用芹菜和码头工人处理定期任务</a></li>
<li><a href="/blog/retrying-failed-celery-tasks/">自动重试失败的芹菜任务</a></li>
<li><a href="/blog/celery-database-transactions/">处理芹菜和数据库事务</a></li>
</ol>
</blockquote>



<h2 id="objectives">目标</h2>
<p>完成本文后，您将能够:</p>
<ol>
<li>将芹菜集成到Django应用程序中并创建任务</li>
<li>集装箱化姜戈、Celery，并与码头工重归于好</li>
<li>使用单独的工作进程在后台运行进程</li>
<li>将芹菜日志保存到文件中</li>
<li>设置<a href="https://flower.readthedocs.io/en/latest/"> Flower </a>来监控和管理芹菜作业和工人</li>
<li>用单元测试和集成测试来测试芹菜任务</li>
</ol>
<h2 id="background-tasks">后台任务</h2>
<p>同样，为了改善用户体验，长时间运行的流程应该在正常的HTTP请求/响应流程之外，在后台进程中运行。</p>
<p>示例:</p>
<ol>
<li>运行机器学习模型</li>
<li>发送确认电子邮件</li>
<li>刮擦和爬行</li>
<li>分析数据</li>
<li>处理图像</li>
<li>生成报告</li>
</ol>
<p>当你构建一个应用程序时，试着区分应该在请求/响应生命周期中运行的任务(比如CRUD操作)和应该在后台运行的任务。</p>
<h2 id="workflow">工作流程</h2>
<p>我们的目标是开发一个Django应用程序，它与Celery一起处理正常请求/响应周期之外的长时间运行的流程。</p>
<ol>
<li>最终用户通过向服务器端发送POST请求开始一项新任务。</li>
<li>在视图中，一个任务被添加到队列中，任务id被发送回客户端。</li>
<li>使用AJAX，当任务本身在后台运行时，客户机继续轮询服务器以检查任务的状态。</li>
</ol>
<p><img data-src="/static/images/blog/django/django-celery/django-celery-flow.png" loading="lazy" class="lazyload" alt="django and celery queue user flow" src="../Images/8913cff9b00767ba2a60e06da775d013.png" data-original-src="https://testdriven.io/static/images/blog/django/django-celery/django-celery-flow.png"/></p>
<h2 id="project-setup">项目设置</h2>
<p>从<a href="https://github.com/testdrivenio/django-celery"> django-celery </a> repo中克隆出基础项目，然后将<a href="https://github.com/testdrivenio/django-celery/tree/v1"> v1 </a>标签签出到主分支:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://github.com/testdrivenio/django-celery --branch v1 --single-branch
$ <span class="nb">cd</span> django-celery
$ git checkout v1 -b master
</code></pre></div>

<p>由于我们总共需要管理三个进程(Django、Redis、worker)，我们将使用Docker来简化我们的工作流，方法是将它们连接起来，以便它们都可以通过一个命令从一个终端窗口运行。</p>
<p>从项目根目录，创建映像并启动Docker容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>构建完成后，导航到<a href="http://localhost:1337"> http://localhost:1337 </a>:</p>
<p><img data-src="/static/images/blog/django/django-celery/django_celery.png" loading="lazy" class="lazyload" alt="django project" src="../Images/665f021b97eeae2f6200701698684705.png" data-original-src="https://testdriven.io/static/images/blog/django/django-celery/django_celery.png"/></p>
<p>确保测试也通过:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python -m <span class="nv">pytest</span>

<span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.1, pytest-7.2.0, pluggy-1.0.0
django: settings: core.settings <span class="o">(</span>from ini<span class="o">)</span>
rootdir: /usr/src/app, configfile: pytest.ini
plugins: django-4.5.2
collected <span class="m">1</span> item

tests/test_tasks.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.17s <span class="o">================================</span>
</code></pre></div>

<p>在继续之前，快速浏览一下项目结构:</p>
<div class="codehilite"><pre><span/><code>├── .gitignore
├── LICENSE
├── README.md
├── docker-compose.yml
└── project
    ├── Dockerfile
    ├── core
    │   ├── __init__.py
    │   ├── asgi.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── entrypoint.sh
    ├── manage.py
    ├── pytest.ini
    ├── requirements.txt
    ├── static
    │   ├── bulma.min.css
    │   ├── jquery-3.4.1.min.js
    │   ├── main.css
    │   └── main.js
    ├── tasks
    │   ├── __init__.py
    │   ├── apps.py
    │   ├── migrations
    │   │   └── __init__.py
    │   ├── templates
    │   │   └── home.html
    │   └── views.py
    └── tests
        ├── __init__.py
        └── test_tasks.py
</code></pre></div>

<blockquote>
<p>想学习如何构建这个项目吗？查看关于Django与Postgres、Gunicorn和Nginx的文章。</p>
</blockquote>
<h2 id="trigger-a-task">触发任务</h2>
<p>在<em> project/static/main.js </em>中设置了一个事件处理程序来监听按钮点击。点击时，一个AJAX POST请求被发送到具有适当任务类型的服务器:<code>1</code>、<code>2</code>或<code>3</code>。</p>
<div class="codehilite"><pre><span/><code><span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">'/tasks/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">'type'</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">done</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_id</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">fail</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>在服务器端，已经配置了一个视图来处理<em> project/tasks/views.py </em>中的请求:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">"task_type"</span><span class="p">:</span> <span class="n">task_type</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">202</span><span class="p">)</span>
</code></pre></div>

<p>现在有趣的部分来了:给芹菜布线！</p>
<h2 id="celery-setup">芹菜装置</h2>
<p>首先将Celery和Redis添加到<em> project/requirements.txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>Django==4.1.4
pytest==7.2.0
pytest-django==4.5.2

celery==5.2.7
redis==4.4.0
</code></pre></div>

<p>Celery使用消息<a href="https://docs.celeryq.dev/en/stable/getting-started/backends-and-brokers/index.html">代理</a> - <a href="https://www.rabbitmq.com/"> RabbitMQ </a>、<a href="https://redis.io/"> Redis </a>或<a href="https://aws.amazon.com/sqs/"> AWS简单队列服务(SQS) </a> -来促进Celery worker和web应用程序之间的通信。消息被添加到代理中，然后由工作人员进行处理。一旦完成，结果被添加到后端。</p>
<p>Redis将被用作代理和后端。将Redis和芹菜<a href="https://docs.celeryq.dev/en/latest/userguide/workers.html">工人</a>添加到<em> docker-compose.yml </em>文件中，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1337:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=dbaa1_i7%*<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7e4d0c4753430453552113044a0c535f0f1b1b1a3e">[email protected]</a>(-a_r(<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="93f4d3f8abf9fcabeaa0e1a1a4">[email protected]</a>%m</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">celery</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery --app=core worker --loglevel=info</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=dbaa1_i7%*<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1c2f6e253121663137437166286e313d6d7979785c">[email protected]</a>(-a_r(<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="deb99eb5e6b4b1e6a7edacece9">[email protected]</a>%m</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span><span class="w"/>
</code></pre></div>

<p>请注意<code>celery --app=core worker --loglevel=info</code>:</p>
<ol>
<li><code>celery worker</code>是用来开动芹菜<a href="https://docs.celeryq.dev/en/stable/userguide/workers.html#starting-the-worker">的工人</a></li>
<li><code>--app=core</code>运行<code>core</code>芹菜<a href="https://docs.celeryq.dev/en/stable/userguide/application.html">应用程序</a>(我们稍后会定义)</li>
<li><code>--loglevel=info</code>将<a href="https://docs.celeryq.dev/en/v4.4.7/reference/celery.bin.worker.html#cmdoption-celery-worker-l">记录级别</a>设置为信息</li>
</ol>
<p>在项目的设置模块中，在底部添加以下内容，告诉Celery使用Redis作为代理和后端:</p>
<div class="codehilite"><pre><span/><code><span class="n">CELERY_BROKER_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"CELERY_BROKER"</span><span class="p">,</span> <span class="s2">"redis://redis:6379/0"</span><span class="p">)</span>
<span class="n">CELERY_RESULT_BACKEND</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"CELERY_BROKER"</span><span class="p">,</span> <span class="s2">"redis://redis:6379/0"</span><span class="p">)</span>
</code></pre></div>

<p>接下来，在“项目/任务”中创建一个名为<em> sample_tasks.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/tasks/sample_tasks.py</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>


<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">create_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>这里，使用<a href="https://docs.celeryq.dev/en/latest/django/first-steps-with-django.html#using-the-shared-task-decorator"> shared_task </a>装饰器，我们定义了一个名为<code>create_task</code>的新芹菜任务函数。</p>
<blockquote>
<p>请记住，任务本身将<em>而不是</em>从Django流程中执行；它将由芹菜工人来执行。</p>
</blockquote>
<p>现在，向“项目/核心”添加一个<em> celery.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"DJANGO_SETTINGS_MODULE"</span><span class="p">,</span> <span class="s2">"core.settings"</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s2">"core"</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s2">"django.conf:settings"</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">"CELERY"</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>
</code></pre></div>

<p>这里发生了什么事？</p>
<ol>
<li>首先，我们为环境变量<code>DJANGO_SETTINGS_MODULE</code>设置一个默认值，这样Celery将知道如何找到Django项目。</li>
<li>接下来，我们创建了一个名为<code>core</code>的新Celery实例，并将值赋给一个名为<code>app</code>的变量。</li>
<li>然后我们从<code>django.conf</code>的settings对象中加载celery配置值。我们使用了<code>namespace="CELERY"</code>来防止与其他Django场景的冲突。换句话说，芹菜的所有配置设置都必须以<code>CELERY_</code>为前缀。</li>
<li>最后，<code>app.autodiscover_tasks()</code>告诉Celery从<code>settings.INSTALLED_APPS</code>中定义的应用程序中寻找Celery任务。</li>
</ol>
<p>更新<em>项目/核心/__init__。py </em>以便在Django启动时自动导入Celery应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"celery_app"</span><span class="p">,)</span>
</code></pre></div>

<h2 id="trigger-a-task_1">触发任务</h2>
<p>更新视图以启动任务，并使用id:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/tasks/views.py</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">create_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">task_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">"task_id"</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">202</span><span class="p">)</span>
</code></pre></div>

<p>不要忘记导入任务:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">tasks.sample_tasks</span> <span class="kn">import</span> <span class="n">create_task</span>
</code></pre></div>

<p>构建映像并旋转新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>要触发新任务，请运行:</p>
<div class="codehilite"><pre><span/><code>$ curl -F <span class="nv">type</span><span class="o">=</span><span class="m">0</span> http://localhost:1337/tasks/
</code></pre></div>

<p>您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">{</span>
  <span class="s2">"task_id"</span>: <span class="s2">"6f025ed9-09be-4cbb-be10-1dce919797de"</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="task-status">任务状态</h2>
<p>回到客户端的事件处理程序:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// project/static/main.js</span><span class="w"/>

<span class="nx">$</span><span class="p">(</span><span class="s1">'.button'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">'/tasks/'</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">'type'</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">done</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_id</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">fail</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">});</span><span class="w"/>
</code></pre></div>

<p>当响应从最初的AJAX请求返回时，我们继续每秒调用带有任务id的<code>getStatus()</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kd">function</span><span class="w"> </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">taskID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"/>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="sb">`/tasks/</span><span class="si">${</span><span class="nx">taskID</span><span class="si">}</span><span class="sb">/`</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'GET'</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">done</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">      &lt;tr&gt;</span>
<span class="sb">        &lt;td&gt;</span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_id</span><span class="si">}</span><span class="sb">&lt;/td&gt;</span>
<span class="sb">        &lt;td&gt;</span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_status</span><span class="si">}</span><span class="sb">&lt;/td&gt;</span>
<span class="sb">        &lt;td&gt;</span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_result</span><span class="si">}</span><span class="sb">&lt;/td&gt;</span>
<span class="sb">      &lt;/tr&gt;`</span><span class="w"/>
<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">'#tasks'</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span><span class="w"/>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">task_status</span><span class="p">;</span><span class="w"/>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">taskStatus</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'SUCCESS'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">taskStatus</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'FAILURE'</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">task_id</span><span class="p">);</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span><span class="w"/>
<span class="w">  </span><span class="p">})</span><span class="w"/>
<span class="w">  </span><span class="p">.</span><span class="nx">fail</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"/>
<span class="w">  </span><span class="p">});</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>如果响应成功，一个新行被添加到DOM上的表中。</p>
<p>更新<code>get_status</code>视图以返回状态:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/tasks/views.py</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
    <span class="n">task_result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"task_id"</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>
        <span class="s2">"task_status"</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="s2">"task_result"</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">result</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>

<p>导入<a href="https://docs.celeryq.dev/en/latest/reference/celery.result.html">异步结果</a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">AsyncResult</span>
</code></pre></div>

<p>更新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>触发新任务:</p>
<div class="codehilite"><pre><span/><code>$ curl -F <span class="nv">type</span><span class="o">=</span><span class="m">1</span> http://localhost:1337/tasks/
</code></pre></div>

<p>然后，从响应中获取<code>task_id</code>并调用更新的端点来查看状态:</p>
<div class="codehilite"><pre><span/><code>$ curl http://localhost:1337/tasks/25278457-0957-4b0b-b1da-2600525f812f/

<span class="o">{</span>
    <span class="s2">"task_id"</span>: <span class="s2">"25278457-0957-4b0b-b1da-2600525f812f"</span>,
    <span class="s2">"task_status"</span>: <span class="s2">"SUCCESS"</span>,
    <span class="s2">"task_result"</span>: <span class="nb">true</span>
<span class="o">}</span>
</code></pre></div>

<p>也在浏览器中测试一下:</p>
<p><img data-src="/static/images/blog/django/django-celery/django_celery_updated.png" loading="lazy" class="lazyload" alt="django, celery, docker" src="../Images/a8a4335e29f1954cf881d6ac79071ed8.png" data-original-src="https://testdriven.io/static/images/blog/django/django-celery/django_celery_updated.png"/></p>
<h2 id="celery-logs">芹菜原木</h2>
<p>更新<em> docker-compose.yml </em>中的<code>celery</code>服务，以便将芹菜日志转储到一个日志文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">celery</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery --app=core worker --loglevel=info --logfile=logs/celery.log</span><span class="w"/>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project:/usr/src/app</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=dbaa1_i7%*<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6e5d1c5743531443453103145a1c434f1f0b0b0a2e">[email protected]</a>(-a_r(<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="026542693a686d3a7b31703035">[email protected]</a>%m</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
</code></pre></div>

<p>向“项目”添加一个名为“日志”的新目录。然后，将名为<em> celery.log </em>的新文件添加到新创建的目录中。</p>
<p>更新:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>由于我们设置了一个卷，您应该看到日志文件在本地被填满:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:20,338: INFO/MainProcess<span class="o">]</span> Connected to redis://redis:6379/0
<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:21,328: INFO/MainProcess<span class="o">]</span> mingle: searching <span class="k">for</span> neighbors
<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:23,342: INFO/MainProcess<span class="o">]</span> mingle: all alone
<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:24,214: WARNING/MainProcess<span class="o">]</span> /usr/local/lib/python3.11/site-packages/celery/fixups/django.py:203: UserWarning: Using settings.DEBUG leads to a memory
            leak, never use this setting <span class="k">in</span> production environments!
  warnings.warn<span class="o">(</span><span class="s1">''</span><span class="err">'</span>Using settings.DEBUG leads to a memory

<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:25,080: INFO/MainProcess<span class="o">]</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6407010801161d24000157545c0655065c545553">[email protected]</a> ready.
<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:40,132: INFO/MainProcess<span class="o">]</span> Task tasks.sample_tasks.create_task<span class="o">[</span>c4589a0d-f718-4d75-a673-fe3626827385<span class="o">]</span> received
<span class="o">[</span><span class="m">2022</span>-12-15 <span class="m">18</span>:15:40,153: INFO/ForkPoolWorker-1<span class="o">]</span> Task tasks.sample_tasks.create_task<span class="o">[</span>c4589a0d-f718-4d75-a673-fe3626827385<span class="o">]</span> succeeded <span class="k">in</span> <span class="m">0</span>.016174572000181797s: True
</code></pre></div>

<h2 id="flower-dashboard">花卉仪表板</h2>
<p><a href="https://flower.readthedocs.io/en/latest/"> Flower </a>是一个轻量级的、实时的、基于网络的芹菜监控工具。您可以监控当前正在运行的任务，增加或减少工作池，查看图表和一些统计数据，等等。</p>
<p>添加到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>Django==4.1.4
pytest==7.2.0
pytest-django==4.5.2

celery==5.2.7
redis==4.4.0
flower==1.2.0
</code></pre></div>

<p>然后，向<em> docker-compose.yml </em>添加一个新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">dashboard</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery flower -A core --port=5555 --broker=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5555:5555</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=dbaa1_i7%*<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="99aaeba0b4a4e3b4b2c6f4e3adebb4b8e8fcfcfdd9">[email protected]</a>(-a_r(<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3c5b7c5704565304450f4e0e0b">[email protected]</a>%m</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BROKER=redis://redis:6379/0</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CELERY_BACKEND=redis://redis:6379/0</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery</span><span class="w"/>
</code></pre></div>

<p>测试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://localhost:5555"> http://localhost:5555 </a>查看仪表板。您应该看到一名员工准备就绪:</p>
<p><img data-src="/static/images/blog/django/django-celery/flower_dashboard.png" loading="lazy" class="lazyload" alt="flower dashboard" src="../Images/95259d3e9e2f60a71c84f203753e341a.png" data-original-src="https://testdriven.io/static/images/blog/django/django-celery/flower_dashboard.png"/></p>
<p>开始几项任务来全面测试仪表板:</p>
<p><img data-src="/static/images/blog/django/django-celery/flower_dashboard2.png" loading="lazy" class="lazyload" alt="flower dashboard" src="../Images/50b8714f50a52ec8e959011298415448.png" data-original-src="https://testdriven.io/static/images/blog/django/django-celery/flower_dashboard2.png"/></p>
<p>试着增加几个工人，看看会有什么影响:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build --scale <span class="nv">celery</span><span class="o">=</span><span class="m">3</span>
</code></pre></div>

<h2 id="tests">试验</h2>
<p>让我们从最基本的测试开始:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_task</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<p>将上述测试用例添加到<em>project/tests/test _ tasks . py</em>中，然后添加以下导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">sample_tasks</span>
</code></pre></div>

<p>单独运行测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python -m pytest -k <span class="s2">"test_task and not test_home"</span>
</code></pre></div>

<p>运行应该需要大约一分钟:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.1, pytest-7.2.0, pluggy-1.0.0
django: settings: core.settings <span class="o">(</span>from ini<span class="o">)</span>
rootdir: /usr/src/app, configfile: pytest.ini
plugins: django-4.5.2
collected <span class="m">2</span> items / <span class="m">1</span> deselected / <span class="m">1</span> selected

tests/test_tasks.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===================</span> <span class="m">1</span> passed, <span class="m">1</span> deselected <span class="k">in</span> <span class="m">60</span>.69s <span class="o">(</span><span class="m">0</span>:01:00<span class="o">)</span> <span class="o">====================</span>
</code></pre></div>

<p>值得注意的是，在上面的断言中，我们使用了<code>.run</code>方法(而不是<code>.delay</code>)来直接运行任务，而没有芹菜工人。</p>
<p>想要模仿<code>.run</code>方法来加快速度吗？</p>
<div class="codehilite"><pre><span/><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">"tasks.sample_tasks.create_task.run"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_mock_task</span><span class="p">(</span><span class="n">mock_run</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample_tasks</span><span class="o">.</span><span class="n">create_task</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<p>导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
</code></pre></div>

<p>测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python -m pytest -k <span class="s2">"test_mock_task"</span>

<span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.1, pytest-7.2.0, pluggy-1.0.0
django: settings: core.settings <span class="o">(</span>from ini<span class="o">)</span>
rootdir: /usr/src/app, configfile: pytest.ini
plugins: django-4.5.2
collected <span class="m">3</span> items / <span class="m">2</span> deselected / <span class="m">1</span> selected

tests/test_tasks.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=========================</span> <span class="m">1</span> passed, <span class="m">2</span> deselected <span class="k">in</span> <span class="m">0</span>.64s <span class="o">=========================</span>
</code></pre></div>

<p>快多了！</p>
<p>全面整合测试怎么样？</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_task_status</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">"run_task"</span><span class="p">),</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">"task_id"</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">202</span>
    <span class="k">assert</span> <span class="n">task_id</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">"get_status"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">task_id</span><span class="p">]))</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">content</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"task_id"</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span> <span class="s2">"task_status"</span><span class="p">:</span> <span class="s2">"PENDING"</span><span class="p">,</span> <span class="s2">"task_result"</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="k">while</span> <span class="n">content</span><span class="p">[</span><span class="s2">"task_status"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"PENDING"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">"get_status"</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">task_id</span><span class="p">]))</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">content</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"task_id"</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span> <span class="s2">"task_status"</span><span class="p">:</span> <span class="s2">"SUCCESS"</span><span class="p">,</span> <span class="s2">"task_result"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</code></pre></div>

<p>请记住，这个测试使用开发中使用的相同的代理和后端。您可能想要实例化一个新的Celery应用程序来进行测试:</p>
<div class="codehilite"><pre><span/><code><span class="n">app</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">Celery</span><span class="p">(</span><span class="s1">'tests'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">CELERY_TEST_BROKER</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">CELERY_TEST_BACKEND</span><span class="p">)</span>
</code></pre></div>

<p>添加导入:</p>


<p>确保测试通过。</p>
<h2 id="conclusion">结论</h2>
<p>这是关于如何在Django应用程序中配置Celery来运行长时间运行的任务的基本指南。您应该让队列处理任何可能阻塞或减慢面向用户的代码的进程。</p>
<p>Celery还可以用于执行可重复的任务，分解复杂的资源密集型任务，以便将计算工作量分布到多个机器上，从而减少(1)完成时间和(2)处理客户端请求的机器上的负载。</p>
<p>最后，如果你想知道如何使用WebSockets(通过Django通道)来检查芹菜任务的状态，而不是使用AJAX轮询，请查看<a href="/courses/django-celery/">芹菜和Django </a>课程的权威指南。</p>
<p>从<a href="https://github.com/testdrivenio/django-celery">回购</a>中抓取代码。</p>
<blockquote>
<p>姜戈+芹菜系列:</p>
<ol>
<li><a href="/blog/django-and-celery/">与Django和芹菜的异步任务</a>(本文！)</li>
<li><a href="/blog/django-celery-periodic-tasks/">在Django用芹菜和码头工人处理定期任务</a></li>
<li><a href="/blog/retrying-failed-celery-tasks/">自动重试失败的芹菜任务</a></li>
<li><a href="/blog/celery-database-transactions/">处理芹菜和数据库事务</a></li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>