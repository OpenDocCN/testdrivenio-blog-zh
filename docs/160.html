<html>
<head>
<title>Python 3.9: What's New </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Python 3.9:新特性</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/python39/#0001-01-01">https://testdriven.io/blog/python39/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>Python 3.9于2020年10月5日发布，没有带来任何重大的新特性，但仍然有一些重大的变化，特别是在语言的开发和发布方面。</p>



<h2 id="development-cycle">开发周期</h2>
<p>这是来自新发布理念的第一个Python版本，其中主要发布每12个月(10月)而不是每18个月进行一次。随着发布越来越频繁，变化应该越来越小——这正是我们在Python 3.9中看到的。</p>
<p>所有新版本都有1.5年的全面支持和3.5年的安全修复。</p>
<p><a href="/static/images/blog/python39/python_releases.png"><img data-src="/static/images/blog/python39/python_releases.png" loading="lazy" class="lazyload" alt="Python release calendar" src="../Images/299e066b86e737ebb65977e9e8adee4d.png" data-original-src="https://testdriven.io/static/images/blog/python39/python_releases.png"/>T2】</a></p>
<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0602/">https://www.python.org/dev/peps/pep-0602/</a></p>
<h2 id="dictionary-unions">词典联盟</h2>
<h3 id="merge-dictionaries">合并词典</h3>
<p>我们现在有一个用于执行字典联合的合并操作符:<code>|</code>。它的工作方式与<code>a.update(b)</code>或<code>{**a, **b}</code>相同，只有一点不同:它适用于<code>dict</code>子类的任何实例。</p>
<blockquote>
<p>如果你有Docker，你可以通过<code>docker run -it --rm python:3.9</code>快速构建一个Python 3.9 shell来使用本文中的例子。</p>
</blockquote>
<p>您可以像这样合并两个字典:</p>
<div class="codehilite"><pre><span/><code><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="s1">'surname'</span><span class="p">:</span> <span class="s1">'Doe'</span><span class="p">}</span>
<span class="n">address</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'street'</span><span class="p">:</span> <span class="s1">'Awesome street 42'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">:</span> <span class="s1">'Huge city'</span><span class="p">,</span> <span class="s1">'post'</span><span class="p">:</span> <span class="s1">'420000'</span><span class="p">}</span>

<span class="n">user_with_address</span> <span class="o">=</span> <span class="n">user</span> <span class="o">|</span> <span class="n">address</span>

<span class="nb">print</span><span class="p">(</span><span class="n">user_with_address</span><span class="p">)</span>
<span class="c1"># {'name': 'John', 'surname': 'Doe', 'street': 'Awesome street 42', 'city': 'Huge city', 'post': '420000'}</span>
</code></pre></div>

<p>现在，我们有了一个新的字典叫做<code>user_with_address</code>，它是<code>user</code>和<code>address</code>的结合。</p>
<p>如果字典中有重复的键，那么输出将显示第二个(最右边的)键-值对:</p>
<div class="codehilite"><pre><span/><code><span class="n">user_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="s1">'surname'</span><span class="p">:</span> <span class="s1">'Doe'</span><span class="p">}</span>
<span class="n">user_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'Joe'</span><span class="p">,</span> <span class="s1">'surname'</span><span class="p">:</span> <span class="s1">'Doe'</span><span class="p">}</span>

<span class="n">users</span> <span class="o">=</span> <span class="n">user_1</span> <span class="o">|</span> <span class="n">user_2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="c1"># {'name': 'Joe', 'surname': 'Doe'}</span>
</code></pre></div>

<blockquote>
<p>运算符的意思是并集，而不是或。它不做任何位运算，也不充当逻辑运算符。它用于创建两个字典的并集。因为它看起来类似于其他语言中的or条件，所以您可能希望在代码评审期间仔细检查它是如何使用的。</p>
</blockquote>
<h3 id="updating-dictionaries">更新词典</h3>
<p>至于更新，现在有了操作符<code>|=</code>。这在适当的地方工作。</p>
<p>您可以用第二个字典中的键和值更新第一个字典，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="n">grades</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'John'</span><span class="p">:</span> <span class="s1">'A'</span><span class="p">,</span> <span class="s1">'Marry'</span><span class="p">:</span> <span class="s1">'B+'</span><span class="p">}</span>
<span class="n">grades_second_try</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Marry'</span><span class="p">:</span> <span class="s1">'A'</span><span class="p">,</span> <span class="s1">'Jane'</span><span class="p">:</span> <span class="s1">'C-'</span><span class="p">,</span> <span class="s1">'James'</span><span class="p">:</span> <span class="s1">'B'</span><span class="p">}</span>

<span class="n">grades</span> <span class="o">|=</span> <span class="n">grades_second_try</span>

<span class="nb">print</span><span class="p">(</span><span class="n">grades</span><span class="p">)</span>
<span class="c1"># {'John': 'A', 'Marry': 'A', 'Jane': 'C-', 'James': 'B'}</span>
</code></pre></div>

<p>它适用于任何带有<code>keys</code>和<code>__getitem__</code>的对象或者带有键值对的可迭代对象:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># example 1</span>
<span class="n">grades</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'John'</span><span class="p">:</span> <span class="s1">'A'</span><span class="p">,</span> <span class="s1">'Marry'</span><span class="p">:</span> <span class="s1">'B+'</span><span class="p">}</span>
<span class="n">grades_second_try</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'Marry'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'Jane'</span><span class="p">,</span> <span class="s1">'C-'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'James'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)]</span>
<span class="n">grades</span> <span class="o">|=</span> <span class="n">grades_second_try</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grades</span><span class="p">)</span>
<span class="c1"># {'John': 'A', 'Marry': 'A', 'Jane': 'C-', 'James': 'B'}</span>


<span class="c1"># example 2</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">|=</span> <span class="n">y</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>


<span class="c1"># example 3</span>
<span class="n">x</span> <span class="o">|</span> <span class="n">y</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">unsupported</span> <span class="n">operand</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="o">|</span><span class="p">:</span> <span class="s1">'dict'</span> <span class="ow">and</span> <span class="s1">'generator'</span>
</code></pre></div>

<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0584/">https://www.python.org/dev/peps/pep-0584/</a></p>
<h2 id="generating-random-bytes">生成随机字节</h2>
<p><a href="https://docs.python.org/3/library/random.html"> random </a>库现在可以用来通过<a href="https://docs.python.org/3/library/random.html#random.randbytes"> randbytes </a>生成随机字节。</p>
<p>例如，要生成十个随机字节:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">random</span>

<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span><span class="o">.</span><span class="n">randbytes</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="sa">b</span><span class="s1">'CO</span><span class="se">\x0e\x0e</span><span class="s1">~</span><span class="se">\x12\x0c\xa4\xa0</span><span class="s1">p'</span>
</code></pre></div>

<p>更多信息:<a href="https://bugs.python.org/issue40286">https://bugs.python.org/issue40286</a></p>
<h2 id="string-methods">字符串方法</h2>
<p>向<code>str</code>对象添加了两个方法:</p>
<ol>
<li><a href="https://docs.python.org/3/library/stdtypes.html#str.removeprefix">删除前缀</a></li>
<li><a href="https://docs.python.org/3/library/stdtypes.html#str.removesuffix"> removesuffix </a></li>
</ol>
<h3 id="removeprefix">移除前缀</h3>
<p>第一种方法从另一个字符串的开头删除输入的字符串。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="n">file_name</span> <span class="o">=</span> <span class="s1">'DOCUMENT_001.pdf'</span>

<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s1">'DOCUMENT_'</span><span class="p">))</span>
<span class="c1">#  001.pdf</span>
</code></pre></div>

<p>如果字符串不是以输入字符串开头，将返回原始字符串的副本:</p>
<div class="codehilite"><pre><span/><code><span class="n">file_name</span> <span class="o">=</span> <span class="s1">'DOCUMENT_001.pdf'</span>

<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s1">'DOC_'</span><span class="p">))</span>
<span class="c1"># DOCUMENT_001.pdf</span>
</code></pre></div>

<h3 id="removesuffix">删除后缀</h3>
<p>类似地，我们可以用第二种方法从选中的字符串中删除后缀。</p>
<p>要从文件名中删除文件扩展名<code>.pdf</code>:</p>
<div class="codehilite"><pre><span/><code><span class="n">file_name</span> <span class="o">=</span> <span class="s1">'DOCUMENT_001.pdf'</span>

<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s1">'.pdf'</span><span class="p">))</span>
<span class="c1"># DOCUMENT_001</span>


<span class="n">file_name</span> <span class="o">=</span> <span class="s1">'DOCUMENT_001.pdf'</span>

<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s1">'.csv'</span><span class="p">))</span>
<span class="c1"># DOCUMENT_001.pdf</span>
</code></pre></div>

<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0616/">https://www.python.org/dev/peps/pep-0616/</a></p>
<h2 id="iana-timezone-support">IANA时区支持</h2>
<p>添加了<a href="https://docs.python.org/3/library/zoneinfo.html"> zoneinfo </a>模块来支持IANA时区数据库。</p>
<p>例如，要创建支持时区的时间戳，可以向datetime方法添加<code>tz</code>或<code>tzinfo</code>参数:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>

<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s1">'America/Los_Angeles'</span><span class="p">))</span>
<span class="c1"># datetime.datetime(2020, 10, 7, 1, 0, tzinfo=zoneinfo.ZoneInfo(key='America/Los_Angeles'))</span>
</code></pre></div>

<p>您也可以轻松地在时区之间转换:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s1">'America/Los_Angeles'</span><span class="p">))</span>
<span class="n">start</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s1">'Europe/London'</span><span class="p">))</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">zoneinfo</span><span class="o">.</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">'Europe/London'</span><span class="p">))</span>
</code></pre></div>

<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0615/">https://www.python.org/dev/peps/pep-0615/</a></p>
<h2 id="generic-type-annotations">泛型类型批注</h2>
<p>从现在开始，您可以对类型注释使用泛型类型。您可以使用<code>list</code>或<code>dict</code>内置集合类型作为泛型类型，而不必使用<code>typing.List</code>或<code>typing.Dict</code></p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">sort_names</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<p>Python是动态类型化的，类型是动态推断的。由于这并不总是可取的，类型提示可以用来指定类型。这是在Python 3.5中引入的。能够将内置集合类型用作泛型类型极大地简化了类型提示。</p>
</blockquote>
<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0585/">https://www.python.org/dev/peps/pep-0585/</a></p>
<h2 id="canceling-concurrent-futures">取消并行期货</h2>
<p>一个名为<code>cancel_futures</code>的新参数被添加到<code>concurrent.futures.Executor.shutdown()</code>中。当设置为<code>True</code>时，取消所有未开始运行的未决期货。在3.9版本之前，进程会在关闭执行器之前等待它们完成。</p>
<p>更多信息:<a href="https://bugs.python.org/issue30966">https://bugs.python.org/issue30966</a></p>
<h2 id="importerror">导入错误</h2>
<p>在以前的版本中，<code>__import__</code>和<code>importlib.util.resolve_name()</code>在相对导入通过其顶层包时引发<code>ValueError</code>。现在您将得到一个<code>ImportError</code>，它更好地描述了正在处理的情况。</p>
<p>更多信息:<a href="https://bugs.python.org/issue37444">https://bugs.python.org/issue37444</a></p>
<h2 id="string-replace-fix">字符串替换修复</h2>
<p>修复了空字符串替换的问题。</p>
<p>在以前的版本中:</p>
<div class="codehilite"><pre><span/><code><span class="s2">""</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"prefix"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># ''</span>
</code></pre></div>

<p>从现在开始:</p>
<div class="codehilite"><pre><span/><code><span class="s2">""</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"prefix"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># 'prefix'</span>
</code></pre></div>

<p>更多信息:<a href="https://bugs.python.org/issue28029">https://bugs.python.org/issue28029</a></p>
<h2 id="new-parser">新解析器</h2>
<p>引入了一个新的更加灵活的基于<a href="https://en.wikipedia.org/wiki/Parsing_expression_grammar"> PEG </a>(解析表达式语法)的解析器。虽然您可能不会注意到，但这是Python这个版本最显著的变化。</p>
<p>基于PEG的解析器的<a href="https://www.python.org/dev/peps/pep-0617/#performance">性能</a>可与旧的<a href="https://en.wikipedia.org/wiki/LL_parser"> LL(1) </a>(从左到右解析器)相媲美，但它更灵活的形式主义应该更容易设计新的语言特性。</p>
<p>更多信息:<a href="https://www.python.org/dev/peps/pep-0617">https://www.python.org/dev/peps/pep-0617</a></p>
<h2 id="performance">表演</h2>
<p>最后，Python 3.8中引入的<a href="https://www.python.org/dev/peps/pep-0590/"> vectorcall </a>协议现在已经扩展到了几个内置的，包括range、tuple、set、frozenset、list和dict。简而言之，vectorcall通过减少为调用创建的临时对象的数量来减少开销，从而使许多常见的函数调用变得更快。</p>
<p>更多信息:<a href="https://docs.python.org/3.9/c-api/call.html#the-vectorcall-protocol">https://docs . python . org/3.9/c-API/call . html # the-vector call-protocol</a></p>
<h2 id="conclusion">结论</h2>
<p>这篇文章仅仅触及了语言的主要变化。完整的变更列表可以在<a href="https://docs.python.org/3.9/whatsnew/3.9.html">这里</a>找到。</p>
<p>编码快乐！</p>
  </div>

  </div>    
</body>
</html>