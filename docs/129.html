<html>
<head>
<title>Continuously Deploying Django to DigitalOcean with Docker and GitLab </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>与Docker和GitLab一起将Django持续部署到数字海洋</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/deploying-django-to-digitalocean-with-docker-and-gitlab/#0001-01-01">https://testdriven.io/blog/deploying-django-to-digitalocean-with-docker-and-gitlab/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将了解如何配置GitLab CI，以便将Django和Docker应用程序持续部署到DigitalOcean。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>Django v3.2.4</li>
<li>Docker v20.04</li>
<li>python 3 . 9 . 5版</li>
</ol>



<h2 id="objectives">目标</h2>
<p>本教程结束时，您将能够:</p>
<ol>
<li>使用Docker将Django部署到数字海洋</li>
<li>配置GitLab CI以持续将Django部署到数字海洋</li>
<li>设置无密码SSH登录</li>
<li>为数据持久性配置数字海洋的托管数据库</li>
</ol>
<h2 id="project-setup">项目设置</h2>
<p>除了Django和Docker，我们将使用的演示项目还包括<a href="https://www.postgresql.org/"> Postgres </a>、<a href="https://www.nginx.com"> Nginx </a>和<a href="https://gunicorn.org/"> Gunicorn </a>。</p>
<blockquote>
<p>好奇这个项目是怎么开发出来的？查看Postgres、Gunicorn和Nginx的博客文章。</p>
</blockquote>
<p>从克隆基础项目开始:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://gitlab.com/testdriven/django-gitlab-digitalocean.git --branch base --single-branch
$ <span class="nb">cd</span> django-gitlab-digitalocean
</code></pre></div>

<p>要进行本地测试，构建映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>。您应该看到:</p>


<h2 id="digitalocean">数字海洋</h2>
<p>让我们设置DigitalOcean来使用我们的应用程序。</p>
<p>首先，你需要<a href="https://m.do.co/c/d8f211a4b4c2">注册</a>一个<a href="https://www.digitalocean.com/">数字海洋</a>账户(如果你还没有的话)，然后<a href="https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/">生成</a>一个访问令牌，这样你就可以访问<a href="https://developers.digitalocean.com/documentation/v2/">数字海洋API </a>。</p>
<p>将令牌添加到您的环境中:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="o">=[</span>your_digital_ocean_token<span class="o">]</span>
</code></pre></div>

<h3 id="droplet">微滴</h3>
<p>接下来，使用预装的Docker创建一个新的Droplet:</p>
<div class="codehilite"><pre><span/><code>$ curl -X POST <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    -d <span class="s1">'{"name":"django-docker","region":"sfo3","size":"s-2vcpu-4gb","image":"docker-20-04"}'</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/droplets"</span>
</code></pre></div>

<p>检查状态:</p>
<div class="codehilite"><pre><span/><code>$ curl <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/droplets?name=django-docker"</span>
</code></pre></div>

<p>如果您安装了<a href="https://stedolan.github.io/jq/"> jq </a>，那么您可以像这样解析JSON响应:</p>
<div class="codehilite"><pre><span/><code>$ curl <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/droplets?name=django-docker"</span> <span class="se">\</span>
  <span class="p">|</span> jq <span class="s1">'.droplets[0].status'</span>
</code></pre></div>

<p>root密码应该会通过电子邮件发送给您。找回它。然后，一旦droplet的状态为<code>active</code>，就以root身份SSH到实例中，并在提示时更新密码。</p>
<p>接下来，生成一个新的SSH密钥:</p>


<p>将密钥保存到<em> /root/。ssh/id_rsa </em>并且不设置密码。这将分别生成一个公钥和私钥- <em> id_rsa </em>和<em> id_rsa.pub </em>。要设置无密码SSH登录，请将公钥复制到<a href="https://security.stackexchange.com/questions/20706/what-is-the-difference-between-authorized-keys-and-known-hosts-file-for-ssh"> authorized_keys </a>文件中，并设置适当的权限:</p>
<div class="codehilite"><pre><span/><code>$ cat ~/.ssh/id_rsa.pub
$ vi ~/.ssh/authorized_keys
$ chmod <span class="m">600</span> ~/.ssh/authorized_keys
$ chmod <span class="m">600</span> ~/.ssh/id_rsa
</code></pre></div>

<p>复制私钥的内容:</p>


<p>将其设置为本地计算机上的环境变量:</p>
<div class="codehilite"><pre><span/><code><span class="nb">export</span> <span class="nv">PRIVATE_KEY</span><span class="o">=</span><span class="s1">'-----BEGIN RSA PRIVATE KEY-----</span>
<span class="s1">MIIEpAIBAAKCAQEA04up8hoqzS1+APIB0RhjXyObwHQnOzhAk5Bd7mhkSbPkyhP1</span>
<span class="s1">...</span>
<span class="s1">iWlX9HNavcydATJc1f0DpzF0u4zY8PY24RVoW8vk+bJANPp1o2IAkeajCaF3w9nf</span>
<span class="s1">q/SyqAWVmvwYuIhDiHDaV2A==</span>
<span class="s1">-----END RSA PRIVATE KEY-----'</span>
</code></pre></div>

<p>将密钥添加到<a href="https://www.ssh.com/ssh/agent"> ssh-agent </a>中:</p>
<div class="codehilite"><pre><span/><code>$ ssh-add - <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="si">${</span><span class="nv">PRIVATE_KEY</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>

<p>要进行测试，请运行:</p>


<p>然后，为应用程序创建一个新目录:</p>


<h3 id="database">数据库ˌ资料库</h3>
<p>接下来，让我们通过数字海洋的<a href="https://www.digitalocean.com/products/managed-databases/">托管数据库</a>建立一个生产Postgres数据库:</p>
<div class="codehilite"><pre><span/><code>$ curl -X POST <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    -d <span class="s1">'{"name":"django-docker-db","region":"sfo3","engine":"pg","version":"13","size":"db-s-2vcpu-4gb","num_nodes":1}'</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/databases"</span>
</code></pre></div>

<p>检查状态:</p>
<div class="codehilite"><pre><span/><code>$ curl <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/databases?name=django-docker-db"</span> <span class="se">\</span>
  <span class="p">|</span> jq <span class="s1">'.databases[0].status'</span>
</code></pre></div>

<p>它应该需要几分钟才能旋转起来。一旦状态为<code>online</code>，获取连接信息:</p>
<div class="codehilite"><pre><span/><code>$ curl <span class="se">\</span>
    -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Bearer '</span><span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="s1">''</span> <span class="se">\</span>
    <span class="s2">"https://api.digitalocean.com/v2/databases?name=django-docker-db"</span> <span class="se">\</span>
  <span class="p">|</span> jq <span class="s1">'.databases[0].connection'</span>
</code></pre></div>

<p>示例响应:</p>
<div class="codehilite"><pre><span/><code><span class="o">{</span>
  <span class="s2">"protocol"</span>: <span class="s2">"postgresql"</span>,
  <span class="s2">"uri"</span>: <span class="s2">"postgresql://doadmin:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3f515e064b5c595a480655480e0c5e0d527f5b555e515850125b505c545a4d125b5d125b50124a4c5a4d120808070d080b120f115e115b5d1150515b5658564b5e">[email protected]</a>locean.com:25060/defaultdb?sslmode=require"</span>,
  <span class="s2">"database"</span>: <span class="s2">"defaultdb"</span>,
  <span class="s2">"host"</span>: <span class="s2">"django-docker-db-do-user-778274-0.a.db.ondigitalocean.com"</span>,
  <span class="s2">"port"</span>: <span class="m">25060</span>,
  <span class="s2">"user"</span>: <span class="s2">"doadmin"</span>,
  <span class="s2">"password"</span>: <span class="s2">"na9tcfew9jw13a2m"</span>,
  <span class="s2">"ssl"</span>: <span class="nb">true</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="gitlab-ci">GitLab CI</h2>
<p><a href="https://gitlab.com/users/sign_up">注册</a>一个GitLab账号(如果需要的话)，然后<a href="https://docs.gitlab.com/ee/user/project/working_with_projects.html#create-a-project">创建一个新项目</a>(再次，如果需要的话)。</p>
<h3 id="build-stage">构建阶段</h3>
<p>接下来，添加一个名为<em>的GitLab CI/CD配置文件。gitlab-ci.yml </em>到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="nt">image</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/compose:1.29.1</span><span class="w"/>
<span class="w">  </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">""</span><span class="p p-Indicator">]</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker:dind</span><span class="w"/>

<span class="nt">stages</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>

<span class="nt">variables</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp://docker:2375</span><span class="w"/>
<span class="w">  </span><span class="nt">DOCKER_DRIVER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay2</span><span class="w"/>

<span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export IMAGE=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export WEB_IMAGE=$IMAGE:web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export NGINX_IMAGE=$IMAGE:nginx</span><span class="w"/>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apk add --no-cache bash</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod +x ./setup_env.sh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash ./setup_env.sh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker pull $IMAGE:web || true</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker pull $IMAGE:nginx || true</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose.ci.yml build</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker push $IMAGE:web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker push $IMAGE:nginx</span><span class="w"/>
</code></pre></div>

<p>在这里，我们定义了单个<code>build</code> <a href="https://docs.gitlab.com/ee/ci/yaml/#stages">阶段</a>，在这里我们:</p>
<ol>
<li>设置<code>IMAGE</code>、<code>WEB_IMAGE</code>和<code>NGINX_IMAGE</code>环境变量</li>
<li>安装bash</li>
<li>为<em> setup_env.sh </em>设置适当的权限</li>
<li>运行<em> setup_env.sh </em></li>
<li>登录到<a href="https://docs.gitlab.com/ee/user/packages/container_registry/"> GitLab容器注册表</a></li>
<li>如果图像存在，请提取图像</li>
<li>构建图像</li>
<li>将图像上传到注册表</li>
</ol>
<p>将<em> setup_env.sh </em>文件添加到项目根目录:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="nb">echo</span> <span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_ENGINE</span><span class="o">=</span>django.db.backends.postgresql &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">DATABASE</span><span class="o">=</span>postgres &gt;&gt; .env

<span class="nb">echo</span> <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="nv">$SECRET_KEY</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_DATABASE</span><span class="o">=</span><span class="nv">$SQL_DATABASE</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_USER</span><span class="o">=</span><span class="nv">$SQL_USER</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_PASSWORD</span><span class="o">=</span><span class="nv">$SQL_PASSWORD</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_HOST</span><span class="o">=</span><span class="nv">$SQL_HOST</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_PORT</span><span class="o">=</span><span class="nv">$SQL_PORT</span> &gt;&gt; .env
</code></pre></div>

<p>这个文件将创建所需的<em>。env </em>文件，基于在GitLab项目的CI/CD设置中找到的环境变量(设置&gt; CI / CD &gt;变量)。根据连接信息添加变量。</p>
<p>例如:</p>
<ol>
<li><code>SECRET_KEY</code> : <code>9zYGEFk2mn3mWB8Bmg9SAhPy6F4s7cCuT8qaYGVEnu7huGRKW9</code></li>
<li><code>SQL_DATABASE</code> : <code>defaultdb</code></li>
<li><code>SQL_HOST</code> : <code>django-docker-db-do-user-778274-0.a.db.ondigitalocean.com</code></li>
<li><code>SQL_PASSWORD</code> : <code>na9tcfew9jw13a2m</code></li>
<li><code>SQL_PORT</code> : <code>25060</code></li>
<li><code>SQL_USER</code> : <code>doadmin</code></li>
</ol>
<p><img data-src="/static/images/blog/django/django-gitlab-digitalocean/gitlab-config.png" loading="lazy" class="lazyload" alt="gitlab config" src="../Images/a4aa8a1640e761dc5cdd60d917cf6599.png" data-original-src="https://testdriven.io/static/images/blog/django/django-gitlab-digitalocean/gitlab-config.png"/></p>
<p>完成后，提交代码并上传到GitLab以触发新的构建。确保它通过。您应该会在GitLab容器注册表中看到这些图像:</p>
<p><img data-src="/static/images/blog/django/django-gitlab-digitalocean/gitlab-container-registry.png" loading="lazy" class="lazyload" alt="gitlab config" src="../Images/7631d34c35ebed99e5716d3e2492f342.png" data-original-src="https://testdriven.io/static/images/blog/django/django-gitlab-digitalocean/gitlab-container-registry.png"/></p>
<h3 id="deploy-stage">部署阶段</h3>
<p>接下来，给<em>增加一个<code>deploy</code>阶段。gitlab-ci.yml </em>并创建一个用于两个阶段的全局<code>before_script</code>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">image</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/compose:1.29.1</span><span class="w"/>
<span class="w">  </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">""</span><span class="p p-Indicator">]</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker:dind</span><span class="w"/>

<span class="nt">stages</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span><span class="w"/>

<span class="nt">variables</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">DOCKER_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp://docker:2375</span><span class="w"/>
<span class="w">  </span><span class="nt">DOCKER_DRIVER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay2</span><span class="w"/>

<span class="nt">before_script</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export IMAGE=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export WEB_IMAGE=$IMAGE:web</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export NGINX_IMAGE=$IMAGE:nginx</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apk add --no-cache openssh-client bash</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod +x ./setup_env.sh</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash ./setup_env.sh</span><span class="w"/>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY</span><span class="w"/>

<span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class="w"/>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker pull $IMAGE:web || true</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker pull $IMAGE:nginx || true</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose.ci.yml build</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker push $IMAGE:web</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker push $IMAGE:nginx</span><span class="w"/>

<span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span><span class="w"/>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdir -p ~/.ssh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo "$PRIVATE_KEY" | tr -d '\r' &gt; ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cat ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod 700 ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eval "$(ssh-agent -s)"</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssh-add ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssh-keyscan -H 'gitlab.com' &gt;&gt; ~/.ssh/known_hosts</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod +x ./deploy.sh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scp  -o StrictHostKeyChecking=no -r ./.env ./docker-compose.prod.yml <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5e2c31312a1e">[email protected]</a>$DIGITAL_OCEAN_IP_ADDRESS:/app</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash ./deploy.sh</span><span class="w"/>
</code></pre></div>

<p>因此，在<code>deploy</code>阶段，我们:</p>
<ol>
<li>将私有ssh密钥添加到SSH代理中</li>
<li>复制完<em>。env </em>和<em> docker-compose.prod.yml </em>文件到远程服务器</li>
<li>为<em> deploy.sh </em>设置适当的权限</li>
<li>运行<em> deploy.sh </em></li>
</ol>
<p>将<em> deploy.sh </em>添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8af8e5e5feca">[email protected]</a><span class="nv">$DIGITAL_OCEAN_IP_ADDRESS</span> <span class="s">&lt;&lt; 'ENDSSH'</span>
<span class="s">  cd /app</span>
<span class="s">  export $(cat .env | xargs)</span>
<span class="s">  docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY</span>
<span class="s">  docker pull $IMAGE:web</span>
<span class="s">  docker pull $IMAGE:nginx</span>
<span class="s">  docker-compose -f docker-compose.prod.yml up -d</span>
<span class="s">ENDSSH</span>
</code></pre></div>

<p>因此，在登录到服务器后，我们</p>
<ol>
<li>导航到部署目录</li>
<li>添加环境变量</li>
<li>登录GitLab容器注册表</li>
<li>调出图像</li>
<li>旋转容器</li>
</ol>
<p>将<code>DIGITAL_OCEAN_IP_ADDRESS</code>和<code>PRIVATE_KEY</code>环境变量添加到GitLab中。</p>
<p>更新<em> setup_env.sh </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/sh</span>

<span class="nb">echo</span> <span class="nv">DEBUG</span><span class="o">=</span><span class="m">0</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_ENGINE</span><span class="o">=</span>django.db.backends.postgresql &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">DATABASE</span><span class="o">=</span>postgres &gt;&gt; .env

<span class="nb">echo</span> <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="nv">$SECRET_KEY</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_DATABASE</span><span class="o">=</span><span class="nv">$SQL_DATABASE</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_USER</span><span class="o">=</span><span class="nv">$SQL_USER</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_PASSWORD</span><span class="o">=</span><span class="nv">$SQL_PASSWORD</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_HOST</span><span class="o">=</span><span class="nv">$SQL_HOST</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">SQL_PORT</span><span class="o">=</span><span class="nv">$SQL_PORT</span> &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">WEB_IMAGE</span><span class="o">=</span><span class="nv">$IMAGE</span>:web  &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">NGINX_IMAGE</span><span class="o">=</span><span class="nv">$IMAGE</span>:nginx  &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">CI_REGISTRY_USER</span><span class="o">=</span><span class="nv">$CI_REGISTRY_USER</span>   &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">CI_JOB_TOKEN</span><span class="o">=</span><span class="nv">$CI_JOB_TOKEN</span>  &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">CI_REGISTRY</span><span class="o">=</span><span class="nv">$CI_REGISTRY</span>  &gt;&gt; .env
<span class="nb">echo</span> <span class="nv">IMAGE</span><span class="o">=</span><span class="nv">$CI_REGISTRY</span>/<span class="nv">$CI_PROJECT_NAMESPACE</span>/<span class="nv">$CI_PROJECT_NAME</span> &gt;&gt; .env
</code></pre></div>

<p>接下来，将服务器的IP添加到Django设置中的<code>ALLOWED_HOSTS</code>列表。</p>
<p>提交并推送您的代码以触发新的构建。构建通过后，导航到实例的IP。您应该看到:</p>


<h2 id="test">试验</h2>
<p>最后，更新<code>deploy</code>阶段，使其仅在对<code>master</code>分支进行更改时运行:</p>
<div class="codehilite"><pre><span/><code><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span><span class="w"/>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdir -p ~/.ssh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo "$PRIVATE_KEY" | tr -d '\r' &gt; ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cat ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod 700 ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eval "$(ssh-agent -s)"</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssh-add ~/.ssh/id_rsa</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssh-keyscan -H 'gitlab.com' &gt;&gt; ~/.ssh/known_hosts</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chmod +x ./deploy.sh</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scp  -o StrictHostKeyChecking=no -r ./.env ./docker-compose.prod.yml <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aedcc1c1daee">[email protected]</a>$DIGITAL_OCEAN_IP_ADDRESS:/app</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash ./deploy.sh</span><span class="w"/>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">master</span><span class="w"/>
</code></pre></div>

<p>为了测试，创建一个新的<code>develop</code>分支。在<em> urls.py </em>中的<code>world</code>后加一个感叹号:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'hello'</span><span class="p">:</span> <span class="s1">'world!'</span><span class="p">})</span>
</code></pre></div>

<p>将您的更改提交并推送到GitLab。确保只运行<code>build</code>阶段。一旦构建通过，打开一个针对<code>master</code>分支的PR并合并变更。这将触发一个包含两个阶段的新管道- <code>build</code>和<code>deploy</code>。确保部署按预期工作:</p>


<p>--</p>
<p>就是这样！你可以在django-git lab-digital oceanrepo中找到最终代码。</p>
  </div>

  </div>    
</body>
</html>