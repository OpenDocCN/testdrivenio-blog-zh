<html>
<head>
<title>Developing an Asynchronous Task Queue in Python </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Python开发异步任务队列</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/developing-an-asynchronous-task-queue-in-python/#0001-01-01">https://testdriven.io/blog/developing-an-asynchronous-task-queue-in-python/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本教程着眼于如何使用Python的<a href="https://docs.python.org/3.10/library/multiprocessing.html">多重处理</a>库和<a href="https://redis.io/"> Redis </a>实现几个异步任务队列。</p>



<h2 id="queue-data-structures">队列数据结构</h2>
<p>一个<a href="https://en.wikipedia.org/wiki/Queue_(abstract_data_type)">队列</a>是一个<a href="https://en.wikipedia.org/wiki/FIFO_(computing_and_electronics)">先进先出</a> ( <strong> FIFO </strong>)的数据结构。</p>
<ol>
<li>在尾部添加一个项目(<strong>入队</strong>)</li>
<li>在头部移除一个项目(<strong>出列</strong>)</li>
</ol>
<p><img data-src="/static/images/blog/simple-task-queue/queue.png" loading="lazy" class="lazyload" alt="queue" src="../Images/15d8511183681e70585dd3c10512971d.png" data-original-src="https://testdriven.io/static/images/blog/simple-task-queue/queue.png"/></p>
<p>当您编写本教程中的示例时，您会在实践中看到这一点。</p>
<h2 id="task">工作</h2>
<p>让我们从创建一个基本任务开始:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># tasks.py</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>

<span class="n">COMMON_WORDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">))</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"output"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">random_str</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">random_str</span><span class="si">}</span><span class="s2">.txt"</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">outfile</span><span class="p">),</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_word_counts</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">wordcount</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
    <span class="c1"># get counts</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">wordcount</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">COMMON_WORDS</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">wordcount</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

    <span class="c1"># save file</span>
    <span class="n">save_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">wordcount</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">20</span><span class="p">))))</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Processed </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> with process id: </span><span class="si">{</span><span class="n">proc</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">get_word_counts</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<p>因此，<code>get_word_counts</code>从给定的文本文件中找到20个最常用的单词，并将它们保存到输出文件中。它还使用Python的<a href="https://docs.python.org/3/library/os.html"> os </a>库打印当前进程标识符(或pid)。</p>
<h3 id="following-along">跟着一起走？</h3>
<p>创建一个项目目录和一个虚拟环境。然后，使用pip安装<a href="https://pypi.org/project/nltk/"> NLTK </a>:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">nltk</span><span class="o">==</span><span class="m">3</span>.6.5
</code></pre></div>

<p>安装完成后，调用Python shell并下载<code>stopwords</code> <a href="https://www.nltk.org/data.html">文集</a>:</p>
<div class="codehilite"><pre><span/><code>&gt;&gt;&gt; import nltk
&gt;&gt;&gt; nltk.download<span class="o">(</span><span class="s2">"stopwords"</span><span class="o">)</span>

<span class="o">[</span>nltk_data<span class="o">]</span> Downloading package stopwords to
<span class="o">[</span>nltk_data<span class="o">]</span>     /Users/michael/nltk_data...
<span class="o">[</span>nltk_data<span class="o">]</span>   Unzipping corpora/stopwords.zip.
True
</code></pre></div>

<blockquote>
<p>如果您遇到SSL错误，请参考这篇文章。</p>
<p>示例修复:</p>
<div class="codehilite"><pre><span/>&gt;&gt;&gt; import nltk
&gt;&gt;&gt; nltk.download<span class="o">(</span><span class="s1">'stopwords'</span><span class="o">)</span>
<span class="o">[</span>nltk_data<span class="o">]</span> Error loading stopwords: &lt;urlopen error <span class="o">[</span>SSL:
<span class="o">[</span>nltk_data<span class="o">]</span>     CERTIFICATE_VERIFY_FAILED<span class="o">]</span> certificate verify failed:
<span class="o">[</span>nltk_data<span class="o">]</span>     unable to get <span class="nb">local</span> issuer certificate <span class="o">(</span>_ssl.c:1056<span class="o">)</span>&gt;
False
&gt;&gt;&gt; import ssl
&gt;&gt;&gt; try:
...     <span class="nv">_create_unverified_https_context</span> <span class="o">=</span> ssl._create_unverified_context
... except AttributeError:
...     pass
... <span class="k">else</span>:
...     ssl._create_default_https_context <span class="o">=</span> _create_unverified_https_context
...
&gt;&gt;&gt; nltk.download<span class="o">(</span><span class="s1">'stopwords'</span><span class="o">)</span>
<span class="o">[</span>nltk_data<span class="o">]</span> Downloading package stopwords to
<span class="o">[</span>nltk_data<span class="o">]</span>     /Users/michael.herman/nltk_data...
<span class="o">[</span>nltk_data<span class="o">]</span>   Unzipping corpora/stopwords.zip.
True
</pre></div></blockquote>

<p>将上面的<em> tasks.py </em>文件添加到您的项目目录中，但是不要运行它。</p>
<h2 id="multiprocessing-pool">多重处理池</h2>
<p>我们可以使用<a href="https://docs.python.org/3/library/multiprocessing.html">多处理</a>库并行运行这个任务:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># simple_pool.py</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span>
            <span class="n">get_word_counts</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">"pride-and-prejudice.txt"</span><span class="p">,</span>
                <span class="s2">"heart-of-darkness.txt"</span><span class="p">,</span>
                <span class="s2">"frankenstein.txt"</span><span class="p">,</span>
                <span class="s2">"dracula.txt"</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># clean up</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time taken = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.10f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>这里，使用<a href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool">池</a>类，我们用两个进程处理了四个任务。</p>
<p>你注意到<code>map_async</code>方法了吗？将任务映射到流程基本上有四种不同的方法。当选择一个时，您必须考虑多参数、并发性、阻塞和排序:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>多参数</th>
<th>并发</th>
<th>阻塞</th>
<th>有序结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>map</code></td>
<td>不</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td><code>map_async</code></td>
<td>不</td>
<td>不</td>
<td>不</td>
<td>是</td>
</tr>
<tr>
<td><code>apply</code></td>
<td>是</td>
<td>不</td>
<td>是</td>
<td>不</td>
</tr>
<tr>
<td><code>apply_async</code></td>
<td>是</td>
<td>是</td>
<td>不</td>
<td>不</td>
</tr>
</tbody>
</table>
<p>没有<code>close</code>和<code>join</code>，垃圾收集可能不会发生，这可能导致内存泄漏。</p>
<ol>
<li><code>close</code>告知池不接受任何新任务</li>
<li><code>join</code>告知池在所有任务完成后退出</li>
</ol>
<blockquote>
<p>跟着一起走？从<a href="https://github.com/testdrivenio/simple-task-queue">简单任务队列</a> repo中的“数据”目录中抓取<a href="http://www.gutenberg.org/">项目古腾堡</a>样本文本文件，然后添加一个“输出”目录。</p>
<p>您的项目目录应该如下所示:</p>
<div class="codehilite"><pre><span/>├── data
│   ├── dracula.txt
│   ├── frankenstein.txt
│   ├── heart-of-darkness.txt
│   └── pride-and-prejudice.txt
├── output
├── simple_pool.py
└── tasks.py
</pre></div></blockquote>

<p>运行时间应该不到一秒钟:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python simple_pool.py

Running with <span class="m">15</span> processes!
Processed heart-of-darkness.txt with process id: <span class="m">50510</span>
Processed frankenstein.txt with process id: <span class="m">50515</span>
Processed pride-and-prejudice.txt with process id: <span class="m">50511</span>
Processed dracula.txt with process id: <span class="m">50512</span>

Time <span class="nv">taken</span> <span class="o">=</span> <span class="m">0</span>.6383581161
</code></pre></div>

<blockquote>
<p>这个脚本运行在16核的i9 Macbook Pro上。</p>
</blockquote>
<p>因此，多重处理<code>Pool</code>类为我们处理排队逻辑。它非常适合运行CPU密集型任务或任何可以独立分解和分配的任务。如果您需要对队列进行更多的控制，或者需要在多个进程之间共享数据，您可能想看看<code>Queue</code>类。</p>
<blockquote>
<p>关于这一点以及并行性(多处理)和并发性(多线程)之间的区别的更多信息，请回顾文章<a href="/blog/concurrency-parallelism-asyncio/">用并发性、并行性和异步性加速Python。</a></p>
</blockquote>
<h2 id="multiprocessing-queue">多重处理队列</h2>
<p>让我们看一个简单的例子:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># simple_queue.py</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">books</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"pride-and-prejudice.txt"</span><span class="p">,</span>
        <span class="s2">"heart-of-darkness.txt"</span><span class="p">,</span>
        <span class="s2">"frankenstein.txt"</span><span class="p">,</span>
        <span class="s2">"dracula.txt"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Enqueuing..."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Dequeuing..."</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>同样来自多处理库的<a href="https://docs.python.org/3/library/multiprocessing.html#exchanging-objects-between-processes">队列</a>类是一个基本的FIFO(先进先出)数据结构。它类似于<a href="https://docs.python.org/3/library/queue.html#queue.Queue">队列。Queue </a>类，但是是为进程间通信设计的。我们使用<code>put</code>将一个项目加入队列，使用<code>get</code>将一个项目出队。</p>
<blockquote>
<p>查看<code>Queue</code> <a href="https://github.com/python/cpython/blob/master/Lib/multiprocessing/queues.py">源代码</a>可以更好地理解这个类的机制。</p>
</blockquote>
<p>现在，让我们看看更高级的例子:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># simple_task_queue.py</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">process_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">get_word_counts</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">add_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">number_of_tasks</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tasks</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"pride-and-prejudice.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"heart-of-darkness.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"frankenstein.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"dracula.txt"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_queue</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">empty_task_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">full_task_queue</span> <span class="o">=</span> <span class="n">add_tasks</span><span class="p">(</span><span class="n">empty_task_queue</span><span class="p">,</span> <span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_tasks</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">full_task_queue</span><span class="p">,))</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time taken = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.10f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>这里，我们将40个任务(每个文本文件10个)放入队列，通过<code>Process</code>类创建单独的进程，使用<code>start</code>开始运行进程，最后，使用<code>join</code>完成进程。</p>
<p>运行时间应该不到一秒钟。</p>
<blockquote>
<p><strong>挑战</strong>:通过添加另一个队列来保存已完成的任务，检查您的理解。您可以在<code>process_tasks</code>函数中对它们进行排队。</p>
</blockquote>
<h2 id="logging">记录</h2>
<p>多处理库也支持日志记录:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># simple_task_queue_logging.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">process_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">get_word_counts</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Process </span><span class="si">{</span><span class="n">proc</span><span class="si">}</span><span class="s2"> completed successfully"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">add_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">number_of_tasks</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tasks</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"pride-and-prejudice.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"heart-of-darkness.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"frankenstein.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"dracula.txt"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_queue</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">empty_task_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">full_task_queue</span> <span class="o">=</span> <span class="n">add_tasks</span><span class="p">(</span><span class="n">empty_task_queue</span><span class="p">,</span> <span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_tasks</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">full_task_queue</span><span class="p">,))</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time taken = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.10f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">log_to_stderr</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>要进行测试，请将<code>task_queue.put("dracula.txt")</code>更改为<code>task_queue.put("drakula.txt")</code>。您应该会在终端中看到以下错误输出十次:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>ERROR/Process-4<span class="o">]</span> <span class="o">[</span>Errno <span class="m">2</span><span class="o">]</span> No such file or directory:
<span class="s1">'simple-task-queue/data/drakula.txt'</span>
</code></pre></div>

<p>想要记录到光盘吗？</p>
<div class="codehilite"><pre><span/><code><span class="c1"># simple_task_queue_logging.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">create_logger</span><span class="p">():</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s2">"process.log"</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">"</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>


<span class="k">def</span> <span class="nf">process_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">()</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">get_word_counts</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Process </span><span class="si">{</span><span class="n">proc</span><span class="si">}</span><span class="s2"> completed successfully"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">add_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">number_of_tasks</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tasks</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"pride-and-prejudice.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"heart-of-darkness.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"frankenstein.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"dracula.txt"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_queue</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">empty_task_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">full_task_queue</span> <span class="o">=</span> <span class="n">add_tasks</span><span class="p">(</span><span class="n">empty_task_queue</span><span class="p">,</span> <span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_tasks</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">full_task_queue</span><span class="p">,))</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time taken = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.10f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p>同样，通过更改其中一个文件名来导致错误，然后运行它。看一下<em> process.log </em>。因为Python日志库不使用进程间的共享锁，所以它并不像它应该的那样有组织。为了解决这个问题，我们让每个进程写入自己的文件。为了保持有序，请在项目文件夹中添加一个日志目录:</p>
<div class="codehilite"><pre><span/><code><span class="c1">#  simple_task_queue_logging_separate_files.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">create_logger</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="sa">f</span><span class="s2">"logs/process_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">.log"</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">"</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>


<span class="k">def</span> <span class="nf">process_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">get_word_counts</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Process </span><span class="si">{</span><span class="n">proc</span><span class="si">}</span><span class="s2"> completed successfully"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">add_tasks</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">number_of_tasks</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tasks</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"pride-and-prejudice.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"heart-of-darkness.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"frankenstein.txt"</span><span class="p">)</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"dracula.txt"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task_queue</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">empty_task_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">full_task_queue</span> <span class="o">=</span> <span class="n">add_tasks</span><span class="p">(</span><span class="n">empty_task_queue</span><span class="p">,</span> <span class="n">NUMBER_OF_TASKS</span><span class="p">)</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_tasks</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">full_task_queue</span><span class="p">,))</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time taken = </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.10f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<h2 id="redis">雷迪斯</h2>
<p>接下来，我们不使用内存队列，而是将<a href="https://redis.io/"> Redis </a>添加到混合队列中。</p>
<blockquote>
<p>跟着一起走？ <a href="https://redis.io/download">下载</a>并安装Redis，如果你还没有安装的话。然后，安装Python <a href="https://pypi.org/project/redis/">接口</a>:</p>
<div class="codehilite"><pre><span/>(env)$ pip install <span class="nv">redis</span><span class="o">==</span><span class="m">4</span>.0.2
</pre></div></blockquote>

<p>我们将把逻辑分成四个文件:</p>
<ol>
<li><em> redis_queue.py </em>分别通过<code>SimpleQueue</code>和<code>SimpleTask</code>类创建新的队列和任务。</li>
<li><em> redis_queue_client </em>调查新任务。</li>
<li><em> redis_queue_worker </em>出队并处理任务。</li>
<li><em> redis_queue_server </em>产生工作进程。</li>
</ol>
<div class="codehilite"><pre><span/><code><span class="c1"># redis_queue.py</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">uuid</span>


<span class="k">class</span> <span class="nc">SimpleQueue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">SimpleTask</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">serialized_task</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">serialized_task</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">serialized_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">brpop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">serialized_task</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">process_task</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">task</span>

    <span class="k">def</span> <span class="nf">get_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">llen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SimpleTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">process_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们定义了两个类，<code>SimpleQueue</code>和<code>SimpleTask</code>:</p>
<ol>
<li>创建一个新队列，入队，出队，并获取队列的长度。</li>
<li><code>SimpleTask</code>创建新任务，由<code>SimpleQueue</code>类的实例用来将新任务排队，并处理新任务。</li>
</ol>
<blockquote>
<p>好奇<code>lpush()</code>、<code>brpop()</code>、<code>llen()</code>？参见<a href="https://redis.io/commands">命令参考</a>页。(<code>The brpop()</code>函数特别酷，因为它阻塞连接，直到有值存在才弹出！)</p>
</blockquote>
<div class="codehilite"><pre><span/><code><span class="c1"># redis_queue_client.py</span>

<span class="kn">import</span> <span class="nn">redis</span>

<span class="kn">from</span> <span class="nn">redis_queue</span> <span class="kn">import</span> <span class="n">SimpleQueue</span>
<span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">get_word_counts</span>

<span class="n">NUMBER_OF_TASKS</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">"sample"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_TASKS</span><span class="p">):</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">get_word_counts</span><span class="p">,</span> <span class="s2">"pride-and-prejudice.txt"</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">get_word_counts</span><span class="p">,</span> <span class="s2">"heart-of-darkness.txt"</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">get_word_counts</span><span class="p">,</span> <span class="s2">"frankenstein.txt"</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">get_word_counts</span><span class="p">,</span> <span class="s2">"dracula.txt"</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">4</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Enqueued </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> tasks!"</span><span class="p">)</span>
</code></pre></div>

<p>这个模块将创建一个Redis和<code>SimpleQueue</code>类的新实例。然后，它将40个任务排队。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># redis_queue_worker.py</span>

<span class="kn">import</span> <span class="nn">redis</span>

<span class="kn">from</span> <span class="nn">redis_queue</span> <span class="kn">import</span> <span class="n">SimpleQueue</span>


<span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">"sample"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">queue</span><span class="o">.</span><span class="n">get_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"No tasks in the queue"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">worker</span><span class="p">()</span>
</code></pre></div>

<p>如果任务可用，则调用<code>dequeue</code>方法，然后反序列化任务并调用<code>process_task</code>方法(在<em> redis_queue.py </em>中)。</p>
<div class="codehilite"><pre><span/><code><span class="c1"># redis_queue_server.py</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">from</span> <span class="nn">redis_queue_worker</span> <span class="kn">import</span> <span class="n">worker</span>

<span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with </span><span class="si">{</span><span class="n">PROCESSES</span><span class="si">}</span><span class="s2"> processes!"</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">)</span>
            <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div>

<p><code>run</code>方法产生了四个新的工作进程。</p>
<blockquote>
<p>您可能不希望四个进程一直同时运行，但有时您可能需要四个或更多的进程。考虑如何根据需求有计划地增加和减少额外的工作人员。</p>
</blockquote>
<p>要进行测试，请在单独的终端窗口中运行<em> redis_queue_server.py </em>和<em> redis_queue_client.py </em>:</p>
<p><a href="/static/images/blog/simple-task-queue/example.png"><img data-src="/static/images/blog/simple-task-queue/example.png" loading="lazy" class="lazyload" alt="example" src="../Images/c733205df2bc2aae453ce2f51da6aff2.png" data-original-src="https://testdriven.io/static/images/blog/simple-task-queue/example.png"/>T2】</a></p>
<p><a href="/static/images/gifs/blog/simple-task-queue/example.gif"><img data-src="/static/images/gifs/blog/simple-task-queue/example.gif" loading="lazy" class="lazyload" alt="example" src="../Images/bcc9dcbd96c896fa3de41d090f10fc65.png" data-original-src="https://testdriven.io/static/images/gifs/blog/simple-task-queue/example.gif"/>T2】</a></p>
<blockquote>
<p>通过将日志添加到上面的应用程序中，再次检查您的理解。</p>
</blockquote>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们研究了Python中的许多异步任务队列实现。如果需求足够简单，以这种方式开发队列可能会更容易。也就是说，如果您正在寻找更高级的功能——如任务调度、批处理、作业优先级和失败任务的重试——您应该寻找一个成熟的解决方案。看看<a href="https://docs.celeryq.dev/en/stable/">芹菜</a>，<a href="http://python-rq.org/"> RQ </a>，或者<a href="http://huey.readthedocs.io/"> Huey </a>。</p>
<p>从<a href="https://github.com/testdrivenio/simple-task-queue">简单任务队列</a> repo中获取最终代码。</p>
  </div>

  </div>    
</body>
</html>