<html>
<head>
<title>Production Django Deployments on Heroku </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Heroku部署Django生产</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/production-django-deployments-on-heroku/#0001-01-01">https://testdriven.io/blog/production-django-deployments-on-heroku/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>我们使用Heroku来托管<a href="https://testdriven.io/"> TestDriven.io </a>学习平台，以便我们可以专注于应用程序开发，而不是配置web服务器、安装Linux包、设置负载平衡器以及传统服务器上基础架构管理的所有其他工作。</p>
<p>本文旨在简化在Heroku上部署、维护和扩展生产级Django应用程序的过程。</p>
<p>我们还将回顾一些简化部署过程的技巧和诀窍。最后，您会发现一份用于将新应用部署到生产环境的生产清单。</p>



<h2 id="heroku">Heroku</h2>
<p>为什么是Heroku？像姜戈一样，Heroku信奉“包含电池”的哲学。这是一个固执己见的环境，但也是一个您不必管理的环境——因此您可以专注于应用程序开发，而不是支持它的环境。</p>
<p>如果你使用自己的基础设施或基础设施即服务(IaaS)解决方案，例如<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean Droplets </a>、<a href="https://aws.amazon.com/ec2/">亚马逊EC2 </a>、<a href="https://cloud.google.com/compute/">谷歌计算引擎</a>，你必须雇用一名系统管理/开发运维工程师或自己承担这一角色。前者要花钱，而后者会降低你的速度。Heroku的托管成本可能会高于IaaS解决方案，但您将节省资金，因为您不需要雇用人员来管理基础架构，并且您可以更快地运行应用程序，这是最终最重要的。</p>
<p>小贴士:</p>
<ol>
<li>确保你使用的Heroku是最新的Heroku栈。</li>
<li>使用<a href="https://uwsgi-docs.readthedocs.io"> uWSGI </a>或<a href="https://gunicorn.org/"> Gunicorn </a>作为你的<a href="https://docs.djangoproject.com/en/3.1/howto/deployment/wsgi/">生产WSGI服务器</a>。哪一个都可以。如果您不知道为什么您更喜欢一个WSGI服务器而不是另一个，这并不重要。以后再切换也不难。</li>
<li>使用<a href="https://docs.celeryq.dev/en/stable/"> Celery </a>或<a href="http://python-rq.org/"> RQ </a>以及<a href="https://elements.heroku.com/addons/heroku-redis"> Heroku Redis </a>插件，在web应用程序之外异步运行长时间运行或CPU密集型流程，如电子邮件交付或PDF报告生成。作为参考，我们使用<a href="https://github.com/rq/django-rq"> Django-RQ </a>。</li>
<li>运行至少两个web和后台进程以实现<a href="https://devcenter.heroku.com/articles/production-check#dyno-redundancy">冗余</a>。</li>
<li>使用<a href="https://https.cio.gov/everything/"> SSL </a>。</li>
<li>遵循<a href="https://12factor.net/">十二因素App </a>方法。</li>
<li>添加<a href="/blog/django-caching/">缓存</a>。</li>
</ol>
<h2 id="database">数据库ˌ资料库</h2>
<p>小贴士:</p>
<ol>
<li>使用Heroku <a href="https://devcenter.heroku.com/articles/heroku-postgres-plans#standard-tier">标准</a>(或更高)层<a href="https://elements.heroku.com/addons/heroku-postgresql"> Postgres </a>数据库。回顾每层的磁盘空间、内存和并发连接限制，以及Django 文章中的<a href="https://devcenter.heroku.com/articles/python-concurrency-and-database-connections">并发和数据库连接。</a></li>
<li>通过<a href="https://devcenter.heroku.com/articles/heroku-postgres-backups#scheduling-backups"> Heroku PGBackups </a>安排生产数据库的每日备份。</li>
<li>通过不时压缩或重置迁移，保持迁移的整洁和可管理性。</li>
</ol>
<h2 id="continuous-integration-and-delivery">持续集成和交付</h2>
<p>Heroku运行时是无状态和不可变的，这有助于实现连续交付。在每次应用程序部署时，都会构建、配置一个新的虚拟机，并将其投入生产。</p>
<p>正因为如此，你无需担心:</p>
<ol>
<li>当Heroku通过一个<a href="https://devcenter.heroku.com/articles/dynos#the-dyno-manager"> Dyno管理器</a>为你处理时，使用一个进程管理器来支持你的服务。</li>
<li>配置用于更新和重新启动应用程序的部署机制。</li>
</ol>
<p>Heroku与许多持续集成(CI)服务合作，如<a href="https://circleci.com/"> Circle </a>和<a href="https://travis-ci.org/"> Travis </a>，他们也提供自己的CI解决方案- <a href="https://www.heroku.com/continuous-integration"> Heroku CI </a>。</p>
<p>小贴士:</p>
<ol>
<li>设置自动部署。由于人为错误，手动部署容易出错。</li>
<li>在您的生产CI构建中运行<a href="https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/"> Django部署清单</a> ( <code>manage.py check --deploy</code>)。</li>
<li>在<a href="https://testdriven.io/"> TestDriven.io </a>中，我们使用了一种形式的<a href="https://www.weave.works/blog/what-is-gitops-really"> GitOps </a>，其中应用程序的状态始终保存在git中，对试运行和生产环境的更改仅发生在CI中。考虑使用这种方法来帮助加速开发并引入稳定的回滚系统。</li>
<li>定期部署，在开发人员有空的预定时间部署，以防出现问题。</li>
<li>使用release标签，这样你就能确切地知道哪个版本的代码正在生产中运行——也就是<code>git tag -a "$ENVIRONMENT/${VERSION}"</code>。</li>
</ol>

<p>小贴士:</p>
<ol>
<li>对静态文件使用<a href="http://whitenoise.evans.io">whiten noise</a>然后在它前面扔一个CDN，像<a href="https://cloudflare.com/"> Cloudflare </a>或者<a href="https://aws.amazon.com/cloudfront/"> CloudFront </a>。</li>
<li>对于用户上传的媒体文件，使用<a href="/blog/storing-django-static-and-media-files-on-amazon-s3/"> S3和django-storages </a>。</li>
</ol>
<h2 id="environments">环境</h2>
<p>小贴士:</p>
<ol>
<li>对于暂存，使用不同的Heroku应用程序。确保在不使用时打开<a href="https://devcenter.heroku.com/articles/maintenance-mode">维护模式</a>,这样谷歌爬虫就不会无意中发现它。</li>
</ol>
<h2 id="testing">测试</h2>
<p>编写测试。测试是一种保护措施，因此您不会意外地更改应用程序的功能。从您的测试套件中本地捕获bug比在生产环境中由客户捕获要好得多。</p>
<p>小贴士:</p>
<ol>
<li>忽略传统的测试金字塔。花一半的时间写Django单元测试(同时用<a href="https://docs.pytest.org"> pytest </a>和<a href="https://hypothesis.works">假设</a>)。另一半时间用<a href="https://www.cypress.io/"> Cypress </a>编写基于浏览器的集成和端到端测试。与Selenium相比，Cypress测试更容易编写和维护。我们建议将Cypress整合到您的日常TDD工作流程中。查看<a href="https://testdriven.io/blog/modern-frontend-testing-with-cypress/">现代前端测试和Cypress </a>了解更多信息。</li>
</ol>
<h2 id="monitoring-and-logging">监控和记录</h2>
<p>监控和日志记录是应用可靠性的重要组成部分，使其更容易:</p>
<ol>
<li>在早期阶段发现错误。</li>
<li>了解你的应用是如何工作的。</li>
<li>分析性能。</li>
<li>确定您的应用程序是否正常运行。</li>
</ol>
<p>您的日志应该总是有时间戳和日志级别。它们也应该是人类可读且易于解析的。</p>
<p>在监控方面，设置警报来帮助减少和抢先停机。设置通知，以便您可以在客户开始抱怨之前解决问题和瓶颈。</p>
<p>如你所见，Heroku通过<a href="https://elements.heroku.com/addons">附加</a>系统提供了许多服务。这个系统是你从Heroku获得的强大工具之一。您可以随意使用数百个服务，只需几分钟即可完成配置，其中许多服务对于日志记录、监控和错误跟踪非常有用。</p>
<p>小贴士:</p>
<ol>
<li>Heroku只保留最近的1500行合并日志，这只是几秒钟的日志。因此，您需要将日志发送到一个远程日志服务，比如<a href="https://elements.heroku.com/addons/logentries"> Logentries </a>，以聚合您的所有日志。</li>
<li>使用<a href="https://elements.heroku.com/addons/scout"> Scout </a>进行应用程序性能监控，以便跟踪性能问题。</li>
<li>使用<a href="https://elements.heroku.com/addons/sentry"> Sentry </a>进行异常监控，以便在应用程序出现错误时获得通知。</li>
<li>您可以直接从Heroku的<a href="https://devcenter.heroku.com/articles/metrics">应用程序指标</a>仪表板监控内存使用和CPU负载等基本情况。</li>
<li>使用<a href="https://uptimerobot.com/"> Uptime Robot </a>，它没有Heroku附加组件，以确保您的网站正常运行。</li>
</ol>
<h2 id="security">安全性</h2>
<p>说到安全，人一般是最薄弱的环节。您的开发团队应该知道一些更常见的安全漏洞。<a href="https://sudo.pagerduty.com/for_engineers/">工程师安全培训</a>和Heroku的<a href="https://devcenter.heroku.com/categories/security">安全</a>指南以及以下<a href="https://www.owasp.org"> OWASP </a>备忘单都是很好的起点:</p>
<ol>
<li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md">跨站点请求伪造(CSRF)防范</a></li>
<li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.md"> XSS(跨站脚本)防范</a></li>
<li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.md">基于DOM的XSS预防</a></li>
<li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Content_Security_Policy_Cheat_Sheet.md">内容安全策略</a></li>
</ol>
<p>小贴士:</p>
<ol>
<li>使用<a href="https://elements.heroku.com/addons/snyk"> Snyk </a>保持您的依赖关系最新。</li>
<li>引入节流机制，如<a href="https://django-ratelimit.readthedocs.io"> Django Ratelimit </a>，以限制DDoS攻击的影响。</li>
<li>将应用程序的配置与代码分开，以防止敏感凭据被签入源代码管理。</li>
<li>监控和记录可疑行为，例如来自特定来源的多次失败登录尝试和异常流量峰值。查看用于实时安全监控的<a href="https://elements.heroku.com/addons/expeditedwaf">加急WAF </a>附件。</li>
<li>使用<a href="https://bandit.readthedocs.io"> Bandit </a>检查您的Python代码中的常见安全问题。</li>
<li>部署完成后，在<a href="https://www.ponycheckup.com/">Pony check</a>通过自动安全检查运行您的站点。</li>
<li><a href="https://www.djangosnippets.org/snippets/1303/">验证上传文件内容类型和大小</a>。</li>
</ol>
<h2 id="conclusion">结论</h2>
<p>希望本文提供了一些有用的信息，有助于简化在Heroku上部署和维护Django生产应用程序的过程。</p>
<p>记住:Web开发是复杂的，因为所有的移动部分都是复杂的。您可以通过以下方式应对这一问题:</p>
<ol>
<li>把问题分解成小的、容易理解的子问题。理想情况下，您可以将这些子问题转化为已经解决的问题。</li>
<li>通过使用Django和Heroku来完全去除碎片——这两者都使得开发和部署安全、可伸缩和可维护的web应用程序变得更加容易，因为它们包含了稳定性和“包含电池”的理念。</li>
</ol>
<p>好奇Heroku的完整架构是什么样子？</p>
<p><img data-src="/static/images/blog/django/django-heroku/django_with_heroku.png" loading="lazy" class="lazyload" alt="django architecture" src="../Images/e6937aca37f6a0696ce995372ceb920a.png" data-original-src="https://testdriven.io/static/images/blog/django/django-heroku/django_with_heroku.png"/></p>
<p>一旦配置好Celery和Gunicorn，您就可以将大部分时间(如果不是全部的话)集中在开发应用程序上——其他一切都是附加的。</p>
<p>推荐资源:</p>
<ol>
<li><a href="https://zachholman.com/posts/deploying-software">如何部署软件</a></li>
<li><a href="https://web.archive.org/web/20201112025258/https://omniti.com/seeds/thoughts-on-web-application-deployment.html">关于Web应用部署的思考</a></li>
</ol>
<h2 id="production-checklist">生产清单</h2>
<p>向Heroku部署新的Django应用程序？查看以下清单以获取帮助。确保在整个过程中记录部署工作流。</p>
<h3 id="before-deployment">部署前</h3>
<p><strong>前端</strong>:</p>
<ol>
<li>拼写检查Django模板。</li>
<li>设置收藏夹图标。</li>
<li><a href="https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/#customize-the-default-error-views">自定义</a>默认错误视图。</li>
<li>添加一个<a href="https://www.cloudflare.com/learning/bots/what-is-robots.txt/"> robots.txt </a>文件。</li>
<li><a href="https://docs.djangoproject.com/en/3.1/ref/contrib/sitemaps/">创建</a>一个sitemap.xml文件。</li>
<li><a href="https://images.guide/">压缩优化</a>所有图像。</li>
<li>设置<a href="https://analytics.google.com/analytics/web">谷歌分析</a>。</li>
<li>配置SSL。</li>
<li>为前端资产配置CDN提供商，如<a href="https://www.cloudflare.com/"> Cloudflare </a>。</li>
</ol>
<p>姜戈:</p>
<ol>
<li>匿名化生产Django管理URL。</li>
<li>可选地添加<a href="https://github.com/adamchainz/django-cors-headers"> django-cors-headers </a>应用程序，将跨源资源共享(cors)头添加到响应中。</li>
<li>考虑使用<a href="https://docs.djangoproject.com/en/3.1/topics/db/transactions/#tying-transactions-to-http-requests"> ATOMIC_REQUESTS </a>。</li>
<li>为生产配置以下<a href="https://docs.djangoproject.com/en/3.1/topics/settings/"> Django设置</a>:</li>
</ol>
<p><strong>持续集成</strong>:</p>
<ol>
<li>设置CI服务。</li>
<li>根据生产设置运行<code>python manage.py check --deploy</code>。</li>
<li>配置要运行的任何其他linters和/或代码分析工具。</li>
<li>测试CI流程。</li>
<li>配置自动部署。</li>
</ol>
<p>英雄:</p>
<ol>
<li>确保使用最新的<a href="https://devcenter.heroku.com/articles/stack"> Heroku栈</a>和Python版本。</li>
<li>配置<a href="https://elements.heroku.com/addons/heroku-postgresql"> Postgres </a>和<a href="https://elements.heroku.com/addons/heroku-redis"> Redis </a>附加组件。</li>
<li>设置数据库<a href="https://devcenter.heroku.com/articles/heroku-postgres-backups">备份</a>。</li>
<li>配置剩余的Heroku插件——即<a href="https://elements.heroku.com/addons/logentries">日志条目</a>、<a href="https://elements.heroku.com/addons/scout">侦察兵</a>、<a href="https://elements.heroku.com/addons/sentry">哨兵</a>和<a href="https://elements.heroku.com/addons/sendgrid">发送网格</a>。</li>
<li>设置环境变量。</li>
<li>为冗余设置至少两个web和工作进程。</li>
</ol>
<h3 id="after-deployment">部署后</h3>
<p><strong>前端</strong>:</p>
<ol>
<li>运行<a href="https://observatory.mozilla.org/"> Mozilla Observatory </a>、<a href="https://developers.google.com/speed/pagespeed/"> Google PageSpeed </a>、<a href="https://search.google.com/test/mobile-friendly"> Google Mobile-Friendly </a>、<a href="https://webhint.io/"> webhint </a>和<a href="https://securityheaders.com/"> Netsparker安全标题</a>扫描。</li>
<li>使用<a href="http://wave.webaim.org/"> WAVE工具</a>来测试你的页面是否符合可访问性标准。</li>
<li>查看<a href="https://github.com/thedaviddias/Front-End-Checklist">前端清单</a>。</li>
<li>运行一个<a href="https://www.ssllabs.com/ssltest/index.html"> SSL服务器测试</a>。</li>
<li>运行自动化测试(如果有的话),或者从浏览器手动测试你的应用。</li>
<li>验证301重定向配置是否正确。</li>
<li>设置<a href="https://tagmanager.google.com/">谷歌标签管理器</a>。</li>
<li>配置<a href="https://uptimerobot.com/">正常运行时间机器人</a>。</li>
</ol>
<p>干杯！</p>
<p><br/></p>
  </div>

  </div>    
</body>
</html>