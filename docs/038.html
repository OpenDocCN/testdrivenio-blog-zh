<html>
<head>
<title>Continuously Deploying Django to Linode with Docker and GitHub Actions </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>通过Docker和GitHub操作不断将Django部署到Linode</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/deploying-django-to-linode-with-docker-and-github-actions/#0001-01-01">https://testdriven.io/blog/deploying-django-to-linode-with-docker-and-github-actions/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将了解如何配置<a href="https://github.com/features/actions"> GitHub动作</a>来持续地将<a href="https://www.djangoproject.com/"> Django </a>和<a href="https://www.docker.com/"> Docker </a>应用程序部署到<a href="https://www.linode.com/"> Linode </a>。</p>



<h2 id="objectives">目标</h2>
<p>学完本教程后，您应该能够:</p>
<ol>
<li>将Django应用程序部署到Linode</li>
<li>使用GitHub包来存储Docker图像</li>
<li>建立一个Linode CPU实例和一个Linode管理的数据库</li>
<li>启用无密码SSH验证</li>
<li>使用GitHub操作持续部署您的应用程序</li>
</ol>
<h2 id="project-setup">项目设置</h2>
<p>首先克隆<a href="https://github.com/testdrivenio/django-github-linode"> GitHub repo </a>并将当前目录更改为其根目录:</p>
<div class="codehilite"><pre><span/><code>$ git clone <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3d5a54497d5a544955485f135e5250">[email protected]</a>:testdrivenio/django-github-linode.git --branch base --single-branch
$ <span class="nb">cd</span> django-github-linode
</code></pre></div>

<blockquote>
<p>好奇这个项目是怎么开发出来的？查看Postgres、Gunicorn和Nginx的博客文章。</p>
</blockquote>
<p>要进行本地测试，构建映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<blockquote>
<p>如果你的容器以<code>exec /usr/src/app/entrypoint.sh: no such file or directory</code>退出，打开<em> app/entrypoint.sh </em>脚本，执行从<code>CR LF</code>到<code>LF</code>的EOL转换。之后再运行<code>docker-compose up -d --build</code>。</p>
</blockquote>
<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>。您应该看到:</p>


<h2 id="github-packages">GitHub包</h2>
<p><a href="https://github.com/features/packages"> GitHub Packages </a>是一个托管和管理包的平台，包括容器和其他依赖项。它允许你在源代码旁边的GitHub上托管你的软件包。我们将使用它来存储Docker图像。</p>
<p>要使用GitHub包，首先必须创建一个个人访问令牌。导航至<a href="https://github.com/settings/apps">开发者设置</a>并选择“个人访问令牌”。点击“生成新令牌”。</p>
<p>给它一个名称/注释-例如，“GitHub actions”-并添加以下权限:</p>
<ul>
<li><code>write:packages</code></li>
<li><code>read:packages</code></li>
<li><code>delete:packages</code></li>
</ul>
<p>接下来，单击“生成令牌”按钮。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/personal-access-token.png" loading="lazy" class="lazyload" alt="GitHub Personal Access Token" src="../Images/fd18e5f2856be39580053f0011699577.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/personal-access-token.png"/></p>
<p>您将只能看到令牌一次，因此请将其存放在安全的地方。</p>
<p>构建并标记容器:</p>
<div class="codehilite"><pre><span/><code>$ docker build -f app/Dockerfile -t ghcr.io/&lt;USERNAME&gt;/&lt;REPOSITORY_NAME&gt;/web:latest ./app

<span class="c1"># Example</span>
$ docker build -f app/Dockerfile -t ghcr.io/testdrivenio/django-github-linode/web:latest ./app
</code></pre></div>

<p>接下来，使用您的个人访问令牌登录GitHub包:</p>
<div class="codehilite"><pre><span/><code>$ docker login ghcr.io -u &lt;USERNAME&gt; -p &lt;TOKEN&gt;

<span class="c1"># Example</span>
$ docker login ghcr.io -u testdrivenio -p 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
</code></pre></div>

<p>最后，将图像推送到GitHub包的<a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry">容器注册表</a>中。</p>
<div class="codehilite"><pre><span/><code>$ docker push ghcr.io/&lt;USERNAME&gt;/&lt;REPOSITORY_NAME&gt;/web:latest

<span class="c1"># Example</span>
$ docker push ghcr.io/testdrivenio/django-github-linode/web:latest
</code></pre></div>

<p>现在，您应该可以在以下网址之一看到该包(取决于您使用的是个人帐户还是组织):</p>
<div class="codehilite"><pre><span/><code># Personal account
https://github.com/&lt;USERNAME&gt;?tab=packages

# Organization
https://github.com/orgs/&lt;ORGANIZATION_NAME&gt;/packages
</code></pre></div>

<p><img data-src="/static/images/blog/django/django-github-linode/linode7.png" loading="lazy" class="lazyload" alt="Linode Create Database Cluster" src="../Images/055ffe85058e8f6a8ee432f940f634cb.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode7.png"/></p>
<h2 id="linode-cpu">Linode CPU</h2>
<blockquote>
<p>如果您还没有Linode帐户，<a href="https://www.linode.com/">导航到他们的网站</a>并点击“注册”。</p>
</blockquote>
<p>首先，我们需要创建一个<a href="https://www.linode.com/products/dedicated-cpu/"> Linode CPU实例</a>。</p>
<p>登录<a href="https://cloud.linode.com/"> Linode仪表盘</a>并选择侧边栏上的“Linodes”。然后点击“创建Linode”。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode1.png" loading="lazy" class="lazyload" alt="Linode Create" src="../Images/fe05db07820fbdf50d2dc574a47ca224.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode1.png"/></p>
<p>要创建一个预装Docker的Linode，我们可以使用<a href="https://www.linode.com/marketplace/"> Linode Marketplace </a>。在导航栏中选择“市场”，在应用程序中选择“Docker”</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode2.png" loading="lazy" class="lazyload" alt="Linode Create Marketplace" src="../Images/387911074a4d3a0498a8b4a4011098cf.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode2.png"/></p>
<p>向下滚动到“选择图像”。对于图像，选择“LTS Ubuntu 20.04”。对于地区，请选择离您的客户最近的地区。然后根据你的项目需求选择一个“Linode计划”。</p>
<blockquote>
<p>如果您正在部署CPU密集型web应用程序，请选择专用CPU。如果您预算有限，并且正在部署一个简单的web应用程序，请放心使用共享CPU。有关更多信息，请查看<a href="https://www.linode.com/content/linode-dedicated-cpus-explained-dedicated-vs-shared-cpu-instances/">专用与共享CPU实例</a>。</p>
</blockquote>
<p><img data-src="/static/images/blog/django/django-github-linode/linode3.png" loading="lazy" class="lazyload" alt="Linode Marketplace Image" src="../Images/3302973c37c095fb41ad871ac402828f.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode3.png"/></p>
<p>让我们把我们的Linode命名为“django-docker”。将标签留空。然后选择一个强根密码。您应该记下来，但是没有必要记住它，因为我们很快就会启用无密码SSH。</p>
<p>出于身份验证的目的，我们将使用SSH密钥。要生成密钥，请运行:</p>


<p>将密钥保存到<em> /root/。ssh/id_rsa </em>并且不设置密码短语。这将分别生成一个公钥和私钥- <em> id_rsa </em>和<em> id_rsa.pub </em>。要设置无密码SSH登录，请将公钥复制到<em> authorized_keys </em>文件中，并设置适当的权限:</p>
<blockquote>
<p>如果您愿意，可以随意使用现有的SSH密钥。</p>
</blockquote>
<div class="codehilite"><pre><span/><code>$ cat ~/.ssh/id_rsa.pub
$ vi ~/.ssh/authorized_keys
$ chmod <span class="m">600</span> ~/.ssh/authorized_keys
$ chmod <span class="m">600</span> ~/.ssh/id_rsa
</code></pre></div>

<p>导航回到Linode仪表板，点击“添加SSH密钥”。给它一个标签并粘贴你的公钥。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode4.png" loading="lazy" class="lazyload" alt="Linode Create Security" src="../Images/7e0673cef486e32ea0596c2203305ea4.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode4.png"/></p>
<p>将其他内容留空，滚动到底部。点击“创建Linode”。</p>
<p>您将被重定向到您的Linode详细信息。Linode需要几分钟的时间进行配置。准备就绪后，其状态将变为“正在运行”。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode5.png" loading="lazy" class="lazyload" alt="Linode Details" src="../Images/0fed2e1986f79231af9064268674029c.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode5.png"/></p>
<p>获取Linode的IP，让我们测试一下是否一切正常。</p>
<p>要连接到新创建的Linode实例并检查Docker版本，请运行:</p>
<div class="codehilite"><pre><span/><code>$ ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="80f2efeff4c0">[email protected]</a>&lt;YOUR_INSTANCE_IP&gt; docker --version

Docker version <span class="m">20</span>.10.17, build 100c701
</code></pre></div>

<blockquote>
<p>实例运行后，Docker可能还需要几分钟才能完成安装。</p>
</blockquote>
<p>然后，为应用程序创建一个新目录:</p>


<p>很好，Linode CPU实例现在已经准备好了。在下一步中，我们将设置一个托管数据库。</p>
<h2 id="database">数据库ˌ资料库</h2>
<p>为了托管我们的数据库，我们将使用<a href="https://www.linode.com/products/databases/"> Linode数据库</a>。</p>
<p>在侧边栏上，导航到“数据库”并单击“创建数据库集群”。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode6.png" loading="lazy" class="lazyload" alt="Linode Create Database Cluster" src="../Images/e87ed0a8223ce38e33b76e55af7a291c.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode6.png"/></p>
<p>将其标记为“django-docker-db”，选择“PostgreSQL v13.2”作为引擎，并为该地区选择最接近您的客户的引擎。根据您的项目需求选择CPU计划。</p>
<blockquote>
<p>对于一个玩具项目，使用共享的CPU，因为专用的CPU数据库非常昂贵。</p>
</blockquote>
<p><img data-src="/static/images/blog/django/django-github-linode/linode7.png" loading="lazy" class="lazyload" alt="Linode Create Database Cluster" src="../Images/055ffe85058e8f6a8ee432f940f634cb.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode7.png"/></p>
<p>一个节点应该绰绰有余。对于访问控制，添加您的Linode CPU实例IP地址。</p>
<blockquote>
<p>要允许任何IP连接到数据库，您可以将<code>0.0.0.0/0</code>添加到访问控制列表中。请记住，这是一种糟糕的安全做法，只应该出于测试目的而这样做。不要像这样公开生产数据。</p>
</blockquote>
<p>单击“创建数据库集群”。数据库启动大约需要10-15分钟。一旦它准备好了，就获取它的连接细节。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/linode8.png" loading="lazy" class="lazyload" alt="Linode Database Details" src="../Images/9284d1f07ffc23365546d1743e616750.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/linode8.png"/></p>
<h2 id="github-actions">GitHub操作</h2>
<p><a href="https://docs.github.com/en/actions"> GitHub Actions </a>允许您在GitHub存储库中自动化、定制和执行软件开发工作流。当代码被推送到GitHub repo时，我们将使用它来构建和部署Docker映像。</p>
<p>要配置GitHub动作，首先需要创建一个“.github”目录。接下来，在该目录中创建“工作流”目录，并在“工作流”中创建<em> main.yml </em>:</p>
<div class="codehilite"><pre><span/><code>.github
└── workflows
    └── main.yml
</code></pre></div>

<h3 id="build-job">构建作业</h3>
<p>让我们从创建构建作业开始。</p>
<p>将以下内容放入<em>。github/workflows/main.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Continuous</span><span class="w"> </span><span class="n">Integration</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Delivery</span><span class="w"/>

<span class="k">on</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">push</span><span class="o">]</span><span class="w"/>

<span class="nl">env</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nl">WEB_IMAGE</span><span class="p">:</span><span class="w"> </span><span class="n">ghcr</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span><span class="w"> </span><span class="err">$</span><span class="n">GITHUB_REPOSITORY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="s1">'[:upper:]'</span><span class="w"> </span><span class="s1">'[:lower:]'</span><span class="p">)</span><span class="o">/</span><span class="n">web</span><span class="w"/>
<span class="w">  </span><span class="nl">NGINX_IMAGE</span><span class="p">:</span><span class="w"> </span><span class="n">ghcr</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span><span class="w"> </span><span class="err">$</span><span class="n">GITHUB_REPOSITORY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="s1">'[:upper:]'</span><span class="w"> </span><span class="s1">'[:lower:]'</span><span class="p">)</span><span class="o">/</span><span class="n">nginx</span><span class="w"/>

<span class="nl">jobs</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nl">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Images</span><span class="w"/>
<span class="w">    </span><span class="n">runs</span><span class="o">-</span><span class="k">on</span><span class="err">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span><span class="w"/>
<span class="w">    </span><span class="nl">steps</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Checkout</span><span class="w"> </span><span class="n">master</span><span class="w"/>
<span class="w">        </span><span class="nl">uses</span><span class="p">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="nv">@v1</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"DEBUG=0"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_ENGINE=django.db.backends.postgresql"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"DATABASE=postgres"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SECRET_KEY=${{ secrets.SECRET_KEY }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_DATABASE=${{ secrets.SQL_DATABASE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_USER=${{ secrets.SQL_USER }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_HOST=${{ secrets.SQL_HOST }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"SQL_PORT=${{ secrets.SQL_PORT }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"WEB_IMAGE=$(echo ${{env.WEB_IMAGE}} )"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">GITHUB_ENV</span><span class="w"/>
<span class="w">          </span><span class="n">echo</span><span class="w"> </span><span class="ss">"NGINX_IMAGE=$(echo ${{env.NGINX_IMAGE}} )"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">GITHUB_ENV</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="nf">Log</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">GitHub</span><span class="w"> </span><span class="n">Packages</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="err">${</span><span class="n">PERSONAL_ACCESS_TOKEN</span><span class="err">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">ghcr</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">secrets</span><span class="p">.</span><span class="n">NAMESPACE</span><span class="w"> </span><span class="err">}}</span><span class="w"> </span><span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">stdin</span><span class="w"/>
<span class="w">        </span><span class="nl">env</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nl">PERSONAL_ACCESS_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">secrets</span><span class="p">.</span><span class="n">PERSONAL_ACCESS_TOKEN</span><span class="w"> </span><span class="err">}}</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Pull</span><span class="w"> </span><span class="n">images</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">WEB_IMAGE</span><span class="w"> </span><span class="err">}}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">true</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">NGINX_IMAGE</span><span class="w"> </span><span class="err">}}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">true</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">images</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">ci</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="n">build</span><span class="w"/>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">images</span><span class="w"/>
<span class="w">        </span><span class="nl">run</span><span class="p">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">WEB_IMAGE</span><span class="w"> </span><span class="err">}}</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="err">${{</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">NGINX_IMAGE</span><span class="w"> </span><span class="err">}}</span><span class="w"/>
</code></pre></div>

<p>首先，我们用<code>on</code>命名工作流并定义它何时运行。接下来，我们设置环境变量并定义<code>build</code>作业。一个<a href="https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions#jobs">任务</a>由一个或多个顺序运行的命令组成。</p>
<p>为了避免泄露像密码和密钥这样的私有变量，我们使用了<a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">秘密</a>。因此，为了成功完成这项工作，您需要向GitHub库添加一些秘密。</p>
<p>导航至:</p>
<div class="codehilite"><pre><span/><code>https://github.com/&lt;USERNAME|ORGANIZATION_NAME&gt;/&lt;REPOSITORY_NAME&gt;&lt;/settings

# Example
https://github.com/testdrivenio/django-github-linode/settings
</code></pre></div>

<p>点击“秘密”,然后点击“操作”,添加以下秘密:</p>
<ol>
<li><code>SECRET_KEY</code> : <code>^8!w90zymm9_0z3h4!_n637hw$^-7g%5-l0npq+zbmqz!v22q9</code></li>
<li><code>SQL_DATABASE</code> : <code>postgres</code></li>
<li><code>SQL_USER</code> : <code>linpostgres</code></li>
<li><code>SQL_PASSWORD</code> : <code>yjNajtqytZU1mp1t</code></li>
<li><code>SQL_HOST</code> : <code>lin-7098-1320-pgsql-primary.servers.linodedb.net</code></li>
<li><code>SQL_PORT</code> : <code>5432</code></li>
<li><code>NAMESPACE</code>:您的GitHub用户名或您的组织名称</li>
<li><code>PERSONAL_ACCESS_TOKEN</code>:您的GitHub个人访问令牌</li>
</ol>
<p>确保用您自己的凭据替换SQL连接信息。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/secrets.png" loading="lazy" class="lazyload" alt="GitHub Repository Secrets" src="../Images/083649db7fe05e01f906d2d614e8faef.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/secrets.png"/></p>
<p>接下来，在Django设置中将您的Linode的IP地址添加到<code>ALLOWED_HOSTS</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># app/hello_django/settings.py</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="s1">'&lt;your Linode IP&gt;'</span><span class="p">]</span>
</code></pre></div>

<p>提交您的更改并将您的代码上传到GitHub以触发新的构建。确保它成功完成。</p>
<p><img data-src="/static/images/blog/django/django-github-linode/log-steps.png" loading="lazy" class="lazyload" alt="Build Job Details" src="../Images/4bfc86f3e653fa29b3a2e4e76f5a40df.png" data-original-src="https://testdriven.io/static/images/blog/django/django-github-linode/log-steps.png"/></p>
<p>如果您检查您的包，您会注意到创建了两个映像，<code>web</code>和<code>nginx</code>。<a href="https://www.nginx.com/"> NGINX </a>作为反向代理服务于web应用和静态/媒体文件。</p>
<h3 id="deploy-job">部署作业</h3>
<p>接下来，在<code>build</code>作业之后添加一个名为<code>deploy</code>的新作业:</p>
<div class="codehilite"><pre><span/><code><span class="n">deploy</span><span class="o">:</span><span class="w"/>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Linode</span><span class="w"/>
<span class="w">  </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="o">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span><span class="w"/>
<span class="w">  </span><span class="n">needs</span><span class="o">:</span><span class="w"> </span><span class="n">build</span><span class="w"/>
<span class="w">  </span><span class="n">steps</span><span class="o">:</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Checkout</span><span class="w"> </span><span class="n">master</span><span class="w"/>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v1</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"DEBUG=0"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_ENGINE=django.db.backends.postgresql"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"DATABASE=postgres"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SECRET_KEY=${{ secrets.SECRET_KEY }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_DATABASE=${{ secrets.SQL_DATABASE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_USER=${{ secrets.SQL_USER }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_HOST=${{ secrets.SQL_HOST }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_PORT=${{ secrets.SQL_PORT }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"WEB_IMAGE=${{ env.WEB_IMAGE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"NGINX_IMAGE=${{ env.NGINX_IMAGE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"NAMESPACE=${{ secrets.NAMESPACE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"PERSONAL_ACCESS_TOKEN=${{ secrets.PERSONAL_ACCESS_TOKEN }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ssh</span><span class="o">-</span><span class="n">agent</span><span class="w"/>
<span class="w">      </span><span class="n">env</span><span class="o">:</span><span class="w"/>
<span class="w">        </span><span class="n">SSH_AUTH_SOCK</span><span class="o">:</span><span class="w"> </span><span class="sr">/tmp/ss</span><span class="n">h_agent</span><span class="o">.</span><span class="na">sock</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">~/.</span><span class="n">ssh</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">agent</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="n">$SSH_AUTH_SOCK</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="sr">/dev/</span><span class="kc">null</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">keyscan</span><span class="w"> </span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">known_hosts</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">add</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">"${{ secrets.PRIVATE_KEY }}"</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">deploy</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Linode</span><span class="w"/>
<span class="w">      </span><span class="n">env</span><span class="o">:</span><span class="w"/>
<span class="w">        </span><span class="n">SSH_AUTH_SOCK</span><span class="o">:</span><span class="w"> </span><span class="sr">/tmp/ss</span><span class="n">h_agent</span><span class="o">.</span><span class="na">sock</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">scp</span><span class="w">  </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">./.</span><span class="n">env</span><span class="w"> </span><span class="o">./</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="na">prod</span><span class="o">.</span><span class="na">yml</span><span class="w"> </span><span class="n">root</span><span class="err">@</span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">LINODE_IP_ADDRESS</span><span class="w"> </span><span class="o">}}:/</span><span class="n">app</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span><span class="w"> </span><span class="n">root</span><span class="err">@</span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">LINODE_IP_ADDRESS</span><span class="w"> </span><span class="o">}}</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'ENDSSH'</span><span class="w"/>
<span class="w">          </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">app</span><span class="w"/>
<span class="w">          </span><span class="n">source</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">ghcr</span><span class="o">.</span><span class="na">io</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">$NAMESPACE</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">$PERSONAL_ACCESS_TOKEN</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">$WEB_IMAGE</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">$NGINX_IMAGE</span><span class="w"/>
<span class="w">          </span><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="na">prod</span><span class="o">.</span><span class="na">yml</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"/>
<span class="w">        </span><span class="n">ENDSSH</span><span class="w"/>
</code></pre></div>

<p>只有当<code>build</code>任务成功完成(通过<code>needs: build</code>)时，该任务才会运行。</p>
<p>作业步骤:</p>
<ol>
<li>检查存储库。</li>
<li>将环境变量(包括秘密)添加到一个<em>中。env </em>文件。</li>
<li>初始化SSH代理并添加Linode的私有SSH密钥。</li>
<li>复制<em>。env </em>和<em> docker-compose.prod </em>到Linode。</li>
<li>嘘去里诺德。</li>
<li>更改活动目录。</li>
<li>登录到容器注册表并提取图像。</li>
<li>使用Docker Compose部署图像。</li>
</ol>
<p>将以下两个秘密添加到您的回购中:</p>
<ol>
<li><code>LINODE_IP_ADDRESS</code>:您的链接的IP地址</li>
<li><code>PRIVATE_KEY</code>:你的SSH私钥</li>
</ol>
<p>为了测试，提交然后推送你的代码。</p>
<p>确保两个作业都成功完成。然后，导航到您的网站。您应该看到:</p>


<h2 id="test">试验</h2>
<p>最后，为了确保部署作业只在对主分支进行更改时运行，在<code>needs: build</code>下面添加<code>if: github.ref == 'refs/heads/master'</code>。</p>
<blockquote>
<p>如果你使用<code>main</code>作为默认分支，确保用<code>main</code>替换<code>master</code>。</p>
</blockquote>
<div class="codehilite"><pre><span/><code><span class="n">deploy</span><span class="o">:</span><span class="w"/>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Deploy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Linode</span><span class="w"/>
<span class="w">  </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="o">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span><span class="w"/>
<span class="w">  </span><span class="n">needs</span><span class="o">:</span><span class="w"> </span><span class="n">build</span><span class="w"/>
<span class="w">  </span><span class="k">if</span><span class="o">:</span><span class="w"> </span><span class="n">github</span><span class="o">.</span><span class="na">ref</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'refs/heads/master'</span><span class="w"/>
<span class="w">  </span><span class="n">steps</span><span class="o">:</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Checkout</span><span class="w"> </span><span class="n">master</span><span class="w"/>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v1</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"DEBUG=0"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_ENGINE=django.db.backends.postgresql"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"DATABASE=postgres"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SECRET_KEY=${{ secrets.SECRET_KEY }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_DATABASE=${{ secrets.SQL_DATABASE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_USER=${{ secrets.SQL_USER }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_HOST=${{ secrets.SQL_HOST }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"SQL_PORT=${{ secrets.SQL_PORT }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"WEB_IMAGE=${{ env.WEB_IMAGE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"NGINX_IMAGE=${{ env.NGINX_IMAGE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"NAMESPACE=${{ secrets.NAMESPACE }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">"PERSONAL_ACCESS_TOKEN=${{ secrets.PERSONAL_ACCESS_TOKEN }}"</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">SSH</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ssh</span><span class="o">-</span><span class="n">agent</span><span class="w"/>
<span class="w">      </span><span class="n">env</span><span class="o">:</span><span class="w"/>
<span class="w">        </span><span class="n">SSH_AUTH_SOCK</span><span class="o">:</span><span class="w"> </span><span class="sr">/tmp/ss</span><span class="n">h_agent</span><span class="o">.</span><span class="na">sock</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">~/.</span><span class="n">ssh</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">agent</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="n">$SSH_AUTH_SOCK</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="sr">/dev/</span><span class="kc">null</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">keyscan</span><span class="w"> </span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">known_hosts</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="o">-</span><span class="n">add</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">"${{ secrets.PRIVATE_KEY }}"</span><span class="w"/>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">deploy</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Linode</span><span class="w"/>
<span class="w">      </span><span class="n">env</span><span class="o">:</span><span class="w"/>
<span class="w">        </span><span class="n">SSH_AUTH_SOCK</span><span class="o">:</span><span class="w"> </span><span class="sr">/tmp/ss</span><span class="n">h_agent</span><span class="o">.</span><span class="na">sock</span><span class="w"/>
<span class="w">      </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="o">|</span><span class="w"/>
<span class="w">        </span><span class="n">scp</span><span class="w">  </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">./.</span><span class="n">env</span><span class="w"> </span><span class="o">./</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="na">prod</span><span class="o">.</span><span class="na">yml</span><span class="w"> </span><span class="n">root</span><span class="err">@</span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">LINODE_IP_ADDRESS</span><span class="w"> </span><span class="o">}}:/</span><span class="n">app</span><span class="w"/>
<span class="w">        </span><span class="n">ssh</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span><span class="w"> </span><span class="n">root</span><span class="err">@</span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">LINODE_IP_ADDRESS</span><span class="w"> </span><span class="o">}}</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'ENDSSH'</span><span class="w"/>
<span class="w">          </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">app</span><span class="w"/>
<span class="w">          </span><span class="n">source</span><span class="w"> </span><span class="o">.</span><span class="na">env</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">ghcr</span><span class="o">.</span><span class="na">io</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">$NAMESPACE</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">$PERSONAL_ACCESS_TOKEN</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">$WEB_IMAGE</span><span class="w"/>
<span class="w">          </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">$NGINX_IMAGE</span><span class="w"/>
<span class="w">          </span><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="na">prod</span><span class="o">.</span><span class="na">yml</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"/>
<span class="w">        </span><span class="n">ENDSSH</span><span class="w"/>
</code></pre></div>

<p>为了测试它是否工作，创建一个新的<code>dev</code>分支。然后将<em> app/hello_django/urls.py </em>中的<code>hello world</code>消息改为<code>hello linode</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">"hello"</span><span class="p">:</span> <span class="s2">"linode"</span><span class="p">})</span>
</code></pre></div>

<p>将您的更改提交并推送到GitHub。确保仅运行<code>build</code>作业。一旦构建通过，打开一个针对<code>master</code>(或者<code>main</code>)分支的PR并合并变更。这将触发两个阶段的新构建，<code>build</code>和<code>deploy</code>。确保部署按预期工作:</p>


<p>--</p>
<p>就是这样。你可以从<a href="https://github.com/testdrivenio/django-github-linode">django-github-Li node</a>repo中抓取最终的源代码。</p>
  </div>

  </div>    
</body>
</html>