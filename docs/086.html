<html>
<head>
<title>Deploying Django to AWS ECS with Terraform </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Terraform将Django部署到AWS ECS</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/deploying-django-to-ecs-with-terraform/#0001-01-01">https://testdriven.io/blog/deploying-django-to-ecs-with-terraform/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将了解如何使用<a href="https://www.terraform.io"> Terraform </a>将Django应用程序部署到AWS ECS。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>Django v3.2.9</li>
<li>文档版本20.10.10</li>
<li>python 3 . 9 . 0版</li>
<li>Terraform v1.0.11</li>
</ol>



<h2 id="objectives">目标</h2>
<p>本教程结束时，您将能够:</p>
<ol>
<li>解释什么是Terraform，以及如何使用它编写代码形式的基础设施</li>
<li>利用ECR Docker图像注册表存储图像</li>
<li>创建启动ECS群集所需的地形配置</li>
<li>通过Terraform提升AWS基础设施</li>
<li>将Django应用程序部署到由ECS集群管理的EC2实例集群中</li>
<li>使用Boto3更新ECS服务</li>
<li>为数据持久性配置AWS RDS</li>
<li>为AWS负载平衡器创建HTTPS监听器</li>
</ol>
<h2 id="terraform">将（行星）地球化（以适合人类居住）</h2>
<p><a href="https://www.terraform.io"> Terraform </a>是一个<a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">基础设施as code </a> (IaC)工具，用于通过代码构建、更改和版本化基础设施。它使用高级声明式<a href="https://www.terraform.io/docs/configuration/index.html">配置语言</a>，让您描述运行应用程序所需的云或本地基础设施的状态。可以把它看作是您的基础设施的唯一来源，它使安全有效地创建、更新和删除资源变得容易。在描述了基础设施的最终状态后，Terraform会生成一个计划，然后执行它——例如，提供和启动必要的基础设施。</p>
<blockquote>
<p>如果你是Terraform的新手，请阅读Terraform简介文章和T2入门指南。</p><p>继续之前，请确保您安装了Terraform:</p>
<div class="codehilite"><pre><span/><code>$ terraform -v

Terraform v1.0.11
on darwin_amd64
</code></pre></div>
</blockquote>

<p>在本教程中，我们将使用Terraform开发将Django应用程序部署到ECS所需的高级配置文件。配置完成后，我们将运行一个命令来设置以下AWS基础设施:</p>
<ul>
<li>网络:<ul>
<li>VPC</li>
<li>公共和私有子网</li>
<li>路由表</li>
<li>互联网网关</li>
<li>密钥对</li>
</ul>
</li>
<li>安全组</li>
<li>负载平衡器、侦听器和目标组</li>
<li>IAM角色和策略</li>
<li>ECS:<ul>
<li>任务定义(有多个容器)</li>
<li>串</li>
<li>服务</li>
</ul>
</li>
<li>启动配置和自动缩放组</li>
<li>无线电数据系统</li>
<li>健康检查和日志</li>
</ul>
<blockquote>
<p>亚马逊的<a href="https://aws.amazon.com/ecs/">弹性容器服务</a> (ECS)是一个完全托管的容器编排平台，用于管理和运行EC2实例集群上的容器化应用。</p>
<p>如果您不熟悉ECS，建议首先在web控制台中进行试验。让ECS为您创建这些内容，而不是手动配置所有底层网络资源、IAM角色和策略以及日志。您只需要设置ECS、负载平衡器、监听器、目标组和RDS。一旦你觉得舒服了，就把基础设施作为编码工具，比如Terraform。</p>
</blockquote>
<p>架构图:</p>
<p><img data-src="/static/images/blog/django/django-ecs-terraform/aws-architecture.png" loading="lazy" class="lazyload" alt="AWS Architecture Diagram" src="../Images/9c6c7c9f82ec67716e127eaddbfd11b3.png" data-original-src="https://testdriven.io/static/images/blog/django/django-ecs-terraform/aws-architecture.png"/></p>
<h2 id="project-setup">项目设置</h2>
<p>让我们从建立一个快速的Django项目开始。</p>
<p>创建一个新的项目目录和一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-ecs-terraform <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-ecs-terraform
$ mkdir app <span class="o">&amp;&amp;</span> <span class="nb">cd</span> app
$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.2.9
<span class="o">(</span>env<span class="o">)</span>$ django-admin startproject hello_django .
<span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>查看Django欢迎屏幕。完成后关闭服务器，然后退出虚拟环境。继续并删除它。我们现在有了一个简单的Django项目。</p>
<p>添加一个<em> requirements.txt </em>文件:</p>
<div class="codehilite"><pre><span/><code>Django==3.2.9
gunicorn==20.1.0
</code></pre></div>

<p>同样添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.0-slim-buster</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>出于测试目的，将<code>DEBUG</code>设置为<code>True</code>，并允许<em> settings.py </em>文件中的所有主机:</p>
<div class="codehilite"><pre><span/><code><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'*'</span><span class="p">]</span>
</code></pre></div>

<p>接下来，构建并标记图像，并旋转一个新的容器:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t django-ecs .

$ docker run <span class="se">\</span>
    -p <span class="m">8007</span>:8000 <span class="se">\</span>
    --name django-test <span class="se">\</span>
    django-ecs <span class="se">\</span>
    gunicorn hello_django.wsgi:application --bind <span class="m">0</span>.0.0.0:8000
</code></pre></div>

<p>确保您可以在<a href="http://localhost:8007/"> http://localhost:8007/ </a>再次查看欢迎屏幕。</p>
<p>完成后，停止并移除容器:</p>
<div class="codehilite"><pre><span/><code>$ docker stop django-test
$ docker rm django-test
</code></pre></div>

<p>加一个<em>。gitignore </em>文件到项目根目录:</p>
<div class="codehilite"><pre><span/><code><span class="nf">__pycache__</span><span class="w"/>
<span class="na">.DS_Store</span><span class="w"/>
<span class="err">*</span><span class="na">.sqlite3</span><span class="w"/>
</code></pre></div>

<p>您的项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── .gitignore
└── app
    ├── Dockerfile
    ├── hello_django
    │   ├── __init__.py
    │   ├── asgi.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    └── requirements.txt
</code></pre></div>

<blockquote>
<p>要更详细地了解如何将Django应用程序容器化，请查看使用Postgres、Gunicorn和Nginx的博客文章。</p>
</blockquote>
<h2 id="ecr">electroniccashregister电子现金出纳机</h2>
<p>在进入Terraform之前，让我们将Docker映像推送到一个私有的Docker映像注册表<a href="https://aws.amazon.com/ecr/">Elastic Container Registry</a>(ECR)。</p>
<p>导航到<a href="http://console.aws.amazon.com/ecr"> ECR控制台</a>，添加一个名为“django-app”的新存储库。保持标签的可变性。关于这方面的更多内容，请查看<a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-tag-mutability.html">图像标签可变性</a>指南。</p>
<p>回到您的终端，再次构建并标记图像:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest .
</code></pre></div>

<blockquote>
<p>确保用您的AWS帐户ID替换<code>&lt;AWS_ACCOUNT_ID&gt;</code>。</p>
<p>我们将在整个课程中使用<code>us-west-1</code>区域。如果你愿意，请随意更改。</p>
</blockquote>
<p>验证Docker CLI以使用ECR注册表:</p>
<div class="codehilite"><pre><span/><code>$ aws ecr get-login --region us-west-1 --no-include-email
</code></pre></div>

<p>该命令将提供一个身份验证令牌。复制并粘贴整个<code>docker login</code>命令进行验证。</p>
<p>推送图像:</p>
<div class="codehilite"><pre><span/><code>$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest
</code></pre></div>

<h2 id="terraform-setup">地形设置</h2>
<p>将“terraform”文件夹添加到项目的根目录。我们将把每个Terraform配置文件添加到这个文件夹中。</p>
<p>接下来，向“terraform”添加一个名为<em> 01_provider.tf </em>的新文件:</p>
<div class="codehilite"><pre><span/><code>provider "aws" {
  region = var.region
}
</code></pre></div>

<p>这里，我们定义了<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs"> AWS </a>提供者。你需要提供你的AWS证书以便<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs#authentication">验证</a>。将它们定义为环境变量:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"YOUR_AWS_ACCESS_KEY_ID"</span>
$ <span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"YOUR_AWS_SECRET_ACCESS_KEY"</span>
</code></pre></div>

<p>我们为<code>region</code>使用了一个字符串插值，它将从<em> variables.tf </em>文件中读入。继续将该文件添加到“terraform”文件夹中，并向其中添加以下变量:</p>
<div class="codehilite"><pre><span/><code># core

variable "region" {
  description = "The AWS region to create resources in."
  default     = "us-west-1"
}
</code></pre></div>

<blockquote>
<p>在学习本教程的过程中，您可以根据自己的具体需求随意更新变量。</p>
</blockquote>
<p>运行<code>terraform init</code>创建一个新的Terraform工作目录并下载AWS提供程序。</p>
<p>这样我们就可以开始定义AWS基础设施的每一部分。</p>
<h2 id="aws-resources">AWS资源</h2>
<p>接下来，让我们配置以下AWS资源:</p>
<ul>
<li>网络:<ul>
<li>VPC</li>
<li>公共和私有子网</li>
<li>路由表</li>
<li>互联网网关</li>
<li>密钥对</li>
</ul>
</li>
<li>安全组</li>
<li>负载平衡器、侦听器和目标组</li>
<li>IAM角色和策略</li>
<li>ECS:<ul>
<li>任务定义(有多个容器)</li>
<li>串</li>
<li>服务</li>
</ul>
</li>
<li>启动配置和自动缩放组</li>
<li>健康检查和日志</li>
</ul>
<blockquote>
<p>您可以在GitHub上的<a href="https://github.com/testdrivenio/django-ecs-terraform">django-ECS-Terraform</a>repo中找到每个terra form配置文件。</p>
</blockquote>
<h3 id="network-resources">网络资源</h3>
<p>让我们在名为<em> 02_network.tf </em>的新文件中定义我们的网络资源:</p>
<div class="codehilite"><pre><span/><code># Production VPC
resource "aws_vpc" "production-vpc" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true
}

# Public subnets
resource "aws_subnet" "public-subnet-1" {
  cidr_block        = var.public_subnet_1_cidr
  vpc_id            = aws_vpc.production-vpc.id
  availability_zone = var.availability_zones[0]
}
resource "aws_subnet" "public-subnet-2" {
  cidr_block        = var.public_subnet_2_cidr
  vpc_id            = aws_vpc.production-vpc.id
  availability_zone = var.availability_zones[1]
}

# Private subnets
resource "aws_subnet" "private-subnet-1" {
  cidr_block        = var.private_subnet_1_cidr
  vpc_id            = aws_vpc.production-vpc.id
  availability_zone = var.availability_zones[0]
}
resource "aws_subnet" "private-subnet-2" {
  cidr_block        = var.private_subnet_2_cidr
  vpc_id            = aws_vpc.production-vpc.id
  availability_zone = var.availability_zones[1]
}

# Route tables for the subnets
resource "aws_route_table" "public-route-table" {
  vpc_id = aws_vpc.production-vpc.id
}
resource "aws_route_table" "private-route-table" {
  vpc_id = aws_vpc.production-vpc.id
}

# Associate the newly created route tables to the subnets
resource "aws_route_table_association" "public-route-1-association" {
  route_table_id = aws_route_table.public-route-table.id
  subnet_id      = aws_subnet.public-subnet-1.id
}
resource "aws_route_table_association" "public-route-2-association" {
  route_table_id = aws_route_table.public-route-table.id
  subnet_id      = aws_subnet.public-subnet-2.id
}
resource "aws_route_table_association" "private-route-1-association" {
  route_table_id = aws_route_table.private-route-table.id
  subnet_id      = aws_subnet.private-subnet-1.id
}
resource "aws_route_table_association" "private-route-2-association" {
  route_table_id = aws_route_table.private-route-table.id
  subnet_id      = aws_subnet.private-subnet-2.id
}

# Elastic IP
resource "aws_eip" "elastic-ip-for-nat-gw" {
  vpc                       = true
  associate_with_private_ip = "10.0.0.5"
  depends_on                = [aws_internet_gateway.production-igw]
}

# NAT gateway
resource "aws_nat_gateway" "nat-gw" {
  allocation_id = aws_eip.elastic-ip-for-nat-gw.id
  subnet_id     = aws_subnet.public-subnet-1.id
  depends_on    = [aws_eip.elastic-ip-for-nat-gw]
}
resource "aws_route" "nat-gw-route" {
  route_table_id         = aws_route_table.private-route-table.id
  nat_gateway_id         = aws_nat_gateway.nat-gw.id
  destination_cidr_block = "0.0.0.0/0"
}

# Internet Gateway for the public subnet
resource "aws_internet_gateway" "production-igw" {
  vpc_id = aws_vpc.production-vpc.id
}

# Route the public subnet traffic through the Internet Gateway
resource "aws_route" "public-internet-igw-route" {
  route_table_id         = aws_route_table.public-route-table.id
  gateway_id             = aws_internet_gateway.production-igw.id
  destination_cidr_block = "0.0.0.0/0"
}
</code></pre></div>

<p>这里，我们定义了以下资源:</p>
<ol>
<li><a href="https://aws.amazon.com/vpc/">虚拟私有云</a> (VPC)</li>
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">公共和私有子网</a></li>
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html">路由表</a></li>
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html">互联网网关</a></li>
</ol>
<p>还添加以下变量:</p>
<div class="codehilite"><pre><span/><code># networking

variable "public_subnet_1_cidr" {
  description = "CIDR Block for Public Subnet 1"
  default     = "10.0.1.0/24"
}
variable "public_subnet_2_cidr" {
  description = "CIDR Block for Public Subnet 2"
  default     = "10.0.2.0/24"
}
variable "private_subnet_1_cidr" {
  description = "CIDR Block for Private Subnet 1"
  default     = "10.0.3.0/24"
}
variable "private_subnet_2_cidr" {
  description = "CIDR Block for Private Subnet 2"
  default     = "10.0.4.0/24"
}
variable "availability_zones" {
  description = "Availability zones"
  type        = list(string)
  default     = ["us-west-1b", "us-west-1c"]
}
</code></pre></div>

<p>运行<code>terraform plan</code>生成并显示基于已定义配置的执行计划。</p>
<h3 id="security-groups">安全组</h3>
<p>接下来，为了保护Django应用程序和ECS集群，让我们在一个名为<em> 03_securitygroups.tf </em>的新文件中配置<a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">安全组</a>:</p>
<div class="codehilite"><pre><span/><code># ALB Security Group (Traffic Internet -&gt; ALB)
resource "aws_security_group" "load-balancer" {
  name        = "load_balancer_security_group"
  description = "Controls access to the ALB"
  vpc_id      = aws_vpc.production-vpc.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# ECS Security group (traffic ALB -&gt; ECS, ssh -&gt; ECS)
resource "aws_security_group" "ecs" {
  name        = "ecs_security_group"
  description = "Allows inbound access from the ALB only"
  vpc_id      = aws_vpc.production-vpc.id

  ingress {
    from_port       = 0
    to_port         = 0
    protocol        = "-1"
    security_groups = [aws_security_group.load-balancer.id]
  }

  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
</code></pre></div>

<p>注意与端口22的ECS集群相关联的安全组上的<a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#SecurityGroupRules">入站规则</a>。这样我们就可以SSH到EC2实例中运行初始数据库迁移并添加一个超级用户。</p>
<h3 id="load-balancer">负载平衡</h3>
<p>接下来，让我们配置一个<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html">应用负载平衡器</a> (ALB)以及适当的<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html">目标组</a>和<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html">监听器</a>。</p>
<p>04 _ load balancer . TF:</p>
<div class="codehilite"><pre><span/><code># Production Load Balancer
resource "aws_lb" "production" {
  name               = "${var.ecs_cluster_name}-alb"
  load_balancer_type = "application"
  internal           = false
  security_groups    = [aws_security_group.load-balancer.id]
  subnets            = [aws_subnet.public-subnet-1.id, aws_subnet.public-subnet-2.id]
}

# Target group
resource "aws_alb_target_group" "default-target-group" {
  name     = "${var.ecs_cluster_name}-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.production-vpc.id

  health_check {
    path                = var.health_check_path
    port                = "traffic-port"
    healthy_threshold   = 5
    unhealthy_threshold = 2
    timeout             = 2
    interval            = 5
    matcher             = "200"
  }
}

# Listener (redirects traffic from the load balancer to the target group)
resource "aws_alb_listener" "ecs-alb-http-listener" {
  load_balancer_arn = aws_lb.production.id
  port              = "80"
  protocol          = "HTTP"
  depends_on        = [aws_alb_target_group.default-target-group]

  default_action {
    type             = "forward"
    target_group_arn = aws_alb_target_group.default-target-group.arn
  }
}
</code></pre></div>

<p>添加所需的变量:</p>
<div class="codehilite"><pre><span/><code># load balancer

variable "health_check_path" {
  description = "Health check path for the default target group"
  default     = "/ping/"
}


# ecs

variable "ecs_cluster_name" {
  description = "Name of the ECS cluster"
  default     = "production"
}
</code></pre></div>

<p>因此，我们配置了负载平衡器和监听器来监听端口80上的HTTP请求。这是暂时的。在我们验证我们的基础设施和应用程序设置正确后，我们将更新负载平衡器，以侦听端口443上的HTTPS请求。</p>
<p>记下运行状况检查的路径URL:<code>/ping/</code>。</p>
<h3 id="iam-roles">IAM角色</h3>
<p><em> 05_iam.tf </em>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_iam_role" "ecs-host-role" {
  name               = "ecs_host_role_prod"
  assume_role_policy = file("policies/ecs-role.json")
}

resource "aws_iam_role_policy" "ecs-instance-role-policy" {
  name   = "ecs_instance_role_policy"
  policy = file("policies/ecs-instance-role-policy.json")
  role   = aws_iam_role.ecs-host-role.id
}

resource "aws_iam_role" "ecs-service-role" {
  name               = "ecs_service_role_prod"
  assume_role_policy = file("policies/ecs-role.json")
}

resource "aws_iam_role_policy" "ecs-service-role-policy" {
  name   = "ecs_service_role_policy"
  policy = file("policies/ecs-service-role-policy.json")
  role   = aws_iam_role.ecs-service-role.id
}

resource "aws_iam_instance_profile" "ecs" {
  name = "ecs_instance_profile_prod"
  path = "/"
  role = aws_iam_role.ecs-host-role.name
}
</code></pre></div>

<p>在“terraform”中添加一个名为“policies”的新文件夹。然后，添加以下<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html">角色</a>和<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">策略</a>定义:</p>
<p><em> ecs-role.json </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2008-10-17"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"Service"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">          </span><span class="s2">"ecs.amazonaws.com"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="s2">"ec2.amazonaws.com"</span><span class="w"/>
<span class="w">        </span><span class="p">]</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p><em>ECS-instance-role-policy . JSON</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="s2">"ecs:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"ec2:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"ecr:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"cloudwatch:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"s3:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"rds:*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"logs:*"</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p><em>ECS-service-role-policy . JSON</em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:Describe*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:DeregisterInstancesFromLoadBalancer"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:RegisterInstancesWithLoadBalancer"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"ec2:Describe*"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"ec2:AuthorizeSecurityGroupIngress"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:RegisterTargets"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"elasticloadbalancing:DeregisterTargets"</span><span class="w"/>
<span class="w">      </span><span class="p">],</span><span class="w"/>
<span class="w">      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">        </span><span class="s2">"*"</span><span class="w"/>
<span class="w">      </span><span class="p">]</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<h3 id="logs">日志</h3>
<p><em> 06_logs.tf </em>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_cloudwatch_log_group" "django-log-group" {
  name              = "/ecs/django-app"
  retention_in_days = var.log_retention_in_days
}

resource "aws_cloudwatch_log_stream" "django-log-stream" {
  name           = "django-app-log-stream"
  log_group_name = aws_cloudwatch_log_group.django-log-group.name
}
</code></pre></div>

<p>添加变量:</p>
<div class="codehilite"><pre><span/><code># logs

variable "log_retention_in_days" {
  default = 30
}
</code></pre></div>

<h3 id="key-pair">密钥对</h3>
<p>07 _ key pair . TF:</p>
<div class="codehilite"><pre><span/><code>resource "aws_key_pair" "production" {
  key_name   = "${var.ecs_cluster_name}_key_pair"
  public_key = file(var.ssh_pubkey_file)
}
</code></pre></div>

<p>变量:</p>
<div class="codehilite"><pre><span/><code># key pair

variable "ssh_pubkey_file" {
  description = "Path to an SSH public key"
  default     = "~/.ssh/id_rsa.pub"
}
</code></pre></div>

<h3 id="ecs">精英公司</h3>
<p>现在，我们可以配置我们的<a href="https://aws.amazon.com/ecs/"> ECS </a>集群了。</p>
<p><em> 08_ecs.tf </em>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_ecs_cluster" "production" {
  name = "${var.ecs_cluster_name}-cluster"
}

resource "aws_launch_configuration" "ecs" {
  name                        = "${var.ecs_cluster_name}-cluster"
  image_id                    = lookup(var.amis, var.region)
  instance_type               = var.instance_type
  security_groups             = [aws_security_group.ecs.id]
  iam_instance_profile        = aws_iam_instance_profile.ecs.name
  key_name                    = aws_key_pair.production.key_name
  associate_public_ip_address = true
  user_data                   = "#!/bin/bash\necho ECS_CLUSTER='${var.ecs_cluster_name}-cluster' &gt; /etc/ecs/ecs.config"
}

data "template_file" "app" {
  template = file("templates/django_app.json.tpl")

  vars = {
    docker_image_url_django = var.docker_image_url_django
    region                  = var.region
  }
}

resource "aws_ecs_task_definition" "app" {
  family                = "django-app"
  container_definitions = data.template_file.app.rendered
}

resource "aws_ecs_service" "production" {
  name            = "${var.ecs_cluster_name}-service"
  cluster         = aws_ecs_cluster.production.id
  task_definition = aws_ecs_task_definition.app.arn
  iam_role        = aws_iam_role.ecs-service-role.arn
  desired_count   = var.app_count
  depends_on      = [aws_alb_listener.ecs-alb-http-listener, aws_iam_role_policy.ecs-service-role-policy]

  load_balancer {
    target_group_arn = aws_alb_target_group.default-target-group.arn
    container_name   = "django-app"
    container_port   = 8000
  }
}
</code></pre></div>

<p>看一下<code>aws_launch_configuration</code>中的<code>user_data</code>字段。简而言之，<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html"> user_data </a>是一个在启动新的EC2实例时运行的脚本。为了让ECS集群发现新的EC2实例，需要将集群名称添加到实例内的<em> /etc/ecs/ecs.config </em>配置文件中的<code>ECS_CLUSTER</code>环境变量中。换句话说，以下脚本将在引导新实例时运行，从而允许群集发现该实例:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span> <span class="nv">ECS_CLUSTER</span><span class="o">=</span><span class="s1">'production-cluster'</span> &gt; /etc/ecs/ecs.config
</code></pre></div>

<blockquote>
<p>有关这个发现过程的更多信息，请查看<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-config.html"> Amazon ECS容器代理配置</a>指南。</p>
</blockquote>
<p>在“terraform”文件夹中添加一个“templates”文件夹，然后添加一个名为<em> django_app.json.tpl </em>的新模板文件:</p>
<div class="codehilite"><pre><span/><code><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${docker_image_url_django}"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"essential"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"memory"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"portMappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">8000</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"hostPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"gunicorn"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-w"</span><span class="p">,</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-b"</span><span class="p">,</span><span class="w"> </span><span class="s2">":8000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hello_django.wsgi:application"</span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"logConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"logDriver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awslogs"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ecs/django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${region}"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-stream-prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app-log-stream"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">]</span><span class="w"/>
</code></pre></div>

<p>这里，我们定义了与Django应用程序相关联的<a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_ContainerDefinition.html">容器定义</a>。</p>
<p>还添加以下变量:</p>
<div class="codehilite"><pre><span/><code># ecs

variable "ecs_cluster_name" {
  description = "Name of the ECS cluster"
  default     = "production"
}
variable "amis" {
  description = "Which AMI to spawn."
  default = {
    us-west-1 = "ami-0bd3976c0dbacc605"
  }
}
variable "instance_type" {
  default = "t2.micro"
}
variable "docker_image_url_django" {
  description = "Docker image to run in the ECS cluster"
  default     = "&lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest"
}
variable "app_count" {
  description = "Number of Docker containers to run"
  default     = 2
}
</code></pre></div>

<blockquote>
<p>同样，确保用您的AWS帐户ID替换<code>&lt;AWS_ACCOUNT_ID&gt;</code>。</p>
<p>参考<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html#ecs-optimized-ami-linux"> Linux Amazon ECS优化的ami</a>指南，找到预装Docker的ami列表。</p>
</blockquote>
<p>因为我们添加了<a href="https://registry.terraform.io/providers/hashicorp/template/latest/docs">模板</a>提供程序，所以再次运行<code>terraform init</code>来下载新的提供程序。</p>
<h3 id="auto-scaling">自动缩放</h3>
<p><em> 09_auto_scaling.tf </em>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_autoscaling_group" "ecs-cluster" {
  name                 = "${var.ecs_cluster_name}_auto_scaling_group"
  min_size             = var.autoscale_min
  max_size             = var.autoscale_max
  desired_capacity     = var.autoscale_desired
  health_check_type    = "EC2"
  launch_configuration = aws_launch_configuration.ecs.name
  vpc_zone_identifier  = [aws_subnet.private-subnet-1.id, aws_subnet.private-subnet-2.id]
}
</code></pre></div>

<p>新变量:</p>
<div class="codehilite"><pre><span/><code># auto scaling

variable "autoscale_min" {
  description = "Minimum autoscale (number of EC2)"
  default     = "1"
}
variable "autoscale_max" {
  description = "Maximum autoscale (number of EC2)"
  default     = "10"
}
variable "autoscale_desired" {
  description = "Desired autoscale (number of EC2)"
  default     = "4"
}
</code></pre></div>

<h3 id="test">试验</h3>
<p><em> outputs.tf </em>:</p>
<div class="codehilite"><pre><span/><code>output "alb_hostname" {
  value = aws_lb.production.dns_name
}
</code></pre></div>

<p>这里，我们配置了一个<em> outputs.tf </em>文件以及一个名为<code>alb_hostname</code>的<a href="https://www.terraform.io/language/values/outputs">输出值</a>。在我们执行Terraform计划之后，为了启动AWS基础设施，负载平衡器的DNS名称将被输出到终端。</p>
<p>准备好了吗？！？查看然后执行计划:</p>
<div class="codehilite"><pre><span/><code>$ terraform plan

$ terraform apply
</code></pre></div>

<p>您应该看到运行状况检查失败，并显示404:</p>
<div class="codehilite"><pre><span/><code>service production-service <span class="o">(</span>instance i-013f1192da079b0bf<span class="o">)</span> <span class="o">(</span>port <span class="m">49153</span><span class="o">)</span>
is unhealthy <span class="k">in</span> target-group production-tg due to
<span class="o">(</span>reason Health checks failed with these codes: <span class="o">[</span><span class="m">404</span><span class="o">])</span>
</code></pre></div>

<p>这是意料之中的，因为我们还没有在应用程序中设置/ping/ handler。</p>
<h2 id="django-health-check">姜戈健康检查</h2>
<p>将以下中间件添加到<em>app/hello _ django/middleware . py</em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.utils.deprecation</span> <span class="kn">import</span> <span class="n">MiddlewareMixin</span>


<span class="k">class</span> <span class="nc">HealthCheckMiddleware</span><span class="p">(</span><span class="n">MiddlewareMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s1">'PATH_INFO'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'/ping/'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">'pong!'</span><span class="p">)</span>
</code></pre></div>

<p>将类添加到<em> settings.py </em>中的中间件配置中:</p>
<div class="codehilite"><pre><span/><code><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'hello_django.middleware.HealthCheckMiddleware'</span><span class="p">,</span>  <span class="c1"># new</span>
    <span class="s1">'django.middleware.security.SecurityMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.common.CommonMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p>这个中间件用于在检查<code>ALLOWED_HOSTS</code>之前处理对/ping/ URL的请求。为什么这是必要的？</p>
<p>健康检查请求来自EC2实例。由于我们事先不知道私有IP，这将确保/ping/ route总是返回一个成功的响应，即使在我们限制<code>ALLOWED_HOSTS</code>之后。</p>
<blockquote>
<p>值得注意的是，您可以将Nginx放在Gunicorn前面，并在Nginx配置中处理健康检查，如下所示:</p>
<div class="codehilite"><pre><span/><span class="err">location /ping/ {</span>
<span class="err">    access_log off;</span>
<span class="err">    return 200;</span>
<span class="err">}</span>
</pre></div></blockquote>

<p>要进行本地测试，构建新的映像，然后启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t django-ecs .

$ docker run <span class="se">\</span>
    -p <span class="m">8007</span>:8000 <span class="se">\</span>
    --name django-test <span class="se">\</span>
    django-ecs <span class="se">\</span>
    gunicorn hello_django.wsgi:application --bind <span class="m">0</span>.0.0.0:8000
</code></pre></div>

<p>确保<a href="http://localhost:8007/ping/">http://localhost:8007/ping/</a>按预期工作:</p>


<p>完成后，停止并移除容器:</p>
<div class="codehilite"><pre><span/><code>$ docker stop django-test
$ docker rm django-test
</code></pre></div>

<p>接下来，更新ECR:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest .
$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest
</code></pre></div>

<p>让我们添加一个快速脚本来更新任务定义和服务，以便新任务使用我们刚刚推送的新映像。</p>
<p>在项目根目录下创建一个“部署”文件夹。然后，将一个<em> update-ecs.py </em>文件添加到新创建的文件夹中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">click</span>


<span class="k">def</span> <span class="nf">get_current_task_definition</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">describe_services</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">services</span><span class="o">=</span><span class="p">[</span><span class="n">service</span><span class="p">])</span>
    <span class="n">current_task_arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">"services"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"taskDefinition"</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">describe_task_definition</span><span class="p">(</span><span class="n">taskDefinition</span><span class="o">=</span><span class="n">current_task_arn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"--cluster"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Name of the ECS cluster"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"--service"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Name of the ECS service"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">"ecs"</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">get_current_task_definition</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
    <span class="n">container_definition</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"containerDefinitions"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_task_definition</span><span class="p">(</span>
        <span class="n">family</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"family"</span><span class="p">],</span>
        <span class="n">volumes</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"volumes"</span><span class="p">],</span>
        <span class="n">containerDefinitions</span><span class="o">=</span><span class="p">[</span><span class="n">container_definition</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">new_task_arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"taskDefinitionArn"</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_service</span><span class="p">(</span>
        <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span> <span class="n">taskDefinition</span><span class="o">=</span><span class="n">new_task_arn</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">deploy</span><span class="p">()</span>
</code></pre></div>

<p>因此，该脚本将创建任务定义的新修订版，然后更新服务，使其使用修订后的任务定义。</p>
<p>创建并激活新的虚拟环境。然后，安装<a href="https://github.com/boto/boto3"> Boto3 </a>和<a href="https://click.palletsprojects.com/">点击</a>:</p>
<div class="codehilite"><pre><span/><code>$ pip install boto3 click
</code></pre></div>

<p>添加您的AWS凭据以及默认区域:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"YOUR_AWS_ACCESS_KEY_ID"</span>
$ <span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"YOUR_AWS_SECRET_ACCESS_KEY"</span>
$ <span class="nb">export</span> <span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">"us-west-1"</span>
</code></pre></div>

<p>像这样运行脚本:</p>
<div class="codehilite"><pre><span/><code>$ python update-ecs.py --cluster<span class="o">=</span>production-cluster --service<span class="o">=</span>production-service
</code></pre></div>

<p>服务应该根据修改后的任务定义启动两个新任务，并将它们注册到相关的目标组。这一次健康检查应该会通过。现在，您应该能够使用输出到终端的DNS主机名来查看您的应用程序了:</p>
<div class="codehilite"><pre><span/><code>Outputs:

<span class="nv">alb_hostname</span> <span class="o">=</span> production-alb-1008464563.us-west-1.elb.amazonaws.com
</code></pre></div>

<h2 id="rds">无线电数据系统</h2>
<p>接下来，让我们配置<a href="https://aws.amazon.com/rds/"> RDS </a>，这样我们就可以将Postgres用于我们的生产数据库。</p>
<p>向<em> 03_securitygroups.tf </em>添加一个新的安全组，以确保只有来自ECS实例的流量可以与数据库对话:</p>
<div class="codehilite"><pre><span/><code># RDS Security Group (traffic ECS -&gt; RDS)
resource "aws_security_group" "rds" {
  name        = "rds-security-group"
  description = "Allows inbound access from ECS only"
  vpc_id      = aws_vpc.production-vpc.id

  ingress {
    protocol        = "tcp"
    from_port       = "5432"
    to_port         = "5432"
    security_groups = [aws_security_group.ecs.id]
  }

  egress {
    protocol    = "-1"
    from_port   = 0
    to_port     = 0
    cidr_blocks = ["0.0.0.0/0"]
  }
}
</code></pre></div>

<p>接下来，添加一个名为<em> 10_rds.tf </em>的新文件，用于设置数据库本身:</p>
<div class="codehilite"><pre><span/><code>resource "aws_db_subnet_group" "production" {
  name       = "main"
  subnet_ids = [aws_subnet.private-subnet-1.id, aws_subnet.private-subnet-2.id]
}

resource "aws_db_instance" "production" {
  identifier              = "production"
  name                    = var.rds_db_name
  username                = var.rds_username
  password                = var.rds_password
  port                    = "5432"
  engine                  = "postgres"
  engine_version          = "12.3"
  instance_class          = var.rds_instance_class
  allocated_storage       = "20"
  storage_encrypted       = false
  vpc_security_group_ids  = [aws_security_group.rds.id]
  db_subnet_group_name    = aws_db_subnet_group.production.name
  multi_az                = false
  storage_type            = "gp2"
  publicly_accessible     = false
  backup_retention_period = 7
  skip_final_snapshot     = true
}
</code></pre></div>

<p>变量:</p>
<div class="codehilite"><pre><span/><code># rds

variable "rds_db_name" {
  description = "RDS database name"
  default     = "mydb"
}
variable "rds_username" {
  description = "RDS database username"
  default     = "foo"
}
variable "rds_password" {
  description = "RDS database password"
}
variable "rds_instance_class" {
  description = "RDS instance type"
  default     = "db.t2.micro"
}
</code></pre></div>

<p>请注意，我们保留了密码的默认值。稍后会有更多的介绍。</p>
<p>因为我们需要知道Django应用程序中实例的地址，所以在<em> 08_ecs.tf </em>的<code>aws_ecs_task_definition</code>中添加一个<code>depends_on</code>参数:</p>
<div class="codehilite"><pre><span/><code>resource "aws_ecs_task_definition" "app" {
  family                = "django-app"
  container_definitions = data.template_file.app.rendered
  depends_on            = [aws_db_instance.production]
}
</code></pre></div>

<p>接下来，我们需要更新<em> settings.py </em>中的<code>DATABASES</code>配置:</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="s1">'RDS_DB_NAME'</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.postgresql_psycopg2'</span><span class="p">,</span>
            <span class="s1">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'RDS_DB_NAME'</span><span class="p">],</span>
            <span class="s1">'USER'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'RDS_USERNAME'</span><span class="p">],</span>
            <span class="s1">'PASSWORD'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'RDS_PASSWORD'</span><span class="p">],</span>
            <span class="s1">'HOST'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'RDS_HOSTNAME'</span><span class="p">],</span>
            <span class="s1">'PORT'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'RDS_PORT'</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.sqlite3'</span><span class="p">,</span>
            <span class="s1">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">'db.sqlite3'</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>添加导入:</p>


<p>更新<em> django_app.json.tpl </em>模板中的<code>environment</code>部分:</p>
<div class="codehilite"><pre><span/><code><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_DB_NAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_db_name}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_USERNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_username}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PASSWORD"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_password}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_HOSTNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_hostname}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PORT"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5432"</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">],</span><span class="w"/>
</code></pre></div>

<p>更新<em> 08_ecs.tf </em>中传递给模板的变量:</p>
<div class="codehilite"><pre><span/><code>data "template_file" "app" {
  template = file("templates/django_app.json.tpl")

  vars = {
    docker_image_url_django = var.docker_image_url_django
    region                  = var.region
    rds_db_name             = var.rds_db_name
    rds_username            = var.rds_username
    rds_password            = var.rds_password
    rds_hostname            = aws_db_instance.production.address
  }
}
</code></pre></div>

<p>将<a href="https://www.psycopg.org/"> Psycopg2 </a>添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>Django==3.2.9
gunicorn==20.1.0
psycopg2-binary==2.9.2
</code></pre></div>

<p>更新docker文件以安装Psycopg2所需的相应软件包:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.0-slim-buster</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2 dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apt-get -y install gcc postgresql <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apt-get clean

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>好吧。构建Docker映像并将其推送到ECR。然后，要更新ECS任务定义、创建RDS资源并更新服务，请运行:</p>


<p>因为我们没有设置默认密码，所以会提示您输入一个密码:</p>
<div class="codehilite"><pre><span/><code>var.rds_password
  RDS database password

  Enter a value:
</code></pre></div>

<p>不必每次都传递一个值，您可以像这样设置一个<a href="https://www.terraform.io/docs/commands/environment-variables.html#tf_var_name">环境变量</a>:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">TF_VAR_rds_password</span><span class="o">=</span>foobarbaz

$ terraform apply
</code></pre></div>

<p>请记住，这种使用环境变量的方法将敏感变量排除在<em>之外。tf </em>文件，但它们仍然以纯文本形式存储在<em> terraform.tfstate </em>文件中。因此，一定要将这个文件置于版本控制之外。因为如果你团队中的其他人需要访问它，将它置于版本控制之外是行不通的，所以要么加密秘密，要么使用像<a href="https://www.vaultproject.io/">金库</a>或<a href="https://aws.amazon.com/secrets-manager/"> AWS秘密管理器</a>这样的秘密存储。</p>
<p>在新任务注册到目标组之后，SSH进入一个EC2实例，其中一个任务正在运行:</p>


<p>通过<code>docker ps</code>获取容器ID，并使用它来应用迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker <span class="nb">exec</span> -it &lt;container-id&gt; python manage.py migrate

<span class="c1"># docker exec -it 73284cda8a87 python manage.py migrate</span>
</code></pre></div>

<p>您可能还想创建一个超级用户。完成后，退出SSH会话。如果您不再需要SSH访问，您可能需要从ECS安全组中删除以下入站规则:</p>
<div class="codehilite"><pre><span/><code>ingress {
  from_port   = 22
  to_port     = 22
  protocol    = "tcp"
  cidr_blocks = ["0.0.0.0/0"]
}
</code></pre></div>

<h2 id="domain-and-ssl-certificate">域和SSL证书</h2>
<p>假设您已经从<a href="https://aws.amazon.com/certificate-manager/"> AWS证书管理器</a>生成并验证了一个新的SSL证书，将证书的ARN添加到您的变量中:</p>
<div class="codehilite"><pre><span/><code># domain

variable "certificate_arn" {
  description = "AWS Certificate Manager ARN for validated domain"
  default     = "ADD YOUR ARN HERE"
}
</code></pre></div>

<p>在<em> 04_loadbalancer.tf </em>中更新与负载平衡器关联的默认监听器，以便它监听端口443上的HTTPS请求(与端口80上的HTTP相反):</p>
<div class="codehilite"><pre><span/><code># Listener (redirects traffic from the load balancer to the target group)
resource "aws_alb_listener" "ecs-alb-http-listener" {
  load_balancer_arn = aws_lb.production.id
  port              = "443"
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-2016-08"
  certificate_arn   = var.certificate_arn
  depends_on        = [aws_alb_target_group.default-target-group]

  default_action {
    type             = "forward"
    target_group_arn = aws_alb_target_group.default-target-group.arn
  }
}
</code></pre></div>

<p>应用更改:</p>


<p>确保使用CNAME记录将您的域指向负载平衡器。确保您可以查看您的应用程序。</p>
<h2 id="nginx">Nginx</h2>
<p>接下来，让我们将Nginx添加到组合中，以适当地处理对静态文件的请求。</p>
<p>在项目根目录中，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<p><em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.19.0-alpine</span>

<span class="k">RUN</span><span class="w"> </span>rm /etc/nginx/conf.d/default.conf
<span class="k">COPY</span><span class="w"> </span>nginx.conf /etc/nginx/conf.d
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">80</span>
</code></pre></div>

<p><em>engine . conf</em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">upstream</span><span class="w"> </span><span class="nt">hello_django</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="err">server</span><span class="w"> </span><span class="n">django-app</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span><span class="w"/>

<span class="w">    </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span><span class="w"/>

<span class="w">    </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">hello_django</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">X-Forwarded-For</span><span class="w"> </span><span class="err">$proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Host</span><span class="w"> </span><span class="err">$host</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_redirect</span><span class="w"> </span><span class="err">off</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>

<span class="err">}</span><span class="w"/>
</code></pre></div>

<p>这里，我们设置了一个位置块，将所有流量路由到Django应用程序。在下一节中，我们将为静态文件设置一个新的位置块。</p>
<p>在ECR中创建一个名为“nginx”的新repo，然后构建并推送新映像:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/nginx:latest .
$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/nginx:latest
</code></pre></div>

<p>将以下变量添加到变量文件的ECS部分:</p>
<div class="codehilite"><pre><span/><code>variable "docker_image_url_nginx" {
  description = "Docker image to run in the ECS cluster"
  default     = "&lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/nginx:latest"
}
</code></pre></div>

<p>将新的容器定义添加到<em> django_app.json.tpl </em>模板:</p>
<div class="codehilite"><pre><span/><code><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${docker_image_url_django}"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"essential"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"memory"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"portMappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">8000</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"hostPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"gunicorn"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-w"</span><span class="p">,</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-b"</span><span class="p">,</span><span class="w"> </span><span class="s2">":8000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hello_django.wsgi:application"</span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_DB_NAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_db_name}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_USERNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_username}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PASSWORD"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_password}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_HOSTNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_hostname}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PORT"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5432"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"logConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"logDriver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awslogs"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ecs/django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${region}"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-stream-prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app-log-stream"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${docker_image_url_nginx}"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"essential"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"memory"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"django-app"</span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"portMappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"hostPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"logConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"logDriver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awslogs"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ecs/nginx"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${region}"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-stream-prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx-log-stream"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">]</span><span class="w"/>
</code></pre></div>

<p>将变量传递给<em> 08_ecs.tf </em>中的模板:</p>
<div class="codehilite"><pre><span/><code>data "template_file" "app" {
  template = file("templates/django_app.json.tpl")

  vars = {
    docker_image_url_django = var.docker_image_url_django
    docker_image_url_nginx  = var.docker_image_url_nginx
    region                  = var.region
    rds_db_name             = var.rds_db_name
    rds_username            = var.rds_username
    rds_password            = var.rds_password
    rds_hostname            = aws_db_instance.production.address
  }
}
</code></pre></div>

<p>将新日志添加到<em> 06_logs.tf </em>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_cloudwatch_log_group" "nginx-log-group" {
  name              = "/ecs/nginx"
  retention_in_days = var.log_retention_in_days
}

resource "aws_cloudwatch_log_stream" "nginx-log-stream" {
  name           = "nginx-log-stream"
  log_group_name = aws_cloudwatch_log_group.nginx-log-group.name
}
</code></pre></div>

<p>更新服务，使其指向<code>nginx</code>容器，而不是<code>django-app</code>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_ecs_service" "production" {
  name            = "${var.ecs_cluster_name}-service"
  cluster         = aws_ecs_cluster.production.id
  task_definition = aws_ecs_task_definition.app.arn
  iam_role        = aws_iam_role.ecs-service-role.arn
  desired_count   = var.app_count
  depends_on      = [aws_alb_listener.ecs-alb-http-listener, aws_iam_role_policy.ecs-service-role-policy]

  load_balancer {
    target_group_arn = aws_alb_target_group.default-target-group.arn
    container_name   = "nginx"
    container_port   = 80
  }
}
</code></pre></div>

<p>应用更改:</p>


<p>确保仍可从浏览器访问该应用程序。</p>
<p>现在我们正在处理两个容器，让我们更新deploy函数来处理<em> update-ecs.py </em>中的多个容器定义:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"--cluster"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Name of the ECS cluster"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"--service"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Name of the ECS service"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">"ecs"</span><span class="p">)</span>

    <span class="n">container_definitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">get_current_task_definition</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">container_definition</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"containerDefinitions"</span><span class="p">]:</span>
        <span class="n">new_def</span> <span class="o">=</span> <span class="n">container_definition</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">container_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_def</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_task_definition</span><span class="p">(</span>
        <span class="n">family</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"family"</span><span class="p">],</span>
        <span class="n">volumes</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"volumes"</span><span class="p">],</span>
        <span class="n">containerDefinitions</span><span class="o">=</span><span class="n">container_definitions</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">new_task_arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">"taskDefinition"</span><span class="p">][</span><span class="s2">"taskDefinitionArn"</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_service</span><span class="p">(</span>
        <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span> <span class="n">taskDefinition</span><span class="o">=</span><span class="n">new_task_arn</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>

<h2 id="static-files">静态文件</h2>
<p>在你的<em> settings.py </em>文件中设置<code>STATIC_ROOT</code>:</p>
<div class="codehilite"><pre><span/><code><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s1">'/staticfiles/'</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">'staticfiles'</span><span class="p">)</span>
</code></pre></div>

<p>此外，关闭调试模式:</p>


<p>更新Dockerfile，以便它在最后运行<code>collectstatic</code>命令:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.0-slim-buster</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2 dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apt-get -y install gcc postgresql <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apt-get clean

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .

<span class="c"># collect static files</span>
<span class="k">RUN</span><span class="w"> </span>python manage.py collectstatic --no-input
</code></pre></div>

<p>接下来，让我们将一个共享卷添加到任务定义中，并更新Nginx conf文件。</p>
<p>将新的位置块添加到<em> nginx.conf </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">upstream</span><span class="w"> </span><span class="nt">hello_django</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="err">server</span><span class="w"> </span><span class="n">django-app</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span><span class="w"/>

<span class="w">    </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span><span class="w"/>

<span class="w">    </span><span class="err">location</span><span class="w"> </span><span class="err">/staticfiles/</span><span class="w"> </span><span class="err">{</span><span class="w"/>
<span class="w">        </span><span class="err">alias</span><span class="w"> </span><span class="err">/usr/src/app/staticfiles/</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>

<span class="w">    </span><span class="nt">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">hello_django</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">X-Forwarded-For</span><span class="w"> </span><span class="err">$proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_set_header</span><span class="w"> </span><span class="err">Host</span><span class="w"> </span><span class="err">$host</span><span class="p">;</span><span class="w"/>
<span class="w">        </span><span class="err">proxy_redirect</span><span class="w"> </span><span class="err">off</span><span class="p">;</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>

<span class="err">}</span><span class="w"/>
</code></pre></div>

<p>将卷添加到<em> 08_ecs.tf </em>中的<code>aws_ecs_task_definition</code>:</p>
<div class="codehilite"><pre><span/><code>resource "aws_ecs_task_definition" "app" {
  family                = "django-app"
  container_definitions = data.template_file.app.rendered
  depends_on            = [aws_db_instance.production]

  volume {
    name      = "static_volume"
    host_path = "/usr/src/app/staticfiles/"
  }
}
</code></pre></div>

<p>将卷添加到<em> django_app.json.tpl </em>模板中的容器定义中:</p>
<div class="codehilite"><pre><span/><code><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${docker_image_url_django}"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"essential"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"memory"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"/>
<span class="w">    </span><span class="nt">"portMappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">8000</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"hostPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"gunicorn"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-w"</span><span class="p">,</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-b"</span><span class="p">,</span><span class="w"> </span><span class="s2">":8000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hello_django.wsgi:application"</span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_DB_NAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_db_name}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_USERNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_username}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PASSWORD"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_password}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_HOSTNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_hostname}"</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PORT"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5432"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"mountPoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/src/app/staticfiles"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"sourceVolume"</span><span class="p">:</span><span class="w"> </span><span class="s2">"static_volume"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"logConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"logDriver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awslogs"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ecs/django-app"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${region}"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-stream-prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"django-app-log-stream"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${docker_image_url_nginx}"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"essential"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"memory"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"django-app"</span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"portMappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"hostPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"mountPoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">      </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"containerPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/src/app/staticfiles"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"sourceVolume"</span><span class="p">:</span><span class="w"> </span><span class="s2">"static_volume"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">],</span><span class="w"/>
<span class="w">    </span><span class="nt">"logConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"logDriver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awslogs"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ecs/nginx"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${region}"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="nt">"awslogs-stream-prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx-log-stream"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">]</span><span class="w"/>
</code></pre></div>

<p>现在，每个容器将共享一个名为“staticfiles”的目录。</p>
<p>构建新图像，并将其上传至ECR:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest .
$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest

$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/nginx:latest .
$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/nginx:latest
</code></pre></div>

<p>应用更改:</p>


<p>静态文件现在应该可以正确加载了。</p>
<h2 id="allowed-hosts">允许的主机</h2>
<p>最后，让我们锁定我们的生产应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'ALLOWED_HOSTS'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</code></pre></div>

<p>将<code>ALLOWED_HOSTS</code>环境变量添加到容器定义中:</p>
<div class="codehilite"><pre><span/><code><span class="nt">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_DB_NAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_db_name}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_USERNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_username}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PASSWORD"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_password}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_HOSTNAME"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${rds_hostname}"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDS_PORT"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5432"</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ALLOWED_HOSTS"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${allowed_hosts}"</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">],</span><span class="w"/>
</code></pre></div>

<p>将变量传递给<em> 08_ecs.tf </em>中的模板:</p>
<div class="codehilite"><pre><span/><code>data "template_file" "app" {
  template = file("templates/django_app.json.tpl")

  vars = {
    docker_image_url_django = var.docker_image_url_django
    docker_image_url_nginx  = var.docker_image_url_nginx
    region                  = var.region
    rds_db_name             = var.rds_db_name
    rds_username            = var.rds_username
    rds_password            = var.rds_password
    rds_hostname            = aws_db_instance.production.address
    allowed_hosts           = var.allowed_hosts
  }
}
</code></pre></div>

<p>将变量添加到变量文件的ECS部分，确保添加您的域名:</p>
<div class="codehilite"><pre><span/><code>variable "allowed_hosts" {
  description = "Domain name for allowed hosts"
  default     = "YOUR DOMAIN NAME"
}
</code></pre></div>

<p>建立新的图像并将其提交给ECR:</p>
<div class="codehilite"><pre><span/><code>$ docker build -t &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest .
$ docker push &lt;AWS_ACCOUNT_ID&gt;.dkr.ecr.us-west-1.amazonaws.com/django-app:latest
</code></pre></div>

<p>应用:</p>


<p>最后一次测试。</p>
<p>完成后立即关闭基础架构:</p>


<h2 id="conclusion">结论</h2>
<p>本教程介绍了如何使用Terraform来构建在ECS上运行Django应用程序所需的AWS基础设施。</p>
<p>虽然初始配置很复杂，但具有复杂基础设施需求的大型团队将从Terraform中受益。它为您的基础设施提供了一个可读的、集中的事实来源，这将导致更快的反馈周期。</p>
<p>后续步骤:</p>
<ol>
<li>为容器的伸缩配置CloudWatch警报。</li>
<li><a href="/blog/storing-django-static-and-media-files-on-amazon-s3/">在亚马逊S3上存储用户上传的文件</a></li>
<li><a href="/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/#production-dockerfile">建立多阶段Docker构建，并在Docker容器中使用非根用户</a></li>
<li>不要将端口80上的流量路由到Nginx，而是为端口443添加一个监听器。</li>
<li>浏览整个<a href="https://docs.djangoproject.com/en/3.2/howto/deployment/checklist/"> Django部署清单</a>。</li>
<li>如果您计划托管多个应用程序，您可能希望将跨应用程序共享的任何“公共”资源移动到单独的Terraform堆栈，以便如果您定期进行修改，您的核心AWS服务不会不受影响。</li>
<li>看一看<a href="https://aws.amazon.com/fargate/"> ECS Fargate </a>。这可以简化您的基础架构，因为您不必管理实际的集群。</li>
</ol>
<p>你可以在django-ecs-terraform  repo中找到最终代码。</p>
  </div>

  </div>    
</body>
</html>