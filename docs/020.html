<html>
<head>
<title>Developing and Testing an Asynchronous API with FastAPI and Pytest </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用FastAPI和Pytest开发和测试异步API</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/fastapi-crud/#0001-01-01">https://testdriven.io/blog/fastapi-crud/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>本教程着眼于如何使用<a href="/test-driven-development/">测试驱动开发</a> (TDD)用FastAPI、Postgres、pytest和Docker开发和测试一个异步API。我们还将使用Databases包与Postgres进行异步交互。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>FastAPI v0.88.0</li>
<li>文档v20.10.21</li>
<li>python 3 . 11 . 0版</li>
<li>pytest v7.2.0</li>
<li>数据库版本0.6.2</li>
</ol>



<h2 id="objectives">目标</h2>
<p>学完本教程后，您应该能够:</p>
<ol>
<li>用Python和FastAPI开发异步RESTful API</li>
<li>实践测试驱动的开发</li>
<li>用pytest测试FastAPI应用程序</li>
<li>与Postgres数据库异步交互</li>
<li>将FastAPI和Postgres封装到Docker容器中</li>
<li>用pytest参数化测试函数和测试中的模拟功能</li>
<li>用Swagger/OpenAPI记录RESTful API</li>
</ol>
<h2 id="fastapi">FastAPI</h2>
<p>FastAPI是一个现代的、高性能的、内置电池的Python web框架，非常适合构建RESTful APIs。它可以处理同步和异步请求，并内置了对数据验证、JSON序列化、身份验证和授权以及<a href="https://swagger.io/docs/specification/about/"> OpenAPI </a>(撰写本文时版本为<a href="https://github.com/tiangolo/fastapi/blob/0.88.0/fastapi/applications.py#L106"> 3.0.2 </a>)文档的支持。</p>
<p>亮点:</p>
<ol>
<li>受Flask的启发，它有一种轻量级微框架的感觉，支持类似Flask的route decorators。</li>
<li>它利用Python类型提示进行参数声明，支持数据验证(通过<a href="https://pydantic-docs.helpmanual.io/"> Pydantic </a>)和OpenAPI/Swagger文档。</li>
<li>它建立在<a href="https://www.starlette.io/"> Starlette </a>之上，支持异步API的开发。</li>
<li>它很快。由于async比传统的同步线程模型更有效，所以在性能方面它可以与Node和Go竞争。</li>
</ol>
<blockquote>
<p>查看官方文档中的<a href="https://fastapi.tiangolo.com/features/">功能</a>指南，了解更多信息。我们也鼓励大家回顾一下<a href="https://fastapi.tiangolo.com/alternatives/">的替代方案、灵感和比较</a>，其中详细介绍了FastAPI与其他web框架和技术的比较。</p>
</blockquote>
<h2 id="project-setup">项目设置</h2>
<p>首先创建一个名为“fastapi-crud”的文件夹来保存您的项目。然后，向项目根目录添加一个<em> docker-compose.yml </em>文件和一个“src”文件夹。在“src”文件夹中，添加一个<em> Dockerfile </em>、<em> requirements.txt </em>文件，以及一个“app”文件夹。最后，将以下文件添加到“app”文件夹:<em> __init__。py </em>和<em> main.py </em>。</p>
<blockquote>
<p>以下命令将创建项目结构:</p><div class="codehilite"><pre><span/><code>$ mkdir fastapi-crud <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">cd</span> fastapi-crud <span class="o">&amp;&amp;</span> <span class="se">\</span>
    touch docker-compose.yml <span class="o">&amp;&amp;</span> <span class="se">\</span>
    mkdir src <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">cd</span> src <span class="o">&amp;&amp;</span> <span class="se">\</span>
    touch Dockerfile <span class="o">&amp;&amp;</span> <span class="se">\</span>
    touch requirements.txt <span class="o">&amp;&amp;</span> <span class="se">\</span>
    mkdir app <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">cd</span> app <span class="o">&amp;&amp;</span> <span class="se">\</span>
    touch __init__.py <span class="o">&amp;&amp;</span> <span class="se">\</span>
    touch main.py
</code></pre></div>
</blockquote>

<p>您现在应该已经:</p>
<div class="codehilite"><pre><span/><code>fastapi-crud
    ├── docker-compose.yml
    └── src
        ├── Dockerfile
        ├── app
        │   ├── __init__.py
        │   └── main.py
        └── requirements.txt
</code></pre></div>

<p>与Django或Flask不同，FastAPI没有内置的开发服务器。因此，我们将使用<a href="https://www.uvicorn.org/">uvicon</a>，一个<a href="https://asgi.readthedocs.io/en/latest/"> ASGI </a>服务器，来提供FastAPI。</p>
<blockquote>
<p>不熟悉ASGI？通读优秀的<a href="https://florimond.dev/blog/articles/2019/08/introduction-to-asgi-async-python-web/">ASGI简介:异步Python Web生态系统的出现</a>文章。</p>
</blockquote>
<p>将FastAPI和Uvicorn添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.88.0
uvicorn==0.20.0
</code></pre></div>

<blockquote>
<p>在我看来，FastAPI没有附带开发服务器的事实既是一个优点，也是一个缺点。一方面，在开发模式下提供应用程序确实需要更多的时间。另一方面，这有助于从概念上将web框架与web服务器分开，这对于初学者来说常常是一个困惑的来源，当一个web框架从开发进入生产时，它确实有一个内置的开发服务器(像Django或Flask)。</p>
</blockquote>
<p>然后，在<em> main.py </em>中，创建一个新的FastAPI实例，并设置一个健全性检查路径:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有的话，然后更新“src”目录下的<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.0-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># copy requirements file</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt /usr/src/app/requirements.txt

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">set</span> -eux <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --no-cache --virtual .build-deps build-base <span class="se">\</span>
         openssl-dev libffi-dev gcc musl-dev python3-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install --upgrade pip setuptools wheel <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install -r /usr/src/app/requirements.txt <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /root/.cache/pip

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. /usr/src/app/
</code></pre></div>

<p>所以，我们从Python 3.11.0的基于<a href="https://github.com/gliderlabs/docker-alpine"> Alpine </a>的<a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及两个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
</ol>
<p>最后，我们复制了<em> requirements.txt </em>文件，安装了一些系统级的依赖项，更新了Pip，安装了需求，并复制了FastAPI应用程序本身。</p>
<blockquote>
<p>查看<a href="/blog/docker-best-practices/"> Docker针对Python开发人员的最佳实践</a>，了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将以下内容添加到项目根目录下的<em> docker-compose.yml </em>文件中:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8002:8000</span><span class="w"/>
</code></pre></div>

<p>因此，当容器旋转起来时，Uvicorn将按照以下<a href="https://www.uvicorn.org/settings/">设置</a>运行:</p>
<ol>
<li><code>--reload</code>启用自动重新加载，这样服务器将在对代码库进行更改后重新启动。</li>
<li><code>--workers 1</code>提供单个工作进程。</li>
<li><code>--host 0.0.0.0</code>定义托管服务器的地址。</li>
<li><code>--port 8000</code>定义托管服务器的端口。</li>
</ol>
<p><code>app.main:app</code>告诉Uvicorn在哪里可以找到FastAPI ASGI应用程序——例如，“在‘app’模块中，您会在‘main . py’文件中找到ASGI应用程序<code>app = FastAPI()</code>。</p>
<blockquote>
<p>有关Docker合成文件配置的更多信息，请查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>。</p>
</blockquote>
<p>构建映像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://localhost:8002/ping">http://localhost:8002/ping</a>。您应该看到:</p>


<p>您还可以在<a href="http://localhost:8002/docs">http://localhost:8002/docs</a>上查看由<a href="https://github.com/swagger-api/swagger-ui"> Swagger UI </a>支持的交互式API文档:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-crud/swagger_ui.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/b5155e593d954faf6c3211ea5180de51.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-crud/swagger_ui.png"/></p>
<h2 id="test-setup">测试设置</h2>
<p>在“src”中创建一个“tests”文件夹，然后添加一个<em> __init__。py </em>文件与一个<em> test_main.py </em>文件一起“测试”:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">starlette.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">app.main</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_ping</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>这里，我们导入了Starlette的<a href="https://www.starlette.io/testclient/"> TestClient </a>，它使用<a href="https://github.com/encode/httpx"> httpx </a>库对FastAPI应用程序发出请求。</p>
<p>将pytest和httpx添加到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.88.0
uvicorn==0.20.0

# dev
pytest==7.2.0
httpx==0.23.1
</code></pre></div>

<p>更新图像，然后运行测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> web pytest .
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">1</span> item

tests/test_main.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.31s <span class="o">================================</span>
</code></pre></div>

<p>在继续之前，添加一个<code>test_app</code> pytest <a href="https://docs.pytest.org/en/latest/how-to/fixtures.html"> fixture </a>到一个名为<em> src/tests/conftest.py </em>的新文件中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">starlette.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">app.main</span> <span class="kn">import</span> <span class="n">app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_app</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">client</span>  <span class="c1"># testing happens here</span>
</code></pre></div>

<p>更新测试文件，以便它使用fixture:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_ping</span><span class="p">(</span><span class="n">test_app</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>您的项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>fastapi-crud
    ├── docker-compose.yml
    └── src
        ├── Dockerfile
        ├── app
        │   ├── __init__.py
        │   └── main.py
        ├── requirements.txt
        └── tests
            ├── __init__.py
            ├── conftest.py
            └── test_main.py
</code></pre></div>

<h2 id="async-handlers">异步处理程序</h2>
<p>让我们将同步处理程序转换成异步处理程序。</p>
<p>FastAPI使异步交付路线变得很容易，而不必经历创建任务队列(如Celery或RQ)或利用线程的麻烦。只要处理程序中没有任何阻塞的I/O调用，就可以简单地通过添加关键字<code>async</code>将处理程序声明为异步的，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="c1"># some async operation could happen here</span>
    <span class="c1"># example: `notes = await get_all_notes()`</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>就是这样。更新代码中的处理程序，然后确保测试仍然通过:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">1</span> item

tests/test_main.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.06s <span class="o">================================</span>
</code></pre></div>

<blockquote>
<p>查看<a href="https://fastapi.tiangolo.com/async/">并发和异步/等待</a>指南，深入了解异步技术。</p>
</blockquote>
<h2 id="routes">路线</h2>
<p>接下来，让我们按照RESTful最佳实践设置基本的CRUD路径:</p>
<table>
<thead>
<tr>
<th>端点</th>
<th>HTTP方法</th>
<th>CRUD方法</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>/备注/</td>
<td>得到</td>
<td>阅读</td>
<td>获取所有笔记</td>
</tr>
<tr>
<td>/notes/:id/</td>
<td>得到</td>
<td>阅读</td>
<td>得到一个音符</td>
</tr>
<tr>
<td>/备注/</td>
<td>邮政</td>
<td>创造</td>
<td>添加注释</td>
</tr>
<tr>
<td>/notes/:id/</td>
<td>放</td>
<td>更新</td>
<td>更新注释</td>
</tr>
<tr>
<td>/notes/:id/</td>
<td>删除</td>
<td>删除</td>
<td>删除便笺</td>
</tr>
</tbody>
</table>
<p>对于每条路线，我们将:</p>
<ol>
<li>写一个测试</li>
<li>运行测试，确保失败(<strong>红色</strong>)</li>
<li>编写足够通过测试的代码(<strong>绿色</strong>)</li>
<li><strong>重构</strong>(如有必要)</li>
</ol>
<p>在开始之前，让我们添加一些结构，以便用FastAPI的<a href="https://fastapi.tiangolo.com/tutorial/bigger-applications/#apirouter"> APIRouter </a>更好地组织CRUD路由。</p>
<blockquote>
<p>您可以分解和模块化更大的项目，并使用<code>APIRouter</code>将版本控制应用到您的API。如果你熟悉Flask，它相当于一个<a href="https://flask.palletsprojects.com/blueprints/">蓝图</a>。</p>
</blockquote>
<p>首先，在“app”文件夹中添加一个名为“api”的新文件夹。添加一个<em> __init__。py </em>文件到新创建的文件夹中。</p>
<p>现在我们可以将<code>/ping</code>路径移动到一个名为<em> src/app/api/ping.py </em>的新文件中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pong</span><span class="p">():</span>
    <span class="c1"># some async operation could happen here</span>
    <span class="c1"># example: `notes = await get_all_notes()`</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"ping"</span><span class="p">:</span> <span class="s2">"pong!"</span><span class="p">}</span>
</code></pre></div>

<p>然后，像这样更新<em> main.py </em>以删除旧路由，并将路由器连接到我们的主应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">app.api</span> <span class="kn">import</span> <span class="n">ping</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
</code></pre></div>

<p>将<em> test_main.py </em>重命名为<em> test_ping.py </em>。</p>
<p>确保<a href="http://localhost:8002/ping">http://localhost:8002/ping</a>和<a href="http://localhost:8002/docs">http://localhost:8002/docs</a>仍然工作。此外，在继续之前，确保测试仍然通过。</p>
<div class="codehilite"><pre><span/><code>fastapi-crud
    ├── docker-compose.yml
    └── src
        ├── Dockerfile
        ├── app
        │   ├── __init__.py
        │   ├── api
        │   │   ├── __init__.py
        │   │   └── ping.py
        │   └── main.py
        ├── requirements.txt
        └── tests
            ├── __init__.py
            ├── conftest.py
            └── test_ping.py
</code></pre></div>

<h2 id="postgres-setup">Postgres设置</h2>
<p>要配置Postgres，我们需要向<em> docker-compose.yml </em>文件添加一个新服务，添加适当的环境变量，并安装<a href="https://github.com/MagicStack/asyncpg"> asyncpg </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"/>
<span class="w">      </span><span class="no">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; uvicorn app.main:app --reload --workers 1 --host 0.0.0.0 --port 8000'</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./src/:/usr/src/app/</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8002:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_fastapi:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d6beb3babab989b0b7a5a2b7a6bf96b2b4">[email protected]</a>/hello_fastapi_dev</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15.1-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_fastapi</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_fastapi_dev</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>更新docker文件以安装asyncpg所需的适当软件包:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.0-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># copy requirements file</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt /usr/src/app/requirements.txt

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">set</span> -eux <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --no-cache --virtual .build-deps build-base <span class="se">\</span>
         openssl-dev libffi-dev gcc musl-dev python3-dev <span class="se">\</span>
        postgresql-dev bash <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install --upgrade pip setuptools wheel <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install -r /usr/src/app/requirements.txt <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /root/.cache/pip

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. /usr/src/app/
</code></pre></div>

<p>将asyncpg添加到<em> src/requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>asyncpg==0.27.0
fastapi==0.88.0
uvicorn==0.20.0

# dev
pytest==7.2.0
httpx==0.23.1
</code></pre></div>

<p>接下来，在“src/app”中添加一个<em> db.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">databases</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span>


<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">)</span>

<span class="c1"># SQLAlchemy</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="c1"># databases query builder</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
</code></pre></div>

<p>这里，使用我们刚刚在Docker Compose文件中配置的数据库URI和凭证，我们创建了一个SQLAlchemy <a href="https://docs.sqlalchemy.org/en/14/core/engines.html">引擎</a>(用于与数据库通信)以及一个<a href="https://docs.sqlalchemy.org/en/14/core/metadata.html">元数据</a>实例(用于创建数据库模式)。我们还从<a href="https://www.encode.io/databases/">数据库</a>中创建了一个新的<a href="https://github.com/encode/databases/blob/0.6.2/databases/core.py#L38">数据库</a>实例。</p>
<p><a href="https://www.encode.io/databases/">数据库</a>是一个异步SQL查询构建器，它工作在<a href="https://docs.sqlalchemy.org/en/latest/core/"> SQLAlchemy核心</a>表达式语言之上。它支持以下方法:</p>
<ol>
<li><code>database.fetch_all(query)</code></li>
<li><code>database.fetch_one(query)</code></li>
<li><code>database.iterate(query)</code></li>
<li><code>database.execute(query)</code></li>
<li><code>database.execute_many(query)</code></li>
</ol>
<blockquote>
<p>查看<a href="https://fastapi.tiangolo.com/advanced/async-sql-databases/">异步SQL(关系)数据库</a>指南和<a href="https://www.starlette.io/database"> Starlette数据库</a>文档，了解关于异步使用数据库的更多细节。</p>
</blockquote>
<p>更新要求:</p>
<div class="codehilite"><pre><span/><code><span class="n">asyncpg</span><span class="o">==</span><span class="mf">0.27.0</span><span class="w"/>
<span class="n">databases</span><span class="o">[</span><span class="n">postgresql</span><span class="o">]==</span><span class="mf">0.6.2</span><span class="w"/>
<span class="n">fastapi</span><span class="o">==</span><span class="mf">0.88.0</span><span class="w"/>
<span class="n">psycopg2</span><span class="o">-</span><span class="nc">binary</span><span class="o">==</span><span class="mf">2.9.5</span><span class="w"/>
<span class="n">SQLAlchemy</span><span class="o">==</span><span class="mf">1.4.41</span><span class="w"/>
<span class="n">uvicorn</span><span class="o">==</span><span class="mf">0.20.0</span><span class="w"/>

<span class="err">#</span><span class="w"> </span><span class="n">dev</span><span class="w"/>
<span class="n">pytest</span><span class="o">==</span><span class="mf">7.2.0</span><span class="w"/>
<span class="n">httpx</span><span class="o">==</span><span class="mf">0.23.1</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>我们正在安装<a href="https://www.psycopg.org/"> Psycopg </a>，因为我们将使用<a href="https://docs.sqlalchemy.org/en/14/core/metadata.html#sqlalchemy.schema.MetaData.create_all"> create_all </a>，这是一个同步SQLAlchemy函数。</p>
</blockquote>
<h2 id="models">模型</h2>
<h3 id="sqlalchemy-model">SQLAlchemy模型</h3>
<p>给<em> src/app/db.py </em>添加一个<code>notes</code>模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">MetaData</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Table</span><span class="p">,</span>
    <span class="n">create_engine</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">databases</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">)</span>

<span class="c1"># SQLAlchemy</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">notes</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">"notes"</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">"description"</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">"created_date"</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># databases query builder</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
</code></pre></div>

<p>连接数据库和<em> main.py </em>中的模型，添加<a href="https://fastapi.tiangolo.com/advanced/events/">启动和关闭事件处理程序</a>，用于连接和断开数据库；</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">app.api</span> <span class="kn">import</span> <span class="n">ping</span>
<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">engine</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">metadata</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"shutdown"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>


<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
</code></pre></div>

<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>确保<code>notes</code>表已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_fastapi --dbname<span class="o">=</span>hello_fastapi_dev

psql <span class="o">(</span><span class="m">15</span>.1<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_fastapi_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                            List of databases
       Name        <span class="p">|</span>     Owner     <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>        Access privileges
-------------------+---------------+----------+------------+------------+---------------------------------
 hello_fastapi_dev <span class="p">|</span> hello_fastapi <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres          <span class="p">|</span> hello_fastapi <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0         <span class="p">|</span> hello_fastapi <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_fastapi               +
                   <span class="p">|</span>               <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_fastapi</span><span class="o">=</span>CTc/hello_fastapi
 template1         <span class="p">|</span> hello_fastapi <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_fastapi               +
                   <span class="p">|</span>               <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_fastapi</span><span class="o">=</span>CTc/hello_fastapi
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_fastapi_dev</span><span class="o">=</span><span class="c1"># \c hello_fastapi_dev</span>
You are now connected to database <span class="s2">"hello_fastapi_dev"</span> as user <span class="s2">"hello_fastapi"</span>.

<span class="nv">hello_fastapi_dev</span><span class="o">=</span><span class="c1"># \dt</span>
           List of relations
 Schema <span class="p">|</span> Name  <span class="p">|</span> Type  <span class="p">|</span>     Owner
--------+-------+-------+---------------
 public <span class="p">|</span> notes <span class="p">|</span> table <span class="p">|</span> hello_fastapi
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">hello_fastapi_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<h3 id="pydantic-model">Pydantic模型</h3>
<blockquote>
<p>第一次使用Pydantic？查看官方文档中的<a href="https://pydantic-docs.helpmanual.io/">概述</a>指南。</p>
</blockquote>
<p>在“src/app/api”中一个名为<em> models.py </em>的新文件中创建一个<code>NoteSchema</code> Pydantic <a href="https://pydantic-docs.helpmanual.io/usage/models/">模型</a>，其中有两个必填字段<code>title</code>和<code>description</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">NoteSchema</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<p><code>NoteSchema</code>将用于验证创建和更新便笺的有效负载。</p>
<h2 id="post-route">邮寄路线</h2>
<p>让我们打破第一条路由的正常TDD流程，以建立我们将用于其余路由的编码模式。</p>
<h3 id="code">密码</h3>
<p>在“src/app/api”文件夹中创建一个名为<em> notes.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">HTTPException</span>

<span class="kn">from</span> <span class="nn">app.api</span> <span class="kn">import</span> <span class="n">crud</span>
<span class="kn">from</span> <span class="nn">app.api.models</span> <span class="kn">import</span> <span class="n">NoteDB</span><span class="p">,</span> <span class="n">NoteSchema</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">NoteSchema</span><span class="p">):</span>
    <span class="n">note_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">response_object</span>
</code></pre></div>

<p>在这里，我们定义了一个处理程序，它需要一个有效负载<code>payload: NoteSchema</code>，带有一个标题和一个描述。</p>
<p>本质上，当路由遇到POST请求时，FastAPI将读取请求的主体并验证数据:</p>
<ul>
<li>如果有效，数据将在<code>payload</code>参数中可用。FastAPI还生成<a href="https://json-schema.org/"> JSON模式</a>定义，然后用于自动生成OpenAPI模式和API文档。</li>
<li>如果无效，将立即返回错误。</li>
</ul>
<blockquote>
<p>查看<a href="https://fastapi.tiangolo.com/tutorial/body/">请求正文</a>文档了解更多信息。</p>
</blockquote>
<p>值得注意的是，我们在这里使用了<code>async</code>声明，因为数据库通信将是异步的。换句话说，在处理程序中没有阻塞的I/O操作。</p>
<p>接下来，在“src/app/api”文件夹中创建一个名为<em> crud.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">app.api.models</span> <span class="kn">import</span> <span class="n">NoteSchema</span>
<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">notes</span><span class="p">,</span> <span class="n">database</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">NoteSchema</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<p>我们添加了一个名为<code>post</code>的实用函数，用于创建新的notes，它接受一个有效载荷对象，然后:</p>
<ol>
<li>创建一个SQLAlchemy <a href="https://docs.sqlalchemy.org/en/13/core/tutorial.html#insert-expressions"> insert </a>对象表达式查询</li>
<li>执行查询并返回生成的ID</li>
</ol>
<p>接下来，我们需要定义一个新的Pydantic模型作为<a href="https://fastapi.tiangolo.com/tutorial/response-model/"> response_model </a>:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
</code></pre></div>

<p>更新<em> models.py </em>这样:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">NoteSchema</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">NoteDB</span><span class="p">(</span><span class="n">NoteSchema</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>

<p><code>NoteDB</code>模型继承了<code>NoteSchema</code>模型，增加了一个<code>id</code>字段。</p>
<p>在<em> main.py </em>中连接新路由器:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">app.api</span> <span class="kn">import</span> <span class="n">notes</span><span class="p">,</span> <span class="n">ping</span>
<span class="kn">from</span> <span class="nn">app.db</span> <span class="kn">import</span> <span class="n">database</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">metadata</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startup</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">"shutdown"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>


<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"/notes"</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"notes"</span><span class="p">])</span>
</code></pre></div>

<p>注意前缀URL和<code>"notes"</code> <a href="https://fastapi.tiangolo.com/tutorial/path-operation-configuration/#tags">标签</a>，它们将应用于OpenAPI模式(用于<a href="https://swagger.io/docs/specification/grouping-operations-with-tags/">分组操作</a>)。</p>
<p>用curl或<a href="https://httpie.org/"> HTTPie </a>测试一下:</p>
<div class="codehilite"><pre><span/><code>$ http --json POST http://localhost:8002/notes/ <span class="nv">title</span><span class="o">=</span>foo <span class="nv">description</span><span class="o">=</span>bar
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code>HTTP/1.1 <span class="m">201</span> Created
content-length: <span class="m">42</span>
content-type: application/json
date: Wed, <span class="m">23</span> Nov <span class="m">2022</span> <span class="m">18</span>:14:51 GMT
server: uvicorn

<span class="o">{</span>
    <span class="s2">"description"</span>: <span class="s2">"bar"</span>,
    <span class="s2">"id"</span>: <span class="m">1</span>,
    <span class="s2">"title"</span>: <span class="s2">"foo"</span>
<span class="o">}</span>
</code></pre></div>

<p>还可以在<a href="http://localhost:8002/docs">http://localhost:8002/docs</a>与端点进行交互。</p>
<h3 id="test">试验</h3>
<p>将以下测试添加到名为<em> src/tests/test_notes.py </em>的新测试文件中:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">app.api</span> <span class="kn">import</span> <span class="n">crud</span>


<span class="k">def</span> <span class="nf">test_create_note</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">test_request_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"something else"</span><span class="p">}</span>
    <span class="n">test_response_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"something else"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_post</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"post"</span><span class="p">,</span> <span class="n">mock_post</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/notes/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_request_payload</span><span class="p">),)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_response_payload</span>


<span class="k">def</span> <span class="nf">test_create_note_invalid_json</span><span class="p">(</span><span class="n">test_app</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/notes/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">}))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
</code></pre></div>

<p>这个测试使用pytest <a href="https://docs.pytest.org/en/latest/how-to/monkeypatch.html"> monkeypatch </a>夹具来模拟<code>crud.post</code>函数。然后，我们断言端点用预期的状态代码和响应体进行响应。</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web pytest .

<span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">3</span> items

tests/test_notes.py ..                                                      <span class="o">[</span> <span class="m">66</span>%<span class="o">]</span>
tests/test_ping.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span> <span class="m">3</span> passed <span class="k">in</span> <span class="m">0</span>.08s <span class="o">================================</span>
</code></pre></div>

<p>这样，我们就可以使用测试驱动开发来配置剩余的CRUD路径。</p>
<div class="codehilite"><pre><span/><code>fastapi-crud
    ├── docker-compose.yml
    └── src
        ├── Dockerfile
        ├── app
        │   ├── __init__.py
        │   ├── api
        │   │   ├── __init__.py
        │   │   ├── crud.py
        │   │   ├── models.py
        │   │   ├── notes.py
        │   │   └── ping.py
        │   ├── db.py
        │   └── main.py
        ├── requirements.txt
        └── tests
            ├── __init__.py
            ├── conftest.py
            ├── test_notes.py
            └── test_ping.py
</code></pre></div>

<h2 id="get-routes">获取路线</h2>
<h3 id="test_1">试验</h3>
<p>将以下测试添加到<em> src/tests/test_notes.py </em>中:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_read_note</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"something else"</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_data</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/notes/1"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_data</span>


<span class="k">def</span> <span class="nf">test_read_note_incorrect_id</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/notes/999"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"detail"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Note not found"</span>
</code></pre></div>

<p>他们应该失败:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">5</span> items

tests/test_notes.py ..FF                                                    <span class="o">[</span> <span class="m">80</span>%<span class="o">]</span>
tests/test_ping.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">====================================</span> <span class="nv">FAILURES</span> <span class="o">=====================================</span>
_________________________________ test_read_note __________________________________

<span class="nv">test_app</span> <span class="o">=</span> &lt;starlette.testclient.TestClient object at 0x7f29072dc390&gt;
<span class="nv">monkeypatch</span> <span class="o">=</span> &lt;_pytest.monkeypatch.MonkeyPatch object at 0x7f290734d5d0&gt;

    def test_read_note<span class="o">(</span>test_app, monkeypatch<span class="o">)</span>:
        <span class="nv">test_data</span> <span class="o">=</span> <span class="o">{</span><span class="s2">"id"</span>: <span class="m">1</span>, <span class="s2">"title"</span>: <span class="s2">"something"</span>, <span class="s2">"description"</span>: <span class="s2">"something else"</span><span class="o">}</span>

        async def mock_get<span class="o">(</span>id<span class="o">)</span>:
            <span class="k">return</span> test_data

&gt;       monkeypatch.setattr<span class="o">(</span>crud, <span class="s2">"get"</span>, mock_get<span class="o">)</span>
E       AttributeError: &lt;module <span class="s1">'app.api.crud'</span> from <span class="s1">'/usr/src/app/app/api/crud.py'</span>&gt; has no attribute <span class="s1">'get'</span>

tests/test_notes.py:35: AttributeError
___________________________ test_read_note_incorrect_id ___________________________

<span class="nv">test_app</span> <span class="o">=</span> &lt;starlette.testclient.TestClient object at 0x7f29072dc390&gt;
<span class="nv">monkeypatch</span> <span class="o">=</span> &lt;_pytest.monkeypatch.MonkeyPatch object at 0x7f290729ead0&gt;

    def test_read_note_incorrect_id<span class="o">(</span>test_app, monkeypatch<span class="o">)</span>:
        async def mock_get<span class="o">(</span>id<span class="o">)</span>:
            <span class="k">return</span> None

&gt;       monkeypatch.setattr<span class="o">(</span>crud, <span class="s2">"get"</span>, mock_get<span class="o">)</span>
E       AttributeError: &lt;module <span class="s1">'app.api.crud'</span> from <span class="s1">'/usr/src/app/app/api/crud.py'</span>&gt; has no attribute <span class="s1">'get'</span>

tests/test_notes.py:46: <span class="nv">AttributeError</span>
<span class="o">=============================</span> short <span class="nb">test</span> summary <span class="nv">info</span> <span class="o">=============================</span>
FAILED tests/test_notes.py::test_read_note - AttributeError: &lt;module <span class="s1">'app.api.crud'</span> from <span class="s1">'/usr/src/app/app/api/crud.py'</span>&gt; ha...
FAILED tests/test_notes.py::test_read_note_incorrect_id - AttributeError: &lt;module <span class="s1">'app.api.crud'</span> from <span class="s1">'/usr/src/app/app/api/crud.py'</span>&gt; ha...
<span class="o">===========================</span> <span class="m">2</span> failed, <span class="m">3</span> passed <span class="k">in</span> <span class="m">0</span>.11s <span class="o">===========================</span>
</code></pre></div>

<h3 id="code_1">密码</h3>
<p>将处理函数添加到<em> src/app/api/notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_note</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">note</span>
</code></pre></div>

<p>这里，处理程序需要一个来自路径的整数<code>id</code>,而不是一个有效载荷——例如/notes/5/。</p>
<p>将<code>get</code>实用函数添加到<em> crud.py </em>中:</p>
<div class="codehilite"><pre><span/><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="n">notes</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<p>在继续之前，确保测试通过，并使用curl或HTTPie和/或通过API文档在浏览器中手动测试新端点。</p>
<h3 id="test_2">试验</h3>
<p>接下来，添加一个阅读所有笔记的测试:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_read_all_notes</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"something else"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"someone"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"someone else"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get_all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">test_data</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get_all"</span><span class="p">,</span> <span class="n">mock_get_all</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/notes/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_data</span>
</code></pre></div>

<p>同样，确保测试失败。</p>
<h3 id="code_2">密码</h3>
<p>将处理函数添加到<em> src/app/api/notes.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">NoteDB</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_all_notes</span><span class="p">():</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span>
</code></pre></div>

<p>从Python的类型模块导入<a href="https://docs.python.org/3/library/typing.html#typing.List">列表</a>:</p>


<p><code>response_model</code>是一个带有<code>NoteDB</code>子类型的<code>List</code>。</p>
<p>添加CRUD实用程序:</p>
<div class="codehilite"><pre><span/><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_all</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<p>确保自动化测试通过。也手动测试这个端点。</p>
<h2 id="put-route">放置路线</h2>
<h3 id="test_3">试验</h3>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_update_note</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">test_update_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"someone"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"someone else"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_put</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"put"</span><span class="p">,</span> <span class="n">mock_put</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"/notes/1/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_update_data</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_update_data</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">"id, payload, status_code"</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">999</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">404</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update_note_invalid</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">"/notes/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status_code</span>
</code></pre></div>

<p>这个测试使用pytest <a href="https://docs.pytest.org/en/latest/how-to/parametrize.html">参数化</a>装饰器来参数化<code>test_update_note_invalid</code>函数的参数。</p>
<h3 id="code_3">密码</h3>
<p>处理人:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">NoteSchema</span><span class="p">):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>

    <span class="n">note_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">response_object</span>
</code></pre></div>

<p>实用工具:</p>
<div class="codehilite"><pre><span/><code><span class="k">async</span> <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">NoteSchema</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">notes</span>
        <span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="n">notes</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<h2 id="delete-route">删除路线</h2>
<h3 id="test_4">试验</h3>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_remove_note</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"something else"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_data</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_delete</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">mock_delete</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/notes/1/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_data</span>


<span class="k">def</span> <span class="nf">test_remove_note_incorrect_id</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/notes/999/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"detail"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Note not found"</span>
</code></pre></div>

<h3 id="code_4">密码</h3>
<p>处理人:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">note</span>
</code></pre></div>

<p>实用工具:</p>
<div class="codehilite"><pre><span/><code><span class="k">async</span> <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="n">notes</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

<p>确保所有测试都通过:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">12</span> items

tests/test_notes.py ...........                                             <span class="o">[</span> <span class="m">91</span>%<span class="o">]</span>
tests/test_ping.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span> <span class="m">12</span> passed <span class="k">in</span> <span class="m">0</span>.13s <span class="o">================================</span>
</code></pre></div>

<h2 id="additional-validation">附加验证</h2>
<p>让我们为路由添加一些额外的验证，检查:</p>
<ol>
<li>对于读取单个笔记、更新笔记和删除笔记，<code>id</code>大于0</li>
<li>来自请求有效负载的<code>title</code>和<code>description</code>字段必须具有长度&gt; = 3和&lt; = 50，以便添加和更新注释</li>
</ol>
<h3 id="get">得到</h3>
<p>更新<code>test_read_note_incorrect_id</code>测试:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_read_note_incorrect_id</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/notes/999"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"detail"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Note not found"</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/notes/0"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
</code></pre></div>

<p>测试应该会失败:</p>
<div class="codehilite"><pre><span/><code>&gt;       assert response.status_code <span class="o">==</span> <span class="m">422</span>
E       assert <span class="nv">404</span> <span class="o">==</span> <span class="m">422</span>
E        +  where <span class="nv">404</span> <span class="o">=</span> &lt;Response <span class="o">[</span><span class="m">404</span><span class="o">]</span>&gt;.status_code
</code></pre></div>

<p>更新处理程序:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">read_note</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">),):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">note</span>
</code></pre></div>

<p>确保导入<code>Path</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Path</span>
</code></pre></div>

<p>因此，我们向带有路径的参数<a href="https://fastapi.tiangolo.com/tutorial/path-params-numeric-validations/">添加了以下元数据:</a></p>
<ol>
<li><code>...</code> -该值是必需的(<a href="https://docs.python.org/3/library/constants.html#Ellipsis">省略号</a>)</li>
<li><code>gt</code> -该值必须大于 0的<a href="https://fastapi.tiangolo.com/tutorial/path-params-numeric-validations/#number-validations-greater-than-or-equal"/></li>
</ol>
<p>测试应该会通过。也尝试一下API文档:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-crud/swagger_ui_2.png" loading="lazy" class="lazyload" alt="swagger ui" src="../Images/c66c82be06efcb3405b2fb9eb48a4bcd.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-crud/swagger_ui_2.png"/></p>
<h3 id="post">邮政</h3>
<p>更新<code>test_create_note_invalid_json</code>测试:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_create_note_invalid_json</span><span class="p">(</span><span class="n">test_app</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/notes/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"something"</span><span class="p">}))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/notes/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"2"</span><span class="p">}))</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
</code></pre></div>

<p>为了让测试通过，像这样更新<code>NoteSchema</code>模型:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">NoteSchema</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div>

<p>在这里，我们用<a href="https://fastapi.tiangolo.com/tutorial/body-fields/">字段</a>向Pydantic模型添加了额外的验证。它的工作原理和<code>Path</code>一样。</p>
<p>添加导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</code></pre></div>

<h3 id="put">放</h3>
<p>向<code>test_update_note_invalid</code>添加三个场景:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">"id, payload, status_code"</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">999</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">404</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">},</span> <span class="mi">422</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"bar"</span><span class="p">},</span> <span class="mi">422</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_update_note_invalid</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">"/notes/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">status_code</span>
</code></pre></div>

<p>处理人:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_note</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">NoteSchema</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">),):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>

    <span class="n">note_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">response_object</span>
</code></pre></div>

<h3 id="delete">删除</h3>
<p>测试:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">test_remove_note_incorrect_id</span><span class="p">(</span><span class="n">test_app</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mock_get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">crud</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="n">mock_get</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/notes/999/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"detail"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Note not found"</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">test_app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/notes/0/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
</code></pre></div>

<p>处理人:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">"/</span><span class="si">{id}</span><span class="s2">/"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">NoteDB</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_note</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)):</span>
    <span class="n">note</span> <span class="o">=</span> <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Note not found"</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">crud</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">note</span>
</code></pre></div>

<p>测试应该通过:</p>
<div class="codehilite"><pre><span/><code><span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform linux -- Python <span class="m">3</span>.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /usr/src/app
plugins: anyio-3.6.2
collected <span class="m">15</span> items

tests/test_notes.py ..............                                          <span class="o">[</span> <span class="m">93</span>%<span class="o">]</span>
tests/test_ping.py .                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span> <span class="m">15</span> passed <span class="k">in</span> <span class="m">0</span>.14s <span class="o">================================</span>
</code></pre></div>

<h2 id="synchronous-example">同步示例</h2>
<p>我们为这个API构建了一个同步版本，因此您可以比较这两个模型。您可以从<a href="https://github.com/testdrivenio/fastapi-crud-sync"> fastapi-crud-sync </a> repo中获取代码。尝试用<a href="https://en.wikipedia.org/wiki/ApacheBench"> ApacheBench </a>对这两个版本进行一些性能测试。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何使用测试驱动开发，用FastAPI、Postgres、pytest和Docker开发和测试异步API。</p>
<p>凭借Flask般的简单性、Django般的电池和Go/Node般的性能，FastAPI是一个强大的框架，使构建RESTful APIs变得简单而有趣。通过回顾本教程开头的目标和下面的每个挑战来检查你的理解。</p>
<p>想要更多的挑战吗？</p>
<ol>
<li>复习官方<a href="https://fastapi.tiangolo.com/tutorial/">教程</a>。这本书很长，但很值得一读。</li>
<li>实现<a href="https://fastapi.tiangolo.com/tutorial/background-tasks/">异步后台任务</a>、<a href="https://fastapi.tiangolo.com/tutorial/sql-databases/#migrations">数据库迁移</a>和<a href="https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/">授权</a>。</li>
<li>将应用程序配置提取到单独的文件中。</li>
<li>在生产环境中，您可能想让Gunicorn来管理Uvicorn。查看<a href="https://www.uvicorn.org/#running-with-gunicorn">与Gunicorn </a>一起运行和<a href="https://fastapi.tiangolo.com/deployment/">部署</a>指南了解更多信息。看看官方的<a href="https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker">uvicon-guni corn-fastapi</a>Docker图片。</li>
<li>最后，查看<a href="/courses/tdd-fastapi/">测试驱动开发与FastAPI和Docker </a>课程以及我们的其他<a href="/courses/topics/fastapi/"> FastAPI课程</a>了解更多！</li>
</ol>
<p>您可以在<a href="https://github.com/testdrivenio/fastapi-crud-async"> fastapi-crud-async </a> repo中找到源代码。感谢阅读！</p>
  </div>

  </div>    
</body>
</html>