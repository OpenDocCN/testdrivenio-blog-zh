<html>
<head>
<title>Sending Confirmation Emails with Flask, Redis Queue, and Amazon SES </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Flask、Redis Queue和Amazon SES发送确认电子邮件</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/sending-confirmation-emails-with-flask-rq-and-ses/#0001-01-01">https://testdriven.io/blog/sending-confirmation-emails-with-flask-rq-and-ses/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>对于大多数web应用程序，在新用户注册后，确认用户提供了他们有权访问的有效电子邮件地址是很重要的。这不仅有助于防止垃圾邮件发送者创建假帐户，而且还为您的应用程序提供了额外的安全层。</p>
<p>例如，在没有首先验证电子邮件地址的情况下，您永远不要发送密码重置电子邮件。假设一个新用户在注册流程中输入了错误的电子邮件地址，并且该用户试图发送一封重置密码的电子邮件。最好的情况是，用户根本收不到邮件。在最坏的情况下，密码重置电子邮件将转到一个有效的电子邮件地址，不属于该用户，他们的帐户就很容易受到威胁。</p>
<p>本教程着眼于如何向Flask、Redis Queue (RQ)和Amazon SES (SES)的新注册用户发送确认电子邮件。</p>
<blockquote>
<p>虽然本教程使用了RQ和ses，但重要的是要关注本教程中的概念和模式，而不是所使用的特定工具和技术。通过使用不同的任务队列(如Celery)和/或事务性电子邮件服务(如SendGrid或Mailgun)来检查你的理解。</p>
</blockquote>



<h2 id="objectives">目标</h2>
<p>完成本教程后，您将能够:</p>
<ol>
<li>讨论整个客户端/服务器电子邮件确认工作流程。</li>
<li>描述什么是电子邮件确认，以及为什么你想在你的申请注册流程中使用它。</li>
<li>将Redis队列集成到Flask应用程序中，并创建任务。</li>
<li>用容器装烧瓶并用码头工人重新分发。</li>
<li>使用单独的工作进程在后台运行长时间运行的任务。</li>
<li>使用itsdangerous模块对令牌进行编码和解码。</li>
<li>通过Boto3与AWS API交互。</li>
<li>使用亚马逊简单电子邮件服务(SES)发送交易电子邮件。</li>
</ol>
<h2 id="project-setup">项目设置</h2>
<p>要按照本教程编写代码，请克隆基础项目:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://github.com/testdrivenio/flask-ses-rq --branch base --single-branch
$ <span class="nb">cd</span> flask-ses-rq
</code></pre></div>

<p>快速检查代码和整个项目结构:</p>
<div class="codehilite"><pre><span/><code>├── Dockerfile
├── docker-compose.yml
├── manage.py
├── project
│   ├── __init__.py
│   ├── client
│   │   ├── static
│   │   │   ├── main.css
│   │   │   └── main.js
│   │   └── templates
│   │       ├── _base.html
│   │       ├── footer.html
│   │       └── home.html
│   ├── db
│   │   ├── Dockerfile
│   │   └── create.sql
│   ├── server
│   │   ├── __init__.py
│   │   ├── config.py
│   │   ├── main
│   │   │   ├── __init__.py
│   │   │   ├── forms.py
│   │   │   └── views.py
│   │   └── models.py
│   └── tests
│       ├── __init__.py
│       ├── base.py
│       ├── helpers.py
│       ├── test__config.py
│       └── test_main.py
└── requirements.txt
</code></pre></div>

<p>然后，启动应用程序:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<blockquote>
<p>本教程使用Docker版本20.10.10。</p>
</blockquote>
<p>创建数据库表:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose run users python manage.py create_db
</code></pre></div>

<p>在浏览器中导航至<a href="http://localhost:5003"> http://localhost:5003 </a>。您应该看到:</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/base.png" loading="lazy" class="lazyload" alt="base project" src="../Images/b2b27615b2ba897f55d4f5d336ca0b6e.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/base.png"/></p>
<p>确保您可以添加新用户:</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/register.png" loading="lazy" class="lazyload" alt="register a new user" src="../Images/ee1b9fc219c62fdcbc1301a32357b885.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/register.png"/></p>
<p>运行测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose run users python manage.py <span class="nb">test</span>

----------------------------------------------------------------------
Ran <span class="m">8</span> tests <span class="k">in</span> <span class="m">0</span>.225s

OK
</code></pre></div>

<h2 id="workflow">工作流程</h2>
<p>以下是我们将使用的工作流程:</p>
<ol>
<li>一个新用户提交注册表单，该表单向服务器端发送POST请求。</li>
<li>在Flask视图中，在新用户成功添加到数据库之后，一个新任务被添加到队列中，并且一个响应被发送回最终用户，指示他们需要通过电子邮件确认他们的注册。</li>
<li>在后台，一个工作进程选择任务，生成一个惟一的链接，并向Amazon SES发送一个发送确认电子邮件的请求。</li>
<li>然后，最终用户可以通过单击唯一链接，从自己的邮箱中确认电子邮件。</li>
<li>当用户单击链接时，GET请求被发送到服务器端，服务器端更新数据库中的用户记录。</li>
</ol>
<blockquote>
<p>如果你试图将电子邮件确认整合到现有的应用程序中，上述工作流程将根据你的应用程序的流程而有所不同。在学习本教程时，请记住这一点。</p>
</blockquote>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/email-confirmation-flow.png" loading="lazy" class="lazyload" alt="email confirmation flow" src="../Images/d7653c181ff226d1f5e555d7edcd776e.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/email-confirmation-flow.png"/></p>
<p>最终应用程序正在运行:</p>
<p><img data-src="/static/images/gifs/blog/flask-rq-ses/email-confirm.gif" loading="lazy" class="lazyload" alt="final app" src="../Images/4dc5b01aa6b6274d58a1c85fe8a58738.png" data-original-src="https://testdriven.io/static/images/gifs/blog/flask-rq-ses/email-confirm.gif"/></p>
<h2 id="redis-queue">重复队列</h2>
<p>首先，让我们连接任务队列！</p>
<h3 id="docker">码头工人</h3>
<p>首先启动两个新流程:Redis和一个worker。像这样更新<em> docker-compose.yml </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">users</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users</span><span class="w"/>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5003:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py run -h 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">APP_SETTINGS=project.server.config.DevelopmentConfig</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://postgres:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c6b6a9b5b2a1b4a3b586b3b5a3b4b5eba2a4">[email protected]</a>:5432/users_dev</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_TEST_URL=postgresql://postgres:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="70001f0304170215033005031502035d1412">[email protected]</a>:5432/users_test</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=my_precious</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">users-db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./project/db</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=postgres</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span><span class="w"/>

<span class="w">  </span><span class="nt">worker</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py run_worker</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">APP_SETTINGS=project.server.config.DevelopmentConfig</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://postgres:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="eb9b84989f8c998e98ab9e988e9998c68f89">[email protected]</a>:5432/users_dev</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_TEST_URL=postgresql://postgres:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1767786463706572645762647265643a7375">[email protected]</a>:5432/users_test</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=my_precious</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="w"/>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:6-alpine</span><span class="w"/>
</code></pre></div>

<p>将依赖项添加到<em> requirements.txt </em>:</p>


<h3 id="task">工作</h3>
<p>在“project/server/main”中的一个名为<em> tasks.py </em>的文件中添加一个新任务:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/server/main/tasks.py</span>


<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">project.server</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.server.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># simulate long-running process</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email_sent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>这里，我们模拟了一个长时间运行的流程，然后将<code>User</code>模型中的<code>email_sent</code>字段更新为<code>True</code>。我们将很快用发送电子邮件的实际功能取代<code>time.sleep(10)</code>。</p>
<blockquote>
<p><code>email_sent</code>设置为<code>True</code>后，用户技术上注册但“未确认”。此时，允许用户做什么？换句话说，那个用户对你的应用程序有完全的访问权限，某种形式的受限访问权限，还是根本没有访问权限？想想你会如何在你的应用程序中处理这个问题。</p>
</blockquote>
<p>更新视图以连接到Redis并对任务进行排队:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@main_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">redis_url</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'REDIS_URL'</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">Connection</span><span class="p">(</span><span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">'Thank you for registering.'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">"main.home"</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">'Sorry. That email already exists.'</span><span class="p">,</span> <span class="s1">'danger'</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'home.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">)</span>
</code></pre></div>

<p>更新导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> \
    <span class="n">redirect</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">rq</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project.server</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.server.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.server.main.forms</span> <span class="kn">import</span> <span class="n">RegisterForm</span>
<span class="kn">from</span> <span class="nn">project.server.main.tasks</span> <span class="kn">import</span> <span class="n">send_email</span>
</code></pre></div>

<p>将配置添加到<em> project/server/config.py </em>中的<code>BaseConfig</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">BaseConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Base configuration."""</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'SECRET_KEY'</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">WTF_CSRF_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">REDIS_URL</span> <span class="o">=</span> <span class="s1">'redis://redis:6379/0'</span>
    <span class="n">QUEUES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'default'</span><span class="p">]</span>
</code></pre></div>

<p>注意，我们在<code>REDIS_URL</code>中引用了<code>redis</code>服务，在<em> docker-compose.yml </em>中定义，而不是<code>localhost</code>。查看Docker Compose <a href="https://docs.docker.com/compose/networking/">文档</a>以获得更多关于通过主机名别名连接到其他服务的信息。</p>
<h3 id="worker">工人</h3>
<p>接下来，让我们向<em> manage.py </em>添加一个自定义CLI命令来触发worker进程，该进程用于处理我们添加到队列中的任务:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">'run_worker'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_worker</span><span class="p">():</span>
    <span class="n">redis_url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'REDIS_URL'</span><span class="p">]</span>
    <span class="n">redis_connection</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Connection</span><span class="p">(</span><span class="n">redis_connection</span><span class="p">):</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'QUEUES'</span><span class="p">])</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="p">()</span>
</code></pre></div>

<p>不要忘记进口:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">rq</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">Worker</span>
</code></pre></div>

<h3 id="test">试验</h3>
<p>旋转新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>要触发新任务，请注册一个新用户。<code>Confirm Email Sent?</code>应该是<code>False</code>:</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/register2.png" loading="lazy" class="lazyload" alt="register a new user" src="../Images/e30d073cb3a002ed85ddf7e5baa0eba8.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/register2.png"/></p>
<p>然后，十秒钟后刷新页面。<code>Confirm Email Sent?</code>现在应该是<code>True</code>，因为任务已经完成，数据库也已经更新。</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/register3.png" loading="lazy" class="lazyload" alt="register a new user" src="../Images/d1549b64cfaf28e1438da48cbc3d0f51.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/register3.png"/></p>
<h2 id="email-confirmation">电子邮件确认</h2>
<p>接下来，让我们从模板开始添加确认电子邮件地址的逻辑。</p>
<h3 id="email-template">电子邮件模板</h3>
<p>我们可以使用<a href="http://jinja.pocoo.org/"> Jinja </a>在服务器上生成模板。</p>
<div class="codehilite"><pre><span/><code><span class="x">Thanks for signing up. Please follow the link to activate your account.</span>
<span class="cp">{{</span> <span class="nv">confirm_url</span> <span class="cp">}}</span><span class="x"/>

<span class="x">Cheers!</span>
</code></pre></div>

<p>将上述文本保存到“项目/客户端/模板”中一个名为<em> email.txt </em>的新文件中。</p>
<blockquote>
<p>目前，我们只会发送一封纯文本电子邮件。你可以随意添加HTML(基本的和/或丰富的)。</p>
</blockquote>
<h3 id="unique-url">唯一URL</h3>
<p>接下来，让我们添加一些辅助函数来编码和解码令牌，这将为生成唯一的确认URL奠定基础。</p>
<p>将名为<em> utils.py </em>的新文件添加到“项目/服务器/main”中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/server/main/utils.py</span>


<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">url_for</span>


<span class="k">def</span> <span class="nf">encode_token</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SECRET_KEY'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s1">'email-confirm-salt'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SECRET_KEY'</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">salt</span><span class="o">=</span><span class="s1">'email-confirm-salt'</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="n">expiration</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">email</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">generate_url</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>这里发生了什么事？</p>
<ol>
<li><code>encode_token</code>利用<a href="https://itsdangerous.palletsprojects.com/">的危险</a>包中的<code>URLSafeTimedSerializer</code>类来编码令牌中的电子邮件地址和时间戳。</li>
<li><code>decode_token</code>然后解码令牌并返回电子邮件地址，只要令牌不超过3600秒(一小时)。</li>
<li><code>generate_url</code>接受一个端点和一个编码的令牌，然后返回一个唯一的URL。(没错，这是单行函数！这使得测试更加容易。)</li>
</ol>
<blockquote>
<p>因为默认情况下，<code>url_for</code>创建相对URL，所以我们将<code>_external</code>设置为<code>True</code>来生成绝对URL。如果这是在Flask请求上下文之外创建的，您需要在应用配置<em>和</em>中定义一个<code>SERVER_NAME</code>来提供对应用上下文的访问，以使用绝对URL。一旦设置了一个<code>SERVER_NAME</code>，Flask就只能<em>服务来自那个域的请求。查看以下<a href="https://github.com/pallets/flask/issues/998">问题</a>了解更多信息。</em></p>
</blockquote>
<p>让我们添加一些快速测试，以确保令牌的编码和解码以及惟一URL的生成按预期进行。</p>
<p><em> test_utils.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># project/server/tests/test_utils.py</span>


<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.server.main.utils</span> <span class="kn">import</span> <span class="n">encode_token</span><span class="p">,</span> <span class="n">decode_token</span><span class="p">,</span> <span class="n">generate_url</span>
<span class="kn">from</span> <span class="nn">project.server.models</span> <span class="kn">import</span> <span class="n">User</span>



<span class="k">class</span> <span class="nc">TestUtils</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure encode and decode behave correctly.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2a4e5f4747536a4f474b434604494547">[email protected]</a>'</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3652435b5b4f76535b575f5a1855595b">[email protected]</a>'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_verify_invalid_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure encode and decode behave correctly when token is invalid.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="s1">'invalid'</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_verify_expired_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure encode and decode behave correctly when token has expired.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c8acbda5a5b188ada5a9a1a4e6aba7a5">[email protected]</a>'</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_token_is_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure tokens are unique.</span>
        <span class="n">token1</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8eeafbe3e3f7ceebe3efe7e2a0ede1e3">[email protected]</a>'</span><span class="p">)</span>
        <span class="n">token2</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a3c7d6cecedae3c6cec2cacf918dc0ccce">[email protected]</a>'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">token1</span><span class="p">,</span> <span class="n">token2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_generate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure generate_url behaves as expected.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a0c4d5cdcdd9e0c5cdc1c9cc8ec3cfcd">[email protected]</a>'</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">generate_url</span><span class="p">(</span><span class="s1">'main.home'</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">url_token</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">url_token</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">url_token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f195849c9c88b1949c90989ddf929e9c">[email protected]</a>'</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>运行测试:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose run users python manage.py <span class="nb">test</span>

----------------------------------------------------------------------
Ran <span class="m">13</span> tests <span class="k">in</span> <span class="m">1</span>.305s

OK
</code></pre></div>

<blockquote>
<p>我们错过什么测试了吗？现在添加它们。你会如何模拟使用<code>sleep(1)</code>的测试？看看<a href="https://github.com/spulec/freezegun">冰枪</a>！</p>
</blockquote>
<p>接下来，对视图进行一些更新:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@main_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># add user to the db</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="c1"># generate token, confirm url, and template</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">encode_token</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                <span class="n">confirm_url</span> <span class="o">=</span> <span class="n">generate_url</span><span class="p">(</span><span class="s1">'main.confirm_email'</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'email.txt'</span><span class="p">,</span> <span class="n">confirm_url</span><span class="o">=</span><span class="n">confirm_url</span><span class="p">)</span>
                <span class="c1"># enqueue</span>
                <span class="n">redis_url</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'REDIS_URL'</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">Connection</span><span class="p">(</span><span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">'Thank you for registering.'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">"main.home"</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">'Sorry. That email already exists.'</span><span class="p">,</span> <span class="s1">'danger'</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'home.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">)</span>
</code></pre></div>

<p>确保导入<code>encode_token</code>和<code>generate_url</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">project.server.main.utils</span> <span class="kn">import</span> <span class="n">encode_token</span><span class="p">,</span> <span class="n">generate_url</span>
</code></pre></div>

<p>因此，在将用户添加到数据库之后，我们创建了一个令牌、一个惟一的URL(我们仍然需要为其创建视图)和一个模板。</p>
<p>最后，将<code>body</code>作为参数添加到<code>send_email</code>中:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># simulate long-running process</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email_sent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>我们很快就会用到它。</p>
<h3 id="view">视角</h3>
<p>接下来，让我们添加<code>confirm_email</code>视图来处理令牌，如果合适的话，更新用户模型:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@main_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/confirm/&lt;token&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">confirm_email</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">'The confirmation link is invalid or has expired.'</span><span class="p">,</span> <span class="s1">'danger'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'main.home'</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">'Account already confirmed.'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'main.home'</span><span class="p">))</span>
    <span class="n">user</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">flash</span><span class="p">(</span><span class="s1">'You have confirmed your account. Thanks!'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'main.home'</span><span class="p">))</span>
</code></pre></div>

<p>导入<code>decode_token</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">project.server.main.utils</span> <span class="kn">import</span> <span class="n">encode_token</span><span class="p">,</span> <span class="n">generate_url</span><span class="p">,</span> <span class="n">decode_token</span>
</code></pre></div>

<p>因此，如果解码成功，数据库记录的<code>confirmed</code>字段将更新为<code>True</code>,用户将通过一条成功消息被重定向回主页。</p>
<h3 id="test_1">试验</h3>
<p>要手动测试，首先关闭容器和体积。然后，旋转容器，创建数据库表，并打开<code>worker</code>的Docker日志:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v
$ docker-compose up -d --build
$ docker-compose run users python manage.py create_db
$ docker-compose logs -f worker
</code></pre></div>

<p>然后，从浏览器中添加一个新的电子邮件地址。您应该看到任务成功启动和完成:</p>
<div class="codehilite"><pre><span/><code><span class="m">21</span>:16:49 default: project.server.main.tasks.send_email<span class="o">(</span>
  <span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d7babeb4bfb6b2bb97babfb2a5bab6b9f9b8a5b0">[email protected]</a>'</span>,
  <span class="err">'</span>Thanks <span class="k">for</span> signing up. Please follow the link to activate your account.<span class="se">\n</span>h...
<span class="o">)</span> <span class="o">(</span>af8974f4-c4b7-4db1-ba15-7e2bc57ee058<span class="o">)</span>
<span class="m">21</span>:16:59 default: Job OK <span class="o">(</span>af8974f4-c4b7-4db1-ba15-7e2bc57ee058<span class="o">)</span>
<span class="m">21</span>:16:59 Result is kept <span class="k">for</span> <span class="m">500</span> seconds
</code></pre></div>

<h2 id="amazon-ses">亚马逊的SES</h2>
<p>首先，你为什么想通过Gmail或你自己的电子邮件服务器使用交易型电子邮件服务(比如<a href="https://aws.amazon.com/ses/">亚马逊SES </a>、<a href="https://mailchimp.com/features/transactional-email/"> Mailchimp交易型电子邮件</a>(之前的Mandrill)或<a href="https://www.mailgun.com/"> Mailgun </a>)。</p>
<ol>
<li>速率限制:电子邮件服务提供商，如Gmail、Yahoo、Outlook，有每小时或每天发送邮件的限制。交易型电子邮件服务提供商也有限制，但是要高得多。</li>
<li><em>可送达性</em>:大多数电子邮件服务提供商不允许来自未知IP地址的邮件。此类电子邮件被标记为垃圾邮件，通常不会到达收件箱。因此，如果你从你自己的邮件服务器发送交易邮件，在一个共享的服务器上，这些邮件很可能永远不会被你的用户看到。事务性电子邮件服务与互联网服务提供商和电子邮件服务提供商建立关系，以确保电子邮件顺利及时地送达。</li>
<li><em>分析</em>:交易电子邮件服务提供详细的统计和分析，帮助您提高电子邮件的打开率和点击率。</li>
</ol>
<p>亚马逊SES是一项经济高效的电子邮件服务，旨在发送批量和交易电子邮件。电子邮件可以通过简单邮件传输协议(SMTP)界面直接从SES控制台发送，也可以通过API发送。</p>
<p>在本教程中，我们将使用基于Python的AWS SDK<a href="https://github.com/boto/boto3">boto 3</a>来调用API。</p>
<h3 id="setup">设置</h3>
<p><a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/sign-up-for-aws.html">如果你还没有AWS账户，请注册</a>。</p>
<p>在使用SES发送电子邮件之前，您必须首先<a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">验证</a>您拥有您希望发送的电子邮件地址。导航到<a href="https://console.aws.amazon.com/ses">亚马逊SES </a>，点击侧边栏中的“已验证身份”，然后点击“创建身份”按钮。</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/aws-ses-1.png" loading="lazy" class="lazyload" alt="amazon ses" src="../Images/15aa0897745d711cc58a88a50c24624b.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/aws-ses-1.png"/></p>
<p>在“身份类型”下，选择“电子邮件地址”。输入您想要使用的电子邮件，然后单击“创建身份”。</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/aws-ses-2.png" loading="lazy" class="lazyload" alt="amazon ses" src="../Images/60771b4dac34cc45eb75344f419a5a2b.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/aws-ses-2.png"/></p>
<p>然后，点击电子邮件收件箱中的验证链接后，您应该会看到您的电子邮件在SES上得到验证。</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/aws-ses-3.png" loading="lazy" class="lazyload" alt="amazon ses" src="../Images/a28798697cbee73dbd459809f887dd95.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/aws-ses-3.png"/></p>
<p>为了帮助防止欺诈，新账户会被自动置于沙盒模式，在这种模式下，你只能向你亲自向亚马逊核实过的地址发送电子邮件。幸运的是，这足以让我们将所有东西连接在一起。</p>
<blockquote>
<p>你必须向Amazon请求退出沙盒模式。这可能需要一两天的时间，所以尽快开始。查看<a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html">走出亚马逊SES沙盒</a>了解更多信息。</p>
</blockquote>
<h3 id="email">电子邮件</h3>
<p>回到代码中，将<code>boto3</code>添加到需求文件中:</p>


<p>更新<code>send_email</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="c1"># time.sleep(10)  # simulate long-running process</span>
    <span class="n">ses</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
        <span class="s1">'ses'</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SES_REGION'</span><span class="p">),</span>
        <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AWS_ACCESS_KEY_ID'</span><span class="p">),</span>
        <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AWS_SECRET_ACCESS_KEY'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ses</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span>
        <span class="n">Source</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SES_EMAIL_SOURCE'</span><span class="p">),</span>
        <span class="n">Destination</span><span class="o">=</span><span class="p">{</span><span class="s1">'ToAddresses'</span><span class="p">:</span> <span class="p">[</span><span class="n">email</span><span class="p">]},</span>
        <span class="n">Message</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">'Subject'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'Data'</span><span class="p">:</span> <span class="s1">'Confirm Your Account'</span><span class="p">},</span>
            <span class="s1">'Body'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'Text'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'Data'</span><span class="p">:</span> <span class="n">body</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email_sent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>这里，我们创建了一个新的SES客户机资源，然后尝试发送一封电子邮件。</p>
<p>导入<code>os</code>和<code>boto3</code>:</p>


<p>更新<em> docker-compose.yml </em>中<code>worker</code>的环境变量，确保更新值:</p>
<div class="codehilite"><pre><span/><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SES_REGION=us-east-2</span><span class="w"/>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SES_EMAIL_SOURCE=your_email</span><span class="w"/>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_ACCESS_KEY_ID=your_access_key_id</span><span class="w"/>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_SECRET_ACCESS_KEY=your_secret_access_key</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>值得注意的是，默认情况下，<code>Boto3</code>将检查<code>AWS_ACCESS_KEY_ID</code>和<code>AWS_SECRET_ACCESS_KEY</code>环境变量以获取凭证。因此，在创建SES客户端资源时，我们不需要显式地传递它们。换句话说，只要定义了这些环境变量，我们就可以简化代码:</p>
<div class="codehilite"><pre><span/><span class="n">ses</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'ses'</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SES_REGION'</span><span class="p">))</span>
</pre></div><p>关于这方面的更多信息，请查看官方Boto3 <a href="http://boto3.readthedocs.io/en/latest/guide/configuration.html">文档</a>。</p></blockquote>

<h3 id="test_2">试验</h3>
<p>更新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>然后，从浏览器注册一个用户，确保使用与SES相同的电子邮件。您应该会在收件箱中看到一封确认邮件。点击链接，您应该会被重定向回<a href="http://localhost:5003"> http://localhost:5003 </a>。</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/confirm1.png" loading="lazy" class="lazyload" alt="email confirm" src="../Images/2e45e5d323a7a510df2c7e38c3f46427.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/confirm1.png"/></p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/confirm2.png" loading="lazy" class="lazyload" alt="email confirm" src="../Images/e03cee0e2b77e7f5615a3c4899a880e5.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/confirm2.png"/></p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/confirm3.png" loading="lazy" class="lazyload" alt="email confirm" src="../Images/03758801000f3d2bbbe4fb4741724809.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/confirm3.png"/></p>
<p>记住:如果你仍然处于沙盒模式，你只能发送电子邮件到验证过的地址。如果您尝试向未经验证的地址发送电子邮件，任务将会失败:</p>
<div class="codehilite"><pre><span/><code>raise error_class<span class="o">(</span>parsed_response, operation_name<span class="o">)</span>
botocore.errorfactory.MessageRejected: An error occurred <span class="o">(</span>MessageRejected<span class="o">)</span> when calling the SendEmail operation:
Email address is not verified. The following identities failed the check <span class="k">in</span> region US-EAST-2: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bdd9d8d0d2fdc8ced8cf93ded2d0">[email protected]</a>
</code></pre></div>

<p>此外，由于您可能使用单个电子邮件地址进行测试，您可能希望删除模型上的唯一约束。否则，您需要在两次测试之间从数据库中删除用户。</p>
<div class="codehilite"><pre><span/><code><span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<p>虽然惟一的约束是<code>False</code>，但是您可能还想确保来自<code>confirm_email</code>视图的以下代码有效:</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
    <span class="n">flash</span><span class="p">(</span><span class="s1">'Account already confirmed.'</span><span class="p">,</span> <span class="s1">'success'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'main.home'</span><span class="p">))</span>
</code></pre></div>

<p>想想如何测试这个？</p>
<ol>
<li>在同一个邮箱下注册两个用户</li>
<li>确认其中一个</li>
<li>从数据库中删除未确认的用户</li>
<li>尝试确认其他用户</li>
</ol>
<p>您应该看到:</p>
<p><img data-src="/static/images/blog/flask/flask-rq-ses/duplicate_confirm.png" loading="lazy" class="lazyload" alt="duplicate confirm" src="../Images/87347a67febd2ca5b063ef969236a279.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-rq-ses/duplicate_confirm.png"/></p>
<p>完成测试后，不要忘记将唯一约束添加回去！</p>
<blockquote>
<p>有关我们通过<code>Boto3</code>在SES上发送电子邮件的过程的更多信息，请查看<a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-using-sdk-python.html">使用用于Python (Boto) </a>的AWS SDK发送电子邮件指南。</p>
</blockquote>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们详细介绍了如何发送确认电子邮件，新注册的用户必须在他们的帐户被完全激活之前点击。</p>
<p>寻找一些挑战？</p>
<ol>
<li><em> Redis队列</em>:添加RQ Dashboard，一个基于web的Redis队列监控系统。<em>参见<a href="https://testdriven.io/asynchronous-tasks-with-flask-and-redis-queue">带Flask和Redis队列的异步任务</a>了解更多信息。</em></li>
<li><em>电子邮件模板</em>:如上所述，与纯文本电子邮件模板一起，生成确认电子邮件模板的HTML版本。</li>
<li>工具:不喜欢我们正在使用的工具？把Redis队列换成芹菜，或者把SES换成Mailgun。</li>
<li><em>重新发送确认电子邮件</em>:尝试将重新发送确认电子邮件的功能整合到此流程中。</li>
<li><em>密码重置</em>:同样，尝试将通过电子邮件重置密码添加到这个流程中。</li>
<li><em>验证码</em>:想要多一层安全保障？添加验证码或双因素认证(通过短信)。</li>
<li><em>处理失败</em>:如果出现异常会怎样？如果确认邮件发送失败，你可能会失去这个潜在用户。因此，您可能希望设置Redis队列的自动重试策略，以防失败。</li>
</ol>
<p>和往常一样，你可以在<a href="https://github.com/testdrivenio/flask-ses-rq"> repo </a>中找到代码。干杯！</p>
  </div>

  </div>    
</body>
</html>