<html>
<head>
<title>Concurrent Web Scraping with Selenium Grid and Docker Swarm </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>基于Selenium Grid和Docker Swarm的并行Web抓取</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/concurrent-web-scraping-with-selenium-grid-and-docker-swarm/#0001-01-01">https://testdriven.io/blog/concurrent-web-scraping-with-selenium-grid-and-docker-swarm/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何与Selenium Grid和Docker并行运行基于Python和Selenium的web scraper。我们还将了解如何使用Docker Swarm快速扩展DigitalOcean上的Selenium网格，以提高刮刀的效率。最后，我们将创建一个bash脚本，自动启动和关闭数字海洋上的资源。</p>
<p><em>依赖关系</em>:</p>
<ol>
<li>文档v20.10.13</li>
<li>python 3 . 10 . 4版</li>
<li>硒4.1.3版</li>
</ol>



<h2 id="learning-objectives">学习目标</h2>
<p>本教程结束时，您将能够:</p>
<ol>
<li>配置Selenium Grid以使用Docker</li>
<li>通过Docker机器将Selenium网格部署到数字海洋</li>
<li>创建一个Docker集群</li>
<li>在Docker集群上扩展Selenium网格</li>
<li>自动部署Selenium Grid和Docker Swarm</li>
</ol>
<h2 id="getting-started">入门指南</h2>
<p>从使用web抓取脚本克隆基础项目开始，创建并激活一个虚拟环境，并安装依赖项:</p>
<div class="codehilite"><pre><span/><code>$ git clone https://github.com/testdrivenio/selenium-grid-docker-swarm.git --branch base --single-branch
$ <span class="nb">cd</span> selenium-grid-docker-swarm
$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate
<span class="o">(</span>env<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<blockquote>
<p>根据您的环境，上述命令可能会有所不同。</p>
</blockquote>
<p>测试刮刀:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python project/script.py
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code>Scraping random Wikipedia page...
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s1">'url'</span>: <span class="s1">'https://en.wikipedia.org/wiki/Andreas_Reinke'</span>,
    <span class="s1">'title'</span>: <span class="s1">'Andreas Reinke'</span>,
    <span class="s1">'last_modified'</span>: <span class="s1">' This page was last edited on 10 January 2022, at 23:11\xa0(UTC).'</span>
  <span class="o">}</span>
<span class="o">]</span>
Finished!
</code></pre></div>

<p>本质上，该脚本向<a href="https://en.wikipedia.org/wiki/Wikipedia:Random"> Wikipedia:Random </a> - <code>https://en.wikipedia.org/wiki/Special:Random</code> -请求关于随机文章的信息，使用<a href="http://www.seleniumhq.org/projects/webdriver/"> Selenium </a>自动与站点交互，使用<a href="https://www.crummy.com/software/BeautifulSoup/"> Beautiful Soup </a>解析HTML。</p>
<p>它是在<a href="/blog/building-a-concurrent-web-scraper-with-python-and-selenium">用Python和Selenium构建并发Web scraper】教程中构建的Scraper的修改版本。请查看教程以及脚本中的代码以获取更多信息。</a></p>
<h2 id="configuring-selenium-grid">配置Selenium网格</h2>
<p>接下来，让我们启动<a href="https://www.selenium.dev/documentation/en/grid/"> Selenium Grid </a>来简化脚本在多台机器上的并行运行。我们还将使用Docker和Docker Compose以最少的安装和配置来管理这些机器。</p>
<p>向根目录添加一个<em> docker-compose.yml </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">hub</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/hub:4.1.3</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4442:4442</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4443:4443</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4444:4444</span><span class="w"/>

<span class="w">  </span><span class="nt">chrome</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-chrome:4.1.3</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_HOST=hub</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_PUBLISH_PORT=4442</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_SUBSCRIBE_PORT=4443</span><span class="w"/>
</code></pre></div>

<p>这里，我们使用官方的<a href="https://hub.docker.com/r/selenium/"> Selenium Docker </a>图片来建立一个基本的Selenium网格，它由一个hub和一个Chrome节点组成。我们使用了<code>4.1.3</code>标签，它与以下版本的Selenium、WebDriver、Chrome和Firefox相关联:</p>
<ul>
<li>硒:4.1.3</li>
<li>谷歌浏览器</li>
<li>chrome驱动程序:99.0.4844.51</li>
<li>Mozilla Firefox: 98.0.2</li>
<li>壁虎:0 . 3 . 0</li>
</ul>
<blockquote>
<p>想用不同的版本？从<a href="https://github.com/SeleniumHQ/docker-selenium/releases">发布</a>页面中找到合适的标签。</p>
</blockquote>
<p>提取并运行图像:</p>


<p>在您的浏览器中导航到<a href="http://localhost:4444"> http://localhost:4444 </a>以确保hub启动并运行一个Chrome节点:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker/selenium_grid.png" loading="lazy" class="lazyload" alt="selenium grid" src="../Images/66a01654b62d1e99bd25fa6652a6e2ab.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker/selenium_grid.png"/></p>
<p>由于Selenium Hub运行在不同的机器上(在Docker容器中)，我们需要在<em>项目/scrapers/scraper.py </em>中配置远程驱动程序:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">get_driver</span><span class="p">():</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--headless"</span><span class="p">)</span>

    <span class="c1"># initialize driver</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Remote</span><span class="p">(</span>
            <span class="n">command_executor</span><span class="o">=</span><span class="s1">'http://localhost:4444/wd/hub'</span><span class="p">,</span>
            <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">DesiredCapabilities</span><span class="o">.</span><span class="n">CHROME</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">driver</span>
</code></pre></div>

<p>添加导入:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">selenium.webdriver.common.desired_capabilities</span> <span class="kn">import</span> <span class="n">DesiredCapabilities</span>
</code></pre></div>

<p>再次运行刮刀:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python project/script.py
</code></pre></div>

<p>当scraper运行时，您应该看到“Sessions”变为1，表明它正在使用中:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker/selenium_grid_session.png" loading="lazy" class="lazyload" alt="selenium grid running" src="../Images/0afe1967615f66e8fc083b439171ea54.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker/selenium_grid_session.png"/></p>
<h2 id="deploying-to-digitalocean">部署到数字海洋</h2>
<p>如果您还没有DigitalOcean的帐户，请注册该帐户。要使用<a href="https://developers.digitalocean.com/documentation/v2/">数字海洋API </a>，你还需要<a href="https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/">生成</a>一个访问令牌。</p>
<blockquote>
<p>在此获得10美元的数字海洋信用点数<a href="https://m.do.co/c/d8f211a4b4c2">。</a></p>
</blockquote>
<p>将令牌作为环境变量添加:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="nb">export</span> <span class="nv">DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="o">=[</span>your_token<span class="o">]</span>
</code></pre></div>

<p>使用Docker Machine供应新的droplet:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine create <span class="se">\</span>
        --driver digitalocean <span class="se">\</span>
        --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
        --digitalocean-region <span class="s2">"nyc1"</span> <span class="se">\</span>
        --digitalocean-image <span class="s2">"debian-10-x64"</span> <span class="se">\</span>
        --digitalocean-size <span class="s2">"s-4vcpu-8gb"</span> <span class="se">\</span>
        --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
        selenium-hub<span class="p">;</span>
</code></pre></div>

<blockquote>
<p><code>--engine-install-url</code>是必需的，因为在撰写本文时，Docker v20.10.13不能与Docker机器一起使用。</p>
</blockquote>
<p>接下来，将Docker守护进程指向新创建的机器，并将其设置为活动机器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine env selenium-hub
<span class="o">(</span>env<span class="o">)</span>$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env selenium-hub<span class="k">)</span>
</code></pre></div>

<p>旋转液滴上的两个容器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-compose up -d
</code></pre></div>

<p>一旦启动，获取液滴的IP:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine ip selenium-hub
</code></pre></div>

<p>确保Selenium Grid在<a href="http://YOUR_IP:4444"> http://YOUR_IP:4444 </a>打开，然后更新<em>project/scrapers/scraper . py</em>中的IP地址:</p>
<div class="codehilite"><pre><span/><code><span class="n">command_executor</span><span class="o">=</span><span class="s1">'http://YOUR_IP:4444/wd/hub'</span><span class="p">,</span>
</code></pre></div>

<p>运行刮刀:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python project/script.py
</code></pre></div>

<p>同样，导航到网格仪表板并确保会话处于活动状态。您应该在终端中看到以下输出:</p>
<div class="codehilite"><pre><span/><code>Scraping random Wikipedia page...
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s1">'url'</span>: <span class="s1">'https://en.wikipedia.org/wiki/David_Hidalgo'</span>,
    <span class="s1">'title'</span>: <span class="s1">'David Hidalgo'</span>,
    <span class="s1">'last_modified'</span>: <span class="s1">' This page was last edited on 11 November 2021, at 01:24\xa0(UTC).'</span>
  <span class="o">}</span>
<span class="o">]</span>
Finished!
</code></pre></div>

<p>到目前为止，我们只在维基百科上搜集了一篇文章。如果我们想抓取多篇文章呢？</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..21<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">{</span>
          python project/script.py <span class="p">&amp;</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="k">done</span>
        <span class="nb">wait</span>
</code></pre></div>

<p>再次导航到网格仪表板。您应该看到其中一个请求与20个排队请求一起运行:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker/selenium_grid_queue.png" loading="lazy" class="lazyload" alt="selenium grid queue" src="../Images/d526a3fdc1aebccdc3ee8f8b5f28210c.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker/selenium_grid_queue.png"/></p>
<p>因为我们只有一个节点在运行，所以需要一段时间才能完成(在我这边只需要1.5分钟)。我们可以增加几个节点的实例，但是每个节点都必须争用droplet上的资源。最好在几个droplets上部署hub和一些节点。这就是Docker Swarm发挥作用的地方。</p>
<h2 id="running-docker-swarm">运行码头群</h2>
<p>因此，使用<a href="https://docs.docker.com/engine/swarm/"> Docker Swarm </a>(或者“docker swarm mode”，如果你想更准确的话)，我们可以在许多机器上部署单个Selenium网格。</p>
<p>首先在当前机器上初始化Docker Swarm:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker swarm init --advertise-addr <span class="o">[</span>YOUR_IP<span class="o">]</span>
</code></pre></div>

<p>您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code>Swarm initialized: current node <span class="o">(</span>mky1a6z8rjaeaeiucvzyo355l<span class="o">)</span> is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-2136awhbig93jh8xunp8yp2wn0pw9i946dvmfrpi05tnpbxula-633h28mn97sxhbfn8479mmpx5 <span class="m">134</span>.122.20.39:2377

To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.
</code></pre></div>

<p>请注意join命令，因为它包含一个<a href="https://docs.docker.com/edge/engine/reference/commandline/swarm_join-token/">令牌</a>，我们需要它来将工人添加到集群中。</p>
<blockquote>
<p>查看官方<a href="https://docs.docker.com/engine/swarm/join-nodes/#join-as-a-worker-node">文档</a>获取更多关于添加节点到群组的信息。</p>
</blockquote>
<p>接下来，在数字海洋上旋转三个新的水滴:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">;</span> <span class="k">do</span>
            docker-machine create <span class="se">\</span>
              --driver digitalocean <span class="se">\</span>
              --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
              --digitalocean-region <span class="s2">"nyc1"</span> <span class="se">\</span>
              --digitalocean-image <span class="s2">"debian-10-x64"</span> <span class="se">\</span>
              --digitalocean-size <span class="s2">"s-4vcpu-8gb"</span> <span class="se">\</span>
              --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
              node-<span class="nv">$i</span><span class="p">;</span>
        <span class="k">done</span>
</code></pre></div>

<p>然后把它们作为工人加入到蜂群中:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">;</span> <span class="k">do</span>
            docker-machine ssh node-<span class="nv">$i</span> <span class="se">\</span>
              -- docker swarm join --token YOUR_JOIN_TOKEN<span class="p">;</span>
        <span class="k">done</span>
</code></pre></div>

<p>您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">;</span> <span class="k">do</span>
            docker-machine ssh node-<span class="nv">$i</span> <span class="se">\</span>
              -- docker swarm join --token SWMTKN-1-2136awhbig93jh8xunp8yp2wn0pw9i946dvmfrpi05tnpbxula-633h28mn97sxhbfn8479mmpx5 <span class="m">134</span>.122.20.39:2377
        <span class="k">done</span>
This node joined a swarm as a worker.
This node joined a swarm as a worker.
This node joined a swarm as a worker.
</code></pre></div>

<p>更新<em> docker-compose.yml </em>文件，以Swarm模式部署Selenium网格:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">hub</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/hub:4.1.3</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4442:4442</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4443:4443</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4444:4444</span><span class="w"/>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicated</span><span class="w"/>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == worker</span><span class="w"/>

<span class="w">  </span><span class="nt">chrome</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-chrome:4.1.3</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_HOST=hub</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_PUBLISH_PORT=4442</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SE_EVENT_BUS_SUBSCRIBE_PORT=4443</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_MAX_SESSION=1</span><span class="w"/>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'SE_OPTS="--host $$HOSTNAME" /opt/bin/entry_point.sh'</span><span class="w"/>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == worker</span><span class="w"/>
</code></pre></div>

<p>主要变化:</p>
<ol>
<li><em>布局约束</em>:我们设置了<code>node.role == worker</code>的<a href="https://docs.docker.com/engine/swarm/services/#placement-constraints">布局约束</a>，这样所有的任务都将在worker节点上运行。通常最好让管理器节点远离CPU和/或内存密集型任务。</li>
<li><em> Entrypoint </em>:这里，我们更新了<em> entry_point.sh </em> <a href="https://github.com/SeleniumHQ/docker-selenium/blob/4.1.3-20220327/Base/entry_point.sh">脚本</a>中的<code>SE_OPTS</code>中的主机集，这样运行在不同主机上的节点将能够成功链接回hub。</li>
</ol>
<p>这样，我们就可以部署堆栈了:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker stack deploy --compose-file<span class="o">=</span>docker-compose.yml selenium
</code></pre></div>

<p>让我们再添加几个节点:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker service scale <span class="nv">selenium_chrome</span><span class="o">=</span><span class="m">5</span>

selenium_chrome scaled to <span class="m">5</span>
overall progress: <span class="m">5</span> out of <span class="m">5</span> tasks
<span class="m">1</span>/5: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
<span class="m">2</span>/5: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
<span class="m">3</span>/5: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
<span class="m">4</span>/5: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
<span class="m">5</span>/5: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
verify: Service converged
</code></pre></div>

<p>您可以像这样检查堆栈的状态:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker stack ps selenium
</code></pre></div>

<p>您还需要获得运行hub的机器的IP地址:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine ip <span class="k">$(</span>docker service ps --format <span class="s2">"{{.Node}}"</span> selenium_hub<span class="k">)</span>
</code></pre></div>

<p>再次更新<em>project/scrapers/scraper . py</em>中的IP地址:</p>
<div class="codehilite"><pre><span/><code><span class="n">command_executor</span><span class="o">=</span><span class="s1">'http://YOUR_IP:4444/wd/hub'</span><span class="p">,</span>
</code></pre></div>

<p>测试一下:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..21<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">{</span>
          python project/script.py <span class="p">&amp;</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="k">done</span>
        <span class="nb">wait</span>
</code></pre></div>

<p>回到网格仪表板上的<a href="http://YOUR_IP:4444/"> http://YOUR_IP:4444/ </a>，您应该看到五个节点，每个节点运行一个会话。还应该有16个排队的请求:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker/selenium_grid_cluster.png" loading="lazy" class="lazyload" alt="selenium grid cluster" src="../Images/4feae5ed3b20d954ee301bb7cfd82523.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker/selenium_grid_cluster.png"/></p>
<p>这应该运行得更快了。在我这边，花了25秒才跑完。</p>
<h3 id="commands">命令</h3>
<p>想要查看服务吗？</p>


<p>要获得关于Chrome节点的更多信息以及每个节点的运行位置，请运行:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker service ps selenium_chrome
</code></pre></div>

<p>移除服务:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker service rm selenium_chrome
<span class="o">(</span>env<span class="o">)</span>$ docker service rm selenium_hub
</code></pre></div>

<p>旋转水滴:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine rm node-1 node-2 node-3
<span class="o">(</span>env<span class="o">)</span>$ docker-machine rm selenium-hub
</code></pre></div>

<h2 id="automating-the-workflow">自动化工作流程</h2>
<p>现在，我们必须手动上下旋转资源。让我们来自动化这个过程，以便当您想要运行一个刮擦作业时，资源会自动旋转起来，然后被拆除。</p>
<p><em> project/create.sh </em>:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>


<span class="nb">echo</span> <span class="s2">"Spinning up four droplets..."</span>

<span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">;</span> <span class="k">do</span>
    docker-machine create <span class="se">\</span>
        --driver digitalocean <span class="se">\</span>
        --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
        --digitalocean-region <span class="s2">"nyc1"</span> <span class="se">\</span>
        --digitalocean-image <span class="s2">"debian-10-x64"</span> <span class="se">\</span>
        --digitalocean-size <span class="s2">"s-4vcpu-8gb"</span> <span class="se">\</span>
        --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
        node-<span class="nv">$i</span><span class="p">;</span>
<span class="k">done</span>


<span class="nb">echo</span> <span class="s2">"Initializing Swarm mode..."</span>

docker-machine ssh node-1 -- docker swarm init --advertise-addr <span class="k">$(</span>docker-machine ip node-1<span class="k">)</span>


<span class="nb">echo</span> <span class="s2">"Adding the nodes to the Swarm..."</span>

<span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>docker-machine ssh node-1 docker swarm join-token worker <span class="p">|</span> grep token <span class="p">|</span> awk <span class="s1">'{ print $5 }'</span><span class="sb">`</span>

docker-machine ssh node-2 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>
docker-machine ssh node-3 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>
docker-machine ssh node-4 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>


<span class="nb">echo</span> <span class="s2">"Deploying Selenium Grid to http://</span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:4444"</span>

<span class="nb">eval</span> <span class="k">$(</span>docker-machine env node-1<span class="k">)</span>
docker stack deploy --compose-file<span class="o">=</span>docker-compose.yml selenium
docker service scale <span class="nv">selenium_chrome</span><span class="o">=</span><span class="m">5</span>
</code></pre></div>

<p><em> project/destroy.sh </em>:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>


<span class="nb">echo</span> <span class="s2">"Bringing down the services"</span>

docker service rm selenium_chrome
docker service rm selenium_hub


<span class="nb">echo</span> <span class="s2">"Bringing down the droplets"</span>

docker-machine rm node-1 node-2 node-3 node-4 -y
</code></pre></div>

<p>更新<em>项目/scrapers/scraper.py </em>中的<code>get_driver()</code>获取地址:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">get_driver</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--headless"</span><span class="p">)</span>

    <span class="c1"># initialize driver</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Remote</span><span class="p">(</span>
                <span class="n">command_executor</span><span class="o">=</span><span class="sa">f</span><span class="s1">'http://</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1">:4444/wd/hub'</span><span class="p">,</span>
                <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">DesiredCapabilities</span><span class="o">.</span><span class="n">CHROME</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">driver</span>
</code></pre></div>

<p>更新<em> project/script.py </em>中的主块:</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">get_driver</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">run_process</span><span class="p">(</span><span class="n">browser</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Finished!'</span><span class="p">)</span>
</code></pre></div>

<p>考验的时候到了！</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ sh project/create.sh
</code></pre></div>

<p>运行刮刀:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ docker-machine env node-1
<span class="o">(</span>env<span class="o">)</span>$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env node-1<span class="k">)</span>
<span class="o">(</span>env<span class="o">)</span>$ <span class="nv">NODE</span><span class="o">=</span><span class="k">$(</span>docker service ps --format <span class="s2">"{{.Node}}"</span> selenium_hub<span class="k">)</span>
<span class="o">(</span>env<span class="o">)</span>$ <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..21<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">{</span>
          python project/script.py <span class="k">$(</span>docker-machine ip <span class="nv">$NODE</span><span class="k">)</span> <span class="p">&amp;</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="k">done</span>
        <span class="nb">wait</span>
</code></pre></div>

<p>完成后将资源带下来:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ sh project/destroy.sh
</code></pre></div>

<h2 id="next-steps">后续步骤</h2>
<p>尝试这些挑战:</p>
<ol>
<li>目前，我们没有对收集到的数据做任何事情。尝试运行一个数据库，并向抓取脚本添加一个函数，将数据写入数据库。</li>
<li>Selenium还用于基于浏览器的端到端测试。有了Selenium Grid，你可以在不同的操作系统上运行不同版本的Chrome和Firefox。换句话说，你可以运行多个节点，每个节点都有不同版本的Chrome和Firefox，你可以对它们进行测试。自己尝试一下。<em>查看使用Selenium Grid和Docker 的<a href="/blog/distributed-testing-with-selenium-grid">分布式测试教程，看看这是怎么回事！</a></em></li>
<li>将Docker Swarm从混合中分离出来，并添加Kubernetes。</li>
</ol>
<p>和往常一样，你可以在<a href="https://github.com/testdrivenio/selenium-grid-docker-swarm"> repo </a>中找到代码。</p>
  </div>

  </div>    
</body>
</html>