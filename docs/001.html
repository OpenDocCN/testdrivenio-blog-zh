<html>
<head>
<title>Deploying a Django App to Azure App Service </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将Django应用部署到Azure应用服务</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-azure-app-service/#0001-01-01">https://testdriven.io/blog/django-azure-app-service/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何安全地部署一个<a href="https://www.djangoproject.com/"> Django </a>应用到<a href="https://azure.microsoft.com/en-us/products/app-service/"> Azure应用服务</a>。</p>



<h2 id="objectives">目标</h2>
<p>学完本教程后，您应该能够:</p>
<ol>
<li>解释什么是Azure App Service以及它是如何工作的。</li>
<li>将Django应用程序部署到Azure应用程序服务。</li>
<li>在Azure上运行一个Postgres 实例。</li>
<li>用<a href="https://azure.microsoft.com/en-us/products/category/storage/"> Azure Storage </a>设置持久存储。</li>
<li>将自定义域链接到您的web应用程序，并在HTTPS上提供服务。</li>
</ol>
<h2 id="what-is-azure-app-service">什么是Azure App服务？</h2>
<p><a href="https://azure.microsoft.com/en-us/products/app-service/"> Azure App Service </a>允许您快速轻松地为任何平台或设备创建企业级web和移动应用，并将其部署在可扩展且可靠的云基础设施上。它本身支持Python。网，。NET Core，Node.js，Java，PHP，容器。它们具有内置的CI/CD、安全功能和零停机部署。</p>
<p>Azure App Service提供了强大的扩展能力，允许应用程序根据流量和使用模式自动扩展或缩减。Azure还保证了99.95%的SLA。</p>
<p>如果你是新客户，你可以获得200美元的免费积分来测试Azure。</p>
<h3 id="why-app-service">为什么选择App服务？</h3>
<ul>
<li>强大的扩展能力</li>
<li>与Visual Studio很好地集成</li>
<li>通过<a href="https://azure.microsoft.com/services/active-directory/"> Azure Active Directory进行认证</a></li>
<li>内置SSL/TLS证书</li>
<li>监控和警报</li>
</ul>
<h2 id="project-setup">项目设置</h2>
<p>在本教程中，我们将部署一个简单的图像托管应用程序，名为<a href="https://github.com/duplxey/django-images"> django-images </a>。</p>
<blockquote>
<p>在学习教程的过程中，通过部署您自己的Django应用程序来检查您的理解。</p>
</blockquote>
<p>首先，从GitHub 上的<a href="https://github.com/duplxey/django-images">库获取代码。</a></p>


<p>创建新的虚拟环境并激活它:</p>
<div class="codehilite"><pre><span/><code>$ python3 -m venv venv <span class="o">&amp;&amp;</span> <span class="nb">source</span> venv/bin/activate
</code></pre></div>

<p>安装需求并迁移数据库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
<span class="o">(</span>venv<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>打开您最喜欢的网络浏览器，导航到<a href="http://localhost:8000"> http://localhost:8000 </a>。使用右边的表格上传图像，确保一切正常。上传图像后，您应该会看到它显示在表格中:</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/django-images-preview.png" loading="lazy" class="lazyload" alt="django-images Application Preview" src="../Images/72b3f6948042806e3db4099b523d4eea.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/django-images-preview.png"/></p>
<h2 id="configure-django-project">配置Django项目</h2>
<p>在本节教程中，我们将配置Django项目来使用App Service。</p>
<h3 id="environment-variables">环境变量</h3>
<p>我们不应该在源代码中存储秘密，所以让我们利用环境变量。最简单的方法是使用名为<a href="https://saurabh-kumar.com/python-dotenv/"> python-dotenv </a>的第三方Python包。首先将其添加到<em> requirements.txt </em>:</p>


<blockquote>
<p>随意使用不同的包来处理环境变量，如<a href="https://github.com/joke2k/django-environ"> django-environ </a>或<a href="https://github.com/henriquebastos/python-decouple/"> python-decouple </a>。</p>
</blockquote>
<p>对于Django来说，要初始化环境更改，请更新<em> settings.py </em>的顶部，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># Build paths inside the project like this: BASE_DIR / 'subdir'.</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>

<span class="n">load_dotenv</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">'.env'</span><span class="p">)</span>
</code></pre></div>

<p>接下来，从环境中加载<code>SECRET_KEY</code>、<code>DEBUG</code>、<code>ALLOWED_HOSTS</code>和其他设置:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="c1"># SECURITY WARNING: keep the secret key used in production secret!</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SECRET_KEY'</span><span class="p">)</span>

<span class="c1"># SECURITY WARNING: don't run with debug turned on in production!</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'DEBUG'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'true'</span><span class="p">,</span> <span class="s1">'t'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">]</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'ALLOWED_HOSTS'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>
<span class="n">CSRF_TRUSTED_ORIGINS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'CSRF_TRUSTED_ORIGINS'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>

<span class="n">SECURE_SSL_REDIRECT</span> <span class="o">=</span> \
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'SECURE_SSL_REDIRECT'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'true'</span><span class="p">,</span> <span class="s1">'t'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">]</span>
<span class="k">if</span> <span class="n">SECURE_SSL_REDIRECT</span><span class="p">:</span>
    <span class="n">SECURE_PROXY_SSL_HEADER</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'HTTP_X_FORWARDED_PROTO'</span><span class="p">,</span> <span class="s1">'https'</span><span class="p">)</span>
</code></pre></div>

<h3 id="database">数据库ˌ资料库</h3>
<p>要使用Postgres代替SQLite，我们首先需要安装数据库适配器。</p>
<p>将下面一行添加到<em> requirements.txt </em>中:</p>


<p>稍后，当我们启动Postgres实例时，Azure将为我们提供一个数据库连接字符串。它将具有以下格式:</p>
<div class="codehilite"><pre><span/><code><span class="n">dbname</span><span class="o">=&lt;</span><span class="n">db_name</span><span class="o">&gt;</span> <span class="n">host</span><span class="o">=&lt;</span><span class="n">db_host</span><span class="o">&gt;</span> <span class="n">port</span><span class="o">=</span><span class="mi">5432</span> <span class="n">user</span><span class="o">=&lt;</span><span class="n">db_user</span><span class="o">&gt;</span> <span class="n">password</span><span class="o">=&lt;</span><span class="n">db_password</span><span class="o">&gt;</span>
</code></pre></div>

<p>由于这个字符串在Django中使用起来相当笨拙，我们将把它分成以下几个env变量:<code>DBNAME</code>、<code>DBHOST</code>、<code>DBUSER</code>、<code>DBPASS</code>。</p>
<p>导航到<em> core/settings.py </em>并像这样更改<code>DATABASES</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.postgresql'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'DBNAME'</span><span class="p">),</span>
        <span class="s1">'HOST'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'DBHOST'</span><span class="p">),</span>
        <span class="s1">'USER'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'DBUSER'</span><span class="p">),</span>
        <span class="s1">'PASSWORD'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'DBPASS'</span><span class="p">),</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'sslmode'</span><span class="p">:</span> <span class="s1">'require'</span><span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Azure应用服务也需要<code>sslmode</code>，所以一定要启用它。</p>
<h3 id="gunicorn">格尼科恩</h3>
<p>接下来，让我们安装<a href="https://gunicorn.org/"> Gunicorn </a>，这是一个生产级的WSGI服务器，它将用于生产，而不是Django的开发服务器。</p>
<p>添加到<em> requirements.txt </em>:</p>


<p>Django配置到此为止！</p>
<h2 id="deploy-app">部署应用程序</h2>
<p>在教程的这一部分，我们将把web应用部署到Azure App Service。如果你还没有Azure账户，就去注册一个吧。</p>
<h3 id="project-initialization">项目初始化</h3>
<p>从<a href="https://portal.azure.com/">仪表盘</a>中，使用搜索栏搜索“Web App +数据库”。您应该会在“市场”部分看到它:</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-webapp-database-search.png" loading="lazy" class="lazyload" alt="Azure Web App + Database Search" src="../Images/e815aa55097e1f5c80803844d76dc3c1.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-webapp-database-search.png"/></p>
<p>单击它，您应该会被重定向到应用程序创建表单。</p>
<p>使用该表单创建项目、应用程序和数据库。</p>
<h4 id="project-details">项目详情</h4>
<ol>
<li>订阅:<strong>保留默认设置</strong></li>
<li>资源组:<strong> django-images-group </strong></li>
<li>地区:<strong>离你最近的地区</strong></li>
</ol>
<h4 id="web-app-details">Web应用程序详细信息</h4>
<ol>
<li>名称:<strong>姜戈图像</strong></li>
<li>运行时堆栈:<strong> Python 3.11 </strong></li>
</ol>
<h4 id="database_1">数据库ˌ资料库</h4>
<ol>
<li>数据库引擎:<strong> PostgreSQL -灵活服务器</strong></li>
<li>服务器名称:<strong> django-images-db </strong></li>
<li>数据库名称:<strong> django-images </strong></li>
<li>主持:<strong>由你决定</strong></li>
</ol>
<p>填写完所有详细信息后，单击“查看”按钮，然后单击“创建”。</p>
<p>设置大约需要五分钟。完成后，通过单击“转到资源”按钮导航到新创建的资源。</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-app-service-dashboard.png" loading="lazy" class="lazyload" alt="Azure App Service Dashboard" src="../Images/ba5809fd10bba64a0afa50d01bf65537.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-app-service-dashboard.png"/></p>
<p>记下应用程序的URL，因为我们将需要它来配置<code>ALLOWED_HOSTS</code>、<code>CSRF_TRUSTED_ORIGINS</code>和其他一些Django设置。</p>
<h3 id="app-configuration">应用程序配置</h3>
<p>为了让应用程序工作，我们需要添加我们在Django项目中使用的所有环境变量。</p>
<p>导航至您的应用服务应用，并选择边栏上的“设置&gt;配置”。</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-app-service-configuration.png" loading="lazy" class="lazyload" alt="Azure App Service Configuration" src="../Images/267fd5d4e4c8a348945602a1edf7eb0e.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-app-service-configuration.png"/></p>
<p>您会注意到已经添加了一个名为<code>AZURE_POSTGRESQL_CONNECTIONSTRING</code>的应用程序设置。这是因为我们使用了“Web App +数据库”来初始化项目。</p>
<p>连接字符串包含连接到数据库所需的所有信息。如前所述，让我们将其拆分为多个变量，并将它们作为单独的应用程序设置进行添加:</p>
<div class="codehilite"><pre><span/><code>DBNAME=&lt;db_name&gt;
DBHOST=&lt;db_host&gt;
DBUSER=&lt;db_user&gt;
DBPASS=&lt;db_pass&gt;
</code></pre></div>

<p>确保用您的实际凭据替换占位符。</p>
<blockquote>
<p>如果您的密码以<code>$</code>结尾，请确保包含它。那个<code>$</code>是密码的一部分，而不是正则表达式锚。</p>
</blockquote>
<p>接下来，添加以下附加变量:</p>
<div class="codehilite"><pre><span/><code><span class="n">DEBUG</span><span class="o">=</span><span class="mi">1</span><span class="w"/>
<span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">w7a8a</span><span class="nv">@lj8nax7tem0caa2f2rjm2ahsascyf83sa5alyv68vea</span><span class="w"/>
<span class="n">ALLOWED_HOSTS</span><span class="o">=</span><span class="n">localhost</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="w"> </span><span class="o">[</span><span class="n">::1</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;</span><span class="n">your_app_url</span><span class="o">&gt;</span><span class="w"/>
<span class="n">CSRF_TRUSTED_ORIGINS</span><span class="o">=</span><span class="nl">https</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">your_app_url</span><span class="o">&gt;</span><span class="w"/>
<span class="n">SECURE_SSL_REDIRECT</span><span class="o">=</span><span class="mi">0</span><span class="w"/>
</code></pre></div>

<p>确保将<code>&lt;your_app_url&gt;</code>替换为上一步中的应用URL。</p>
<blockquote>
<p>不用担心<code>DEBUG</code>等不安全的设定。我们以后再换！</p>
</blockquote>
<p>添加完所有应用程序设置后，单击“保存”更新并重新启动应用程序服务应用程序。等待一两分钟，让重启完成，然后进入下一步。</p>
<h3 id="deploy-code">部署代码</h3>
<p>要将你的代码部署到Azure App Service，你首先需要将其推送到<a href="https://github.com/"> GitHub </a>、<a href="https://bitbucket.org/product/"> Bitbucket </a>、<a href="https://azure.microsoft.com/en-us/products/devops/repos"> Azure Repos </a>或另一个基于git的版本控制系统。如果你还没有这样做，那就去做吧。</p>
<blockquote>
<p>我们将在本教程中使用GitHub。</p>
</blockquote>
<p>导航至您的应用服务应用，并在侧边栏上选择“部署&gt;部署中心”。选择您想要使用的来源，并使用您的第三方帐户进行鉴定(如果您还没有)。</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-deployment-center.png" loading="lazy" class="lazyload" alt="Azure Deployment Center" src="../Images/3f7daa2053676af1e36a6ad5e2a70363.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-deployment-center.png"/></p>
<p>接下来，填写表格:</p>
<ol>
<li>来源:<strong> GitHub </strong></li>
<li>组织:<strong>您的个人账户或组织</strong></li>
<li>存储库:<strong>您想要部署的存储库</strong></li>
<li>分支:<strong>您想要部署的分支</strong></li>
</ol>
<p>最后，点击“保存”。</p>
<p>Azure现在将设置GitHub动作部署管道，用于部署您的应用程序。从现在开始，每次你把代码推送到选中的分支，你的app都会自动重新部署。</p>
<p>如果你导航到你的GitHub库，你会注意到一个名为。github/工作流”。还会有GitHub动作工作流运行。工作流运行完成后，尝试在您喜爱的web浏览器中访问您的应用程序URL。</p>
<blockquote>
<p>当您第一次访问新部署的应用程序时，应用程序服务可能需要一点时间来“唤醒”。给它几分钟，再试一次。</p>
</blockquote>
<p>如果您的应用程序依赖于数据库迁移，您可能会得到一个错误，因为我们还没有迁移数据库。我们将在下一步中做它。</p>
<h3 id="ssh">嘘</h3>
<p>App Service让我们可以轻松地从浏览器SSH到我们的服务器。</p>
<p>要使用SSH，请导航到您的应用服务应用，然后在边栏上选择“开发工具&gt; SSH”。接下来，单击“Go”按钮。Azure将打开一个新的浏览器窗口，其中包含到服务器的活动SSH连接:</p>
<div class="codehilite"><pre><span/><code>   _____
  /  _  <span class="se">\ </span>__________ _________   ____
 /  /_<span class="se">\ </span> <span class="se">\\</span>___   /  <span class="p">|</span>  <span class="se">\_</span>  __ <span class="se">\_</span>/ __ <span class="se">\</span>
/    <span class="p">|</span>    <span class="se">\/</span>    /<span class="p">|</span>  <span class="p">|</span>  /<span class="p">|</span>  <span class="p">|</span> <span class="se">\/\ </span> ___/
<span class="se">\_</span>___<span class="p">|</span>__  /_____ <span class="se">\_</span>___/ <span class="p">|</span>__<span class="p">|</span>    <span class="se">\_</span>__  &gt;
        <span class="se">\/</span>      <span class="se">\/</span>                  <span class="se">\/</span>
A P P   S E R V I C E   O N   L I N U X

Documentation: http://aka.ms/webapp-linux
Python <span class="m">3</span>.9.16
Note: Any data outside <span class="s1">'/home'</span> is not persisted
<span class="o">(</span>antenv<span class="o">)</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="61130e0e1521575157570700000707075855">[email protected]</a>:/tmp/8db11d9b11cc42a#
</code></pre></div>

<p>让我们迁移数据库并创建一个超级用户:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>antenv<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>antenv<span class="o">)</span>$ python manage.py createsuperuser
</code></pre></div>

<p>不错！此时，您的web应用程序应该完全正常工作。</p>
<h2 id="persistent-storage">持久存储</h2>
<p>Azure应用服务提供了一个短暂的文件系统。这意味着您的数据不是持久的，可能会在应用程序关闭或重新部署时消失。如果你的应用程序需要保留文件，这是非常糟糕的。</p>
<p>要为静态和媒体文件设置持久存储，我们可以使用<a href="https://azure.microsoft.com/en-us/products/category/storage/"> Azure Storage </a>。</p>
<p>导航到你的Azure仪表盘，搜索“Azure Storage”。然后选择“存储帐户”。</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-storage.png" loading="lazy" class="lazyload" alt="Azure Storage Index" src="../Images/72a200e85e8d7cad5ac5a588d7cc7e44.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-storage.png"/></p>
<h3 id="create-storage-account">创建存储帐户</h3>
<p>要使用Azure存储，您首先需要创建一个存储帐户。单击“创建存储帐户”，并使用以下详细信息创建一个新的存储帐户:</p>
<ol>
<li>订阅:<strong>保留默认设置</strong></li>
<li>资源组:<strong> django-images-group </strong></li>
<li>存储帐户名称:<strong>选择一个自定义名称</strong></li>
<li>地区:<strong>与您的应用相同的地区</strong></li>
<li>性能:<strong>由你决定</strong></li>
<li>冗余:<strong>保留默认设置</strong></li>
</ol>
<p>将其他内容保留为默认值，检查并保存。记下存储帐户名，因为我们将在本教程的后面用到它。</p>
<p>成功创建存储帐户后，导航至该帐户。然后在侧边栏选择“安全+网络&gt;访问密钥”并抓取其中一个密钥。</p>
<p><img data-src="/static/images/blog/django/django-azure-app-service/azure-storage-account-key.png" loading="lazy" class="lazyload" alt="Azure Storage Account Key" src="../Images/f80be84bc2a51c5712556a147ec7bcde.png" data-original-src="https://testdriven.io/static/images/blog/django/django-azure-app-service/azure-storage-account-key.png"/></p>
<h3 id="create-containers">创建容器</h3>
<p>为了更好地组织我们的存储，我们将创建两个独立的容器。</p>
<p>首先，导航回“概述”，然后单击“Blob服务”。</p>
<p>继续创建两个容器，一个名为“静态”，另一个名为“媒体”。它们都应该将“公共访问级别”设置为“Blob(仅限Blob的匿名读取访问)”。</p>
<h3 id="configure-app">配置应用程序</h3>
<p>接下来，导航至您的应用程序服务应用程序配置，并添加以下两个应用程序设置:</p>
<div class="codehilite"><pre><span/><code>AZURE_ACCOUNT_NAME=&lt;your_storage_account_name&gt;
AZURE_ACCOUNT_KEY=&lt;your_storage_account_key&gt;
</code></pre></div>

<p>单击“保存”并等待您的应用程序重新启动。</p>
<h3 id="configure-django">配置Django</h3>
<p>为了利用Azure存储，我们将使用一个名为<a href="https://django-storages.readthedocs.io/en/latest/"> django-storages </a>的第三方包。</p>
<p>将以下几行添加到<em> requirements.txt </em></p>
<div class="codehilite"><pre><span/><code>django-storages==1.13.2
azure-core==1.26.3
azure-storage-blob==12.14.1
</code></pre></div>

<p>接下来，转到<em> core/settings.py </em>并更改静态和媒体文件设置，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/settings.py</span>

<span class="n">DEFAULT_FILE_STORAGE</span> <span class="o">=</span> <span class="s1">'core.azure_storage.AzureMediaStorage'</span>
<span class="n">STATICFILES_STORAGE</span> <span class="o">=</span> <span class="s1">'core.azure_storage.AzureStaticStorage'</span>

<span class="n">AZURE_ACCOUNT_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_NAME'</span><span class="p">)</span>
<span class="n">AZURE_ACCOUNT_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_KEY'</span><span class="p">)</span>
<span class="n">AZURE_CUSTOM_DOMAIN</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">AZURE_ACCOUNT_NAME</span><span class="si">}</span><span class="s1">.blob.core.windows.net'</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'https://</span><span class="si">{</span><span class="n">AZURE_CUSTOM_DOMAIN</span><span class="si">}</span><span class="s1">/static/'</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">'staticfiles'</span>

<span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'https://</span><span class="si">{</span><span class="n">AZURE_CUSTOM_DOMAIN</span><span class="si">}</span><span class="s1">/media/'</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">'mediafiles'</span>
</code></pre></div>

<p>因为我们使用两个独立的容器，我们需要定义自己的<code>AzureMediaStorage</code>和<code>AzureStaticStorage</code>。在“核心”目录下(在<em> settings.py </em>旁边)新建一个名为<em> azure_storage.py </em>的文件，内容如下:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># core/azure_storage.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">storages.backends.azure_storage</span> <span class="kn">import</span> <span class="n">AzureStorage</span>


<span class="k">class</span> <span class="nc">AzureMediaStorage</span><span class="p">(</span><span class="n">AzureStorage</span><span class="p">):</span>
    <span class="n">account_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_NAME'</span><span class="p">)</span>
    <span class="n">account_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_KEY'</span><span class="p">)</span>
    <span class="n">azure_container</span> <span class="o">=</span> <span class="s1">'media'</span>
    <span class="n">expiration_secs</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">AzureStaticStorage</span><span class="p">(</span><span class="n">AzureStorage</span><span class="p">):</span>
    <span class="n">account_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_NAME'</span><span class="p">)</span>
    <span class="n">account_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'AZURE_ACCOUNT_KEY'</span><span class="p">)</span>
    <span class="n">azure_container</span> <span class="o">=</span> <span class="s1">'static'</span>
    <span class="n">expiration_secs</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>提交您的代码并将其推送到VCS。</p>
<p>在您的应用程序重新部署后，SSH进入服务器并尝试收集静态文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>antenv<span class="o">)</span>$ python manage.py collectstatic

You have requested to collect static files at the destination
location as specified <span class="k">in</span> your settings.

This will overwrite existing files!
Are you sure you want to <span class="k">do</span> this?

Type <span class="s1">'yes'</span> to <span class="k">continue</span>, or <span class="s1">'no'</span> to cancel: yes

<span class="m">141</span> static files copied.
</code></pre></div>

<p>为了确保静态和媒体文件正常工作，请导航到您的应用程序的<code>/admin</code>并检查CSS是否已加载。接下来，试着上传一张图片。</p>
<h2 id="custom-domain">自定义域</h2>
<p>要将自定义域链接到你的应用，首先导航到你的应用仪表板，然后选择边栏上的“设置&gt;自定义域”。之后，点击“添加自定义域”。</p>
<p>然后，添加一个包含以下详细信息的自定义域:</p>
<ol>
<li>域提供者:<strong>所有其他域服务</strong></li>
<li>TLS/SSL证书:<strong> App服务托管证书</strong></li>
<li>TLS/SSL类型:sni SSL</li>
<li>域:<strong>你的域(如azure.testdriven.io) </strong></li>
<li>主机名记录类型:<strong> CNAME </strong></li>
</ol>
<p>输入所有细节后，Azure会要求您验证您的域所有权。为此，您需要导航到您的域名注册商的DNS设置，并添加一个新的“CNAME记录”，指向您的应用程序URL和一个TXT记录，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| Type     | Host         | Value                              | TTL       |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| CNAME    | </span><span class="nv">&lt;</span><span class="c">some host</span><span class="nv">&gt;</span><span class="c">  | </span><span class="nv">&lt;</span><span class="c">your_app_url</span><span class="nv">&gt;</span><span class="c">                     | Automatic |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| TXT      | asuid</span><span class="nt">.</span><span class="c">azure  | </span><span class="nv">&lt;</span><span class="c">your_txt_value</span><span class="nv">&gt;</span><span class="c">                   | Automatic |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
</code></pre></div>

<p>示例:</p>
<div class="codehilite"><pre><span/><code><span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| Type     | Host         | Value                              | TTL       |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| CNAME    | azure        | django</span><span class="nb">-</span><span class="c">images</span><span class="nt">.</span><span class="c">azurewebsites</span><span class="nt">.</span><span class="c">net    | Automatic |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
<span class="c">| TXT      | asuid</span><span class="nt">.</span><span class="c">azure  | BXVJAHNLY3JLDG11Y2H3B3C6KQASDFF    | Automatic |</span>
<span class="nb">+----------+--------------+------------------------------------+-----------+</span><span class="c"/>
</code></pre></div>

<p>等待几分钟，让DNS更改传播开来，然后单击“验证”。验证完成后，单击“添加”。</p>
<p>Azure将一个自定义域链接到应用程序，并颁发SSL证书。您的自定义域应该以“安全”状态显示在表格中。</p>
<blockquote>
<p>如果您的域的状态为“无绑定”，或者您收到错误消息“无法为创建应用程序服务管理的证书……”，单击“添加绑定”，将所有内容保留为默认设置，然后单击“验证”。如果失败，请在几分钟后重试。</p>
</blockquote>
<p>我们需要做的最后一件事是改变<code>ALLOWED_HOSTS</code>和<code>CSRF_TRUSTED_ORIGINS</code>并启用<code>SECURE_SSL_REDIRECT</code>。导航至您的应用程序服务应用程序配置，并按如下方式进行更改:</p>
<div class="codehilite"><pre><span/><code>ALLOWED_HOSTS=localhost 127.0.0.1 [::1] &lt;your_custom_domain&gt;
CSRF_TRUSTED_ORIGINS=https://&lt;your_custom_domain&gt;
SECURE_SSL_REDIRECT=1
</code></pre></div>

<p>现在，您应该可以在HTTPS上的自定义域中访问您的web应用。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们已经成功地将Django应用部署到Azure应用服务。我们已经处理了Postgres数据库，配置了静态和媒体文件服务，链接了自定义域名，并启用了HTTPS。现在你应该对Azure的工作原理有了基本的了解，并且能够部署你自己的Django应用了。</p>
<p>从<a href="https://github.com/duplxey/django-app-service"> GitHub repo </a>中抓取最终的源代码。</p>
<h3 id="future-steps">未来的步骤</h3>
<ol>
<li>查看<a href="https://learn.microsoft.com/en-us/azure/app-service/monitor-app-service"> Azure应用服务监控和记录</a>。</li>
<li>学习如何使用Azure命令行界面。</li>
</ol>
  </div>

  </div>    
</body>
</html>