<html>
<head>
<title>Integrating Mailchimp with Django </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>整合Mailchimp和Django</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-mailchimp/#0001-01-01">https://testdriven.io/blog/django-mailchimp/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本文中，我们将了解如何将<a href="https://mailchimp.com/"> Mailchimp </a>与<a href="https://www.djangoproject.com/"> Django </a>集成，以便处理新闻订阅和发送事务性电子邮件。</p>



<h2 id="objectives">目标</h2>
<p>在本文结束时，您将能够:</p>
<ol>
<li>解释Mailchimp的营销和交易电子邮件API之间的区别</li>
<li>将Mailchimp的营销API与Django集成</li>
<li>管理Mailchimp受众和联系人</li>
<li>设置并使用合并字段发送个性化活动</li>
<li>使用Mailchimp的事务性电子邮件API发送事务性电子邮件</li>
</ol>
<h2 id="what-is-mailchimp">Mailchimp是什么？</h2>
<p>Mailchimp 是一个营销自动化平台，允许您创建、发送和分析电子邮件和广告活动。此外，它还允许您管理联系人、创建自定义电子邮件模板和生成报告。这是企业最常用的电子邮件营销解决方案之一。</p>
<p>Mailchimp为开发人员提供了以下API:</p>
<ol>
<li><a href="https://mailchimp.com/developer/marketing/docs/fundamentals/">营销API </a></li>
<li><a href="https://mailchimp.com/developer/transactional/docs/fundamentals/">交易电子邮件API </a>(又名<a href="https://mandrillapp.com/"> Mandrill </a>)</li>
<li><a href="https://mailchimp.com/developer/open-commerce/docs/fundamentals/"> Mailchimp开放商业</a></li>
</ol>
<h3 id="marketing-api-vs-transactional-email-api">营销API与交易电子邮件API</h3>
<p>营销和交易电子邮件API都可以用于发送电子邮件...那么有什么区别呢？</p>
<p>营销API用于发送批量电子邮件，通常用于营销目的。其用途包括时事通讯、产品促销和欢迎系列。</p>
<p>另一方面，事务性电子邮件API用于在电子邮件触发操作后向单个收件人发送电子邮件。其用途包括帐户创建电子邮件、订单通知和密码重置电子邮件。</p>
<blockquote>
<p>如需详细解释，请查看官方文档。</p>
</blockquote>
<p>在本文的第一部分，我们将使用营销API来创建一个时事通讯。之后，我们将演示如何通过事务性电子邮件API发送电子邮件。</p>
<h2 id="project-setup">项目设置</h2>
<p>创建一个新的项目目录以及一个名为<code>djangomailchimp</code>的新Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-mailchimp <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-mailchimp
$ python3.10 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">4</span>.1
<span class="o">(</span>env<span class="o">)</span>$ django-admin startproject djangomailchimp .
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org/">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>接下来，迁移数据库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>这就是基本的设置。</p>
<h2 id="mailchimp-marketing-api">Mailchimp营销API</h2>
<p>在本节中，我们将使用<a href="https://mailchimp.com/developer/marketing/">营销API </a>来创建一份时事通讯。</p>
<blockquote>
<p>有了一个免费的Mailchimp账户，你可以拥有多达2000个联系人，每月发送多达10000封电子邮件(每天最多2000封)。</p>
</blockquote>
<h3 id="setup">设置</h3>
<p>出于组织目的，让我们创建一个名为<code>marketing</code>的新Django应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp marketing
</code></pre></div>

<p>将app添加到<em> settings.py </em>中的<code>INSTALLED_APPS</code>配置中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'marketing.apps.MarketingConfig'</span><span class="p">,</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>接下来，用<code>marketing</code>应用程序更新项目级的<em> urls.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'marketing/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'marketing.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>在<code>marketing</code>应用程序中创建一个<em> urls.py </em>文件并填充它:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_success_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'fail/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_fail_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe-fail'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_success_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/fail/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_fail_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe-fail'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>记下网址。它们应该是不言自明的:</p>
<ul>
<li>索引将显示订阅表单。</li>
<li>如果用户成功订阅，他们将被重定向到<code>/success</code>，否则将被重定向到<code>/fail</code>。</li>
<li>取消订阅网址的工作方式相同。</li>
</ul>
<p>在处理视图之前，让我们创建一个名为<em> forms.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/forms.py</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>


<span class="k">class</span> <span class="nc">EmailForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'Email'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</code></pre></div>

<p>我们创建了一个简单的<code>EmailForm</code>，用于在用户订阅时事通讯时收集联系数据。</p>
<blockquote>
<p>随意添加您想要收集的可选信息，如<code>first_name</code>、<code>last_name</code>、<code>address</code>、<code>phone_number</code>等。</p>
</blockquote>
<p>现在将以下内容添加到<em> views.py </em>中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/views.py</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">djangomailchimp</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">marketing.forms</span> <span class="kn">import</span> <span class="n">EmailForm</span>


<span class="k">def</span> <span class="nf">subscribe_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
            <span class="c1"># TODO: use Mailchimp API to subscribe</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'subscribe-success'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'subscribe.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">EmailForm</span><span class="p">(),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">subscribe_success_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'message.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Successfully subscribed'</span><span class="p">,</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'Yay, you have been successfully subscribed to our mailing list.'</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">subscribe_fail_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'message.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Failed to subscribe'</span><span class="p">,</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'Oops, something went wrong.'</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">unsubscribe_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
            <span class="c1"># TODO: use Mailchimp API to unsubscribe</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'unsubscribe-success'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'unsubscribe.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">EmailForm</span><span class="p">(),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">unsubscribe_success_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'message.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Successfully unsubscribed'</span><span class="p">,</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'You have been successfully unsubscribed from our mailing list.'</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">unsubscribe_fail_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'message.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Failed to unsubscribe'</span><span class="p">,</span>
        <span class="s1">'message'</span><span class="p">:</span> <span class="s1">'Oops, something went wrong.'</span><span class="p">,</span>
    <span class="p">})</span>
</code></pre></div>

<p>接下来，让我们为这些视图提供HTML模板。在根目录下创建一个“模板”文件夹。然后添加以下文件...</p>
<p><em>subscribe.html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/subscribe.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Mailchimp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ddbfb2b2a9aea9afbcad9de8f3ecf3ee">[email protected]</a>/dist/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bcded3d3c8cfc8ceddccfc89928d928f">[email protected]</a>/dist/js/bootstrap.min.js"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container mt-5"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Subscribe<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Enter your email address to subscribe to our mailing list.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
                {% csrf_token %}
                {{ form.as_p }}
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-primary"</span><span class="p">&gt;</span>Subscribe<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"mt-2"</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% url "</span><span class="na">unsubscribe</span><span class="err">"</span> <span class="err">%}"</span><span class="p">&gt;</span>Unsubscribe form<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><em>unsubscribe.html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/unsubscribe.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Mailchimp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f3919c9c878087819283b3c6ddc2ddc0">[email protected]</a>/dist/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="afcdc0c0dbdcdbddcedfef9a819e819c">[email protected]</a>/dist/js/bootstrap.min.js"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container mt-5"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Unsubscribe<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Enter your email address to unsubscribe from our mailing list.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
                {% csrf_token %}
                {{ form.as_p }}
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">class</span><span class="o">=</span><span class="s">"btn btn-danger"</span><span class="p">&gt;</span>Unsubscribe<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">"mt-2"</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"{% url "</span><span class="na">subscribe</span><span class="err">"</span> <span class="err">%}"</span><span class="p">&gt;</span>Subscribe form<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><em>message.html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- templates/message.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Django + Mailchimp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a4c6cbcbd0d7d0d6c5d4e4918a958a97">[email protected]</a>/dist/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://cdn.jsdelivr.net/npm/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f4d40405b5c5b5d4e5f6f1a011e011c">[email protected]</a>/dist/js/bootstrap.min.js"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"container mt-5"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ title }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ message }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>确保更新<em> settings.py </em>文件，以便Django知道要查找“模板”文件夹:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>


<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">'BACKEND'</span><span class="p">:</span> <span class="s1">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
        <span class="s1">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'templates'</span><span class="p">],</span> <span class="c1"># new</span>
        <span class="o">...</span>
</code></pre></div>

<p>最后，运行<code>runserver</code>命令启动Django的本地web服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>在浏览器中导航至<a href="http://localhost:8000/marketing/">http://localhost:8000/marketing/</a>。您应该会看到订阅表单:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/marketing-index.png" loading="lazy" class="lazyload" alt="Django + Mailchimp Marketing Index" src="../Images/d1c0b7fad1614099820e2fd9b609a6bb.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/marketing-index.png"/></p>
<p>通过点击“退订表单”锚，您将被重定向到退订表单。</p>
<p>太好了！我们完成了姜戈的设置。</p>
<h3 id="add-mailchimp-marketing-client">添加Mailchimp营销客户端</h3>
<p>首先，安装mailchimp-marketing包，这是Mailchimp Marketing API的官方客户端库:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install mailchimp-marketing<span class="o">==</span><span class="m">3</span>.0.75
</code></pre></div>

<p>接下来，我们需要创建/获取一个API密钥。</p>
<blockquote>
<p>如果你还没有Mailchimp账户，那就去注册。</p>
</blockquote>
<p>登录Mailchimp帐户后，通过点击链接或点击您的帐户(左下角)&gt;“帐户&amp;计费”，导航至<a href="https://us8.admin.mailchimp.com/account/api/">帐户API键</a>:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/gotoapi.png" loading="lazy" class="lazyload" alt="Mailchimp API Keys 1" src="../Images/13d0249ebecb39dc9acc338c0fbe2d38.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/gotoapi.png"/></p>
<p>然后单击“附加功能”&gt;“API密钥”:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/gotoapi2.png" loading="lazy" class="lazyload" alt="Mailchimp API Keys 2" src="../Images/74d335fa9fb4784598b0768f9a7b3deb.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/gotoapi2.png"/></p>
<p>最后，单击“创建密钥”以生成API密钥:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/create-api-key.png" loading="lazy" class="lazyload" alt="Mailchimp API Key Create" src="../Images/cfb93fd3d901afa4182b5b16f9bd1e2e.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/create-api-key.png"/></p>
<p>获得API密钥后，复制它。</p>
<p>要使用营销API，我们还需要了解我们所在的地区。最简单的方法是查看Mailchimp URL的开头。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code>https://us8.admin.mailchimp.com/
        ^^^
</code></pre></div>

<p>在我这里，地区是:<code>us8</code>。</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/api-key-copy.png" loading="lazy" class="lazyload" alt="Mailchimp API Key Copy" src="../Images/45a4c9a1a5d8e0c70c7cc77c54f240a0.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/api-key-copy.png"/></p>
<p>将Mailchimp API密钥和区域存储在<em> settings.py </em>的底部，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>

<span class="n">MAILCHIMP_API_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp api key&gt;'</span>
<span class="n">MAILCHIMP_REGION</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp region&gt;'</span>
</code></pre></div>

<p>接下来，我们将在<em> marketing/views.py </em>中初始化营销API客户端，并创建一个ping API的端点:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/views.py</span>

<span class="n">mailchimp</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="n">mailchimp</span><span class="o">.</span><span class="n">set_config</span><span class="p">({</span>
  <span class="s1">'api_key'</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_API_KEY</span><span class="p">,</span>
  <span class="s1">'server'</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_REGION</span><span class="p">,</span>
<span class="p">})</span>


<span class="k">def</span> <span class="nf">mailchimp_ping_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mailchimp</span><span class="o">.</span><span class="n">ping</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<p>不要忘记在文件顶部导入<code>Client</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">mailchimp_marketing</span> <span class="kn">import</span> <span class="n">Client</span>
</code></pre></div>

<p>在<em> marketing/urls.py </em>中注册新创建的端点:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'ping/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">mailchimp_ping_view</span><span class="p">),</span>  <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_success_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'fail/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">subscribe_fail_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'subscribe-fail'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/success/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_success_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe-success'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'unsubscribe/fail/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">unsubscribe_fail_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'unsubscribe-fail'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>再次运行服务器，访问<a href="http://localhost:8000/marketing/ping/">http://localhost:8000/marketing/ping/</a>看看能否ping通API。</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"health_status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Everything's Chimpy!"</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>如果你看到上面的消息，那么一切正常。</p>
<h3 id="create-an-audience">创造观众</h3>
<p>要创建简讯，我们需要使用受众。受众(或列表)是您可以向其发送活动电子邮件的联系人列表。</p>
<blockquote>
<p>Mailchimp的免费计划只允许你有一个(默认)受众。如果您有付费计划，请随意创建专门针对此演示新闻稿的受众。你可以通过<a href="https://us8.admin.mailchimp.com/lists/">网络界面</a>或<a href="https://mailchimp.com/developer/marketing/api/lists/add-list/">编程</a>来创建一个。</p>
</blockquote>
<p>导航至您的<a href="https://us8.admin.mailchimp.com/"> Mailchimp仪表盘</a>。在“受众”下，点击“所有联系人”。然后点击【设置】&gt;【受众名称及默认】:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/audiencenamesendefaults.png" loading="lazy" class="lazyload" alt="Mailchimp - All contacts" src="../Images/df3024e761ade1cc16c40d69ca23a2db.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/audiencenamesendefaults.png"/></p>
<p>在屏幕右侧，复制“观众ID”:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/audience.png" loading="lazy" class="lazyload" alt="Mailchimp - audience" src="../Images/ec0bd8705d161a493d4047d8639457ec.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/audience.png"/></p>
<p>粘贴在<em> settings.py </em>的末尾，API键和区域下:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>

<span class="n">MAILCHIMP_API_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp api key&gt;'</span>
<span class="n">MAILCHIMP_REGION</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp region&gt;'</span>
<span class="n">MAILCHIMP_MARKETING_AUDIENCE_ID</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp audience id&gt;'</span>  <span class="c1"># new</span>
</code></pre></div>

<p>在下一部分中，我们将向受众添加用户。</p>
<h3 id="subscribe-view">订阅视图</h3>
<p>转到<em> marketing/views.py </em>，用以下代码替换<code>subscribe_view</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/views.py</span>

<span class="k">def</span> <span class="nf">subscribe_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">form_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
                <span class="n">member_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'email_address'</span><span class="p">:</span> <span class="n">form_email</span><span class="p">,</span>
                    <span class="s1">'status'</span><span class="p">:</span> <span class="s1">'subscribed'</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">mailchimp</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">add_list_member</span><span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_MARKETING_AUDIENCE_ID</span><span class="p">,</span>
                    <span class="n">member_info</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'API call successful: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'subscribe-success'</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">ApiClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">'An exception occurred: </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'subscribe-fail'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'subscribe.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">EmailForm</span><span class="p">(),</span>
    <span class="p">})</span>
</code></pre></div>

<p>不要忘记像这样导入<code>ApiClientError</code>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">mailchimp_marketing.api_client</span> <span class="kn">import</span> <span class="n">ApiClientError</span>
</code></pre></div>

<p>另外，添加记录器:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">logging</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>

<p>因此，我们首先创建了一个字典，其中包含了我们想要存储的所有用户信息。字典需要包含<code>email</code>和<code>status</code>。我们可以使用多种<a href="https://mailchimp.com/help/about-your-contacts/">状态类型</a>，但最重要的是:</p>
<ol>
<li><code>subscribed</code> -立即添加联系人</li>
<li><code>pending</code> -用户将在被添加为联系人之前收到一封验证电子邮件</li>
</ol>
<p>如果我们想要附加额外的用户信息，我们必须使用<a href="https://mailchimp.com/developer/marketing/docs/merge-fields/">合并字段</a>。合并字段之后，我们可以发送个性化的电子邮件。它们由一个<code>name</code>和一个<code>type</code>组成(如<code>text</code>、<code>number</code>、<code>address</code>)。</p>
<p>默认的合并字段有:<code>ADDRESS</code>、<code>BIRTHDAY</code>、<code>FNAME</code>、<code>LNAME</code>、<code>PHONE</code>。</p>
<blockquote>
<p>如果您想使用自定义合并字段，您可以使用Mailchimp仪表板或通过<a href="https://mailchimp.com/developer/marketing/api/list-merges/"> Marketing API </a>添加它们。</p>
</blockquote>
<p>让我们将用户的名字和姓氏硬连接到<code>member_info</code>:</p>
<div class="codehilite"><pre><span/><code><span class="n">member_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'email_address'</span><span class="p">:</span> <span class="n">form_email</span><span class="p">,</span>
    <span class="s1">'status'</span><span class="p">:</span> <span class="s1">'subscribed'</span><span class="p">,</span>
    <span class="s1">'merge_fields'</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'FNAME'</span><span class="p">:</span> <span class="s1">'Elliot'</span><span class="p">,</span>
      <span class="s1">'LNAME'</span><span class="p">:</span> <span class="s1">'Alderson'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>发送活动时，您可以通过占位符访问合并字段，例如，<code>*|FNAME|*</code>将替换为<code>Elliot</code>。</p>
<blockquote>
<p>如果您在第一步中向<code>EmailForm</code>添加了额外的字段，请随意将它们添加为合并字段，如示例所示。</p>
<p>关于合并字段的更多信息可以在<a href="https://mailchimp.com/developer/marketing/docs/merge-fields/">正式文档</a>中找到。</p>
<p><a href="https://mailchimp.com/developer/marketing/api/list-members/add-member-to-list/"> lists.add_list_member() API引用</a></p>
</blockquote>
<p>我们已经完成了订阅视图。我们来测试一下。</p>
<p>运行服务器并导航到<a href="http://localhost:8000/marketing/">http://localhost:8000/marketing/</a>。然后，使用订阅表单进行订阅。您应该被重定向到<code>success/</code>:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/successfully-subscribed.png" loading="lazy" class="lazyload" alt="Successfully subscribed" src="../Images/5c33923807f2c07613e461f21d6c189a.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/successfully-subscribed.png"/></p>
<p>接下来，打开你的<a href="https://us8.admin.mailchimp.com/"> Mailchimp仪表盘</a>，导航至“观众”&gt;“所有联系人”。您应该可以看到您的第一个简讯订阅者:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/all-contacts-sub.png" loading="lazy" class="lazyload" alt="Mailchimp - All contacts new subscriber" src="../Images/8abb4be202a518cba84bffbd808ea557.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/all-contacts-sub.png"/></p>
<h3 id="unsubscribe-view">取消订阅视图</h3>
<p>要启用取消订阅功能，请用以下代码替换<code>unsubscribe_view</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># marketing/views.py</span>

<span class="k">def</span> <span class="nf">unsubscribe_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">form_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
                <span class="n">form_email_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">form_email</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="n">member_update</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'status'</span><span class="p">:</span> <span class="s1">'unsubscribed'</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">mailchimp</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">update_list_member</span><span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_MARKETING_AUDIENCE_ID</span><span class="p">,</span>
                    <span class="n">form_email_hash</span><span class="p">,</span>
                    <span class="n">member_update</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'API call successful: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'unsubscribe-success'</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">ApiClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">'An exception occurred: </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'unsubscribe-fail'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'unsubscribe.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">EmailForm</span><span class="p">(),</span>
    <span class="p">})</span>
</code></pre></div>

<p>在此，我们:</p>
<ol>
<li>通过表单获取用户的电子邮件。</li>
<li>使用<code>md5</code>散列用户的电子邮件并生成订户散列。哈希允许我们操作用户数据。</li>
<li>用我们想要更改的所有数据创建了一个名为<code>member_update</code>的字典。在我们的例子中，我们只是改变了状态。</li>
<li>将所有这些数据传递给<code>lists.update_list_member()</code>——瞧！</li>
</ol>
<blockquote>
<p>您可以使用相同的方法来更改其他用户数据，如合并字段。</p>
</blockquote>
<p>添加导入:</p>


<p>让我们测试一下是否一切正常。</p>
<p>再次运行服务器，导航到<a href="http://localhost:8000/marketing/unsubscribe/">http://localhost:8000/marketing/unsubscribe/</a>并使用表单取消订阅。打开“所有联系人”，您会注意到状态从“已订阅”变为“未订阅”:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/status.png" loading="lazy" class="lazyload" alt="Mailchimp - Unsubscribe status" src="../Images/3168d2b7eb337a57d0779a2cd43bf778.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/status.png"/></p>
<blockquote>
<p><a href="https://mailchimp.com/developer/marketing/api/list-members/update-list-member/">lists . update _ list _ member()API引用</a></p>
</blockquote>
<h3 id="fetch-subscription-information">获取订阅信息</h3>
<p>以下是如何获取用户订阅状态的代码示例:</p>
<div class="codehilite"><pre><span/><code><span class="n">member_email</span> <span class="o">=</span> <span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e99b868b869da9999b869d8687c7848c">[email protected]</a>'</span>
<span class="n">member_email_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">member_email</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mailchimp</span><span class="o">.</span><span class="n">lists</span><span class="o">.</span><span class="n">get_list_member</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_MARKETING_AUDIENCE_ID</span><span class="p">,</span>
        <span class="n">member_email_hash</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'API call successful: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="k">except</span> <span class="n">ApiClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'An exception occurred: </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</code></pre></div>

<p>正如我们在上一节中看到的，每当我们想要获取/修改某个用户时，我们需要散列他们的电子邮件并将其提供给API。</p>
<p>响应看起来会像这样:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">   </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f4ce663018fefacfe5c327869be7485d"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"email_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="71031e131e0531161c10181d5f121e1c">[email protected]</a>"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"unique_email_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ec7bdadf19"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"contact_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"67851f34b33195292b2977590007e965"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"full_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elliot Alderson"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"web_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">585506089</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"email_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"html"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"unsubscribed"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"unsubscribe_reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N/A (Unsubscribed by admin)"</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"consents_to_one_to_one_messaging"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">   </span><span class="nt">"merge_fields"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"FNAME"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elliot"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"LNAME"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alderson"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"ADDRESS"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"PHONE"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"BIRTHDAY"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w"/>
<span class="w">   </span><span class="p">},</span><span class="w"/>

<span class="w">   </span><span class="err">...</span><span class="w"/>

<span class="p">}</span><span class="w"/>
</code></pre></div>

<blockquote>
<p><a href="https://mailchimp.com/developer/marketing/api/list-members/get-member-info/"> lists.get_list_member() API引用</a></p>
</blockquote>
<p>--</p>
<p>我们的时事通讯差不多完成了。我们创建了一个受众，并启用了订阅和取消订阅功能。现在，剩下唯一要做的就是获得一些实际用户，并开始发送竞选电子邮件！</p>
<h2 id="mailchimp-transactional-api">Mailchimp事务API</h2>
<p>在本节中，我们将演示如何使用<a href="https://mailchimp.com/developer/transactional/docs/fundamentals/"> Mailchimp事务性电子邮件API </a>来发送事务性电子邮件。</p>
<blockquote>
<p>有了一个免费的<a href="https://mailchimp.com/features/transactional-email/"> Mailchimp交易账户</a> / <a href="https://mandrillapp.com/"> Mandrill账户</a>，你可以发送多达500封测试邮件。不过，测试邮件只能<em>发送到经过验证的域名。</em></p>
</blockquote>
<p>要使用Mailchimp事务性电子邮件API，您需要拥有一个域名，并有权访问其高级DNS设置。</p>
<h3 id="setup_1">设置</h3>
<p>出于组织目的，让我们创建另一个名为<code>transactional</code>的Django应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp transactional
</code></pre></div>

<p>将app添加到<em> settings.py </em>中的<code>INSTALLED_APPS</code>配置中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'marketing.apps.MarketingConfig'</span><span class="p">,</span>
    <span class="s1">'transactional.apps.TransactionalConfig'</span><span class="p">,</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>用<code>transactional</code> app更新项目级<em> urls.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'marketing/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'marketing.urls'</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'transactional/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'transactional.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，在<code>transactional</code>应用程序中创建一个<em> urls.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># transactional/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'send/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">send_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mailchimp-send'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>接下来，在<em> transactional/views.py </em>中创建一个<code>send_view</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># transactional/views.py</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>


<span class="k">def</span> <span class="nf">send_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">'detail'</span><span class="p">:</span> <span class="s1">'This view is going to send an email.'</span><span class="p">,</span>
    <span class="p">})</span>
</code></pre></div>

<p>运行服务器并导航到<a href="http://localhost:8000/transactional/send/">http://localhost:8000/transactional/send/</a>。您应该会得到这样的回应:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This view is going to send an email."</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<h3 id="add-transactional-email-client">添加交易电子邮件客户端</h3>
<p>接下来，让我们安装<a href="https://github.com/mailchimp/mailchimp-transactional-python"> mailchimp-transactional </a>包:</p>
<div class="codehilite"><pre><span/><code>pip install mailchimp-transactional<span class="o">==</span><span class="m">1</span>.0.47
</code></pre></div>

<p>这个包使得向事务性电子邮件API发送请求变得很容易。</p>
<blockquote>
<p>如果你还没有Mailchimp账户，那就去注册。</p>
</blockquote>
<p>我们现在需要创建一个新的事务API键。</p>
<p>登录您的Mailchimp帐户，进入“自动操作”&gt;“交易电子邮件”，然后按“启动”(在窗口的右上角):</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/transactional-path.png" loading="lazy" class="lazyload" alt="Mailchimp Transactional Email" src="../Images/742a6e56ed27b5c6a79c2f0355f8f745.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/transactional-path.png"/></p>
<p>在那之后，你将被重定向到Mandrill，在那里你将被询问你是否想用你的帐户登录。按“使用Mailchimp登录”。</p>
<p>然后导航至“设置”并点击“添加API密钥”:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/mandrill-1.png" loading="lazy" class="lazyload" alt="Mandrill Settings" src="../Images/9d8a51ea828122cd2fcd605a688bb723.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/mandrill-1.png"/></p>
<p>生成密钥后，复制它:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/mandrill-2.png" loading="lazy" class="lazyload" alt="Mandrill API Key" src="../Images/90e3dc98b765f2d027e12311213e83ae.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/mandrill-2.png"/></p>
<p>将生成的密钥存储在<em> settings.py </em>的底部，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangomailchimp/settings.py</span>

<span class="n">MAILCHIMP_MARKETING_API_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp marketing api key&gt;'</span>
<span class="n">MAILCHIMP_MARKETING_REGION</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp marketing region&gt;'</span>
<span class="n">MAILCHIMP_MARKETING_AUDIENCE_ID</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp audience id&gt;'</span>

<span class="n">MAILCHIMP_TRANSACTIONAL_API_KEY</span> <span class="o">=</span> <span class="s1">'&lt;your mailchimp transactional api key&gt;'</span>  <span class="c1"># new</span>
</code></pre></div>

<p>接下来，回到Mandrill设置，点击“域”，然后“发送域”。</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/sendingdomains.png" loading="lazy" class="lazyload" alt="Mandrill Sending Domains" src="../Images/309cf1819b07b927f5988ef9824f293b.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/sendingdomains.png"/></p>
<p>添加您的域名，并通过TXT记录或电子邮件验证所有权。验证域所有权后，还应该为DKIM和SPF设置添加TXT记录。接下来，点击“测试DNS设置”,看看是否一切正常:</p>
<p><img data-src="/static/images/blog/django/django-mailchimp/greentick.png" loading="lazy" class="lazyload" alt="Mandrill All Good" src="../Images/f15573377f2e02df8f23ba1b8ee4c8b9.png" data-original-src="https://testdriven.io/static/images/blog/django/django-mailchimp/greentick.png"/></p>
<p>应该只有绿色的扁虱。</p>
<p>接下来，让我们在<em> transactional/views.py </em>中初始化Mailchimp事务电子邮件客户端，并创建一个端点来测试我们是否可以成功ping通API:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">mailchimp_transactional</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">mailchimp_transactional.api_client</span> <span class="kn">import</span> <span class="n">ApiClientError</span>

<span class="kn">from</span> <span class="nn">djangomailchimp</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">mailchimp</span> <span class="o">=</span> <span class="n">mailchimp_transactional</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MAILCHIMP_TRANSACTIONAL_API_KEY</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">mailchimp_transactional_ping_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mailchimp</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">'detail'</span><span class="p">:</span> <span class="s1">'Everything is working fine'</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="n">ApiClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">'detail'</span><span class="p">:</span> <span class="s1">'Something went wrong'</span><span class="p">,</span>
            <span class="s1">'error'</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">})</span>
</code></pre></div>

<p>确保不要忘记任何进口。</p>
<p>在<em> urls.py </em>中注册新创建的URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># transactional/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'ping/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">mailchimp_transactional_ping_view</span><span class="p">),</span>  <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'send/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">send_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mailchimp-send'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>再次运行服务器，访问<a href="http://localhost:8000/transactional/ping/">http://localhost:8000/transactional/ping/</a>查看ping是否通过。</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Everything is working fine"</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>如果你看到上面的消息，那么一切正常。</p>
<h3 id="send-a-transactional-email">发送交易电子邮件</h3>
<p>用以下代码替换我们的<code>send_view</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">send_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'from_email'</span><span class="p">:</span> <span class="s1">'&lt;YOUR_SENDER_EMAIL&gt;'</span><span class="p">,</span>
        <span class="s1">'subject'</span><span class="p">:</span> <span class="s1">'My First Email'</span><span class="p">,</span>
        <span class="s1">'text'</span><span class="p">:</span> <span class="s1">'Hey there, this email has been sent via Mailchimp Transactional API.'</span><span class="p">,</span>
        <span class="s1">'to'</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">'email'</span><span class="p">:</span> <span class="s1">'&lt;YOUR_RECIPIENT_EMAIL&gt;'</span><span class="p">,</span>
                <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'to'</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">mailchimp</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">send</span><span class="p">({</span>
            <span class="s1">'message'</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">'detail'</span><span class="p">:</span> <span class="s1">'Email has been sent'</span><span class="p">,</span>
            <span class="s1">'response'</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="n">ApiClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
            <span class="s1">'detail'</span><span class="p">:</span> <span class="s1">'Something went wrong'</span><span class="p">,</span>
            <span class="s1">'error'</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">})</span>
</code></pre></div>

<blockquote>
<p>确保用您的实际电子邮件地址替换<code>&lt;YOUR_SENDER_EMAIL&gt;</code>和<code>&lt;YOUR_RECIPIENT_EMAIL&gt;</code>。也可以随意改变主题和/或文字。</p>
</blockquote>
<p>在此，我们:</p>
<ol>
<li>创建了一个包含所有电子邮件信息的字典。</li>
<li>将新创建的字典传递给<code>mailchimp.messages.send</code>。</li>
</ol>
<p>你应该一直把它包在袋子里，以防出错。</p>
<blockquote>
<p>如果你使用的是免费的Mailchimp计划，而你的电子邮件被拒绝<code>'reject_reason': 'recipient-domain-mismatch'</code>，你很可能试图发送一封电子邮件到一个未经验证的域名。如果您只验证了一个域，您只能向该域发送电子邮件。</p>
</blockquote>
<p>运行服务器，访问<a href="http://localhost:8000/transactional/send/">http://localhost:8000/transactional/send/</a>。如果一切顺利，您应该会看到以下响应:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Email has been sent"</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>接下来，检查你的收件箱，邮件应该在那里。</p>
<p>这只是一个如何发送交易邮件的演示。在现实世界的应用程序中，您可以使用该代码发送电子邮件进行密码重置和电子邮件验证等。</p>
<h2 id="conclusion">结论</h2>
<p>在本文中，我们研究了如何利用Mailchimp的营销和交易电子邮件API。我们创建了一个简单的时事通讯，并学习了如何发送交易电子邮件。现在，您应该对Mailchimp APIs的工作原理以及如何在您的应用程序中实现其他API端点有了相当好的理解。</p>
  </div>

  </div>    
</body>
</html>