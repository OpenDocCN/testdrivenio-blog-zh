<html>
<head>
<title>Distributed Testing with Selenium Grid and Docker </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Selenium Grid和Docker进行分布式测试</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/distributed-testing-with-selenium-grid/#0001-01-01">https://testdriven.io/blog/distributed-testing-with-selenium-grid/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>对于希望实现频繁交付方法(比如持续集成和交付)或者总体上加速开发周期的软件开发团队来说，减少测试执行时间是关键。在频繁构建和测试是常态的环境中，开发人员根本无法承受连续几个小时等待测试完成。将测试分布在许多机器上是这个问题的一个解决方案。</p>
<p>本文着眼于如何使用<a href="https://www.selenium.dev/documentation/en/grid/"> Selenium Grid </a>和<a href="https://docs.docker.com/engine/swarm/"> Docker Swarm </a>将自动化测试分布到多个机器上。</p>
<p>我们还将了解如何在多种浏览器上运行测试，并自动配置和取消配置机器以降低成本。</p>



<h2 id="objectives">目标</h2>
<p>完成本教程后，您将能够:</p>
<ol>
<li>用Docker将硒网格装箱</li>
<li>在Selenium Grid上运行自动化测试</li>
<li>描述分布式计算和并行计算的区别</li>
<li>通过Docker Compose和Machine将Selenium网格部署到数字海洋</li>
<li>自动供应和取消供应数字海洋上的资源</li>
</ol>
<h2 id="project-setup">项目设置</h2>
<p>让我们从Python中的基本Selenium测试开始:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>


<span class="k">class</span> <span class="nc">HackerNewsSearchTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_hackernews_search_for_testdrivenio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://news.ycombinator.com'</span><span class="p">)</span>
        <span class="n">search_box</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s1">'q'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">'testdriven.io'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># simulate long running test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">'testdriven.io'</span><span class="p">,</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_hackernews_search_for_selenium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://news.ycombinator.com'</span><span class="p">)</span>
        <span class="n">search_box</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s1">'q'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">'selenium'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># simulate long running test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">'selenium'</span><span class="p">,</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_hackernews_search_for_testdriven</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://news.ycombinator.com'</span><span class="p">)</span>
        <span class="n">search_box</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s1">'q'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">'testdriven'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># simulate long running test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">'testdriven'</span><span class="p">,</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_hackernews_search_with_no_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'https://news.ycombinator.com'</span><span class="p">)</span>
        <span class="n">search_box</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s1">'q'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">'?*^^%'</span><span class="p">)</span>
        <span class="n">search_box</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># simulate long running test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">'&lt;em&gt;'</span><span class="p">,</span> <span class="n">browser</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>  <span class="c1"># quit vs close?</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>跟着一起走？</p>
<ol>
<li>创建新的项目目录。</li>
<li>将上述代码保存在一个名为<em> test.py </em>的新文件中。</li>
<li>创建并激活虚拟环境。</li>
<li>装硒:<code>pip install selenium==3.141.0</code>。</li>
<li>全局安装<a href="https://sites.google.com/a/chromium.org/ChromeDriver/"> ChromeDriver </a>。(我们正在使用版本<a href="https://chromedriver.storage.googleapis.com/index.html?path=88.0.4324.96/"> 88.0.4324.96 </a>。)</li>
<li>确保它工作:<code>python test.py</code>。</li>
</ol>
<p>在这个测试中，我们导航到<code>https://news.ycombinator.com</code>，执行四次搜索，然后断言搜索结果页面被适当地呈现。没什么特别的，但是足够用了。请随意使用你自己的硒测试来代替这个测试。</p>
<p><em>执行时间</em>:约25秒</p>
<div class="codehilite"><pre><span/><code>$ python test.py

....
----------------------------------------------------------------------
Ran <span class="m">4</span> tests <span class="k">in</span> <span class="m">24</span>.533s

OK
</code></pre></div>

<h2 id="selenium-grid">硒栅</h2>
<p>说到分布式测试，<a href="https://www.selenium.dev/documentation/en/grid/"> Selenium Grid </a>是最强大和最流行的开源工具之一。有了它，我们可以将测试负载分散到多台机器上，并跨浏览器运行它们。</p>
<p>假设你有一套90个测试，在你的笔记本电脑上针对一个版本的Chrome运行。也许运行这些测试需要六分钟。使用Selenium Grid，您可以旋转三台不同的机器来运行它们，这将减少(大约)三分之一的测试执行时间。您也可以在不同的浏览器和平台上运行相同的测试。因此，您不仅节省了时间，而且还有助于确保您的web应用程序在不同的浏览器和环境中呈现时表现和外观都是一样的。</p>
<p>Selenium Grid使用客户机-服务器模型，包括一个中心和多个节点(运行测试的浏览器)。</p>
<p><img data-src="/static/images/blog/selenium-grid-docker-test/selenium-grid.png" loading="lazy" class="lazyload" alt="selenium grid" src="../Images/b0d12f3142e032ef6e470f84deb441e4.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker-test/selenium-grid.png"/></p>
<p>例如，您可以将三个节点连接到集线器，每个节点运行不同的浏览器。然后，当您使用特定的远程WebDriver运行您的测试时，WebDriver请求被发送到中心hub，它搜索与指定标准匹配的可用节点(例如，像浏览器版本)。一旦找到一个节点，就发送脚本并运行测试。</p>
<p>我们可以使用来自<a href="https://github.com/SeleniumHQ/docker-selenium"> Selenium Docker </a>的官方映像来启动一个中心和几个节点，而不是处理手动配置和安装Selenium Grid的麻烦。</p>
<p>要启动并运行，请将以下代码添加到项目根目录下名为<em> docker-compose.yml </em>的新文件中:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">hub</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/hub:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4444:4444</span><span class="w"/>

<span class="w">  </span><span class="nt">chrome</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-chrome:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_HOST=hub</span><span class="w"/>

<span class="w">  </span><span class="nt">firefox</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-firefox:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_HOST=hub</span><span class="w"/>
</code></pre></div>

<p>我们使用了<code>3.141.59</code>标签，它与以下版本的Selenium、WebDriver、Chrome和Firefox相关联:</p>
<div class="codehilite"><pre><span/><code><span class="n">Selenium</span><span class="o">:</span><span class="w"> </span><span class="mf">3.141</span><span class="o">.</span><span class="mi">59</span><span class="w"/>
<span class="n">Chrome</span><span class="o">:</span><span class="w"> </span><span class="mf">88.0</span><span class="o">.</span><span class="mf">4324.96</span><span class="w"/>
<span class="n">ChromeDriver</span><span class="o">:</span><span class="w"> </span><span class="mf">88.0</span><span class="o">.</span><span class="mf">4324.96</span><span class="w"/>
<span class="n">Firefox</span><span class="o">:</span><span class="w"> </span><span class="mf">85.0</span><span class="w"/>
<span class="n">GeckoDriver</span><span class="o">:</span><span class="w"> </span><span class="mf">0.29</span><span class="o">.</span><span class="mi">0</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果你想使用不同版本的Chrome或Firefox，请参考<a href="https://github.com/SeleniumHQ/docker-selenium/releases">发布版</a>页面</p>
</blockquote>
<p>提取并运行图像:</p>


<blockquote>
<p>本指南使用Docker版本18.09.2。</p>
</blockquote>
<p>完成后，打开浏览器并导航到Selenium Grid控制台(http://localhost:4444/Grid/console),确保一切正常:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker-test/console1.png" loading="lazy" class="lazyload" alt="selenium grid console" src="../Images/843152423a135c5dd3be26fbf2fd48b2.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker-test/console1.png"/></p>
<p>通过更新<code>setUp</code>方法在测试文件中配置远程驱动程序:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'browserName'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'BROWSER'</span><span class="p">,</span> <span class="s1">'chrome'</span><span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Remote</span><span class="p">(</span>
        <span class="n">command_executor</span><span class="o">=</span><span class="s1">'http://localhost:4444/wd/hub'</span><span class="p">,</span>
        <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">caps</span>
    <span class="p">)</span>
</code></pre></div>

<p>确保也添加导入:</p>


<p>通过Chrome节点上的Selenium Grid运行测试:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">BROWSER</span><span class="o">=</span>chrome <span class="o">&amp;&amp;</span> python test.py

....
----------------------------------------------------------------------
Ran <span class="m">4</span> tests <span class="k">in</span> <span class="m">21</span>.054s

OK
</code></pre></div>

<p>也试试Firefox:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">BROWSER</span><span class="o">=</span>firefox <span class="o">&amp;&amp;</span> python test.py

....
----------------------------------------------------------------------
Ran <span class="m">4</span> tests <span class="k">in</span> <span class="m">25</span>.058s

OK
</code></pre></div>

<p>为了模拟更长的测试运行，让我们连续运行20次相同的测试——10次在Chrome上，10次在Firefox上。</p>
<p>将名为<em> sequential_test_run.py </em>的新文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_call</span>


<span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">chrome_cmd</span> <span class="o">=</span> <span class="s1">'export BROWSER=chrome &amp;&amp; python test.py'</span>
    <span class="n">firefox_cmd</span> <span class="o">=</span> <span class="s1">'export BROWSER=firefox &amp;&amp; python test.py'</span>
    <span class="n">check_call</span><span class="p">(</span><span class="n">chrome_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">check_call</span><span class="p">(</span><span class="n">firefox_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>运行测试:</p>
<div class="codehilite"><pre><span/><code>$ python sequential_test_run.py
</code></pre></div>

<p><em>执行时间</em>:约8分钟</p>
<h2 id="distributed-vs-parallel">分布式与并行</h2>
<p>这很好，但是测试仍然没有并行运行。</p>
<blockquote>
<p>这可能会引起混淆，因为“并行”和“分布式”经常被测试人员和开发人员互换使用。查看<a href="https://cs.stackexchange.com/questions/1580/distributed-vs-parallel-computing">分布式与并行计算</a>了解更多信息。</p>
</blockquote>
<p>到目前为止，我们只处理了在多台机器上分发测试，这是由Selenium Grid处理的。测试运行器或框架，如<a href="https://docs.pytest.org"> pytest </a>或<a href="http://nose.readthedocs.io/"> nose </a>，负责并行运行测试。为了简单起见，我们将使用子流程模块，而不是完整的框架。值得注意的是，如果你正在使用pytest或nose，请分别查看<a href="https://pypi.python.org/pypi/pytest-xdist"> pytest-xdist </a>插件或使用nose 的<a href="http://nose.readthedocs.io/en/latest/doc_tests/test_multiprocess/multiprocess.html">并行测试指南以获得并行执行的帮助。</a></p>
<h2 id="running-in-parallel">并行运行</h2>
<p>将名为<em> parallel_test_run.py </em>的新文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>


<span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">chrome_cmd</span> <span class="o">=</span> <span class="s1">'export BROWSER=chrome &amp;&amp; python test.py'</span>
    <span class="n">firefox_cmd</span> <span class="o">=</span> <span class="s1">'export BROWSER=firefox &amp;&amp; python test.py'</span>
    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Popen</span><span class="p">(</span><span class="n">chrome_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Popen</span><span class="p">(</span><span class="n">firefox_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">processes</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div>

<p>这将同时运行测试文件二十次，每次都使用单独的进程。</p>
<div class="codehilite"><pre><span/><code>$ python parallel_test_run.py
</code></pre></div>

<p><em>执行时间</em>:约4分钟</p>
<p>这将花费不到四分钟的时间来运行，与顺序运行所有二十个测试相比，将执行时间减少了一半。我们可以通过注册更多的节点来进一步加快速度。</p>
<h2 id="digitalocean">数字海洋</h2>
<p>让我们旋转一个数字海洋液滴，这样我们就有更多的核心来工作。</p>
<p>如果你还没有账户，先从<a href="https://m.do.co/c/d8f211a4b4c2">注册</a>开始，然后<a href="https://docs.digitalocean.com/reference/api/create-personal-access-token/">生成</a>一个访问令牌，这样我们就可以使用<a href="https://developers.digitalocean.com/documentation/v2/">数字海洋API </a>。</p>
<p>将令牌添加到您的环境中:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">DIGITAL_OCEAN_ACCESS_TOKEN</span><span class="o">=[</span>your_digital_ocean_token<span class="o">]</span>
</code></pre></div>

<p>使用Docker Machine供应新的droplet:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine create <span class="se">\</span>
    --driver digitalocean <span class="se">\</span>
    --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
    --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
    selenium-grid<span class="p">;</span>
</code></pre></div>

<blockquote>
<p>需要<code>--engine-install-url</code>，因为在撰写本文时，Docker v20.10.0 <a href="https://github.com/docker/machine/issues/4858">无法与Docker Machine </a>一起使用。</p>
</blockquote>
<p>完成后，将Docker守护进程指向该机器，并将其设置为活动机器:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine env selenium-grid
$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env selenium-grid<span class="k">)</span>
</code></pre></div>

<p>旋转droplet上的三个容器——中心和两个节点:</p>


<p>抓取水滴的IP:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine ip selenium-grid
</code></pre></div>

<p>确保Selenium Grid在<a href="http://localhost:4444/grid/console">http://YOUR _ IP:4444/Grid/console</a>启动并运行，然后更新测试文件中的IP地址:</p>
<div class="codehilite"><pre><span/><code><span class="n">command_executor</span><span class="o">=</span><span class="s1">'http://YOUR_IP:4444/wd/hub'</span><span class="p">,</span>
</code></pre></div>

<p>再次并行运行测试:</p>
<div class="codehilite"><pre><span/><code>$ python parallel_test_run.py
</code></pre></div>

<p>刷新网格控制台。两个测试应该正在运行，而剩余的18个测试正在排队:</p>
<p><img data-src="/static/images/blog/selenium-grid-docker-test/console2.png" loading="lazy" class="lazyload" alt="selenium grid console" src="../Images/3aeefa64dd7ce1af1b01410c1482969f.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker-test/console2.png"/></p>
<p>同样，这应该需要大约四分钟来运行。</p>
<h2 id="docker-swarm-mode">码头工人群体模式</h2>
<p>继续前进，我们应该旋转更多的节点来运行测试。然而，由于droplet上的资源有限，让我们添加一些droplet供节点驻留。这就是Docker Swarm发挥作用的地方。</p>
<p>为了创建Swarm集群，让我们从头开始，首先旋转旧的液滴:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine rm selenium-grid
</code></pre></div>

<p>然后，旋转五个新的液滴:</p>
<div class="codehilite"><pre><span/><code>$ <span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">;</span> <span class="k">do</span>
    docker-machine create <span class="se">\</span>
      --driver digitalocean <span class="se">\</span>
      --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
      --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
      node-<span class="nv">$i</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div>

<p>在<code>node-1</code>初始化<a href="https://docs.docker.com/engine/swarm/">群模式</a>:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine ssh node-1 -- docker swarm init --advertise-addr <span class="k">$(</span>docker-machine ip node-1<span class="k">)</span>
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code>Swarm initialized: current node <span class="o">(</span>ae0iz7lqwz6g9p0oso4f5g6sd<span class="o">)</span> is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-54ca6zbkpya4mw15mctnmnkp7uzqmtcj8hm354ym2qqr8n5iyq-2v63f4ztawazzzitiibgpnh39 <span class="m">134</span>.209.115.249:2377

To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.
</code></pre></div>

<p>请注意join命令，因为它包含一个令牌，我们需要这个令牌来将节点workers添加到群中。</p>
<blockquote>
<p>如果忘记了，随时可以跑<code>docker-machine ssh node-1 -- docker swarm join-token worker</code>。</p>
</blockquote>
<p>将剩余的四个节点作为<a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/nodes/">工人</a>添加到群中:</p>
<div class="codehilite"><pre><span/><code>$ <span class="k">for</span> i <span class="k">in</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">;</span> <span class="k">do</span>
    docker-machine ssh node-<span class="nv">$i</span> <span class="se">\</span>
      -- docker swarm join --token YOUR_JOIN_TOKEN<span class="p">;</span>
<span class="k">done</span>
</code></pre></div>

<p>更新<em> docker-compose.yml </em>文件，以Swarm模式部署Selenium网格:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">hub</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/hub:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4444:4444</span><span class="w"/>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicated</span><span class="w"/>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == worker</span><span class="w"/>

<span class="w">  </span><span class="nt">chrome</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-chrome:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/urandom:/dev/random</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_PORT_4444_TCP_ADDR=hub</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_PORT_4444_TCP_PORT=4444</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_MAX_SESSION=1</span><span class="w"/>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'SE_OPTS="-host $$HOSTNAME -port 5555" /opt/bin/entry_point.sh'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5555:5555</span><span class="w"/>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == worker</span><span class="w"/>

<span class="w">  </span><span class="nt">firefox</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">selenium/node-firefox:3.141.59</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/urandom:/dev/random</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hub</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_PORT_4444_TCP_ADDR=hub</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HUB_PORT_4444_TCP_PORT=4444</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_MAX_SESSION=1</span><span class="w"/>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'SE_OPTS="-host $$HOSTNAME -port 5556" /opt/bin/entry_point.sh'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5556:5556</span><span class="w"/>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == worker</span><span class="w"/>
</code></pre></div>

<p>主要变化:</p>
<ol>
<li><em>布局约束</em>:我们设置了<code>node.role == worker</code>的<a href="https://docs.docker.com/engine/swarm/services/#placement-constraints">布局约束</a>，这样所有的任务都将在worker节点上运行。通常最好让管理器节点远离CPU和/或内存密集型任务。</li>
<li><em> Entrypoint </em>:这里，我们更新了<em> entry_point.sh </em> <a href="https://github.com/SeleniumHQ/docker-selenium/blob/3.10.0-argon/NodeBase/entry_point.sh">脚本</a>中的<code>SE_OPTS</code>中的主机集，这样运行在不同主机上的节点将能够成功链接回hub。</li>
</ol>
<p>这样，将Docker守护进程指向<code>node-1</code>并部署堆栈:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env node-1<span class="k">)</span>
$ docker stack deploy --compose-file<span class="o">=</span>docker-compose.yml selenium
</code></pre></div>

<p>再添加几个节点:</p>
<div class="codehilite"><pre><span/><code>$ docker service scale <span class="nv">selenium_chrome</span><span class="o">=</span><span class="m">4</span> <span class="nv">selenium_firefox</span><span class="o">=</span><span class="m">4</span>
</code></pre></div>

<p>查看堆栈:</p>
<div class="codehilite"><pre><span/><code>$ docker stack ps selenium
</code></pre></div>

<p>您应该会看到类似这样的内容:</p>
<div class="codehilite"><pre><span/><code>ID             NAME                 IMAGE                            NODE      DESIRED STATE   CURRENT STATE
99filw99x8bc   selenium_chrome.1    selenium/node-chrome:3.141.59    node-3    Running         Running <span class="m">41</span> seconds ago
9ff9cwx1dmqw   selenium_chrome.2    selenium/node-chrome:3.141.59    node-4    Running         Running about a minute ago
ige7rlnj1e03   selenium_chrome.3    selenium/node-chrome:3.141.59    node-5    Running         Running <span class="m">59</span> seconds ago
ewsg5mxiy9eg   selenium_chrome.4    selenium/node-chrome:3.141.59    node-2    Running         Running <span class="m">56</span> seconds ago
y3ud4iojz8u0   selenium_firefox.1   selenium/node-firefox:3.141.59   node-4    Running         Running about a minute ago
bvpizrfdhlq0   selenium_firefox.2   selenium/node-firefox:3.141.59   node-5    Running         Running about a minute ago
0jdw3sr7ld62   selenium_firefox.3   selenium/node-firefox:3.141.59   node-3    Running         Running <span class="m">50</span> seconds ago
4esw9a2wvcf3   selenium_firefox.4   selenium/node-firefox:3.141.59   node-2    Running         Running about a minute ago
3dd04mt1t7n8   selenium_hub.1       selenium/hub:3.141.59            node-5    Running         Running about a minute ago
</code></pre></div>

<p>然后，获取运行集线器的节点的名称和IP地址，并将其设置为环境变量:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nv">NODE</span><span class="o">=</span><span class="k">$(</span>docker service ps --format <span class="s2">"{{.Node}}"</span> selenium_hub<span class="k">)</span>
$ <span class="nb">export</span> <span class="nv">NODE_HUB_ADDRESS</span><span class="o">=</span><span class="k">$(</span>docker-machine ip <span class="nv">$NODE</span><span class="k">)</span>
</code></pre></div>

<p>再次更新<code>setUp</code>方法:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'browserName'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'BROWSER'</span><span class="p">,</span> <span class="s1">'chrome'</span><span class="p">)}</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'NODE_HUB_ADDRESS'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Remote</span><span class="p">(</span>
        <span class="n">command_executor</span><span class="o">=</span><span class="sa">f</span><span class="s1">'http://</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1">:4444/wd/hub'</span><span class="p">,</span>
        <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">caps</span>
    <span class="p">)</span>
</code></pre></div>

<p>测试！</p>
<div class="codehilite"><pre><span/><code>$ python parallel_test_run.py
</code></pre></div>

<p><img data-src="/static/images/blog/selenium-grid-docker-test/console3.png" loading="lazy" class="lazyload" alt="selenium grid console" src="../Images/39f0bfbef89095846e458849e5ad4dae.png" data-original-src="https://testdriven.io/static/images/blog/selenium-grid-docker-test/console3.png"/></p>
<p><em>执行时间</em>:约1.5分钟</p>
<p>去除水滴:</p>
<div class="codehilite"><pre><span/><code>$ docker-machine rm node-1 node-2 node-3 node-4 node-5 -y
</code></pre></div>

<p>概括地说，为了创建一个群体，我们:</p>
<ol>
<li>旋转出新的水滴</li>
<li>在其中一个液滴上初始化群体模式(本例中为<code>node-1</code>)</li>
<li>将节点作为工人添加到群体中</li>
</ol>
<h2 id="automation-scripts">自动化脚本</h2>
<p>因为让droplet闲置，等待客户端运行测试是不划算的，所以我们应该在测试运行之前自动供应droplet，然后在运行之后取消供应。</p>
<p>让我们编写一个脚本:</p>
<ul>
<li>用Docker机器提供液滴</li>
<li>配置Docker群组模式</li>
<li>向群集添加节点</li>
<li>部署硒网格</li>
<li>运行测试</li>
<li>旋转水滴</li>
</ul>
<p><em> create.sh </em>:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>


<span class="nb">echo</span> <span class="s2">"Spinning up five droplets..."</span>

<span class="k">for</span> i <span class="k">in</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">;</span> <span class="k">do</span>
  docker-machine create <span class="se">\</span>
    --driver digitalocean <span class="se">\</span>
    --digitalocean-access-token <span class="nv">$DIGITAL_OCEAN_ACCESS_TOKEN</span> <span class="se">\</span>
    --engine-install-url <span class="s2">"https://releases.rancher.com/install-docker/19.03.9.sh"</span> <span class="se">\</span>
    node-<span class="nv">$i</span><span class="p">;</span>
<span class="k">done</span>


<span class="nb">echo</span> <span class="s2">"Initializing Swarm mode..."</span>

docker-machine ssh node-1 -- docker swarm init --advertise-addr <span class="k">$(</span>docker-machine ip node-1<span class="k">)</span>

docker-machine ssh node-1 -- docker node update --availability drain node-1

<span class="nb">echo</span> <span class="s2">"Adding the nodes to the Swarm..."</span>

<span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>docker-machine ssh node-1 docker swarm join-token worker <span class="p">|</span> grep token <span class="p">|</span> awk <span class="s1">'{ print $5 }'</span><span class="sb">`</span>

docker-machine ssh node-2 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>
docker-machine ssh node-3 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>
docker-machine ssh node-4 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>
docker-machine ssh node-5 <span class="s2">"docker swarm join --token </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2"> </span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:2377"</span>


<span class="nb">echo</span> <span class="s2">"Deploying Selenium Grid to http://</span><span class="k">$(</span>docker-machine ip node-1<span class="k">)</span><span class="s2">:4444..."</span>

<span class="nb">eval</span> <span class="k">$(</span>docker-machine env node-1<span class="k">)</span>
docker stack deploy --compose-file<span class="o">=</span>docker-compose.yml selenium
docker service scale <span class="nv">selenium_chrome</span><span class="o">=</span><span class="m">2</span> <span class="nv">selenium_firefox</span><span class="o">=</span><span class="m">2</span>
</code></pre></div>

<p><em> destroy.sh </em>:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>

docker-machine rm node-1 node-2 node-3 node-4 node-5 -y
</code></pre></div>

<p>测试！</p>
<div class="codehilite"><pre><span/><code>$ sh create.sh

$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env node-1<span class="k">)</span>
$ <span class="nv">NODE</span><span class="o">=</span><span class="k">$(</span>docker service ps --format <span class="s2">"{{.Node}}"</span> selenium_hub<span class="k">)</span>
$ <span class="nb">export</span> <span class="nv">NODE_HUB_ADDRESS</span><span class="o">=</span><span class="k">$(</span>docker-machine ip <span class="nv">$NODE</span><span class="k">)</span>

$ python parallel_test_run.py

$ sh destroy.sh
</code></pre></div>

<h2 id="conclusion">结论</h2>
<p>本文研究了如何使用Docker和Docker Swarm配置Selenium Grid，以便在多台机器上分布测试。</p>
<p>完整的代码可以在<a href="https://github.com/testdrivenio/selenium-grid-docker-swarm-test">selenium-grid-docker-swarm-test</a>库中找到。</p>
<p>寻找一些挑战？</p>
<ol>
<li>通过在不同的Selenium网格节点上并行运行所有测试方法，尝试进一步减少测试执行时间。</li>
<li>在Travis或Jenkins(或其他CI工具)上配置测试的运行，使它们成为持续集成过程的一部分。</li>
</ol>
  </div>

  </div>    
</body>
</html>