<html>
<head>
<title>Integrating the Masonite ORM with FastAPI </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将Masonite ORM与FastAPI集成</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/masonite-orm-fastapi/#0001-01-01">https://testdriven.io/blog/masonite-orm-fastapi/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，你将学习如何使用<a href="https://orm.masoniteproject.com/"> Masonite ORM </a>和<a href="https://fastapi.tiangolo.com/"> FastAPI </a>。</p>



<h2 id="objectives">目标</h2>
<p>学完本教程后，您应该能够:</p>
<ol>
<li>将Masonite ORM与FastAPI集成</li>
<li>使用Masonite ORM与Postgres、MySQL和SQLite进行交互</li>
<li>用Masonite ORM声明数据库应用程序中的关系</li>
<li>用pytest测试FastAPI应用程序</li>
</ol>
<h2 id="why-use-the-masonite-orm">为什么使用Masonite ORM</h2>
<p>Masonite ORM是一个干净的、易于使用的对象关系映射库，它是为<a href="https://docs.masoniteproject.com/"> Masonite </a> web框架构建的。Masonite ORM建立在<a href="https://orator-orm.com/">演说家ORM </a>的基础上，这是一个活跃的记录ORM，它在很大程度上受到了Laravel的<a href="https://laravel.com/docs/eloquent">雄辩ORM </a>的启发。</p>
<p>Masonite ORM被开发出来作为astorator ORM的<a href="https://github.com/sdispater/orator/issues/369#issuecomment-633591842">替代品</a>,因为astorator不再接收更新和错误修复。</p>
<p>尽管Masonite ORM是为Masonite web项目设计的，但是您也可以将mason ite ORM用于其他Python web框架或项目。</p>
<h2 id="fastapi">FastAPI</h2>
<p>FastAPI是一个现代的、高性能的、内置电池的Python web框架，非常适合构建RESTful APIs。它可以处理同步和异步请求，并内置了对数据验证、JSON序列化、身份验证和授权以及OpenAPI的支持。</p>
<p>有关FastAPI的更多信息，请查看我们的<a href="https://testdriven.io/blog/topics/fastapi/"> FastAPI摘要页面</a>。</p>
<h2 id="what-were-building">我们正在建造的东西</h2>
<p>我们将使用以下模型构建一个简单的博客应用程序:</p>
<ol>
<li>用户</li>
<li>邮件</li>
<li>评论</li>
</ol>
<p>用户将与帖子有一对多的关系，而帖子也将与评论有一对多的关系。</p>
<p>API端点:</p>
<ol>
<li><code>/api/v1/users</code> -获取所有用户的详细信息</li>
<li><code>/api/v1/users/&lt;user_id&gt;</code> -获取单个用户的详细信息</li>
<li><code>/api/v1/posts</code> -获取所有帖子</li>
<li><code>/api/v1/posts/&lt;post_id&gt;</code> -获得一个帖子</li>
<li>从一篇文章中获取所有评论</li>
</ol>
<h2 id="project-setup">项目设置</h2>
<p>创建一个目录来保存名为“fastapi-masonite”的项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir fastapi-masonite
$ <span class="nb">cd</span> fastapi-masonite
</code></pre></div>

<p>创建虚拟环境并激活它:</p>
<div class="codehilite"><pre><span/><code>$ python3.10 -m venv .env
$ <span class="nb">source</span> .env/bin/activate

<span class="o">(</span>.env<span class="o">)</span>$
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>创建一个<em> requirements.txt </em>文件，并向其中添加以下需求:</p>
<div class="codehilite"><pre><span/><code>fastapi==0.89.1
uvicorn==0.20.0
</code></pre></div>

<p><a href="http://www.uvicorn.org/">uvicon</a>是一个<a href="https://asgi.readthedocs.io/en/latest/"> ASGI </a>(异步服务器网关接口)兼容服务器，将用于启动FastAPI。</p>
<p>安装要求:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>在项目的根文件夹中创建一个<em> main.py </em>文件，并添加以下几行:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"msg"</span><span class="p">:</span> <span class="s2">"Hello World"</span><span class="p">}</span>
</code></pre></div>

<p>使用以下命令运行FastAPI服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ uvicorn main:app --reload
</code></pre></div>

<p>打开您选择的网络浏览器并导航至<a href="http://127.0.0.1:8000"> http://127.0.0.1:8000 </a>。您应该会看到以下JSON响应:</p>


<h2 id="masonite-orm">Masonite ORM</h2>
<p>将以下需求添加到<em> requirements.txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>masonite-orm==2.18.6
psycopg2-binary==2.9.5
</code></pre></div>

<p>安装新的依赖项:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>创建以下文件夹:</p>
<div class="codehilite"><pre><span/><code>models
databases/migrations
config
</code></pre></div>

<p>“models”文件夹将包含我们的模型文件，“databases/migrations”文件夹将包含我们的迁移文件，“config”文件夹将保存我们的Masonite数据库配置文件。</p>
<h3 id="database-config">数据库配置</h3>
<p>在“config”文件夹中，创建一个<em> database.py </em>文件。Masonite ORM需要这个文件，因为这是我们声明数据库配置的地方。</p>
<blockquote>
<p>欲了解更多信息，请访问<a href="https://orm.masoniteproject.com/installation#configuration">文档</a>。</p>
</blockquote>
<p>在<em> database.py </em>文件中，我们需要添加<code>DATABASE</code>变量和一些连接信息，从<code>masonite-orm.connections</code>导入<code>ConnectionResolver</code>，并注册连接细节:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/database.py</span>

<span class="kn">from</span> <span class="nn">masoniteorm.connections</span> <span class="kn">import</span> <span class="n">ConnectionResolver</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"default"</span><span class="p">:</span> <span class="s2">"postgres"</span><span class="p">,</span>
  <span class="s2">"mysql"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="s2">"driver"</span><span class="p">:</span> <span class="s2">"mysql"</span><span class="p">,</span>
    <span class="s2">"database"</span><span class="p">:</span> <span class="s2">"masonite"</span><span class="p">,</span>
    <span class="s2">"user"</span><span class="p">:</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="s2">"log_queries"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">#</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"postgres"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="s2">"driver"</span><span class="p">:</span> <span class="s2">"postgres"</span><span class="p">,</span>
    <span class="s2">"database"</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span>
    <span class="s2">"user"</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
    <span class="s2">"log_queries"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">"options"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">#</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"sqlite"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"driver"</span><span class="p">:</span> <span class="s2">"sqlite"</span><span class="p">,</span>
    <span class="s2">"database"</span><span class="p">:</span> <span class="s2">"db.sqlite3"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">DB</span> <span class="o">=</span> <span class="n">ConnectionResolver</span><span class="p">()</span><span class="o">.</span><span class="n">set_connection_details</span><span class="p">(</span><span class="n">DATABASES</span><span class="p">)</span>
</code></pre></div>

<p>这里，我们定义了三种不同的数据库设置:</p>
<ol>
<li>关系型数据库</li>
<li>Postgres</li>
<li>SQLite</li>
</ol>
<p>我们将默认连接设置为Postgres。</p>
<blockquote>
<p>注意:确保您已经启动并运行了Postgres数据库。如果要使用MySQL，将默认连接改为<code>mysql</code>。</p>
</blockquote>
<h3 id="masonite-models">Masonite型号</h3>
<p>要创建一个新的样板文件<a href="https://orm.masoniteproject.com/models#creating-a-model"> Masonite模型</a>，从终端的项目根文件夹中运行下面的<code>masonite-orm</code>命令:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ masonite-orm model User --directory models
</code></pre></div>

<p>您应该会看到一条成功消息:</p>
<div class="codehilite"><pre><span/><code>Model created: models/User.py
</code></pre></div>

<p>因此，该命令应该在“models”目录中创建一个包含以下内容的<em> User.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="sd">""" User Model """</span>

<span class="kn">from</span> <span class="nn">masoniteorm.models</span> <span class="kn">import</span> <span class="n">Model</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""User Model"""</span>

    <span class="k">pass</span>
</code></pre></div>

<blockquote>
<p>如果您收到一个<code>FileNotFoundError</code>，检查以确保“模型”文件夹存在。</p>
</blockquote>
<p>对帖子和评论模型运行相同的命令:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ masonite-orm model Post --directory models
&gt; Model created: models/Post.py

<span class="o">(</span>.env<span class="o">)</span>$ masonite-orm model Comment --directory models
&gt; Model created: models/Comment.py
</code></pre></div>

<p>接下来，我们可以创建初始迁移:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ masonite-orm migration migration_for_user_table --create users
</code></pre></div>

<p>我们添加了<code>--create</code>标志来告诉Masonite将要创建的迁移文件是针对我们的<code>users</code>表的，并且应该在迁移运行时创建数据库表。</p>
<p>在“数据库/迁移”文件夹中，应该已经创建了一个新文件:</p>
<p><code>&lt;timestamp&gt;_migration_for_user_table.py</code></p>
<p>内容:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""MigrationForUserTable Migration."""</span>

<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="k">class</span> <span class="nc">MigrationForUserTable</span><span class="p">(</span><span class="n">Migration</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run the migrations.</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>

            <span class="n">table</span><span class="o">.</span><span class="n">timestamps</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Revert the migrations.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span>
</code></pre></div>

<p>创建剩余的迁移文件:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ masonite-orm migration migration_for_post_table --create posts
&gt; Migration file created: databases/migrations/2022_05_04_084820_migration_for_post_table.py

<span class="o">(</span>.env<span class="o">)</span>$ masonite-orm migration migration_for_comment_table --create comments
&gt; Migration file created: databases/migrations/2022_05_04_084833_migration_for_comment_table.py
</code></pre></div>

<p>接下来，让我们填充每个数据库表的字段。</p>
<h3 id="database-tables">数据库表</h3>
<p><code>users</code>表应该有以下字段:</p>
<ol>
<li>名字</li>
<li>电子邮件(唯一)</li>
<li>地址(可选)</li>
<li>电话号码(可选)</li>
<li>性别(可选)</li>
</ol>
<p>将与用户模型相关联的迁移文件更改为:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""MigrationForUserTable Migration."""</span>

<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="k">class</span> <span class="nc">MigrationForUserTable</span><span class="p">(</span><span class="n">Migration</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run the migrations.</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s2">"email"</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"address"</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s2">"phone_number"</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">enum</span><span class="p">(</span><span class="s2">"sex"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"male"</span><span class="p">,</span> <span class="s2">"female"</span><span class="p">])</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">timestamps</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Revert the migrations.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<p>有关表方法和列类型的更多信息，请查看文档中的<a href="https://orm.masoniteproject.com/schema-and-migrations">模式&amp;迁移</a>。</p>
</blockquote>
<p>接下来，更新帖子和评论模型的字段，注意这些字段。</p>
<p>帖子:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""MigrationForPostTable Migration."""</span>

<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="k">class</span> <span class="nc">MigrationForPostTable</span><span class="p">(</span><span class="n">Migration</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run the migrations.</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">"posts"</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">unsigned</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s2">"title"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"body"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">timestamps</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Revert the migrations.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"posts"</span><span class="p">)</span>
</code></pre></div>

<p>评论:</p>
<div class="codehilite"><pre><span/><code><span class="sd">"""MigrationForCommentTable Migration."""</span>

<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="k">class</span> <span class="nc">MigrationForCommentTable</span><span class="p">(</span><span class="n">Migration</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run the migrations.</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">increments</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">unsigned</span><span class="p">()</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">"post_id"</span><span class="p">)</span><span class="o">.</span><span class="n">unsigned</span><span class="p">()</span><span class="o">.</span><span class="n">nullable</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s2">"post_id"</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"posts"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"body"</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">timestamps</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Revert the migrations.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">)</span>
</code></pre></div>

<p>注意到:</p>
<div class="codehilite"><pre><span/><code><span class="n">table</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">unsigned</span><span class="p">()</span>
<span class="n">table</span><span class="o">.</span><span class="n">foreign</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"users"</span><span class="p">)</span>
</code></pre></div>

<p>上面几行创建了一个从<code>posts</code> / <code>comments</code>表到<code>users</code>表的外键。<code>user_id</code>列引用<code>users</code>表上的<code>id</code>列</p>
<p>要应用迁移，请在终端中运行以下命令:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ masonite-orm migrate
</code></pre></div>

<p>您应该会看到关于每个迁移的成功消息:</p>
<div class="codehilite"><pre><span/><code>Migrating: 2022_05_04_084807_migration_for_user_table
Migrated: 2022_05_04_084807_migration_for_user_table <span class="o">(</span><span class="m">0</span>.08s<span class="o">)</span>
Migrating: 2022_05_04_084820_migration_for_post_table
Migrated: 2022_05_04_084820_migration_for_post_table <span class="o">(</span><span class="m">0</span>.04s<span class="o">)</span>
Migrating: 2022_05_04_084833_migration_for_comment_table
Migrated: 2022_05_04_084833_migration_for_comment_table <span class="o">(</span><span class="m">0</span>.02s<span class="o">)</span>
</code></pre></div>

<p>到目前为止，我们已经在表中添加并引用了外键，这些外键是在数据库中创建的。但是，我们仍然需要告诉Masonite每个模型之间的关系类型。</p>
<h3 id="table-relationships">表关系</h3>
<p>为了定义一对多的关系，我们需要从<em>模型/User.py </em>中的<code>masoniteorm.relationships</code>导入<code>has_many</code>，并将其作为装饰者添加到我们的函数中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># models/User.py</span>

<span class="kn">from</span> <span class="nn">masoniteorm.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">masoniteorm.relationships</span> <span class="kn">import</span> <span class="n">has_many</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""User Model"""</span>

    <span class="nd">@has_many</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"user_id"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">posts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.Post</span> <span class="kn">import</span> <span class="n">Post</span>

        <span class="k">return</span> <span class="n">Post</span>

    <span class="nd">@has_many</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"user_id"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.Comment</span> <span class="kn">import</span> <span class="n">Comment</span>

        <span class="k">return</span> <span class="n">Comment</span>
</code></pre></div>

<p>请注意，<code>has_many</code>有两个参数:</p>
<ol>
<li>将在另一个表中引用的主表上的主键列的名称</li>
<li>将作为外键引用的列的名称</li>
</ol>
<p>在<code>users</code>表中，<code>id</code>是主键列，而<code>user_id</code>是引用<code>users</code>表记录的<code>posts</code>表中的列。</p>
<p>对<em>型号/Post.py </em>进行同样的操作:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># models/Post.py</span>

<span class="kn">from</span> <span class="nn">masoniteorm.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">masoniteorm.relationships</span> <span class="kn">import</span> <span class="n">has_many</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Post Model"""</span>

    <span class="nd">@has_many</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"post_id"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.Comment</span> <span class="kn">import</span> <span class="n">Comment</span>

        <span class="k">return</span> <span class="n">Comment</span>
</code></pre></div>

<p>配置好数据库后，让我们用FastAPI连接我们的API。</p>
<h2 id="fastapi-restful-api">FastAPI RESTful API</h2>
<h3 id="pydantic">迂腐的</h3>
<p>FastAPI严重依赖<a href="https://pydantic-docs.helpmanual.io/"> Pydantic </a>来操作(读取和返回)数据。</p>
<p>在根文件夹中，创建一个名为<em> schema.py </em>的新Python文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># schema.py</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>


<span class="k">class</span> <span class="nc">UserBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">phone_number</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sex</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">UserCreate</span><span class="p">(</span><span class="n">UserBase</span><span class="p">):</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">UserResult</span><span class="p">(</span><span class="n">UserBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<p>这里，我们为用户对象定义了一个基本模型，然后添加了两个Pydantic模型，一个用于读取数据，另一个用于从API返回数据。我们对可空值使用了<code>Optional</code>类型。</p>
<blockquote>
<p>你可以在这里阅读更多关于Pydantic模型<a href="https://pydantic-docs.helpmanual.io/usage/models/">。</a></p>
</blockquote>
<p>在<code>UserResult</code> Pydantic类中，我们增加了一个<code>Config</code>类，并将<code>orm_mode</code>设置为<code>True</code>。这告诉Pydantic不仅要将数据作为dict读取，还要作为具有属性的对象读取。因此，您可以选择:</p>
<div class="codehilite"><pre><span/><code><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span>   <span class="c1"># as a dict</span>

<span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># as an attribute</span>
</code></pre></div>

<blockquote>
<p><a href="https://pydantic-docs.helpmanual.io/usage/models/#orm-mode-aka-arbitrary-class-instances">更多关于Pydantic ORM模型的信息</a>。</p>
</blockquote>
<p>接下来，为帖子和评论对象添加模型:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># schema.py</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>


<span class="k">class</span> <span class="nc">UserBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">phone_number</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sex</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">UserCreate</span><span class="p">(</span><span class="n">UserBase</span><span class="p">):</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">UserResult</span><span class="p">(</span><span class="n">UserBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">PostBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">PostCreate</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PostResult</span><span class="p">(</span><span class="n">PostBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">CommentBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">CommentCreate</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CommentResult</span><span class="p">(</span><span class="n">CommentBase</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">orm_mode</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="api-endpoints">API端点</h3>
<p>现在，让我们添加API端点。在<em> main.py </em>文件中，导入Pydantic模式和Masonite模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">schema</span>

<span class="kn">from</span> <span class="nn">models.Post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models.User</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">models.Comment</span> <span class="kn">import</span> <span class="n">Comment</span>
</code></pre></div>

<p>要获取所有用户，可以使用Masonite的<a href="https://orm.masoniteproject.com/models#selecting">。集合实例上用户模型的所有方法调用</a>返回:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/users"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">UserResult</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_all_users</span><span class="p">():</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>确保导入<code>typing.List</code>:</p>


<p>要添加用户，请添加以下发布端点:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/api/v1/users"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">UserResult</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">UserCreate</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"email"</span><span class="p">,</span> <span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"User already exists"</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">email</span>
    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">name</span>
    <span class="n">user</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">address</span>
    <span class="n">user</span><span class="o">.</span><span class="n">sex</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">sex</span>
    <span class="n">user</span><span class="o">.</span><span class="n">phone_number</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">phone_number</span>

    <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c1"># saves user details to the database.</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<p>导入<a href="https://fastapi.tiangolo.com/tutorial/handling-errors/#import-httpexception">http异常</a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</code></pre></div>

<p>检索单个用户:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/users/</span><span class="si">{user_id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">UserResult</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_single_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<p>发布端点:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/posts"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">PostResult</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_all_posts</span><span class="p">():</span>
    <span class="n">all_posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">all_posts</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/posts/</span><span class="si">{post_id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">PostResult</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_single_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">post</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/api/v1/posts"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">PostResult</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_new_post</span><span class="p">(</span><span class="n">post_data</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">PostCreate</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post_data</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"User not found"</span><span class="p">)</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">()</span>
    <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">title</span>
    <span class="n">post</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">body</span>
    <span class="n">post</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">user_id</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">user</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"posts"</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>

<p>我们将来自API的数据保存到数据库上的<code>posts</code>表中，然后为了将帖子链接到用户，我们附加了它，以便当我们调用<code>user.posts()</code>时，我们可以获得用户的所有帖子。</p>
<p>注释端点:</p>
<div class="codehilite"><pre><span/><code><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/api/v1/</span><span class="si">{post_id}</span><span class="s2">/comments"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">CommentResult</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_new_comment</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">comment_data</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">CommentCreate</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"Post not found"</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">comment_data</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">"User not found"</span><span class="p">)</span>

    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">()</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">comment_data</span><span class="o">.</span><span class="n">body</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">comment_data</span><span class="o">.</span><span class="n">user_id</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">post_id</span> <span class="o">=</span> <span class="n">post_id</span>

    <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">user</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="n">post</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">comment</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/posts/</span><span class="si">{post_id}</span><span class="s2">/comments"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">CommentResult</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_post_comments</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/users/</span><span class="si">{user_id}</span><span class="s2">/comments"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">CommentResult</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_user_comments</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<p>如果FastAPI服务器尚未运行，请启动它:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ uvicorn main:app --reload
</code></pre></div>

<p>导航到<a href="http://localhost:8000/docs">http://localhost:8000/docs</a>查看所有端点的Swagger/OpenAPI文档。测试每个端点以查看响应。</p>
<h2 id="tests">试验</h2>
<p>因为我们是好公民，我们会增加一些测试。</p>
<h3 id="fixtures">固定装置</h3>
<p>让我们为上面的代码编写测试。因为我们将使用<a href="https://docs.pytest.org/"> pytest </a>，继续将依赖项添加到<em> requirements.txt </em>文件中:</p>


<p>我们还需要<a href="https://www.python-httpx.org/"> HTTPX </a>库，因为FastAPI的<a href="https://fastapi.tiangolo.com/tutorial/testing/"> TestClient </a>基于它。也将其添加到需求文件中:</p>


<p>安装:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>.env<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>接下来，让我们为测试创建一个单独的配置文件，这样我们就不会覆盖主开发数据库中的数据。在“config”文件夹中，创建一个名为<em> test_config.py </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/test_config.py</span>

<span class="kn">from</span> <span class="nn">masoniteorm.connections</span> <span class="kn">import</span> <span class="n">ConnectionResolver</span>


<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"default"</span><span class="p">:</span> <span class="s2">"sqlite"</span><span class="p">,</span>
  <span class="s2">"sqlite"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"driver"</span><span class="p">:</span> <span class="s2">"sqlite"</span><span class="p">,</span>
    <span class="s2">"database"</span><span class="p">:</span> <span class="s2">"db.sqlite3"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">DB</span> <span class="o">=</span> <span class="n">ConnectionResolver</span><span class="p">()</span><span class="o">.</span><span class="n">set_connection_details</span><span class="p">(</span><span class="n">DATABASES</span><span class="p">)</span>
</code></pre></div>

<p>注意，它类似于我们在<em> config/database.py </em>文件中的内容。唯一的区别是我们将<code>default</code>设置为<code>sqlite</code>,因为我们想要使用SQLite进行测试。</p>
<p>为了将我们的测试套件设置为总是使用我们在<em> test_config.py </em>配置中的配置，而不是默认的<em> database.py </em>文件，我们可以使用pytest的<a href="https://docs.pytest.org/en/latest/fixture.html#autouse-fixtures-fixtures-you-don-t-have-to-request"> autouse </a> fixture。</p>
<p>创建一个名为“tests”的新文件夹，并在这个新文件夹中创建一个<em> conftest.py </em>文件:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_database</span><span class="p">():</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="s2">"config/test_config.py"</span>

    <span class="n">migrator</span> <span class="o">=</span> <span class="n">Migration</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">create_table_if_not_exists</span><span class="p">()</span>

    <span class="n">migrator</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</code></pre></div>

<p>这里，我们将Masonite的迁移配置路径设置为<em> config/test_config.py </em>文件，创建了<code>migration</code>表(如果之前还没有创建的话),然后刷新所有的迁移。因此，每个测试都将从数据库的一个干净副本开始。</p>
<p>现在，让我们为用户、帖子和评论定义一些装置:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">masoniteorm.migrations</span> <span class="kn">import</span> <span class="n">Migration</span>

<span class="kn">from</span> <span class="nn">models.Comment</span> <span class="kn">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">models.Post</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">models.User</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_database</span><span class="p">():</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="s2">"config/test_config.py"</span>

    <span class="n">migrator</span> <span class="o">=</span> <span class="n">Migration</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">create_table_if_not_exists</span><span class="p">()</span>

    <span class="n">migrator</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"John Doe"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="s2">"United States of Nigeria"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">phone_number</span> <span class="o">=</span> <span class="mi">123456789</span>
    <span class="n">user</span><span class="o">.</span><span class="n">sex</span> <span class="o">=</span> <span class="s2">"male"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="84e2ebebc4e6e5f6aae7ebe9">[email protected]</a>"</span>
    <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">()</span>
    <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">"Test Title"</span>
    <span class="n">post</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">"this is the post body and can be as long as possible"</span>
    <span class="n">post</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">user</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"posts"</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">post</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">()</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">"This is a comment body"</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">comment</span><span class="o">.</span><span class="n">post_id</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span>

    <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">user</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="n">post</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"comments"</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">comment</span>
</code></pre></div>

<p>至此，我们现在可以开始编写一些测试了。</p>
<h3 id="test-specs">测试规格</h3>
<p>在“tests”文件夹中创建一个名为<em> test_views.py </em>的新测试文件。</p>
<p>首先添加以下代码来实例化一个<a href="https://fastapi.tiangolo.com/tutorial/testing/"> TestClient </a>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># =&gt; FastAPI app created in our main.py file</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</code></pre></div>

<p>现在，我们将测试添加到:</p>
<ol>
<li>保存用户</li>
<li>获取所有用户</li>
<li>使用用户ID获取单个用户</li>
</ol>
<p>代码:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># =&gt; FastAPI app created in our main.py file</span>
<span class="kn">from</span> <span class="nn">models.User</span> <span class="kn">import</span> <span class="n">User</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_create_new_user</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># Asserting that there's no user in the database</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"My name"</span><span class="p">,</span>
        <span class="s2">"email"</span><span class="p">:</span> <span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0f7b6a7c7b4f7b6a7c7b216c6062">[email protected]</a>"</span><span class="p">,</span>
        <span class="s2">"address"</span><span class="p">:</span> <span class="s2">"My full Address"</span><span class="p">,</span>
        <span class="s2">"sex"</span><span class="p">:</span> <span class="s2">"male"</span><span class="p">,</span>
        <span class="s2">"phone_number"</span><span class="p">:</span> <span class="mi">123456789</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/api/v1/users"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">test_get_all_user_details</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/api/v1/users"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"email"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>


<span class="c1"># Test to get a single user</span>
<span class="k">def</span> <span class="nf">test_get_single_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">"/api/v1/users/</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">"email"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</code></pre></div>

<p>运行测试以确保它们通过:</p>


<p>尝试为帖子和评论视图编写测试。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何将Masonite ORM与FastAPI一起使用。Masonite ORM是一个相对较新的ORM库，有一个活跃的社区。如果您有使用astorar ORM(或者任何其他基于Python的ORM)的经验，Masonite ORM应该很容易使用。</p>
  </div>

  </div>    
</body>
</html>