<html>
<head>
<title>Django Session-based Auth for Single Page Apps </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django基于会话的单页应用授权</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-spa-auth/#0001-01-01">https://testdriven.io/blog/django-spa-auth/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本文中，我们将看看如何使用基于会话的认证来认证<a href="https://en.wikipedia.org/wiki/Single-page_application">单页面应用程序</a> (SPAs)。我们将使用<a href="https://www.djangoproject.com/"> Django </a>作为后端，而前端将使用<a href="https://reactjs.org/"> React </a>构建，这是一个为构建用户界面而设计的JavaScript库。</p>
<blockquote>
<p>请随意将React替换为不同的工具，如Angular、Vue或Svelte。</p>
</blockquote>



<h2 id="session-vs-token-based-auth">会话与基于令牌的身份验证</h2>
<h3 id="what-are-they">它们是什么？</h3>
<p>使用基于会话的身份验证，会生成一个会话，并将ID存储在cookie中。</p>
<p>登录后，服务器会验证凭据。如果有效，它生成一个会话，存储它，然后将会话id发送回浏览器。浏览器将会话ID存储为cookie，每当向服务器发出请求时，就会发送该cookie。</p>
<p><img data-src="/static/images/blog/flask/flask-spa-auth/session_workflow.png" loading="lazy" class="lazyload" alt="session-based auth workflow" src="../Images/fa2af016022ab82e5dae1d461651b00f.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-spa-auth/session_workflow.png"/></p>
<p>基于会话的身份验证是有状态的。每当客户端请求服务器时，服务器必须在内存中定位会话，以便将会话ID绑定到相关用户。</p>
<p>另一方面，与基于会话的身份验证相比，基于令牌的身份验证相对较新。随着水疗和RESTful APIs的兴起，它获得了牵引力。</p>
<p>登录后，服务器验证凭据，如果有效，则创建一个签名令牌并发送回浏览器。大多数情况下，令牌存储在localStorage中。然后，当向服务器发出请求时，客户端会将令牌添加到报头中。假设请求来自授权来源，服务器解码令牌并检查其有效性。</p>
<p><img data-src="/static/images/blog/flask/flask-spa-auth/token_workflow.png" loading="lazy" class="lazyload" alt="token-based auth workflow" src="../Images/2455f647bc1733762c9b9d71c0620221.png" data-original-src="https://testdriven.io/static/images/blog/flask/flask-spa-auth/token_workflow.png"/></p>
<p>令牌是对用户信息进行编码的字符串。</p>
<p>例如:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// token header</span><span class="w"/>
<span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="c1">// token payload</span><span class="w"/>
<span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>令牌可以被验证和信任，因为它是使用秘密密钥或公钥/私钥对进行数字签名的。最常见的令牌类型是<a href="https://jwt.io/"> JSON Web令牌</a> (JWT)。</p>
<p>由于令牌包含服务器验证用户身份所需的所有信息，因此基于令牌的身份验证是无状态的。</p>
<blockquote>
<p>有关会话和令牌的更多信息，请查看Stack Exchange中的<a href="https://security.stackexchange.com/questions/81756/session-authentication-vs-token-authentication">会话认证与令牌认证</a>。</p>
</blockquote>
<h3 id="security-vulnerabilities">安全漏洞</h3>
<p>如前所述，基于会话的身份验证在cookie中维护客户端的状态。虽然JWT可以存储在localStorage或cookie中，但是大多数基于令牌的auth实现都将JWT存储在localStorage中。这两种方法都存在潜在的安全问题:</p>

<p>CSRF是一种针对web应用程序的攻击，攻击者试图欺骗经过身份验证的用户执行恶意操作。大多数CSRF攻击的目标是使用基于cookie的身份验证的web应用程序，因为web浏览器包括与每个请求的特定域相关联的所有cookie。因此，当发出恶意请求时，攻击者可以很容易地利用存储的cookies。</p>
<blockquote>
<p>要了解更多关于CSRF和如何在烧瓶中预防它，请查看烧瓶中的<a href="/blog/csrf-flask/"> CSRF保护</a>文章。</p>
</blockquote>
<p>XSS攻击是一种注入类型，恶意脚本被注入客户端，通常是为了绕过浏览器的同源策略。在localStorage中存储令牌的Web应用程序容易受到XSS攻击。打开浏览器并导航到任何站点。在开发者工具中打开控制台，输入<code>JSON.stringify(localStorage)</code>。按回车键。这应该以JSON序列化的形式打印localStorage元素。脚本访问localStorage就是这么容易。</p>
<blockquote>
<p>关于在哪里存储jwt的更多信息，请查看<a href="https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage">在哪里存储jwt——cookie与HTML5 Web存储</a>。</p>
</blockquote>
<h2 id="setting-up-session-based-auth">设置基于会话的身份验证</h2>
<p>本教程涵盖了以下将Django与前端库或框架相结合的方法:</p>
<ol>
<li>通过Django模板提供框架</li>
<li>在同一个域上独立于Django提供框架</li>
<li>与Django分开提供框架，Django REST框架在同一个域中</li>
<li>在不同的域上独立于Django提供框架</li>
</ol>
<blockquote>
<p>同样，你也可以随意替换React作为你选择的前端——例如，棱角分明的，脆弱的，苗条的。</p>
</blockquote>
<h2 id="frontend-served-from-django">Django提供前台服务</h2>
<p>使用这种方法，我们将直接从Django提供React应用程序。这种方法是最容易建立的。</p>
<h3 id="backend">后端</h3>
<p>让我们首先为我们的项目创建一个新目录。在目录中，我们将创建并激活一个新的虚拟环境，安装Django，并创建一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django_react_templates <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django_react_templates
$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.1.4
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject djangocookieauth .
</code></pre></div>

<p>之后，创建一个名为<code>api</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp api
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em>djangookieauth/settings . py</em>中注册app:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangocookieauth/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'api.apps.ApiConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>我们的应用将拥有以下API端点:</p>
<ol>
<li><code>/api/login/</code>允许用户通过提供用户名和密码登录</li>
<li><code>/api/logout/</code>注销用户</li>
<li><code>/api/session/</code>检查会话是否存在</li>
<li><code>/api/whoami/</code>获取已验证用户的用户数据</li>
</ol>
<p>对于视图，在这里获取完整的代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_templates/api/views.py">，并将其添加到<em> api/views.py </em>文件中。</a></p>
<p>向“api”添加一个<em> urls.py </em>文件，并定义以下URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">logout_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-logout'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">session_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-session'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'whoami/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">whoami_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-whoami'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，让我们将我们的应用程序URL注册到基础项目:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangocookieauth/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>  <span class="c1"># new import</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'api.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>我们后端的代码现在差不多完成了。运行migrate命令并创建一个超级用户以供将来测试:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>env<span class="o">)</span>$ python manage.py createsuperuser
</code></pre></div>

<p>最后，更新<em>djangookieauth/settings . py</em>中的以下安全设置:</p>
<div class="codehilite"><pre><span/><code><span class="n">CSRF_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Strict'</span>
<span class="n">SESSION_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Strict'</span>
<span class="n">CSRF_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># False since we will grab it via universal-cookies</span>
<span class="n">SESSION_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># PROD ONLY</span>
<span class="c1"># CSRF_COOKIE_SECURE = True</span>
<span class="c1"># SESSION_COOKIE_SECURE = True</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>将<code>CSRF_COOKIE_SAMESITE</code>和<code>SESSION_COOKIE_SAMESITE</code>设置为<code>True</code>可以防止任何外部请求发送cookies和CSRF令牌。</li>
<li>将<code>CSRF_COOKIE_HTTPONLY</code>和<code>SESSION_COOKIE_HTTPONLY</code>设置为<code>True</code>会阻止客户端JavaScript访问CSRF和会话cookies。我们将<code>CSRF_COOKIE_HTTPONLY</code>设置为<code>False</code>，因为我们将通过JavaScript访问cookie。</li>
</ol>
<blockquote>
<p>如果你在制作中，你应该通过HTTPS服务你的网站并启用<code>CSRF_COOKIE_SECURE</code>和<code>SESSION_COOKIE_SECURE</code>，这将只允许cookies通过HTTPS发送。</p>
</blockquote>
<h3 id="frontend">前端</h3>
<p>在你开始前端工作之前，确保你已经安装了<a href="https://nodejs.org/en/"> Node.js </a>和<a href="https://www.npmjs.com/"> npm </a>(或者<a href="https://yarnpkg.com/"> Yarn </a>)。</p>
<p>我们将使用<a href="https://create-react-app.dev/"> Create React App </a>来搭建一个新的React项目:</p>
<div class="codehilite"><pre><span/><code>$ npx create-react-app frontend
$ <span class="nb">cd</span> frontend
$ npm start
</code></pre></div>

<p>这将在端口3000上启动我们的应用程序。访问<a href="http://localhost:3000"> http://localhost:3000 </a>以确保其工作正常:</p>
<p><img data-src="/static/images/blog/django/django-spa-auth/react.png" loading="lazy" class="lazyload" alt="React default page" src="../Images/9496e7026974c934aadd2b59f247c0e7.png" data-original-src="https://testdriven.io/static/images/blog/django/django-spa-auth/react.png"/></p>
<p>您可以通过删除所有文件和文件夹来简化前端，除了:</p>
<div class="codehilite"><pre><span/><code>├── README.md
├── node_modules
├── package-lock.json
├── package.json
├── public
│   ├── favicon.ico
│   ├── index.html
│   ├── manifest.json
│   └── robots.txt
└── src
    ├── App.js
    ├── index.css
    └── index.js
</code></pre></div>

<p>接下来，让我们添加Bootstrap<em>frontend/public/index . html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- frontend/public/index.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/favicon.ico"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"theme-color"</span> <span class="na">content</span><span class="o">=</span><span class="s">"#000000"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span>
      <span class="na">name</span><span class="o">=</span><span class="s">"description"</span>
      <span class="na">content</span><span class="o">=</span><span class="s">"Web site created using create-react-app"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/logo192.png"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"manifest"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/manifest.json"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>React App<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- new --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- end of new --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">noscript</span><span class="p">&gt;</span>You need to enable JavaScript to run this app.<span class="p">&lt;/</span><span class="nt">noscript</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"root"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>接下来，我们将使用<a href="https://github.com/reactivestack/cookies/tree/master/packages/universal-cookie"> universal-cookie </a>将cookie加载到React应用程序中。</p>
<p>从“前端”文件夹安装它:</p>
<div class="codehilite"><pre><span/><code>$ npm install universal-cookie
</code></pre></div>

<p>抓取<code>App</code>组件的完整代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_templates/frontend/src/App.js">在这里</a>，并将其添加到<em> frontend/src/App.js </em>文件中。</p>
<p>这只是一个简单的带有表单的前端应用程序，由React state处理。在页面加载时，<code>compontentDidMount()</code>被调用，它获取会话并将<code>isAuthenticated</code>设置为<code>true</code>或<code>false</code>。</p>
<p>我们使用<code>universal-cookie</code>获得了CSRF令牌，并在我们的请求中将其作为报头传递给了<code>X-CSRFToken</code>:</p>
<div class="codehilite"><pre><span/><code><span class="k">import</span><span class="w"> </span><span class="nx">Cookies</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"universal-cookie"</span><span class="p">;</span><span class="w"/>

<span class="kd">const</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Cookies</span><span class="p">();</span><span class="w"/>

<span class="nx">login</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span><span class="w"/>
<span class="w">  </span><span class="nx">fetch</span><span class="p">(</span><span class="s2">"/api/login/"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="s2">"Content-Type"</span><span class="o">:</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w"/>
<span class="w">        </span><span class="s2">"X-CSRFToken"</span><span class="o">:</span><span class="w"> </span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"csrftoken"</span><span class="p">),</span><span class="w"/>
<span class="w">      </span><span class="p">},</span><span class="w"/>
<span class="w">      </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s2">"same-origin"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="p">}),</span><span class="w"/>
<span class="w">    </span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isResponseOk</span><span class="p">)</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">isAuthenticated</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">""</span><span class="p">});</span><span class="w"/>
<span class="w">    </span><span class="p">})</span><span class="w"/>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"/>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s2">"Wrong username or password."</span><span class="p">});</span><span class="w"/>
<span class="w">    </span><span class="p">});</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>请注意，对于每个请求，我们都使用了<code>credentials: same-origin</code>。这是必需的，因为如果URL与调用脚本来源相同，我们希望浏览器在每个HTTP请求中传递cookies。</p>
<p>更新<em> frontend/src/index.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// frontend/src/index.js</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ReactDOM</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react-dom"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"./App.js"</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="s2">"./index.css"</span><span class="p">;</span><span class="w"/>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="nx">React</span><span class="p">.</span><span class="nx">StrictMode</span><span class="o">&gt;</span><span class="w"/>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">App</span><span class="w"> </span><span class="o">/&gt;</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="err">/React.StrictMode&gt;,</span><span class="w"/>
<span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span><span class="w"/>
<span class="p">);</span><span class="w"/>
</code></pre></div>

<h3 id="serving-react">上菜反应</h3>
<p>首先，构建前端应用程序:</p>


<p>这个命令将生成“build”文件夹，我们的后端将使用它来提供React应用程序。</p>
<p>接下来，我们必须让Django知道我们的React应用程序在哪里:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangocookieauth/settings.py</span>

<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">'BACKEND'</span><span class="p">:</span> <span class="s1">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
        <span class="s1">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="n">BASE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">'frontend'</span><span class="p">)],</span>  <span class="c1"># new</span>
        <span class="s1">'APP_DIRS'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'context_processors'</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">'django.template.context_processors.debug'</span><span class="p">,</span>
                <span class="s1">'django.template.context_processors.request'</span><span class="p">,</span>
                <span class="s1">'django.contrib.auth.context_processors.auth'</span><span class="p">,</span>
                <span class="s1">'django.contrib.messages.context_processors.messages'</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="o">...</span>

<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s1">'/static/'</span>

<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">BASE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">'frontend'</span><span class="p">,</span> <span class="s1">'build'</span><span class="p">,</span> <span class="s1">'static'</span><span class="p">),</span>  <span class="c1"># new</span>
<span class="p">)</span>
</code></pre></div>

<blockquote>
<p>如果你使用的是Django的旧版本，确保导入<code>os</code>并使用<a href="https://docs.python.org/3/library/os.path.html#os.path.join"> os.path.join </a>而不是<a href="https://docs.python.org/3/library/pathlib.html#pathlib.PurePath.joinpath"> joinpath </a>。</p>
</blockquote>
<p>让我们为我们的应用程序创建索引视图:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangocookieauth/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>


<span class="c1"># new</span>
<span class="k">def</span> <span class="nf">index_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'build/index.html'</span><span class="p">)</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'api.urls'</span><span class="p">)),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">index_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'index'</span><span class="p">),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>因为Django最终提供前端服务，所以CSRF cookie将被自动设置。</p>
<p>从项目根目录，使用<code>runserver</code>命令运行Django服务器，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>打开浏览器，导航到<a href="https://localhost:8000"> https://localhost:8000/ </a>。您的React应用程序现在通过Django模板提供服务。</p>
<p><img data-src="/static/images/blog/django/django-spa-auth/templates1.png" loading="lazy" class="lazyload" alt="Login page" src="../Images/a61762137cce441ab6101abf8827f36c.png" data-original-src="https://testdriven.io/static/images/blog/django/django-spa-auth/templates1.png"/></p>
<p>在加载时，设置CSRF cookie，用于后续的AJAX请求。如果用户输入了正确的用户名和密码，它会对他们进行身份验证，并将<code>sessionid</code> cookie保存到他们的浏览器中。</p>
<p><img data-src="/static/images/blog/django/django-spa-auth/loggedin.png" loading="lazy" class="lazyload" alt="Session page" src="../Images/ceb1f323964db434d2eeb051b33abe3d.png" data-original-src="https://testdriven.io/static/images/blog/django/django-spa-auth/loggedin.png"/></p>
<p>您可以用之前创建的超级用户来测试它。</p>
<p>从GitHub获取该方法的完整代码:<a href="https://github.com/duplxey/django-spa-cookie-auth/tree/master/django_react_templates"> django_react_templates </a>。</p>
<h2 id="frontend-served-separately-same-domain">单独提供前端服务(同一域)</h2>
<p>使用这种方法，我们将构建前端，并在同一个域中独立于Django应用程序提供它。我们将使用Docker和Nginx在本地同一域上提供这两个应用程序。</p>
<p>模板方法和这种方法的主要区别在于，我们必须在加载时手动获取CSRF令牌。</p>
<p>首先创建一个项目目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django_react_same_origin <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django_react_same_origin
</code></pre></div>

<h3 id="backend_1">后端</h3>
<p>首先，为Django项目创建一个名为“backend”的新目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir backend <span class="o">&amp;&amp;</span> <span class="nb">cd</span> backend
</code></pre></div>

<p>接下来，创建并激活一个新的虚拟环境，安装Django，并创建一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.1.4
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject djangocookieauth .
</code></pre></div>

<p>之后，创建一个名为<code>api</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp api
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em>djangookieauth/settings . py</em>中注册app:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'api.apps.ApiConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>我们的应用将拥有以下API端点:</p>
<ol>
<li>将生成一个CSRF令牌并以JSON的形式返回</li>
<li><code>/api/login/</code>允许用户通过提供用户名和密码登录</li>
<li><code>/api/logout/</code>注销用户</li>
<li><code>/api/session/</code>检查会话是否存在</li>
<li><code>/api/whoami/</code>获取已验证用户的用户数据</li>
</ol>
<p>对于视图，在这里获取完整代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_same_origin/backend/api/views.py">，并将其添加到<em>后端/api/views.py </em>文件中。</a></p>
<p>向“后端/api”添加一个<em> urls.py </em>文件，并定义以下特定于应用程序的URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'csrf/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_csrf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-csrf'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">logout_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-logout'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">session_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-session'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'whoami/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">whoami_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-whoami'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，让我们将我们的应用程序URL注册到基础项目:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>  <span class="c1"># new import</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'api.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>让我们更改一下<em>back end/djangookieauth/settings . py</em>中的一些安全设置:</p>
<div class="codehilite"><pre><span/><code><span class="n">CSRF_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Strict'</span>
<span class="n">SESSION_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Strict'</span>
<span class="n">CSRF_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SESSION_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># PROD ONLY</span>
<span class="c1"># CSRF_COOKIE_SECURE = True</span>
<span class="c1"># SESSION_COOKIE_SECURE = True</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>启用<code>CSRF_COOKIE_SAMESITE</code>和<code>SESSION_COOKIE_SAMESITE</code>可防止任何外部请求发送cookies和CSRF令牌。</li>
<li>启用<code>CSRF_COOKIE_HTTPONLY</code>和<code>SESSION_COOKIE_HTTPONLY</code>会阻止客户端JavaScript访问CSRF和会话cookies。</li>
</ol>
<blockquote>
<p>如果你在制作中，你应该通过HTTPS服务你的网站并启用<code>CSRF_COOKIE_SECURE</code>和<code>SESSION_COOKIE_SECURE</code>，这将只允许cookies通过HTTPS发送。</p>
</blockquote>
<p>创建一个<em>后端/需求. txt </em>文件:</p>


<h3 id="frontend_1">前端</h3>
<p>在你开始前端工作之前，确保你已经安装了<a href="https://nodejs.org/en/"> Node.js </a>和<a href="https://www.npmjs.com/"> npm </a>(或者<a href="https://yarnpkg.com/"> Yarn </a>)。</p>
<p>我们将使用<a href="https://create-react-app.dev/"> Create React App </a>来搭建一个新的React项目。</p>
<p>从项目根目录运行:</p>
<div class="codehilite"><pre><span/><code>$ npx create-react-app frontend
$ <span class="nb">cd</span> frontend
$ npm start
</code></pre></div>

<p>这将在端口3000上启动我们的应用程序。访问<a href="http://localhost:3000"> http://localhost:3000 </a>以确保其工作正常:</p>
<p><img data-src="/static/images/blog/django/django-spa-auth/react.png" loading="lazy" class="lazyload" alt="React default page" src="../Images/9496e7026974c934aadd2b59f247c0e7.png" data-original-src="https://testdriven.io/static/images/blog/django/django-spa-auth/react.png"/></p>
<p>您可以通过删除所有文件和文件夹来简化前端，除了:</p>
<div class="codehilite"><pre><span/><code>├── README.md
├── node_modules
├── package-lock.json
├── package.json
├── public
│   ├── favicon.ico
│   ├── index.html
│   ├── manifest.json
│   └── robots.txt
└── src
    ├── App.js
    ├── index.css
    └── index.js
</code></pre></div>

<p>接下来，让我们添加Bootstrap<em>frontend/public/index . html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- frontend/public/index.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/favicon.ico"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"theme-color"</span> <span class="na">content</span><span class="o">=</span><span class="s">"#000000"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span>
      <span class="na">name</span><span class="o">=</span><span class="s">"description"</span>
      <span class="na">content</span><span class="o">=</span><span class="s">"Web site created using create-react-app"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/logo192.png"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"manifest"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/manifest.json"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>React App<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- new --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- end of new --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">noscript</span><span class="p">&gt;</span>You need to enable JavaScript to run this app.<span class="p">&lt;/</span><span class="nt">noscript</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"root"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>抓取<code>App</code>组件的完整代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_same_origin/frontend/src/App.js">在这里</a>，并将其添加到<em> frontend/src/App.js </em>文件中。</p>
<p>这只是一个简单的带有表单的前端应用程序，由React state处理。在页面加载时，<code>compontentDidMount()</code>被调用，它执行两个API调用:</p>
<ol>
<li>首先，它通过调用<code>/api/session/</code>检查用户是否被认证，并将<code>isAuthenticated</code>设置为<code>true</code>或<code>false</code>。</li>
<li>如果用户没有通过认证，它从<code>/api/csrf/</code>获取CSRF令牌，并将其保存到状态。</li>
</ol>
<p>请注意，对于每个请求，我们都使用了<code>credentials: same-origin</code>。这是必需的，因为如果URL与调用脚本来源相同，我们希望浏览器在每个HTTP请求中传递cookies。</p>
<p>更新<em> frontend/src/index.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// frontend/src/index.js</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ReactDOM</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react-dom"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"./App.js"</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="s2">"./index.css"</span><span class="p">;</span><span class="w"/>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="nx">React</span><span class="p">.</span><span class="nx">StrictMode</span><span class="o">&gt;</span><span class="w"/>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">App</span><span class="w"> </span><span class="o">/&gt;</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="err">/React.StrictMode&gt;,</span><span class="w"/>
<span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span><span class="w"/>
<span class="p">);</span><span class="w"/>
</code></pre></div>

<h3 id="docker">码头工人</h3>
<p>接下来，让我们对两个应用程序进行Dockerize。</p>
<h4 id="backend_2">后端</h4>
<div class="codehilite"><pre><span/><code><span class="c"># backend/Dockerfile</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.0-slim-buster</span>

<span class="c"># set working directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># add app</span>
<span class="k">COPY</span><span class="w"> </span>. .

<span class="c"># start app</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"python"</span><span class="p">,</span><span class="w"> </span><span class="s2">"manage.py"</span><span class="p">,</span><span class="w"> </span><span class="s2">"runserver"</span><span class="p">,</span><span class="w"> </span><span class="s2">"0.0.0.0:8000"</span><span class="p">]</span>
</code></pre></div>

<h4 id="frontend_2">前端</h4>
<div class="codehilite"><pre><span/><code><span class="c"># frontend/Dockerfile</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:15.2.0-alpine</span>

<span class="c"># set working directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># add `/usr/src/app/node_modules/.bin` to $PATH</span>
<span class="k">ENV</span><span class="w"> </span>PATH /usr/src/app/node_modules/.bin:<span class="nv">$PATH</span>

<span class="c"># install and cache app dependencies</span>
<span class="k">COPY</span><span class="w"> </span>package.json .
<span class="k">COPY</span><span class="w"> </span>package-lock.json .
<span class="k">RUN</span><span class="w"> </span>npm ci
<span class="k">RUN</span><span class="w"> </span>npm install <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="146671757760396777667d64606754203a243a24">[email protected]</a> -g --silent

<span class="c"># start app</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"npm"</span><span class="p">,</span><span class="w"> </span><span class="s2">"start"</span><span class="p">]</span>
</code></pre></div>

<h4 id="nginx">Nginx</h4>
<p>为了在同一个域上运行这两个应用程序，让我们为Nginx添加一个作为反向代理的容器。在项目根目录下创建一个名为“nginx”的新文件夹。</p>
<div class="codehilite"><pre><span/><code><span class="c"># nginx/Dockerfile</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">nginx:latest</span>
<span class="k">COPY</span><span class="w"> </span>./nginx.conf /etc/nginx/nginx.conf
</code></pre></div>

<p>同样添加一个<em> nginx/nginx.conf </em>配置文件。你可以在这里找到它的代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_same_origin/nginx/nginx.conf"/>。</p>
<p>注意两个<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">位置</a>块:</p>
<div class="codehilite"><pre><span/><code><span class="err">#</span><span class="w"> </span><span class="nt">nginx</span><span class="o">/</span><span class="nt">nginx</span><span class="p">.</span><span class="nc">conf</span><span class="w"/>

<span class="nt">location</span><span class="w"> </span><span class="o">/</span><span class="nt">api</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="err">proxy_pass</span><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">backend</span><span class="o">:</span><span class="mi">8000</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="err">...</span><span class="w"/>
<span class="p">}</span><span class="w"/>

<span class="nt">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="err">proxy_pass</span><span class="w">              </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">frontend</span><span class="o">:</span><span class="mi">8000</span><span class="p">;</span><span class="w"/>
<span class="w">  </span><span class="err">...</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>对<code>/</code>的请求将被转发到http://frontend:8000 (frontend是Docker Compose文件中服务的名称，我们稍后将添加它)，而对<code>/api</code>的请求将被转发到http://backend:8000 (backend是Docker Compose文件中服务的名称)。</p>
<h4 id="docker-compose">复合坞站</h4>
<p>在项目根目录中创建一个<em> docker-compose.yml </em>文件，并添加以下内容:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>

<span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./backend</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./backend:/usr/src/app</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>

<span class="w">  </span><span class="nt">frontend</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">stdin_open</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./frontend</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./frontend:/usr/src/app</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/src/app/node_modules</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_ENV=development</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span><span class="w"/>

<span class="w">  </span><span class="nt">reverse_proxy</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">81:80</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span><span class="w"/>
</code></pre></div>

<p>您的项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── backend
│   ├── Dockerfile
│   ├── api
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── migrations
│   │   │   └── __init__.py
│   │   ├── models.py
│   │   ├── tests.py
│   │   ├── urls.py
│   │   └── views.py
│   ├── djangocookieauth
│   │   ├── __init__.py
│   │   ├── asgi.py
│   │   ├── settings.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   ├── manage.py
│   └── requirements.txt
├── docker-compose.yml
├── frontend
│   ├── Dockerfile
│   ├── README.md
│   ├── package-lock.json
│   ├── package.json
│   ├── public
│   │   ├── favicon.ico
│   │   ├── index.html
│   │   ├── manifest.json
│   │   └── robots.txt
│   └── src
│       ├── App.js
│       ├── index.css
│       └── index.js
└── nginx
    ├── Dockerfile
    └── nginx.conf
</code></pre></div>

<h3 id="running-with-docker">使用Docker运行</h3>
<p>构建图像并旋转容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<blockquote>
<p>如果你遇到“服务前端构建失败”，你的<em> package-lock.json </em>可能会丢失。移动到<em>前端</em>文件夹，运行<code>npm install --package-lock</code>生成。</p>
</blockquote>
<p>运行迁移并创建超级用户:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> backend python manage.py makemigrations
$ docker-compose <span class="nb">exec</span> backend python manage.py migrate
$ docker-compose <span class="nb">exec</span> backend python manage.py createsuperuser
</code></pre></div>

<p>您的应用程序应该可以在:<a href="http://localhost:81"> http://localhost:81 </a>访问。通过使用您刚刚创建的超级用户登录来测试它。</p>
<p>从GitHub获取该方法的完整代码:<a href="https://github.com/duplxey/django-spa-cookie-auth/tree/master/django_react_same_origin"> django_react_same_origin </a>。</p>
<h2 id="django-drf-frontend-served-separately-same-domain">姜戈DRF +前端分开服务(同一域)</h2>
<p>这种方法或多或少与前面的方法“前端分开服务(同一个域)”相同。下面列出了一些小的区别。</p>
<p>当使用这种方法时，你必须使用pip安装<code>djangorestframework</code>或将其添加到<em> requirements.txt </em>(如果用Docker构建)。安装后，你需要在<em>设置中的<code>INSTALLED_APPS</code>下注册它。</em></p>
<div class="codehilite"><pre><span/><code><span class="c1"># djangocookieauth/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'api.apps.ApiConfig'</span><span class="p">,</span>
    <span class="s1">'rest_framework'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>要启用<code>SessionAuthentication</code>，您必须将以下内容添加到您的<em>设置中。py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/settings.py</span>

<span class="c1"># Django REST framework</span>
<span class="c1"># https://www.django-rest-framework.org/api-guide/settings/</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DEFAULT_RENDERER_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'rest_framework.renderers.JSONRenderer'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'rest_framework.authentication.SessionAuthentication'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p>还建议将<code>JSONRenderer</code>设置为<code>DEFAULT_RENDERER_CLASSES</code>来禁用DRF导航和那个花哨的显示。</p>
</blockquote>
<p>创建session和whoami视图时，使用从<code>rest_framework</code>导入的<code>APIView</code>，并显式设置<code>authentication_classes</code>和<code>permission_classes</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/api/views.py</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>


<span class="k">class</span> <span class="nc">SessionView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'isAuthenticated'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>


<span class="k">class</span> <span class="nc">WhoAmIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">'username'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">})</span>
</code></pre></div>

<p>注册URL时，请像这样注册:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'csrf/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_csrf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-csrf'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">logout_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-logout'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SessionView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-session'</span><span class="p">),</span>  <span class="c1"># new</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'whoami/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">WhoAmIView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-whoami'</span><span class="p">),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>从GitHub获取该方法的完整代码:<a href="https://github.com/duplxey/django-spa-cookie-auth/tree/master/django_react_drf_same_origin">django _ react _ drf _ same _ origin</a>。</p>
<h2 id="frontend-served-separately-cross-domain">单独提供前端服务(跨域)</h2>
<p>使用这种方法，我们将构建前端，并在不同的域上独立于Django应用程序提供它。我们将不得不通过使用<a href="https://pypi.org/project/django-cors-headers/"> django-cors-headers </a>允许来自前端的跨域请求来稍微放宽安全性。</p>
<p>首先创建一个项目目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django_react_cross_origin <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django_react_cross_origin
</code></pre></div>

<h3 id="backend_3">后端</h3>
<p>首先，为Django项目创建一个名为“backend”的新目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir backend <span class="o">&amp;&amp;</span> <span class="nb">cd</span> backend
</code></pre></div>

<p>接下来，创建并激活一个新的虚拟环境，安装Django，并创建一个新的Django项目:</p>
<div class="codehilite"><pre><span/><code>$ python3.9 -m venv env
$ <span class="nb">source</span> env/bin/activate

<span class="o">(</span>env<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">3</span>.1.4
<span class="o">(</span>env<span class="o">)</span>$ django-admin.py startproject djangocookieauth .
</code></pre></div>

<p>之后，创建一个名为<code>api</code>的新应用:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py startapp api
</code></pre></div>

<p>在<code>INSTALLED_APPS</code>下的<em>back end/djangookieauth/settings . py</em>中注册app:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'api.apps.ApiConfig'</span><span class="p">,</span> <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>我们的应用将拥有以下API端点:</p>
<ol>
<li>将生成一个CSRF令牌并以JSON的形式返回</li>
<li><code>/api/login/</code>允许用户通过提供用户名和密码登录</li>
<li><code>/api/logout/</code>注销用户</li>
<li><code>/api/session/</code>检查会话是否存在</li>
<li><code>/api/whoami/</code>获取已验证用户的用户数据</li>
</ol>
<p>对于视图，在这里获取完整代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_cross_origin/backend/api/views.py">，并将其添加到<em>后端/api/views.py </em>文件中。</a></p>
<p>向“api”添加一个<em> urls.py </em>文件，并定义以下URL:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/api/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'csrf/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_csrf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-csrf'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">login_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-login'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">logout_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-logout'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'session/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">session_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-session'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'whoami/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">whoami_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'api-whoami'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，让我们将我们的应用程序URL注册到基础项目:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/urls.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>  <span class="c1"># new import</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">'api.urls'</span><span class="p">)),</span>  <span class="c1"># new</span>
<span class="p">]</span>
</code></pre></div>

<p>现在，我们必须放松一些安全设置，以便我们的请求能够通过。让我们首先在<em>back end/djangookieauth/settings . py</em>中设置我们的cookie设置:</p>
<div class="codehilite"><pre><span/><code><span class="n">CSRF_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Lax'</span>
<span class="n">SESSION_COOKIE_SAMESITE</span> <span class="o">=</span> <span class="s1">'Lax'</span>
<span class="n">CSRF_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SESSION_COOKIE_HTTPONLY</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># PROD ONLY</span>
<span class="c1"># CSRF_COOKIE_SECURE = True</span>
<span class="c1"># SESSION_COOKIE_SECURE = True</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>将<code>CSRF_COOKIE_SAMESITE</code>和<code>SESSION_COOKIE_SAMESITE</code>设置为<code>Lax</code>允许我们在外部请求中发送CSRF cookie。</li>
<li>启用<code>CSRF_COOKIE_HTTPONLY</code>和<code>SESSION_COOKIE_HTTPONLY</code>会阻止客户端JavaScript访问CSRF和会话cookies。</li>
</ol>
<blockquote>
<p>如果你在制作中，你应该通过HTTPS服务你的网站并启用<code>CSRF_COOKIE_SECURE</code>和<code>SESSION_COOKIE_SECURE</code>，这将只允许cookies通过HTTPS发送。</p>
</blockquote>
<p>为了允许跨源cookie保存，我们还需要更改一些CORS设置。为此我们将使用<code>django-cors-headers</code>。让我们从使用以下命令安装它开始:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ pip install django-cors-headers<span class="o">==</span><span class="m">3</span>.5.0
</code></pre></div>

<p>将它添加到您已安装的应用程序中，并添加一个新的中间件类:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s1">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s1">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s1">'api.apps.ApiConfig'</span><span class="p">,</span>
    <span class="s1">'corsheaders'</span><span class="p">,</span>  <span class="c1"># new</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'corsheaders.middleware.CorsMiddleware'</span><span class="p">,</span>  <span class="c1"># new</span>
    <span class="s1">'django.middleware.security.SecurityMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.common.CommonMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p>配置CORS:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># backend/djangocookieauth/settings.py</span>

<span class="n">CORS_ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'http://localhost:3000'</span><span class="p">,</span>
    <span class="s1">'http://127.0.0.1:3000'</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">CORS_EXPOSE_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'X-CSRFToken'</span><span class="p">]</span>
<span class="n">CORS_ALLOW_CREDENTIALS</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<p>注意事项:</p>
<ol>
<li>我们在<code>CORS_ALLOWED_ORIGINS</code>列表中设置了允许的原点。值得注意的是，出于测试目的，不使用<code>CORS_ALLOWED_ORIGINS</code>设置，而是将<code>CORS_ALLOW_ALL_ORIGIN</code>设置为<code>True</code>，以便允许任何来源发出请求。但是不要在生产中使用它。</li>
<li><code>CORS_EXPOSE_HEADERS</code>是暴露给浏览器的HTTP头列表。</li>
<li>将<code>CORS_ALLOW_CREDENTIALS</code>设置为<code>True</code>允许cookies随跨来源请求一起发送。</li>
</ol>
<p>我们后端的代码现在差不多完成了。让我们运行migrate命令并创建一个超级用户，以便将来进行测试:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>env<span class="o">)</span>$ python manage.py createsuperuser
</code></pre></div>

<h3 id="frontend_3">前端</h3>
<p>在你开始前端工作之前，确保你已经安装了<a href="https://nodejs.org/en/"> Node.js </a>和<a href="https://www.npmjs.com/"> npm </a>(或者<a href="https://yarnpkg.com/"> Yarn </a>)。</p>
<p>我们将使用<a href="https://create-react-app.dev/"> Create React App </a>来搭建一个新的React项目。</p>
<p>从项目根目录运行:</p>
<div class="codehilite"><pre><span/><code>$ npx create-react-app frontend
$ <span class="nb">cd</span> frontend
$ npm start
</code></pre></div>

<p>这将在端口3000上启动我们的应用程序。访问<a href="http://localhost:3000"> http://localhost:3000 </a>以确保其工作正常:</p>
<p><img data-src="/static/images/blog/django/django-spa-auth/react.png" loading="lazy" class="lazyload" alt="React default page" src="../Images/9496e7026974c934aadd2b59f247c0e7.png" data-original-src="https://testdriven.io/static/images/blog/django/django-spa-auth/react.png"/></p>
<p>您可以通过删除所有文件和文件夹来简化前端，除了:</p>
<div class="codehilite"><pre><span/><code>├── README.md
├── node_modules
├── package-lock.json
├── package.json
├── public
│   ├── favicon.ico
│   ├── index.html
│   ├── manifest.json
│   └── robots.txt
└── src
    ├── App.js
    ├── index.css
    └── index.js
</code></pre></div>

<p>接下来，让我们添加Bootstrap<em>frontend/public/index . html</em>:</p>
<div class="codehilite"><pre><span/><code><span class="cm">&lt;!-- frontend/public/index.html --&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"utf-8"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/favicon.ico"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"viewport"</span> <span class="na">content</span><span class="o">=</span><span class="s">"width=device-width, initial-scale=1"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"theme-color"</span> <span class="na">content</span><span class="o">=</span><span class="s">"#000000"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span>
      <span class="na">name</span><span class="o">=</span><span class="s">"description"</span>
      <span class="na">content</span><span class="o">=</span><span class="s">"Web site created using create-react-app"</span>
    <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"apple-touch-icon"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/logo192.png"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"manifest"</span> <span class="na">href</span><span class="o">=</span><span class="s">"%PUBLIC_URL%/manifest.json"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>React App<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- new --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">"stylesheet"</span> <span class="na">href</span><span class="o">=</span><span class="s">"https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">"anonymous"</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- end of new --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">noscript</span><span class="p">&gt;</span>You need to enable JavaScript to run this app.<span class="p">&lt;/</span><span class="nt">noscript</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"root"</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>抓取<code>App</code>组件的完整代码<a href="https://github.com/duplxey/django-spa-cookie-auth/blob/master/django_react_cross_origin/frontend/src/App.js">在这里</a>，并将其添加到<em> frontend/src/App.js </em>文件中。</p>
<p>这只是一个简单的带有表单的前端应用程序，由React state处理。在页面加载时，<code>compontentDidMount()</code>被调用，它执行两个API调用:</p>
<ol>
<li>首先，它通过调用<code>/api/session/</code>检查用户是否被认证，并将<code>isAuthenticated</code>设置为<code>true</code>或<code>false</code>。</li>
<li>如果用户没有通过认证，它从<code>/api/csrf/</code>获取CSRF令牌，并将其保存到状态。</li>
</ol>
<p>请注意，对于每个请求，我们都使用了<code>credentials: include</code>。这是必需的，因为我们希望浏览器通过每个HTTP请求传递cookies，即使URL与调用脚本的来源不同。请记住，我们在后端更改了一些CORS设置以允许这样做。</p>
<p>更新<em> frontend/src/index.js </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1">// frontend/src/index.js</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">ReactDOM</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"react-dom"</span><span class="p">;</span><span class="w"/>
<span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"./App.js"</span><span class="p">;</span><span class="w"/>

<span class="k">import</span><span class="w"> </span><span class="s2">"./index.css"</span><span class="p">;</span><span class="w"/>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="nx">React</span><span class="p">.</span><span class="nx">StrictMode</span><span class="o">&gt;</span><span class="w"/>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">App</span><span class="w"> </span><span class="o">/&gt;</span><span class="w"/>
<span class="w">  </span><span class="o">&lt;</span><span class="err">/React.StrictMode&gt;,</span><span class="w"/>
<span class="w">  </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span><span class="w"/>
<span class="p">);</span><span class="w"/>
</code></pre></div>

<h3 id="running-the-application">运行应用程序</h3>
<p>移动到您的<em>后端</em>文件夹，使用以下命令运行Django:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>env<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>您的后端应该可以访问:<a href="http://localhost:8000"> http://localhost:8000 </a>。</p>
<p>打开一个新的终端窗口，导航到“frontend”文件夹并启动React with npm:</p>


<p>您应该能够在<a href="http://localhost:3000"> http://localhost:3000 </a>访问您的应用程序。</p>
<p>通过使用您之前创建的超级用户登录来测试您的应用程序。</p>
<p>从GitHub获取该方法的完整代码:<a href="https://github.com/duplxey/django-spa-cookie-auth/tree/master/django_react_cross_origin/"> django_react_same_origin </a></p>
<h2 id="conclusion">结论</h2>
<p>本文详细介绍了如何使用Django和React为单页面应用程序设置基于会话的身份验证。无论您使用会话cookie还是令牌，当客户端是浏览器时，最好使用cookie进行身份验证。虽然最好从同一个域提供这两个应用程序，但您可以通过放宽跨域安全设置，在不同的域上提供它们。</p>
<p>我们研究了将Django与前端框架结合起来处理基于会话的授权的四种不同方法:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>前端</th>
<th>后端</th>
</tr>
</thead>
<tbody>
<tr>
<td>Django提供前台服务</td>
<td>使用<code>universal-cookies</code>获取CSRF令牌，并在请求中使用<code>credentials: "same-origin"</code>。</td>
<td>将<code>CSRF_COOKIE_SAMESITE</code>、<code>SESSION_COOKIE_SAMESITE</code>设置为<code>"Strict"</code>。启用<code>SESSION_COOKIE_HTTPONLY</code>，禁用<code>CSRF_COOKIE_HTTPONLY</code>。</td>
</tr>
<tr>
<td>单独提供前端服务(同一域)</td>
<td>获取CSRF令牌并在获取请求中使用<code>credentials: "same-origin"</code>。</td>
<td>添加一个路由处理程序，用于生成在响应头中设置的CSRF令牌。将<code>SESSION_COOKIE_HTTPONLY</code>、<code>CSRF_COOKIE_HTTPONLY</code>设置为<code>True</code>，将<code>SESSION_COOKIE_SAMESITE</code>、<code>CSRF_COOKIE_SAMESITE</code>设置为<code>"Strict"</code>。</td>
</tr>
<tr>
<td>前端与DRF分开服务(同一域)</td>
<td>获取CSRF令牌并在获取请求中使用<code>credentials: "same-origin"</code>。</td>
<td>添加一个路由处理程序，用于生成在响应头中设置的CSRF令牌。将<code>SESSION_COOKIE_HTTPONLY</code>、<code>CSRF_COOKIE_HTTPONLY</code>设置为<code>True</code>，将<code>SESSION_COOKIE_SAMESITE</code>、<code>CSRF_COOKIE_SAMESITE</code>设置为<code>"Strict"</code>。</td>
</tr>
<tr>
<td>单独提供前端服务(跨来源)</td>
<td>获取CSRF令牌并在获取请求中使用<code>credentials: "include"</code>。</td>
<td>启用CORS并添加路由处理程序，以生成在响应标头中设置的CSRF令牌。将<code>SESSION_COOKIE_HTTPONLY</code>、<code>CSRF_COOKIE_HTTPONLY</code>设置为<code>True</code>，将<code>SESSION_COOKIE_SAMESITE</code>、<code>CSRF_COOKIE_SAMESITE</code>设置为<code>"Lax"</code>。添加django-cors-headers包并配置<code>CORS_ALLOWED_ORIGINS</code>、<code>CORS_EXPOSE_HEADERS</code>和<code>CORS_ALLOW_CREDENTIALS</code>设置。</td>
</tr>
</tbody>
</table>
<p>从<a href="https://github.com/duplxey/django-spa-cookie-auth"> django-spa-cookie-auth </a>存储库中获取代码。</p>
  </div>

  </div>    
</body>
</html>