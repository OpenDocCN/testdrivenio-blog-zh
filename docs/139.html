<html>
<head>
<title>Running Vault and Consul on Kubernetes </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在库伯内特经营金库和领事</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/running-vault-and-consul-on-kubernetes/#0001-01-01">https://testdriven.io/blog/running-vault-and-consul-on-kubernetes/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在下面的教程中，我们将带您在Kubernetes上使用TLS配置一个高度可用的Hashicorp Vault和Consul集群。</p>
<p><em>主要依赖:</em></p>
<ul>
<li>保险库版本1.7.1</li>
<li>领事v1.9.5</li>
<li>kubernetes 1 . 21 . 0版</li>
</ul>
<blockquote>
<p>这是一个中级教程。它假设你有金库，领事，码头工人和Kubernetes的基本工作知识。</p>
</blockquote>



<h2 id="minikube">迷你库贝</h2>
<p>Minikube是一个用于在本地运行单节点Kubernetes集群的工具。它旨在快速启动并运行一个集群，这样您就可以开始在本地与Kubernetes API进行交互。</p>
<p>遵循官方的<a href="https://minikube.sigs.k8s.io/docs/start/">入门</a>指南，安装Minikube以及:</p>
<ol>
<li>一个<a href="https://en.wikipedia.org/wiki/Hypervisor">虚拟机管理程序</a>(像<a href="https://www.virtualbox.org/wiki/Downloads"> VirtualBox </a>或<a href="https://github.com/moby/hyperkit"> HyperKit </a>)来管理虚拟机</li>
<li>在Kubernetes上部署和管理应用程序</li>
</ol>
<blockquote>
<p>如果你用的是Mac，我们建议用<a href="https://brew.sh/"> Homebrew </a>安装Kubectl和Minikube:</p>
<div class="codehilite"><pre><span/><code>$ brew update
$ brew install kubectl
$ brew install minikube
</code></pre></div>

</blockquote>
<p>然后，启动组合仪表并拉起Minikube <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">仪表盘</a>:</p>
<div class="codehilite"><pre><span/><code>$ minikube config <span class="nb">set</span> vm-driver hyperkit
$ minikube start
$ minikube dashboard
</code></pre></div>

<p>至此，我们将把注意力转向配置TLS。</p>
<h2 id="tls-certificates">TLS证书</h2>
<p>TLS将用于保护每个Consul成员之间的RPC通信。为此，我们将通过CloudFlare的<a href="https://github.com/cloudflare/cfssl"> SSL工具包</a> ( <code>cfssl</code>和<code>cfssljson</code>)创建一个证书颁发机构(CA)来签署证书，并向节点分发密钥。</p>
<p>如果你还没有安装<a href="https://golang.org/doc/install"> Go </a>就开始安装吧。</p>
<blockquote>
<p>再说一遍，如果你用的是Mac，安装Go最快的方法就是用自制软件:</p>
<div class="codehilite"><pre><span/><code>$ brew update
$ brew install go
</code></pre></div>

</blockquote>
<p>安装后，创建一个工作区，配置<a href="https://github.com/golang/go/wiki/GOPATH"> GOPATH </a>并将工作区的bin文件夹添加到您的系统路径:</p>
<div class="codehilite"><pre><span/><code>$ mkdir <span class="nv">$HOME</span>/go
$ <span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOPATH</span>/bin
</code></pre></div>

<p>接下来，安装SSL工具包:</p>
<div class="codehilite"><pre><span/><code>$ go get -u github.com/cloudflare/cfssl/cmd/cfssl
$ go get -u github.com/cloudflare/cfssl/cmd/cfssljson
</code></pre></div>

<p>创建名为“vault-consul-kubernetes”的新项目目录，并添加以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>├── certs
│   ├── config
│   │   ├── ca-config.json
│   │   ├── ca-csr.json
│   │   ├── consul-csr.json
│   │   └── vault-csr.json
├── consul
└── vault
</code></pre></div>

<p><em> ca-config.json </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w"/>
<span class="w">    </span><span class="p">},</span><span class="w"/>
<span class="w">    </span><span class="nt">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">        </span><span class="nt">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">          </span><span class="s2">"signing"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w"/>
<span class="w">          </span><span class="s2">"client auth"</span><span class="w"/>
<span class="w">        </span><span class="p">],</span><span class="w"/>
<span class="w">        </span><span class="nt">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8760h"</span><span class="w"/>
<span class="w">      </span><span class="p">}</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p><em> ca-csr.json </em></p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="s2">"cluster.local"</span><span class="w"/>
<span class="w">  </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Colorado"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Denver"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p><em>领事-csr.json </em>:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server.dc1.cluster.local"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="s2">"server.dc1.cluster.local"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"127.0.0.1"</span><span class="w"/>
<span class="w">  </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Colorado"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Denver"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>【t0-CSR . JSON】：</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="s2">"vault"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="s2">"127.0.0.1"</span><span class="w"/>
<span class="w">  </span><span class="p">],</span><span class="w"/>
<span class="w">  </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w"/>
<span class="w">    </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"/>
<span class="w">    </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Colorado"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Denver"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">]</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>有关这些文件的信息，请查看《带TLS加密的安全咨询代理通信指南》。</p>
</blockquote>
<p>创建证书颁发机构:</p>
<div class="codehilite"><pre><span/><code>$ cfssl gencert -initca certs/config/ca-csr.json <span class="p">|</span> cfssljson -bare certs/ca
</code></pre></div>

<p>然后，为Consul创建一个私钥和一个TLS证书:</p>
<div class="codehilite"><pre><span/><code>$ cfssl gencert <span class="se">\</span>
    -ca<span class="o">=</span>certs/ca.pem <span class="se">\</span>
    -ca-key<span class="o">=</span>certs/ca-key.pem <span class="se">\</span>
    -config<span class="o">=</span>certs/config/ca-config.json <span class="se">\</span>
    -profile<span class="o">=</span>default <span class="se">\</span>
    certs/config/consul-csr.json <span class="p">|</span> cfssljson -bare certs/consul
</code></pre></div>

<p>对Vault执行相同的操作:</p>
<div class="codehilite"><pre><span/><code>$ cfssl gencert <span class="se">\</span>
    -ca<span class="o">=</span>certs/ca.pem <span class="se">\</span>
    -ca-key<span class="o">=</span>certs/ca-key.pem <span class="se">\</span>
    -config<span class="o">=</span>certs/config/ca-config.json <span class="se">\</span>
    -profile<span class="o">=</span>default <span class="se">\</span>
    certs/config/vault-csr.json <span class="p">|</span> cfssljson -bare certs/vault
</code></pre></div>

<p>现在，您应该会在“certs”目录中看到以下PEM文件:</p>
<ul>
<li>ca-key.pem</li>
<li>ca.csr</li>
<li>ca.pem</li>
<li>领事钥匙. pem</li>
<li>领事. csr</li>
<li>领事. pem</li>
<li>vault-key.pem</li>
<li>vault.csr</li>
<li>vault.pem</li>
</ul>
<h2 id="consul">领事</h2>
<h3 id="gossip-encryption-key">八卦加密密钥</h3>
<p>Consul使用<a href="https://www.consul.io/docs/architecture/gossip">八卦协议</a>来广播加密信息，并发现加入集群的新成员。这需要一个共享密钥。要生成，首先<a href="https://www.consul.io/docs/install/index.html">安装Consul客户端</a> (Mac用户要用Brew来做这个- <code>brew install consul</code>)，然后生成一个密钥并存储在一个环境变量中:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">GOSSIP_ENCRYPTION_KEY</span><span class="o">=</span><span class="k">$(</span>consul keygen<span class="k">)</span>
</code></pre></div>

<p>将密钥与TLS证书一起秘密存储:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create secret generic consul <span class="se">\</span>
  --from-literal<span class="o">=</span><span class="s2">"gossip-encryption-key=</span><span class="si">${</span><span class="nv">GOSSIP_ENCRYPTION_KEY</span><span class="si">}</span><span class="s2">"</span> <span class="se">\</span>
  --from-file<span class="o">=</span>certs/ca.pem <span class="se">\</span>
  --from-file<span class="o">=</span>certs/consul.pem <span class="se">\</span>
  --from-file<span class="o">=</span>certs/consul-key.pem
</code></pre></div>

<p>验证:</p>
<div class="codehilite"><pre><span/><code>$ kubectl describe secrets consul
</code></pre></div>

<p>您应该看到:</p>
<div class="codehilite"><pre><span/><code>Name:         consul
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

<span class="nv">Data</span>
<span class="o">====</span>
consul.pem:             <span class="m">1359</span> bytes
gossip-encryption-key:  <span class="m">44</span> bytes
ca.pem:                 <span class="m">1168</span> bytes
consul-key.pem:         <span class="m">1679</span> bytes
</code></pre></div>

<h3 id="config">配置</h3>
<p>向“consul”添加一个名为<em> config.json </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"ca_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/etc/tls/ca.pem"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"cert_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/etc/tls/consul.pem"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"key_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/etc/tls/consul-key.pem"</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"verify_incoming"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"verify_outgoing"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"verify_server_hostname"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"/>
<span class="w">  </span><span class="nt">"ports"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"https"</span><span class="p">:</span><span class="w"> </span><span class="mi">8443</span><span class="w"/>
<span class="w">  </span><span class="p">}</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>通过将<code>verify_incoming</code>、<code>verify_outgoing</code>和<code>verify_server_hostname</code>设置为<code>true</code>，所有的RPC调用都必须被加密。</p>
<blockquote>
<p>请务必查看咨询文档中的<a href="https://www.consul.io/docs/security/encryption#rpc-encryption-with-tls"> RPC加密与TLS </a>指南，以了解有关这些选项的更多信息。</p>
</blockquote>
<p>将此配置保存在配置映射中:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create configmap consul --from-file<span class="o">=</span>consul/config.json
$ kubectl describe configmap consul
</code></pre></div>

<h3 id="service">服务</h3>
<p>定义一个<a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">无头服务</a>——一个没有集群IP-in<em>consul/Service . YAML</em>的服务，在内部公开每个Consul成员:</p>
<div class="codehilite"><pre><span/><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"/>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"/>
<span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8500</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8500</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rpc</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8400</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8400</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serflan-tcp</span><span class="w"/>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="s">"TCP"</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8301</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8301</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serflan-udp</span><span class="w"/>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="s">"UDP"</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8301</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8301</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serfwan-tcp</span><span class="w"/>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="s">"TCP"</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8302</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8302</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serfwan-udp</span><span class="w"/>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="s">"UDP"</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8302</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8302</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8300</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8300</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consuldns</span><span class="w"/>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8600</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8600</span><span class="w"/>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
</code></pre></div>

<p>创建服务:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create -f consul/service.yaml
$ kubectl get service consul
</code></pre></div>

<blockquote>
<p>请确保在StatefulSet之前创建服务，因为由StatefulSet创建的pod将立即开始进行DNS查找以查找其他成员。</p>
</blockquote>
<h3 id="statefulset">状态集</h3>
<p>领事/statefulset.yaml :</p>
<div class="codehilite"><pre><span/><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"/>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span><span class="w"/>
<span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"/>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span><span class="w"/>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"consul:1.4.0"</span><span class="w"/>
<span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_IP</span><span class="w"/>
<span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w"/>
<span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">status.podIP</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GOSSIP_ENCRYPTION_KEY</span><span class="w"/>
<span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"/>
<span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gossip-encryption-key</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NAMESPACE</span><span class="w"/>
<span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w"/>
<span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span><span class="w"/>
<span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"agent"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-advertise=$(POD_IP)"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-bind=0.0.0.0"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-bootstrap-expect=3"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-client=0.0.0.0"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-config-file=/consul/myconfig/config.json"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-datacenter=dc1"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-data-dir=/consul/data"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-domain=cluster.local"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-encrypt=$(GOSSIP_ENCRYPTION_KEY)"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-server"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-ui"</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-disable-host-node-id"</span><span class="w"/>
<span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="w"/>
<span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/consul/myconfig</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span><span class="w"/>
<span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/tls</span><span class="w"/>
<span class="w">          </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">preStop</span><span class="p">:</span><span class="w"/>
<span class="w">              </span><span class="nt">exec</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">command</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span><span class="w"/>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"/>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul leave</span><span class="w"/>
<span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8500</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ui-port</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8400</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alt-port</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">udp-port</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https-port</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http-port</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8301</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serflan</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8302</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serfwan</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8600</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consuldns</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8300</span><span class="w"/>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span><span class="w"/>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="w"/>
<span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span><span class="w"/>
<span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
</code></pre></div>

<p>部署三节点咨询集群:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create -f consul/statefulset.yaml
</code></pre></div>

<p>验证pod已启动并正在运行:</p>
<div class="codehilite"><pre><span/><code>$ kubectl get pods

NAME       READY     STATUS    RESTARTS   AGE
consul-0   <span class="m">1</span>/1       Running   <span class="m">0</span>          17s
consul-1   <span class="m">1</span>/1       Running   <span class="m">0</span>          7s
consul-2   <span class="m">1</span>/1       Running   <span class="m">0</span>          6s
</code></pre></div>

<p>查看每个单元的日志，确保其中一个单元被选为领导者:</p>
<div class="codehilite"><pre><span/><code>$ kubectl logs consul-0
$ kubectl logs consul-1
$ kubectl logs consul-2
</code></pre></div>

<p>示例日志:</p>
<div class="codehilite"><pre><span/><code><span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: Election won. Tally: <span class="m">2</span>
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: Node at <span class="m">172</span>.17.0.7:8300 <span class="o">[</span>Leader<span class="o">]</span> entering Leader state
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: Added peer a3ee83a0-e39b-f58b-e2d4-35a3689ff3d9, starting replication
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> consul: cluster leadership acquired
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> consul: New leader elected: consul-2
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: Added peer f91746e3-881c-aebb-f8c5-b34bf37d3529, starting replication
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>WARN<span class="o">]</span> raft: AppendEntries to <span class="o">{</span>Voter a3ee83a0-e39b-f58b-e2d4-35a3689ff3d9 <span class="m">172</span>.17.0.6:8300<span class="o">}</span> rejected, sending older logs <span class="o">(</span>next: <span class="m">1</span><span class="o">)</span>
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: pipelining replication to peer <span class="o">{</span>Voter a3ee83a0-e39b-f58b-e2d4-35a3689ff3d9 <span class="m">172</span>.17.0.6:8300<span class="o">}</span>
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>WARN<span class="o">]</span> raft: AppendEntries to <span class="o">{</span>Voter f91746e3-881c-aebb-f8c5-b34bf37d3529 <span class="m">172</span>.17.0.5:8300<span class="o">}</span> rejected, sending older logs <span class="o">(</span>next: <span class="m">1</span><span class="o">)</span>
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> raft: pipelining replication to peer <span class="o">{</span>Voter f91746e3-881c-aebb-f8c5-b34bf37d3529 <span class="m">172</span>.17.0.5:8300<span class="o">}</span>
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> consul: member <span class="s1">'consul-2'</span> joined, marking health alive
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> consul: member <span class="s1">'consul-1'</span> joined, marking health alive
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> consul: member <span class="s1">'consul-0'</span> joined, marking health alive
<span class="m">2021</span>/04/27 <span class="m">21</span>:24:36 <span class="o">[</span>INFO<span class="o">]</span> agent: Synced node info
</code></pre></div>

<p>将端口转发到本地机器:</p>
<div class="codehilite"><pre><span/><code>$ kubectl port-forward consul-1 <span class="m">8500</span>:8500
</code></pre></div>

<p>然后，在新的终端窗口中，确保所有成员都处于活动状态:</p>
<div class="codehilite"><pre><span/><code>$ consul members

Node      Address          Status  Type    Build  Protocol  DC   Segment
consul-0  <span class="m">172</span>.17.0.6:8301  alive   server  <span class="m">1</span>.4.0  <span class="m">2</span>         dc1  &lt;all&gt;
consul-1  <span class="m">172</span>.17.0.7:8301  alive   server  <span class="m">1</span>.4.0  <span class="m">2</span>         dc1  &lt;all&gt;
consul-2  <span class="m">172</span>.17.0.8:8301  alive   server  <span class="m">1</span>.4.0  <span class="m">2</span>         dc1  &lt;all&gt;
</code></pre></div>

<p>最后，您应该能够访问位于<a href="http://localhost:8500"> http://localhost:8500 </a>的web界面。</p>
<p><img data-src="/static/images/blog/vault-consul-kubernetes/consul.png" loading="lazy" class="lazyload" alt="consul dashboard" src="../Images/8a7d53f8b95c5eef5f623461054386bf.png" data-original-src="https://testdriven.io/static/images/blog/vault-consul-kubernetes/consul.png"/></p>
<h2 id="vault">跳跃</h2>
<p>接下来，让我们将Vault配置为在Kubernetes上运行。</p>
<h3 id="secret">秘密</h3>
<p>将我们创建的保管库TLS证书存储在一个秘密位置:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create secret generic vault <span class="se">\</span>
    --from-file<span class="o">=</span>certs/ca.pem <span class="se">\</span>
    --from-file<span class="o">=</span>certs/vault.pem <span class="se">\</span>
    --from-file<span class="o">=</span>certs/vault-key.pem

$ kubectl describe secrets vault
</code></pre></div>

<h3 id="configmap">配置图</h3>
<p>为Vault配置添加一个名为<em> vault/config.json </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="p">{</span><span class="w"/>
<span class="w">  </span><span class="nt">"listener"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"tcp"</span><span class="p">:{</span><span class="w"/>
<span class="w">      </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1:8200"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"tls_disable"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"tls_cert_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/etc/tls/vault.pem"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"tls_key_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/etc/tls/vault-key.pem"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"storage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">    </span><span class="nt">"consul"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"/>
<span class="w">      </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"consul:8500"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vault/"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"disable_registration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w"/>
<span class="w">      </span><span class="nt">"ha_enabled"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w"/>
<span class="w">    </span><span class="p">}</span><span class="w"/>
<span class="w">  </span><span class="p">},</span><span class="w"/>
<span class="w">  </span><span class="nt">"ui"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"/>
<span class="p">}</span><span class="w"/>
</code></pre></div>

<p>在这里，我们将Vault配置为使用<a href="https://www.vaultproject.io/docs/configuration/storage/consul.html"> Consul后端</a>(支持高可用性)，为Vault定义了<a href="https://www.vaultproject.io/docs/configuration/listener/tcp.html"> TCP监听器</a>，<a href="https://www.vaultproject.io/docs/configuration/listener/tcp.html#tls_disable">启用了TLS </a>，添加了到<a href="https://www.vaultproject.io/docs/configuration/listener/tcp.html#tls_cert_file"> TLS证书</a>和<a href="https://www.vaultproject.io/docs/configuration/listener/tcp.html#tls_key_file">私钥</a>的路径，并启用了<a href="https://www.vaultproject.io/docs/configuration/ui/index.html"> Vault UI </a>。查看<a href="https://www.vaultproject.io/docs/configuration/index.html">文档</a>了解更多关于配置保险库的信息。</p>
<p>将此配置保存在配置映射中:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create configmap vault --from-file<span class="o">=</span>vault/config.json
$ kubectl describe configmap vault
</code></pre></div>

<h3 id="service_1">服务</h3>
<p><em> vault/service.yaml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"/>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"/>
<span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8200</span><span class="w"/>
<span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8200</span><span class="w"/>
<span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class="w"/>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
</code></pre></div>

<p>创建:</p>
<div class="codehilite"><pre><span/><code>$ kubectl create -f vault/service.yaml
$ kubectl get service vault
</code></pre></div>

<h3 id="deployment">部署</h3>
<p><em> vault/deployment.yaml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"/>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"/>
<span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"/>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">"vault"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"server"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"-config"</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">"/vault/config/config.json"</span><span class="p p-Indicator">]</span><span class="w"/>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"vault:0.11.5"</span><span class="w"/>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"/>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">add</span><span class="p">:</span><span class="w"/>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPC_LOCK</span><span class="w"/>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configurations</span><span class="w"/>
<span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/vault/config/config.json</span><span class="w"/>
<span class="w">            </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.json</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/tls</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul-vault-agent</span><span class="w"/>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"consul:1.4.0"</span><span class="w"/>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GOSSIP_ENCRYPTION_KEY</span><span class="w"/>
<span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"/>
<span class="w">              </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">                </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gossip-encryption-key</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NAMESPACE</span><span class="w"/>
<span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"/>
<span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w"/>
<span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span><span class="w"/>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"agent"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-encrypt=$(GOSSIP_ENCRYPTION_KEY)"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-config-file=/consul/myconfig/config.json"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-domain=cluster.local"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-datacenter=dc1"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-disable-host-node-id"</span><span class="w"/>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"-node=vault-1"</span><span class="w"/>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="w"/>
<span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/consul/myconfig</span><span class="w"/>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span><span class="w"/>
<span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/tls</span><span class="w"/>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configurations</span><span class="w"/>
<span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="w"/>
<span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls</span><span class="w"/>
<span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">consul</span><span class="w"/>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
<span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w"/>
<span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vault</span><span class="w"/>
</code></pre></div>

<p>部署保管库:</p>
<div class="codehilite"><pre><span/><code>$ kubectl apply -f vault/deployment.yaml
</code></pre></div>

<p>要进行测试，请获取Pod名称，然后转发端口:</p>
<div class="codehilite"><pre><span/><code>$ kubectl get pods

NAME                     READY     STATUS    RESTARTS   AGE
consul-0                 <span class="m">1</span>/1       Running   <span class="m">0</span>          35m
consul-1                 <span class="m">1</span>/1       Running   <span class="m">0</span>          35m
consul-2                 <span class="m">1</span>/1       Running   <span class="m">0</span>          35m
vault-64754b559d-dw459   <span class="m">2</span>/2       Running   <span class="m">0</span>          7m

$ kubectl port-forward vault-64754b559d-dw459 <span class="m">8200</span>:8200
</code></pre></div>

<p>确保可以在<a href="https://localhost:8200"> https://localhost:8200 </a>查看UI。</p>
<p><img data-src="/static/images/blog/vault-consul-kubernetes/vault.png" loading="lazy" class="lazyload" alt="vault dashboard" src="../Images/4446dec1147ed064f85ddaaa8a300b35.png" data-original-src="https://testdriven.io/static/images/blog/vault-consul-kubernetes/vault.png"/></p>
<h2 id="quick-test">快速试验</h2>
<p>在端口转发仍然打开的情况下，在新的终端窗口中，导航到项目目录并设置<code>VAULT_ADDR</code>和<code>VAULT_CACERT</code>环境变量:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span>https://127.0.0.1:8200
$ <span class="nb">export</span> <span class="nv">VAULT_CACERT</span><span class="o">=</span><span class="s2">"certs/ca.pem"</span>
</code></pre></div>

<p><a href="https://www.vaultproject.io/docs/install/">在本地安装保险库客户端</a>，如果您还没有的话，然后用一个密钥初始化保险库:</p>
<div class="codehilite"><pre><span/><code>$ vault operator init -key-shares<span class="o">=</span><span class="m">1</span> -key-threshold<span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p>记下解封密钥和初始根令牌。</p>
<div class="codehilite"><pre><span/><code>Unseal Key <span class="m">1</span>: iejZsVPrDFPbQL+JUW5HGMub9tlAwSSr7bR5NuAX9pg<span class="o">=</span>

Initial Root Token: 85kVUa6mxr2VFawubh1YFG6t

Vault initialized with <span class="m">1</span> key shares and a key threshold of <span class="m">1</span>. Please securely
distribute the key shares printed above. When the Vault is re-sealed,
restarted, or stopped, you must supply at least <span class="m">1</span> of these keys to unseal it
before it can start servicing requests.

Vault does not store the generated master key. Without at least <span class="m">1</span> key to
reconstruct the master key, Vault will remain permanently sealed!

It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. See <span class="s2">"vault operator rekey"</span> <span class="k">for</span> more information.
</code></pre></div>

<p>虚构的</p>
<div class="codehilite"><pre><span/><code>$ vault operator unseal

Unseal Key <span class="o">(</span>will be hidden<span class="o">)</span>:

Key                    Value
---                    -----
Seal Type              shamir
Initialized            <span class="nb">true</span>
Sealed                 <span class="nb">false</span>
Total Shares           <span class="m">1</span>
Threshold              <span class="m">1</span>
Version                <span class="m">0</span>.11.5
Cluster Name           vault-cluster-2c64d090
Cluster ID             42db2c78-938b-fe5c-aa15-f70be43a5cb4
HA Enabled             <span class="nb">true</span>
HA Cluster             n/a
HA Mode                standby
Active Node Address    &lt;none&gt;
</code></pre></div>

<p>使用根令牌进行身份验证:</p>
<div class="codehilite"><pre><span/><code>$ vault login

Token <span class="o">(</span>will be hidden<span class="o">)</span>:

Success! You are now authenticated. The token information displayed below
is already stored <span class="k">in</span> the token helper. You <span class="k">do</span> NOT need to run <span class="s2">"vault login"</span>
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                85kVUa6mxr2VFawubh1YFG6t
token_accessor       8hGliUJJeM8iijbiSzqiH49o
token_duration       ∞
token_renewable      <span class="nb">false</span>
token_policies       <span class="o">[</span><span class="s2">"root"</span><span class="o">]</span>
identity_policies    <span class="o">[]</span>
policies             <span class="o">[</span><span class="s2">"root"</span><span class="o">]</span>
</code></pre></div>

<p>创建新的秘密:</p>
<div class="codehilite"><pre><span/><code>$ vault kv put secret/precious <span class="nv">foo</span><span class="o">=</span>bar

Success! Data written to: secret/precious
</code></pre></div>

<p>阅读:</p>
<div class="codehilite"><pre><span/><code>$ vault kv get secret/precious

<span class="o">===</span> <span class="nv">Data</span> <span class="o">===</span>
Key    Value
---    -----
foo    bar
</code></pre></div>

<p>完成后关闭集群。</p>
<h2 id="automation-script">自动化脚本</h2>
<p>最后，让我们创建一个快速脚本来自动化资源调配过程:</p>
<ol>
<li>生成八卦加密密钥</li>
<li>创建一个秘密来存储Gossip密钥和TLS证书</li>
<li>将咨询配置存储在配置映射中</li>
<li>创建咨询服务和状态集</li>
<li>创建一个密码来存储保管库TLS证书</li>
<li>将存储库配置存储在配置映射中</li>
<li>创建Vault服务和部署</li>
<li>将端口转发添加到端口8200的存储区</li>
</ol>
<p>将名为<em> create.sh </em>的新文件添加到项目根目录:</p>
<div class="codehilite"><pre><span/><code><span class="ch">#!/bin/bash</span>


<span class="nb">echo</span> <span class="s2">"Generating the Gossip encryption key..."</span>

<span class="nb">export</span> <span class="nv">GOSSIP_ENCRYPTION_KEY</span><span class="o">=</span><span class="k">$(</span>consul keygen<span class="k">)</span>


<span class="nb">echo</span> <span class="s2">"Creating the Consul Secret to store the Gossip key and the TLS certificates..."</span>

kubectl create secret generic consul <span class="se">\</span>
  --from-literal<span class="o">=</span><span class="s2">"gossip-encryption-key=</span><span class="si">${</span><span class="nv">GOSSIP_ENCRYPTION_KEY</span><span class="si">}</span><span class="s2">"</span> <span class="se">\</span>
  --from-file<span class="o">=</span>certs/ca.pem <span class="se">\</span>
  --from-file<span class="o">=</span>certs/consul.pem <span class="se">\</span>
  --from-file<span class="o">=</span>certs/consul-key.pem


<span class="nb">echo</span> <span class="s2">"Storing the Consul config in a ConfigMap..."</span>

kubectl create configmap consul --from-file<span class="o">=</span>consul/config.json


<span class="nb">echo</span> <span class="s2">"Creating the Consul Service..."</span>

kubectl create -f consul/service.yaml


<span class="nb">echo</span> <span class="s2">"Creating the Consul StatefulSet..."</span>

kubectl create -f consul/statefulset.yaml


<span class="nb">echo</span> <span class="s2">"Creating a Secret to store the Vault TLS certificates..."</span>

kubectl create secret generic vault <span class="se">\</span>
    --from-file<span class="o">=</span>certs/ca.pem <span class="se">\</span>
    --from-file<span class="o">=</span>certs/vault.pem <span class="se">\</span>
    --from-file<span class="o">=</span>certs/vault-key.pem


<span class="nb">echo</span> <span class="s2">"Storing the Vault config in a ConfigMap..."</span>

kubectl create configmap vault --from-file<span class="o">=</span>vault/config.json


<span class="nb">echo</span> <span class="s2">"Creating the Vault Service..."</span>

kubectl create -f vault/service.yaml


<span class="nb">echo</span> <span class="s2">"Creating the Vault Deployment..."</span>

kubectl apply -f vault/deployment.yaml


<span class="nb">echo</span> <span class="s2">"All done! Forwarding port 8200..."</span>

<span class="nv">POD</span><span class="o">=</span><span class="k">$(</span>kubectl get pods -o<span class="o">=</span>name <span class="p">|</span> grep vault <span class="p">|</span> sed <span class="s2">"s/^.\{4\}//"</span><span class="k">)</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
  <span class="nv">STATUS</span><span class="o">=</span><span class="k">$(</span>kubectl get pods <span class="si">${</span><span class="nv">POD</span><span class="si">}</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.phase}"</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$STATUS</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"Running"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">break</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">"Pod status is: </span><span class="si">${</span><span class="nv">STATUS</span><span class="si">}</span><span class="s2">"</span>
    sleep <span class="m">5</span>
  <span class="k">fi</span>
<span class="k">done</span>

kubectl port-forward <span class="nv">$POD</span> <span class="m">8200</span>:8200
</code></pre></div>

<p>在测试之前，确保Minikube启动并创建TLS证书。</p>


<p>在新的终端窗口中，导航到项目目录并运行:</p>
<div class="codehilite"><pre><span/><code>$ <span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span>https://127.0.0.1:8200
$ <span class="nb">export</span> <span class="nv">VAULT_CACERT</span><span class="o">=</span><span class="s2">"certs/ca.pem"</span>
</code></pre></div>

<p>检查状态:</p>


<p><img data-src="/static/images/gifs/blog/vault-consul-kubernetes/video.gif" loading="lazy" class="lazyload" alt="video" src="../Images/754ea8233414bcee4891f71de60378d7.png" data-original-src="https://testdriven.io/static/images/gifs/blog/vault-consul-kubernetes/video.gif"/></p>
<hr/>

<p>你可以在<a href="https://github.com/testdrivenio/vault-consul-kubernetes">金库-领事-kubernetes </a>回购中找到最终代码。</p>
  </div>

  </div>    
</body>
</html>