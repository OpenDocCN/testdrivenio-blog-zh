<html>
<head>
<title>Class-based vs Function-based Views in Django </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Django中基于类和基于函数的视图</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-class-based-vs-function-based-views/#0001-01-01">https://testdriven.io/blog/django-class-based-vs-function-based-views/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在这篇文章中，我们将看看Django的基于类的观点(CBV)和基于函数的观点(FBV)之间的区别。我们将比较和对比每种方法的优缺点(以及Django内置的基于类的通用视图)。最后，你应该很好地理解什么时候使用一个而不是另一个。</p>



<h2 id="introduction">介绍</h2>
<p>Django(以及其他任何web框架)的主要用途之一是响应HTTP请求提供HTTP响应。Django允许我们使用所谓的视图来做到这一点。视图只是一个接受请求并返回响应的可调用对象。</p>
<p>Django最初只支持基于函数的视图(fbv)，但它们很难扩展，没有利用<a href="https://en.wikipedia.org/wiki/Object-oriented_programming">面向对象编程</a> (OOP)原则，也没有<a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">干</a>。这就是为什么Django开发人员决定增加对基于类的视图(cbv)的支持。cbv利用OOP原则，这允许我们使用继承，重用代码，并且通常编写更好更干净的代码。</p>
<blockquote>
<p>我们需要记住，cbv不是为了取代fbv而设计的。用fbv可以实现的任何事情，用cbv也可以实现。它们各有利弊。</p>
</blockquote>
<p>最后，Django提供预制或通用的cbv，为常见问题提供解决方案。它们具有程序员友好的名称，并为显示数据、编辑数据和处理基于日期的数据等问题提供解决方案。它们可以单独使用，也可以在自定义视图中继承。</p>
<p>让我们看看不同的视图类型，并了解什么时候适合使用哪种视图。</p>
<h2 id="function-based-views-fbvs">基于功能的视图(fbv)</h2>
<p>从本质上来说，<a href="https://docs.djangoproject.com/en/4.0/topics/http/views/">fbv</a>只是函数。它们易于阅读和操作，因为你可以清楚地看到发生了什么。由于其简单性，它们非常适合Django初学者。所以，如果你刚开始用Django，建议在潜入CBVs之前先对FBVs有一些工作知识。</p>
<h3 id="pros-and-cons">利弊</h3>
<p><strong>优点</strong></p>
<ul>
<li>显式代码流(您可以完全控制发生的事情)</li>
<li>易于实施</li>
<li>容易理解</li>
<li>非常适合独特的视图逻辑</li>
<li>易于与装饰者整合</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>大量重复的(样板)代码</li>
<li>通过条件分支处理HTTP方法</li>
<li>不要利用OOP</li>
<li>更难维护</li>
</ul>
<h3 id="quick-example">快速示例</h3>
<p>FBV的一个例子是这样的:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>


<span class="k">def</span> <span class="nf">task_create_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">'task-list'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_create.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(),</span>
    <span class="p">})</span>
</code></pre></div>

<p>这个视图接收一个<code>request</code>，执行一些逻辑，然后返回一个<code>HttpResponse</code>。只要看看代码，我们就可以看到第一个缺点:条件分支。对于每个HTTP方法，我们必须创建一个单独的分支。这会增加代码的复杂性，并导致<a href="https://en.wikipedia.org/wiki/Spaghetti_code">意大利面条代码</a>。</p>
<p>fbv的下一个缺点是它们的扩展性不好。随着您的代码库变得越来越大，您会注意到许多重复的(样板)代码用于处理模型(尤其是CRUD操作)。试着想象一下创建文章的视图与上面的例子有多大的不同...他们会非常相似。</p>
<p>为了使用fbv，我们必须将它们注册在<em> urls.py </em>中，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create/'</span><span class="p">,</span> <span class="n">task_create_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-create'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>当您处理高度定制的视图逻辑时，应该选择fbv。换句话说，对于不与其他视图共享很多代码的视图来说，fbv是一个很好的用例。使用FBVs的几个真实例子是:统计视图、图表视图和密码重置视图。</p>
<h3 id="todo-app-using-fbvs">待办事项应用程序(使用FBVs)</h3>
<p>让我们来看看如何只使用fbv编写一个允许CRUD操作的简单todo应用程序。</p>
<p>首先，我们将初始化我们的项目，定义我们的模型，创建HTML模板，然后开始处理<em> views.py </em>。我们可能会得到这样的结果:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># todo/views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">TaskForm</span><span class="p">,</span> <span class="n">ConfirmForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Task</span>


<span class="k">def</span> <span class="nf">task_list_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_list.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'tasks'</span><span class="p">:</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">task_create_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">'task-list'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_create.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">task_detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_detail.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">task_update_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">'task-detail'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="n">pk</span><span class="p">:</span> <span class="n">pk</span><span class="p">}))</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_update.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">task</span><span class="p">),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">task_delete_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ConfirmForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">'task-list'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_delete.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
        <span class="s1">'form'</span><span class="p">:</span> <span class="n">ConfirmForm</span><span class="p">(),</span>
    <span class="p">})</span>
</code></pre></div>

<blockquote>
<p>你可以在<a href="https://github.com/testdrivenio/django-cbv-fbv/tree/main/fbv"> GitHub </a>上获得完整的源代码。</p>
</blockquote>
<p>我们最终得到了简单明了的视图逻辑。你不能对这段代码做太多改进。</p>
<h2 id="class-based-views-cbvs">基于类的视图(cbv)</h2>
<p>在<a href="https://docs.djangoproject.com/en/4.0/releases/1.3/"> Django 1.3 </a>中引入的基于类的视图，提供了一种替代的方式来实现视图作为Python对象而不是函数。它们允许我们使用OOP原则(最重要的是继承)。我们可以使用cbv来概括部分代码，并将它们提取为超类视图。</p>
<blockquote>
<p>cbv还允许您使用Django内置的基于类的通用视图和<a href="https://docs.djangoproject.com/en/4.0/topics/class-based-views/mixins/">混合视图</a>，我们将在下一节中对此进行介绍。</p>
</blockquote>
<h3 id="pros-and-cons_1">利弊</h3>
<p><strong>优点</strong></p>
<ul>
<li>是可扩展的</li>
<li>他们利用了OOP概念(最重要的是继承)</li>
<li>非常适合编写CRUD视图</li>
<li>更干净和可重用的代码</li>
<li>Django内置的通用CBVs</li>
<li>它们类似于<a href="/blog/drf-views-part-1/"> Django REST框架视图</a></li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>隐式代码流(许多事情发生在后台)</li>
<li>使用许多混音，这可能会令人困惑</li>
<li>更复杂，更难掌握</li>
<li>装饰者需要额外的导入或代码覆盖</li>
</ul>
<blockquote>
<p>更多信息，请回顾一下在Django/Python中使用基于类的视图的利弊？</p>
</blockquote>
<h3 id="quick-example_1">快速示例</h3>
<p>让我们把之前的FBV例子改写成CBV:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>


<span class="k">class</span> <span class="nc">TaskCreateView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_create.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'task-detail'</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<p>我们可以看到，这个例子与FBV的方法没有太大的不同。逻辑大致相同。主要区别是代码组织。这里，每个HTTP方法都用一个单独的方法来处理，而不是条件分支。在CBVs中可以使用以下方法:<code>get</code>、<code>post</code>、<code>put</code>、<code>patch</code>、<code>delete</code>、<code>head</code>、<code>options</code>、<code>trace</code>。</p>
<p>这种方法的另一个好处是没有定义的HTTP方法会自动返回一个<code>405 Method Not Allowed</code>响应。</p>
<blockquote>
<p>当使用FBVs时，你可以使用<a href="https://docs.djangoproject.com/en/4.0/topics/http/decorators/#allowed-http-methods">允许的HTTP方法装饰器</a>，比如<code>@require_http_methods</code>，来实现同样的事情。</p>
</blockquote>
<p>因为Django的URL解析器需要一个可调用的函数，所以在<em> urls.py </em>中注册它们时，我们需要调用<a href="https://docs.djangoproject.com/en/4.0/ref/class-based-views/base/#django.views.generic.base.View.as_view"> as_view() </a>:</p>
<div class="codehilite"><pre><span/><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create/'</span><span class="p">,</span> <span class="n">TaskCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-create'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="code-flow">代码流</h3>
<p>CBVs的代码流稍微复杂一些，因为一些事情发生在后台。如果我们扩展基本<a href="https://docs.djangoproject.com/en/4.0/ref/class-based-views/base/#view">视图</a>类，将执行以下代码步骤:</p>
<ol>
<li>Django URL dispatcher将一个<code>HttpRequest</code>路由到<code>MyView</code>。</li>
<li>Django URL调度程序在<code>MyView</code>上调用<code>as_view()</code>。</li>
<li><code>as_view()</code>调用<code>setup()</code>和<code>dispatch()</code>。</li>
<li><code>dispatch()</code>触发特定HTTP方法的方法或<code>http_method_not_allowed()</code>。</li>
<li>返回一个<code>HttpResponse</code>。</li>
</ol>
<p><img data-src="/static/images/blog/django/django-cbv-fbv/cbv-code-flow.png" loading="lazy" class="lazyload" alt="Class based-views code flow" src="../Images/4fdf5c3571e9f13ec860abdf4826c737.png" data-original-src="https://testdriven.io/static/images/blog/django/django-cbv-fbv/cbv-code-flow.png"/></p>
<h3 id="todo-app-using-cbvs">待办事项应用程序(使用CBVs)</h3>
<p>现在，让我们重写todo应用程序，只使用CBVs:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># todo/views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">TaskForm</span><span class="p">,</span> <span class="n">ConfirmForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Task</span>


<span class="k">class</span> <span class="nc">TaskListView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_list.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'tasks'</span><span class="p">:</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="p">})</span>


<span class="k">class</span> <span class="nc">TaskCreateView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_create.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'task-detail'</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskDetailView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_detail.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
        <span class="p">})</span>


<span class="k">class</span> <span class="nc">TaskUpdateView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_update.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
            <span class="s1">'form'</span><span class="p">:</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">task</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'task-detail'</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskDeleteView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'todo/task_confirm_delete.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">'task'</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
            <span class="s1">'form'</span><span class="p">:</span> <span class="n">ConfirmForm</span><span class="p">(),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ConfirmForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'task-list'</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
</code></pre></div>

<p>另外，我们不要忘记让我们的<em> urls.py </em>调用<code>as_view()</code>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># todo/urls.py</span>

<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">TaskListView</span><span class="p">,</span> <span class="n">TaskDetailView</span><span class="p">,</span> <span class="n">TaskCreateView</span><span class="p">,</span> <span class="n">TaskUpdateView</span><span class="p">,</span> <span class="n">TaskDeleteView</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">TaskListView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-list'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'create/'</span><span class="p">,</span> <span class="n">TaskCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-create'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'&lt;int:pk&gt;/'</span><span class="p">,</span> <span class="n">TaskDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-detail'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'update/&lt;int:pk&gt;/'</span><span class="p">,</span> <span class="n">TaskUpdateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-update'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">'delete/&lt;int:pk&gt;/'</span><span class="p">,</span> <span class="n">TaskDeleteView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'task-delete'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<blockquote>
<p>你可以在<a href="https://github.com/testdrivenio/django-cbv-fbv/tree/main/cbv"> GitHub </a>上获得完整的源代码。</p>
</blockquote>
<p>为了更简洁的代码，我们牺牲了几行代码。我们不再使用条件分支。例如，如果我们看一下<code>TaskCreateView</code>和<code>TaskUpdateView</code>，我们可以看到它们几乎是一样的。我们可以通过将公共逻辑提取到父类中来进一步改进这段代码。此外，我们可以提取视图逻辑，并将其用于其他模型的视图。</p>
<h2 id="djangos-generic-class-based-views">Django的基于类的通用视图</h2>
<p>如果您遵循上一节提到的所有重构建议，您最终会得到一个模仿Django的一些通用的基于类的视图。Django的<a href="https://docs.djangoproject.com/en/4.0/topics/class-based-views/generic-display/">通用cbv</a>非常适合解决常见问题，如检索、创建、修改和删除对象，以及分页和归档视图。它们也加快了开发过程。</p>
<h3 id="quick-example_2">快速示例</h3>
<p>让我们看一个例子:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">CreateView</span>


<span class="k">class</span> <span class="nc">TaskCreateView</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'task'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'is_done'</span><span class="p">)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'todo/task_create.html'</span>
</code></pre></div>

<p>我们创建了一个名为<code>TaskCreateView</code>的类，并继承了<code>CreateView</code>。通过这样做，我们获得了很多功能，几乎没有代码。现在我们只需要设置以下属性:</p>
<ol>
<li>定义视图使用的Django模型。</li>
<li>Django使用<code>fields</code>来创建表单(或者，我们可以提供<code>form_class</code>)。</li>
<li><code>template_name</code>定义使用哪个模板(默认为<code>/&lt;app_name&gt;/&lt;model_name&gt;_form.html</code>)。</li>
<li><code>context_object_name</code>定义将模型实例传递给模板的上下文键(默认为<code>object</code>)。</li>
<li><code>success_url</code>定义用户成功时被重定向到哪里(或者，您可以在您的模型中设置<code>get_absolute_url</code>)。</li>
</ol>
<blockquote>
<p>有关通用cbv的更多信息，请参考<a href="https://docs.djangoproject.com/en/4.0/topics/class-based-views/generic-display/">官方文档</a>。</p>
</blockquote>
<p>正如您可能已经猜到的那样，通用cbv的幕后还会有更多的奇迹发生。即使对于有经验的Django开发人员来说，它们也会令人困惑。一旦你掌握了它们的窍门，你可能会觉得自己像个巫师。</p>
<p>对于执行常见任务(例如CRUD操作)的视图，应该使用通用cbv。如果你的视图需要做CBVs没有涵盖的事情，使用mixins或者基于函数的视图。</p>
<h3 id="djangos-built-in-cbv-types">姜戈内置的CBV类型</h3>
<p>在撰写本文时，Django提供了大量的通用cbv，我们可以将其分为三类:</p>


<blockquote>
<p>我们将在这里看看如何使用它们的实际例子。</p>
</blockquote>
<h3 id="view-mixins">查看混音</h3>
<p>每个通用视图用来解决一个问题(例如，显示信息，创建/更新某些东西)。如果您的视图需要做更多的事情，您可以使用mixins创建您的视图。Mixins是提供独立功能的类，它们可以组合起来解决几乎任何问题。</p>
<blockquote>
<p>你也可以选择一个通用的CBV作为基础，然后包括额外的混音。</p>
</blockquote>
<p>甚至Django的通用cbv也是由mixins组成的。让我们看一下<code>CreateView</code>图:</p>
<p><img data-src="/static/images/blog/django/django-cbv-fbv/create-view-diagram.png" loading="lazy" class="lazyload" alt="CreateView diagram" src="../Images/b2b2e142701ce7fd5008553ff7ad5ae1.png" data-original-src="https://testdriven.io/static/images/blog/django/django-cbv-fbv/create-view-diagram.png"/></p>
<p>我们可以看到它利用了许多混合，比如<code>ContextMixin</code>、<code>SingleObjectMixin</code>和<code>FormMixin</code>。它们有程序员友好的名字，所以根据它们的名字，你应该对它们的功能有一个大致的了解。</p>
<blockquote>
<p>Mixins需要花很多时间来掌握，而且经常会令人困惑。如果你刚刚开始使用mixin，我建议你从阅读<a href="https://docs.djangoproject.com/en/4.0/topics/class-based-views/mixins/">使用基于类视图的mixin</a>开始。</p>
</blockquote>
<h3 id="todo-app-using-djangos-generic-cbvs">Todo应用程序(使用Django的通用CBVs)</h3>
<p>现在，让我们使用Django的通用的基于类的视图最后一次重写todo应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># todo/views.py</span>

<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">DeleteView</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">,</span> <span class="n">CreateView</span>


<span class="k">class</span> <span class="nc">TaskListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'tasks'</span>


<span class="k">class</span> <span class="nc">TaskCreateView</span><span class="p">(</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'task'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'is_done'</span><span class="p">)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'todo/task_create.html'</span>


<span class="k">class</span> <span class="nc">TaskDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'task'</span>


<span class="k">class</span> <span class="nc">TaskUpdateView</span><span class="p">(</span><span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'task'</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'is_done'</span><span class="p">)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">'todo/task_update.html'</span>


<span class="k">class</span> <span class="nc">TaskDeleteView</span><span class="p">(</span><span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Task</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">'task'</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">'/'</span>
</code></pre></div>

<blockquote>
<p>你可以在<a href="https://github.com/testdrivenio/django-cbv-fbv/tree/main/dbv"> GitHub </a>上获得完整的源代码。</p>
</blockquote>
<p>通过使用Django通用cbv，我们将代码分成了两半。此外，代码更加清晰，更易于维护，但是如果您不熟悉一般的cbv，那么阅读和理解起来可能会困难得多。</p>
<h2 id="conclusion">结论</h2>
<p>一种视图类型并不比另一种更好。这完全取决于情况和个人喜好。有时fbv更好，有时cbv更好。当你写下一个具体的观点时，试着记住它们的优点和缺点，以便做出一个好的决定。如果你仍然不确定什么时候使用哪个，你可以通过把fbv转换成cbv或者相反来练习一下。此外，您可以使用此流程图:</p>
<p><img data-src="/static/images/blog/django/django-cbv-fbv/flowchart.png" loading="lazy" class="lazyload" alt="CBV vs FBV Flowchart" src="../Images/95463da347fa1b8736a8bd16f801ccb2.png" data-original-src="https://testdriven.io/static/images/blog/django/django-cbv-fbv/flowchart.png"/></p>
<p>我个人更喜欢在较小的项目中使用fbv(不能用通用的cbv解决),在处理较大的代码库时选择cbv。</p>
  </div>

  </div>    
</body>
</html>