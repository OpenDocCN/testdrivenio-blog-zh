<html>
<head>
<title>Dockerizing Flask with Postgres, Gunicorn, and Traefik </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>带有Postgres、Gunicorn和Traefik的多用途烧瓶</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/flask-docker-traefik/#0001-01-01">https://testdriven.io/blog/flask-docker-traefik/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何用Postgres和Docker设置Flask。对于生产环境，我们将添加Gunicorn、Traefik，并进行加密。</p>



<h2 id="project-setup">项目设置</h2>
<p>首先创建一个项目目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir flask-docker-traefik <span class="o">&amp;&amp;</span> <span class="nb">cd</span> flask-docker-traefik
$ python3.9 -m venv venv
$ <span class="nb">source</span> venv/bin/activate
<span class="o">(</span>venv<span class="o">)</span>$
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="https://testdriven.io/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>然后，创建以下文件和文件夹:</p>
<div class="codehilite"><pre><span/><code>└── services
    └── web
        ├── manage.py
        ├── project
        │   └── __init__.py
        └── requirements.txt
</code></pre></div>

<p>将<a href="https://flask.palletsprojects.com/en/2.0.x/">烧瓶</a>添加到<em>要求. txt </em>中:</p>


<p>从“服务/web”安装软件包:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install -r requirements.txt
</code></pre></div>

<p>接下来，让我们在<em> __init.py__ </em>中创建一个简单的Flask应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_root</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">hello</span><span class="o">=</span><span class="s2">"world"</span><span class="p">)</span>
</code></pre></div>

<p>然后，要配置Flask CLI工具从命令行运行和管理应用程序，请将以下内容添加到<em> services/web/manage.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>这里，我们创建了一个新的<code>FlaskGroup</code>实例，用与Flask应用程序相关的命令来扩展普通CLI。</p>
<p>从“web”目录运行服务器:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ <span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>project/__init__.py
<span class="o">(</span>venv<span class="o">)</span>$ python manage.py run
</code></pre></div>

<p>导航到<a href="http://127.0.0.1:5000/"> 127.0.0.1:5000 </a>，您应该看到:</p>


<p>一旦完成就杀死服务器。退出虚拟环境，并将其删除。</p>
<h2 id="docker">码头工人</h2>
<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有，那么在“web”目录下添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># pull the official docker image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.5-slim</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># set env variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>所以，我们从Python 3.9.5的基于<code>slim</code>的<a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及两个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
</ol>
<p>最后，我们复制了<em> requirements.txt </em>文件，安装了依赖项，并复制了Flask应用程序本身。</p>
<blockquote>
<p>查看<a href="https://mherman.org/presentations/dockercon-2018">Docker for Python Developers</a>了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将一个<em> docker-compose.yml </em>文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py run -h 0.0.0.0</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web/:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=development</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>，了解该文件如何工作的信息。</p>
</blockquote>
<p>建立形象:</p>


<p>构建映像后，运行容器:</p>


<p>导航到<a href="http://127.0.0.1:5000/"> http://127.0.0.1:5000/ </a>再次查看hello world健全性检查。</p>
<blockquote>
<p>如果这不起作用，通过<code>docker-compose logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="postgres">Postgres</h2>
<p>要配置Postgres，我们需要在<em> docker-compose.yml </em>文件中添加一个新服务，设置<a href="https://flask-sqlalchemy.palletsprojects.com/"> Flask-SQLAlchemy </a>，安装<a href="https://www.psycopg.org/"> Psycopg2 </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py run -h 0.0.0.0'</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web/:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=development</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_flask:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f59d9099999aaa939994869eb59197">[email protected]</a>:5432/hello_flask_dev</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_flask_dev</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>注意<code>web</code>服务中的新命令:</p>
<div class="codehilite"><pre><span/><code><span class="nv">bash</span><span class="w"> </span><span class="o">-</span><span class="nv">c</span><span class="w"> </span><span class="s1">'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py run -h 0.0.0.0'</span><span class="w"/>
</code></pre></div>

<p>将持续到Postgres完成。一旦启动，<code>python manage.py run -h 0.0.0.0</code>就会运行。</p>
<p>然后，将一个名为<em> config.py </em>的新文件添加到“项目”目录中，在这里我们将定义特定于环境的<a href="https://flask.palletsprojects.com/config/">配置</a>变量:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"DATABASE_URL"</span><span class="p">,</span> <span class="s2">"sqlite://"</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

<p>这里，数据库是基于我们刚刚定义的<code>DATABASE_URL</code>环境变量配置的。记下默认值。</p>
<p>更新<em> __init__。py </em>在init上拉入配置:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s2">"project.config.Config"</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_root</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">hello</span><span class="o">=</span><span class="s2">"world"</span><span class="p">)</span>
</code></pre></div>

<p>将<a href="https://flask-sqlalchemy.palletsprojects.com/"> Flask-SQLAlchemy </a>和<a href="https://www.psycopg.org/"> Psycopg2 </a>添加到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>Flask==2.0.1
Flask-SQLAlchemy==2.5.1
psycopg2-binary==2.8.6
</code></pre></div>

<p>更新<em> __init__。py </em>再次创建一个新的<code>SQLAlchemy</code>实例并定义一个数据库模型:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s2">"project.config.Config"</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_root</span><span class="p">():</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
</code></pre></div>

<p>在数据库模型上使用<a href="https://docs.python.org/3/library/dataclasses.html"> dataclass </a> decorator有助于我们序列化数据库对象。</p>
<p>最后，更新<em> manage.py </em>:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>

<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"create_db"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>这向CLI注册了一个新命令<code>create_db</code>，以便我们可以从命令行运行它，稍后我们将使用它将模型应用到数据库。</p>
<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>创建表格:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py create_db
</code></pre></div>

<blockquote>
<p>得到以下错误？</p>
<div class="codehilite"><pre><span/>sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)
FATAL:  database "hello_flask_dev" does not exist
</pre></div>
<p>运行<code>docker-compose down -v</code>移除卷和容器。然后，重新构建映像，运行容器，并应用迁移。</p>
</blockquote>
<p>确保<code>users</code>表已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_flask --dbname<span class="o">=</span>hello_flask_dev

psql <span class="o">(</span><span class="m">13</span>.3<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                        List of databases
      Name       <span class="p">|</span>    Owner    <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>      Access privileges
-----------------+-------------+----------+------------+------------+-----------------------------
 hello_flask_dev <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres        <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0       <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_flask             +
                 <span class="p">|</span>             <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_flask</span><span class="o">=</span>CTc/hello_flask
 template1       <span class="p">|</span> hello_flask <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_flask             +
                 <span class="p">|</span>             <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_flask</span><span class="o">=</span>CTc/hello_flask
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \c hello_flask_dev</span>
You are now connected to database <span class="s2">"hello_flask_dev"</span> as user <span class="s2">"hello_flask"</span>.

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \dt</span>
          List of relations
 Schema <span class="p">|</span> Name <span class="p">|</span> Type  <span class="p">|</span>    Owner
--------+------+-------+-------------
 public <span class="p">|</span> user <span class="p">|</span> table <span class="p">|</span> hello_flask
<span class="o">(</span><span class="m">1</span> row<span class="o">)</span>

<span class="nv">hello_flask_dev</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>您也可以通过运行以下命令来检查该卷是否已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker volume inspect flask-docker-traefik_postgres_data
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2021-06-05T14:12:52Z"</span>,
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{</span>
            <span class="s2">"com.docker.compose.project"</span>: <span class="s2">"flask-docker-traefik"</span>,
            <span class="s2">"com.docker.compose.version"</span>: <span class="s2">"1.29.1"</span>,
            <span class="s2">"com.docker.compose.volume"</span>: <span class="s2">"postgres_data"</span>
        <span class="o">}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/flask-docker-traefik_postgres_data/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"flask-docker-traefik_postgres_data"</span>,
        <span class="s2">"Options"</span>: null,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>

<p>导航到<a href="http://127.0.0.1:5000"> http://127.0.0.1:5000 </a>。健全性检查显示一个空列表。这是因为我们还没有填充<code>users</code>表。让我们添加一个CLI种子命令，用于将样本<code>users</code>添加到<em> manage.py </em>中的用户表:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">flask.cli</span> <span class="kn">import</span> <span class="n">FlaskGroup</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>

<span class="n">cli</span> <span class="o">=</span> <span class="n">FlaskGroup</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"create_db"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">"seed_db"</span><span class="p">)</span> <span class="c1"># new</span>
<span class="k">def</span> <span class="nf">seed_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d4b9bdb7bcb5b1b894b9bcb1a6b9b5bafabba6b3">[email protected]</a>"</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="eb9f8e989fab8e938a869b878ec5888486">[email protected]</a>"</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py seed_db
</code></pre></div>

<p>再次导航到<a href="http://127.0.0.1:5000"> http://127.0.0.1:5000 </a>。您现在应该看到:</p>


<h2 id="gunicorn">格尼科恩</h2>
<p>接下来，对于生产环境，让我们将<a href="https://gunicorn.org/"> Gunicorn </a>，一个生产级的WSGI服务器，添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>Flask==2.0.1
Flask-SQLAlchemy==2.5.1
gunicorn==20.1.0
psycopg2-binary==2.8.6
</code></pre></div>

<p>因为我们仍然希望在开发中使用Flask的内置服务器，所以在项目根目录中创建一个名为<em> docker-compose.prod.yml </em>的新合成文件用于生产:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:5000 manage:app'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=production</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_flask:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5b333e373734043d373a28301b3f39">[email protected]</a>:5432/hello_flask_prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_flask_prod</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果您有多个环境，您可能希望使用一个<a href="https://docs.docker.com/compose/extends/">docker-compose . override . yml</a>配置文件。使用这种方法，您可以将您的基本配置添加到一个<em> docker-compose.yml </em>文件中，然后使用一个<em>docker-compose . override . yml</em>文件根据环境覆盖那些配置设置。</p>
</blockquote>
<p>记下默认值<code>command</code>。我们运行的是Gunicorn，而不是Flask开发服务器。我们还从<code>web</code>服务中删除了这个卷，因为我们在生产中不需要它。</p>
<p>关闭开发容器(以及带有-v标志的相关卷):</p>


<p>然后，构建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>创建表格并应用种子:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py seed_db
</code></pre></div>

<p>验证<code>hello_flask_prod</code>数据库是与<code>users</code>表一起创建的。测试出<a href="http://127.0.0.1:5000/"> http://127.0.0.1:5000/ </a>。</p>
<blockquote>
<p>同样，如果容器启动失败，通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="production-dockerfile">生产文档</h2>
<p>在“web”目录中创建一个名为<em> Dockerfile.prod </em>的新Dockerfile，用于生产构建:</p>
<div class="codehilite"><pre><span/><code><span class="c">###########</span>
<span class="c"># BUILDER #</span>
<span class="c">###########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.5-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends gcc

<span class="c"># lint</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install <span class="nv">flake8</span><span class="o">==</span><span class="m">3</span>.9.1
<span class="k">COPY</span><span class="w"> </span>. .
<span class="k">RUN</span><span class="w"> </span>flake8 --ignore<span class="o">=</span>E501,F401 .

<span class="c"># install python dependencies</span>
<span class="k">COPY</span><span class="w"> </span>./requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt


<span class="c">#########</span>
<span class="c"># FINAL #</span>
<span class="c">#########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.5-slim</span>

<span class="c"># create directory for the app user</span>
<span class="k">RUN</span><span class="w"> </span>mkdir -p /home/app

<span class="c"># create the app user</span>
<span class="k">RUN</span><span class="w"> </span>addgroup --system app <span class="o">&amp;&amp;</span> adduser --system --group app

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y --no-install-recommends netcat
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/wheels /wheels
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install --no-cache /wheels/*

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. <span class="nv">$APP_HOME</span>

<span class="c"># chown all the files to the app user</span>
<span class="k">RUN</span><span class="w"> </span>chown -R app:app <span class="nv">$APP_HOME</span>

<span class="c"># change to the app user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">app</span>
</code></pre></div>

<p>在这里，我们使用了一个Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>来缩小最终的图像尺寸。本质上，<code>builder</code>是一个用于构建Python轮子的临时图像。然后车轮被复制到最终产品图像中，而<code>builder</code>图像被丢弃。</p>
<blockquote>
<p>您可以将<a href="https://stackoverflow.com/a/53101932/1799408">多阶段构建方法</a>更进一步，使用单个docker文件，而不是创建两个docker文件。思考在两个不同的文件上使用这种方法的利弊。</p>
</blockquote>
<p>您是否注意到我们创建了一个非root用户？默认情况下，Docker在容器内部以root用户身份运行容器进程。这是一种不好的做法，因为如果攻击者设法突破容器，他们可以获得Docker主机的根用户访问权限。如果您是容器中的root用户，那么您将是主机上的root用户。</p>
<p>用<em> Dockerfile.prod </em>更新docker-compose.prod.yml文件中的<code>web</code>服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:5000 manage:app'</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000:5000</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=production</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_flask:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aec6cbc2c2c1f1c8c2cfddc5eecacc">[email protected]</a>:5432/hello_flask_prod</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>尝试一下:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py seed_db
</code></pre></div>

<h2 id="traefik">Traefik</h2>
<p>接下来，让我们添加<a href="https://traefik.io/traefik/"> Traefik </a>，一个<a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/">反向代理</a>。</p>
<blockquote>
<p>刚接触Traefik？查看官方<a href="https://doc.traefik.io/traefik/getting-started/concepts/">入门</a>指南。</p>
<p><strong> Traefik vs Nginx </strong> : Traefik是一个现代的、HTTP反向代理和负载平衡器。它经常被比作<a href="https://www.nginx.com"> Nginx </a>，一个网络服务器和反向代理。由于Nginx主要是一个网络服务器，它可以用来提供网页，也可以作为一个反向代理和负载平衡器。总的来说，Traefik的启动和运行更简单，而Nginx的功能更丰富。</p>
<p><strong> Traefik </strong> :</p>
<ol>
<li>反向代理和负载平衡器</li>
<li>通过开箱即用的<a href="https://letsencrypt.org/">让我们加密</a>，自动发布和更新SSL证书</li>
<li>将Traefik用于简单的、基于Docker的微服务</li>
</ol>
<p><strong> Nginx </strong>:</p>
<ol>
<li>Web服务器、反向代理和负载平衡器</li>
<li>比Traefik稍快</li>
<li>对复杂的服务使用Nginx</li>
</ol>
</blockquote>
<p>将名为“traefik”的新文件夹与以下文件一起添加到“services”目录中:</p>
<div class="codehilite"><pre><span/><code>traefik
├── Dockerfile.traefik
├── traefik.dev.toml
└── traefik.prod.toml
</code></pre></div>

<p>您的项目结构现在应该如下所示:</p>
<div class="codehilite"><pre><span/><code>├── docker-compose.prod.yml
├── docker-compose.yml
└── services
    ├── traefik
    │   ├── Dockerfile.traefik
    │   ├── traefik.dev.toml
    │   └── traefik.prod.toml
    └── web
        ├── Dockerfile
        ├── Dockerfile.prod
        ├── manage.py
        ├── project
        │   ├── __init__.py
        │   └── config.py
        └── requirements.txt
</code></pre></div>

<p>将以下内容添加到<em> traefik.dev.toml </em>中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># listen on port 80</span><span class="w"/>
<span class="k">[entryPoints]</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":80"</span><span class="w"/>

<span class="c1"># Traefik dashboard over http</span><span class="w"/>
<span class="k">[api]</span><span class="w"/>
<span class="n">insecure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"/>

<span class="k">[log]</span><span class="w"/>
<span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"DEBUG"</span><span class="w"/>

<span class="k">[accessLog]</span><span class="w"/>

<span class="c1"># containers are not discovered automatically</span><span class="w"/>
<span class="k">[providers]</span><span class="w"/>
<span class="w">  </span><span class="k">[providers.docker]</span><span class="w"/>
<span class="w">    </span><span class="n">exposedByDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"/>
</code></pre></div>

<p>在这里，由于我们不想公开<code>db</code>服务，我们将<a href="https://doc.traefik.io/traefik/providers/docker/#exposedbydefault"> exposedByDefault </a>设置为<code>false</code>。要手动公开服务，我们可以将<code>"traefik.enable=true"</code>标签添加到Docker组合文件中。</p>
<p>接下来，更新<em> docker-compose.yml </em>文件，以便Traefik发现我们的<code>web</code>服务并添加一个新的<code>traefik</code>服务:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py run -h 0.0.0.0'</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web/:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=development</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_flask:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="375f525b5b5868515b56445c775355">[email protected]</a>:5432/hello_flask_dev</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.flask.rule=Host(`flask.localhost`)"</span><span class="w"/>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_flask_dev</span><span class="w"/>

<span class="w">  </span><span class="nt">traefik</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik:v2.2</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8081:8080</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"./services/traefik/traefik.dev.toml:/etc/traefik/traefik.toml"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>首先，<code>web</code>服务只对端口<code>5000</code>上的其他容器公开。我们还为<code>web</code>服务添加了以下标签:</p>
<ol>
<li><code>traefik.enable=true</code>使Traefik能够发现服务</li>
<li><code>traefik.http.routers.flask.rule=Host(`flask.localhost`)</code>当请求有<code>Host=flask.localhost</code>时，请求被重定向到该服务</li>
</ol>
<p>记下<code>traefik</code>服务中的卷:</p>
<ol>
<li>将本地配置文件映射到容器中的配置文件，以便保持设置同步</li>
<li><code>/var/run/docker.sock:/var/run/docker.sock:ro</code>使Traefik能够发现其他容器</li>
</ol>
<p>要进行测试，首先取下任何现有的容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v
$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>

<p>构建新的开发映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>创建表格并应用种子:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py create_db
$ docker-compose <span class="nb">exec</span> web python manage.py seed_db
</code></pre></div>

<p>导航到<a href="http://flask.localhost"> http://flask.localhost </a>。您应该看到:</p>


<p>您也可以通过cURL进行测试:</p>
<div class="codehilite"><pre><span/><code>$ curl -H Host:flask.localhost http://0.0.0.0
</code></pre></div>

<p>接下来，在<a href="http://flask.localhost:8081">查看<a href="https://doc.traefik.io/traefik/operations/dashboard/">仪表盘</a>http://flask . localhost:8081</a>:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-docker-traefik/traefik_dashboard.png" loading="lazy" class="lazyload" alt="traefik dashboard" src="../Images/c388e49cdf834296ca304b677e08a153.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-docker-traefik/traefik_dashboard.png"/></p>
<p>完成后，将容器和体积拿下来:</p>


<h2 id="lets-encrypt">让我们加密</h2>
<p>我们已经在开发模式下成功地创建了Flask、Docker和Traefik的工作示例。对于生产，您需要配置Traefik来通过Let's Encrypt 管理TLS证书。简而言之，Traefik将自动联系证书颁发机构来颁发和续订证书。</p>
<p>因为Let's Encrypt不会为<code>localhost</code>颁发证书，所以你需要在云计算实例(比如<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean </a> droplet或AWS EC2实例)上运行你的生产容器。您还需要一个有效的域名。如果你没有，你可以在<a href="https://www.freenom.com/"> Freenom </a>创建一个免费域名。</p>
<blockquote>
<p>我们使用了一个<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean </a> droplet和Docker machine来快速配置Docker的计算实例，并部署了生产容器来测试Traefik配置。查看Docker文档中的<a href="https://docs.docker.com/machine/examples/ocean/"> DigitalOcean示例</a>，了解更多关于使用Docker机器供应droplet的信息。</p>
</blockquote>
<p>假设您配置了一个计算实例并设置了一个自由域，那么现在就可以在生产模式下设置Traefik了。</p>
<p>首先将Traefik配置的生产版本添加到<em> traefik.prod.toml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="k">[entryPoints]</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":80"</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web.http]</span><span class="w"/>
<span class="w">    </span><span class="k">[entryPoints.web.http.redirections]</span><span class="w"/>
<span class="w">      </span><span class="k">[entryPoints.web.http.redirections.entryPoint]</span><span class="w"/>
<span class="w">        </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"websecure"</span><span class="w"/>
<span class="w">        </span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https"</span><span class="w"/>

<span class="w">  </span><span class="k">[entryPoints.websecure]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":443"</span><span class="w"/>

<span class="k">[accessLog]</span><span class="w"/>

<span class="k">[api]</span><span class="w"/>
<span class="n">dashboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"/>

<span class="k">[providers]</span><span class="w"/>
<span class="w">  </span><span class="k">[providers.docker]</span><span class="w"/>
<span class="w">    </span><span class="n">exposedByDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"/>

<span class="k">[certificatesResolvers.letsencrypt.acme]</span><span class="w"/>
<span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7d0412080f3d18101c1411531e1210">[email protected]</a>"</span><span class="w"/>
<span class="w">  </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/certificates/acme.json"</span><span class="w"/>
<span class="w">  </span><span class="k">[certificatesResolvers.letsencrypt.acme.httpChallenge]</span><span class="w"/>
<span class="w">    </span><span class="n">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"web"</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>确保用您的实际电子邮件地址替换<code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e29b8d9790a2878f838b8ecc818d8f">[email protected]</a></code>。</p>
</blockquote>
<p>这里发生了什么:</p>
<ol>
<li>将我们不安全的HTTP应用程序的入口点设置为端口80</li>
<li>将我们的安全HTTPS应用程序的入口点设置为端口443</li>
<li>将所有不安全的请求重定向到安全端口</li>
<li><code>exposedByDefault = false</code>取消所有服务</li>
<li><code>dashboard = true</code>启用监控仪表板</li>
</ol>
<p>最后，请注意:</p>
<div class="codehilite"><pre><span/><code><span class="k">[certificatesResolvers.letsencrypt.acme]</span><span class="w"/>
<span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5e27312b2c1e3b333f3732703d3133">[email protected]</a>"</span><span class="w"/>
<span class="w">  </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/certificates/acme.json"</span><span class="w"/>
<span class="w">  </span><span class="k">[certificatesResolvers.letsencrypt.acme.httpChallenge]</span><span class="w"/>
<span class="w">    </span><span class="n">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"web"</span><span class="w"/>
</code></pre></div>

<p>这是让我们加密配置的地方。我们定义了证书的存储位置(T1)和验证类型(T3)，这是一个HTTP挑战(T5)。</p>
<p>接下来，假设您更新了域名的DNS记录，创建两个新的A记录，它们都指向您的计算实例的公共IP:</p>
<ol>
<li><code>flask-traefik.your-domain.com</code> -用于网络服务</li>
<li><code>dashboard-flask-traefik.your-domain.com</code> -用于Traefik仪表板</li>
</ol>
<blockquote>
<p>确保用您的实际域名替换<code>your-domain.com</code>。</p>
</blockquote>
<p>接下来，像这样更新<em> docker-compose.prod.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/web</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:5000 manage:app'</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_APP=project/__init__.py</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=production</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://hello_flask:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6f070a0303003009030e1c042f0b0d">[email protected]</a>:5432/hello_flask_prod</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.flask.rule=Host(`flask-traefik.your-domain.com`)"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.flask.tls=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.flask.tls.certresolver=letsencrypt"</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_flask</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_flask_prod</span><span class="w"/>
<span class="w">  </span><span class="nt">traefik</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./services/traefik</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.traefik</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443:443</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"./traefik-public-certificates:/certificates"</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.rule=Host(`dashboard-flask-traefik.your-domain.com`)"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.tls=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.tls.certresolver=letsencrypt"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5c282e3d393a3537723428282c722e332928392e2f72383d2f343e333d2e38722f392e2a353f39613d2c351c353228392e323d30">[email protected]</a>"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.middlewares=auth"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.middlewares.auth.basicauth.users=testuser:$$apr1$$jIKW.bdS$$eKXe4Lxjgy/rH65wP1iQe1"</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">traefik-public-certificates</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>同样，确保用您的实际域名替换<code>your-domain.com</code>。</p>
</blockquote>
<p>这里有什么新鲜事？</p>
<p>在<code>web</code>服务中，我们添加了以下标签:</p>
<ol>
<li><code>traefik.http.routers.flask.rule=Host(`flask-traefik.your-domain.com`)</code>将主机更改为实际的域</li>
<li><code>traefik.http.routers.flask.tls=true</code>启用HTTPS</li>
<li><code>traefik.http.routers.flask.tls.certresolver=letsencrypt</code>将证书颁发者设置为让我们加密</li>
</ol>
<p>接下来，对于<code>traefik</code>服务，我们为证书目录添加了适当的端口和一个卷。该卷确保即使容器关闭，证书仍然有效。</p>
<p>至于标签:</p>
<ol>
<li><code>traefik.http.routers.dashboard.rule=Host(`dashboard-flask-traefik.your-domain.com`)</code>定义仪表板主机，因此可以在<code>$Host/dashboard/</code>访问</li>
<li><code>traefik.http.routers.dashboard.tls=true</code>启用HTTPS</li>
<li><code>traefik.http.routers.dashboard.tls.certresolver=letsencrypt</code>将证书解析器设置为“让我们加密”</li>
<li><code>traefik.http.routers.dashboard.middlewares=auth</code>启用<code>HTTP BasicAuth</code>中间件</li>
<li><code>traefik.http.middlewares.auth.basicauth.users</code>定义用于登录的用户名和散列密码</li>
</ol>
<p>您可以使用htpasswd实用程序创建新的密码哈希:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># username: testuser</span>
<span class="c1"># password: password</span>

$ <span class="nb">echo</span> <span class="k">$(</span>htpasswd -nb testuser password<span class="k">)</span> <span class="p">|</span> sed -e s/<span class="se">\\</span>$/<span class="se">\\</span>$<span class="se">\\</span>$/g
testuser:<span class="nv">$$</span>apr1<span class="nv">$$</span>jIKW.bdS<span class="nv">$$</span>eKXe4Lxjgy/rH65wP1iQe1
</code></pre></div>

<p>随意使用一个<code>env_file</code>来存储用户名和密码作为环境变量</p>
<div class="codehilite"><pre><span/><code>USERNAME=testuser
HASHED_PASSWORD=$$apr1$$jIKW.bdS$$eKXe4Lxjgy/rH65wP1iQe1
</code></pre></div>

<p>Update <em> Dockerfile.traefik </em> :</p>
<div class="codehilite"><pre><span/><code><span class="k">FROM</span><span class="w"> </span><span class="s">traefik:v2.2</span>

<span class="k">COPY</span><span class="w"> </span>./traefik.prod.toml ./etc/traefik/traefik.toml
</code></pre></div>

<p>接下来，旋转新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>创建表格并应用种子:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py create_db
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py seed_db
</code></pre></div>

<p>确保这两个URL有效:</p>
<ol>
<li><a href="https://flask-traefik.your-domain.com">https://flask-traefik.your-domain.com</a></li>
<li><a href="https://dashboard-flask-traefik.your-domain.com/dashboard/">https://dashboard-flask-traefik.your-domain.com/dashboard/</a></li>
</ol>
<p>此外，请确保当您访问上述网址的HTTP版本时，您会被重定向到HTTPS版本。</p>
<p>最后，让我们加密有效期为<a href="https://letsencrypt.org/2015/11/09/why-90-days.html"> 90天</a>的证书。Treafik将在后台自动为您处理证书更新，这样您就少了一件担心的事情！</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何用Postgres封装Flask应用程序以进行开发。我们还创建了一个生产就绪的Docker组合文件，设置了Traefik和Let's Encrypt来通过HTTPS为应用程序提供服务，并启用了一个安全的仪表板来监控我们的服务。</p>
<p>就生产环境的实际部署而言，您可能希望使用:</p>
<ol>
<li>完全托管的数据库服务——像<a href="https://aws.amazon.com/rds/"> RDS </a>或<a href="https://cloud.google.com/sql/">云SQL</a>——而不是在一个容器中管理你自己的Postgres实例。</li>
<li>服务的非根用户</li>
</ol>
<p>你可以在<a href="https://github.com/testdrivenio/flask-docker-traefik">flask-docker-traefik</a>repo中找到代码。</p>
  </div>

  </div>    
</body>
</html>