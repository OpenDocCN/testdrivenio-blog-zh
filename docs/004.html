<html>
<head>
<title>Dockerizing Django with Postgres, Gunicorn, and Traefik </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将Django与Postgres、Gunicorn和Traefik一起归档</h1>
<blockquote>原文：<a href="https://testdriven.io/blog/django-docker-traefik/#0001-01-01">https://testdriven.io/blog/django-docker-traefik/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>在本教程中，我们将看看如何用Postgres和Docker设置Django。对于生产环境，我们将添加Gunicorn、Traefik，并进行加密。</p>



<h2 id="project-setup">项目设置</h2>
<p>首先创建一个项目目录:</p>
<div class="codehilite"><pre><span/><code>$ mkdir django-docker-traefik <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-docker-traefik
$ mkdir app <span class="o">&amp;&amp;</span> <span class="nb">cd</span> app
$ python3.11 -m venv venv
$ <span class="nb">source</span> venv/bin/activate
</code></pre></div>

<blockquote>
<p>你可以随意把virtualenv和Pip换成诗歌<a href="https://python-poetry.org">或</a><a href="https://github.com/pypa/pipenv"> Pipenv </a>。更多信息，请查看<a href="/blog/python-environments/">现代Python环境</a>。</p>
</blockquote>
<p>接下来，让我们安装Django并创建一个简单的Django应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ pip install <span class="nv">django</span><span class="o">==</span><span class="m">4</span>.1.6
<span class="o">(</span>venv<span class="o">)</span>$ django-admin startproject config .
<span class="o">(</span>venv<span class="o">)</span>$ python manage.py migrate
</code></pre></div>

<p>运行应用程序:</p>
<div class="codehilite"><pre><span/><code><span class="o">(</span>venv<span class="o">)</span>$ python manage.py runserver
</code></pre></div>

<p>导航到<a href="http://localhost:8000/"> http://localhost:8000/ </a>查看Django欢迎屏幕。完成后，关闭服务器并退出虚拟环境。也删除虚拟环境。我们现在有了一个简单的Django项目。</p>
<p>在“app”目录下创建一个<em> requirements.txt </em>文件，并添加Django作为依赖项:</p>


<p>因为我们将转移到Postgres，所以继续从“app”目录中删除<em> db.sqlite3 </em>文件。</p>
<p>您的项目目录应该如下所示:</p>
<div class="codehilite"><pre><span/><code>└── app
    ├── config
    │   ├── __init__.py
    │   ├── asgi.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    └── requirements.txt
</code></pre></div>

<h2 id="docker">码头工人</h2>
<p>安装<a href="https://docs.docker.com/install/"> Docker </a>，如果你还没有，那么在“app”目录下添加一个<em> Dockerfile </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c"># app/Dockerfile</span>

<span class="c"># pull the official docker image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11.2-slim</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># set env variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install -r requirements.txt

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. .
</code></pre></div>

<p>所以，我们从Python 3.11.2的<code>slim</code> <a href="https://hub.docker.com/_/python/"> Docker镜像</a>开始。然后我们设置了一个<a href="https://docs.docker.com/engine/reference/builder/#workdir">工作目录</a>以及两个环境变量:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>:防止Python将pyc文件写入磁盘(相当于<code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-B">选项</a></li>
<li><code>PYTHONUNBUFFERED</code>:防止Python缓冲stdout和stderr(相当于<code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">选项</a></li>
</ol>
<p>最后，我们复制了<em> requirements.txt </em>文件，安装了依赖项，并复制了项目。</p>
<blockquote>
<p>查看<a href="/blog/docker-best-practices/"> Docker针对Python开发人员的最佳实践</a>，了解更多关于构造Docker文件的信息，以及为基于Python的开发配置Docker的一些最佳实践。</p>
</blockquote>
<p>接下来，将一个<em> docker-compose.yml </em>文件添加到项目根:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>查看<a href="https://docs.docker.com/compose/compose-file/">合成文件参考</a>，了解该文件如何工作的信息。</p>
</blockquote>
<p>建立形象:</p>


<p>构建映像后，运行容器:</p>


<p>导航到<a href="http://localhost:8008"> http://localhost:8008 </a>再次查看欢迎页面。</p>
<blockquote>
<p>如果这不起作用，通过<code>docker-compose logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="postgres">Postgres</h2>
<p>要配置Postgres，我们需要向<em> docker-compose.yml </em>文件添加一个新服务，更新Django设置，并安装<a href="https://www.psycopg.org/"> Psycopg2 </a>。</p>
<p>首先，向<em> docker-compose.yml </em>添加一个名为<code>db</code>的新服务:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py runserver 0.0.0.0:8000'</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://django_traefik:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="680c0209060f07371c1a090d0e0103280c0a">[email protected]</a>:5432/django_traefik</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=django_traefik</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>为了在容器的生命周期之外保存数据，我们配置了一个卷。这个配置将把<code>postgres_data</code>绑定到容器中的“/var/lib/postgresql/data/”目录。</p>
<p>我们还添加了一个环境键来定义默认数据库的名称，并设置用户名和密码。</p>
<blockquote>
<p>查看<a href="https://hub.docker.com/_/postgres"> Postgres Docker Hub页面</a>的“环境变量”部分了解更多信息。</p>
</blockquote>
<p>注意<code>web</code>服务中的新命令:</p>
<div class="codehilite"><pre><span/><code>bash -c <span class="s1">'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py runserver 0.0.0.0:8000'</span>
</code></pre></div>

<p>将持续到Postgres完成。一旦启动，<code>python manage.py runserver 0.0.0.0:8000</code>就会运行。</p>
<p>要配置Postgres，添加<a href="https://django-environ.readthedocs.io/en/latest/"> django-environ </a>，加载/读取环境变量，添加<a href="https://github.com/psycopg/psycopg2"> Psycopg2 </a>到<em> requirements.txt </em>:</p>
<div class="codehilite"><pre><span/><code>Django==4.1.6
django-environ==0.9.0
psycopg2-binary==2.9.5
</code></pre></div>

<p>初始化<em> config/settings.py </em>顶部的environ:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="kn">import</span> <span class="nn">environ</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">Env</span><span class="p">()</span>
</code></pre></div>

<p>然后，更新<code>DATABASES</code>字典:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">db</span><span class="p">(),</span>
<span class="p">}</span>
</code></pre></div>

<p>django-environ将自动解析我们添加到<em> docker-compose.yml </em>中的数据库连接URL字符串:</p>
<div class="codehilite"><pre><span/><code><span class="n">DATABASE_URL</span><span class="o">=</span><span class="nl">postgresql</span><span class="p">:</span><span class="o">//</span><span class="nl">django_traefik</span><span class="p">:</span><span class="n">django_traefik</span><span class="nv">@db</span><span class="err">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">django_traefik</span><span class="w"/>
</code></pre></div>

<p>同样更新<code>DEBUG</code>变量:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="s1">'DEBUG'</span><span class="p">)</span>
</code></pre></div>

<p>构建新的映像并旋转两个容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>运行初始迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<p>确保创建了默认的Django表:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>django_traefik --dbname<span class="o">=</span>django_traefik

psql <span class="o">(</span><span class="m">15</span>.2<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for</span> help.

<span class="nv">django_traefik</span><span class="o">=</span><span class="c1"># \l</span>
                                            List of databases
      Name      <span class="p">|</span>     Owner      <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>         Access privileges
----------------+----------------+----------+------------+------------+-----------------------------------
 django_traefik <span class="p">|</span> django_traefik <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres       <span class="p">|</span> django_traefik <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0      <span class="p">|</span> django_traefik <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/django_traefik                +
                <span class="p">|</span>                <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">django_traefik</span><span class="o">=</span>CTc/django_traefik
 template1      <span class="p">|</span> django_traefik <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/django_traefik                +
                <span class="p">|</span>                <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">django_traefik</span><span class="o">=</span>CTc/django_traefik
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">django_traefik</span><span class="o">=</span><span class="c1"># \c django_traefik</span>
You are now connected to database <span class="s2">"django_traefik"</span> as user <span class="s2">"django_traefik"</span>.

<span class="nv">django_traefik</span><span class="o">=</span><span class="c1"># \dt</span>
                      List of relations
 Schema <span class="p">|</span>            Name            <span class="p">|</span> Type  <span class="p">|</span>     Owner
--------+----------------------------+-------+----------------
 public <span class="p">|</span> auth_group                 <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> auth_group_permissions     <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> auth_permission            <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> auth_user                  <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> auth_user_groups           <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> auth_user_user_permissions <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> django_admin_log           <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> django_content_type        <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> django_migrations          <span class="p">|</span> table <span class="p">|</span> django_traefik
 public <span class="p">|</span> django_session             <span class="p">|</span> table <span class="p">|</span> django_traefik
<span class="o">(</span><span class="m">10</span> rows<span class="o">)</span>

<span class="nv">django_traefik</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>您也可以通过运行以下命令来检查该卷是否已创建:</p>
<div class="codehilite"><pre><span/><code>$ docker volume inspect django-docker-traefik_postgres_data
</code></pre></div>

<p>您应该会看到类似如下的内容:</p>
<div class="codehilite"><pre><span/><code><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2023-02-11T18:01:42Z"</span>,
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{</span>
            <span class="s2">"com.docker.compose.project"</span>: <span class="s2">"django-docker-traefik"</span>,
            <span class="s2">"com.docker.compose.version"</span>: <span class="s2">"2.12.2"</span>,
            <span class="s2">"com.docker.compose.volume"</span>: <span class="s2">"postgres_data"</span>
        <span class="o">}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/django-docker-traefik_postgres_data/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"django-docker-traefik_postgres_data"</span>,
        <span class="s2">"Options"</span>: null,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>

<h2 id="gunicorn">格尼科恩</h2>
<p>接下来，对于生产环境，让我们将<a href="https://gunicorn.org/"> Gunicorn </a>，一个生产级的WSGI服务器，添加到需求文件中:</p>
<div class="codehilite"><pre><span/><code>Django==4.1.6
django-environ==0.9.0
psycopg2-binary==2.9.5
gunicorn==20.1.0
</code></pre></div>

<p>由于我们仍然希望在开发中使用Django的内置服务器，因此为生产创建一个名为<em> docker-compose.prod.yml </em>的新合成文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.prod.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:8000 config.wsgi'</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://django_traefik:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="395d5358575e56664d4b585c5f5052795d5b">[email protected]</a>:5432/django_traefik</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=django_traefik</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>如果您有多个环境，您可能希望使用一个<a href="https://docs.docker.com/compose/extends/">docker-compose . override . yml</a>配置文件。使用这种方法，您可以将基本配置添加到docker-compose.yml文件中，然后使用docker-compose.override.yml文件根据环境覆盖这些配置设置。</p>
</blockquote>
<p>记下默认值<code>command</code>。我们运行的是Gunicorn，而不是Django开发服务器。我们还从<code>web</code>服务中删除了这个卷，因为我们在生产中不需要它。</p>
<p>将<a href="https://docs.docker.com/compose/reference/down/">下放到</a>开发容器(以及带有<code>-v</code>标志的相关卷):</p>


<p>然后，构建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>运行迁移:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<p>验证<code>django_traefik</code>数据库是和默认的Django表一起创建的。在<a href="http://localhost:8008/admin">http://localhost:8008/admin</a>测试管理页面。静态文件加载不正确。这是意料之中的。我们会尽快解决这个问题。</p>
<blockquote>
<p>同样，如果容器启动失败，通过<code>docker-compose -f docker-compose.prod.yml logs -f</code>检查日志中的错误。</p>
</blockquote>
<h2 id="production-dockerfile">生产文档</h2>
<p>创建一个名为<em> Dockerfile.prod </em>的新Dockerfile，用于生产构建:</p>
<div class="codehilite"><pre><span/><code><span class="c"># app/Dockerfile.prod</span>

<span class="c">###########</span>
<span class="c"># BUILDER #</span>
<span class="c">###########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span><span class="w"> </span>PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install system dependencies</span>
<span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends gcc

<span class="c"># lint</span>
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install <span class="nv">flake8</span><span class="o">==</span><span class="m">6</span>.0.0
<span class="k">COPY</span><span class="w"> </span>. .
<span class="k">RUN</span><span class="w"> </span>flake8 --ignore<span class="o">=</span>E501,F401 .

<span class="c"># install python dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt


<span class="c">#########</span>
<span class="c"># FINAL #</span>
<span class="c">#########</span>

<span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>

<span class="c"># create directory for the app user</span>
<span class="k">RUN</span><span class="w"> </span>mkdir -p /home/app

<span class="c"># create the app user</span>
<span class="k">RUN</span><span class="w"> </span>addgroup --system app <span class="o">&amp;&amp;</span> adduser --system --group app

<span class="c"># create the appropriate directories</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/app
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_HOME</span><span class="o">=</span>/home/app/web
<span class="k">RUN</span><span class="w"> </span>mkdir <span class="nv">$APP_HOME</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">$APP_HOME</span>

<span class="c"># install dependencies</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /usr/src/app/wheels /wheels
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder /app/requirements.txt .
<span class="k">RUN</span><span class="w"> </span>pip install --upgrade pip
<span class="k">RUN</span><span class="w"> </span>pip install --no-cache /wheels/*

<span class="c"># copy project</span>
<span class="k">COPY</span><span class="w"> </span>. <span class="nv">$APP_HOME</span>

<span class="c"># chown all the files to the app user</span>
<span class="k">RUN</span><span class="w"> </span>chown -R app:app <span class="nv">$APP_HOME</span>

<span class="c"># change to the app user</span>
<span class="k">USER</span><span class="w"> </span><span class="s">app</span>
</code></pre></div>

<p>在这里，我们使用了一个Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">多阶段构建</a>来缩小最终的图像尺寸。本质上，<code>builder</code>是一个用于构建Python轮子的临时图像。然后车轮被复制到最终产品图像中，而<code>builder</code>图像被丢弃。</p>
<blockquote>
<p>您可以将<a href="https://stackoverflow.com/a/53101932/1799408">多阶段构建方法</a>更进一步，使用单个docker文件，而不是创建两个docker文件。思考在两个不同的文件上使用这种方法的利弊。</p>
</blockquote>
<p>您是否注意到我们创建了一个非root用户？默认情况下，Docker在容器内部以root用户身份运行容器进程。这是一种不好的做法，因为如果攻击者设法突破容器，他们可以获得Docker主机的根用户访问权限。如果您是容器中的root用户，那么您将是主机上的root用户。</p>
<p>更新<em> docker-compose.prod.yml </em>文件中的<code>web</code>服务，用<em> Dockerfile.prod </em>构建:</p>
<div class="codehilite"><pre><span/><code><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:8000 config.wsgi'</span><span class="w"/>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8000</span><span class="w"/>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=0</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://django_traefik:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="05616f646b626a5a71776460636c6e456167">[email protected]</a>:5432/django_traefik</span><span class="w"/>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
</code></pre></div>

<p>现在，让我们重建生产映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</code></pre></div>

<h2 id="traefik">Traefik</h2>
<p>接下来，让我们添加<a href="https://traefik.io/traefik/"> Traefik </a>，一个<a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/">反向代理</a>。</p>
<blockquote>
<p>刚接触Traefik？查看官方<a href="https://doc.traefik.io/traefik/getting-started/concepts/">入门</a>指南。</p>
<p><strong> Traefik vs Nginx </strong> : Traefik是一个现代的、HTTP反向代理和负载平衡器。它经常被比作<a href="https://www.nginx.com"> Nginx </a>，一个网络服务器和反向代理。由于Nginx主要是一个网络服务器，它可以用来提供网页，也可以作为一个反向代理和负载平衡器。总的来说，Traefik的启动和运行更简单，而Nginx的功能更丰富。</p>
<p><strong> Traefik </strong> :</p>
<ol>
<li>反向代理和负载平衡器</li>
<li>通过开箱即用的<a href="https://letsencrypt.org/">让我们加密</a>，自动发布和更新SSL证书</li>
<li>将Traefik用于简单的、基于Docker的微服务</li>
</ol>
<p><strong> Nginx </strong>:</p>
<ol>
<li>Web服务器、反向代理和负载平衡器</li>
<li>比trafik稍快</li>
<li>对复杂的服务使用Nginx</li>
</ol>
</blockquote>
<p>添加一个名为<em> traefik.dev.toml </em>的新文件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># traefik.dev.toml</span><span class="w"/>

<span class="c1"># listen on port 80</span><span class="w"/>
<span class="k">[entryPoints]</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":80"</span><span class="w"/>

<span class="c1"># Traefik dashboard over http</span><span class="w"/>
<span class="k">[api]</span><span class="w"/>
<span class="n">insecure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"/>

<span class="k">[log]</span><span class="w"/>
<span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"DEBUG"</span><span class="w"/>

<span class="k">[accessLog]</span><span class="w"/>

<span class="c1"># containers are not discovered automatically</span><span class="w"/>
<span class="k">[providers]</span><span class="w"/>
<span class="w">  </span><span class="k">[providers.docker]</span><span class="w"/>
<span class="w">    </span><span class="n">exposedByDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"/>
</code></pre></div>

<p>在这里，由于我们不想公开<code>db</code>服务，我们将<a href="https://doc.traefik.io/traefik/providers/docker/#exposedbydefault"> exposedByDefault </a>设置为<code>false</code>。要手动公开服务，我们可以将<code>"traefik.enable=true"</code>标签添加到Docker组合文件中。</p>
<p>接下来，更新<em> docker-compose.yml </em>文件，以便Traefik发现我们的<code>web</code>服务并添加一个新的<code>traefik</code>服务:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; python manage.py runserver 0.0.0.0:8000'</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app:/app</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://django_traefik:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bedad4dfd0d9d1e1caccdfdbd8d7d5fedadc">[email protected]</a>:5432/django_traefik</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.django.rule=Host(`django.localhost`)"</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=django_traefik</span><span class="w"/>
<span class="w">  </span><span class="nt">traefik</span><span class="p">:</span><span class="w"> </span><span class="c1"># new</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik:v2.9.6</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:80</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8081:8080</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"$PWD/traefik.dev.toml:/etc/traefik/traefik.toml"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<p>首先，<code>web</code>服务只对端口<code>8000</code>上的其他容器公开。我们还为<code>web</code>服务添加了以下标签:</p>
<ol>
<li><code>traefik.enable=true</code>使Traefik能够发现服务</li>
<li><code>traefik.http.routers.django.rule=Host(`django.localhost`)</code>当请求有<code>Host=django.localhost</code>时，请求被重定向到该服务</li>
</ol>
<p>记下<code>traefik</code>服务中的卷:</p>
<ol>
<li>将本地配置文件映射到容器中的配置文件，以便保持设置同步</li>
<li><code>"/var/run/docker.sock:/var/run/docker.sock:ro"</code>使Traefik能够发现其他容器</li>
</ol>
<p>要进行测试，首先取下任何现有的容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose down -v
$ docker-compose -f docker-compose.prod.yml down -v
</code></pre></div>

<p>构建新的开发映像并启动容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose up -d --build
</code></pre></div>

<p>导航到<a href="http://django.localhost:8008/">http://django.localhost:8008/</a>你应该看到Django的欢迎页面。</p>
<p>接下来，在<a href="http://django.localhost:8081"> django.localhost:8081 </a>查看<a href="https://doc.traefik.io/traefik/operations/dashboard/">仪表盘</a>:</p>
<p><img data-src="/static/images/blog/fastapi/fastapi-docker-traefik/traefik_dashboard.png" loading="lazy" class="lazyload" alt="traefik dashboard" src="../Images/c388e49cdf834296ca304b677e08a153.png" data-original-src="https://testdriven.io/static/images/blog/fastapi/fastapi-docker-traefik/traefik_dashboard.png"/></p>
<p>完成后，将容器和体积拿下来:</p>


<h2 id="lets-encrypt">让我们加密</h2>
<p>我们已经成功地在开发模式中创建了Django、Docker和Traefik的工作示例。对于生产，您需要配置Traefik来通过Let's Encrypt 管理TLS证书。简而言之，Traefik将自动联系证书颁发机构来颁发和续订证书。</p>
<p>因为Let's Encrypt不会为<code>localhost</code>颁发证书，所以你需要在云计算实例(比如<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean </a> droplet或AWS EC2实例)上运行你的生产容器。您还需要一个有效的域名。如果你没有，你可以在<a href="https://www.freenom.com/"> Freenom </a>创建一个免费域名。</p>
<blockquote>
<p>我们使用一个<a href="https://m.do.co/c/d8f211a4b4c2"> DigitalOcean </a> droplet为Docker提供一个计算实例，并部署生产容器来测试Traefik配置。</p>
</blockquote>
<p>假设您配置了一个计算实例并设置了一个自由域，那么现在就可以在生产模式下设置Traefik了。</p>
<p>首先将Traefik配置的生产版本添加到名为<em> traefik.prod.toml </em>的文件中:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># traefik.prod.toml</span><span class="w"/>

<span class="k">[entryPoints]</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":80"</span><span class="w"/>
<span class="w">  </span><span class="k">[entryPoints.web.http]</span><span class="w"/>
<span class="w">    </span><span class="k">[entryPoints.web.http.redirections]</span><span class="w"/>
<span class="w">      </span><span class="k">[entryPoints.web.http.redirections.entryPoint]</span><span class="w"/>
<span class="w">        </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"websecure"</span><span class="w"/>
<span class="w">        </span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https"</span><span class="w"/>

<span class="w">  </span><span class="k">[entryPoints.websecure]</span><span class="w"/>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":443"</span><span class="w"/>

<span class="k">[accessLog]</span><span class="w"/>

<span class="k">[api]</span><span class="w"/>
<span class="n">dashboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"/>

<span class="k">[providers]</span><span class="w"/>
<span class="w">  </span><span class="k">[providers.docker]</span><span class="w"/>
<span class="w">    </span><span class="n">exposedByDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"/>

<span class="k">[certificatesResolvers.letsencrypt.acme]</span><span class="w"/>
<span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="84fdebf1f6c4e1e9e5ede8aae7ebe9">[email protected]</a>"</span><span class="w"/>
<span class="w">  </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/certificates/acme.json"</span><span class="w"/>
<span class="w">  </span><span class="k">[certificatesResolvers.letsencrypt.acme.httpChallenge]</span><span class="w"/>
<span class="w">    </span><span class="n">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"web"</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>确保用您的实际电子邮件地址替换<code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e891879d9aa88d85898184c68b8785">[email protected]</a></code>。</p>
</blockquote>
<p>这里发生了什么:</p>
<ol>
<li>将我们不安全的HTTP应用程序的入口点设置为端口80</li>
<li>将我们的安全HTTPS应用程序的入口点设置为端口443</li>
<li>将所有不安全的请求重定向到安全端口</li>
<li><code>exposedByDefault = false</code>取消所有服务</li>
<li><code>dashboard = true</code>启用监控仪表板</li>
</ol>
<p>最后，请注意:</p>
<div class="codehilite"><pre><span/><code><span class="k">[certificatesResolvers.letsencrypt.acme]</span><span class="w"/>
<span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d9a0b6acab99bcb4b8b0b5f7bab6b4">[email protected]</a>"</span><span class="w"/>
<span class="w">  </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/certificates/acme.json"</span><span class="w"/>
<span class="w">  </span><span class="k">[certificatesResolvers.letsencrypt.acme.httpChallenge]</span><span class="w"/>
<span class="w">    </span><span class="n">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"web"</span><span class="w"/>
</code></pre></div>

<p>这是让我们加密配置的地方。我们定义了证书的存储位置(T1)和验证类型(T3)，这是一个HTTP挑战(T5)。</p>
<p>接下来，假设您更新了域名的DNS记录，创建两个新的A记录，它们都指向您的计算实例的公共IP:</p>
<ol>
<li><code>django-traefik.your-domain.com</code> -用于网络服务</li>
<li><code>dashboard-django-traefik.your-domain.com</code> -用于Traefik仪表板</li>
</ol>
<blockquote>
<p>确保用您的实际域名替换<code>your-domain.com</code>。</p>
</blockquote>
<p>接下来，像这样更新<em> docker-compose.prod.yml </em>:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># docker-compose.prod.yml</span><span class="w"/>

<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.8'</span><span class="w"/>

<span class="nt">services</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span><span class="w"/>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bash -c 'while !&lt;/dev/tcp/db/5432; do sleep 1; done; gunicorn --bind 0.0.0.0:8000 config.wsgi'</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DEBUG=0</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgresql://django_traefik:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fe9a949f909991a18a8c9f9b989795be9a9c">[email protected]</a>:5432/django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DJANGO_ALLOWED_HOSTS=.your-domain.com</span><span class="w"/>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.django.rule=Host(`django-traefik.your-domain.com`)"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.django.tls=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.django.tls.certresolver=letsencrypt"</span><span class="w"/>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span><span class="w"/>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_data_prod:/var/lib/postgresql/data/</span><span class="w"/>
<span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span><span class="w"/>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=django_traefik</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=django_traefik</span><span class="w"/>
<span class="w">  </span><span class="nt">traefik</span><span class="p">:</span><span class="w">  </span><span class="c1"># new</span><span class="w"/>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span><span class="w"/>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.traefik</span><span class="w"/>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443:443</span><span class="w"/>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"./traefik-public-certificates:/certificates"</span><span class="w"/>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.enable=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.rule=Host(`dashboard-django-traefik.your-domain.com`)"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.tls=true"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.tls.certresolver=letsencrypt"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f98d8b989c9f9092d7918d8d89d78b968c8d9c8b8ad79d988a919b96988b9dd78a9c8b8f909a9cc4988990b990978d9c8b979895">[email protected]</a>"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.routers.dashboard.middlewares=auth"</span><span class="w"/>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"traefik.http.middlewares.auth.basicauth.users=testuser:$$apr1$$jIKW.bdS$$eKXe4Lxjgy/rH65wP1iQe1"</span><span class="w"/>

<span class="nt">volumes</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">postgres_data_prod</span><span class="p">:</span><span class="w"/>
<span class="w">  </span><span class="nt">traefik-public-certificates</span><span class="p">:</span><span class="w"/>
</code></pre></div>

<blockquote>
<p>同样，确保用您的实际域名替换<code>your-domain.com</code>。</p>
</blockquote>
<p>这里有什么新鲜事？</p>
<p>在<code>web</code>服务中，我们添加了以下标签:</p>
<ol>
<li><code>traefik.http.routers.django.rule=Host(`django-traefik.your-domain.com`)</code>将主机更改为实际的域</li>
<li><code>traefik.http.routers.django.tls=true</code>启用HTTPS</li>
<li><code>traefik.http.routers.django.tls.certresolver=letsencrypt</code>将证书颁发者设置为让我们加密</li>
</ol>
<p>接下来，对于<code>traefik</code>服务，我们为证书目录添加了适当的端口和一个卷。该卷确保即使容器关闭，证书仍然有效。</p>
<p>至于标签:</p>
<ol>
<li><code>traefik.http.routers.dashboard.rule=Host(`dashboard-django-traefik.your-domain.com`)</code>定义仪表板主机，因此可以在<code>$Host/dashboard/</code>访问</li>
<li><code>traefik.http.routers.dashboard.tls=true</code>启用HTTPS</li>
<li><code>traefik.http.routers.dashboard.tls.certresolver=letsencrypt</code>将证书解析器设置为“让我们加密”</li>
<li><code>traefik.http.routers.dashboard.middlewares=auth</code>启用<code>HTTP BasicAuth</code>中间件</li>
<li><code>traefik.http.middlewares.auth.basicauth.users</code>定义用于登录的用户名和散列密码</li>
</ol>
<p>您可以使用htpasswd实用程序创建新的密码哈希:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># username: testuser</span>
<span class="c1"># password: password</span>

$ <span class="nb">echo</span> <span class="k">$(</span>htpasswd -nb testuser password<span class="k">)</span> <span class="p">|</span> sed -e s/<span class="se">\\</span>$/<span class="se">\\</span>$<span class="se">\\</span>$/g
testuser:<span class="nv">$$</span>apr1<span class="nv">$$</span>jIKW.bdS<span class="nv">$$</span>eKXe4Lxjgy/rH65wP1iQe1
</code></pre></div>

<p>随意使用一个<code>env_file</code>来存储用户名和密码作为环境变量</p>
<div class="codehilite"><pre><span/><code>USERNAME=testuser
HASHED_PASSWORD=$$apr1$$jIKW.bdS$$eKXe4Lxjgy/rH65wP1iQe1
</code></pre></div>

<p>接下来，更新<em> config/settings.py </em>中的<code>ALLOWED_HOSTS</code>环境变量，如下所示:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="s1">'DJANGO_ALLOWED_HOSTS'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div>

<p>最后，添加一个名为<em> Dockerfile.traefik </em>的新Dockerfile:</p>
<div class="codehilite"><pre><span/><code><span class="c"># Dockerfile.traefik</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">traefik:v2.9.6</span>

<span class="k">COPY</span><span class="w"> </span>./traefik.prod.toml ./etc/traefik/traefik.toml
</code></pre></div>

<p>接下来，旋转新容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>确保这两个URL有效:</p>
<ol>
<li><a href="https://django-traefik.your-domain.com">https://django-traefik.your-domain.com</a></li>
<li><a href="https://dashboard-django-traefik.your-domain.com/dashboard/">https://dashboard-django-traefik.your-domain.com/dashboard/</a></li>
</ol>
<p>此外，请确保当您访问上述网址的HTTP版本时，您会被重定向到HTTPS版本。</p>
<p>最后，让我们加密有效期为<a href="https://letsencrypt.org/2015/11/09/why-90-days.html"> 90天</a>的证书。Treafik将在后台自动为您处理证书更新，这样您就少了一件担心的事情！</p>
<h2 id="static-files">静态文件</h2>
<p>由于Traefik不提供静态文件，我们将使用<a href="http://whitenoise.evans.io">whiten noise</a>来管理静态资产。</p>
<p>首先，将包添加到<em> requirements.txt </em>文件中:</p>
<div class="codehilite"><pre><span/><code>Django==4.1.6
django-environ==0.9.0
psycopg2-binary==2.9.5
gunicorn==20.1.0
whitenoise==6.3.0
</code></pre></div>

<p>像这样更新<em> config/settings.py </em>中的中间件:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'django.middleware.security.SecurityMiddleware'</span><span class="p">,</span>
    <span class="s1">'whitenoise.middleware.WhiteNoiseMiddleware'</span><span class="p">,</span>  <span class="c1"># new</span>
    <span class="s1">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.common.CommonMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="p">,</span>
    <span class="s1">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<p>然后用<code>STATIC_ROOT</code>配置静态文件的处理:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">'staticfiles'</span>
</code></pre></div>

<p>最后，添加压缩和缓存支持:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># config/settings.py</span>

<span class="n">STATICFILES_STORAGE</span> <span class="o">=</span> <span class="s1">'whitenoise.storage.CompressedManifestStaticFilesStorage'</span>
</code></pre></div>

<p>要进行测试，请更新图像和容器:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml up -d --build
</code></pre></div>

<p>收集静态文件:</p>
<div class="codehilite"><pre><span/><code>$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py collectstatic
</code></pre></div>

<p>确保静态文件在<a href="https://django-traefik.your-domain.com/admin">https://django-traefik.your-domain.com/admin</a>被正确提供。</p>
<h2 id="conclusion">结论</h2>
<p>在本教程中，我们介绍了如何使用Postgres将Django应用程序容器化以进行开发。我们还创建了一个生产就绪的Docker组合文件，设置了Traefik和Let's Encrypt来通过HTTPS为应用程序提供服务，并启用了一个安全的仪表板来监控我们的服务。</p>
<p>就生产环境的实际部署而言，您可能希望使用:</p>
<ol>
<li>完全托管的数据库服务——像<a href="https://aws.amazon.com/rds/"> RDS </a>或<a href="https://cloud.google.com/sql/">云SQL</a>——而不是在一个容器中管理你自己的Postgres实例。</li>
<li>服务的非根用户</li>
</ol>
<p>你可以在django-docker-traefik 报告中找到代码。</p>
  </div>

  </div>    
</body>
</html>